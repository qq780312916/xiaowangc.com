<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Linux证书有效期检测脚本</title>
      <link href="/archives/bc2a8490.html"/>
      <url>/archives/bc2a8490.html</url>
      
        <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">Domain=&quot;&quot;&quot;</span><br><span class="line">www.xiaowangc.com</span><br><span class="line">www.baidu.com</span><br><span class="line">www.so.com</span><br><span class="line">developer.aliyun.com</span><br><span class="line">www.google.com</span><br><span class="line">harbor.xiaowangc.local</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;-----------开始检查证书有效期-----------&quot;</span><br><span class="line">for i in $&#123;Domain&#125;;</span><br><span class="line">do</span><br><span class="line">    end_time=$(timeout 3 openssl s_client -connect $i:443 2&gt; /dev/null | openssl x509 -noout -enddate 2&gt; /dev/null | awk -F &#x27;=&#x27; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">    </span><br><span class="line">    if [ $? -ne 0 ] || [[ $end_time == &#x27;&#x27; ]];then</span><br><span class="line">        echo -e &quot;当前域名为: $i&quot;</span><br><span class="line">        echo -e &quot;\e[33m未能检测成功,请稍后重试\e[0m&quot;</span><br><span class="line">        echo &quot;----------------------------------------&quot;</span><br><span class="line">        continue</span><br><span class="line">    fi </span><br><span class="line">    </span><br><span class="line">    echo -e &quot;当前检查的域名: $i&quot;</span><br><span class="line">    </span><br><span class="line">    temp_time_1=$(date -d &quot;$end_time&quot; +%s)</span><br><span class="line">    temp_time_2=$(date -d &quot;$(date -u &#x27;+%b %d %T %Y GMT&#x27;)&quot; +%s )</span><br><span class="line">    </span><br><span class="line">    let temp_time_3=$temp_time_1-$temp_time_2</span><br><span class="line">    days=`expr $temp_time_3 / 86400`</span><br><span class="line">    </span><br><span class="line">    if [ $days -lt 30 ];then</span><br><span class="line">        echo -e &quot;\e[31m剩余天数：$days天\e[0m&quot;</span><br><span class="line">        echo &quot;----------------------------------------&quot;</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    echo -e &quot;\e[32m剩余天数：$days天\e[0m&quot;</span><br><span class="line">    echo &quot;----------------------------------------&quot;</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shell </tag>
            
            <tag> OpenSSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于Kubernetes配置私有镜像仓库</title>
      <link href="/archives/e3278faf.html"/>
      <url>/archives/e3278faf.html</url>
      
        <content type="html"><![CDATA[<h1 id="关于Kubernetes配置私有镜像仓库"><a href="#关于Kubernetes配置私有镜像仓库" class="headerlink" title="关于Kubernetes配置私有镜像仓库"></a>关于Kubernetes配置私有镜像仓库</h1><p>转用Containerd作为CRI，在正常使用公有镜像时并未发现有什么问题，但是在接入Harbor时发现Kubernetes拉取镜像的方式始总采用https方式拉取，将Harbor开启https之后又会出现<code>x509: certificate signed by unknown authority</code>证书验证失败</p><p><strong>本人环境：</strong></p><ul><li>Kubernetes 1.25</li><li>Containerd 1.6.15</li><li>Ubuntu 22.04</li></ul><p><strong>解决方法：</strong></p><ol><li><p>关于kubernetes拉取采用http的方式可参考：</p><p><a href="https://blog.csdn.net/qq_35925862/article/details/128641810">https://blog.csdn.net/qq_35925862/article/details/128641810</a></p><p><a href="https://blog.csdn.net/lhf2112/article/details/117195731">https://blog.csdn.net/lhf2112/article/details/117195731</a></p></li><li><p>继续使用https方式提高安全等级，并通过kubernetes中的Secret提供Harbor用户认证</p></li></ol><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><blockquote><p>很显然本人采用的第二种方法，图方便的同时也要考虑安全性，第二种方法无需更改Containerd</p></blockquote><h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################生成CA证书及私钥################</span></span></span><br><span class="line">[root@master ~]# vi ca.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:ca</span><br><span class="line"></span><br><span class="line">[root@master ~]# openssl req -new -newkey rsa:2048 -keyout ca.key -out ca.csr -nodes -subj &#x27;/CN=ca&#x27;</span><br><span class="line">[root@master ~]# openssl x509 -req -days 36500 -sha256 -extfile ca.cnf -extensions v3_ca -set_serial 0 -signkey ca.key -in ca.csr -out ca.crt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################签发Harbor证书################</span></span></span><br><span class="line"></span><br><span class="line">[root@master ~]# vi harbor.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:harbor.xiaowangc.local,IP:192.168.10.101  # 配置成自己的harbor的域名和IP</span><br><span class="line">[root@master ~]# openssl req -new -newkey rsa:2048 -keyout harbor.key -out harbor.csr -nodes -subj &#x27;/CN=harbor.xiaowangc.local&#x27;</span><br><span class="line">[root@master ~]# openssl x509 -req -sha256 -days 36500 -extfile harbor.cnf -extensions v3_req -in harbor.csr -CA ca.crt -CAkey ca.key -out harbor.crt -CAcreateserial</span><br></pre></td></tr></table></figure><h2 id="配置Harbor"><a href="#配置Harbor" class="headerlink" title="配置Harbor"></a>配置Harbor</h2><p><strong>请将生成的harbor证书copy到harbor服务器上并放置到相应的目录中</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@harbor:~/harbor# vi harbor.yml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Configuration file of Harbor</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The IP address or hostname to access admin UI and registry service.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span></span><br><span class="line">hostname: harbor.xiaowangc.local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http related config</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http:</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">port <span class="keyword">for</span> http, default is 80. If https enabled, this port will redirect to https port</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">port: 80</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https related config</span></span><br><span class="line">https:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">https port <span class="keyword">for</span> harbor, default is 443</span></span><br><span class="line">  port: 443</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">The path of cert and key files <span class="keyword">for</span> nginx</span></span><br><span class="line">  certificate: /root/harbor/tls/harbor.crt</span><br><span class="line">  private_key: /root/harbor/tls/harbor.key</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>加载Harbor配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：使用重启的方式本人未能加载https的配置而是采用如下重新安装的方式</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用重新安装的方法之前的镜像虽然还在，但是生产环境还是要慎用</span></span><br><span class="line">root@harbor:~/harbor# ls</span><br><span class="line">common     docker-compose.yml    harbor.yml       install.sh  prepare</span><br><span class="line">common.sh  harbor.v2.7.0.tar.gz  harbor.yml.tmpl  LICENSE     tls</span><br><span class="line">root@harbor:~/harbor# ./install.sh</span><br></pre></td></tr></table></figure><p><img src="/archives/e3278faf/image-20230121170336333.png" alt="image-20230121170336333"></p><h2 id="信任CA"><a href="#信任CA" class="headerlink" title="信任CA"></a>信任CA</h2><p><strong>虽然Harbor配置https但是由于每台服务器未安装CA证书，所以还是不可信的</strong></p><p><strong>请在所有Kubernetes节点执行如下操作</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@master:~# cp ca.crt /usr/local/share/ca-certificates/</span><br><span class="line">root@master:~# update-ca-certificates</span><br><span class="line">Updating certificates in /etc/ssl/certs...</span><br><span class="line">1 added, 0 removed; done.</span><br><span class="line">Running hooks in /etc/ca-certificates/update.d...</span><br><span class="line">done.</span><br></pre></td></tr></table></figure><p><strong>重启Containerd</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@master:~# systemctl restart containerd</span><br></pre></td></tr></table></figure><h2 id="创建Secret"><a href="#创建Secret" class="headerlink" title="创建Secret"></a>创建Secret</h2><p>通过Secret保存Harbor的认证信息，如果是<strong>公开私有仓库可略过</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred \</span><br><span class="line">  --docker-server=harbor.xiaowangc.local \</span><br><span class="line">  --docker-username=admin \</span><br><span class="line">  --docker-password=Harbor12345 \</span><br><span class="line">  --docker-email=780312916@qq.com </span><br></pre></td></tr></table></figure><p><strong>创建Pod</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@master:~# vi app.yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.xiaowangc.local/app/nginx:v1.0</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">regcred</span><span class="comment"># 使用secret的认证信息，注意与Pod的名称空间一致</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@master:~# kubectl apply -f app.yaml</span><br><span class="line">root@master:~# kubectl describe pod nginx</span><br><span class="line">Name:             nginx</span><br><span class="line">Namespace:        default</span><br><span class="line">Priority:         0</span><br><span class="line">Service Account:  default</span><br><span class="line">Node:             node2.xiaowangc.local/192.168.10.12</span><br><span class="line">Start Time:       Sat, 21 Jan 2023 08:28:08 +0000</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">  kube-api-access-gjv4w:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  45m   default-scheduler  Successfully assigned default/nginx to node2.xiaowangc.local</span><br><span class="line">  Normal  Pulling    45m   kubelet            Pulling image &quot;harbor.xiaowangc.local/app/nginx:v1.0&quot;</span><br><span class="line">  Normal  Pulled     45m   kubelet            Successfully pulled image &quot;harbor.xiaowangc.local/app/nginx:v1.0&quot; in 43.28536ms (43.305668ms including waiting)</span><br><span class="line">  Normal  Created    45m   kubelet            Created container nginx</span><br><span class="line">  Normal  Started    45m   kubelet            Started container nginx</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Containerd </tag>
            
            <tag> Harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Containerd安装脚本</title>
      <link href="/archives/d89a6add.html"/>
      <url>/archives/d89a6add.html</url>
      
        <content type="html"><![CDATA[<h1 id="Containerd安装脚本"><a href="#Containerd安装脚本" class="headerlink" title="Containerd安装脚本"></a>Containerd安装脚本</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">install containerd script</span></span><br><span class="line"></span><br><span class="line">containerd_version=1.6.15</span><br><span class="line">containerd_pause_version=3.9</span><br><span class="line">kubernetes_version=1.26.1-00</span><br><span class="line"></span><br><span class="line">function install_containerd()&#123;</span><br><span class="line">    wget https://github.com/containerd/containerd/releases/download/v$&#123;containerd_version&#125;/cri-containerd-cni-$&#123;containerd_version&#125;-linux-amd64.tar.gz</span><br><span class="line">    tar xf cri-containerd-cni-$&#123;containerd_version&#125;-linux-amd64.tar.gz</span><br><span class="line">    mkdir -p /opt/cni/bin &amp;&amp; mkdir -p /etc/containerd</span><br><span class="line">    mv ./opt/cni/bin/* /opt/cni/bin/ &amp;&amp; mv ./usr/local/bin/* /usr/local/bin/ &amp;&amp; mv ./usr/local/sbin/* /usr/local/sbin/ &amp;&amp; mv ./etc/systemd/system/containerd.service /lib/systemd/system/</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">function config_containerd()&#123;</span><br><span class="line">    /usr/local/bin/containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">    sed -i &quot;s/SystemdCgroup = false/SystemdCgroup = true/g&quot; /etc/containerd/config.toml</span><br><span class="line">    sed -i &quot;s/sandbox_image = \&quot;registry.k8s.io\/pause:3.6\&quot;/sandbox_image = \&quot;registry.k8s.io\/pause:$&#123;containerd_pause_version&#125;\&quot;/g&quot; /etc/containerd/config.toml</span><br><span class="line">    systemctl enable --now containerd</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function config_cri_env()&#123;</span><br><span class="line">tee &gt; /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">modprobe overlay</span><br><span class="line">modprobe br_netfilter    </span><br><span class="line"></span><br><span class="line">tee &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function install_kubernetes_google()&#123;</span><br><span class="line">    apt update</span><br><span class="line">    apt-get install -y apt-transport-https ca-certificates curl</span><br><span class="line">    curl -fsSLo /etc/apt/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg</span><br><span class="line">    echo &quot;deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot; | tee /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">    apt-get update</span><br><span class="line">    apt-get install -y kubelet=$&#123;kubernetes_version&#125; kubeadm=$&#123;kubernetes_version&#125; kubectl=$&#123;kubernetes_version&#125;</span><br><span class="line">    apt-mark hold kubelet kubeadm kubectl</span><br><span class="line">    systemctl enable kubelet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function install_kubernetes_ali()&#123;</span><br><span class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - </span><br><span class="line">    </span><br><span class="line">tee &gt; /etc/apt/sources.list.d/kubernetes.list &lt;&lt; EOF</span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sed -i &quot;s/sandbox_image = \&quot;registry.k8s.io\/pause:$&#123;containerd_pause_version&#125;\&quot;/sandbox_image = \&quot;registry.cn-hangzhou.aliyuncs.com\/google_containers\/pause:$&#123;containerd_pause_version&#125;\&quot;/g&quot; /etc/containerd/config.toml</span><br><span class="line">systemctl restart containerd.service</span><br><span class="line"></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet=$&#123;kubernetes_version&#125; kubeadm=$&#123;kubernetes_version&#125; kubectl=$&#123;kubernetes_version&#125;</span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br><span class="line">systemctl enable kubelet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main()&#123;</span><br><span class="line">    install_containerd</span><br><span class="line">    config_containerd</span><br><span class="line">    config_cri_env</span><br><span class="line">    #install_kubernetes_google</span><br><span class="line">    install_kubernetes_ali</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shell </tag>
            
            <tag> Kubernetes </tag>
            
            <tag> Containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES&amp;Kibana安装配置</title>
      <link href="/archives/93a87db7.html"/>
      <url>/archives/93a87db7.html</url>
      
        <content type="html"><![CDATA[<h1 id="ES单节点安装"><a href="#ES单节点安装" class="headerlink" title="ES单节点安装"></a>ES单节点安装</h1><h2 id="下载es并解压"><a href="#下载es并解压" class="headerlink" title="下载es并解压"></a>下载es并解压</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.5.3-linux-x86_64.tar.gz</span><br><span class="line">[root@xiaowangc ~]# tar -xzf elasticsearch-8.5.3-linux-x86_64.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用elastic用户启动elasticsearch,使用root会报错</span></span><br><span class="line">[root@xiaowangc ~]# useradd elastic</span><br><span class="line">[root@xiaowangc ~]# cd /usr/local/</span><br><span class="line">[root@xiaowangc local]# chown -R elastic.elastic elasticsearch-8.5.3</span><br></pre></td></tr></table></figure><h2 id="更改配置文件"><a href="#更改配置文件" class="headerlink" title="更改配置文件"></a>更改配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc local]# vi elasticsearch-8.5.3/config/elasticsearch.yml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 证书和节点之间加密传输可配可不配，视情况而定，也可以只配置一个身份验证</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">xiaowangc</span><span class="comment"># ES集群名称</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">es.xiaowangc.local</span><span class="comment"># 节点名称</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.224</span><span class="comment"># 节点IP</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span><span class="comment"># ES端口</span></span><br><span class="line"><span class="attr">discovery.type:</span> <span class="string">single-node</span><span class="comment"># 单节点需要加此选项</span></span><br><span class="line"></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span><span class="comment"># 在传输网络层上启用或禁用 TLS/SSL，节点使用这些层相互通信</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span> <span class="comment"># 控制证书的验证full、certificate、none</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.client_authentication:</span> <span class="string">required</span><span class="comment"># 控制服务器在请求证书方面的行为</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span><span class="comment"># 包含专用密钥和证书的密钥库文件</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span><span class="comment"># 包含要信任的证书的密钥库</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span><span class="comment"># 开启身份验证</span></span><br><span class="line"></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span><span class="comment"># 开启HTTPS</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">http.p12</span><span class="comment"># 指定证书</span></span><br></pre></td></tr></table></figure><h2 id="创建CA的方法"><a href="#创建CA的方法" class="headerlink" title="创建CA的方法"></a>创建CA的方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ls</span><br><span class="line">xiaowangc.cnf</span><br><span class="line">[root@master ~]# cat xiaowangc.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:ca.xiaowangc.local</span><br><span class="line">[root@master ~]# openssl req -new -newkey rsa:2048 -keyout ca.key -out ca.csr -nodes -subj &#x27;/CN=ca.xiaowangc.local&#x27;</span><br><span class="line">[root@master ~]# openssl x509 -req -days 36500 -sha256 -extfile xiaowangc.cnf -extensions v3_ca -set_serial 0 -signkey ca.key -in ca.csr -out ca.crt</span><br></pre></td></tr></table></figure><h2 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc local]# cd elasticsearch-8.5.3</span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]# ./bin/elasticsearch-certutil cert --ca-cert ca.crt --ca-key ca.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里的CA是我自建的一套，因为需要用我们自己CA的签发证书，方便信任管理</span></span><br><span class="line">[root@es elasticsearch-8.5.3]# ls</span><br><span class="line">bin  ca.crt  ca.key  config  data  elastic-certificates.p12  jdk  lib  LICENSE.txt  logs  modules  nohup.out  NOTICE.txt  plugins  README.asciidoc</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面那条命令会生成elastic-certificates.p12证书</span></span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]# cp elastic-certificates.p12 config/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置文件中指定的elastic-certificates.p12证书默认会在config目录中寻找</span></span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]# chown -R elastic.elastic config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#####################上面生成的p12证书是集群间通信加密的################################</span></span></span><br><span class="line"></span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]$ ./bin/elasticsearch-certutil http# 为节点申请证书</span><br><span class="line">Generate a CSR? [y/N]n</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不创建CSR</span></span><br><span class="line"></span><br><span class="line">Use an existing CA? [y/N]y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用现有CA</span></span><br><span class="line"></span><br><span class="line">CA Path: ca.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CA证书文件名   默认在config目录中寻找</span></span><br><span class="line"></span><br><span class="line">CA Key: ca.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CA私钥文件名   默认在config目录中寻找</span></span><br><span class="line"></span><br><span class="line">For how long should your certificate be valid? [5y]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置证书的有效时间</span></span><br><span class="line"></span><br><span class="line">Generate a certificate per node? [y/N]y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为每个节点生成证书</span></span><br><span class="line"></span><br><span class="line">node #1 name: es.xiaowangc.local</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">节点1的名称</span></span><br><span class="line"></span><br><span class="line">Enter all the hostnames that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">es.xiaowangc.local</span><br><span class="line"></span><br><span class="line">You entered the following hostnames.</span><br><span class="line"></span><br><span class="line"> - es.xiaowangc.local</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确认信息无误</span></span><br><span class="line"></span><br><span class="line">Enter all the IP addresses that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">192.168.10.224</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">节点的IP</span></span><br><span class="line"></span><br><span class="line">You entered the following IP addresses.</span><br><span class="line"></span><br><span class="line"> - 192.168.10.224</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确认信息无误</span></span><br><span class="line"></span><br><span class="line">The generated certificate will have the following additional configuration</span><br><span class="line">values. These values have been selected based on a combination of the</span><br><span class="line">information you have provided above and secure defaults. You should not need to</span><br><span class="line">change these values unless you have specific requirements.</span><br><span class="line"></span><br><span class="line">Key Name: es.xiaowangc.local</span><br><span class="line">Subject DN: CN=es, DC=xiaowangc, DC=local</span><br><span class="line">Key Size: 2048</span><br><span class="line"></span><br><span class="line">Do you wish to change any of these options? [y/N]n</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否更改</span></span><br><span class="line">Generate additional certificates? [Y/n]n</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否生成其他证书</span></span><br><span class="line"></span><br><span class="line">If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.</span><br><span class="line">Provide a password for the &quot;http.p12&quot; file:  [&lt;ENTER&gt; for none]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给证书加密，直接回车不加密</span></span><br><span class="line"></span><br><span class="line">What filename should be used for the output zip file? [/usr/local/elasticsearch-8.5.3/elasticsearch-ssl-http.zip]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出的文件名</span></span><br><span class="line"></span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]# ls</span><br><span class="line">bin  ca.crt  ca.key  config  data  elastic-certificates.p12  elasticsearch-ssl-http.zip  jdk  lib  LICENSE.txt  logs  modules  nohup.out  NOTICE.txt  plugins  README.asciidoc</span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]# unzip elasticsearch-ssl-http.zip</span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]# cp elasticsearch/http.p12 config/</span><br><span class="line">[root@xiaowangc elasticsearch-8.5.3]# chown -R elastic.elastic config/</span><br></pre></td></tr></table></figure><h2 id="启动ES"><a href="#启动ES" class="headerlink" title="启动ES"></a>启动ES</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc elasticsearch-8.5.3]# su elastic</span><br><span class="line">[elastic@xiaowangc elasticsearch-8.5.3]$ nohup ./bin/elasticsearch &amp;</span><br></pre></td></tr></table></figure><h2 id="更改ES密码"><a href="#更改ES密码" class="headerlink" title="更改ES密码"></a>更改ES密码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[elastic@xiaowangc elasticsearch-8.5.3]$ ./bin/elasticsearch-reset-password -u elastic</span><br><span class="line">This tool will reset the password of the [elastic] user to an autogenerated value.</span><br><span class="line">The password will be printed in the console.</span><br><span class="line">Please confirm that you would like to continue [y/N]y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Password for the [elastic] user successfully reset.</span><br><span class="line">New value: AaGWf1Krql6*rpnYBgjE</span><br></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p><img src="/archives/93a87db7/image-20230109150335931.png" alt="image-20230109150335931"></p><p><strong>证书验证成功，前提得信任CA</strong></p><h1 id="ES集群配置方法"><a href="#ES集群配置方法" class="headerlink" title="ES集群配置方法"></a>ES集群配置方法</h1><h2 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h2><table><thead><tr><th>主机名</th><th>IP地址</th><th>应用</th></tr></thead><tbody><tr><td>es03.xiaowangc.local</td><td>192.168.10.233&#x2F;24</td><td>ES</td></tr><tr><td>es02.xiaowangc.local</td><td>192.168.10.232&#x2F;24</td><td>ES</td></tr><tr><td>es01.xiaowangc.local</td><td>192.168.10.231&#x2F;24</td><td>ES</td></tr><tr><td>es.xiaowangc.local</td><td>192.168.10.230&#x2F;24</td><td>openresty</td></tr><tr><td>kibana.xiaowangc.local</td><td>192.168.10.234&#x2F;24</td><td>kibana</td></tr></tbody></table><h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p><img src="/archives/93a87db7/image-20230109171612733.png" alt="image-20230109171612733"></p><h2 id="必要设置"><a href="#必要设置" class="headerlink" title="必要设置"></a>必要设置</h2><p><strong>所有节点均需配置以免出问题，配置完重启</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@es01 ~]# cat /etc/security/limits.conf</span><br><span class="line">*       soft    nofile  65536</span><br><span class="line">*       hard    nofile  65536</span><br><span class="line">root    soft    nofile  65536</span><br><span class="line">root    hard    nofile  65536</span><br><span class="line">[root@es01 ~]# cat /etc/sysctl.conf</span><br><span class="line">net.core.somaxconn = 1024</span><br><span class="line">net.core.netdev_max_backlog = 5000</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line">net.ipv4.tcp_wmem = 4096 12582912 16777216</span><br><span class="line">net.ipv4.tcp_rmem = 4096 12582912 16777216</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8096</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle = 0</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.ip_local_port_range = 10240 65535</span><br><span class="line">net.ipv4.ip_local_reserved_ports = 24224</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">[root@es01 ~]# systemctl disable --now firewalld</span><br></pre></td></tr></table></figure><h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@es ~]# yum install pcre-devel openssl-devel gcc curl</span><br><span class="line">[root@es ~]# wget https://openresty.org/package/centos/openresty.repo</span><br><span class="line">[root@es ~]# mv openresty.repo /etc/yum.repos.d/</span><br><span class="line">[root@es ~]# dnf makecache</span><br><span class="line">[root@es ~]# dnf -y install openresty</span><br><span class="line">[root@es ~]# cd /usr/local/openresty</span><br><span class="line">[root@es openresty]# vi nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">worker_processes</span>  <span class="string">auto;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line">    <span class="string">worker_connections</span>  <span class="number">1024</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">include</span>       <span class="string">mime.types;</span></span><br><span class="line">    <span class="string">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sendfile</span>        <span class="string">on;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">keepalive_timeout</span>  <span class="number">65</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>       <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="string">server_name</span>  <span class="string">es.xiaowangc.local;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">return</span> <span class="number">301</span> <span class="string">https://es.xiaowangc.com;</span></span><br><span class="line">        </span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">root</span>    <span class="string">html;</span></span><br><span class="line">            <span class="string">index</span>   <span class="string">index.html;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  <span class="string">/50x.html;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">=</span> <span class="string">/50x.html</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">html;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">upstream</span> <span class="string">es_cluster</span> &#123;</span><br><span class="line">        <span class="string">server</span> <span class="string">es01.xiaowangc.local:9200;</span></span><br><span class="line">        <span class="string">server</span> <span class="string">es02.xiaowangc.local:9200;</span></span><br><span class="line">        <span class="string">server</span> <span class="string">es03.xiaowangc.local:9200;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>       <span class="number">443</span> <span class="string">ssl;</span></span><br><span class="line">        <span class="string">server_name</span>  <span class="string">es.xiaowangc.local;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ssl_certificate</span>      <span class="string">es.crt;</span></span><br><span class="line">        <span class="string">ssl_certificate_key</span>  <span class="string">es.key;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ssl_session_cache</span>    <span class="string">shared:SSL:1m;</span></span><br><span class="line">        <span class="string">ssl_session_timeout</span>  <span class="string">5m;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ssl_ciphers</span>  <span class="string">HIGH:!aNULL:!MD5;</span></span><br><span class="line">        <span class="string">ssl_prefer_server_ciphers</span>  <span class="string">on;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">html;</span></span><br><span class="line">            <span class="string">index</span>  <span class="string">index.html</span> <span class="string">index.htm;</span></span><br><span class="line">            <span class="string">proxy_pass</span> <span class="string">http://es_cluster;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">Host</span> <span class="string">$proxy_host;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Real-IP</span> <span class="string">$remote_addr;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">X-forwarded</span> <span class="string">$proxy_add_x_forwarded_for;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@es openresty]# ./bin/openresty</span><br></pre></td></tr></table></figure><h2 id="ES01安装配置"><a href="#ES01安装配置" class="headerlink" title="ES01安装配置"></a>ES01安装配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@es01 ~]# tar xf elasticsearch-8.5.3-linux-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@es01 ~]# useradd elastic</span><br><span class="line">[root@es01 ~]# cd /usr/local/elasticsearch-8.5.3/</span><br><span class="line">[root@es01 elasticsearch-8.5.3]# vi config/elasticsearch.yml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">xiaowangc</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">es01.xiaowangc.local</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;es01.xiaowangc.local&quot;</span>,<span class="string">&quot;es02.xiaowangc.local&quot;</span>,<span class="string">&quot;es03.xiaowangc.local&quot;</span>]</span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;es03.xiaowangc.local&quot;</span>,<span class="string">&quot;es02.xiaowangc.local&quot;</span>,<span class="string">&quot;es01.xiaowangc.local&quot;</span>]</span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.client_authentication:</span> <span class="string">required</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="ES02配置"><a href="#ES02配置" class="headerlink" title="ES02配置"></a>ES02配置</h2><p><strong>其余配置和ES01一样就不写出来了</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">xiaowangc</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">es02.xiaowangc.local</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;es01.xiaowangc.local&quot;</span>,<span class="string">&quot;es02.xiaowangc.local&quot;</span>,<span class="string">&quot;es03.xiaowangc.local&quot;</span>]</span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;es03.xiaowangc.local&quot;</span>,<span class="string">&quot;es02.xiaowangc.local&quot;</span>,<span class="string">&quot;es01.xiaowangc.local&quot;</span>]</span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.client_authentication:</span> <span class="string">required</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="ES03配置"><a href="#ES03配置" class="headerlink" title="ES03配置"></a>ES03配置</h2><p><strong>其余配置和ES01一样就不写出来了</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">xiaowangc</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">es03.xiaowangc.local</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;es01.xiaowangc.local&quot;</span>,<span class="string">&quot;es02.xiaowangc.local&quot;</span>,<span class="string">&quot;es03.xiaowangc.local&quot;</span>]</span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;es03.xiaowangc.local&quot;</span>,<span class="string">&quot;es02.xiaowangc.local&quot;</span>,<span class="string">&quot;es01.xiaowangc.local&quot;</span>]</span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.client_authentication:</span> <span class="string">required</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><p><strong>注意：每个节点都需要指定p12格式的证书，来加密集群间的通信，生成一次就行了，拷贝到其他节点</strong></p><p><strong>ES集群必须配置集群间的加密</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@es01 ~]# ./bin/elasticsearch-certutil cert --ca-cert ca.crt --ca-key ca.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跟单机配置一样，集群必须配置TSL使集群间通信进行加密否则集群无法启动</span></span><br><span class="line">[root@es01 elasticsearch-8.5.3]# mv elastic-certificates.p12 config/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他节点无需生成,直接copy节点1的p12证书过去即可</span></span><br></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p><strong>所有节点均需要使用普通用户启动elasticsearch</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@es01 elasticsearch-8.5.3]# cd ..</span><br><span class="line">[root@es01 local]# chown -R elastic.elastic elasticsearch-8.5.3/</span><br><span class="line">[root@es01 local]# su elastic</span><br><span class="line">[root@es01 local]# su elastic</span><br><span class="line">[elastic@es01 local]$ cd elasticsearch-8.5.3/</span><br><span class="line">[elastic@es01 elasticsearch-8.5.3]$ nohup ./bin/elasticsearch &amp;</span><br></pre></td></tr></table></figure><h2 id="更改密码"><a href="#更改密码" class="headerlink" title="更改密码"></a>更改密码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自动设置所有密码,只能使用一次</span></span><br><span class="line">[elastic@es01 elasticsearch-8.5.3]$ ./bin/elasticsearch-reset-password auto</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动设置跟单机一样</span></span><br><span class="line">[elastic@es01 elasticsearch-8.5.3]$ ./bin/elasticsearch-reset-password -u elastic</span><br><span class="line">This tool will reset the password of the [elastic] user to an autogenerated value.</span><br><span class="line">The password will be printed in the console.</span><br><span class="line">Please confirm that you would like to continue [y/N]y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Password for the [elastic] user successfully reset.</span><br><span class="line">New value: cmo6aWzTVF+YegghL+h=</span><br></pre></td></tr></table></figure><h2 id="附加：配置HTTPS"><a href="#附加：配置HTTPS" class="headerlink" title="附加：配置HTTPS"></a>附加：配置HTTPS</h2><h3 id="生成证书-1"><a href="#生成证书-1" class="headerlink" title="生成证书"></a>生成证书</h3><p>直接通过<code>elasticsearch-certutil http</code>为所有节点生成证书</p><p><strong>自行准备ca</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[root@es01 elasticsearch-8.5.3]# ./bin/elasticsearch-certutil http</span><br><span class="line">Generate a CSR? [y/N]n</span><br><span class="line">Use an existing CA? [y/N]y</span><br><span class="line">CA Path: ca.crt</span><br><span class="line">CA Key: ca.key</span><br><span class="line">For how long should your certificate be valid? [5y]</span><br><span class="line">Generate a certificate per node? [y/N]y# 是否为每个节点生成证书</span><br><span class="line">node #1 name: es01.xiaowangc.local</span><br><span class="line"></span><br><span class="line">Enter all the hostnames that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">node01.xiaowangc.local</span><br><span class="line"></span><br><span class="line">You entered the following hostnames.</span><br><span class="line"></span><br><span class="line"> - node01.xiaowangc.local</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line"></span><br><span class="line">Enter all the IP addresses that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">192.168.10.231</span><br><span class="line"></span><br><span class="line">You entered the following IP addresses.</span><br><span class="line"></span><br><span class="line"> - 192.168.10.231</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line"></span><br><span class="line">Key Name: node01.xiaowangc.local</span><br><span class="line">Subject DN: CN=node01, DC=xiaowangc, DC=local</span><br><span class="line">Key Size: 2048</span><br><span class="line"></span><br><span class="line">Do you wish to change any of these options? [y/N]n</span><br><span class="line">Generate additional certificates? [Y/n]y# 是否继续生成证书</span><br><span class="line"></span><br><span class="line">node #2 name: es02.xiaowangc.local</span><br><span class="line"></span><br><span class="line">Enter all the hostnames that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">es02.xiaowangc.local</span><br><span class="line"></span><br><span class="line">You entered the following hostnames.</span><br><span class="line"></span><br><span class="line"> - es02.xiaowangc.local</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line"></span><br><span class="line">Enter all the IP addresses that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">192.168.10.232</span><br><span class="line"></span><br><span class="line">You entered the following IP addresses.</span><br><span class="line"></span><br><span class="line"> - 192.168.10.232</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line">Do you wish to change any of these options? [y/N]n</span><br><span class="line">Generate additional certificates? [Y/n]y# 是否继续生成证书</span><br><span class="line"></span><br><span class="line">node #3 name: es03.xiaowangc.local</span><br><span class="line"></span><br><span class="line">Enter all the hostnames that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">es03.xiaowangc.local</span><br><span class="line"></span><br><span class="line">You entered the following hostnames.</span><br><span class="line"></span><br><span class="line"> - es03.xiaowangc.local</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line"></span><br><span class="line">Enter all the IP addresses that you need, one per line.</span><br><span class="line">When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span><br><span class="line"></span><br><span class="line">192.168.10.233</span><br><span class="line"></span><br><span class="line">You entered the following IP addresses.</span><br><span class="line"></span><br><span class="line"> - 192.168.10.233</span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]y</span><br><span class="line">Do you wish to change any of these options? [y/N]n</span><br><span class="line">Generate additional certificates? [Y/n]n</span><br><span class="line"></span><br><span class="line">If you wish to use a blank password, simply press &lt;enter&gt; at the prompt below.</span><br><span class="line">Provide a password for the &quot;http.p12&quot; file:  [&lt;ENTER&gt; for none]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Where should we save the generated files?</span></span></span><br><span class="line"></span><br><span class="line">What filename should be used for the output zip file? [/usr/local/elasticsearch-8.5.3/elasticsearch-ssl-http.zip]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@es01 elasticsearch-8.5.3]# dnf -y install unzip tree</span><br><span class="line">[root@es01 elasticsearch-8.5.3]# unzip elasticsearch-ssl-http.zip</span><br><span class="line">[root@es01 elasticsearch-8.5.3]# tree elasticsearch</span><br><span class="line">elasticsearch</span><br><span class="line">├── es02.xiaowangc.local</span><br><span class="line">│   ├── http.p12</span><br><span class="line">│   ├── README.txt</span><br><span class="line">│   └── sample-elasticsearch.yml</span><br><span class="line">├── es03.xiaowangc.local</span><br><span class="line">│   ├── http.p12</span><br><span class="line">│   ├── README.txt</span><br><span class="line">│   └── sample-elasticsearch.yml</span><br><span class="line">└── node01.xiaowangc.local</span><br><span class="line">    ├── http.p12</span><br><span class="line">    ├── README.txt</span><br><span class="line">    └── sample-elasticsearch.yml</span><br><span class="line"></span><br><span class="line">3 directories, 9 files</span><br></pre></td></tr></table></figure><h3 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h3><p><strong>将证书copy到每个节点，将对应节点的证书放到config目录中，并修改权限</strong></p><p><strong>每个节点的配置中加入两项配置并重启</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span><span class="comment"># 开启HTTPS</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">http.p12</span><span class="comment"># 指定证书 默认会在config目录中找http.p12文件</span></span><br></pre></td></tr></table></figure><h3 id="nginx参考"><a href="#nginx参考" class="headerlink" title="nginx参考"></a>nginx参考</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="string">worker_processes</span>  <span class="string">auto;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line">    <span class="string">worker_connections</span>  <span class="number">1024</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">include</span>       <span class="string">mime.types;</span></span><br><span class="line">    <span class="string">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sendfile</span>        <span class="string">on;</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="string">keepalive_timeout</span>  <span class="number">65</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>       <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="string">server_name</span>  <span class="string">es.xiaowangc.local;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">return</span> <span class="number">301</span> <span class="string">https://es.xiaowangc.com;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">root</span>    <span class="string">html;</span></span><br><span class="line">            <span class="string">index</span>   <span class="string">index.html;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  <span class="string">/50x.html;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">=</span> <span class="string">/50x.html</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">html;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">upstream</span> <span class="string">es_cluster</span> &#123;</span><br><span class="line">        <span class="string">server</span> <span class="string">es01.xiaowangc.local:9200;</span></span><br><span class="line">        <span class="string">server</span> <span class="string">es02.xiaowangc.local:9200;</span></span><br><span class="line">        <span class="string">server</span> <span class="string">es03.xiaowangc.local:9200;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>       <span class="number">443</span> <span class="string">ssl;</span></span><br><span class="line">        <span class="string">server_name</span>  <span class="string">es.xiaowangc.local;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ssl_certificate</span>      <span class="string">es.crt;</span></span><br><span class="line">        <span class="string">ssl_certificate_key</span>  <span class="string">es.key;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ssl_session_cache</span>    <span class="string">shared:SSL:1m;</span></span><br><span class="line">        <span class="string">ssl_session_timeout</span>  <span class="string">5m;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ssl_ciphers</span>  <span class="string">HIGH:!aNULL:!MD5;</span></span><br><span class="line">        <span class="string">ssl_prefer_server_ciphers</span>  <span class="string">on;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">html;</span></span><br><span class="line">            <span class="string">index</span>  <span class="string">index.html</span> <span class="string">index.htm;</span></span><br><span class="line">            <span class="string">proxy_pass</span> <span class="string">https://es_cluster;</span><span class="comment"># 配置成https</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">Host</span> <span class="string">$proxy_host;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Real-IP</span> <span class="string">$remote_addr;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">X-forwarded</span> <span class="string">$proxy_add_x_forwarded_for;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Kibana安装"><a href="#Kibana安装" class="headerlink" title="Kibana安装"></a>Kibana安装</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kibana ~]# tar xf kibana-8.5.3-linux-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@kibana local]#</span><br><span class="line">[root@kibana local]# cd kibana-8.5.3/</span><br><span class="line">[root@kibana kibana-8.5.3]# vi config/kibana.yml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;kibana.xiaowangc.local&quot;</span></span><br><span class="line"><span class="attr">server.publicBaseUrl:</span> <span class="string">&quot;https://kibana.xiaowangc.local&quot;</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">&quot;kibana.xiaowangc.local&quot;</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span><span class="comment"># 设置中文</span></span><br><span class="line"><span class="attr">server.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server.ssl.certificate:</span> <span class="string">/usr/local/kibana-8.5.3/config/kibana.crt</span><span class="comment"># 指定kibana证书</span></span><br><span class="line"><span class="attr">server.ssl.key:</span> <span class="string">/usr/local/kibana-8.5.3/config/kibana.key</span><span class="comment"># 指定kibana私钥</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;https://es.xiaowangc.local/&quot;</span>]<span class="comment"># 我这用的是LB地址</span></span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibana_system&quot;</span><span class="comment"># ES中的kibana_system账号</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;oXeQUf8eMlZ2glRbVL_8&quot;</span><span class="comment"># 密码auto的时候会自动配置，或者手动设置也行</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.certificateAuthorities:</span> [ <span class="string">&quot;/usr/local/kibana-8.5.3/ca.pem&quot;</span> ]<span class="comment"># 指定CA证书</span></span><br></pre></td></tr></table></figure><h2 id="生成证书-2"><a href="#生成证书-2" class="headerlink" title="生成证书"></a>生成证书</h2><p><strong>还是用之前的CA</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway ca]# ls</span><br><span class="line">ca.crt  ca.key   kibana.cnf</span><br><span class="line"></span><br><span class="line">[root@gateway ca]# cat kibana.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:kibana.xiaowangc.local,IP:192.168.10.234</span><br><span class="line"></span><br><span class="line">[root@gateway ca]# openssl req -new -newkey rsa:2048 -keyout kibana.key -out kibana.csr -nodes -subj &#x27;/CN=kibana.xiaowangc.local&#x27;</span><br><span class="line"></span><br><span class="line">[root@gateway ca]# openssl x509 -req -sha256 -days 36500 -extfile kibana.cnf -extensions v3_req -in kibana.csr -CA ca.crt -CAkey ca.key -out kibana.crt -CAcreateserial</span><br><span class="line"></span><br><span class="line">[root@gateway ca]# ls</span><br><span class="line">ca.crt  ca.key  ca.srl  kibana.cnf  kibana.crt  kibana.csr  kibana.key</span><br></pre></td></tr></table></figure><p><strong>将证书拷贝到kibana对应的路径即可（略），包括CA证书</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kibana kibana-8.5.3]# useradd kibana</span><br><span class="line">[root@kibana kibana-8.5.3]# chown -R kibana.kibana /usr/local/kibana-8.5.3/</span><br><span class="line">[root@kibana kibana-8.5.3]# su kibana</span><br><span class="line">[kibana@kibana kibana-8.5.3]$ nohup bin/kibana &amp;</span><br></pre></td></tr></table></figure><p><img src="/archives/93a87db7/image-20230110152649136.png" alt="image-20230110152649136"></p><p><strong>登录用elastic账号登录就行了</strong></p><p><strong>不想使用5601端口可以做nginx代理或直接修改配置文件端口，自行尝试</strong></p>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
            <tag> Kibana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Poste.io邮件服务器</title>
      <link href="/archives/bd4820af.html"/>
      <url>/archives/bd4820af.html</url>
      
        <content type="html"><![CDATA[<h1 id="Poste-io简介"><a href="#Poste-io简介" class="headerlink" title="Poste.io简介"></a>Poste.io简介</h1><p>官网:<a href="https://poste.io/">Poste.io </a></p><p>Poste.io是一款SMTP+IMAP+POP3+反垃圾邮件+防病毒+Web管理+Web电子邮件集一体的开源邮件服务器</p><p>特点：</p><ul><li>SPF、DKIM、DMARC、SRS的原生实现，带有简单的向导</li><li>可检测特洛伊木马、病毒、恶意软件</li><li>内置垃圾邮件过滤器</li><li>带有HTTPS的网络邮件客户端</li><li>电子邮件重定向，自动回复和通过Sieve脚本过滤</li><li>可限制邮件空间及电子邮件数量</li><li>对系统管理员、域管理员、电子邮件所有者具有不同权限的Web管理</li><li>内置微软产品的自动发现功能</li><li>内置邮件服务器的诊断功能</li><li>支持邮件TLS(SMTPS、POP3S、IMAPS)</li><li>默认情况使用SHA512算法加密，防止密码被黑客破解</li><li>可使用Docker部署并与其他应用程序隔离</li></ul><h1 id="邮件原理"><a href="#邮件原理" class="headerlink" title="邮件原理"></a>邮件原理</h1><h2 id="电子邮件结构"><a href="#电子邮件结构" class="headerlink" title="电子邮件结构"></a>电子邮件结构</h2><ol><li><p>用户代理UA</p><p>用户与电子邮件系统的接口，具有编写、显示、邮件处理、通信等功能。例如：Foxmail</p></li><li><p>邮件服务器</p><p>邮件服务器是邮件系统的核心，用于发送和接受邮件，向发送人报告邮件传递情况，同时充当客户和服务器</p></li><li><p>电子邮件使用的协议</p><ul><li><p>STMP协议</p><p>STMP客户端主动将邮件推到SMTP服务器端</p></li><li><p>POP3协议</p><p>用户代理向邮件服务器发出请求，拉去用户邮箱中的邮件</p></li></ul></li></ol><h2 id="电子邮件格式"><a href="#电子邮件格式" class="headerlink" title="电子邮件格式"></a>电子邮件格式</h2><ol><li><p>电子邮件格式</p><ul><li><p>信封</p><p>用户写好首部后，系统自动将信封所需信息提取到信封上</p></li><li><p>内容</p><ul><li>首部<ul><li>包含一些首部行，由一个字典组成</li><li>To: 收件人邮箱(一个或多个)</li><li>Subject: 邮件的主题(可选)</li><li>From: 由系统自动填入</li><li>首部和主体之间使用一个空格进行分割</li></ul></li><li>主体<ul><li>用户自己编写</li></ul></li></ul></li></ul></li><li><p>MIME(多用途网际邮件扩充)</p><ul><li><p>SMTP的缺点</p><p>只能传送7位的ASCII码，其他非英语国家的文字无法传送</p><p>无法传送可执行文件&#x2F;二进制对象</p><p>SMTP服务器拒绝超过一定长度的邮件</p></li><li><p>MIME意图</p><p>并未改变SMTP或取代，继续使用目前的格式，增加了邮件主体的结构</p><p>定义了传送非ASCII码的编码规则，可在现有的电子邮件程序和协议下传送</p></li><li><p>三部分内容</p><p>五个新的邮件首部字段（MIME版本、内容描述、内容标识、内容传送编码、内容类型）</p><p>定义更多的邮件内容的格式</p><p>定义传送编码，可对任何内容格式进行转换，不被邮件系统改变</p></li></ul></li></ol><h2 id="SMTP-x2F-POP3"><a href="#SMTP-x2F-POP3" class="headerlink" title="SMTP&#x2F;POP3"></a>SMTP&#x2F;POP3</h2><ol><li><p>SMTP协议</p><ul><li><p>特点</p><p>提供可靠有效的电子邮件传输协议，客户&#x2F;服务器方式，使用TCP协议</p></li><li><p>三个阶段</p><p>连接建立</p><p>邮件传递</p><p>连接释放</p></li></ul></li><li><p>POP3协议</p><ul><li><p>特点</p><p>简单且非常有限的邮件读取协议，拉取邮件</p></li><li><p>两种工作模式</p><p>下载并保留&#x2F;下载并删除</p><p><img src="/archives/bd4820af/1.png" alt="img"></p></li></ul></li><li><p>IMAP协议</p><ul><li>比POP协议复杂，可以看到首部，当用户需要时，该邮件才上传到用户计算机中</li><li>可以让用户在不同的地方使用不同的计算机随时处理邮件</li></ul></li><li><p>基于万维网的电子邮件</p><ul><li>用户浏览器与电子邮件服务器之间发送&#x2F;接收邮件使用HTTP协议，仅在不同邮件服务器之间使用SMTP协议</li></ul><p><img src="/archives/bd4820af/2.png" alt="img"></p></li></ol><h2 id="邮件端口"><a href="#邮件端口" class="headerlink" title="邮件端口"></a>邮件端口</h2><table><thead><tr><th>端口号</th><th>作用</th></tr></thead><tbody><tr><td>25</td><td>SMTP-主要用于处理接收邮件</td></tr><tr><td>80</td><td>HTTP</td></tr><tr><td>110</td><td>POP3-用于访问邮件的标准协议</td></tr><tr><td>143</td><td>IMAP-用于访问邮件的标准协议</td></tr><tr><td>443</td><td>HTTPS</td></tr><tr><td>465</td><td>SMTPS-传统SMTP端口</td></tr><tr><td>587</td><td>MSA-SMTP端口主要用于STARTTLS和身份验证之后的电子邮件客户端</td></tr><tr><td>993</td><td>IMAP-自连接以来加密的IMAP的备用端口</td></tr><tr><td>995</td><td>POP3S-自连接以来加密的POP3</td></tr><tr><td>4190</td><td>筛子</td></tr></tbody></table><h1 id="部署邮件"><a href="#部署邮件" class="headerlink" title="部署邮件"></a>部署邮件</h1><ol><li><p>安装Docker（略）</p></li><li><p>启动容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# docker run -itd \</span><br><span class="line">-e TZ=Asia/Shanghai \# 设置时区</span><br><span class="line">-e HTTPS=OFF \# 关闭HTTPS，这里是因为我使用了代理</span><br><span class="line">-e HTTP_PORT=11111 \# 更改HTTP默认端口,因为我的代理服务器占用了80端口</span><br><span class="line">-v /root/email/data:/data \# 数据持久化</span><br><span class="line">--name &quot;mailserver&quot; \# 容器名称</span><br><span class="line">-h &quot;mail.xiaowangc.com&quot; \# 主机名</span><br><span class="line">-p 25:25 -p 110:110 -p 143:143 -p 587:587 -p 993:993 -p 995:995 -p 465:465 -p 11111:11111 \# 需要暴露的端口</span><br><span class="line">-t analogic/poste.io</span><br></pre></td></tr></table></figure><p><strong>其他参数：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-e &quot;HTTPS_PORT&quot; # 更改HTTPS端口</span><br><span class="line">-e &quot;DISABLE_CLAMAV=TRUE&quot;# 禁用ClamAV病毒查杀，可降低内存使用率</span><br><span class="line">-e &quot;DISABLE_RSPAMD=TRUE&quot;# 禁用Rspamd反垃圾邮件系统，可降低内存使用率</span><br><span class="line">-e &quot;DISABLE_ROUNDCUBE=TRUE&quot;# 禁用Web电子浏览器</span><br></pre></td></tr></table></figure></li><li><p>配置DNS解析</p><p>配置A记录解析mail.xiaowangc.com的邮件服务器域名</p><p><img src="/archives/bd4820af/image-20221216102820038.png" alt="image-20221216102820038"></p><p>配置MX记录指定邮件服务器</p><p><img src="/archives/bd4820af/image-20221216102904064.png" alt="image-20221216102904064"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 邮件服务器 </tag>
            
            <tag> Email </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 22.04安装CA证书</title>
      <link href="/archives/17c76bbf.html"/>
      <url>/archives/17c76bbf.html</url>
      
        <content type="html"><![CDATA[<p>Ubuntu安装CA证书</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# apt-get install -y ca-certificates</span><br><span class="line">[root@xiaowangc ~]# sudo cp xiaowang-CA.crt /usr/local/share/ca-certificates</span><br><span class="line">[root@xiaowangc ~]# sudo update-ca-certificates</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ubuntu </tag>
            
            <tag> Certificates </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-RuntimeClass</title>
      <link href="/archives/9da39c32.html"/>
      <url>/archives/9da39c32.html</url>
      
        <content type="html"><![CDATA[<h1 id="RuntimeClass"><a href="#RuntimeClass" class="headerlink" title="RuntimeClass"></a>RuntimeClass</h1><p><img src="/archives/9da39c32/architecture.png"></p><p>RuntimeClass 是一个用于选择容器运行时配置的特性，容器运行时配置用于运行 Pod 中的容器。</p><p>容器技术是通过namespace、cgroups等技术对进程实现隔离，相比于虚拟化，容器更小更快。传统虚拟化技术，通过虚拟化一套硬件并在这硬件上安装操作系统OS和部署应用程序。每个虚拟机都拥有属于自己的内核，虚拟机中病毒或被入侵对宿主机的影响较小。而容器和宿主机是共享内核，一旦容器被入侵、逃逸、中病毒等，会对宿主机产生较大影响。</p><p>RuntimeClass就是为了解决以上问题，也有称RuntimeClass为沙箱(沙箱容器)。Runtime主要有：</p><ul><li><p><strong>runC</strong></p><p>根据OCI规范生成的运行容器的Runtime，且作为Containerd runtime的默认配置类型</p><p><img src="/archives/9da39c32/1.png" alt="img"></p></li><li><p><strong>Crun</strong></p><p>使用C语言开发兼容OCI规范用于运行容器的Runtime，具有快速轻量、低内存占用等</p></li><li><p><strong>gVisor（runSC）</strong></p><p>由Google开源使用Go语言编写的Application内核，其包含一个兼容OCI规范的Runtime（runSC），用于在应用程序和主机内核之间提供隔离边界；runSC开源与主流的容器运行时Docker、Containerd、CRI-O、Kubernetes集成。gVisor提供了一个虚拟化环境，以便对容器进行沙盒处理</p><p><img src="/archives/9da39c32/2.png" alt="img"></p></li><li><p><strong>Kata</strong></p><p>KataContainers是一个开源项目和社区，致力于构建轻量级虚拟机的标准实现；kata用于运行根据OCI规范打包的容器</p></li></ul><p><img src="/archives/9da39c32/3.png" alt="image-20221206095145816"></p><h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><ol><li><p>在gVirsor官网根据教程部署runSC</p><p>官网：<a href="https://gvisor.dev/">gvisor</a></p><p>下载：<a href="https://github.com/containerd/containerd">Github</a></p><p>containerd-1.6.10-linux-amd64.tar.gz 仅包含Containerd</p><p>cri-containerd-1.6.10-linux-amd64.tar.gz 包含runC，Containerd</p><p>cri-containerd-cni-1.6.10-linux-amd64.tar.gz包含runC，Containerd，CNI</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# tar Cxzvf /usr/local containerd-1.6.2-linux-amd64.tar.gz</span><br><span class="line">[root@xiaowangc ~]# install -m 755 runc.amd64 /usr/local/sbin/runc</span><br><span class="line">[root@xiaowangc ~]# mkdir -p /opt/cni/bin</span><br><span class="line">[root@xiaowangc ~]# tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz</span><br></pre></td></tr></table></figure></li><li><p>通过配置Containerd的配置文件设置gvisor</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果/etc/containerd/下没有文件通过命令containerd config default &gt; config.toml生成</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在config.toml添加runtimes</span></span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span><br><span class="line"></span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]# 默认runtime</span><br><span class="line">    base_runtime_spec = &quot;&quot;</span><br><span class="line">    cni_conf_dir = &quot;&quot;</span><br><span class="line">    cni_max_conf_num = 0</span><br><span class="line">    container_annotations = []</span><br><span class="line">    pod_annotations = []</span><br><span class="line">    privileged_without_host_devices = false</span><br><span class="line">    runtime_engine = &quot;&quot;</span><br><span class="line">    runtime_path = &quot;&quot;</span><br><span class="line">    runtime_root = &quot;&quot;</span><br><span class="line">    runtime_type = &quot;io.containerd.runc.v2&quot;</span><br><span class="line"></span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br><span class="line">      BinaryName = &quot;&quot;</span><br><span class="line">      CriuImagePath = &quot;&quot;</span><br><span class="line">      CriuPath = &quot;&quot;</span><br><span class="line">      CriuWorkPath = &quot;&quot;</span><br><span class="line">      IoGid = 0</span><br><span class="line">      IoUid = 0</span><br><span class="line">      NoNewKeyring = false</span><br><span class="line">      NoPivotRoot = false</span><br><span class="line">      Root = &quot;&quot;</span><br><span class="line">      ShimCgroup = &quot;&quot;</span><br><span class="line">      SystemdCgroup = true</span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runsc]# 新增runSC需要注意这里的名字要和k8s的handler一致(runsc)</span><br><span class="line">    runtime_type = &quot;io.containerd.runsc.v1&quot;</span><br></pre></td></tr></table></figure></li><li><p>修改后重启containerd</p></li><li><p>创建RuntimeClass</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gvisor</span><span class="comment"># 自定义</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">runsc</span><span class="comment"># 要与Containerd配置的名字一致</span></span><br></pre></td></tr></table></figure></li><li><p>创建RuntimeClass</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# kubectl apply -f gvisor.yaml</span><br><span class="line">runtimeclass.node.k8s.io/gvisor create</span><br><span class="line"></span><br><span class="line">[root@xiaowangc ~]# kubectl get runtimeclass</span><br><span class="line">NAME     HANDLER   AGE</span><br><span class="line">gvisor   runsc     150m</span><br></pre></td></tr></table></figure></li><li><p>指定Pod在RuntimeClass(沙箱)中运行</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node1.xiaowangc.local</span></span><br><span class="line">  <span class="attr">runtimeClassName:</span> <span class="string">gvisor</span><span class="comment"># 指定RuntimeClass的name</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li><li><p>部署</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 runtimeClass]# kubectl get pod</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">mypod   1/1     Running   0          132m</span><br><span class="line"></span><br><span class="line">[root@master1 runtimeClass]# kubectl describe pod mypod | grep Class</span><br><span class="line">Runtime Class Name:  gvisor</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> RuntimeClass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-排错思路</title>
      <link href="/archives/dd3f7a17.html"/>
      <url>/archives/dd3f7a17.html</url>
      
        <content type="html"><![CDATA[<p><img src="/archives/dd3f7a17/k8s-Troubleshooting.png" alt="K8S排错"></p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> Troubleshooting </tag>
            
            <tag> 排错 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-AppArmor</title>
      <link href="/archives/e72cab47.html"/>
      <url>/archives/e72cab47.html</url>
      
        <content type="html"><![CDATA[<h1 id="Linux强制访问控制系统"><a href="#Linux强制访问控制系统" class="headerlink" title="Linux强制访问控制系统"></a>Linux强制访问控制系统</h1><p><strong>AppArmor(Application Armor)<strong>是Linux内核的一个安全模块，AppAromor允许系统管理员将每个程序与一个安全配置文件关联，从而限制程序的功能。AppArmor是与SELinux类似的一个访问控制系统，通过它可以</strong>指定程序可以读、写或运行哪些文件，是否可以打开网络端口等</strong>。作为对传统Unix的自主访问控制模块的补充，AppAromor提供了强制访问控制机制。</p><p>AppArmor 可以配置为任何应用程序减少潜在的攻击面，并且提供更加深入的防御，AppArmor 可以通过限制允许容器执行的操作， 和通过系统日志提供更好的审计来帮助你运行更安全的部署</p><h2 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h2><p>Apparmor有两种工作模式：</p><ul><li><p>enforcing（强制模式）</p><p>遵循配置文件的规则限制，阻止访问不允许访问的资源</p></li><li><p>complain（警告模式）</p><p>遵循配置文件的规则限制，对访问禁止的资源发出警告但不做限制</p></li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><strong>Kubernetes版本不低于v1.4，CentOS不支持AppArmor</strong></p><ul><li><p>查看AppArmor是否开启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@node3:~# cat /sys/module/apparmor/parameters/enabled</span><br><span class="line">Y</span><br><span class="line">root@node3:~# aa-status</span><br><span class="line">apparmor module is loaded.</span><br><span class="line">30 profiles are loaded.</span><br><span class="line">30 profiles are in enforce mode.</span><br></pre></td></tr></table></figure></li><li><p>确保节点的AppArmor都处于运行状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get nodes -o=jsonpath=&#x27;&#123;range .items[*]&#125;&#123;@.metadata.name&#125;: &#123;.status.conditions[?(@.reason==&quot;KubeletReady&quot;)].message&#125;&#123;&quot;\n&quot;&#125;&#123;end&#125;&#x27;</span><br><span class="line">master1.xiaowangc.local: kubelet is posting ready status</span><br><span class="line">master2.xiaowangc.local: kubelet is posting ready status</span><br><span class="line">master3.xiaowangc.local: kubelet is posting ready status</span><br><span class="line">node1.xiaowangc.local: kubelet is posting ready status</span><br><span class="line">node2.xiaowangc.local: kubelet is posting ready status</span><br><span class="line">node3.xiaowangc.local: kubelet is posting ready status. AppArmor enabled</span><br><span class="line">node4.xiaowangc.local: kubelet is posting ready status. AppArmor enabled</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我这里集群一开始是在CentOS8上部署的高可用Kubernetes,为了测试才加入两台Ubuntu节点</span></span><br><span class="line">[root@master1 ~]# kubectl get node -o wide</span><br><span class="line">NAME                      STATUS   ROLES           AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION              CONTAINER-RUNTIME</span><br><span class="line">master1.xiaowangc.local   Ready    control-plane   8d    v1.25.4   192.168.10.1    &lt;none&gt;        CentOS Linux 8       4.18.0-305.3.1.el8.x86_64   docker://20.10.21</span><br><span class="line">master2.xiaowangc.local   Ready    control-plane   8d    v1.25.4   192.168.10.2    &lt;none&gt;        CentOS Linux 8       4.18.0-305.3.1.el8.x86_64   docker://20.10.21</span><br><span class="line">master3.xiaowangc.local   Ready    control-plane   8d    v1.25.4   192.168.10.3    &lt;none&gt;        CentOS Linux 8       4.18.0-305.3.1.el8.x86_64   docker://20.10.21</span><br><span class="line">node1.xiaowangc.local     Ready    nodes           8d    v1.25.4   192.168.10.11   &lt;none&gt;        CentOS Linux 8       4.18.0-305.3.1.el8.x86_64   docker://20.10.21</span><br><span class="line">node2.xiaowangc.local     Ready    nodes           8d    v1.25.4   192.168.10.12   &lt;none&gt;        CentOS Linux 8       4.18.0-305.3.1.el8.x86_64   docker://20.10.21</span><br><span class="line">node3.xiaowangc.local     Ready    &lt;none&gt;          11h   v1.25.4   192.168.10.13   &lt;none&gt;        Ubuntu 22.04.1 LTS   5.15.0-43-generic           docker://20.10.21</span><br><span class="line">node4.xiaowangc.local     Ready    &lt;none&gt;          11h   v1.25.4   192.168.10.14   &lt;none&gt;        Ubuntu 22.04.1 LTS   5.15.0-43-generic           docker://20.10.21</span><br></pre></td></tr></table></figure></li><li><p>在所有Ubuntu节点上加载AppArmor配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# apparmor_parser -q &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;tunables/global&gt;</span></span><br><span class="line"></span><br><span class="line">profile k8s-apparmor-deny-write flags=(attach_disconnected) &#123;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">include &lt;abstractions/base&gt;</span></span><br><span class="line">  file,</span><br><span class="line">  deny /** w,</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否加载</span></span><br><span class="line">root@node3:~# cat /sys/kernel/security/apparmor/profiles | grep k8s-apparmor-deny-write</span><br><span class="line">k8s-apparmor-deny-write (enforce)</span><br></pre></td></tr></table></figure></li><li><p>创建Pod测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# cat busybox-test.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-apparmor</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  annotations:</span><br><span class="line">    container.apparmor.security.beta.kubernetes.io/test: localhost/k8s-apparmor-deny-write</span><br><span class="line">    # 表示对nginx容器应用本地的k8s-apparmor-deny-write策略</span><br><span class="line">spec:</span><br><span class="line">  nodeName: node3.xiaowangc.local# 由于Pod的创建是通过调度器可能不会调度到Ubuntu节点，我就直接使用节点选择器测试</span><br><span class="line">  containers:</span><br><span class="line">  - name: test</span><br><span class="line">    image: busybox</span><br><span class="line">    command: [&quot;sh&quot;, &quot;-c&quot;, &quot;echo &#x27;Hello xiaowangc!&#x27; &amp;&amp; sleep 1h&quot;]</span><br><span class="line">    </span><br><span class="line">[root@master1 ~]# kubectl apply -f busybox-test.yaml</span><br><span class="line">pod/hello-apparmor created</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pod -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP              NODE                    NOMINATED NODE   READINESS GATES</span><br><span class="line">hello-apparmor   1/1     Running   0          32s   172.21.33.134   node3.xiaowangc.local   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl exec hello-apparmor -- cat /proc/1/attr/current</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否加载了Apparmor配置</span></span><br><span class="line">k8s-apparmor-deny-write (enforce)</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl exec hello-apparmor -- touch /tmp/test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入测试文件可以看到被拒绝访问了</span></span><br><span class="line">touch: /tmp/test: Permission denied</span><br><span class="line">command terminated with exit code 1</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> AppArmor </tag>
            
            <tag> CKS </tag>
            
            <tag> 安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 22.04-DNS无法解析</title>
      <link href="/archives/3033751c.html"/>
      <url>/archives/3033751c.html</url>
      
        <content type="html"><![CDATA[<h1 id="Ubuntu-DNS解析问题"><a href="#Ubuntu-DNS解析问题" class="headerlink" title="Ubuntu-DNS解析问题"></a>Ubuntu-DNS解析问题</h1><p>当配置好DNS之后发现怎么都无法进行解析</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@node3:~#</span> <span class="string">cat</span> <span class="string">/etc/netplan/00-installer-config.yaml</span></span><br><span class="line"><span class="comment"># This is the network config written by &#x27;subiquity&#x27;</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">ens33:</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.13</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">via:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.254</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span> [<span class="number">192.168</span><span class="number">.10</span><span class="number">.254</span>]</span><br><span class="line">        <span class="attr">search:</span> [<span class="string">&quot;xiaowangc.local&quot;</span>]</span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>查看&#x2F;etc&#x2F;resolv.conf发现DNS服务器地址一直都是127.0.0.53，修改后临时有效，一旦重启后DNS将无法再次解析</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@node3:~# cat /etc/resolv.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Do not edit.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This file might be symlinked as /etc/resolv.conf. If you&#x27;re looking at</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/resolv.conf and seeing this text, you have followed the symlink.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This is a dynamic resolv.conf file for connecting local clients to the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">internal DNS stub resolver of systemd-resolved. This file lists all</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">configured search domains.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Run &quot;resolvectl status&quot; to see details about the uplink DNS servers</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">currently <span class="keyword">in</span> use.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Third party programs should typically not access this file directly, but only</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) <span class="keyword">in</span> a</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">different way, replace this symlink by a static file or a different symlink.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># See man:systemd-resolved.service(8) for details about the supported modes of</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">operation <span class="keyword">for</span> /etc/resolv.conf.</span></span><br><span class="line"></span><br><span class="line">nameserver 127.0.0.53</span><br><span class="line">options edns0 trust-ad</span><br></pre></td></tr></table></figure><p>从&#x2F;etc&#x2F;resolv.conf的配置文件的注释来看，告诉我们不要修改这个文件，这个文件由systemd-resolved服务管理，这是一个动态文件。通过查看端口得知确实有这么个端口</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@node3:~# ss -lntp | grep 53                                                                                                 </span><br><span class="line">LISTEN 0      4096   127.0.0.53%lo:53         0.0.0.0:*    users:((&quot;systemd-resolve&quot;,pid=34041,fd=14))                           </span><br><span class="line">LISTEN 0      4096         0.0.0.0:8181       0.0.0.0:*    users:((&quot;nginx&quot;,pid=2253,fd=52),(&quot;nginx&quot;,pid=2222,fd=52))             </span><br><span class="line">LISTEN 0      4096         0.0.0.0:443        0.0.0.0:*    users:((&quot;nginx&quot;,pid=2253,fd=38),(&quot;nginx&quot;,pid=2222,fd=38))             </span><br><span class="line">LISTEN 0      4096            [::]:80            [::]:*    users:((&quot;nginx&quot;,pid=2253,fd=31),(&quot;nginx&quot;,pid=2222,fd=31))             </span><br><span class="line">LISTEN 0      4096            [::]:8181          [::]:*    users:((&quot;nginx&quot;,pid=2247,fd=53),(&quot;nginx&quot;,pid=2222,fd=53))             </span><br><span class="line">LISTEN 0      4096            [::]:8181          [::]:*    users:((&quot;nginx&quot;,pid=2253,fd=59),(&quot;nginx&quot;,pid=2222,fd=59))             </span><br><span class="line">LISTEN 0      4096               *:45367            *:*    users:((&quot;cri-dockerd&quot;,pid=1180,fd=10))</span><br></pre></td></tr></table></figure><p>通过配置systemd-resolved来解决DNS无法解析的问题</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@node3:~# vi /etc/systemd/resolved.conf</span><br><span class="line">[Resolve]</span><br><span class="line">DNS=192.168.10.254</span><br><span class="line">Domains=xiaowangc.local# 因为我是自建DNS的原因所以加上域名,没有自建DNS可不加</span><br></pre></td></tr></table></figure><p>重启生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">root@node3:~# systemctl restart systemd-resolved.service</span><br><span class="line">root@node3:~# resolvectl status</span><br><span class="line">Global</span><br><span class="line">         Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span><br><span class="line">  resolv.conf mode: stub</span><br><span class="line">Current DNS Server: 192.168.10.254</span><br><span class="line">       DNS Servers: 192.168.10.254</span><br><span class="line">        DNS Domain: xiaowangc.local</span><br><span class="line"></span><br><span class="line">Link 2 (ens33)</span><br><span class="line">    Current Scopes: DNS</span><br><span class="line">         Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span><br><span class="line">Current DNS Server: 192.168.10.254</span><br><span class="line">       DNS Servers: 192.168.10.254</span><br><span class="line">        DNS Domain: xiaowangc.local</span><br><span class="line"></span><br><span class="line">Link 3 (docker0)</span><br><span class="line">Current Scopes: none</span><br><span class="line">     Protocols: -DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span><br><span class="line"></span><br><span class="line">Link 4 (kube-ipvs0)</span><br><span class="line">Current Scopes: none</span><br><span class="line">     Protocols: -DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span><br><span class="line"></span><br><span class="line">Link 5 (tunl0)</span><br><span class="line">Current Scopes: none</span><br><span class="line">     Protocols: -DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span><br><span class="line">root@node3:~# ping api.xiaowangc.local</span><br><span class="line">PING api.xiaowangc.local (192.168.10.100) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.100 (192.168.10.100): icmp_seq=1 ttl=64 time=0.212 ms</span><br><span class="line">64 bytes from 192.168.10.100 (192.168.10.100): icmp_seq=2 ttl=64 time=0.228 ms</span><br><span class="line">64 bytes from 192.168.10.100 (192.168.10.100): icmp_seq=3 ttl=64 time=0.227 ms</span><br><span class="line">64 bytes from 192.168.10.100 (192.168.10.100): icmp_seq=4 ttl=64 time=0.182 ms</span><br><span class="line">--- api.xiaowangc.local ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3004ms</span><br><span class="line">rtt min/avg/max/mdev = 0.182/0.212/0.228/0.018 ms</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-Join流程</title>
      <link href="/archives/ceed1ba0.html"/>
      <url>/archives/ceed1ba0.html</url>
      
        <content type="html"><![CDATA[<h3 id="join-工作流"><a href="#join-工作流" class="headerlink" title="join 工作流"></a>join 工作流</h3><p><code>kubeadm join</code> 初始化 Kubernetes 工作节点或控制平面节点并将其添加到集群中。 对于工作节点，该操作包括以下步骤：</p><ol><li><p>kubeadm 从 API 服务器下载必要的集群信息（Public名称空间下名为Cluster-info的Configmap）。 默认情况下，它使用引导令牌和 CA 密钥哈希来验证数据的真实性。 也可以通过文件或 URL 直接发现根 CA。</p></li><li><p>一旦知道集群信息，kubelet 就可以开始 TLS 引导过程。</p><p>TLS 引导程序使用共享令牌与 Kubernetes API 服务器进行临时的身份验证，以提交证书签名请求 (CSR)； 默认情况下，控制平面自动对该 CSR 请求进行签名。</p></li><li><p>最后，kubeadm 配置本地 kubelet 使用分配给节点的确定标识连接到 API 服务器。</p></li></ol><p>对于控制平面节点，执行额外的步骤：</p><ol><li>从集群下载控制平面节点之间共享的证书（如果用户明确要求）。</li><li>生成控制平面组件清单、证书和 kubeconfig。</li><li>添加新的本地 etcd 成员。</li></ol>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes常用配置模板</title>
      <link href="/archives/2c3e3fb5.html"/>
      <url>/archives/2c3e3fb5.html</url>
      
        <content type="html"><![CDATA[<h1 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span> </span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h1 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h1 id="Statefulset"><a href="#Statefulset" class="headerlink" title="Statefulset"></a>Statefulset</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 必须匹配 .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 默认值是 1</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">10</span> <span class="comment"># 默认值是 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.k8s.io/nginx-slim:0.8</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;my-storage-class&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h1 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="comment"># 这些容忍度设置是为了让该守护进程集在控制平面节点上运行</span></span><br><span class="line">      <span class="comment"># 如果你不希望自己的控制平面节点运行 Pod，可以删除它们</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/control-plane</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br></pre></td></tr></table></figure><h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">portname-1</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span><span class="comment"># 默认TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span><span class="comment"># SVC-Port</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span>    <span class="comment"># Pod-Port   target: portnaem</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">portname-2</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span><span class="comment"># 默认TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span><span class="comment"># SVC-Port</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span>  <span class="comment"># Pod-Port   target: portnaem</span></span><br><span class="line"><span class="comment"># spec.type      NodePort ClusterIP</span></span><br><span class="line"><span class="comment"># spec.ports.nodePort: xxx</span></span><br><span class="line"><span class="comment"># spec.clusterIP 自定义IPNone为无头</span></span><br></pre></td></tr></table></figure><p><strong>自定义</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">discovery.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EndpointSlice</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-1</span> <span class="comment"># 按惯例将服务的名称用作 EndpointSlice 名称的前缀</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># 你应设置 &quot;kubernetes.io/service-name&quot; 标签。</span></span><br><span class="line">    <span class="comment"># 设置其值以匹配服务的名称</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">addressType:</span> <span class="string">IPv4</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;&#x27;</span> <span class="comment"># 留空，因为 port 9376 未被 IANA 分配为已注册端口</span></span><br><span class="line">    <span class="attr">appProtocol:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9376</span></span><br><span class="line"><span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10.4.5.6&quot;</span> <span class="comment"># 此列表中的 IP 地址可以按任何顺序显示</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10.1.2.3&quot;</span></span><br></pre></td></tr></table></figure><h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><p><strong>注意IngressClassName</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: name-virtual-host-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: foo.bar.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - pathType: Prefix</span><br><span class="line">        path: &quot;/&quot;</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: service1</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">  - host: bar.foo.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - pathType: Prefix</span><br><span class="line">        path: &quot;/&quot;</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: service2</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><h1 id="PV-amp-PVC"><a href="#PV-amp-PVC" class="headerlink" title="PV&amp;PVC"></a>PV&amp;PVC</h1><h2 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"><span class="comment"># 回收策略</span></span><br><span class="line"><span class="comment"># Retain 保留 当PVC对象被删除时，PV 卷仍然存在，对应的数据卷被视为&quot;已释放（released）&quot;。 由于卷上仍然存在这前一申领人的数据，该卷还不能用于其他申领</span></span><br><span class="line"><span class="comment"># Delete 删除  删除动作会将 PV 对象从K8s中移除,包括所关联的存储资产</span></span><br><span class="line"><span class="comment"># Recycle 回收(弃用) 回收策略 Recycle 会在卷上执行一些基本的擦除 （rm -rf /thevolume/*）操作，之后允许该卷用于新的 PVC 申领。</span></span><br></pre></td></tr></table></figure><h2 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myclaim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">8Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 访问模式</span></span><br><span class="line"><span class="comment"># ReadWriteOnce 卷可以被一个节点以读写方式挂载</span></span><br><span class="line"><span class="comment"># ReadOnlyMany 卷可以被多个节点以只读方式挂载</span></span><br><span class="line"><span class="comment"># ReadWriteMany 卷可以被多个节点以读写方式挂载</span></span><br><span class="line"><span class="comment"># ReadWriteOncePod 卷可以被单个 Pod 以读写方式挂载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卷模式</span></span><br><span class="line"><span class="comment"># Filesystem（文件系统） 和 Block（块）</span></span><br></pre></td></tr></table></figure><h2 id="申领"><a href="#申领" class="headerlink" title="申领"></a>申领</h2><h3 id="无状态"><a href="#无状态" class="headerlink" title="无状态"></a>无状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfrontend</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mypd</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypd</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">myclaim</span></span><br></pre></td></tr></table></figure><h3 id="有状态"><a href="#有状态" class="headerlink" title="有状态"></a><strong>有状态</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 必须匹配 .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 默认值是 1</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">10</span> <span class="comment"># 默认值是 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.k8s.io/nginx-slim:0.8</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;my-storage-class&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h1 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">game-demo</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 类属性键；每一个键都映射到一个简单的值</span></span><br><span class="line">  <span class="attr">player_initial_lives:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">  <span class="attr">ui_properties_file_name:</span> <span class="string">&quot;user-interface.properties&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 类文件键</span></span><br><span class="line">  <span class="attr">game.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    enemy.types=aliens,monsters</span></span><br><span class="line"><span class="string">    player.maximum-lives=5    </span></span><br><span class="line"><span class="string"></span>  <span class="attr">user-interface.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    color.good=purple</span></span><br><span class="line"><span class="string">    color.bad=yellow</span></span><br><span class="line"><span class="string">    allow.textmode=true    </span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-demo-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># 定义环境变量</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PLAYER_INITIAL_LIVES</span> <span class="comment"># 请注意这里和 ConfigMap 中的键名是不一样的</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">game-demo</span>           <span class="comment"># 这个值来自 ConfigMap</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">player_initial_lives</span> <span class="comment"># 需要取值的键</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">UI_PROPERTIES_FILE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">game-demo</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">ui_properties_file_name</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">&quot;/config&quot;</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="comment"># 你可以在 Pod 级别设置卷，然后将其挂载到 Pod 内的容器中</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="comment"># 提供你想要挂载的 ConfigMap 的名字</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">game-demo</span></span><br><span class="line">      <span class="comment"># 来自 ConfigMap 的一组键，将被创建为文件</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="comment"># 不通过items会将类属性也挂载</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;game.properties&quot;</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;game.properties&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;user-interface.properties&quot;</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;user-interface.properties&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 需要注意subPath 默认挂载将覆盖路径下所有文件目录</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;250000&quot;</span>]</span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-web-svc</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">&quot;/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">&quot;nginx.conf&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-conf</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">name-of-service-port</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-web-svc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nginx.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    user  nginx;</span></span><br><span class="line"><span class="string">    worker_processes  auto;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">error_log</span>  <span class="string">/var/log/nginx/error.log</span> <span class="string">notice;</span></span><br><span class="line">    <span class="string">pid</span>        <span class="string">/var/run/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">events</span> &#123;</span><br><span class="line">        <span class="string">worker_connections</span>  <span class="number">1024</span><span class="string">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">http</span> &#123;</span><br><span class="line">        <span class="string">include</span>       <span class="string">/etc/nginx/mime.types;</span></span><br><span class="line">        <span class="string">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">log_format</span>  <span class="string">main</span>  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                          <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                          <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">access_log</span>  <span class="string">/var/log/nginx/access.log</span>  <span class="string">main;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">sendfile</span>        <span class="string">on;</span></span><br><span class="line">        <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">keepalive_timeout</span>  <span class="number">65</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">include</span> <span class="string">/etc/nginx/conf.d/*.conf;</span></span><br><span class="line">        <span class="comment"># xiaowangc edit</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h1><p><strong>作为环境变量</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">USER_NAME:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">PASSWORD:</span> <span class="string">MWYyZDFlMmU2N2Rm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">registry.k8s.io/busybox</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span> ]</span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">secretRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysecret</span></span><br></pre></td></tr></table></figure><p><strong>作为文件</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key为文件名，value为内容</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">USER_NAME:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">PASSWORD:</span> <span class="string">MWYyZDFlMmU2N2Rm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p><strong>将证书或密钥文件作为Secret</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc~]# kubectl create secret generic ssh-key-secret --from-file=ssh-privatekey=/path/to/.ssh/id_rsa --from-file=ssh-publickey=/path/to/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure><h1 id="钩子"><a href="#钩子" class="headerlink" title="钩子"></a>钩子</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lifecycle-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the postStart handler &gt; /usr/share/message&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;nginx -s quit; while killall -0 nginx; do sleep 1; done&quot;</span>]</span><br></pre></td></tr></table></figure><h1 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">high-priority</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ubuntu</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo hello; sleep 10;done&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span><span class="comment"># 资源请求</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span><span class="comment"># 最大限制</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br></pre></td></tr></table></figure><h1 id="亲和性"><a href="#亲和性" class="headerlink" title="亲和性"></a>亲和性</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">topology.kubernetes.io/zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">antarctica-east1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">antarctica-west1</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">another-node-label-key</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">another-node-label-value</span></span><br></pre></td></tr></table></figure><h1 id="污点容忍"><a href="#污点容忍" class="headerlink" title="污点容忍"></a>污点容忍</h1><p><strong>设置污点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# kubectl taint nodes node1 key1=value1:NoSchedule</span><br></pre></td></tr></table></figure><p><strong>取消污点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 key1=value1:NoSchedule-</span><br></pre></td></tr></table></figure><p><strong>容忍</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;example-key&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure><p><code>operator</code> 的默认值是 <code>Equal</code>。</p><ul><li>如果 <code>operator</code> 是 <code>Exists</code> （此时容忍度不能指定 <code>value</code>），</li><li>如果 <code>operator</code> 是 <code>Equal</code> ，则它们的 <code>value</code> 应该相等</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value1&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line"><span class="string">=====================================</span></span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key1&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure><h1 id="初始容器"><a href="#初始容器" class="headerlink" title="初始容器"></a>初始容器</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo The app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&quot;until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mydb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&quot;until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done&quot;</span>]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-Trivy容器镜像扫描仪</title>
      <link href="/archives/1cfc3e42.html"/>
      <url>/archives/1cfc3e42.html</url>
      
        <content type="html"><![CDATA[<h1 id="Trivy"><a href="#Trivy" class="headerlink" title="Trivy"></a>Trivy</h1><p>Trivy是一款全面且多功能的安全扫描仪。Trivy用扫描仪来寻找安全问题，并瞄准可以找到这些问题的目标。</p><p>Trivy可以扫描的目标：</p><ul><li>容器镜像</li><li>文件系统</li><li>Git存储库</li><li>虚拟机映像</li></ul><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>更多方式请到：<a href="https://aquasecurity.github.io/trivy/v0.35/getting-started/installation/">安装 - Trivy (aquasecurity.github.io)</a></p><p>本次演示OS：CentOS8.5</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接通过rpm包进行安装</span></span><br><span class="line">[<span class="string">root@harbor</span> <span class="string">~</span>]<span class="comment"># wget https://github.com/aquasecurity/trivy/releases/download/v0.35.0/trivy_0.35.0_Linux-64bit.rpm</span></span><br><span class="line">[<span class="string">root@harbor</span> <span class="string">~</span>]<span class="comment"># dnf -y install trivy_0.35.0_Linux-64bit.rpm</span></span><br></pre></td></tr></table></figure><p><strong>Trivy除了扫描器本体还需要安装数据库，Trivy第一次扫描时会自动下载漏洞数据库，但是由于被墙可能导致数据库无法下载</strong></p><p><strong>可到墙外部署并扫描后将<code>/root/cache/trivy</code>缓存目录进行打包并<code>COPY</code>到本机进行覆盖</strong></p><h1 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">--ignore-unfixed</span><span class="comment"># 跳过无法修复的漏洞,暂时没有解决方案的漏洞</span></span><br><span class="line"><span class="string">--skip-db-update</span><span class="comment"># 跳过数据库更新</span></span><br><span class="line"><span class="string">--severity</span><span class="comment"># 扫描后显示特定风险等级的漏洞 UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL</span></span><br><span class="line"><span class="string">--output</span><span class="comment"># 输出到指定文件</span></span><br><span class="line"><span class="string">--format</span><span class="comment"># 指定输出格式(table、json)</span></span><br></pre></td></tr></table></figure><p><strong>扫描镜像</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# trivy image python:3.4-alpine</span><br><span class="line">2022-11-30T17:20:29.382+0800    INFO    Vulnerability scanning is enabled</span><br><span class="line">2022-11-30T17:20:29.382+0800    INFO    Secret scanning is enabled</span><br><span class="line">2022-11-30T17:20:29.382+0800    INFO    If your scanning is slow, please try &#x27;--security-checks vuln&#x27; to disable secret scanning</span><br><span class="line">2022-11-30T17:20:29.382+0800    INFO    Please see also https://aquasecurity.github.io/trivy/v0.35/docs/secret/scanning/#recommendation for faster secret detection</span><br><span class="line">2022-11-30T17:20:29.387+0800    INFO    Detected OS: alpine</span><br><span class="line">2022-11-30T17:20:29.387+0800    INFO    Detecting Alpine vulnerabilities...</span><br><span class="line">2022-11-30T17:20:29.388+0800    INFO    Number of language-specific files: 1</span><br><span class="line">2022-11-30T17:20:29.388+0800    INFO    Detecting python-pkg vulnerabilities...</span><br><span class="line">2022-11-30T17:20:29.389+0800    WARN    This OS version is no longer supported by the distribution: alpine 3.9.2</span><br><span class="line">2022-11-30T17:20:29.389+0800    WARN    The vulnerability detection may be insufficient because security updates are not provided</span><br><span class="line"></span><br><span class="line">python:3.4-alpine (alpine 3.9.2)</span><br><span class="line"></span><br><span class="line">Total: 37 (UNKNOWN: 0, LOW: 4, MEDIUM: 16, HIGH: 13, CRITICAL: 4)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">总计：37   （未知：0，低：4，中等：16，高：13，严重：4）</span></span><br></pre></td></tr></table></figure><p><strong>扫描文件系统(扫描包含特定语言文件的本地项目)</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# trivy fs /path/to/project</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Trivy将根据锁定文件（如Gemfile.lock和package-lock.json）查找漏洞</span></span><br><span class="line">[root@harbor ~]# trivy fs ~/src/github.com/aquasecurity/trivy-ci-test</span><br></pre></td></tr></table></figure><p><strong>扫描根文件系统（例如主机、虚拟机映像或解压缩的容器映像文件系统）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# trivy rootfs /</span><br></pre></td></tr></table></figure><p><strong>Git存储库</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# trivy repo https://github.com/xxx/xxx</span><br><span class="line">[root@harbor ~]#trivy repo --branch &lt;branch-name&gt; &lt;repo-name&gt;# 扫描分支</span><br></pre></td></tr></table></figure><p><strong>私有库</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为了扫描私有 GitHub 或 GitLab 存储库，必须分别使用有权访问正在扫描的私有存储库的有效令牌设置环境变量或</span></span><br><span class="line"><span class="string">GITHUB_TOKEN</span></span><br><span class="line"><span class="string">GITLAB_TOKEN</span></span><br></pre></td></tr></table></figure><p><strong>K8S</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# trivy k8s --report summary cluster# 扫描Kubernetes集群</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# trivy k8s --report=summary deploy# 扫描所有的deploy并显示摘要信息</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# trivy k8s --report=all deploy# 扫描所有的deploy并显示全部信息</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# trivy k8s --report=all deploy/xxx# 扫描指定的deploy并显示全部信息</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# trivy k8s --namespace=default --report summary pods/nginx-deployment-68db55bfc6-5xsqp# 扫描特定的Pod</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# trivy k8s --namespace=kube-system --report=summary configmaps</span><br><span class="line">7 / 7 [------------------------------------------------------------------------] 100.00% 2 p/s</span><br><span class="line"></span><br><span class="line">Summary Report for kubernetes-admin@kubernetes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Workload Assessment</span><br><span class="line">┌───────────┬──────────┬───────────────────┬───────────────────┬───────────────────┐</span><br><span class="line">│ Namespace │ Resource │  Vulnerabilities  │ Misconfigurations │      Secrets      │</span><br><span class="line">│           │          ├───┬───┬───┬───┬───┼───┬───┬───┬───┬───┼───┬───┬───┬───┬───┤</span><br><span class="line">│           │          │ C │ H │ M │ L │ U │ C │ H │ M │ L │ U │ C │ H │ M │ L │ U │</span><br><span class="line">└───────────┴──────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘</span><br><span class="line">Severities: C=CRITICAL H=HIGH M=MEDIUM L=LOW U=UNKNOWN</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# trivy k8s --namespace=kube-system --report=summary deploy# 扫描kube-system名称空间的所有deployment</span><br><span class="line">2 / 2 [------------------------------------------------------------------------] 100.00% 1 p/s</span><br><span class="line"></span><br><span class="line">Summary Report for kubernetes-admin@kubernetes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Workload Assessment</span><br><span class="line">┌─────────────┬────────────────────────────────────┬───────────────────┬────────────────────┬───────────────────┐</span><br><span class="line">│  Namespace  │              Resource              │  Vulnerabilities  │ Misconfigurations  │      Secrets      │</span><br><span class="line">│             │                                    ├───┬───┬───┬───┬───┼───┬───┬───┬────┬───┼───┬───┬───┬───┬───┤</span><br><span class="line">│             │                                    │ C │ H │ M │ L │ U │ C │ H │ M │ L  │ U │ C │ H │ M │ L │ U │</span><br><span class="line">├─────────────┼────────────────────────────────────┼───┼───┼───┼───┼───┼───┼───┼───┼────┼───┼───┼───┼───┼───┼───┤</span><br><span class="line">│ kube-system │ Deployment/coredns                 │ 1 │ 3 │ 1 │ 1 │ 5 │   │   │ 3 │ 5  │   │   │   │   │   │   │</span><br><span class="line">│ kube-system │ Deployment/calico-kube-controllers │ 1 │ 1 │   │   │ 1 │   │   │ 3 │ 10 │   │   │   │   │   │   │</span><br><span class="line">└─────────────┴────────────────────────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴────┴───┴───┴───┴───┴───┴───┘</span><br><span class="line">Severities: C=CRITICAL H=HIGH M=MEDIUM L=LOW U=UNKNOWN</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> CKS </tag>
            
            <tag> 安全 </tag>
            
            <tag> Trivy </tag>
            
            <tag> 扫描工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pod安全性标准</title>
      <link href="/archives/2d6df133.html"/>
      <url>/archives/2d6df133.html</url>
      
        <content type="html"><![CDATA[<h1 id="Pod安全性标准"><a href="#Pod安全性标准" class="headerlink" title="Pod安全性标准"></a>Pod安全性标准</h1><p>Pod安全性标准定义了三种不同的策略（Policy），广泛覆盖安全应用场景。这些策略是叠加式的，安全级别从高度宽松至高度受限</p><ul><li><p><strong>Privileges</strong></p><p><strong>Privileged策略是有目的地开放且完全无限制的策略</strong>。此类策略通常针对由特权较高、受信任的用户所管理的系统级或基础设施级负载</p></li><li><p><strong>Baseline</strong></p><p><strong>Baseline 策略的目标是便于常见的容器化应用采用，同时禁止已知的特权提升。</strong> 此策略针对的是应用运维人员和非关键性应用的开发人员</p></li><li><p><strong>Restricted</strong></p><p><strong>Restricted 策略旨在实施当前保护 Pod 的最佳实践，尽管这样作可能会牺牲一些兼容性。</strong> 该类策略主要针对运维人员和安全性很重要的应用的开发人员，以及不太被信任的用户</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> CKS </tag>
            
            <tag> Pod安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-审计</title>
      <link href="/archives/926e9fa1.html"/>
      <url>/archives/926e9fa1.html</url>
      
        <content type="html"><![CDATA[<h1 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h1><p>Kubernetes审计提供了与安全相关的、按时间顺序排列的记录集，记录每个用户、使用Kubernetes API的应用以及控制平面自身引发的活动</p><p>审计功能可以让管理员回答以下问题：</p><ul><li>发什么甚么事了</li><li>什么时候发生的</li><li>谁触发的事件记录</li><li>活动发生做哪些对象上（对哪些资源进行了变更）</li><li>在哪观察到的</li><li>它从哪触发的</li><li>活动的后续处理行为是什么</li></ul><p>审计记录最初产生于<code>kube-apiserver</code>内部。每个请求在不同执行阶段都会生成审计事件；这些审计事件会根据特定策略被预处理并写入后端。策略确定要记录的内容和用来存储记录的后端。当前的后端支持日志文件和webhook</p><p>每个请求都可被记录其相关的阶段(Stage)。已定义的阶段有：</p><ul><li><p>RequestReceived</p><p>接收到请求，响应头发出之前记录审计日志</p></li><li><p>ResponseStarted</p><p>在响应消息的头部发送后，响应消息体发送前生成的事件，只有长时间运行的请求才会生成这个阶段</p></li><li><p>ResponseComplete</p><p>当响应消息体完成并且没有更多数据需要传输的时候</p></li><li><p>Panic</p><p>当panic发生时生成</p></li></ul><h1 id="审计策略"><a href="#审计策略" class="headerlink" title="审计策略"></a>审计策略</h1><p>Kubernetes审计策略定义了关于应记录哪些事件以及应包含哪些数据的规则，审计策略对象结构定义在<code>audit.k8s.io</code> <code>API</code>组处理事件时，将按顺序与规则列表进行比较。第一个匹配规则设置事件的审计级别<strong>（Audit ）</strong>。已定义的审计级别有：</p><ul><li><p><strong>None</strong></p><p>符合规则的日志不会被记录</p></li><li><p><strong>Metadata</strong></p><p>记录请求的元数据（请求的用户，时间戳，资源，动作等），但是不记录请求或相应的消息体</p></li><li><p><strong>Request</strong></p><p>记录事件的元数据和请求的消息体，但是不记录响应的消息体。这不适用于非资源类型的请求</p></li><li><p><strong>RequestResponse</strong></p><p>记录事件的元数据，请求和响应的消息体。这不适用于非资源类型的请求</p></li></ul><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span><span class="comment"># 省略阶段</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span><span class="comment"># 不在RequestReceived阶段为任何请求生成审计事件</span></span><br><span class="line"><span class="attr">rules:</span><span class="comment"># 规则</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">RequestReceived</span>  <span class="comment"># 级别</span></span><br><span class="line">    <span class="attr">resources:</span><span class="comment"># 资源</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span><span class="comment"># 组</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]<span class="comment"># 资源(与RABA策略一致，NS级别，集群级别)</span></span><br><span class="line">  <span class="comment"># 在日志中按Metadata级别记录&quot;pods/log&quot;、&quot;pods/status&quot;请求</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;pods/log&quot;</span>,<span class="string">&quot;pods/status&quot;</span>]</span><br><span class="line">  <span class="comment"># 不在日志中记录对应名称为&quot;controller-leader&quot;的ConfigMap的请求</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">      <span class="attr">resourcesName:</span> [<span class="string">&quot;controller-leader&quot;</span>]</span><br><span class="line">  <span class="comment"># 不在日志中记录由&quot;system:kube-proxy&quot;发起对端点或服务的监测请求</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">users:</span> [<span class="string">&#x27;system:kube-proxy&#x27;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&#x27;watch&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&#x27;endpoints&#x27;</span>,<span class="string">&#x27;services&#x27;</span>]</span><br><span class="line">   <span class="comment"># 在日志中记录kube-system名称空间中configmap变更的请求消息体</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">     <span class="attr">namespace:</span> [<span class="string">&quot;kube-system&quot;</span>]</span><br><span class="line">     <span class="attr">resources:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">       <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">   <span class="comment"># 在日志中按Metadata级别记录所有名称空间的configmap和secret的变更</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">     <span class="attr">resources:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">       <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>,<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">   <span class="comment"># 在日志中以Request级别记录所有其他core和extensions组中的资源操作</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">     <span class="attr">resources:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">   <span class="comment"># 在日志中以Metadta级别记录所有规则的所有其他请求</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">     <span class="attr">omitStages:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br></pre></td></tr></table></figure><h1 id="审计后端-存储"><a href="#审计后端-存储" class="headerlink" title="审计后端(存储)"></a>审计后端(存储)</h1><p>审计后端实现将审计事件到处到外部存储。<code>Kube-apiserver</code>默认提供两个后端：</p><ul><li><p>Log后端</p><p>将事件写入到文件系统</p></li><li><p>WebHook</p><p>将事件发送到外部HTTP API</p></li></ul><h2 id="Log后端"><a href="#Log后端" class="headerlink" title="Log后端"></a>Log后端</h2><p>Log后端将审计事件写入<code>Jsonlines</code>格式的文件。使用<code>kube-apiserver</code>标志配置Log审计后端：</p><ul><li><p>–audit-log-path</p><p>指定日志审计事件的日志文件路径，不指定此标志会禁用日志</p></li><li><p>–audit-log-maxage</p><p>保留审计日志文件的最大天数</p></li><li><p>–audit-log-maxbackup</p><p>保留审计日志文件的最大数量</p></li><li><p>–audit-log-maxsize</p><p>定义审计日志文件的最大大小(兆字节)</p></li></ul><p>如果集群控制平面以Pod的形式运行<code>Kube-apiserver</code>，需要使用<code>hostPath</code>卷来访问策略文件和日志文件所在的目录，这样审计记录才会持久保存</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">--audit-policy-file=/etc/kubernetes/audit-policy.yaml</span> <span class="string">\</span></span><br><span class="line"><span class="string">--audit-log-path=/var/log/kubernetes/audit/audit.log</span></span><br></pre></td></tr></table></figure><p>挂载数据卷</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/audit-policy.yaml</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/kubernetes/audit/</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/kubernetes/audit-policy.yaml</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">File</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">audit-log</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/kubernetes/audit/</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure><h2 id="WebHook后端"><a href="#WebHook后端" class="headerlink" title="WebHook后端"></a>WebHook后端</h2><p>WebHook后端将审计日志发送到远程WebAPI，该远程API应该暴露与Kube-apiserver形式相同的API，包括其身份验证机制</p><ul><li><p>–audit-webhook-config-file</p><p>设置Webhook配置文件的路径，webhook配置文件实际上是一个kubeconfig文件</p></li><li><p>–audit-webhook-initial-backoff</p><p>第一次失败后重发请求等待事件</p></li></ul><h1 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h1><p>截取部分格式化后如下：</p><p><strong>例1：</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Event&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;audit.k8s.io/v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Metadata&quot;</span><span class="punctuation">,</span><span class="comment">// 审计级别</span></span><br><span class="line">    <span class="attr">&quot;auditID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db8c4ca2-cbee-468d-bb93-a483f29073e0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ResponseStarted&quot;</span><span class="punctuation">,</span><span class="comment">// 发出响应头后开始记录</span></span><br><span class="line">    <span class="attr">&quot;requestURI&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/v1/nodes?allowWatchBookmarks=true\\u0026fieldSelector=metadata.name%3Dnode2.xiaowangc.local\\u0026resourceVersion=1207264\\u0026timeout=6m4s\\u0026timeoutSeconds=364\\u0026watch=true&quot;</span><span class="punctuation">,</span> <span class="comment">// 请求路径</span></span><br><span class="line">    <span class="attr">&quot;verb&quot;</span><span class="punctuation">:</span> <span class="string">&quot;watch&quot;</span><span class="punctuation">,</span>  <span class="comment">// 动作</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:serviceaccount:kube-system:kube-proxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2af30a3f-64b9-4475-9efc-621b9cf356a8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;groups&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;system:serviceaccounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;system:serviceaccounts:kube-system&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;system:authenticated&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;extra&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;authentication.kubernetes.io/pod-name&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;kube-proxy-9tc94&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;authentication.kubernetes.io/pod-uid&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;79788f0f-e471-481e-b783-17c4e3c523d5&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sourceIPs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="comment">// 在哪台机器操作的</span></span><br><span class="line">        <span class="string">&quot;192.168.10.1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userAgent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kube-proxy/v1.25.4 (linux/amd64) kubernetes/872a965&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;objectRef&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nodes&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node2.xiaowangc.local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;responseStatus&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="comment">// 操作结果</span></span><br><span class="line">        <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requestReceivedTimestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-11-30T05:40:24.573747Z&quot;</span><span class="punctuation">,</span><span class="comment">// 开始时间</span></span><br><span class="line">    <span class="attr">&quot;stageTimestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-11-30T05:40:24.574373Z&quot;</span><span class="punctuation">,</span><span class="comment">// 结束时间</span></span><br><span class="line">    <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;authorization.k8s.io/decision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;authorization.k8s.io/reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RBAC: allowed by ClusterRoleBinding \&quot;kubeadm:node-proxier\&quot; of ClusterRole \&quot;system:node-proxier\&quot; to ServiceAccount \&quot;kube-proxy/kube-system\&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/archives/926e9fa1/image-20221130140512079.png" alt="image-20221130140512079"></p><p><strong>例2：</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Event&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;audit.k8s.io/v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Metadata&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;auditID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0355f932-2c04-418c-b40a-8ea0cc467917&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ResponseComplete&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requestURI&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/apis/apps/v1/namespaces/default/deployments/nginx-deployment?fieldManager=kubectl-client-side-apply\\u0026fieldValidation=Strict&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;verb&quot;</span><span class="punctuation">:</span> <span class="string">&quot;patch&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kubernetes-admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;groups&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;system:masters&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;system:authenticated&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sourceIPs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;192.168.10.1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userAgent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kubectl/v1.25.4 (linux/amd64) kubernetes/872a965&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;objectRef&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;deployments&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx-deployment&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;apiGroup&quot;</span><span class="punctuation">:</span> <span class="string">&quot;apps&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;responseStatus&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requestReceivedTimestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-11-30T06:06:54.749969Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stageTimestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-11-30T06:06:54.786396Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;authorization.k8s.io/decision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;authorization.k8s.io/reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> CKS </tag>
            
            <tag> 安全 </tag>
            
            <tag> 审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitlab字符集错误</title>
      <link href="/archives/3a601eb7.html"/>
      <url>/archives/3a601eb7.html</url>
      
        <content type="html"><![CDATA[<h1 id="错误："><a href="#错误：" class="headerlink" title="错误："></a><code>错误</code>：</h1><pre><code>Error executing action `run` on resource &#39;execute[/opt/gitlab/embedded/bin/initdb -D /var/opt/gitlab/postgresql/data -E UTF8]&#39;================================================================================Mixlib::ShellOut::ShellCommandFailed------------------------------------Expected process to exit with [0], but received &#39;1&#39;---- Begin output of /opt/gitlab/embedded/bin/initdb -D /var/opt/gitlab/postgresql/data -E UTF8 ----STDOUT: The files belonging to this database system will be owned by user &quot;gitlab-psql&quot;.This user must also own the server process.STDERR: initdb: error: invalid locale settings; check LANG and LC_* environment variables---- End output of /opt/gitlab/embedded/bin/initdb -D /var/opt/gitlab/postgresql/data -E UTF8 ----Ran /opt/gitlab/embedded/bin/initdb -D /var/opt/gitlab/postgresql/data -E UTF8 returned 1Resource Declaration:---------------------# In /opt/gitlab/embedded/cookbooks/cache/cookbooks/postgresql/recipes/enable.rb 49: execute &quot;/opt/gitlab/embedded/bin/initdb -D #&#123;postgresql_data_dir&#125; -E UTF8&quot; do 50:   user postgresql_username 51:   not_if &#123; pg_helper.bootstrapped? || pg_helper.delegated? &#125; 52: end</code></pre><p><code>解决方法</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# vim /etc/profile</span><br><span class="line">[root@xiaowangc ~]#export LC_CTYPE=en_US.UTF-8</span><br><span class="line">[root@xiaowangc ~]# export LC_ALL=en_US.UTF-8</span><br><span class="line">[root@xiaowangc ~]# source /etc/profile</span><br><span class="line">[root@xiaowangc ~]# gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Gitlab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes安全-Kube-Bench</title>
      <link href="/archives/2031d73f.html"/>
      <url>/archives/2031d73f.html</url>
      
        <content type="html"><![CDATA[<h1 id="Kube-Bench"><a href="#Kube-Bench" class="headerlink" title="Kube-Bench"></a>Kube-Bench</h1><p>kube-bench是一个工具，通过运行CIS Kubernetes基准测试中记录的检查来检查Kubernetes是否安全部署，测试使用YAML文件进行部署，使此工具易于随着测试规范的发展而更新</p><p><a href="https://github.com/aquasecurity/kube-bench">GitHub网站</a>下载，我这里是CentOS8的环境因为有rpm包就直接安装，可以通过docker、二进制或其他方式进行安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# wget https://github.com/aquasecurity/kube-bench/releases/download/v0.6.10/kube-bench_0.6.10_linux_amd64.rpm</span><br><span class="line">[root@xiaowangc ~]# dnf -y install kube-bench_0.6.10_linux_amd64.rpm</span><br><span class="line"></span><br><span class="line">[root@xiaowangc ~]# kube-bench run --targets node</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安全检测</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">INFO信息 PASS通过 WARN警告 FAIL失败</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WARN和FAIL级别信息需要处理</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[信息级别] 序号 提示信息</span></span><br><span class="line">[INFO] 4 Worker Node Security Configuration</span><br><span class="line">[INFO] 4.1 Worker Node Configuration Files</span><br><span class="line">[PASS] 4.1.1 Ensure that the kubelet service file permissions are set to 644 or more restrictive (Automated)</span><br><span class="line">[PASS] 4.1.2 Ensure that the kubelet service file ownership is set to root:root (Automated)</span><br><span class="line">[PASS] 4.1.3 If proxy kubeconfig file exists ensure permissions are set to 644 or more restrictive (Manual)</span><br><span class="line">[PASS] 4.1.4 If proxy kubeconfig file exists ensure ownership is set to root:root (Manual)</span><br><span class="line">[PASS] 4.1.5 Ensure that the --kubeconfig kubelet.conf file permissions are set to 644 or more restrictive (Automated)</span><br><span class="line">[PASS] 4.1.6 Ensure that the --kubeconfig kubelet.conf file ownership is set to root:root (Automated)</span><br><span class="line">[PASS] 4.1.7 Ensure that the certificate authorities file permissions are set to 644 or more restrictive (Manual)</span><br><span class="line">[PASS] 4.1.8 Ensure that the client certificate authorities file ownership is set to root:root (Manual)</span><br><span class="line">[PASS] 4.1.9 Ensure that the kubelet --config configuration file has permissions set to 644 or more restrictive (Automated)</span><br><span class="line">[PASS] 4.1.10 Ensure that the kubelet --config configuration file ownership is set to root:root (Automated)</span><br><span class="line">[INFO] 4.2 Kubelet</span><br><span class="line">[PASS] 4.2.1 Ensure that the --anonymous-auth argument is set to false (Automated)</span><br><span class="line">[PASS] 4.2.2 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)</span><br><span class="line">[PASS] 4.2.3 Ensure that the --client-ca-file argument is set as appropriate (Automated)</span><br><span class="line">[PASS] 4.2.4 Ensure that the --read-only-port argument is set to 0 (Manual)</span><br><span class="line">[PASS] 4.2.5 Ensure that the --streaming-connection-idle-timeout argument is not set to 0 (Manual)</span><br><span class="line">[FAIL] 4.2.6 Ensure that the --protect-kernel-defaults argument is set to true (Automated)</span><br><span class="line">[PASS] 4.2.7 Ensure that the --make-iptables-util-chains argument is set to true (Automated)</span><br><span class="line">[PASS] 4.2.8 Ensure that the --hostname-override argument is not set (Manual)</span><br><span class="line">[WARN] 4.2.9 Ensure that the --event-qps argument is set to 0 or a level which ensures appropriate event capture (Manual)</span><br><span class="line">[WARN] 4.2.10 Ensure that the --tls-cert-file and --tls-private-key-file arguments are set as appropriate (Manual)</span><br><span class="line">[PASS] 4.2.11 Ensure that the --rotate-certificates argument is not set to false (Automated)</span><br><span class="line">[PASS] 4.2.12 Verify that the RotateKubeletServerCertificate argument is set to true (Manual)</span><br><span class="line">[WARN] 4.2.13 Ensure that the Kubelet only makes use of Strong Cryptographic Ciphers (Manual)</span><br><span class="line"></span><br><span class="line">== Remediations node ==</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">补救措施或步骤(修正节点)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此修正提示的编号与上面检测的编号一一对应,告诉你如何纠正</span></span><br><span class="line">4.2.6 If using a Kubelet config file, edit the file to set `protectKernelDefaults` to `true`.</span><br><span class="line">If using command line arguments, edit the kubelet service file</span><br><span class="line">/lib/systemd/system/kubelet.service on each worker node and</span><br><span class="line">set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.</span><br><span class="line">--protect-kernel-defaults=true</span><br><span class="line">Based on your system, restart the kubelet service. For example:</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line"></span><br><span class="line">4.2.9 If using a Kubelet config file, edit the file to set `eventRecordQPS` to an appropriate level.</span><br><span class="line">If using command line arguments, edit the kubelet service file</span><br><span class="line">/lib/systemd/system/kubelet.service on each worker node and</span><br><span class="line">set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.</span><br><span class="line">Based on your system, restart the kubelet service. For example,</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line"></span><br><span class="line">4.2.10 If using a Kubelet config file, edit the file to set `tlsCertFile` to the location</span><br><span class="line">of the certificate file to use to identify this Kubelet, and `tlsPrivateKeyFile`</span><br><span class="line">to the location of the corresponding private key file.</span><br><span class="line">If using command line arguments, edit the kubelet service file</span><br><span class="line">/lib/systemd/system/kubelet.service on each worker node and</span><br><span class="line">set the below parameters in KUBELET_CERTIFICATE_ARGS variable.</span><br><span class="line">--tls-cert-file=&lt;path/to/tls-certificate-file&gt;</span><br><span class="line">--tls-private-key-file=&lt;path/to/tls-key-file&gt;</span><br><span class="line">Based on your system, restart the kubelet service. For example,</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line"></span><br><span class="line">4.2.13 If using a Kubelet config file, edit the file to set `TLSCipherSuites` to</span><br><span class="line">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">or to a subset of these values.</span><br><span class="line">If using executable arguments, edit the kubelet service file</span><br><span class="line">/lib/systemd/system/kubelet.service on each worker node and</span><br><span class="line">set the --tls-cipher-suites parameter as follows, or to a subset of these values.</span><br><span class="line">--tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">Based on your system, restart the kubelet service. For example:</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">== Summary node ==</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">摘要</span></span><br><span class="line">19 checks PASS</span><br><span class="line">1 checks FAIL</span><br><span class="line">3 checks WARN</span><br><span class="line">0 checks INFO</span><br><span class="line"></span><br><span class="line">== Summary total ==</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">汇总</span></span><br><span class="line">19 checks PASS</span><br><span class="line">1 checks FAIL</span><br><span class="line">3 checks WARN</span><br><span class="line">0 checks INFO</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安全检测</span></span><br><span class="line">···</span><br><span class="line">···</span><br><span class="line">···</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修正措施</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">摘要</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">汇总</span></span><br></pre></td></tr></table></figure><p><strong>基本kube-bench检测后的格式如上所示</strong></p><h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# kube-bench# 对所有targets进行检测(master node etcd等)</span><br><span class="line">[root@xiaowangc ~]# kube-bench run --targets master # 对master进行检测</span><br><span class="line">[root@xiaowangc ~]# kube-bench run -s node # 对node进行检测</span><br><span class="line">[root@xiaowangc ~]# kube-bench run -s master # 对master进行检测</span><br><span class="line">[root@xiaowangc ~]# kube-bench master # 对master进行检测</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用cis-1.4对node进行检测</span></span><br><span class="line">[root@xiaowangc ~]# kube-bench node --benchmark cis-1.4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">针对kubernetes1.13版本进行检测</span></span><br><span class="line">kube-bench node --version 1.13</span><br></pre></td></tr></table></figure><h1 id="支持版本"><a href="#支持版本" class="headerlink" title="支持版本"></a>支持版本</h1><table><thead><tr><th>源</th><th>CIS Kubernetes Benchmark</th><th>kube-bench 配置</th><th>Kubernetes 版本</th></tr></thead><tbody><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/4892">1.5.1</a></td><td>cis-1.5</td><td>1.15</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/4834">1.6.0</a></td><td>cis-1.6</td><td>1.16-1.18</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/6246">1.20</a></td><td>cis-1.20</td><td>1.19-1.21</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/7532">1.23</a></td><td>cis-1.23</td><td>1.22-1.23</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/10873">1.24</a></td><td>cis-1.24</td><td>1.24</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/4536">GKE 1.0.0</a></td><td>gke-1.0</td><td>GKE</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/7534">GKE 1.2.0</a></td><td>gke-1.2.0</td><td>GKE</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/6041">EKS 1.0.1</a></td><td>eks-1.0.1</td><td>EKS</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/6248">EKS 1.1.0</a></td><td>eks-1.1.0</td><td>EKS</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/6467">ACK 1.0.0</a></td><td>ack-1.0</td><td>ACK</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/6347">AKS 1.0.0</a></td><td>aks-1.0</td><td>AKS</td></tr><tr><td>RHEL</td><td>RedHat OpenShift hardening guide</td><td>rh-0.7</td><td>OCP 3.10-3.11</td></tr><tr><td>CIS</td><td><a href="https://workbench.cisecurity.org/benchmarks/6778">OCP4 1.1.0</a></td><td>rh-1.0</td><td>OCP 4.1-</td></tr><tr><td>CIS</td><td><a href="https://docs.rancher.cn/docs/k3s/security/self-assessment/_index">1.6.0-k3s</a></td><td>cis-1.6-k3s</td><td>k3s v1.16-v1.24</td></tr><tr><td>DISA</td><td><a href="https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_Kubernetes_V1R6_STIG.zip">Kubernetes Ver 1, Rel 6</a></td><td>eks-stig-kubernetes-v1r6</td><td>EKS</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> CKS </tag>
            
            <tag> 安全 </tag>
            
            <tag> Kube-Bench </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-RBAC</title>
      <link href="/archives/37cc241.html"/>
      <url>/archives/37cc241.html</url>
      
        <content type="html"><![CDATA[<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><h2 id="证书申请信息"><a href="#证书申请信息" class="headerlink" title="证书申请信息"></a>证书申请信息</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Country Name (2 letter code) [XX]: 国家</span><br><span class="line">State or Province Name (full name) []: 省</span><br><span class="line">Locality Name (eg, city) [Default City]:  市</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]: 组织名称</span><br><span class="line">Organizational Unit Name (eg, section) []:  组织单位名称</span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []: 主机名</span><br><span class="line"></span><br><span class="line">对应简写</span><br><span class="line"></span><br><span class="line">C 国家</span><br><span class="line"></span><br><span class="line">ST 省</span><br><span class="line"></span><br><span class="line">L 城市</span><br><span class="line"></span><br><span class="line">O 组织名称 # 对应K8S的组名</span><br><span class="line"></span><br><span class="line">OU 组织单位名称</span><br><span class="line"></span><br><span class="line">CN 主机名 # 对应K8S的用户名</span><br></pre></td></tr></table></figure><h2 id="查看K8S资源"><a href="#查看K8S资源" class="headerlink" title="查看K8S资源"></a>查看K8S资源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">非名称空间级别的资源(集群资源)</span></span><br><span class="line">[root@master1 ~]# kubectl api-resources --namespaced=false</span><br><span class="line">NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND</span><br><span class="line">componentstatuses                 cs           v1                                     false        ComponentStatus</span><br><span class="line">namespaces                        ns           v1                                     false        Namespace</span><br><span class="line">nodes                             no           v1                                     false        Node</span><br><span class="line">persistentvolumes                 pv           v1                                     false        PersistentVolume</span><br><span class="line">mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1        false        MutatingWebhookConfiguration</span><br><span class="line">validatingwebhookconfigurations                admissionregistration.k8s.io/v1        false        ValidatingWebhookConfiguration</span><br><span class="line">customresourcedefinitions         crd,crds     apiextensions.k8s.io/v1                false        CustomResourceDefinition</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">名称空间级别的资源</span></span><br><span class="line">[root@master1 ~]# kubectl api-resources --namespaced=true</span><br><span class="line">NAME                        SHORTNAMES   APIVERSION                     NAMESPACED   KIND</span><br><span class="line">bindings                                 v1                             true         Binding</span><br><span class="line">configmaps                  cm           v1                             true         ConfigMap</span><br><span class="line">endpoints                   ep           v1                             true         Endpoints</span><br><span class="line">events                      ev           v1                             true         Event</span><br><span class="line">limitranges                 limits       v1                             true         LimitRange</span><br><span class="line">persistentvolumeclaims      pvc          v1                             true         PersistentVolumeClaim</span><br><span class="line">pods                        po           v1                             true         Pod</span><br><span class="line">podtemplates                             v1                             true         PodTemplate</span><br><span class="line">replicationcontrollers      rc           v1                             true         ReplicationController</span><br><span class="line">resourcequotas              quota        v1                             true         ResourceQuota</span><br><span class="line">secrets                                  v1                             true         Secret</span><br><span class="line">serviceaccounts             sa           v1                             true         ServiceAccount</span><br><span class="line">services                    svc          v1                             true         Service</span><br><span class="line">controllerrevisions                      apps/v1                        true         ControllerRevision</span><br><span class="line">daemonsets                  ds           apps/v1                        true         DaemonSet</span><br><span class="line">deployments                 deploy       apps/v1                        true         Deployment</span><br><span class="line">replicasets                 rs           apps/v1                        true         ReplicaSet</span><br><span class="line">statefulsets                sts          apps/v1                        true         StatefulSet</span><br><span class="line">localsubjectaccessreviews                authorization.k8s.io/v1        true         LocalSubjectAccessReview</span><br><span class="line">horizontalpodautoscalers    hpa          autoscaling/v2                 true         HorizontalPodAutoscaler</span><br><span class="line">cronjobs                    cj           batch/v1                       true         CronJob</span><br><span class="line">jobs                                     batch/v1                       true         Job</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>RBAC API声明了四种Kubernetes对象：</p><ul><li><p>Role（角色）</p><ol><li>用于在某个名称空间内设置资源对象的访问权限，创建Role必须指定名称空间</li></ol></li><li><p>ClusterRole（集群角色）</p><ol><li>定义对某个名称空间的资源对象的访问权限，并授予在某个名称空间内访问权限</li><li>为名称空间作用域的资源对象访问权限，并授予跨所有名称空间的访问权限</li><li>为集群作用域的资源对象定义访问权限</li></ol></li><li><p>RoleBinding（角色绑定）</p></li><li><p>ClusterRoleBinding（集群角色绑定）</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">User------RoleBinding-------------Role# 名称空间资源</span><br><span class="line">授予对某一个名称空间级别资源的权限(限制在名称空间中)</span><br><span class="line">User------RoleBinding-------------ClusterRole# 名称空间资源(包含多个)</span><br><span class="line">授予对多个名称空间级别资源的权限(限制在多个名称空间中,不能对集群资源进行操作)</span><br><span class="line">User------ClusterRoleBinding------ClusterRole# 集群资源</span><br></pre></td></tr></table></figure><h2 id="主体"><a href="#主体" class="headerlink" title="主体"></a>主体</h2><ul><li>User（用户）</li><li>Group（组）</li><li>ServiceAccount（SA服务账号）</li></ul><h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a><strong>权限</strong></h2><ul><li>create （创建）</li><li>delete（删除）</li><li>deletecollection（删除集合）</li><li>get（获取）</li><li>list（列出）</li><li>patch（补丁）</li><li>update（更新）</li><li>watch（查看）</li><li>*（所有）</li></ul><h2 id="Role"><a href="#Role" class="headerlink" title="Role"></a>Role</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span><span class="comment"># Role必须填写名称空间</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span><span class="comment"># Role名称</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; 标明 core API 组</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]<span class="comment"># 名称空间级别资源</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]<span class="comment"># 权限</span></span><br></pre></td></tr></table></figure><h2 id="ClusterRole"><a href="#ClusterRole" class="headerlink" title="ClusterRole"></a>ClusterRole</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># &quot;namespace&quot; 被忽略，因为 ClusterRoles 不受名字空间限制</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="comment"># 在 HTTP 层面，用来访问 Secret 资源的名称为 &quot;secrets&quot;</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]<span class="comment"># 名称空间级别资源 Or 使用集群资源级别</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>] <span class="comment"># 权限</span></span><br></pre></td></tr></table></figure><h2 id="RoleBinding"><a href="#RoleBinding" class="headerlink" title="RoleBinding"></a>RoleBinding</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="comment"># 此角色绑定允许 &quot;jane&quot; 读取 &quot;default&quot; 名字空间中的 Pod</span></span><br><span class="line"><span class="comment"># 你需要在该命名空间中有一个名为 “pod-reader” 的 Role</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="comment"># 你可以指定不止一个“subject（主体）”</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jane</span> <span class="comment"># &quot;name&quot; 是区分大小写的</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="comment"># &quot;roleRef&quot; 指定与某 Role 或 ClusterRole 的绑定关系</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span>        <span class="comment"># 此字段必须是 Role 或 ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span>  <span class="comment"># 此字段必须与你要绑定的 Role 或 ClusterRole 的名称匹配</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  </span><br><span class="line"><span class="string">=======================================================</span></span><br><span class="line"><span class="comment"># 虽然是集群角色但是加了名称空间只能访问这个名称空间，除非不加名称空间就可以访问多个名称空间</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="comment"># 此角色绑定使得用户 &quot;dave&quot; 能够读取 &quot;development&quot; 名字空间中的 Secrets</span></span><br><span class="line"><span class="comment"># 你需要一个名为 &quot;secret-reader&quot; 的 ClusterRole</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line">  <span class="comment"># RoleBinding 的名字空间决定了访问权限的授予范围。</span></span><br><span class="line">  <span class="comment"># 这里隐含授权仅在 &quot;development&quot; 名字空间内的访问权限。</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">development</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dave</span> <span class="comment"># &#x27;name&#x27; 是区分大小写的</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h2 id="ClusterRoleBinding"><a href="#ClusterRoleBinding" class="headerlink" title="ClusterRoleBinding"></a>ClusterRoleBinding</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="comment"># 此集群角色绑定允许 “manager” 组中的任何人访问任何名字空间中的 Secret 资源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span>      <span class="comment"># &#x27;name&#x27; 是区分大小写的</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h2 id="对资源的引用"><a href="#对资源的引用" class="headerlink" title="对资源的引用"></a>对资源的引用</h2><h3 id="子资源"><a href="#子资源" class="headerlink" title="子资源"></a>子资源</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许某主体读取 pods 同时访问这些 Pod 的 log 子资源</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-and-pod-logs-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="单实例"><a href="#单实例" class="headerlink" title="单实例"></a>单实例</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许get or update configmaps下的my-configmap实例对象</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-updater</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="comment"># 在 HTTP 层面，用来访问 ConfigMap 资源的名称为 &quot;configmaps&quot;</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;my-configmap&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;update&quot;</span>, <span class="string">&quot;get&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="所有资源"><a href="#所有资源" class="headerlink" title="所有资源"></a>所有资源</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example.com-superuser</span>  </span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;*&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="API组"><a href="#API组" class="headerlink" title="API组"></a>API组</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许对默认名称空间apps下的deployments控制器做所有操作</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example.com-superuser</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="comment"># 在 HTTP 层面，用来访问 Deployment 资源的名称为 &quot;deployments&quot;</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="string">=============================================</span></span><br><span class="line"><span class="comment"># 允许对默认名称空间apps下的所有资源做所有操作</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example.com-superuser</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="string">==============================================</span></span><br><span class="line"><span class="comment"># 只允许对指定控制器进行所有操作</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example.com-superuser</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">  <span class="attr">resourcesName:</span> [<span class="string">&quot;具体deploy的名称&quot;</span>]<span class="comment"># 具体deploy控制器的名称</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br></pre></td></tr></table></figure><p><strong>apps包含如下资源</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# kubectl api-resources --namespaced | grep apps</span><br><span class="line">controllerrevisions                      apps/v1                        true         ControllerRevision</span><br><span class="line">daemonsets                  ds           apps/v1                        true         DaemonSet</span><br><span class="line">deployments                 deploy       apps/v1                        true         Deployment</span><br><span class="line">replicasets                 rs           apps/v1                        true         ReplicaSet</span><br><span class="line">statefulsets                sts          apps/v1                        true         StatefulSet</span><br></pre></td></tr></table></figure><h2 id="资源查看命令"><a href="#资源查看命令" class="headerlink" title="资源查看命令"></a>资源查看命令</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 名称空间级别的资源</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl api-resources --namespaced=true</span></span><br><span class="line"><span class="comment"># 名称空间级别的资源的权限有哪些</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl api-resources --namespaced=true -o wide</span></span><br><span class="line"><span class="comment"># 非名称空间级别的资源(集群资源)</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl api-resources --namespaced=false -o wide</span></span><br><span class="line"><span class="comment"># 非名称空间级别的资源的权限有哪些</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl api-resources --namespaced=false -o wide</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> RBAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes组件概念</title>
      <link href="/archives/9b833745.html"/>
      <url>/archives/9b833745.html</url>
      
        <content type="html"><![CDATA[<h1 id="Kubernetes组件"><a href="#Kubernetes组件" class="headerlink" title="Kubernetes组件"></a>Kubernetes组件</h1><p><img src="https://d33wubrfki0l68.cloudfront.net/2475489eaf20163ec0f54ddc1d92aa8d4c87c96b/e7c81/images/docs/components-of-kubernetes.svg" alt="Kubernetes 的组件"></p><h2 id="控制平面组件"><a href="#控制平面组件" class="headerlink" title="控制平面组件"></a>控制平面组件</h2><ul><li><p>kube-apiserver</p><p>负责公开了 Kubernetes API，负责处理接受请求的工作</p></li><li><p>etcd</p><p>高度可用的键值存储，k8s集群的数据库</p></li><li><p>kube-scheduler</p><p> 负责监视新调度创建的、未指定运行节点的Pods， 并选择节点来让 Pod 在上面运行</p><p>调度决策考虑的因素包括单个 Pod 及 Pods 集合的资源需求、软硬件及策略约束、 亲和性及反亲和性规范、数据位置、工作负载间的干扰及最后时限</p></li><li><p>kube-controller-manager</p><ul><li><p><strong>节点控制器（Node Controller）</strong></p><p>负责在节点出现故障时进行通知和响应</p></li><li><p><strong>任务控制器（Job Controller）</strong></p><p>监测一次性任务的Job对象，然后创建Pods来运行这些任务直至完成</p></li><li><p><strong>端点分片控制器（EndpointSlice Controller）</strong></p><p>填充端点分片(EndPointSlice)对象(对SVC和Pod之间进行关联)</p></li><li><p><strong>服务账号控制器（Service Account Controller）</strong></p><p>为新的名称空间创建默认的服务账号（SA）</p></li></ul></li><li><p>cloud-conroller-manager</p><p>允许将集群连接到云提供商的 API 之上， 并将与该云平台交互的组件与集群交互的组件分离开来。</p><ul><li><p><strong>节点控制器（Node Controller）</strong></p><p>在节点终止响应后检查云提供商以确定节点是否已删除</p></li><li><p><strong>路由控制器（Route Controller）</strong></p><p>用于在底层云基础架构中设置路由</p></li><li><p><strong>服务控制器（Service Controller）</strong></p><p>用于创建、更新和删除云提供商负载均衡器</p></li></ul></li></ul><h2 id="Node组件"><a href="#Node组件" class="headerlink" title="Node组件"></a>Node组件</h2><ul><li><p>kubelet</p><p>kubelet运行在集群中每个节点上。它保证容器都运行在Pod中</p><p>kubelet接受到来自控制平面提供的PodSpecs，确保这些PodSpecs中描述的容器处于运行且状态健康。kubelet不会管理不是由k8s创建的容器</p></li><li><p>kube-proxy</p><p>kube-proxy运行集群中每个节点上的网络代理，实现k8s服务(Service)的一部分。</p><p>维护节点上的网络规则，这些网络规则会允许从集群内部或外部的网络会话与Pod进行网络通信</p></li><li><p>容器运行时(Container Runtime)</p><p>容器运行环境是负责运行容器的软件</p><p>containerd、CRI-O、Docker(1.24开始需要安装cri-dockerd)、Podman等遵循CRI标准</p></li></ul><h1 id="Pod创建流程"><a href="#Pod创建流程" class="headerlink" title="Pod创建流程"></a>Pod创建流程</h1><ol><li>用户通过kubectl等方式向ApiServer发送请求，需要创建新Pod</li><li>ApiServer验证请求身份信息无误后将新Pod的信息写入etcd中</li><li>ControllerManager通过ApiServer的watch(监视)接口发现了新的Pod信息更新，将该资源所依赖的拓扑结构进行整合，整合后将信息提交给ApiServer，通过ApiServer写入到etcd，此时Pod以及可以被调度了</li><li>Scheduler通过ApiServer的watch接口更新发现Pod可以被调度，通过算法给Pod分配节点，并将Pod和对应节点绑定的信息交给ApiServer，通过ApiServer写入到etcd，然后将PodSpecs交给kubelet</li><li>kubelet收到PodSpecs后，通过调用CRI，CNI、CSI去对容器、网络、存储等资源进行创建</li><li>容器、网络、存储创建完成后Pod创建完成。</li></ol><h1 id="Pod的生命周期"><a href="#Pod的生命周期" class="headerlink" title="Pod的生命周期"></a>Pod的生命周期</h1><p>Pod 在其生命周期中只会被调度一次。 一旦 Pod 被调度（分派）到某个节点，Pod 会一直在该节点运行，直到 Pod 停止或者被终止</p><p><strong>Pod 被认为是相对临时性（而不是长期存在）的实体</strong>。 Pod 会被创建、赋予一个唯一的 ID（UID）， 并被调度到节点，并在终止（根据重启策略）或删除之前一直运行在该节点</p><p><strong>Pod 自身不具有自愈能力</strong>。如果 Pod 被调度到某节点而该节点之后失效， Pod 会被删除；类似地，<strong>Pod 无法在因节点资源耗尽或者节点维护而被驱逐期间继续存活</strong>。</p><p>Pod不会被重新调度到不同的节点，只会被一个新的，且几乎完全相同的Pod替换掉，新的Pod名字可以不变，但是UID会不一样</p><h2 id="Pod阶段"><a href="#Pod阶段" class="headerlink" title="Pod阶段"></a>Pod阶段</h2><ul><li><p>Pending（等待）</p><p>有一个或者多个容器未创建或未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间</p></li><li><p>Running</p><p>Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态</p></li><li><p>Succeeded</p><p>Pod 中的所有容器都已成功终止，并且不会再重启</p></li><li><p>Failed</p><p>Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止</p></li><li><p>Unknown</p><p>因为某些原因无法取得 Pod 的状态</p></li></ul><h2 id="容器状态"><a href="#容器状态" class="headerlink" title="容器状态"></a>容器状态</h2><ul><li><p>Waiting</p><p>如果容器并不处在 <code>Running</code> 或 <code>Terminated</code> 状态之一，它就处在 <code>Waiting</code> 状态。 处于 <code>Waiting</code> 状态的容器仍在运行它完成启动所需要的操作：例如， 从某个容器镜像仓库拉取容器镜像，或者向容器应用 Secret数据等等。 当你使用 <code>kubectl</code> 来查询包含 <code>Waiting</code> 状态的容器的 Pod 时，会看到一个 Reason 字段，其中给出了容器处于等待状态的原因</p></li><li><p>Running</p><p>状态表明容器正在执行状态并且没有问题发生</p></li><li><p>Terminated</p><p>容器已经开始执行并且或者正常结束或者因为某些原因失败</p></li></ul><h2 id="容器探针"><a href="#容器探针" class="headerlink" title="容器探针"></a>容器探针</h2><p>probe是由kubelet对容器执行的定期诊断</p><h3 id="检查机制"><a href="#检查机制" class="headerlink" title="检查机制"></a>检查机制</h3><ul><li><p>exec</p><p>在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</p></li><li><p>grpc</p><p>使用gRPC执行一个远程过程调用</p></li><li><p>httpGet</p><p>对容器的 IP 地址上指定端口和路径执行 HTTP <code>GET</code> 请求</p></li><li><p>tcpSocket</p><p>对容器的 IP 地址上的指定端口执行 TCP 检查。如果端口打开，则诊断被认为是成功的</p></li></ul><h3 id="探测结果"><a href="#探测结果" class="headerlink" title="探测结果"></a>探测结果</h3><ul><li><p>Success</p><p>容器通过了诊断</p></li><li><p>Failure</p><p>容器未通过诊断</p></li><li><p>Unknown</p><p>诊断失败</p></li></ul><h3 id="探测类型"><a href="#探测类型" class="headerlink" title="探测类型"></a>探测类型</h3><ul><li><p>LivenessProbe（持续运行）</p><p>存活探针，探测容器是否正在运行，如果探测失败，kubelet会杀死容器，并根据重启策略来决定后续</p></li><li><p>ReadingessProbe（持续运行）</p><p>就绪探针，探测容器是否准备好提供服务，如果探测失败，端点控制器将从与Pod匹配的端点列表中删除该Pod的IP地址</p></li><li><p>StartupProbe（容器创建时运行一次）</p><p>启动探针，探测容器是否以及启动，如果使用启动探针，则其他探针都会被禁用，知道此探针成功为止。如果探测失败，kubelet将杀死容器，并根据其重启策略来决定后续</p></li></ul><h2 id="initC-初始容器"><a href="#initC-初始容器" class="headerlink" title="initC(初始容器)"></a>initC(初始容器)</h2><p>Init 容器是一种特殊容器，在Pod内的应用容器启动之前运行，每个 Pod中可以包含多个容器， 应用运行在这些容器里面，同时 Pod 也可以有一个或多个先于应用容器启动的 Init 容器。如果init容器运行失败，kublet会不断的重启init容器知道该容器成功为止。</p><p><strong>init容器不支持探针，且如果有多个init容器，这些容器将按照顺序执行，当上一个init容器运行成功后，下一个init容器才能运行。所有的init容器运行完成后，k8s才会初始化Pod并运行</strong></p><p><strong>init容器可以限制资源使用率以及重启策略</strong></p><h2 id="容器钩子-Container-hooks"><a href="#容器钩子-Container-hooks" class="headerlink" title="容器钩子(Container hooks)"></a>容器钩子(Container hooks)</h2><ul><li><p><strong>PostStart(容器启动后)</strong></p><p>这个钩子会在容器创建之后立即被执行，但是不能保证钩子会在容器入口点(ENTRYPOINT)之前执行</p></li><li><p><strong>PreStop(容器结束前)</strong></p><p>在容器因API或管理事件(探针、资源抢占等)而被终止之前，此钩子会被调用，如果容器已经处于已终止或已完成状态，则PreStop钩子的调用失败</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Systemd-Unit配置</title>
      <link href="/archives/38fea313.html"/>
      <url>/archives/38fea313.html</url>
      
        <content type="html"><![CDATA[<h1 id="Unit相关"><a href="#Unit相关" class="headerlink" title="Unit相关"></a>Unit相关</h1><ol><li><p>unit相关文件目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/lib/systemd/system# 本地的系统单元</span><br><span class="line">/run/systemd/system# 运行时的系统单元</span><br><span class="line">/usr/lib/systemd/system# 第三方的系统单元</span><br><span class="line">/etc/systemd/system# Systgemd默认从这个目录读取单元</span><br><span class="line">/etc/systemd/system/multi-user.target.wants# systemd开机自动启动此目录的单元,当配置enable时就会自动创建链接文件到此目录</span><br></pre></td></tr></table></figure></li><li><p>unit分类</p><ul><li><strong>Service Unit：系统服务</strong></li><li><strong>Target Unit：由多个Unit构成的</strong></li><li>Device Unit：硬件设备</li><li>Mount Unit：文件系统的挂载点</li><li>Automount Unit：自动挂载点</li><li>Path Unit：文件或路径</li><li>Slice Unit：进程组</li><li>Snapshot Unit：快照</li><li>Socket Unit：进程间通信的Socket</li><li>Swap Unit：Swap文件</li><li>Time Unit：定时器</li></ul><p><strong>查看单元命令</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway ~]# systemctl list-units# 查看正在运行的Unit</span><br><span class="line">[root@gateway ~]# systemctl list-units --all# 查看所有的Unit</span><br><span class="line">[root@gateway ~]# systemctl list-units --all --state=inactive# 查看没有运行的Unit</span><br><span class="line">[root@gateway ~]# systemctl list-units --failed# 查看加载失败的Unit</span><br></pre></td></tr></table></figure></li></ol><h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway ~]# systemctl start nginx# 启动服务</span><br><span class="line">[root@gateway ~]# systemctl status nginx# 查看服务状态</span><br><span class="line">[root@gateway ~]# systemctl stop nginx# 停止服务</span><br><span class="line">[root@gateway ~]# systemctl kill nginx# 杀死与服务相关的子进程</span><br><span class="line">[root@gateway ~]# systemctl reload nginx# 重载服务的配置</span><br><span class="line">[root@gateway ~]# systemctl daemon-reload# 重载所有修改过的配置</span><br><span class="line">[root@gateway ~]# systemctl show nginx# 查看服务所有配置</span><br><span class="line">[root@gateway ~]# systemctl list-dependencies nginx# 查看服务的依赖关系</span><br><span class="line">[root@gateway ~]# systemctl cat nginx.service# 查看服务的配置文件</span><br></pre></td></tr></table></figure><h1 id="创建Service-Unit"><a href="#创建Service-Unit" class="headerlink" title="创建Service Unit"></a>创建Service Unit</h1><h2 id="查看Service-Unit"><a href="#查看Service-Unit" class="headerlink" title="查看Service Unit"></a>查看Service Unit</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway ~]# systemctl cat nginx.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginx will fail to start <span class="keyword">if</span> /run/nginx.pid already exists but has the wrong</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SELinux context. This might happen when running `nginx -t` from the cmdline.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://bugzilla.redhat.com/show_bug.cgi?<span class="built_in">id</span>=1268621</span></span><br><span class="line">ExecStartPre=/usr/bin/rm -f /run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">KillMode=mixed</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="配置格式"><a href="#配置格式" class="headerlink" title="配置格式"></a>配置格式</h2><p>官网配置大全：<a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">(www.freedesktop.org)</a></p><p>通常Service配置文件如下分为三大块</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">...</span><br><span class="line">[Service]</span><br><span class="line">...</span><br><span class="line">[Install]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>[Unit]</strong>: 用来配置元数据以及与其他Unit的关系</p><ul><li><strong>Description</strong> 描述</li><li><strong>Documentation</strong> 文档地址</li><li><strong>Requires</strong> 如果此字段的Unit没有启动，则Unit会启动失败</li><li><strong>Wants</strong> 如果此字段的Unit没有启动，则Unit不会启动失败</li><li><strong>BindsTo</strong> 此字段的Unit退出，此Unit会停止运行</li><li><strong>Before</strong> 此字段的Unit要启动，那么必须要在当前Unit启动之后</li><li><strong>After</strong> 此字段的Unit要启动，那么必须要在当前Unit启动之前</li><li><strong>Conflicts</strong> 此字段的Unit不能与当前Unit同时启动</li></ul><p><strong>[Service]</strong>: 用来定义服务(程序)的配置，只有Service类型的Unit才有这个配置</p><ul><li><strong>Type</strong>: 定义启动时进程的行为<ul><li><strong>simple</strong>：默认值，执行ExecStart指定的命令</li><li>forking：以fork方式从父进程创建子进程，创建后父进程会立即退出</li><li>oneshot：一次性进程，Systemd会等待当前服务退出再继续执行</li><li>dbus：当前服务通过D-bus启动</li><li>notify：当前服务启动完毕后，会通知Systemd再继续往下执行</li></ul></li><li><strong>ExecStart</strong>：启动当前服务的命令</li><li>ExecStartPre：启动当前服务之前执行的命令</li><li>ExecStartPost：启动当前服务之后执行的命令</li><li>ExecReload：重启当前服务时执行的命令</li><li>ExecStop：停止当前服务时执行的命令</li><li>ExecStopPort：停止当前服务之后执行的命令</li><li><strong>RestartSec</strong>：自动重启当前服务的间隔秒数</li><li><strong>Restart</strong>：定义重启策略<ul><li>always总是重启</li><li>on-success</li><li>on-failure</li><li>on-abnormal</li><li>no-abort</li><li>on-watchdog</li></ul></li><li>TimeoutSec：停止当前服务之前等待多少秒</li><li><strong>Environment</strong>：指定环境变量</li></ul><p><strong>[Install]</strong>: 用来定义程序如何启动以及是否开启自启</p><ul><li><strong>WantedBy</strong> 此字段的值是一个或多个Target，当前 Unit 激活时（enable）符号链接会放入<code>/etc/systemd/system</code>目录下面以 Target 名 + <code>.wants</code>后缀构成的子目录中(<strong>enable时才会自启</strong>)</li><li><strong>RequiredBy</strong> 此字段的值是一个或多个Target，它的值是一个或多个 Target，当前 Unit 激活时，符号链接会放入<code>/etc/systemd/system</code>目录下面以 Target 名 + <code>.required</code>后缀构成的子目录中(<strong>start就自启</strong>)</li><li><strong>Alias</strong>：别名</li><li><strong>Also</strong>：当前Unit激活时(enable)，同时激活其他的Unit</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Systemd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>etcd备份和检查集群状态命令</title>
      <link href="/archives/f2101881.html"/>
      <url>/archives/f2101881.html</url>
      
        <content type="html"><![CDATA[<h1 id="etcd备份命令"><a href="#etcd备份命令" class="headerlink" title="etcd备份命令"></a>etcd备份命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前提需要安装etcdctl工具</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/etcd-io/etcd/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看etcd集群状态</span></span><br><span class="line">[root@master1 ~]# etcdctl \</span><br><span class="line">--endpoints master1.xiaowangc.local:2379,master2.xiaowangc.local:2379,master3.xiaowangc.local:2379 \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">--write-out=table endpoint status </span><br><span class="line"></span><br><span class="line">+------------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|           ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+------------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| master1.xiaowangc.local:2379 | 4e2cf6f6c40333c8 |   3.5.5 |  5.2 MB |     false |      false |         8 |      69635 |              69635 |        |</span><br><span class="line">| master2.xiaowangc.local:2379 | 7308778bf3dd1f82 |   3.5.5 |  5.2 MB |      true |      false |         8 |      69635 |              69635 |        |</span><br><span class="line">| master3.xiaowangc.local:2379 | 99148080d033de44 |   3.5.5 |  5.3 MB |     false |      false |         8 |      69635 |              69635 |        |</span><br><span class="line">+------------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看etcd集群状态</span></span><br><span class="line">[root@master1 ~]# etcdctl \</span><br><span class="line">--endpoints master1.xiaowangc.local:2379,master2.xiaowangc.local:2379,master3.xiaowangc.local:2379 \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/server.key endpoint health</span><br><span class="line"></span><br><span class="line">master3.xiaowangc.local:2379 is healthy: successfully committed proposal: took = 8.169826ms</span><br><span class="line">master2.xiaowangc.local:2379 is healthy: successfully committed proposal: took = 10.849518ms</span><br><span class="line">master1.xiaowangc.local:2379 is healthy: successfully committed proposal: took = 8.282098ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份命令</span></span><br><span class="line">[root@master1 ~]# etcdctl \</span><br><span class="line">--endpoints master1.xiaowangc.local:2379 \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/server.key snapshot save my.db</span><br><span class="line"></span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-11-23T23:44:32.593+0800&quot;,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:65&quot;,&quot;msg&quot;:&quot;created temporary db file&quot;,&quot;path&quot;:&quot;my.db.part&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-11-23T23:44:32.598+0800&quot;,&quot;logger&quot;:&quot;client&quot;,&quot;caller&quot;:&quot;v3@v3.5.6/maintenance.go:212&quot;,&quot;msg&quot;:&quot;opened snapshot stream; downloading&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-11-23T23:44:32.598+0800&quot;,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:73&quot;,&quot;msg&quot;:&quot;fetching snapshot&quot;,&quot;endpoint&quot;:&quot;master1.xiaowangc.local:2379&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-11-23T23:44:32.630+0800&quot;,&quot;logger&quot;:&quot;client&quot;,&quot;caller&quot;:&quot;v3@v3.5.6/maintenance.go:220&quot;,&quot;msg&quot;:&quot;completed snapshot read; closing&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-11-23T23:44:32.634+0800&quot;,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:88&quot;,&quot;msg&quot;:&quot;fetched snapshot&quot;,&quot;endpoint&quot;:&quot;master1.xiaowangc.local:2379&quot;,&quot;size&quot;:&quot;5.2 MB&quot;,&quot;took&quot;:&quot;now&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-11-23T23:44:32.634+0800&quot;,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:97&quot;,&quot;msg&quot;:&quot;saved&quot;,&quot;path&quot;:&quot;my.db&quot;&#125;</span><br><span class="line">Snapshot saved at my.db</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看备份</span></span><br><span class="line">[root@master1 ~]# etcdctl \</span><br><span class="line">--endpoints master1.xiaowangc.local:2379 \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">--write-out=table snapshot status my.db</span><br><span class="line"></span><br><span class="line">Deprecated: Use `etcdutl snapshot status` instead.</span><br><span class="line"></span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line">| 9c4365f3 |    52313 |       1941 |     5.2 MB |</span><br><span class="line">+----------+----------+------------+------------+</span><br><span class="line"></span><br><span class="line">[root@master1 etcd_backup]# vi backup.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">简单的备份脚本自行添加到定时任务执行</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/bin/bash</span></span><br><span class="line">/usr/local/sbin/etcdctl \</span><br><span class="line">--endpoints master1.xiaowangc.local:2379 \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">--write-out=table snapshot save /root/etcd_backup/`date +%Y%m%d%H%M`.db</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> etcd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> etcd </tag>
            
            <tag> 备份 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentoOS8 TLS目录</title>
      <link href="/archives/9b886d63.html"/>
      <url>/archives/9b886d63.html</url>
      
        <content type="html"><![CDATA[<p>快速帮助1：要将简单PEM或DER文件格式的证书添加到系统上受信任的CA列表中，请执行以下操作：<br>·将其作为新文件添加到&#x2F;etc&#x2F;pki&#x2F;catrust&#x2F;source&#x2F;achors目录&#x2F;<br>·运行更新ca信任提取</p><p>快速帮助2：如果您的证书是扩展的BEGIN TRUSTED文件格式（可能包含不信任&#x2F;黑名单信任标志，或TLS以外的其他用途的信任标志），则：<br>·将其作为新文件添加到&#x2F;etc&#x2F;pki&#x2F;catrust&#x2F;source目录&#x2F;<br>·运行更新ca信任提取</p><p>为了提供简单性和灵活性，证书文件的处理方式取决于它们安装到的子目录。<br>·简单信任锚子目录：&#x2F;usr&#x2F;share&#x2F;pki&#x2F;ca-trust-source&#x2F;achors&#x2F;或&#x2F;etc&#x2F;pki&#x2F;ca-trust&#x2F;source&#x2F;achors&#x2F;<br>·简单黑名单（不信任）子目录：&#x2F;usr&#x2F;share&#x2F;pki&#x2F;ca-trust-source&#x2F;blact&#x2F;或&#x2F;etc&#x2F;pki&#x2F;ca-trust&#x2F;source&#x2F;black&#x2F;<br>·扩展格式目录：&#x2F;usr&#x2F;share&#x2F;pki&#x2F;ca-trust-source&#x2F;或&#x2F;etc&#x2F;pki&#x2F;ca-trust&#x2F;source&#x2F;</p><p>在主目录&#x2F;usr&#x2F;share&#x2F;pki&#x2F;ca-trust-source&#x2F;或&#x2F;etc&#x2F;pki&#x2F;ca-trust&#x2F;source&#x2F;中，可以安装以下文件格式的一个或多个文件：<br>·包含信任标志的证书文件，采用BEGIN&#x2F;END TRUSTED certificate文件格式（任何文件名），这些文件是使用openssl x509工具和-addreject创建的<br>-添加信任选项。支持具有多个证书的捆绑文件。</p><p>·p11工具包文件格式的文件，使用.p11工具包文件扩展名，可以（例如）用于基于序列号和颁发者名称不信任证书，而不具有完整的证书可用。（这目前是一种未记录的格式，稍后将进行扩展。有关支持的格式的示例，请参阅ca证书包附带的文件。）</p><p>·没有信任标志的DER文件格式或PEM（BEGIN&#x2F;END certificate）文件格式（任何文件名）的证书文件。此类文件将以中立信任添加既不信任也不信任。系统只需知道它们，这可能有助于密码软件构建证书链。（如果您需要CA要信任这些文件格式的证书，您应该将其从该目录中删除，并将其移至.&#x2F;anchors子目录。）</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> TLS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS8安装中文语言包</title>
      <link href="/archives/6dcdc915.html"/>
      <url>/archives/6dcdc915.html</url>
      
        <content type="html"><![CDATA[<h1 id="CentOS8安装中文语言包"><a href="#CentOS8安装中文语言包" class="headerlink" title="CentOS8安装中文语言包"></a>CentOS8安装中文语言包</h1><p>[root@gateway ~]# dnf -y install langpacks-zh_CN<br>[root@gateway ~]# vi &#x2F;etc&#x2F;locale.conf<br>LANG&#x3D;”zh_CN.UTF-8”<br>[root@gateway ~]# LANG&#x3D;”zh_CN.UTF-8”</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> LANG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker安装k8s 1.24+</title>
      <link href="/archives/847c320a.html"/>
      <url>/archives/847c320a.html</url>
      
        <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正常安装Docker并配置sysstemd驱动,K8S前置条件基本不变除了Docker环节</span></span><br><span class="line">[root@master1 ~]# cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">        &quot;registry-mirrors&quot;: [&quot;https://vrm5w46o.mirror.aliyuncs.com&quot;],</span><br><span class="line">        &quot;insecure-registries&quot;: [&quot;https://harbor.xiaowangc.local&quot;]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载cri-docker,我这里环境是CentOS8所以直接用rpm安装</span></span><br><span class="line">cri-docker地址: https://github.com/Mirantis/cri-dockerd/</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.2.6/cri-dockerd-0.2.6-3.el8.x86_64.rpm</span><br><span class="line">[root@master1 ~]# dnf -y install cri-dockerd-0.2.6-3.el8.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改pause版本  1.24.x版本应该用的是3.6  我这里是1.25.x所以改成3.8</span></span><br><span class="line">[root@master1 ~]# vi /lib/systemd/system/cri-docker.service</span><br><span class="line">...</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.8</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# systemctl enable --now cri-docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化</span></span><br><span class="line">[root@master1 ~]# kubeadm init --control-plane-endpoint api.xiaowangc.local:16443 \</span><br><span class="line">--upload-certs --apiserver-advertise-address 192.168.10.1 \</span><br><span class="line">--pod-network-cidr 172.21.0.0/16 --service-cidr 172.22.0.0/16 \</span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \</span><br><span class="line">--cri-socket unix:///run/cri-dockerd.sock</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux开启IP路由</title>
      <link href="/archives/ccf900ab.html"/>
      <url>/archives/ccf900ab.html</url>
      
        <content type="html"><![CDATA[<h1 id="Linux开启IP路由"><a href="#Linux开启IP路由" class="headerlink" title="Linux开启IP路由"></a>Linux开启IP路由</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久生效</span></span><br><span class="line">[root@xiaowangc ~]# vi /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">[root@xiaowangc ~]# sysctl -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时生效</span></span><br><span class="line">[root@xiaowangc ~]# echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否开启IP路由</span></span><br><span class="line">[root@xiaowangc ~]# cat /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启Nat</span></span><br><span class="line">[root@xiaowangc ~]# iptables -t nat -A POSTROUTING -s $(内部网段) -j SNAT --to $(本机出口地址)</span><br><span class="line">[root@xiaowangc ~]# iptables -t nat -A POSTROUTING -s 192.168.64.0/24 -j SNAT --to 172.16.1.1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Route </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes网络策略</title>
      <link href="/archives/5b1fc607.html"/>
      <url>/archives/5b1fc607.html</url>
      
        <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="网络策略"><a href="#网络策略" class="headerlink" title="网络策略"></a>网络策略</h2><p>在kubernetes集群中可以使用网络策略(NetworkPolicy)对Pod的IP或端口进行网络流量控制，NetworkPolicy是一种以应用为中心的结构，允许Pod与网络上的各类实体通信，<strong>NetworkPolicies适用于一端或者两端与Pod的连接，与其他连接无关</strong></p><p>Pod是通过如下三个标识符的组合来辨识的：</p><ul><li>被允许的Pods</li><li>被允许的名称空间</li><li>IP组</li></ul><h2 id="隔离类型"><a href="#隔离类型" class="headerlink" title="隔离类型"></a>隔离类型</h2><p>Pod有两种隔离：</p><ul><li>出口隔离</li><li>入口隔离</li></ul><p>默认情况下，一个Pod的出口是非隔离的，所有向外的连接都是被允许的。如果有<code>网络策略</code>选择改Pod并在其<code>policyTypes</code>中包含了<code>Egress</code>，则改Pod的出口是隔离的；这样的策略适用于该Pod的出口，当Pod的出口被隔离时，则Pod的连接必须符合<code>NetworkPolicy</code>中的<code>egress</code>的策略，<code>egress</code>列表中的策略效果是相加的</p><p>Ingress同理，Pod的入口是非隔离的，所有向内的连接都是被允许的。如果有<code>网络策略</code>选择改Pod并在其<code>policyTypes</code>中包含了<code>Ingress</code>，则改Pod的入口是隔离的；这样的策略适用于该Pod的入口，当Pod的入口被隔离时，则Pod的连接必须符合<code>NetworkPolicy</code>中的<code>Ingress</code>的策略，<code>Ingress</code>列表中的策略效果是相加的</p><h2 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h2><p>两种行为：</p><ul><li>from(源)：从哪来</li><li>to(目的)：到哪去</li></ul><p>四种选择器：</p><ul><li><p><strong>PodSelector</strong></p><p>此选择器在Network的名称空间中选择特定的Pod，将其作为流量的入站目的地或出站来源</p></li><li><p><strong>namespaceSelector</strong></p><p>此选择器将选择特定的名称空间，将所有的Pod的流量作为入站目的地或出站来源</p></li><li><p><strong>namespaceSelector和podselector</strong></p><p>此选择器将特定名称空间下特定的Pod作为流量作为入站目的地或出站来源</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这种写法from列表包含一个元素，只允许来自标有role=client的Pod且该Pod所在的名称空间标有user=alice的连接</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"> <span class="attr">ingress:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">       <span class="attr">matchLabels:</span></span><br><span class="line">         <span class="attr">user:</span> <span class="string">alice</span></span><br><span class="line">     <span class="attr">podSelector:</span></span><br><span class="line">       <span class="attr">matchLabels:</span></span><br><span class="line">         <span class="attr">role:</span> <span class="string">client</span></span><br><span class="line"> <span class="string">...</span>  </span><br><span class="line"> </span><br><span class="line"> <span class="comment">#######################################################################</span></span><br><span class="line"> <span class="comment"># 这种写法from列表包含两个元素，允许来自标有role=client的Pod的连接，或来自名称空间标有user=alice</span></span><br><span class="line"> <span class="string">...</span></span><br><span class="line"> <span class="attr">ingress:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">       <span class="attr">matchLabels:</span></span><br><span class="line">         <span class="attr">user:</span> <span class="string">alice</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">       <span class="attr">matchLabels:</span></span><br><span class="line">         <span class="attr">role:</span> <span class="string">client</span></span><br><span class="line"> <span class="string">...</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ipBlock</strong></p><p>此选择器将选择特定的IP CIDR范围以作为入站流量来源或出站流量的目的地</p></li></ul><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy策略</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span><span class="comment"># 在默认名称空间创建test-network-policy策略</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span><span class="comment"># pod选择器用于作为流量入站或出站的目的地</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span><span class="comment"># 带有role: db标签的Pod作为流量的目的地</span></span><br><span class="line">  <span class="attr">policyTypes:</span><span class="comment"># 策略类型,对进站和出站进行限制</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">ingress:</span><span class="comment"># 进站规则</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">from:</span><span class="comment"># 来源 </span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ipBlock:</span><span class="comment"># (进站流量)来源必须符合172.17.0.0/16IP段的,且不是172.17.1.0/24段的IP的流量进入默认名称空间</span></span><br><span class="line">            <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">            <span class="attr">except:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="number">172.17</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">namespaceSelector:</span><span class="comment"># (进站流量)来源必须是project: myproject名称空间的流量进入默认名称空间</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">project:</span> <span class="string">myproject</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">podSelector:</span><span class="comment"># (进站流量)来源必须是标签为role: frontend的Pod的流量进入默认名称空间</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">      <span class="attr">ports:</span><span class="comment"># (进站流量)来自符合上面条件且目的端口是6379/TCP的流量</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">egress:</span><span class="comment"># 出站规则</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span><span class="comment"># 到哪</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ipBlock:</span><span class="comment"># (出站流量)只允许默认名称空间的流量到10.0.0.0/24网络</span></span><br><span class="line">            <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">ports:</span><span class="comment"># (出站流量)来自符合上面条件且目的端口是5978/TCP的流量</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">5978</span></span><br></pre></td></tr></table></figure><h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p><img src="/archives/5b1fc607/image-20221119015610802.png" alt="image-20221119015610802"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master networkpolicy]# kubectl get pod -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">app01   1/1     Running   0          11m   172.11.196.133   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">app02   1/1     Running   0          10m   172.11.196.134   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@master networkpolicy]# kubectl get pod -o wide -n app02</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">app01   1/1     Running   0          6m18s   172.11.196.135   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">app02   1/1     Running   0          5m46s   172.11.196.136   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@master networkpolicy]# kubectl get pod -o wide -n app03</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">app01   1/1     Running   0          4m36s   172.11.140.73    node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">app02   1/1     Running   0          4m13s   172.11.196.137   node01   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="禁止访问Default"><a href="#禁止访问Default" class="headerlink" title="禁止访问Default"></a>禁止访问Default</h2><p><img src="/archives/5b1fc607/image-20221119015904520.png" alt="image-20221119015904520"></p><ol><li><p>测试默认情况下是否能访问</p><blockquote><p>下面实验结论在没有策略的情况下不同名称空间的Pod网络是互通的</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master networkpolicy]# kubectl exec -it app01 -n app02 -- sh</span><br><span class="line">/ # ping 172.11.196.133</span><br><span class="line">PING 172.11.196.133 (172.11.196.133): 56 data bytes</span><br><span class="line">64 bytes from 172.11.196.133: seq=0 ttl=63 time=0.102 ms</span><br><span class="line">64 bytes from 172.11.196.133: seq=1 ttl=63 time=0.095 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.11.196.133 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.095/0.098/0.102 ms</span><br><span class="line">/ # ping 172.11.196.134</span><br><span class="line">PING 172.11.196.134 (172.11.196.134): 56 data bytes</span><br><span class="line">64 bytes from 172.11.196.134: seq=0 ttl=63 time=0.108 ms</span><br><span class="line">64 bytes from 172.11.196.134: seq=1 ttl=63 time=0.092 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.11.196.134 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.092/0.100/0.108 ms</span><br><span class="line"></span><br><span class="line">==================================================================================================</span><br><span class="line">[root@master networkpolicy]# kubectl exec -it app02 -n app03 -- sh</span><br><span class="line">/ # ping 172.11.196.133</span><br><span class="line">PING 172.11.196.133 (172.11.196.133): 56 data bytes</span><br><span class="line">64 bytes from 172.11.196.133: seq=0 ttl=63 time=0.102 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.11.196.133 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.102/0.102/0.102 ms</span><br><span class="line">/ # ping 172.11.196.134</span><br><span class="line">PING 172.11.196.134 (172.11.196.134): 56 data bytes</span><br><span class="line">64 bytes from 172.11.196.134: seq=0 ttl=63 time=0.086 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.11.196.134 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.086/0.086/0.086 ms</span><br></pre></td></tr></table></figure></li><li><p>创建网络策略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master networkpolicy]# vi network01.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: deny-all-in</span><br><span class="line">spec:</span><br><span class="line">  podSelector: &#123;&#125;</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line">  </span><br><span class="line">[root@master networkpolicy]# kubectl apply -f network01.yaml</span><br><span class="line">networkpolicy.networking.k8s.io/deny-all-in created</span><br></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master networkpolicy]# kubectl exec -it app01 -n app02 -- sh</span><br><span class="line">/ # ping 172.11.196.133</span><br><span class="line">PING 172.11.196.133 (172.11.196.133): 56 data bytes</span><br><span class="line"></span><br><span class="line">--- 172.11.196.133 ping statistics ---</span><br><span class="line">33 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">无响应</span></span><br><span class="line">/ # ping 172.11.196.134</span><br><span class="line">PING 172.11.196.134 (172.11.196.134): 56 data bytes</span><br><span class="line"></span><br><span class="line">--- 172.11.196.134 ping statistics ---</span><br><span class="line">24 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">无响应</span></span><br></pre></td></tr></table></figure><p><strong>注意：</strong></p><p><strong>只是禁止了所有流量进入default名称空间，不是真的所有的流量都无法进入，default名称空间下Pod的响应流量是可以回来的</strong></p><p><strong>禁止所有流量出站，同理将策略的Ingress改成Egress。同理，自己的请求流量无法出站，但是响应可以</strong></p><p>同时拒绝进站出站流量，需要将两个一起加上即可</p></li><li><p>清除策略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master networkpolicy]# kubectl delete -f network01.yaml</span><br><span class="line">networkpolicy.networking.k8s.io &quot;deny-all-in&quot; deleted</span><br></pre></td></tr></table></figure></li></ol><h2 id="只允许app02空间访问app03名称空间的80端口"><a href="#只允许app02空间访问app03名称空间的80端口" class="headerlink" title="只允许app02空间访问app03名称空间的80端口"></a>只允许app02空间访问app03名称空间的80端口</h2><p><img src="/archives/5b1fc607/image-20221119023505044.png" alt="image-20221119023505044"></p><ol><li><p>确保之前测试的网络策略删除了</p></li><li><p>查看namespace标签</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master networkpolicy]# kubectl get ns --show-labels</span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">app02             Active   96m   kubernetes.io/metadata.name=app02</span><br><span class="line">app03             Active   96m   kubernetes.io/metadata.name=app03</span><br><span class="line">default           Active   32d   kubernetes.io/metadata.name=default</span><br><span class="line">kube-node-lease   Active   32d   kubernetes.io/metadata.name=kube-node-lease</span><br><span class="line">kube-public       Active   32d   kubernetes.io/metadata.name=kube-public</span><br><span class="line">kube-system       Active   32d   kubernetes.io/metadata.name=kube-system</span><br></pre></td></tr></table></figure></li><li><p>创建网络策略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master networkpolicy]# kubectl get ns --show-labels</span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">app02             Active   96m   kubernetes.io/metadata.name=app02</span><br><span class="line">app03             Active   96m   kubernetes.io/metadata.name=app03</span><br><span class="line">default           Active   32d   kubernetes.io/metadata.name=default</span><br><span class="line">kube-node-lease   Active   32d   kubernetes.io/metadata.name=kube-node-lease</span><br><span class="line">kube-public       Active   32d   kubernetes.io/metadata.name=kube-public</span><br><span class="line">kube-system       Active   32d   kubernetes.io/metadata.name=kube-system</span><br><span class="line">[root@master networkpolicy]# vi network02.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: allow-app02-in</span><br><span class="line">  namespace: app03</span><br><span class="line">spec:</span><br><span class="line">  podSelector: &#123;&#125;</span><br><span class="line">  policyTypes:</span><br><span class="line">    - Ingress</span><br><span class="line">  ingress:</span><br><span class="line">    - from:</span><br><span class="line">        - namespaceSelector:</span><br><span class="line">            matchLabels:</span><br><span class="line">              kubernetes.io/metadata.name: app02</span><br><span class="line">      ports:</span><br><span class="line">        - protocol: TCP</span><br><span class="line">          port: 80</span><br><span class="line">[root@master networkpolicy]# kubectl apply -f network02.yaml</span><br><span class="line">networkpolicy.networking.k8s.io/allow-app02-in created</span><br></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### app02名称空间的Pod可以访问app03名称空间的Pod</span></span></span><br><span class="line"></span><br><span class="line">[root@master networkpolicy]# kubectl exec -it app01 -n app02 -- sh</span><br><span class="line">/ # curl 172.11.140.73</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">/ # curl 172.11.196.137</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">/ #</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### default名称空间的Pod不可以访问app03名称空间的Pod</span></span></span><br><span class="line"></span><br><span class="line">[root@master networkpolicy]# kubectl exec -it app01 -- sh</span><br><span class="line">/ # curl 172.11.196.137</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">卡死(超时)</span></span><br><span class="line">/ # ping 172.11.196.137</span><br><span class="line">PING 172.11.196.137 (172.11.196.137): 56 data bytes</span><br><span class="line">^C</span><br><span class="line">--- 172.11.196.137 ping statistics ---</span><br><span class="line">8 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同样无法ping通</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> CKS </tag>
            
            <tag> 安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus-PromQL</title>
      <link href="/archives/de9e970e.html"/>
      <url>/archives/de9e970e.html</url>
      
        <content type="html"><![CDATA[<h1 id="理解时间序列"><a href="#理解时间序列" class="headerlink" title="理解时间序列"></a>理解时间序列</h1><p>通过Node Exporter暴露的HTTP服务，Prometheus可以采集到当前主机所有监控指标的样本数据。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># HELP node_cpu Seconds the cpus spent in each mode.</span><br><span class="line"># TYPE node_cpu counter</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;idle&quot;&#125; 362812.7890625</span><br><span class="line"># HELP node_load1 1m load average.</span><br><span class="line"># TYPE node_load1 gauge</span><br><span class="line">node_load1 3.0703125</span><br></pre></td></tr></table></figure><p>其中非#开头的每一行表示当前Node Exporter采集到的一个监控样本：node_cpu和node_load1表明了当前指标的名称、大括号中的标签则反映了当前样本的一些特征和维度、浮点数则是该监控样本的具体值。</p><h2 id="样本"><a href="#样本" class="headerlink" title="样本"></a>样本</h2><p>Prometheus会将所有采集到的样本数据以时间序列（time-series）的方式保存在内存数据库中，并且定时保存到硬盘上。time-series是按照时间戳和值的序列顺序存放的，我们称之为向量(vector). 每条time-series通过指标名称(metrics name)和一组标签集(labelset)命名。如下所示，可以将time-series理解为一个以时间为Y轴的数字矩阵：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line">│   . . . . . . . . . . . . . . . . .   . .   node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;idle&quot;&#125;</span><br><span class="line">│     . . . . . . . . . . . . . . . . . . .   node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;system&quot;&#125;</span><br><span class="line">│     . . . . . . . . . .   . . . . . . . .   node_load1&#123;&#125;</span><br><span class="line">│     . . . . . . . . . . . . . . . .   . .  </span><br><span class="line">v</span><br><span class="line">  &lt;------------------ 时间 ----------------&gt;</span><br></pre></td></tr></table></figure><p>在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成：</p><ul><li>指标(metric)：metric name和描述当前样本特征的labelsets;</li><li>时间戳(timestamp)：一个精确到毫秒的时间戳;</li><li>样本值(value)： 一个float64的浮点型数据表示当前样本的值。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;--------------- metric ---------------------&gt;&lt;-timestamp -&gt;&lt;-value-&gt;</span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;GET&quot;&#125;@1434417560938 =&gt; 94355</span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;GET&quot;&#125;@1434417561287 =&gt; 94334</span><br><span class="line"></span><br><span class="line">http_request_total&#123;status=&quot;404&quot;, method=&quot;GET&quot;&#125;@1434417560938 =&gt; 38473</span><br><span class="line">http_request_total&#123;status=&quot;404&quot;, method=&quot;GET&quot;&#125;@1434417561287 =&gt; 38544</span><br><span class="line"></span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;POST&quot;&#125;@1434417560938 =&gt; 4748</span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;POST&quot;&#125;@1434417561287 =&gt; 4785</span><br></pre></td></tr></table></figure><h2 id="指标-Metric"><a href="#指标-Metric" class="headerlink" title="指标(Metric)"></a>指标(Metric)</h2><p>在形式上，所有的指标(Metric)都通过如下格式标示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;</span><br></pre></td></tr></table></figure><p>指标的名称(metric name)可以反映被监控样本的含义（比如，<code>http_request_total</code> - 表示当前系统接收到的HTTP请求总量）。指标名称只能由ASCII字符、数字、下划线以及冒号组成并必须符合正则表达式<code>[a-zA-Z_:][a-zA-Z0-9_:]*</code>。</p><p>标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等。标签的名称只能由ASCII字符、数字以及下划线组成并满足正则表达式<code>[a-zA-Z_][a-zA-Z0-9_]*</code>。</p><p>其中以<code>__</code>作为前缀的标签，是系统保留的关键字，只能在系统内部使用。标签的值则可以包含任何Unicode编码的字符。在Prometheus的底层实现中指标名称实际上是以<code>__name__=&lt;metric name&gt;</code>的形式保存在数据库中的，因此以下两种方式均表示的同一条time-series：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api_http_requests_total&#123;method=&quot;POST&quot;, handler=&quot;/messages&quot;&#125;</span><br></pre></td></tr></table></figure><p>等同于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;__name__=&quot;api_http_requests_total&quot;，method=&quot;POST&quot;, handler=&quot;/messages&quot;&#125;</span><br></pre></td></tr></table></figure><p>在Prometheus源码中也可以找到指标(Metric)对应的数据结构，如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Metric LabelSet</span><br><span class="line"></span><br><span class="line">type LabelSet map[LabelName]LabelValue</span><br><span class="line"></span><br><span class="line">type LabelName string</span><br><span class="line"></span><br><span class="line">type LabelValue string</span><br></pre></td></tr></table></figure><h1 id="Metric类型"><a href="#Metric类型" class="headerlink" title="Metric类型"></a>Metric类型</h1><p>在上一小节中我们带领读者了解了Prometheus的底层数据模型，在Prometheus的存储实现上所有的监控样本都是以time-series的形式保存在Prometheus内存的TSDB（时序数据库）中，而time-series所对应的监控指标(metric)也是通过labelset进行唯一命名的。</p><p>从存储上来讲所有的监控指标metric都是相同的，但是在不同的场景下这些metric又有一些细微的差异。 例如，在Node Exporter返回的样本中指标node_load1反应的是当前系统的负载状态，随着时间的变化这个指标返回的样本数据是在不断变化的。而指标node_cpu所获取到的样本数据却不同，它是一个持续增大的值，因为其反应的是CPU的累积使用时间，从理论上讲只要系统不关机，这个值是会无限变大的。</p><p>为了能够帮助用户理解和区分这些不同监控指标之间的差异，Prometheus定义了4种不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要）。</p><p>在Exporter返回的样本数据中，其注释中也包含了该样本的类型。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP node_cpu Seconds the cpus spent in each mode.</span><br><span class="line"># TYPE node_cpu counter</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;idle&quot;&#125; 362812.7890625</span><br></pre></td></tr></table></figure><h2 id="Counter：只增不减的计数器"><a href="#Counter：只增不减的计数器" class="headerlink" title="Counter：只增不减的计数器"></a>Counter：只增不减的计数器</h2><p>Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。</p><p>Counter是一个简单但有强大的工具，例如我们可以在应用程序中记录某些事件发生的次数，通过以时序的形式存储这些数据，我们可以轻松的了解该事件产生速率的变化。<br>PromQL内置的聚合操作和函数可以让用户对这些数据进行进一步的分析：</p><p>例如，通过rate()函数获取HTTP请求量的增长率：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[5m])</span><br></pre></td></tr></table></figure><p>查询当前系统中，访问量前10的HTTP地址：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(10, http_requests_total)</span><br></pre></td></tr></table></figure><h2 id="Gauge：可增可减的仪表盘"><a href="#Gauge：可增可减的仪表盘" class="headerlink" title="Gauge：可增可减的仪表盘"></a>Gauge：可增可减的仪表盘</h2><p>与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。常见指标如：node_memory_MemFree（主机当前空闲的内存大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。</p><p>通过Gauge指标，用户可以直接查看系统的当前状态：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_memory_MemFree</span><br></pre></td></tr></table></figure><p>对于Gauge类型的监控指标，通过PromQL内置函数delta()可以获取样本在一段时间返回内的变化情况。例如，计算CPU温度在两个小时内的差异：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delta(cpu_temp_celsius&#123;host=&quot;zeus&quot;&#125;[2h])</span><br></pre></td></tr></table></figure><p>还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。例如，预测系统磁盘空间在4个小时之后的剩余情况：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[1h], 4 * 3600)</span><br></pre></td></tr></table></figure><h2 id="使用Histogram和Summary分析数据分布情况"><a href="#使用Histogram和Summary分析数据分布情况" class="headerlink" title="使用Histogram和Summary分析数据分布情况"></a>使用Histogram和Summary分析数据分布情况</h2><p>除了Counter和Gauge类型的监控指标以外，Prometheus还定义了Histogram和Summary的指标类型。Histogram和Summary主要用于统计和分析样本的分布情况。</p><p>在大多数情况下人们都倾向于使用某些量化指标的平均值，例如CPU的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统API调用的平均响应时间为例：如果大多数API请求都维持在100ms的响应时间范围内，而个别请求的响应时间需要5s，那么就会导致某些WEB页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。</p><p>为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在0<del>10ms之间的请求数有多少而10</del>20ms之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram和Summary都是为了能够解决这样问题的存在，通过Histogram和Summary类型的监控指标，我们可以快速了解监控样本的分布情况。 </p><p>例如，指标prometheus_tsdb_wal_fsync_duration_seconds的指标类型为Summary。 它记录了Prometheus Server中wal_fsync处理的处理时间，通过访问Prometheus Server的&#x2F;metrics地址，可以获取到以下监控样本数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync.</span><br><span class="line"># TYPE prometheus_tsdb_wal_fsync_duration_seconds summary</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile=&quot;0.5&quot;&#125; 0.012352463</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile=&quot;0.9&quot;&#125; 0.014458005</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile=&quot;0.99&quot;&#125; 0.017316173</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds_sum 2.888716127000002</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds_count 216</span><br></pre></td></tr></table></figure><p>从上面的样本中可以得知当前Prometheus Server进行wal_fsync操作的总次数为216次，耗时2.888716127000002s。其中中位数（quantile&#x3D;0.5）的耗时为0.012352463，9分位数（quantile&#x3D;0.9）的耗时为0.014458005s。</p><p>在Prometheus Server自身返回的样本数据中，我们还能找到类型为Histogram的监控指标prometheus_tsdb_compaction_chunk_range_bucket。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># HELP prometheus_tsdb_compaction_chunk_range Final time range of chunks on their first compaction</span><br><span class="line"># TYPE prometheus_tsdb_compaction_chunk_range histogram</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;100&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;400&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;1600&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;6400&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;25600&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;102400&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;409600&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;1.6384e+06&quot;&#125; 260</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;6.5536e+06&quot;&#125; 780</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;2.62144e+07&quot;&#125; 780</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;+Inf&quot;&#125; 780</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_sum 1.1540798e+09</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_count 780</span><br></pre></td></tr></table></figure><p>与Summary类型的指标相似之处在于Histogram类型的样本同样会反应当前指标的记录的总数(以_count作为后缀)以及其值的总量（以_sum作为后缀）。不同在于Histogram指标直接反应了在不同区间内样本的个数，区间通过标签len进行定义。</p><p>同时对于Histogram的指标，我们还可以通过histogram_quantile()函数计算出其值的分位数。不同在于Histogram通过histogram_quantile函数是在服务器端计算的分位数。 而Sumamry的分位数则是直接在客户端计算完成。因此对于分位数的计算而言，Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。反之对于客户端而言Histogram消耗的资源更少。在选择这两种方式时用户应该按照自己的实际场景进行选择。</p><h1 id="初识PromQL"><a href="#初识PromQL" class="headerlink" title="初识PromQL"></a>初识PromQL</h1><p>Prometheus通过指标名称（metrics name）以及对应的一组标签（labelset）唯一定义一条时间序列。指标名称反映了监控样本的基本标识，而label则在这个基本特征上为采集到的数据提供了多种特征维度。用户可以基于这些特征维度过滤，聚合，统计从而产生新的计算后的一条时间序列。</p><p>PromQL是Prometheus内置的数据查询语言，其提供对时间序列数据丰富的查询，聚合以及逻辑运算能力的支持。并且被广泛应用在Prometheus的日常应用当中，包括对数据查询、可视化、告警处理当中。可以这么说，PromQL是Prometheus所有应用场景的基础，理解和掌握PromQL是Prometheus入门的第一课。</p><h2 id="查询时间序列"><a href="#查询时间序列" class="headerlink" title="查询时间序列"></a>查询时间序列</h2><p>当Prometheus通过Exporter采集到相应的监控指标样本数据后，我们就可以通过PromQL对监控样本数据进行查询。</p><p>当我们直接使用监控指标名称查询时，可以查询该指标下的所有时间序列。如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total</span><br></pre></td></tr></table></figure><p>等同于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;&#125;</span><br></pre></td></tr></table></figure><p>该表达式会返回指标名称为http_requests_total的所有时间序列：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;alerts&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=(20889@1518096812.326)</span><br><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;graph&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=(21287@1518096812.326)</span><br></pre></td></tr></table></figure><p>PromQL还支持用户根据时间序列的标签匹配模式来对时间序列进行过滤，目前主要支持两种匹配模式：完全匹配和正则匹配。</p><p>PromQL支持使用<code>=</code>和<code>!=</code>两种完全匹配模式：</p><ul><li>通过使用<code>label=value</code>可以选择那些标签满足表达式定义的时间序列；</li><li>反之使用<code>label!=value</code>则可以根据标签匹配排除时间序列；</li></ul><p>例如，如果我们只需要查询所有http_requests_total时间序列中满足标签instance为localhost:9090的时间序列，则可以使用如下表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;instance=&quot;localhost:9090&quot;&#125;</span><br></pre></td></tr></table></figure><p>反之使用<code>instance!=&quot;localhost:9090&quot;</code>则可以排除这些时间序列：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;instance!=&quot;localhost:9090&quot;&#125;</span><br></pre></td></tr></table></figure><p>除了使用完全匹配的方式对时间序列进行过滤以外，PromQL还可以支持使用正则表达式作为匹配条件，多个表达式之间使用<code>|</code>进行分离：</p><ul><li>使用<code>label=~regx</code>表示选择那些标签符合正则表达式定义的时间序列；</li><li>反之使用<code>label!~regx</code>进行排除；</li></ul><p>例如，如果想查询多个环节下的时间序列序列可以使用如下表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;environment=~&quot;staging|testing|development&quot;,method!=&quot;GET&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h2><p>直接通过类似于PromQL表达式<code>http_requests_total</code>查询时间序列时，会选择出所有属于该度量指标的时序的当前采样值，这样的返回结果我们称之为__瞬时向量__。而相应的这样的表达式称之为__瞬时向量表达式__。</p><p>而如果我们想过去一段时间范围内的样本数据时，我们则需要使用__区间向量表达式__。区间向量表达式和瞬时向量表达式之间的差异在于在区间向量表达式中我们需要定义时间选择的范围，时间范围通过时间范围选择器<code>[]</code>进行定义。例如，通过以下表达式可以选择最近5分钟内的所有样本数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;&#125;[5m]</span><br></pre></td></tr></table></figure><p>该表达式将会返回查询到的时间序列中最近5分钟的所有样本数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;alerts&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=[</span><br><span class="line">    1@1518096812.326</span><br><span class="line">    1@1518096817.326</span><br><span class="line">    1@1518096822.326</span><br><span class="line">    1@1518096827.326</span><br><span class="line">    1@1518096832.326</span><br><span class="line">    1@1518096837.325</span><br><span class="line">]</span><br><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;graph&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=[</span><br><span class="line">    4 @1518096812.326</span><br><span class="line">    4@1518096817.326</span><br><span class="line">    4@1518096822.326</span><br><span class="line">    4@1518096827.326</span><br><span class="line">    4@1518096832.326</span><br><span class="line">    4@1518096837.325</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>通过区间向量表达式查询到的结果我们称为__区间向量__。</p><p>除了使用m表示分钟以外，PromQL的时间范围选择器支持其它时间单位：</p><ul><li>s - 秒</li><li>m - 分钟</li><li>h - 小时</li><li>d - 天</li><li>w - 周</li><li>y - 年</li></ul><h2 id="时间位移操作"><a href="#时间位移操作" class="headerlink" title="时间位移操作"></a>时间位移操作</h2><p>在瞬时向量表达式或者区间向量表达式中，都是以当前时间为基准：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;&#125; # 瞬时向量表达式，选择当前最新的数据</span><br><span class="line">http_request_total&#123;&#125;[5m] # 区间向量表达式，选择以当前时间为基准，5分钟内的数据</span><br></pre></td></tr></table></figure><p>而如果我们想查询，5分钟前的瞬时样本数据，或昨天一天的区间内的样本数据呢? 这个时候我们就可以使用位移操作，位移操作的关键字为<strong>offset</strong>。</p><p>可以使用offset时间位移操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;&#125; offset 5m</span><br><span class="line">http_request_total&#123;&#125;[1d] offset 1d</span><br></pre></td></tr></table></figure><h2 id="使用聚合操作"><a href="#使用聚合操作" class="headerlink" title="使用聚合操作"></a>使用聚合操作</h2><p>一般来说，如果描述样本特征的标签(label)在并非唯一的情况下，通过PromQL查询数据，会返回多条满足这些特征维度的时间序列。而PromQL提供的聚合操作可以用来对这些时间序列进行处理，形成一条新的时间序列：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查询系统所有http请求的总量</span><br><span class="line">sum(http_request_total)</span><br><span class="line"></span><br><span class="line"># 按照mode计算主机CPU的平均使用时间</span><br><span class="line">avg(node_cpu) by (mode)</span><br><span class="line"></span><br><span class="line"># 按照主机查询各个主机的CPU使用率</span><br><span class="line">sum(sum(irate(node_cpu&#123;mode!=&#x27;idle&#x27;&#125;[5m]))  / sum(irate(node_cpu[5m]))) by (instance)</span><br></pre></td></tr></table></figure><h2 id="标量和字符串"><a href="#标量和字符串" class="headerlink" title="标量和字符串"></a>标量和字符串</h2><p>除了使用瞬时向量表达式和区间向量表达式以外，PromQL还直接支持用户使用标量(Scalar)和字符串(String)。</p><h3 id="标量（Scalar）：一个浮点型的数字值"><a href="#标量（Scalar）：一个浮点型的数字值" class="headerlink" title="标量（Scalar）：一个浮点型的数字值"></a>标量（Scalar）：一个浮点型的数字值</h3><p>标量只有一个数字，没有时序。</p><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10</span><br></pre></td></tr></table></figure><blockquote><p>需要注意的是，当使用表达式count(http_requests_total)，返回的数据类型，依然是瞬时向量。用户可以通过内置函数scalar()将单个瞬时向量转换为标量。</p></blockquote><h3 id="字符串（String）：一个简单的字符串值"><a href="#字符串（String）：一个简单的字符串值" class="headerlink" title="字符串（String）：一个简单的字符串值"></a>字符串（String）：一个简单的字符串值</h3><p>直接使用字符串，作为PromQL表达式，则会直接返回字符串。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;this is a string&quot;</span><br><span class="line">&#x27;these are unescaped: \n \\ \t&#x27;</span><br><span class="line">`these are not unescaped: \n &#x27; &quot; \t`</span><br></pre></td></tr></table></figure><h2 id="合法的PromQL表达式"><a href="#合法的PromQL表达式" class="headerlink" title="合法的PromQL表达式"></a>合法的PromQL表达式</h2><p>所有的PromQL表达式都必须至少包含一个指标名称(例如http_request_total)，或者一个不会匹配到空字符串的标签过滤器(例如{code&#x3D;”200”})。</p><p>因此以下两种方式，均为合法的表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http_request_total # 合法</span><br><span class="line">http_request_total&#123;&#125; # 合法</span><br><span class="line">&#123;method=&quot;get&quot;&#125; # 合法</span><br></pre></td></tr></table></figure><p>而如下表达式，则不合法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;job=~&quot;.*&quot;&#125; # 不合法</span><br></pre></td></tr></table></figure><p>同时，除了使用<code>&lt;metric name&gt;&#123;label=value&#125;</code>的形式以外，我们还可以使用内置的<code>__name__</code>标签来指定监控指标名称：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;__name__=~&quot;http_request_total&quot;&#125; # 合法</span><br><span class="line">&#123;__name__=~&quot;node_disk_bytes_read|node_disk_bytes_written&quot;&#125; # 合法</span><br></pre></td></tr></table></figure><h1 id="PromQL操作符"><a href="#PromQL操作符" class="headerlink" title="PromQL操作符"></a>PromQL操作符</h1><p>使用PromQL除了能够方便的按照查询和过滤时间序列以外，PromQL还支持丰富的操作符，用户可以使用这些操作符对进一步的对事件序列进行二次加工。这些操作符包括：数学运算符，逻辑运算符，布尔运算符等等。</p><h2 id="数学运算"><a href="#数学运算" class="headerlink" title="数学运算"></a>数学运算</h2><p>例如，我们可以通过指标node_memory_free_bytes_total获取当前主机可用的内存空间大小，其样本单位为Bytes。这时如果客户端要求使用MB作为单位响应数据，那只需要将查询到的时间序列的样本值进行单位换算即可：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_memory_free_bytes_total / (1024 * 1024)</span><br></pre></td></tr></table></figure><p>node_memory_free_bytes_total表达式会查询出所有满足表达式条件的时间序列，在上一小节中我们称该表达式为瞬时向量表达式，而返回的结果成为瞬时向量。</p><p>当瞬时向量与标量之间进行数学运算时，数学运算符会依次作用于瞬时向量中的每一个样本值，从而得到一组新的时间序列。</p><p>而如果是瞬时向量与瞬时向量之间进行数学运算时，过程会相对复杂一点。 例如，如果我们想根据node_disk_bytes_written和node_disk_bytes_read获取主机磁盘IO的总量，可以使用如下表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_disk_bytes_written + node_disk_bytes_read</span><br></pre></td></tr></table></figure><p>那这个表达式是如何工作的呢？依次找到与左边向量元素匹配（标签完全一致）的右边向量元素进行运算，如果没找到匹配元素，则直接丢弃。同时新的时间序列将不会包含指标名称。 该表达式返回结果的示例如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;device=&quot;sda&quot;,instance=&quot;localhost:9100&quot;,job=&quot;node_exporter&quot;&#125;=&gt;1634967552@1518146427.807 + 864551424@1518146427.807</span><br><span class="line">&#123;device=&quot;sdb&quot;,instance=&quot;localhost:9100&quot;,job=&quot;node_exporter&quot;&#125;=&gt;0@1518146427.807 + 1744384@1518146427.807</span><br></pre></td></tr></table></figure><p>PromQL支持的所有数学运算符如下所示：</p><ul><li><code>+</code> (加法)</li><li><code>-</code> (减法)</li><li><code>*</code> (乘法)</li><li><code>/</code> (除法)</li><li><code>%</code> (求余)</li><li><code>^</code> (幂运算)</li></ul><h2 id="使用布尔运算过滤时间序列"><a href="#使用布尔运算过滤时间序列" class="headerlink" title="使用布尔运算过滤时间序列"></a>使用布尔运算过滤时间序列</h2><p>在PromQL通过标签匹配模式，用户可以根据时间序列的特征维度对其进行查询。而布尔运算则支持用户根据时间序列中样本的值，对时间序列进行过滤。</p><p>例如，通过数学运算符我们可以很方便的计算出，当前所有主机节点的内存使用率：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_bytes_total - node_memory_free_bytes_total) / node_memory_bytes_total</span><br></pre></td></tr></table></figure><p>而系统管理员在排查问题的时候可能只想知道当前内存使用率超过95%的主机呢？通过使用布尔运算符可以方便的获取到该结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_bytes_total - node_memory_free_bytes_total) / node_memory_bytes_total &gt; 0.95</span><br></pre></td></tr></table></figure><p>瞬时向量与标量进行布尔运算时，PromQL依次比较向量中的所有时间序列样本的值，如果比较结果为true则保留，反之丢弃。</p><p>瞬时向量与瞬时向量直接进行布尔运算时，同样遵循默认的匹配模式：依次找到与左边向量元素匹配（标签完全一致）的右边向量元素进行相应的操作，如果没找到匹配元素，则直接丢弃。</p><p>目前，Prometheus支持以下布尔运算符如下：</p><ul><li><code>==</code> (相等)</li><li><code>!=</code> (不相等)</li><li><code>&gt;</code> (大于)</li><li><code>&lt;</code> (小于)</li><li><code>&gt;=</code> (大于等于)</li><li><code>&lt;=</code> (小于等于)</li></ul><h2 id="使用bool修饰符改变布尔运算符的行为"><a href="#使用bool修饰符改变布尔运算符的行为" class="headerlink" title="使用bool修饰符改变布尔运算符的行为"></a>使用bool修饰符改变布尔运算符的行为</h2><p>布尔运算符的默认行为是对时序数据进行过滤。而在其它的情况下我们可能需要的是真正的布尔结果。例如，只需要知道当前模块的HTTP请求量是否&gt;&#x3D;1000，如果大于等于1000则返回1（true）否则返回0（false）。这时可以使用bool修饰符改变布尔运算的默认行为。 例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total &gt; bool 1000</span><br></pre></td></tr></table></figure><p>使用bool修改符后，布尔运算不会对时间序列进行过滤，而是直接依次瞬时向量中的各个样本数据与标量的比较结果0或者1。从而形成一条新的时间序列。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;query&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;  1</span><br><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;query_range&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;  0</span><br></pre></td></tr></table></figure><p>同时需要注意的是，如果是在两个标量之间使用布尔运算，则必须使用bool修饰符</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2 == bool 2 # 结果为1</span><br></pre></td></tr></table></figure><h2 id="使用集合运算符"><a href="#使用集合运算符" class="headerlink" title="使用集合运算符"></a>使用集合运算符</h2><p>使用瞬时向量表达式能够获取到一个包含多个时间序列的集合，我们称为瞬时向量。 通过集合运算，可以在两个瞬时向量与瞬时向量之间进行相应的集合操作。目前，Prometheus支持以下集合运算符：</p><ul><li><code>and</code> (并且)</li><li><code>or</code> (或者)</li><li><code>unless</code> (排除)</li></ul><p><em><strong>vector1 and vector2</strong></em> 会产生一个由vector1的元素组成的新的向量。该向量包含vector1中完全匹配vector2中的元素组成。</p><p><em><strong>vector1 or vector2</strong></em> 会产生一个新的向量，该向量包含vector1中所有的样本数据，以及vector2中没有与vector1匹配到的样本数据。</p><p><em><strong>vector1 unless vector2</strong></em> 会产生一个新的向量，新向量中的元素由vector1中没有与vector2匹配的元素组成。</p><h2 id="操作符优先级"><a href="#操作符优先级" class="headerlink" title="操作符优先级"></a>操作符优先级</h2><p>对于复杂类型的表达式，需要了解运算操作的运行优先级</p><p>例如，查询主机的CPU使用率，可以使用表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 * (1 - avg (irate(node_cpu&#123;mode=&#x27;idle&#x27;&#125;[5m])) by(job) )</span><br></pre></td></tr></table></figure><p>其中irate是PromQL中的内置函数，用于计算区间向量中时间序列每秒的即时增长率。关于内置函数的部分，会在下一节详细介绍。</p><p>在PromQL操作符中优先级由高到低依次为：</p><ol><li><code>^</code></li><li><code>*, /, %</code></li><li><code>+, -</code></li><li><code>==, !=, &lt;=, &lt;, &gt;=, &gt;</code></li><li><code>and, unless</code></li><li><code>or</code></li></ol><h2 id="匹配模式详解"><a href="#匹配模式详解" class="headerlink" title="匹配模式详解"></a>匹配模式详解</h2><p>向量与向量之间进行运算操作时会基于默认的匹配规则：依次找到与左边向量元素匹配（标签完全一致）的右边向量元素进行运算，如果没找到匹配元素，则直接丢弃。</p><p>接下来将介绍在PromQL中有两种典型的匹配模式：一对一（one-to-one）,多对一（many-to-one）或一对多（one-to-many）。</p><h3 id="一对一匹配"><a href="#一对一匹配" class="headerlink" title="一对一匹配"></a>一对一匹配</h3><p>一对一匹配模式会从操作符两边表达式获取的瞬时向量依次比较并找到唯一匹配(标签完全一致)的样本值。默认情况下，使用表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vector1 &lt;operator&gt; vector2</span><br></pre></td></tr></table></figure><p>在操作符两边表达式标签不一致的情况下，可以使用on(label list)或者ignoring(label list）来修改标签的匹配行为。使用ignoreing可以在匹配时忽略某些标签。而on则用于将匹配行为限定在某些标签之内。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure><p>例如当存在样本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  24</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  30</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;put&quot;, code=&quot;501&quot;&#125;  3</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 6</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 21</span><br><span class="line"></span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;get&quot;&#125;  600</span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;del&quot;&#125;  34</span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;post&quot;&#125; 120</span><br></pre></td></tr></table></figure><p>使用PromQL表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;code=&quot;500&quot;&#125; / ignoring(code) method:http_requests:rate5m</span><br></pre></td></tr></table></figure><p>该表达式会返回在过去5分钟内，HTTP请求状态码为500的在所有请求中的比例。如果没有使用ignoring(code)，操作符两边表达式返回的瞬时向量中将找不到任何一个标签完全相同的匹配项。</p><p>因此结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;method=&quot;get&quot;&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method=&quot;post&quot;&#125; 0.05            //   6 / 120</span><br></pre></td></tr></table></figure><p>同时由于method为put和del的样本找不到匹配项，因此不会出现在结果当中。</p><h3 id="多对一和一对多"><a href="#多对一和一对多" class="headerlink" title="多对一和一对多"></a>多对一和一对多</h3><p>多对一和一对多两种匹配模式指的是“一”侧的每一个向量元素可以与”多”侧的多个元素匹配的情况。在这种情况下，必须使用group修饰符：group_left或者group_right来确定哪一个向量具有更高的基数（充当“多”的角色）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure><p>多对一和一对多两种模式一定是出现在操作符两侧表达式返回的向量标签不一致的情况。因此需要使用ignoring和on修饰符来排除或者限定匹配的标签列表。</p><p>例如,使用表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m</span><br></pre></td></tr></table></figure><p>该表达式中，左向量<code>method_code:http_errors:rate5m</code>包含两个标签method和code。而右向量<code>method:http_requests:rate5m</code>中只包含一个标签method，因此匹配时需要使用ignoring限定匹配的标签为code。 在限定匹配标签后，右向量中的元素可能匹配到多个左向量中的元素，因此该表达式的匹配模式为多对一，需要使用group修饰符group_left指定左向量具有更好的基数。</p><p>最终的运算结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  0.05            //  30 / 600</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 0.05            //   6 / 120</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 0.175           //  21 / 120</span><br></pre></td></tr></table></figure><blockquote><p>提醒：group修饰符只能在比较和数学运算符中使用。在逻辑运算and,unless和or才注意操作中默认与右向量中的所有元素进行匹配。</p></blockquote><h1 id="PromQL聚合操作"><a href="#PromQL聚合操作" class="headerlink" title="PromQL聚合操作"></a>PromQL聚合操作</h1><p>Prometheus还提供了下列内置的聚合操作符，这些操作符作用域瞬时向量。可以将瞬时表达式返回的样本数据进行聚合，形成一个新的时间序列。</p><ul><li><code>sum</code> (求和)</li><li><code>min</code> (最小值)</li><li><code>max</code> (最大值)</li><li><code>avg</code> (平均值)</li><li><code>stddev</code> (标准差)</li><li><code>stdvar</code> (标准方差)</li><li><code>count</code> (计数)</li><li><code>count_values</code> (对value进行计数)</li><li><code>bottomk</code> (后n条时序)</li><li><code>topk</code> (前n条时序)</li><li><code>quantile</code> (分位数)</li></ul><p>使用聚合操作的语法如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br></pre></td></tr></table></figure><p>其中只有<code>count_values</code>, <code>quantile</code>, <code>topk</code>, <code>bottomk</code>支持参数(parameter)。</p><p>without用于从计算结果中移除列举的标签，而保留其它标签。by则正好相反，结果向量中只保留列出的标签，其余标签则移除。通过without和by可以按照样本的问题对数据进行聚合。</p><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total) without (instance)</span><br></pre></td></tr></table></figure><p>等价于</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total) by (code,handler,job,method)</span><br></pre></td></tr></table></figure><p>如果只需要计算整个应用的HTTP请求总量，可以直接使用表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total)</span><br></pre></td></tr></table></figure><p>count_values用于时间序列中每一个样本值出现的次数。count_values会为每一个唯一的样本值输出一个时间序列，并且每一个时间序列包含一个额外的标签。</p><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count_values(&quot;count&quot;, http_requests_total)</span><br></pre></td></tr></table></figure><p>topk和bottomk则用于对样本值进行排序，返回当前样本值前n位，或者后n位的时间序列。</p><p>获取HTTP请求数前5位的时序样本数据，可以使用表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(5, http_requests_total)</span><br></pre></td></tr></table></figure><p>quantile用于计算当前样本数据值的分布情况quantile(φ, express)其中0 ≤ φ ≤ 1。</p><p>例如，当φ为0.5时，即表示找到当前样本数据中的中位数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quantile(0.5, http_requests_total)</span><br></pre></td></tr></table></figure><h1 id="PromQL内置函数"><a href="#PromQL内置函数" class="headerlink" title="PromQL内置函数"></a>PromQL内置函数</h1><p>在上一小节中，我们已经看到了类似于irate()这样的函数，可以帮助我们计算监控指标的增长率。除了irate以外，Prometheus还提供了其它大量的内置函数，可以对时序数据进行丰富的处理。本小节将带读者了解一些常用的内置函数以及相关的使用场景和用法。</p><h2 id="计算Counter指标增长率"><a href="#计算Counter指标增长率" class="headerlink" title="计算Counter指标增长率"></a>计算Counter指标增长率</h2><p>我们知道Counter类型的监控指标其特点是只增不减，在没有发生重置（如服务器重启，应用重启）的情况下其样本值应该是不断增大的。为了能够更直观的表示样本数据的变化剧烈情况，需要计算样本的增长速率。</p><p>如下图所示，样本增长率反映出了样本变化的剧烈程度：</p><p><img src="/archives/de9e970e/counter-to-rate.png" alt="通过增长率表示样本的变化情况"></p><p>increase(v range-vector)函数是PromQL中提供的众多内置函数之一。其中参数v是一个区间向量，increase函数获取区间向量中的第一个后最后一个样本并返回其增长量。因此，可以通过以下表达式Counter类型指标的增长率：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu[2m]) / 120</span><br></pre></td></tr></table></figure><p>这里通过node_cpu[2m]获取时间序列最近两分钟的所有样本，increase计算出最近两分钟的增长量，最后除以时间120秒得到node_cpu样本在最近两分钟的平均增长率。并且这个值也近似于主机节点最近两分钟内的平均CPU使用率。</p><p>除了使用increase函数以外，PromQL中还直接内置了rate(v range-vector)函数，rate函数可以直接计算区间向量v在时间窗口内平均增长速率。因此，通过以下表达式可以得到与increase函数相同的结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_cpu[2m])</span><br></pre></td></tr></table></figure><p>需要注意的是使用rate或者increase函数去计算样本的平均增长速率，容易陷入“长尾问题”当中，其无法反应在时间窗口内样本数据的突发变化。 例如，对于主机而言在2分钟的时间窗口内，可能在某一个由于访问量或者其它问题导致CPU占用100%的情况，但是通过计算在时间窗口内的平均增长率却无法反应出该问题。</p><p>为了解决该问题，PromQL提供了另外一个灵敏度更高的函数irate(v range-vector)。irate同样用于计算区间向量的计算率，但是其反应出的是瞬时增长率。irate函数是通过区间向量中最后两个样本数据来计算区间向量的增长速率。这种方式可以避免在时间窗口范围内的“长尾问题”，并且体现出更好的灵敏度，通过irate函数绘制的图标能够更好的反应样本数据的瞬时变化状态。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irate(node_cpu[2m])</span><br></pre></td></tr></table></figure><p>irate函数相比于rate函数提供了更高的灵敏度，不过当需要分析长期趋势或者在告警规则中，irate的这种灵敏度反而容易造成干扰。因此在长期趋势分析或者告警中更推荐使用rate函数。</p><h2 id="预测Gauge指标变化趋势"><a href="#预测Gauge指标变化趋势" class="headerlink" title="预测Gauge指标变化趋势"></a>预测Gauge指标变化趋势</h2><p>在一般情况下，系统管理员为了确保业务的持续可用运行，会针对服务器的资源设置相应的告警阈值。例如，当磁盘空间只剩512MB时向相关人员发送告警通知。 这种基于阈值的告警模式对于当资源用量是平滑增长的情况下是能够有效的工作的。 但是如果资源不是平滑变化的呢？ 比如有些某些业务增长，存储空间的增长速率提升了好几倍。这时，如果基于原有阈值去触发告警，当系统管理员接收到告警以后可能还没来得及去处理问题，系统就已经不可用了。 因此阈值通常来说不是固定的，需要定期进行调整才能保证该告警阈值能够发挥去作用。 那么还有没有更好的方法吗？</p><p>PromQL中内置的predict_linear(v range-vector, t scalar) 函数可以帮助系统管理员更好的处理此类情况，predict_linear函数可以预测时间序列v在t秒后的值。它基于简单线性回归的方式，对时间窗口内的样本数据进行统计，从而可以对时间序列的变化趋势做出预测。例如，基于2小时的样本数据，来预测主机可用磁盘空间的是否在4个小时候被占满，可以使用如下表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[2h], 4 * 3600) &lt; 0</span><br></pre></td></tr></table></figure><h2 id="统计Histogram指标的分位数"><a href="#统计Histogram指标的分位数" class="headerlink" title="统计Histogram指标的分位数"></a>统计Histogram指标的分位数</h2><p>在本章的第2小节中，我们介绍了Prometheus的四种监控指标类型，其中Histogram和Summary都可以用于统计和分析数据的分布情况。区别在于Summary是直接在客户端计算了数据分布的分位数情况。而Histogram的分位数计算需要通过histogram_quantile(φ float, b instant-vector)函数进行计算。其中φ（0&lt;φ&lt;1）表示需要计算的分位数，如果需要计算中位数φ取值为0.5，以此类推即可。</p><p>以指标http_request_duration_seconds_bucket为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># HELP http_request_duration_seconds request duration histogram</span><br><span class="line"># TYPE http_request_duration_seconds histogram</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;0.5&quot;&#125; 0</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;1&quot;&#125; 1</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;2&quot;&#125; 2</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;3&quot;&#125; 3</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;5&quot;&#125; 3</span><br><span class="line">http_request_duration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125; 3</span><br><span class="line">http_request_duration_seconds_sum 6</span><br><span class="line">http_request_duration_seconds_count 3</span><br></pre></td></tr></table></figure><p>当计算9分位数时，使用如下表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">histogram_quantile(0.5, http_request_duration_seconds_bucket)</span><br></pre></td></tr></table></figure><p>通过对Histogram类型的监控指标，用户可以轻松获取样本数据的分布情况。同时分位数的计算，也可以非常方便的用于评判当前监控指标的服务水平。</p><p><img src="/archives/de9e970e/histogram_quantile.png" alt="获取分布直方图的中位数"></p><p>需要注意的是通过histogram_quantile计算的分位数，并非为精确值，而是通过http_request_duration_seconds_bucket和http_request_duration_seconds_sum近似计算的结果。</p><h2 id="动态标签替换"><a href="#动态标签替换" class="headerlink" title="动态标签替换"></a>动态标签替换</h2><p>一般来说来说，使用PromQL查询到时间序列后，可视化工具会根据时间序列的标签来渲染图表。例如通过up指标可以获取到当前所有运行的Exporter实例以及其状态：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">up&#123;instance=&quot;localhost:8080&quot;,job=&quot;cadvisor&quot;&#125;1</span><br><span class="line">up&#123;instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;&#125;1</span><br><span class="line">up&#123;instance=&quot;localhost:9100&quot;,job=&quot;node&quot;&#125;1</span><br></pre></td></tr></table></figure><p>这是可视化工具渲染图标时可能根据，instance和job的值进行渲染，为了能够让客户端的图标更具有可读性，可以通过label_replace标签为时间序列添加额外的标签。label_replace的具体参数如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)</span><br></pre></td></tr></table></figure><p>该函数会依次对v中的每一条时间序列进行处理，通过regex匹配src_label的值，并将匹配部分relacement写入到dst_label标签中。如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label_replace(up, &quot;host&quot;, &quot;$1&quot;, &quot;instance&quot;,  &quot;(.*):.*&quot;)</span><br></pre></td></tr></table></figure><p>函数处理后，时间序列将包含一个host标签，host标签的值为Exporter实例的IP地址：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">up&#123;host=&quot;localhost&quot;,instance=&quot;localhost:8080&quot;,job=&quot;cadvisor&quot;&#125;1</span><br><span class="line">up&#123;host=&quot;localhost&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;&#125;1</span><br><span class="line">up&#123;host=&quot;localhost&quot;,instance=&quot;localhost:9100&quot;,job=&quot;node&quot;&#125; 1</span><br></pre></td></tr></table></figure><p>除了label_replace以外，Prometheus还提供了label_join函数，该函数可以将时间序列中v多个标签src_label的值，通过separator作为连接符写入到一个新的标签dst_label中:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label_join(v instant-vector, dst_label string, separator string, src_label_1 string, src_label_2 string, ...)</span><br></pre></td></tr></table></figure><p>label_replace和label_join函数提供了对时间序列标签的自定义能力，从而能够更好的于客户端或者可视化工具配合。</p><h2 id="其它内置函数"><a href="#其它内置函数" class="headerlink" title="其它内置函数"></a>其它内置函数</h2><p>除了上文介绍的这些内置函数以外，PromQL还提供了大量的其它内置函数。这些内置函数包括一些常用的数学计算、日期等等。这里就不一一细讲，感兴趣的读者可以通过阅读Prometheus的官方文档，了解这些函数的使用方式。</p><h1 id="在HTTP-API中使用PromQL"><a href="#在HTTP-API中使用PromQL" class="headerlink" title="在HTTP API中使用PromQL"></a>在HTTP API中使用PromQL</h1><p>Prometheus当前稳定的HTTP API可以通过&#x2F;api&#x2F;v1访问。</p><h2 id="API响应格式"><a href="#API响应格式" class="headerlink" title="API响应格式"></a>API响应格式</h2><p>Prometheus API使用了JSON格式的响应内容。 当API调用成功后将会返回2xx的HTTP状态码。</p><p>反之，当API调用失败时可能返回以下几种不同的HTTP状态码：</p><ul><li>404 Bad Request：当参数错误或者缺失时。</li><li>422 Unprocessable Entity 当表达式无法执行时。</li><li>503 Service Unavailiable 当请求超时或者被中断时。</li></ul><p>所有的API请求均使用以下的JSON格式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot; | &quot;error&quot;,</span><br><span class="line">  &quot;data&quot;: &lt;data&gt;,</span><br><span class="line"></span><br><span class="line">  // Only set if status is &quot;error&quot;. The data field may still hold</span><br><span class="line">  // additional data.</span><br><span class="line">  &quot;errorType&quot;: &quot;&lt;string&gt;&quot;,</span><br><span class="line">  &quot;error&quot;: &quot;&lt;string&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="在HTTP-API中使用PromQL-1"><a href="#在HTTP-API中使用PromQL-1" class="headerlink" title="在HTTP API中使用PromQL"></a>在HTTP API中使用PromQL</h2><p>通过HTTP API我们可以分别通过&#x2F;api&#x2F;v1&#x2F;query和&#x2F;api&#x2F;v1&#x2F;query_range查询PromQL表达式当前或者一定时间范围内的计算结果。</p><h3 id="瞬时数据查询"><a href="#瞬时数据查询" class="headerlink" title="瞬时数据查询"></a>瞬时数据查询</h3><p>通过使用QUERY API我们可以查询PromQL在特定时间点下的计算结果。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/query</span><br></pre></td></tr></table></figure><p>URL请求参数：</p><ul><li>query&#x3D;<string>：PromQL表达式。</li><li>time&#x3D;&lt;rfc3339 | unix_timestamp&gt;：用于指定用于计算PromQL的时间戳。可选参数，默认情况下使用当前系统时间。</li><li>timeout&#x3D;<duration>：超时设置。可选参数，默认情况下使用-query,timeout的全局设置。</li></ul><p>例如使用以下表达式查询表达式up在时间点2015-07-01T20:10:51.781Z的计算结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#x27;http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z&#x27;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;status&quot; : &quot;success&quot;,</span><br><span class="line">   &quot;data&quot; : &#123;</span><br><span class="line">      &quot;resultType&quot; : &quot;vector&quot;,</span><br><span class="line">      &quot;result&quot; : [</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;prometheus&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9090&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;value&quot;: [ 1435781451.781, &quot;1&quot; ]</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;node&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9100&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;value&quot; : [ 1435781451.781, &quot;0&quot; ]</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="响应数据类型"><a href="#响应数据类型" class="headerlink" title="响应数据类型"></a>响应数据类型</h3><p>当API调用成功后，Prometheus会返回JSON格式的响应内容，格式如上小节所示。并且在data节点中返回查询结果。data节点格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;resultType&quot;: &quot;matrix&quot; | &quot;vector&quot; | &quot;scalar&quot; | &quot;string&quot;,</span><br><span class="line">  &quot;result&quot;: &lt;value&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PromQL表达式可能返回多种数据类型，在响应内容中使用resultType表示当前返回的数据类型，包括：</p><ul><li>瞬时向量：vector</li></ul><p>当返回数据类型resultType为vector时，result响应格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;metric&quot;: &#123; &quot;&lt;label_name&gt;&quot;: &quot;&lt;label_value&gt;&quot;, ... &#125;,</span><br><span class="line">    &quot;value&quot;: [ &lt;unix_time&gt;, &quot;&lt;sample_value&gt;&quot; ]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>其中metrics表示当前时间序列的特征维度，value只包含一个唯一的样本。</p><ul><li>区间向量：matrix</li></ul><p>当返回数据类型resultType为matrix时，result响应格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;metric&quot;: &#123; &quot;&lt;label_name&gt;&quot;: &quot;&lt;label_value&gt;&quot;, ... &#125;,</span><br><span class="line">    &quot;values&quot;: [ [ &lt;unix_time&gt;, &quot;&lt;sample_value&gt;&quot; ], ... ]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>其中metrics表示当前时间序列的特征维度，values包含当前事件序列的一组样本。</p><ul><li>标量：scalar</li></ul><p>当返回数据类型resultType为scalar时，result响应格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &lt;unix_time&gt;, &quot;&lt;scalar_value&gt;&quot; ]</span><br></pre></td></tr></table></figure><p>由于标量不存在时间序列一说，因此result表示为当前系统时间一个标量的值。</p><ul><li>字符串：string</li></ul><p>当返回数据类型resultType为string时，result响应格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &lt;unix_time&gt;, &quot;&lt;string_value&gt;&quot; ]</span><br></pre></td></tr></table></figure><p>字符串类型的响应内容格式和标量相同。</p><h3 id="区间数据查询"><a href="#区间数据查询" class="headerlink" title="区间数据查询"></a>区间数据查询</h3><p>使用QUERY_RANGE API我们则可以直接查询PromQL表达式在一段时间返回内的计算结果。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/query_range</span><br></pre></td></tr></table></figure><p>URL请求参数：</p><ul><li>query&#x3D;<string>: PromQL表达式。</li><li>start&#x3D;&lt;rfc3339 | unix_timestamp&gt;: 起始时间。</li><li>end&#x3D;&lt;rfc3339 | unix_timestamp&gt;: 结束时间。</li><li>step&#x3D;<duration>: 查询步长。</li><li>timeout&#x3D;<duration>: 超时设置。可选参数，默认情况下使用-query,timeout的全局设置。</li></ul><p>当使用QUERY_RANGE API查询PromQL表达式时，返回结果一定是一个区间向量：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;resultType&quot;: &quot;matrix&quot;,</span><br><span class="line">  &quot;result&quot;: &lt;value&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>需要注意的是，在QUERY_RANGE API中PromQL只能使用瞬时向量选择器类型的表达式。</p></blockquote><p>例如使用以下表达式查询表达式up在30秒范围内以15秒为间隔计算PromQL表达式的结果。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#x27;http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s&#x27;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;status&quot; : &quot;success&quot;,</span><br><span class="line">   &quot;data&quot; : &#123;</span><br><span class="line">      &quot;resultType&quot; : &quot;matrix&quot;,</span><br><span class="line">      &quot;result&quot; : [</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;prometheus&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9090&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;values&quot; : [</span><br><span class="line">               [ 1435781430.781, &quot;1&quot; ],</span><br><span class="line">               [ 1435781445.781, &quot;1&quot; ],</span><br><span class="line">               [ 1435781460.781, &quot;1&quot; ]</span><br><span class="line">            ]</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;node&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9091&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;values&quot; : [</span><br><span class="line">               [ 1435781430.781, &quot;0&quot; ],</span><br><span class="line">               [ 1435781445.781, &quot;0&quot; ],</span><br><span class="line">               [ 1435781460.781, &quot;1&quot; ]</span><br><span class="line">            ]</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="最佳实践：4个黄金指标和USE方法"><a href="#最佳实践：4个黄金指标和USE方法" class="headerlink" title="最佳实践：4个黄金指标和USE方法"></a>最佳实践：4个黄金指标和USE方法</h1><p>前面部分介绍了Prometheus的数据存储模型以及4种指标类型，同时Prometheus提供的强大的PromQL可以实现对数据的个性化处理。Prometheus基于指标提供了一个通用的监控解决方案。这里先思考一个基本的问题，在实现监控时，我们到底应该监控哪些对象以及哪些指标？</p><h2 id="监控所有"><a href="#监控所有" class="headerlink" title="监控所有"></a>监控所有</h2><p>在之前<strong>Prometheus简介</strong>部分介绍监控的基本目标，首先是及时发现问题，其次是要能够快速对问题进行定位。对于传统监控解决方案而言，用户看到的依然是一个黑盒，用户无法真正了解系统的真正的运行状态。因此Prometheus鼓励用户监控所有的东西。下面列举一些常用的监控维度。</p><table><thead><tr><th>级别</th><th>监控什么</th><th>Exporter</th></tr></thead><tbody><tr><td>网络</td><td>网络协议：http、dns、tcp、icmp；网络硬件：路由器，交换机等</td><td>BlackBox Exporter;SNMP Exporter</td></tr><tr><td>主机</td><td>资源用量</td><td>node exporter</td></tr><tr><td>容器</td><td>资源用量</td><td>cAdvisor</td></tr><tr><td>应用(包括Library)</td><td>延迟，错误，QPS，内部状态等</td><td>代码中集成Prmometheus Client</td></tr><tr><td>中间件状态</td><td>资源用量，以及服务状态</td><td>代码中集成Prmometheus Client</td></tr><tr><td>编排工具</td><td>集群资源用量，调度等</td><td>Kubernetes Components</td></tr></tbody></table><h2 id="监控模式"><a href="#监控模式" class="headerlink" title="监控模式"></a>监控模式</h2><p>除了上述介绍的不同监控级别以外。实际上根据不同的系统类型和目标，这里还有一些通用的套路和模式可以使用。</p><h2 id="4个黄金指标"><a href="#4个黄金指标" class="headerlink" title="4个黄金指标"></a>4个黄金指标</h2><p>Four Golden Signals是Google针对大量分布式监控的经验总结，4个黄金指标可以在服务级别帮助衡量终端用户体验、服务中断、业务影响等层面的问题。主要关注与以下四种类型的指标：延迟，通讯量，错误以及饱和度：</p><ul><li>延迟：服务请求所需时间。</li></ul><p>记录用户所有请求所需的时间，重点是要区分成功请求的延迟时间和失败请求的延迟时间。 例如在数据库或者其他关键祸端服务异常触发HTTP 500的情况下，用户也可能会很快得到请求失败的响应内容，如果不加区分计算这些请求的延迟，可能导致计算结果与实际结果产生巨大的差异。除此以外，在微服务中通常提倡“快速失败”，开发人员需要特别注意这些延迟较大的错误，因为这些缓慢的错误会明显影响系统的性能，因此追踪这些错误的延迟也是非常重要的。</p><ul><li>通讯量：监控当前系统的流量，用于衡量服务的容量需求。</li></ul><p>流量对于不同类型的系统而言可能代表不同的含义。例如，在HTTP REST API中, 流量通常是每秒HTTP请求数；</p><ul><li>错误：监控当前系统所有发生的错误请求，衡量当前系统错误发生的速率。</li></ul><p>对于失败而言有些是显式的(比如, HTTP 500错误)，而有些是隐式(比如，HTTP响应200，但实际业务流程依然是失败的)。</p><p>对于一些显式的错误如HTTP 500可以通过在负载均衡器(如Nginx)上进行捕获，而对于一些系统内部的异常，则可能需要直接从服务中添加钩子统计并进行获取。</p><ul><li>饱和度：衡量当前服务的饱和度。</li></ul><p>主要强调最能影响服务状态的受限制的资源。 例如，如果系统主要受内存影响，那就主要关注系统的内存状态，如果系统主要受限于磁盘I&#x2F;O，那就主要观测磁盘I&#x2F;O的状态。因为通常情况下，当这些资源达到饱和后，服务的性能会明显下降。同时还可以利用饱和度对系统做出预测，比如，“磁盘是否可能在4个小时候就满了”。</p><h2 id="RED方法"><a href="#RED方法" class="headerlink" title="RED方法"></a>RED方法</h2><p>RED方法是Weave Cloud在基于Google的“4个黄金指标”的原则下结合Prometheus以及Kubernetes容器实践，细化和总结的方法论，特别适合于云原生应用以及微服务架构应用的监控和度量。主要关注以下三种关键指标：</p><ul><li>(请求)速率：服务每秒接收的请求数。</li><li>(请求)错误：每秒失败的请求数。</li><li>(请求)耗时：每个请求的耗时。</li></ul><p>在“4大黄金信号”的原则下，RED方法可以有效的帮助用户衡量云原生以及微服务应用下的用户体验问题。</p><h2 id="USE方法"><a href="#USE方法" class="headerlink" title="USE方法"></a>USE方法</h2><p>USE方法全称”Utilization Saturation and Errors Method”，主要用于分析系统性能问题，可以指导用户快速识别资源瓶颈以及错误的方法。正如USE方法的名字所表示的含义，USE方法主要关注与资源的：使用率(Utilization)、饱和度(Saturation)以及错误(Errors)。</p><ul><li>使用率：关注系统资源的使用情况。 这里的资源主要包括但不限于：CPU，内存，网络，磁盘等等。100%的使用率通常是系统性能瓶颈的标志。</li><li>饱和度：例如CPU的平均运行排队长度，这里主要是针对资源的饱和度(注意，不同于4大黄金信号)。任何资源在某种程度上的饱和都可能导致系统性能的下降。</li><li>错误：错误计数。例如：“网卡在数据包传输过程中检测到的以太网网络冲突了14次”。</li></ul><p>通过对资源以上指标持续观察，通过以下流程可以知道用户识别资源瓶颈：</p><p><img src="/archives/de9e970e/USEMethod.png" alt="识别资源瓶颈"></p>]]></content>
      
      
      <categories>
          
          <category> 监控 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> 监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWT is not properly configured on this server.</title>
      <link href="/archives/4d672e21.html"/>
      <url>/archives/4d672e21.html</url>
      
        <content type="html"><![CDATA[<p><code>错误</code>：AWT is not properly configured on this server.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install fontconfig</span><br></pre></td></tr></table></figure><p><code>错误</code>：<br>Nov 08, 2022 10:29:14 AM executable.Main verifyJavaVersion<br>SEVERE: Running with Java class version 52, which is older than the Minimum required version 55. See <a href="https://jenkins.io/redirect/java-support/">https://jenkins.io/redirect/java-support/</a><br>java.lang.UnsupportedClassVersionError: 52.0<br>        at executable.Main.verifyJavaVersion(Main.java:145)<br>        at executable.Main.main(Main.java:109)</p><p>Jenkins requires Java versions [17, 11] but you are running with Java 1.8 from &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_351-amd64&#x2F;jre<br>java.lang.UnsupportedClassVersionError: 52.0<br>        at executable.Main.verifyJavaVersion(Main.java:145)<br>        at executable.Main.main(Main.java:109)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用java11/java17启动</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Gitlab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux-Shell基础</title>
      <link href="/archives/8baf922f.html"/>
      <url>/archives/8baf922f.html</url>
      
        <content type="html"><![CDATA[<h1 id="Shell基础"><a href="#Shell基础" class="headerlink" title="Shell基础"></a>Shell基础</h1><h2 id="Bash注释"><a href="#Bash注释" class="headerlink" title="Bash注释"></a>Bash注释</h2><ul><li><p>Bash只支持单行注释，使用<code>#</code>开头的都被当作注释语句</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单行注释</span></span><br><span class="line"></span><br><span class="line">echo &quot;Hello World&quot;#注释</span><br></pre></td></tr></table></figure></li><li><p>通过Bash特性，可以实现多行注释</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">:&#x27;</span><br><span class="line">注释</span><br><span class="line">&#x27;</span><br><span class="line"></span><br><span class="line">: &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">注释</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h2 id="Bash基本数据类型"><a href="#Bash基本数据类型" class="headerlink" title="Bash基本数据类型"></a>Bash基本数据类型</h2><ul><li><p>Bash中基本数据类型只有字符串类型，连数值类型都没有</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">都是字符串类型，可用<span class="built_in">declare</span> -i声明为数值类型</span></span><br><span class="line">[root@localhost ~]# echo hello</span><br><span class="line">[root@localhost ~]# echo 123</span><br></pre></td></tr></table></figure></li></ul><h2 id="Bash字符串串联"><a href="#Bash字符串串联" class="headerlink" title="Bash字符串串联"></a>Bash字符串串联</h2><ul><li><p>Bash中字符串的串联操作，可用将两段数据连接在一起</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# echo xiaowang xiaowangc</span><br><span class="line">xiaowang xiaowangc</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li></ul><h2 id="变量赋值和引用变量"><a href="#变量赋值和引用变量" class="headerlink" title="变量赋值和引用变量"></a>变量赋值和引用变量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# a=xiaowangc</span><br><span class="line">[root@localhost ~]# echo $a</span><br><span class="line">xiaowangc</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><ul><li><p>Shell可用使用未定义的变量和使用空变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# echo $abc</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# a=</span><br><span class="line">[root@localhost ~]# echo $a</span><br><span class="line"></span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li><li><p>变量引用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# a=666</span><br><span class="line">[root@localhost ~]# echo $a 777</span><br><span class="line">666 777</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li></ul><h2 id="命令替换"><a href="#命令替换" class="headerlink" title="命令替换"></a>命令替换</h2><ul><li><p>命令替换是值先执行id root，将id root的输出结果替换到$()</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# echo $(id root)</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure></li></ul><h2 id="算数运算"><a href="#算数运算" class="headerlink" title="算数运算"></a>算数运算</h2><ul><li><p>Shell可用使用$[]和$(())和let命令做算数运算</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# a=10</span><br><span class="line">[root@localhost ~]# echo $[a+3]</span><br><span class="line">13</span><br><span class="line">[root@localhost ~]# echo $((a+3))</span><br><span class="line">13</span><br><span class="line">[root@localhost ~]# echo $((1+1))</span><br><span class="line">2</span><br><span class="line">[root@localhost ~]# let a+3</span><br><span class="line">[root@localhost ~]# let a=a+3</span><br><span class="line">[root@localhost ~]# echo $a</span><br><span class="line">13</span><br></pre></td></tr></table></figure></li></ul><h2 id="退出状态码"><a href="#退出状态码" class="headerlink" title="退出状态码"></a>退出状态码</h2><blockquote><p>每个命令执行之后都有对应的进程退出状态码，用来表示该进程是否正常退出。所以，在Shell中经常会使用特殊变量$?判断前台命令是否正常退出。</p></blockquote><ul><li>如果$?的值为：<ul><li>为0，表示进程成功执行，即正常退出</li><li>非0，表示进程未成功执行，即非正常退出</li><li>非0退出状态码不一定表示错误，也可能是逻辑上正常的退出</li></ul></li><li>在Shell脚本中，所有条件判断（比如if语句、while语句）都以0退出状态码表示True，以非0退出状态码表示False</li></ul><h2 id="Exit命令"><a href="#Exit命令" class="headerlink" title="Exit命令"></a>Exit命令</h2><blockquote><p>exit命令可用于退出当前Shell进程。退出Shell终端、脚本等。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">exit</span></span></span><br></pre></td></tr></table></figure><h2 id="后台执行命令-amp"><a href="#后台执行命令-amp" class="headerlink" title="后台执行命令&amp;"></a>后台执行命令&amp;</h2><blockquote><p>在命令的结尾使用&amp;符号，表示将这个命令放入后台执行。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# sleep 20 &amp;</span><br><span class="line">[root@localhost ~]# echo $!</span><br></pre></td></tr></table></figure><h2 id="多命令组合"><a href="#多命令组合" class="headerlink" title="多命令组合"></a>多命令组合</h2><blockquote><p>Shell中有多种组合多个命令的方式</p></blockquote><ul><li><p>分号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# echo xiaowangc ; echo hello</span><br><span class="line">xiaowangc</span><br><span class="line">hello</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li><li><p>&amp;&amp;</p><p>前者正确执行完毕并正常退出后，执行后者命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# echo xiaowangc &amp;&amp; echo hello</span><br><span class="line">xiaowangc</span><br><span class="line">hello</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li><li><p>||；如果前者正确只执行前者，前者不正确执行后者（或）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ping asdf &amp;&amp; ping www.baidu.com</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ping -c 4 www.baidu.com || ping abc</span><br></pre></td></tr></table></figure></li><li><p>逻辑结合</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令1 &amp;&amp; 命令2 &amp;&amp; 命令3...</span>  </span><br><span class="line">如果命令1正确执行则执行命令2，如果命令2正确执行则执行命令3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令1 &amp;&amp; 命令2 || 命令3...</span></span><br><span class="line">如果命令1正确执行则执行命令2，如果命令1不正确执行则执行命令3</span><br><span class="line">如果命令1正确执行则执行命令2，如果命令2不正确执行则执行命令3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令1 || 命令2 &amp;&amp; 命令3...</span></span><br><span class="line">如果命令1正确执行则执行命令3</span><br><span class="line">如果命令1不正确执行则执行命令2，如果命令2正确执行则执行命令3</span><br></pre></td></tr></table></figure></li></ul><h2 id="多个命令组合"><a href="#多个命令组合" class="headerlink" title="多个命令组合"></a>多个命令组合</h2><ul><li><p>通过小括号或者大括号组合多个命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(命令1 ; 命令2 ; 命令3)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">小括号是在子Shell中执行</span></span><br><span class="line"></span><br><span class="line">&#123; 命令1 ; 命令2 ; 命令3&#125;</span><br><span class="line">&#123;</span><br><span class="line">命令1</span><br><span class="line">命令2</span><br><span class="line">命令3</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">大括号当前Shell中执行</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><blockquote><p>标准输入、标准输出、标准错误，在Linux系统中，每个程序默认都会打开三个文件描述符</p></blockquote><ul><li>fd&#x3D;0：标准输入</li><li>fd&#x3D;1：标准输出</li><li>fd&#x3D;2：标准错误</li></ul><p>Linux中一切皆文件，文件描述符也是文件：</p><ul><li>fd &#x3D; 0：对应&#x2F;dev&#x2F;stdin文件</li><li>fd &#x3D; 1：对应&#x2F;dev&#x2F;stdout文件</li><li>fd &#x3D; 2：对应&#x2F;dev&#x2F;stderr文件</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls -l /dev/std*</span><br><span class="line">lrwxrwxrwx. 1 root root 15 May  3 04:28 /dev/stderr -&gt; /proc/self/fd/2</span><br><span class="line">lrwxrwxrwx. 1 root root 15 May  3 04:28 /dev/stdin -&gt; /proc/self/fd/0</span><br><span class="line">lrwxrwxrwx. 1 root root 15 May  3 04:28 /dev/stdout -&gt; /proc/self/fd/1</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><h3 id="重定向操作"><a href="#重定向操作" class="headerlink" title="重定向操作"></a>重定向操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. &gt; #格式化输出</span><br><span class="line"></span><br><span class="line">2. &gt;&gt; #追加输出</span><br><span class="line"></span><br><span class="line">3. &lt; #输入重定向</span><br><span class="line"></span><br><span class="line">4. &amp;&gt; #特殊重定向，将标准错误和标准输出都重定向到指定的File中,等价于&gt;file 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">5. &amp;&gt;&gt; #特殊重定向,将标准错误和标准输出都追加到指定File中，等价于&gt;&gt;file 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>还有一种操作经常将输出的目标文件指定为&#x2F;dev&#x2F;null。它是空设备，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /dev/null &gt; file  #清空文件</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="cat命令"><a href="#cat命令" class="headerlink" title="cat命令"></a>cat命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat -n /etc/fstab#-n选项，输出时带行号</span><br><span class="line">     1</span><br><span class="line">     2  #</span><br><span class="line">     3  # /etc/fstab</span><br><span class="line">     4  # Created by anaconda on Sun May  2 20:23:48 2021</span><br><span class="line">     5  #</span><br><span class="line">     6  # Accessible filesystems, by reference, are maintained under &#x27;/dev/disk/&#x27;.</span><br><span class="line">     7  # See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info.</span><br><span class="line">     8  #</span><br><span class="line">     9  # After editing this file, run &#x27;systemctl daemon-reload&#x27; to update systemd</span><br><span class="line">    10  # units generated from this file.</span><br><span class="line">    11  #</span><br><span class="line">    12  /dev/mapper/cl-root     /                       xfs     defaults        0 0</span><br><span class="line">    13  UUID=ffc9c9ba-0b05-43c3-8241-e19518b8c840 /boot                   ext4    defaults        1 2</span><br><span class="line">    14  /dev/mapper/cl-swap     swap                    swap    defaults        0 0</span><br><span class="line">[root@localhost ~]# cat &lt; /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># /etc/fstab</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Created by anaconda on Sun May  2 20:23:48 2021</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk/&#x27;.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) <span class="keyword">for</span> more info.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># After editing this file, run &#x27;systemctl daemon-reload&#x27; to update systemd</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">units generated from this file.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">/dev/mapper/cl-root     /                       xfs     defaults        0 0</span></span><br><span class="line">UUID=ffc9c9ba-0b05-43c3-8241-e19518b8c840 /boot                   ext4    defaults        1 2</span><br><span class="line">/dev/mapper/cl-swap     swap                    swap    defaults        0 0</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="here-docer"><a href="#here-docer" class="headerlink" title="here docer"></a>here docer</h3><p>输入重定向是&lt;，除此之外还有&lt;&lt;,&lt;&lt;&lt;</p><ul><li><p>&lt;&lt;符号表示here doc，也就是后面表示跟着的是一篇文档。常用于多行数据输入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat &lt;&lt; EOF#here doc作为标准输入被读取，然后被cat输出</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">hello</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">xiaowangc</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">EOF</span></span><br><span class="line">hello</span><br><span class="line">xiaowangc</span><br><span class="line">[root@localhost ~]# cat &lt;&lt; EOF &gt; xiaowangc.txt#here doc的内容还会被cat格式化输出到指定文档</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">hello</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">xiaowangc</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">EOF</span></span><br><span class="line">[root@localhost ~]# cat xiaowangc.txt</span><br><span class="line">hello</span><br><span class="line">xiaowangc</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li><li><p>&lt;&lt;&lt;表示here string。也就是说该符号后面是一个字符串</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat &lt;&lt;&lt; xiaowangc</span><br><span class="line">xiaowangc</span><br><span class="line">[root@localhost ~]# a=11111</span><br><span class="line">[root@localhost ~]# cat &lt;&lt;&lt; $a</span><br><span class="line">11111</span><br><span class="line">[root@localhost ~]# cat &lt;&lt;&lt; &quot;xiaowangc$a&quot;#使用双引号时会进行替换</span><br><span class="line">xiaowangc11111</span><br><span class="line">[root@localhost ~]# cat &lt;&lt;&lt; &#x27;xiaowangc$a&#x27;#使用单引号时不会进行替换</span><br><span class="line"><span class="meta prompt_">xiaowangc$</span><span class="language-bash">a</span></span><br><span class="line">[root@localhost ~]#</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><blockquote><p>每一个竖线”|“代表一个管道，第一个命令的标准输出会放进管道，第二个命令会从管道中读取进行处理</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps -aux | grep sshd</span><br><span class="line">root        1005  0.0  0.5  92968  4280 ?        Ss   May08   0:00 /usr/sbin/sshd -D -oCiphers=aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes256-cbc,aes128-gcm@openssh.com,aes128-ctr,aes128-cbc -oMACs=hmac-sha2-256-etm@openssh.com,hmac-sha1-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha1,umac-128@openssh.com,hmac-sha2-512 -oGSSAPIKexAlgorithms=gss-gex-sha1-,gss-group14-sha1- -oKexAlgorithms=curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1 -oHostKeyAlgorithms=rsa-sha2-256,rsa-sha2-256-cert-v01@openssh.com,ecdsa-sha2-nistp256,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384,ecdsa-sha2-nistp384-cert-v01@openssh.com,rsa-sha2-512,rsa-sha2-512-cert-v01@openssh.com,ecdsa-sha2-nistp521,ecdsa-sha2-nistp521-cert-v01@openssh.com,ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,ssh-rsa,ssh-rsa-cert-v01@openssh.com -oPubkeyAcceptedKeyTypes=rsa-sha2-256,rsa-sha2-256-cert-v01@openssh.com,ecdsa-sha2-nistp256,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384,ecdsa-sha2-nistp384-cert-v01@openssh.com,rsa-sha2-512,rsa-sha2-512-cert-v01@openssh.com,ecdsa-sha2-nistp521,ecdsa-sha2-nistp521-cert-v01@openssh.com,ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,ssh-rsa,ssh-rsa-cert-v01@openssh.com -oCASignatureAlgorithms=rsa-sha2-256,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,rsa-sha2-512,ecdsa-sha2-nistp521,ssh-ed25519,ssh-rsa</span><br><span class="line">root       55071  0.0  1.2 152904  9960 ?        Ss   05:23   0:00 sshd: root [priv]</span><br><span class="line">root       55085  0.0  0.6 152904  5060 ?        S    05:23   0:00 sshd: root@pts/0</span><br><span class="line">root       58868  0.0  0.1  12112  1040 pts/0    R+   07:35   0:00 grep --color=auto sshd</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><p>让grep既从&#x2F;etc&#x2F;fstab读取数据，也从管道中读取数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps aux | grep &quot;#&quot; /etc/fstab /dev/stdin</span><br><span class="line">/etc/fstab:#</span><br><span class="line">/etc/fstab:# /etc/fstab</span><br><span class="line">/etc/fstab:# Created by anaconda on Sun May  2 20:23:48 2021</span><br><span class="line">/etc/fstab:#</span><br><span class="line">/etc/fstab:# Accessible filesystems, by reference, are maintained under &#x27;/dev/disk/&#x27;.</span><br><span class="line">/etc/fstab:# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info.</span><br><span class="line">/etc/fstab:#</span><br><span class="line">/etc/fstab:# After editing this file, run &#x27;systemctl daemon-reload&#x27; to update systemd</span><br><span class="line">/etc/fstab:# units generated from this file.</span><br><span class="line">/etc/fstab:#</span><br><span class="line">/dev/stdin:zabbix     19079  0.0  0.3  76692  2584 ?        S    May08   0:00 /usr/sbin/zabbix_agentd: listener #1 [waiting for connection]</span><br><span class="line">/dev/stdin:zabbix     19080  0.0  0.3  76692  2592 ?        S    May08   0:00 /usr/sbin/zabbix_agentd: listener #2 [waiting for connection]</span><br><span class="line">/dev/stdin:zabbix     19081  0.0  0.3  76692  2672 ?        S    May08   0:00 /usr/sbin/zabbix_agentd: listener #3 [waiting for connection]</span><br><span class="line">/dev/stdin:zabbix     19082  0.0  0.3  76692  2848 ?        S    May08   0:04 /usr/sbin/zabbix_agentd: active checks #1 [idle 1 sec]</span><br><span class="line">/dev/stdin:root       58944  0.0  0.1  12112  1000 pts/0    R+   07:38   0:00 grep --color=auto # /etc/fstab /dev/stdin</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="tee命令"><a href="#tee命令" class="headerlink" title="tee命令"></a>tee命令</h2><blockquote><p>tee命令可以将标准输入复制到标准输出和0或多个文件中。tee的作用是数据多重定向</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# echo hello | tee /tmp/xiaowangc /tmp/xiaowc | cat</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><h2 id="条件测试语句"><a href="#条件测试语句" class="headerlink" title="条件测试语句"></a>条件测试语句</h2><p>test命令或Bash内置命令[ ]可以做条件测试，如果测试的结果为True，则退出的状态码为0</p><p>这些条件测试常用在if、while语句中</p><ul><li><p>true和false命令</p><p>true命令返回true，退出码为0</p><p>false命令返回false，退出码非0</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# true</span><br><span class="line">[root@localhost ~]# echo $?</span><br><span class="line">0</span><br><span class="line">[root@localhost ~]# false</span><br><span class="line">[root@localhost ~]# echo $?</span><br><span class="line">1</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li><li><p>文件类测试</p><table><thead><tr><th align="center">条件表达式</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-e</td><td align="center">判断文件是否存在</td></tr><tr><td align="center">-f</td><td align="center">判断文件是否存在且为普通文件</td></tr><tr><td align="center">-b</td><td align="center">判断文件是否存在且为块设备</td></tr><tr><td align="center">-c</td><td align="center">判断文件是否存在且为字符设备</td></tr><tr><td align="center">-S</td><td align="center">判断文件是否存在且为套接字文件</td></tr><tr><td align="center">-p</td><td align="center">判断文件是否存在且为命令管道文件</td></tr><tr><td align="center">-l</td><td align="center">判断文件是否存在且为一个链接文件</td></tr><tr><td align="center">-d</td><td align="center">判断文件是否存在且为普通目录</td></tr></tbody></table></li><li><p>文件属性类测试</p><table><thead><tr><th align="center">条件表达式</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-r</td><td align="center">文件是否存在且当前用户可读</td></tr><tr><td align="center">-w</td><td align="center">文件是否存在且当前用户可写</td></tr><tr><td align="center">-x</td><td align="center">文件是否存在且当前用户可执行</td></tr><tr><td align="center">-s</td><td align="center">文件是否存在且为非空文件</td></tr><tr><td align="center">-N</td><td align="center">文件是否存在，且上次read后是否被modify</td></tr></tbody></table></li><li><p>两个文件之间的比较</p><table><thead><tr><th align="center">条件表达式</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">file1 -nt file2</td><td align="center">判断file1是否比file2新</td></tr><tr><td align="center">file1 -ot file2</td><td align="center">判断file1是否比file2旧</td></tr><tr><td align="center">file1 -ef file2</td><td align="center">判断file1与file2是否为同一文件</td></tr></tbody></table></li><li><p>数值大小比较</p><table><thead><tr><th align="center">条件表达式</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">int1 -eq int2</td><td align="center">两个数值相等</td></tr><tr><td align="center">int1 -ne int2</td><td align="center">两个数值不相等</td></tr><tr><td align="center">int1 -gt int2</td><td align="center">n1大于n2</td></tr><tr><td align="center">int1 -lt int2</td><td align="center">n1小于n2</td></tr><tr><td align="center">int1 -ge int2</td><td align="center">n1大于等于n2</td></tr><tr><td align="center">int1 -le int2</td><td align="center">n1小于等于n2</td></tr></tbody></table></li><li><p>字符串比较</p><table><thead><tr><th align="center">条件表达式</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-z str</td><td align="center">判断字符串是否为空，返回true</td></tr><tr><td align="center">str or -n str</td><td align="center">判断字符串是否为空，返回falsh</td></tr><tr><td align="center">str1 &#x3D; str2 or str1 &#x3D;&#x3D; str2</td><td align="center">判断str1和str2是否相同，相同则返回true</td></tr><tr><td align="center">str1 ！&#x3D; str2</td><td align="center">判断str1是否不等于str2</td></tr><tr><td align="center">str1 &gt; str2</td><td align="center">判断str1是否大于str2</td></tr><tr><td align="center">str1 &lt; str</td><td align="center">判断str1是否小于str2</td></tr></tbody></table></li><li><p>逻辑运算符</p><table><thead><tr><th align="center">条件表达式</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-a or &amp;&amp;</td><td align="center">两表达式同时为true才为true</td></tr><tr><td align="center">-o or ||</td><td align="center">两表达式任何一个为true则为true</td></tr><tr><td align="center">！</td><td align="center">对表达式取反</td></tr><tr><td align="center">（）</td><td align="center">更改表达式优先级</td></tr></tbody></table></li></ul><h2 id="if语句"><a href="#if语句" class="headerlink" title="if语句"></a>if语句</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if 条件判断式1; then</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当条件满足时，执行的语句</span></span><br><span class="line">语句;</span><br><span class="line">[elif 条件判断式2; then</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当条件满足时，执行的语句;]</span></span><br><span class="line">[else 所有条件不成立时，执行此语句;]</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">test-commands既可以是<span class="built_in">test</span>测试或[]、[[]]测试，也可以是任何其他命令，test-commands用于条件测试，它只判断命令的退出状态码是否为0，为0则为<span class="literal">true</span></span></span><br></pre></td></tr></table></figure><p>实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/sh</span></span><br><span class="line">dir_d=/media/disk_d#定义了三个变量</span><br><span class="line">dir_e=/media/disk_e</span><br><span class="line">dir_f=/media/disk_f</span><br><span class="line"></span><br><span class="line">a=`ls $dir_d | wc -l`#将ls和wl命令运行的返回值赋值给a、b、c</span><br><span class="line">b=`ls $dir_e | wc -l`</span><br><span class="line">c=`ls $dir_f | wc -l`</span><br><span class="line">echo &quot;检查 disk_d..&quot;</span><br><span class="line">if [ $a -eq 0 ]; then#判断$a变量是否等于0，等于0则代表不存在</span><br><span class="line">    echo &quot;disk_d 不存在,现在开始创建...&quot;</span><br><span class="line">    sudo  mount -t ntfs /dev/disk/by-label/software /media/disk_d#挂载</span><br><span class="line">else</span><br><span class="line">    echo &quot;disk_d 存在&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h2 id="case"><a href="#case" class="headerlink" title="case"></a>case</h2><p>case用于确定的分支判断。</p><p>实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line">case $a in</span><br><span class="line">&quot;1&quot;)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行此语句</span></span><br><span class="line">;;</span><br><span class="line">&quot;2&quot;)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行此语句</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果都不满足则执行此语句</span></span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">case</span>以<span class="keyword">case</span>开头，以<span class="keyword">esac</span>结尾</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在每个分支后面都要以;;结尾</span></span><br></pre></td></tr></table></figure><h2 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h2><blockquote><p>两种for循环结构：</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第一种</span></span><br><span class="line">for i in s1 s2 s3 ...;do 语句;done</span><br><span class="line"></span><br><span class="line">for i in s1 s2 s3;do</span><br><span class="line">  语句</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二种</span></span><br><span class="line">for ((初始化；循环控制条件；变量变化));</span><br><span class="line">do</span><br><span class="line">语句</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while 测试条件;</span><br><span class="line">do</span><br><span class="line">语句</span><br><span class="line">done</span><br></pre></td></tr></table></figure><blockquote><p>​无限循环的写法</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">while :</span><br><span class="line">do</span><br><span class="line">命令</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">命令</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="Shell函数"><a href="#Shell函数" class="headerlink" title="Shell函数"></a>Shell函数</h2><p>Shell函数可以当作命令一样执行，它是一个或多个命令的组合结构体。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Shell函数的几种语法格式</span></span><br><span class="line"></span><br><span class="line">function 函数名 &#123; 命令 &#125;</span><br><span class="line">函数名() &#123; 命令 &#125;</span><br><span class="line">function 函数名() &#123;  命令 &#125;</span><br></pre></td></tr></table></figure><p>函数定义后，可以直接使用函数名来进行调用，同时可以向函数传递0个或多个参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不传递参数</span></span><br><span class="line">函数名</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">传递多个参数</span></span><br><span class="line">函数名 参数1 参数2 参数3 ...</span><br></pre></td></tr></table></figure><ul><li>在函数中，那些位置变量将具有特殊的含义：<ul><li>$1、$2、$3…：传递给函数的第一个参数保存在$1中，第二个参数保存在$2中，以此类推</li><li>$@、$*：保存所有参数，各参数使用空格分隔<ul><li>不用双引号包围时，两者没区别</li><li>使用双引号包围时，$@的各个元素都被双引号包围，$*的所有元素一次性被双引号包围</li></ul></li></ul></li></ul><p><strong>local</strong>在函数里定义局部变量</p><p><strong>return</strong>语句可以来定义函数的返回值</p><h2 id="实践：分析一段Shell脚本"><a href="#实践：分析一段Shell脚本" class="headerlink" title="实践：分析一段Shell脚本"></a>实践：分析一段Shell脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"> 1 #!/bin/bash</span><br><span class="line"> 2 #</span><br><span class="line"> 3</span><br><span class="line"> 4 function prepare_check() &#123;</span><br><span class="line"> 5   isRoot=`id -u -n | grep root | wc -l`</span><br><span class="line"> 6   if [ &quot;x$isRoot&quot; != &quot;x1&quot; ]; then</span><br><span class="line"> 7       echo -e &quot;[\033[31m ERROR \033[0m] Please use root to execute the installation script (请用 root 用户执行安装脚本)&quot;</span><br><span class="line"> 8       exit 1</span><br><span class="line"> 9   fi</span><br><span class="line">10   processor=`cat /proc/cpuinfo| grep &quot;processor&quot;| wc -l`</span><br><span class="line">11   if [ $processor -lt 2 ]; then</span><br><span class="line">12       echo -e &quot;[\033[31m ERROR \033[0m] The CPU is less than 2 cores (CPU 小于 2核，JumpServer 所在机器的 CPU 需要至少 2核)&quot;</span><br><span class="line">13       exit 1</span><br><span class="line">14   fi</span><br><span class="line">15   memTotal=`cat /proc/meminfo | grep MemTotal | awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">16   if [ $memTotal -lt 3750000 ]; then</span><br><span class="line">17       echo -e &quot;[\033[31m ERROR \033[0m] Memory less than 4G (内存小于 4G，JumpServer 所在机器的内存需要至少 4G)&quot;</span><br><span class="line">18       exit 1</span><br><span class="line">19   fi</span><br><span class="line">20 &#125;</span><br><span class="line">21</span><br><span class="line">22 function install_soft() &#123;</span><br><span class="line">23     if command -v dnf &gt; /dev/null; then</span><br><span class="line">24       if [ &quot;$1&quot; == &quot;python&quot; ]; then</span><br><span class="line">25         dnf -q -y install python2</span><br><span class="line">26         ln -s /usr/bin/python2 /usr/bin/python</span><br><span class="line">27       else</span><br><span class="line">28         dnf -q -y install $1</span><br><span class="line">29       fi</span><br><span class="line">30     elif command -v yum &gt; /dev/null; then</span><br><span class="line">31       yum -q -y install $1</span><br><span class="line">32     elif command -v apt &gt; /dev/null; then</span><br><span class="line">33       apt-get -qqy install $1</span><br><span class="line">34     elif command -v zypper &gt; /dev/null; then</span><br><span class="line">35       zypper -q -n install $1</span><br><span class="line">36     elif command -v apk &gt; /dev/null; then</span><br><span class="line">37       apk add -q $1</span><br><span class="line">38     else</span><br><span class="line">39       echo -e &quot;[\033[31m ERROR \033[0m] Please install it first (请先安装) $1 &quot;</span><br><span class="line">40       exit 1</span><br><span class="line">41     fi</span><br><span class="line">42 &#125;</span><br><span class="line">43</span><br><span class="line">44 function prepare_install() &#123;</span><br><span class="line">45   for i in curl wget zip python; do</span><br><span class="line">46     command -v $i &amp;&gt;/dev/null || install_soft $i</span><br><span class="line">47   done</span><br><span class="line">48 &#125;</span><br><span class="line">49</span><br><span class="line">50 function get_installer() &#123;</span><br><span class="line">51   echo &quot;download install script to /opt/jumpserver-installe (开始下载安装脚本到 /opt/jumpserver-installe)&quot;</span><br><span class="line">52   Version=$(curl -s &#x27;https://api.github.com/repos/jumpserver/installer/releases/latest&#x27; | grep &quot;tag_name&quot; | head -n 1 | awk -F &quot;:&quot; &#x27;&#123;print $2&#125;&#x27; | sed &#x27;s/\&quot;//g;s/,//g;s/ //g&#x27;)</span><br><span class="line">53   if [ ! &quot;$Version&quot; ]; then</span><br><span class="line">54     echo -e &quot;[\033[31m ERROR \033[0m] Network Failed (请检查网络是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">55   fi</span><br><span class="line">56   cd /opt</span><br><span class="line">57   if [ ! -d &quot;/opt/jumpserver-installer-$Version&quot; ]; then</span><br><span class="line">58     wget -qO jumpserver-installer-$Version.tar.gz https://github.com/jumpserver/installer/releases/download/$Version/jumpserver-installer-$Version.tar.gz || &#123;</span><br><span class="line">59       rm -rf /opt/jumpserver-installer-$Version.tar.gz</span><br><span class="line">60       echo -e &quot;[\033[31m ERROR \033[0m] Failed to download jumpserver-installer (下载 jumpserver-installer 失败, 请检查网络是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">61       exit 1</span><br><span class="line">62     &#125;</span><br><span class="line">63     tar -xf /opt/jumpserver-installer-$Version.tar.gz -C /opt || &#123;</span><br><span class="line">64       rm -rf /opt/jumpserver-installer-$Version</span><br><span class="line">65       echo -e &quot;[\033[31m ERROR \033[0m] Failed to unzip jumpserver-installe (解压 jumpserver-installer 失败, 请检查网络是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">66       exit 1</span><br><span class="line">67     &#125;</span><br><span class="line">68     rm -rf /opt/jumpserver-installer-$Version.tar.gz</span><br><span class="line">69   fi</span><br><span class="line">70 &#125;</span><br><span class="line">71</span><br><span class="line">72 function config_installer() &#123;</span><br><span class="line">73   cd /opt/jumpserver-installer-$Version</span><br><span class="line">74   JMS_Version=$(curl -s &#x27;https://api.github.com/repos/jumpserver/jumpserver/releases/latest&#x27; | grep &quot;tag_name&quot; | head -n 1 | awk -F &quot;:&quot; &#x27;&#123;print $2&#125;&#x27; | sed &#x27;s/\&quot;//g;s/,//g;s/ //g&#x27;)</span><br><span class="line">75   if [ ! &quot;$JMS_Version&quot; ]; then</span><br><span class="line">76     echo -e &quot;[\033[31m ERROR \033[0m] Network Failed (请检查网络是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">77     exit 1</span><br><span class="line">78   fi</span><br><span class="line">79   sed -i &quot;s/VERSION=.*/VERSION=$JMS_Version/g&quot; /opt/jumpserver-installer-$Version/static.env</span><br><span class="line">80   ./jmsctl.sh install</span><br><span class="line">81 &#125;</span><br><span class="line">82</span><br><span class="line">83 function main()&#123;</span><br><span class="line">84   prepare_check</span><br><span class="line">85   prepare_install</span><br><span class="line">86   get_installer</span><br><span class="line">87   config_installer</span><br><span class="line">88 &#125;</span><br><span class="line">89</span><br><span class="line">90 main              </span><br></pre></td></tr></table></figure><blockquote><p>分析</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不要被那么多代码量给吓到了，我们慢慢来分析</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先了解整个shell的框架如下，</span></span><br><span class="line">&quot;定义的函数不会直接运行，必须通过函数名去调用才会执行&quot;</span><br><span class="line">prepare_check() &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义prepare_check函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_soft() &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义install_soft函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">prepare_install() &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义prepare_install函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get_installer() &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义get_installer函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config_installer() &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义config_installer函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义主函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main #执行主函数</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">我们了解到这段shell脚本有6个函数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">shell一开始运行并不会直接执行某个函数，只是定义了一个函数告诉系统有这么个名字为***的函数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用函数名进行调用，才会运行函数体里面的语句！</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">我们从大概的结构看，最后一行对main主函数进行了调用，也就是运行main主函数，我们来分析以下主函数里面做了什么？</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>主函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function main()&#123;</span><br><span class="line">   prepare_check#第一步：调用prepare_check函数</span><br><span class="line">   prepare_install#第二步：调用prepare_install函数</span><br><span class="line">   get_installer#第三步：调用get_installer函数</span><br><span class="line">   config_installer#第四步：调用config_installer函数</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主函数main函数体内对4个自定义函数进行了调用，当调用prepare_check函数则程序会跳转到prepare_check函数体内执行此函数体内的代码</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">接下来我们分析prepare_check函数</span></span><br></pre></td></tr></table></figure><blockquote><p>prepare_check函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">function prepare_check() &#123;</span><br><span class="line">  isRoot=`id -u -n | grep root | wc -l`</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">执行命令<span class="built_in">id</span> -u -n | grep root | <span class="built_in">wc</span> -l并将返回值赋值给isRoot变量</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">判断当前用户是否为root用户并对输出的结果计数</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">如果是root用户则为1否则为0</span></span><br><span class="line">  </span><br><span class="line">  if [ &quot;x$isRoot&quot; != &quot;x1&quot; ]; then#条件判断，这里的$isRoot为调用变量，如果x$isRoot不等于&quot;x1&quot;</span><br><span class="line">    #如果满足上面的条件则执行下面两条语句</span><br><span class="line">    #输出：请用 root 用户执行安装脚本的提示</span><br><span class="line">    #-e选项是激活转义字符 “\”表示转义   [\033[31m ERROR \033[0m] 表示ERROR用红色显示</span><br><span class="line">      echo -e &quot;[\033[31m ERROR \033[0m] Please use root to execute the installation script (请用 root 用户执行安装脚本)&quot;</span><br><span class="line">      #exit为退出</span><br><span class="line">      exit 1</span><br><span class="line">  fi</span><br><span class="line">  </span><br><span class="line">  processor=`cat /proc/cpuinfo| grep &quot;processor&quot;| wc -l`</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">执行命令<span class="built_in">cat</span> /proc/cpuinfo | grep <span class="string">&quot;processor&quot;</span> | <span class="built_in">wc</span> -l 对/proc/cpuinfo文件的processor的字段进行计数并将结果赋值给processor变量</span></span><br><span class="line">  </span><br><span class="line">  if [ $processor -lt 2 ]; then#条件判断，如果processor变量的值小于2</span><br><span class="line">    #输出：CPU 小于 2核，JumpServer 所在机器的 CPU 需要至少 2核</span><br><span class="line">      echo -e &quot;[\033[31m ERROR \033[0m] The CPU is less than 2 cores (CPU 小于 2核，JumpServer 所在机器的 CPU 需要至少 2核)&quot;</span><br><span class="line">      #退出shell</span><br><span class="line">      exit 1</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  memTotal=`cat /proc/meminfo | grep MemTotal | awk &#x27;&#123;print $2&#125;&#x27;`#输出/proc/meminfo文件的MemTotal字段的第二列的结果赋值给memTotal变量</span><br><span class="line">  </span><br><span class="line">  if [ $memTotal -lt 3750000 ]; then#判断memTotal变量的值是否小于3750000</span><br><span class="line">    #输出：内存小于 4G，JumpServer 所在机器的内存需要至少 4G</span><br><span class="line">      echo -e &quot;[\033[31m ERROR \033[0m] Memory less than 4G (内存小于 4G，JumpServer 所在机器的内存需要至少 4G)&quot;</span><br><span class="line">      #退出shell</span><br><span class="line">      exit 1</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">prepare_check函数主要用来判断主机的CPU、内存、用户是否都满足条件，如果不满足则退出shell脚本</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果满足我们则执行main函数的第二条语句</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">看下面</span></span><br></pre></td></tr></table></figure><blockquote><p>主函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function main()&#123;</span><br><span class="line">   prepare_check#这步已经执行完毕，主机各项配置都符合条件，接下来执行下面那条语句；如果第一个函数其中一项不满足条件，整个shell进行退出，不会再执行下面的语句了。    </span><br><span class="line">   prepare_install#第二步：调用prepare_install函数</span><br><span class="line">   get_installer#第三步：调用get_installer函数</span><br><span class="line">   config_installer#第四步：调用config_installer函数</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下面进入prepare_install函数</span></span><br></pre></td></tr></table></figure><blockquote><p>prepare_install函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function prepare_install() &#123;</span><br><span class="line">  for i in curl wget zip python; do</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">使用<span class="keyword">for</span>循环进行迭代，<span class="keyword">for</span>循环共会执行4次，每次的i变量的参数为curl、wget、zip、python</span></span><br><span class="line">    command -v $i &amp;&gt;/dev/null || install_soft $i</span><br><span class="line">    #使用command -v 命令判断i变量中的参数(也就是判断系统有没有这个命令)，如果有，则开始下一轮循环，如果没有则调用install_soft函数并传递变量i的值，并进行相应命令的安装</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">本函数用来判断Linux系统中是否存在curl、wget、zip、python这四条命令，如果都有，则本函数执行完毕！如果没有则将没有的命令通过变量i传递至install_soft函数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">接下来我们看install_soft函数</span></span><br></pre></td></tr></table></figure><blockquote><p>install_soft函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">function install_soft() &#123;</span><br><span class="line">    if command -v dnf &gt; /dev/null; then#判断系统是否有dnf命令</span><br><span class="line">      if [ &quot;$1&quot; == &quot;python&quot; ]; then#判断$1为 调用函数时传递进来的参数 也就是没有前面没有安装的命令 判断是否为python</span><br><span class="line">        dnf -q -y install python2#安装python2</span><br><span class="line">        ln -s /usr/bin/python2 /usr/bin/python#对python2命令进行软链接</span><br><span class="line">      else</span><br><span class="line">        dnf -q -y install $1#如果不等于python则安装$1 也就是传递进来的参数(命令)</span><br><span class="line">      fi</span><br><span class="line">    elif command -v yum &gt; /dev/null; then#判断系统是否有yum命令</span><br><span class="line">      yum -q -y install $1#安装$1变量里的命令</span><br><span class="line">    elif command -v apt &gt; /dev/null; then#判断系统是否有apt命令</span><br><span class="line">      apt-get -qqy install $1#安装$1变量里的命令</span><br><span class="line">    elif command -v zypper &gt; /dev/null; then#判断系统是否有zypper命令</span><br><span class="line">      zypper -q -n install $1#安装$1变量里的命令</span><br><span class="line">    elif command -v apk &gt; /dev/null; then#判断系统是否有apk命令</span><br><span class="line">      apk add -q $1#安装$1变量里的命令</span><br><span class="line">    else</span><br><span class="line">      echo -e &quot;[\033[31m ERROR \033[0m] Please install it first (请先安装) $1 &quot;#如果以上方法都无法进行安装，则输出：...请安装**</span><br><span class="line">      #退出shell</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">回到prepare_install函数</span></span><br></pre></td></tr></table></figure><blockquote><p>prepare_install函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function prepare_install() &#123;</span><br><span class="line">  for i in curl wget zip python; do</span><br><span class="line">    command -v $i &amp;&gt;/dev/null || install_soft $i</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过prepare_install函数和install_soft的判断和安装</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">我们可以确定系统已经有curl wget zip python等4条命令了，如果正常执行完install_soft函数体里的命令(不正常情况shell已退出)，则回到main主函数</span></span><br></pre></td></tr></table></figure><blockquote><p>主函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function main()&#123;</span><br><span class="line">   prepare_check#这步已经执行完毕，主机各项配置都符合条件，接下来执行下面那条语句；如果第一个函数其中一项不满足条件，整个shell进行退出，不会再执行下面的语句了。    </span><br><span class="line">   prepare_install#这部已经执行完毕，主机必要的命令已存在</span><br><span class="line">   get_installer#第三步：调用get_installer函数</span><br><span class="line">   config_installer#第四步：调用config_installer函数</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下面进入get_isntaller函数</span></span><br></pre></td></tr></table></figure><blockquote><p>get_installer函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function get_installer() &#123;</span><br><span class="line">  echo &quot;download install script to /opt/jumpserver-installe (开始下载安装脚本到 /opt/jumpserver-installe)&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">输出：开始下载安装脚本...</span></span><br><span class="line">  </span><br><span class="line">  Version=$(curl -s &#x27;https://api.github.com/repos/jumpserver/installer/releases/latest&#x27; | grep &quot;tag_name&quot; | head -n 1 | awk -F &quot;:&quot; &#x27;&#123;print $2&#125;&#x27; | sed &#x27;s/\&quot;//g;s/,//g;s/ //g&#x27;)</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">对链接的信息进行筛选，找到<span class="string">&quot;tag-name&quot;</span>字符的第一行，并对接下来的结果筛选，并将结果赋值给Version变量</span></span><br><span class="line">  if [ ! &quot;$Version&quot; ]; then# 取反</span><br><span class="line">    echo -e &quot;[\033[31m ERROR \033[0m] Network Failed (请检查网络是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">  fi</span><br><span class="line">  cd /opt#进入/opt目录</span><br><span class="line">  </span><br><span class="line">  if [ ! -d &quot;/opt/jumpserver-installer-$Version&quot; ]; then#判断这个目录是否存在，并取反</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">如果不存在，则开始下载相应的文件，如果下载不成功，删除下载的文件，并提示检查网络是否正常</span></span><br><span class="line">    wget -qO jumpserver-installer-$Version.tar.gz https://github.com/jumpserver/installer/releases/download/$Version/jumpserver-installer-$Version.tar.gz || &#123;</span><br><span class="line">      rm -rf /opt/jumpserver-installer-$Version.tar.gz</span><br><span class="line">      echo -e &quot;[\033[31m ERROR \033[0m] Failed to download jumpserver-installer (下载 jumpserver-installer 失败, 请检查&gt;网络是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">      exit 1</span><br><span class="line">    &#125;</span><br><span class="line">    #下载成功后对文件进行解压缩 || 前者不成功则进行删除相应的目录并提示：网络问题或重新执行脚本并退出</span><br><span class="line">    tar -xf /opt/jumpserver-installer-$Version.tar.gz -C /opt || &#123;</span><br><span class="line">      rm -rf /opt/jumpserver-installer-$Version</span><br><span class="line">      echo -e &quot;[\033[31m ERROR \033[0m] Failed to unzip jumpserver-installe (解压 jumpserver-installer 失败, 请检查网络&gt;是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">      exit 1</span><br><span class="line">    &#125;</span><br><span class="line">    #如果成功解压后，删除下载的压缩包</span><br><span class="line">    rm -rf /opt/jumpserver-installer-$Version.tar.gz</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">成功执行完毕返回main主函数</span></span><br></pre></td></tr></table></figure><blockquote><p>主函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function main()&#123;</span><br><span class="line">   prepare_check#这步已经执行完毕，主机各项配置都符合条件，接下来执行下面那条语句；如果第一个函数其中一项不满足条件，整个shell进行退出，不会再执行下面的语句了。    </span><br><span class="line">   prepare_install#这部已经执行完毕，主机必要的命令已存在</span><br><span class="line">   get_installer#这部已经执行完毕，相应的文件已下载并解压</span><br><span class="line">   config_installer#第四步：调用config_installer函数</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下面进入config_installer函数</span></span><br></pre></td></tr></table></figure><blockquote><p>config_installer函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function config_installer() &#123;</span><br><span class="line">  cd /opt/jumpserver-installer-$Version</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">进入相应的目录</span></span><br><span class="line">  </span><br><span class="line">  JMS_Version=$(curl -s &#x27;https://api.github.com/repos/jumpserver/jumpserver/releases/latest&#x27; | grep &quot;tag_name&quot; | head -n 1 | awk -F &quot;:&quot; &#x27;&#123;print $2&#125;&#x27; | sed &#x27;s/\&quot;//g;s/,//g;s/ //g&#x27;)</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">将链接的信息进行筛选并赋值给JMS_Version变量</span></span><br><span class="line">  </span><br><span class="line">  if [ ! &quot;$JMS_Version&quot; ]; then#取反</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">如果为假 则提示：检查网络或重新执行脚本，并退出</span></span><br><span class="line">    echo -e &quot;[\033[31m ERROR \033[0m] Network Failed (请检查网络是否正常或尝试重新执行脚本)&quot;</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">  </span><br><span class="line">  sed -i &quot;s/VERSION=.*/VERSION=$JMS_Version/g&quot; /opt/jumpserver-installer-$Version/static.env</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">在/opt/jumpserver-installer-<span class="variable">$Version</span>/static.env文件中插入s/VERSION=.*/VERSION=<span class="variable">$JMS_Version</span>/g参数</span></span><br><span class="line">  ./jmsctl.sh install</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">运行脚本</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">config_installer函数执行完毕，返回主函数main</span></span><br></pre></td></tr></table></figure><blockquote><p>主函数</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function main()&#123;</span><br><span class="line">   prepare_check#这步已经执行完毕，主机各项配置都符合条件，接下来执行下面那条语句；如果第一个函数其中一项不满足条件，整个shell进行退出，不会再执行下面的语句了。    </span><br><span class="line">   prepare_install#这部已经执行完毕，主机必要的命令已存在</span><br><span class="line">   get_installer#这部已经执行完毕，相应的文件已下载并解压</span><br><span class="line">   config_installer#这部已经执行完毕，已配置完毕相应的配置并运行jumpserver</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------- 至此shell分析结束，如果有不到位的请留言提出qwq或私信我--------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 除了某些命令可能不是很了解，其实看完前面的基础和掌握Linux基础命令，对上面的shell也能大致的进行分析了</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 接下来就是多多练习了~</span></span></span><br><span class="line"><span class="meta prompt_">#</span></span><br></pre></td></tr></table></figure><h1 id="记一次MySQL-Shell学习"><a href="#记一次MySQL-Shell学习" class="headerlink" title="记一次MySQL-Shell学习"></a>记一次MySQL-Shell学习</h1><h2 id="日志记录函数"><a href="#日志记录函数" class="headerlink" title="日志记录函数"></a>日志记录函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql_log() &#123;</span><br><span class="line">        local type=&quot;$1&quot;; shift</span><br><span class="line">        local text=&quot;$*&quot;; if [ &quot;$#&quot; -eq 0 ]; then text=&quot;$(cat)&quot;; fi</span><br><span class="line">        local dt; dt=&quot;$(date --rfc-3339=seconds)&quot;</span><br><span class="line">        printf &#x27;%s [%s] [Entrypoint]: %s\n&#x27; &quot;$dt&quot; &quot;$type&quot; &quot;$text&quot;</span><br><span class="line">&#125;</span><br><span class="line">mysql_note() &#123;</span><br><span class="line">        mysql_log Note &quot;$@&quot;</span><br><span class="line">&#125;</span><br><span class="line">mysql_warn() &#123;</span><br><span class="line">        mysql_log Warn &quot;$@&quot; &gt;&amp;2</span><br><span class="line">&#125;</span><br><span class="line">mysql_error() &#123;</span><br><span class="line">        mysql_log ERROR &quot;$@&quot; &gt;&amp;2</span><br><span class="line">        exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="文件变量函数"><a href="#文件变量函数" class="headerlink" title="文件变量函数"></a>文件变量函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">file_env() &#123;</span><br><span class="line">        local var=&quot;$1&quot;</span><br><span class="line">        local fileVar=&quot;$&#123;var&#125;_FILE&quot;</span><br><span class="line">        local def=&quot;$&#123;2:-&#125;&quot;</span><br><span class="line">        if [ &quot;$&#123;!var:-&#125;&quot; ] &amp;&amp; [ &quot;$&#123;!fileVar:-&#125;&quot; ]; then</span><br><span class="line">                mysql_error &quot;Both $var and $fileVar are set (but are exclusive)&quot;</span><br><span class="line">        fi</span><br><span class="line">        local val=&quot;$def&quot;</span><br><span class="line">        if [ &quot;$&#123;!var:-&#125;&quot; ]; then</span><br><span class="line">                val=&quot;$&#123;!var&#125;&quot;</span><br><span class="line">        elif [ &quot;$&#123;!fileVar:-&#125;&quot; ]; then</span><br><span class="line">                val=&quot;$(&lt; &quot;$&#123;!fileVar&#125;&quot;)&quot;</span><br><span class="line">        fi</span><br><span class="line">        export &quot;$var&quot;=&quot;$val&quot;</span><br><span class="line">        unset &quot;$fileVar&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检测文件本身函数"><a href="#检测文件本身函数" class="headerlink" title="检测文件本身函数"></a>检测文件本身函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_is_sourced() &#123;</span><br><span class="line">        [ &quot;$&#123;#FUNCNAME[@]&#125;&quot; -ge 2 ] \</span><br><span class="line">                &amp;&amp; [ &quot;$&#123;FUNCNAME[0]&#125;&quot; = &#x27;_is_sourced&#x27; ] \</span><br><span class="line">                &amp;&amp; [ &quot;$&#123;FUNCNAME[1]&#125;&quot; = &#x27;source&#x27; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="进程初始化文件函数"><a href="#进程初始化文件函数" class="headerlink" title="进程初始化文件函数"></a>进程初始化文件函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">docker_process_init_files() &#123;</span><br><span class="line">        mysql=( docker_process_sql )</span><br><span class="line"></span><br><span class="line">        echo</span><br><span class="line">        local f</span><br><span class="line">        for f; do</span><br><span class="line">                case &quot;$f&quot; in</span><br><span class="line">                        *.sh)</span><br><span class="line">                                if [ -x &quot;$f&quot; ]; then</span><br><span class="line">                                        mysql_note &quot;$0: running $f&quot;</span><br><span class="line">                                        &quot;$f&quot;</span><br><span class="line">                                else</span><br><span class="line">                                        mysql_note &quot;$0: sourcing $f&quot;</span><br><span class="line">                                        . &quot;$f&quot;</span><br><span class="line">                                fi</span><br><span class="line">                                ;;</span><br><span class="line">                        *.sql)     mysql_note &quot;$0: running $f&quot;; docker_process_sql &lt; &quot;$f&quot;; echo ;;</span><br><span class="line">                        *.sql.bz2) mysql_note &quot;$0: running $f&quot;; bunzip2 -c &quot;$f&quot; | docker_process_sql; echo ;;</span><br><span class="line">                        *.sql.gz)  mysql_note &quot;$0: running $f&quot;; gunzip -c &quot;$f&quot; | docker_process_sql; echo ;;</span><br><span class="line">                        *.sql.xz)  mysql_note &quot;$0: running $f&quot;; xzcat &quot;$f&quot; | docker_process_sql; echo ;;</span><br><span class="line">                        *.sql.zst) mysql_note &quot;$0: running $f&quot;; zstd -dc &quot;$f&quot; | docker_process_sql; echo ;;</span><br><span class="line">                        *)         mysql_warn &quot;$0: ignoring $f&quot; ;;</span><br><span class="line">                esac</span><br><span class="line">                echo</span><br><span class="line">        done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检测配置函数"><a href="#检测配置函数" class="headerlink" title="检测配置函数"></a>检测配置函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql_check_config() &#123;</span><br><span class="line">        local toRun=( &quot;$@&quot; &quot;$&#123;_verboseHelpArgs[@]&#125;&quot; ) errors</span><br><span class="line">        if ! errors=&quot;$(&quot;$&#123;toRun[@]&#125;&quot; 2&gt;&amp;1 &gt;/dev/null)&quot;; then</span><br><span class="line">                mysql_error $&#x27;mysqld failed while attempting to check config\n\tcommand was: &#x27;&quot;$&#123;toRun[*]&#125;&quot;$&#x27;\n\t&#x27;&quot;$errors&quot;</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取配置函数"><a href="#获取配置函数" class="headerlink" title="获取配置函数"></a>获取配置函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql_get_config() &#123;</span><br><span class="line">        local conf=&quot;$1&quot;; shift</span><br><span class="line">        &quot;$@&quot; &quot;$&#123;_verboseHelpArgs[@]&#125;&quot; 2&gt;/dev/null \</span><br><span class="line">                | awk -v conf=&quot;$conf&quot; &#x27;$1 == conf &amp;&amp; /^[^ \t]/ &#123; sub(/^[^ \t]+[ \t]+/, &quot;&quot;); print; exit &#125;&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="套接字函数"><a href="#套接字函数" class="headerlink" title="套接字函数"></a>套接字函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql_socket_fix() &#123;</span><br><span class="line">        local defaultSocket</span><br><span class="line">        defaultSocket=&quot;$(mysql_get_config &#x27;socket&#x27; mysqld --no-defaults)&quot;</span><br><span class="line">        if [ &quot;$defaultSocket&quot; != &quot;$SOCKET&quot; ]; then</span><br><span class="line">                ln -sfTv &quot;$SOCKET&quot; &quot;$defaultSocket&quot; || :</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="临时启动服务函数"><a href="#临时启动服务函数" class="headerlink" title="临时启动服务函数"></a>临时启动服务函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">docker_temp_server_start() &#123;</span><br><span class="line">        if [ &quot;$&#123;MYSQL_MAJOR&#125;&quot; = &#x27;5.7&#x27; ]; then</span><br><span class="line">                &quot;$@&quot; --skip-networking --default-time-zone=SYSTEM --socket=&quot;$&#123;SOCKET&#125;&quot; &amp;</span><br><span class="line">                mysql_note &quot;Waiting for server startup&quot;</span><br><span class="line">                local i</span><br><span class="line">                for i in &#123;30..0&#125;; do</span><br><span class="line">                        # only use the root password if the database has already been initialized</span><br><span class="line">                        # so that it won&#x27;t try to fill in a password file when it hasn&#x27;t been set yet</span><br><span class="line">                        extraArgs=()</span><br><span class="line">                        if [ -z &quot;$DATABASE_ALREADY_EXISTS&quot; ]; then</span><br><span class="line">                                extraArgs+=( &#x27;--dont-use-mysql-root-password&#x27; )</span><br><span class="line">                        fi</span><br><span class="line">                        if docker_process_sql &quot;$&#123;extraArgs[@]&#125;&quot; --database=mysql &lt;&lt;&lt;&#x27;SELECT 1&#x27; &amp;&gt; /dev/null; then</span><br><span class="line">                                break</span><br><span class="line">                        fi</span><br><span class="line">                        sleep 1</span><br><span class="line">                done</span><br><span class="line">                if [ &quot;$i&quot; = 0 ]; then</span><br><span class="line">                        mysql_error &quot;Unable to start server.&quot;</span><br><span class="line">                fi</span><br><span class="line">        else</span><br><span class="line">                # For 5.7+ the server is ready for use as soon as startup command unblocks</span><br><span class="line">                if ! &quot;$@&quot; --daemonize --skip-networking --default-time-zone=SYSTEM --socket=&quot;$&#123;SOCKET&#125;&quot;; then</span><br><span class="line">                        mysql_error &quot;Unable to start server.&quot;</span><br><span class="line">                fi</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="停止临时服务函数"><a href="#停止临时服务函数" class="headerlink" title="停止临时服务函数"></a>停止临时服务函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker_temp_server_stop() &#123;</span><br><span class="line">        if ! mysqladmin --defaults-extra-file=&lt;( _mysql_passfile ) shutdown -uroot --socket=&quot;$&#123;SOCKET&#125;&quot;; then</span><br><span class="line">                mysql_error &quot;Unable to shut down server.&quot;</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检查密码函数"><a href="#检查密码函数" class="headerlink" title="检查密码函数"></a>检查密码函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">docker_verify_minimum_env() &#123;</span><br><span class="line">        if [ -z &quot;$MYSQL_ROOT_PASSWORD&quot; -a -z &quot;$MYSQL_ALLOW_EMPTY_PASSWORD&quot; -a -z &quot;$MYSQL_RANDOM_ROOT_PASSWORD&quot; ]; then</span><br><span class="line">                mysql_error &lt;&lt; -&#x27;EOF&#x27;</span><br><span class="line">                        Database is uninitialized and password option is not specified</span><br><span class="line">                            You need to specify one of the following as an environment variable:</span><br><span class="line">                            - MYSQL_ROOT_PASSWORD</span><br><span class="line">                            - MYSQL_ALLOW_EMPTY_PASSWORD</span><br><span class="line">                            - MYSQL_RANDOM_ROOT_PASSWORD</span><br><span class="line">                </span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # This will prevent the CREATE USER from failing (and thus exiting with a half-initialized database)</span><br><span class="line">        if [ &quot;$MYSQL_USER&quot; = &#x27;root&#x27; ]; then</span><br><span class="line">                mysql_error &lt;&lt; -&#x27;EOF&#x27;</span><br><span class="line">                        MYSQL_USER=&quot;root&quot;, MYSQL_USER and MYSQL_PASSWORD are for configuring a regular user and cannot be used for the root user</span><br><span class="line">                            Remove MYSQL_USER=&quot;root&quot; and use one of the following to control the root user password:</span><br><span class="line">                            - MYSQL_ROOT_PASSWORD</span><br><span class="line">                            - MYSQL_ALLOW_EMPTY_PASSWORD</span><br><span class="line">                            - MYSQL_RANDOM_ROOT_PASSWORD</span><br><span class="line">                EOF</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # warn when missing one of MYSQL_USER or MYSQL_PASSWORD</span><br><span class="line">        if [ -n &quot;$MYSQL_USER&quot; ] &amp;&amp; [ -z &quot;$MYSQL_PASSWORD&quot; ]; then</span><br><span class="line">                mysql_warn &#x27;MYSQL_USER specified, but missing MYSQL_PASSWORD; MYSQL_USER will not be created&#x27;</span><br><span class="line">        elif [ -z &quot;$MYSQL_USER&quot; ] &amp;&amp; [ -n &quot;$MYSQL_PASSWORD&quot; ]; then</span><br><span class="line">                mysql_warn &#x27;MYSQL_PASSWORD specified, but missing MYSQL_USER; MYSQL_PASSWORD will be ignored&#x27;</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="创建数据库文件函数"><a href="#创建数据库文件函数" class="headerlink" title="创建数据库文件函数"></a>创建数据库文件函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">docker_create_db_directories() &#123;</span><br><span class="line">        local user; user=&quot;$(id -u)&quot;</span><br><span class="line"></span><br><span class="line">        local -A dirs=( [&quot;$DATADIR&quot;]=1 )</span><br><span class="line">        local dir</span><br><span class="line">        dir=&quot;$(dirname &quot;$SOCKET&quot;)&quot;</span><br><span class="line">        dirs[&quot;$dir&quot;]=1</span><br><span class="line"></span><br><span class="line">        # &quot;datadir&quot; and &quot;socket&quot; are already handled above (since they were already queried previously)</span><br><span class="line">        local conf</span><br><span class="line">        for conf in \</span><br><span class="line">                general-log-file \</span><br><span class="line">                keyring_file_data \</span><br><span class="line">                pid-file \</span><br><span class="line">                secure-file-priv \</span><br><span class="line">                slow-query-log-file \</span><br><span class="line">        ; do</span><br><span class="line">                dir=&quot;$(mysql_get_config &quot;$conf&quot; &quot;$@&quot;)&quot;</span><br><span class="line"></span><br><span class="line">                # skip empty values</span><br><span class="line">                if [ -z &quot;$dir&quot; ] || [ &quot;$dir&quot; = &#x27;NULL&#x27; ]; then</span><br><span class="line">                        continue</span><br><span class="line">                fi</span><br><span class="line">                case &quot;$conf&quot; in</span><br><span class="line">                        secure-file-priv)</span><br><span class="line">                                # already points at a directory</span><br><span class="line">                                ;;</span><br><span class="line">                        *)</span><br><span class="line">                                # other config options point at a file, but we need the directory</span><br><span class="line">                                dir=&quot;$(dirname &quot;$dir&quot;)&quot;</span><br><span class="line">                                ;;</span><br><span class="line">                esac</span><br><span class="line"></span><br><span class="line">                dirs[&quot;$dir&quot;]=1</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">        mkdir -p &quot;$&#123;!dirs[@]&#125;&quot;</span><br><span class="line"></span><br><span class="line">        if [ &quot;$user&quot; = &quot;0&quot; ]; then</span><br><span class="line">                # this will cause less disk access than `chown -R`</span><br><span class="line">                find &quot;$&#123;!dirs[@]&#125;&quot; \! -user mysql -exec chown --no-dereference mysql &#x27;&#123;&#125;&#x27; +</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="初始化数据库目录函数"><a href="#初始化数据库目录函数" class="headerlink" title="初始化数据库目录函数"></a>初始化数据库目录函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker_init_database_dir() &#123;</span><br><span class="line">        mysql_note &quot;Initializing database files&quot;</span><br><span class="line">        &quot;$@&quot; --initialize-insecure --default-time-zone=SYSTEM</span><br><span class="line">        mysql_note &quot;Database files initialized&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker_setup_env() &#123;</span><br><span class="line">        # Get config</span><br><span class="line">        declare -g DATADIR SOCKET</span><br><span class="line">        DATADIR=&quot;$(mysql_get_config &#x27;datadir&#x27; &quot;$@&quot;)&quot;</span><br><span class="line">        SOCKET=&quot;$(mysql_get_config &#x27;socket&#x27; &quot;$@&quot;)&quot;</span><br><span class="line"></span><br><span class="line">        # Initialize values that might be stored in a file</span><br><span class="line">        file_env &#x27;MYSQL_ROOT_HOST&#x27; &#x27;%&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_DATABASE&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_USER&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_PASSWORD&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_ROOT_PASSWORD&#x27;</span><br><span class="line"></span><br><span class="line">        declare -g DATABASE_ALREADY_EXISTS</span><br><span class="line">        if [ -d &quot;$DATADIR/mysql&quot; ]; then</span><br><span class="line">                DATABASE_ALREADY_EXISTS=&#x27;true&#x27;</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="执行SQL脚本函数"><a href="#执行SQL脚本函数" class="headerlink" title="执行SQL脚本函数"></a>执行SQL脚本函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker_process_sql() &#123;</span><br><span class="line">        passfileArgs=()</span><br><span class="line">        if [ &#x27;--dont-use-mysql-root-password&#x27; = &quot;$1&quot; ]; then</span><br><span class="line">                passfileArgs+=( &quot;$1&quot; )</span><br><span class="line">                shift</span><br><span class="line">        fi</span><br><span class="line">        # args sent in can override this db, since they will be later in the command</span><br><span class="line">        if [ -n &quot;$MYSQL_DATABASE&quot; ]; then</span><br><span class="line">                set -- --database=&quot;$MYSQL_DATABASE&quot; &quot;$@&quot;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        mysql --defaults-extra-file=&lt;( _mysql_passfile &quot;$&#123;passfileArgs[@]&#125;&quot;) --protocol=socket -uroot -hlocalhost --socket=&quot;$&#123;SOCKET&#125;&quot; --comments &quot;$@&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="初始化数据库函数"><a href="#初始化数据库函数" class="headerlink" title="初始化数据库函数"></a>初始化数据库函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">docker_setup_db() &#123;</span><br><span class="line">        # Load timezone info into database</span><br><span class="line">        if [ -z &quot;$MYSQL_INITDB_SKIP_TZINFO&quot; ]; then</span><br><span class="line">                # sed is for https://bugs.mysql.com/bug.php?id=20545</span><br><span class="line">                mysql_tzinfo_to_sql /usr/share/zoneinfo \</span><br><span class="line">                        | sed &#x27;s/Local time zone must be set--see zic manual page/FCTY/&#x27; \</span><br><span class="line">                        | docker_process_sql --dont-use-mysql-root-password --database=mysql</span><br><span class="line">                        # tell docker_process_sql to not use MYSQL_ROOT_PASSWORD since it is not set yet</span><br><span class="line">        fi</span><br><span class="line">        # Generate random root password</span><br><span class="line">        if [ -n &quot;$MYSQL_RANDOM_ROOT_PASSWORD&quot; ]; then</span><br><span class="line">                MYSQL_ROOT_PASSWORD=&quot;$(openssl rand -base64 24)&quot;; export MYSQL_ROOT_PASSWORD</span><br><span class="line">                mysql_note &quot;GENERATED ROOT PASSWORD: $MYSQL_ROOT_PASSWORD&quot;</span><br><span class="line">        fi</span><br><span class="line">        # Sets root password and creates root users for non-localhost hosts</span><br><span class="line">        local rootCreate=</span><br><span class="line">        # default root to listen for connections from anywhere</span><br><span class="line">        if [ -n &quot;$MYSQL_ROOT_HOST&quot; ] &amp;&amp; [ &quot;$MYSQL_ROOT_HOST&quot; != &#x27;localhost&#x27; ]; then</span><br><span class="line">                # no, we don&#x27;t care if read finds a terminating character in this heredoc</span><br><span class="line">                # https://unix.stackexchange.com/questions/265149/why-is-set-o-errexit-breaking-this-read-heredoc-expression/265151#265151</span><br><span class="line">                ## read -r -d &#x27;&#x27; rootCreate &lt;&lt;-EOSQL || true</span><br><span class="line">                        CREATE USER &#x27;root&#x27;@&#x27;$&#123;MYSQL_ROOT_HOST&#125;&#x27; IDENTIFIED BY &#x27;$&#123;MYSQL_ROOT_PASSWORD&#125;&#x27; ;</span><br><span class="line">                        GRANT ALL ON *.* TO &#x27;root&#x27;@&#x27;$&#123;MYSQL_ROOT_HOST&#125;&#x27; WITH GRANT OPTION ;</span><br><span class="line">                EOSQL</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        local passwordSet=</span><br><span class="line">        # no, we don&#x27;t care if read finds a terminating character in this heredoc (see above)</span><br><span class="line">        #read -r -d &#x27;&#x27; passwordSet &lt;&lt;-EOSQL || true</span><br><span class="line">                ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;$&#123;MYSQL_ROOT_PASSWORD&#125;&#x27; ;</span><br><span class="line">        EOSQL</span><br><span class="line"></span><br><span class="line">        # tell docker_process_sql to not use MYSQL_ROOT_PASSWORD since it is just now being set</span><br><span class="line">        docker_process_sql --dont-use-mysql-root-password --database=mysql &lt;&lt;-EOSQL</span><br><span class="line">                -- What&#x27;s done in this file shouldn&#x27;t be replicated</span><br><span class="line">                --  or products like mysql-fabric won&#x27;t work</span><br><span class="line">                SET @@SESSION.SQL_LOG_BIN=0;</span><br><span class="line"></span><br><span class="line">                $&#123;passwordSet&#125;</span><br><span class="line">                GRANT ALL ON *.* TO &#x27;root&#x27;@&#x27;localhost&#x27; WITH GRANT OPTION ;</span><br><span class="line">                FLUSH PRIVILEGES ;</span><br><span class="line">                $&#123;rootCreate&#125;</span><br><span class="line">                DROP DATABASE IF EXISTS test ;</span><br><span class="line">        EOSQL</span><br><span class="line"></span><br><span class="line">        # Creates a custom database and user if specified</span><br><span class="line">        if [ -n &quot;$MYSQL_DATABASE&quot; ]; then</span><br><span class="line">                mysql_note &quot;Creating database $&#123;MYSQL_DATABASE&#125;&quot;</span><br><span class="line">                docker_process_sql --database=mysql &lt;&lt;&lt;&quot;CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\` ;&quot;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        if [ -n &quot;$MYSQL_USER&quot; ] &amp;&amp; [ -n &quot;$MYSQL_PASSWORD&quot; ]; then</span><br><span class="line">                mysql_note &quot;Creating user $&#123;MYSQL_USER&#125;&quot;</span><br><span class="line">                docker_process_sql --database=mysql &lt;&lt;&lt;&quot;CREATE USER &#x27;$MYSQL_USER&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;$MYSQL_PASSWORD&#x27; ;&quot;</span><br><span class="line"></span><br><span class="line">                if [ -n &quot;$MYSQL_DATABASE&quot; ]; then</span><br><span class="line">                        mysql_note &quot;Giving user $&#123;MYSQL_USER&#125; access to schema $&#123;MYSQL_DATABASE&#125;&quot;</span><br><span class="line">                        docker_process_sql --database=mysql &lt;&lt;&lt;&quot;GRANT ALL ON \`$&#123;MYSQL_DATABASE//_/\\_&#125;\`.* TO &#x27;$MYSQL_USER&#x27;@&#x27;%&#x27; ;&quot;</span><br><span class="line">                fi</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="回显密码函数"><a href="#回显密码函数" class="headerlink" title="回显密码函数"></a>回显密码函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_mysql_passfile() &#123;</span><br><span class="line">        # echo the password to the &quot;file&quot; the client uses</span><br><span class="line">        # the client command will use process substitution to create a file on the fly</span><br><span class="line">        # ie: --defaults-extra-file=&lt;( _mysql_passfile )</span><br><span class="line">        if [ &#x27;--dont-use-mysql-root-password&#x27; != &quot;$1&quot; ] &amp;&amp; [ -n &quot;$MYSQL_ROOT_PASSWORD&quot; ]; then</span><br><span class="line">                ##cat &lt;&lt;-EOF</span><br><span class="line">                        [client]</span><br><span class="line">                        password=&quot;$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;</span><br><span class="line">                EOF</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="标志ROOT过期函数"><a href="#标志ROOT过期函数" class="headerlink" title="标志ROOT过期函数"></a>标志ROOT过期函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql_expire_root_user() &#123;</span><br><span class="line">        if [ -n &quot;$MYSQL_ONETIME_PASSWORD&quot; ]; then</span><br><span class="line">                ##docker_process_sql --database=mysql &lt;&lt;-EOSQL</span><br><span class="line">                        ALTER USER &#x27;root&#x27;@&#x27;%&#x27; PASSWORD EXPIRE;</span><br><span class="line">                EOSQL</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检查是否包含导进程停止的参数函数"><a href="#检查是否包含导进程停止的参数函数" class="headerlink" title="检查是否包含导进程停止的参数函数"></a>检查是否包含导进程停止的参数函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_mysql_want_help() &#123;</span><br><span class="line">        local arg</span><br><span class="line">        for arg; do</span><br><span class="line">                case &quot;$arg&quot; in</span><br><span class="line">                        -&#x27;?&#x27;|--help|--print-defaults|-V|--version)</span><br><span class="line">                                return 0</span><br><span class="line">                                ;;</span><br><span class="line">                esac</span><br><span class="line">        done</span><br><span class="line">        return 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">_main() &#123;</span><br><span class="line">        # if command starts with an option, prepend mysqld</span><br><span class="line">        if [ &quot;$&#123;1:0:1&#125;&quot; = &#x27;-&#x27; ]; then</span><br><span class="line">                set -- mysqld &quot;$@&quot;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # skip setup if they aren&#x27;t running mysqld or want an option that stops mysqld</span><br><span class="line">        if [ &quot;$1&quot; = &#x27;mysqld&#x27; ] &amp;&amp; ! _mysql_want_help &quot;$@&quot;; then</span><br><span class="line">                mysql_note &quot;Entrypoint script for MySQL Server $&#123;MYSQL_VERSION&#125; started.&quot;</span><br><span class="line"></span><br><span class="line">                mysql_check_config &quot;$@&quot;</span><br><span class="line">                # Load various environment variables</span><br><span class="line">                docker_setup_env &quot;$@&quot;</span><br><span class="line">                docker_create_db_directories &quot;$@&quot;</span><br><span class="line"></span><br><span class="line">                # If container is started as root user, restart as dedicated mysql user</span><br><span class="line">                if [ &quot;$(id -u)&quot; = &quot;0&quot; ]; then</span><br><span class="line">                        mysql_note &quot;Switching to dedicated user &#x27;mysql&#x27;&quot;</span><br><span class="line">                        exec gosu mysql &quot;$BASH_SOURCE&quot; &quot;$@&quot;</span><br><span class="line">                fi</span><br><span class="line"></span><br><span class="line">                # there&#x27;s no database, so it needs to be initialized</span><br><span class="line">                if [ -z &quot;$DATABASE_ALREADY_EXISTS&quot; ]; then</span><br><span class="line">                        docker_verify_minimum_env</span><br><span class="line"></span><br><span class="line">                        # check dir permissions to reduce likelihood of half-initialized database</span><br><span class="line">                        ls /docker-entrypoint-initdb.d/ &gt; /dev/null</span><br><span class="line"></span><br><span class="line">                        docker_init_database_dir &quot;$@&quot;</span><br><span class="line"></span><br><span class="line">                        mysql_note &quot;Starting temporary server&quot;</span><br><span class="line">                        docker_temp_server_start &quot;$@&quot;</span><br><span class="line">                        mysql_note &quot;Temporary server started.&quot;</span><br><span class="line"></span><br><span class="line">                        mysql_socket_fix</span><br><span class="line">                        docker_setup_db</span><br><span class="line">                        docker_process_init_files /docker-entrypoint-initdb.d/*</span><br><span class="line"></span><br><span class="line">                        mysql_expire_root_user</span><br><span class="line"></span><br><span class="line">                        mysql_note &quot;Stopping temporary server&quot;</span><br><span class="line">                        docker_temp_server_stop</span><br><span class="line">                        mysql_note &quot;Temporary server stopped&quot;</span><br><span class="line"></span><br><span class="line">                        echo</span><br><span class="line">                        mysql_note &quot;MySQL init process done. Ready for start up.&quot;</span><br><span class="line">                        echo</span><br><span class="line">                else</span><br><span class="line">                        mysql_socket_fix</span><br><span class="line">                fi</span><br><span class="line">        fi</span><br><span class="line">        exec &quot;$@&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ! _is_sourced; then</span><br><span class="line">        _main &quot;$@&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="分析脚本"><a href="#分析脚本" class="headerlink" title="分析脚本"></a>分析脚本</h1><h2 id="判断脚本的运行方式"><a href="#判断脚本的运行方式" class="headerlink" title="判断脚本的运行方式"></a>判断脚本的运行方式</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ! _is_sourced; then# _is_sourced为假则开始运行主函数</span><br><span class="line">        _main &quot;$@&quot;   # 进入主函数并携带所有的参数</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_is_sourced() &#123;</span><br><span class="line">        [ &quot;$&#123;#FUNCNAME[@]&#125;&quot; -ge 2 ] \</span><br><span class="line">                &amp;&amp; [ &quot;$&#123;FUNCNAME[0]&#125;&quot; = &#x27;_is_sourced&#x27; ] \</span><br><span class="line">                &amp;&amp; [ &quot;$&#123;FUNCNAME[1]&#125;&quot; = &#x27;source&#x27; ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">FUNCNAME表示函数的名字，它是一个数组变量，其中包含了整个调用链上所有的函数的名字，故变量<span class="variable">$&#123;FUNCNAME[0]&#125;</span>代表shell脚本当前正在执行的函数的名字，而变量<span class="variable">$&#123;FUNCNAME[1]&#125;</span>则代表调用函数<span class="variable">$&#123;FUNCNAME[0]&#125;</span>的函数的名字，依此类推。</span></span><br><span class="line"></span><br><span class="line">如果是./执行则函数为假执行_main函数，如果是source则为真不执行_main</span><br></pre></td></tr></table></figure><h2 id="进入主函数"><a href="#进入主函数" class="headerlink" title="进入主函数"></a>进入主函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">_main() &#123;</span><br><span class="line">        # 判断CMD提供的命令是否是mysqld -xxx -xxx的形式   $&#123;1:0:1&#125;即第二个字符串的第一个字符是否是-；如果是就执行CMD给定的参数</span><br><span class="line">        if [ &quot;$&#123;1:0:1&#125;&quot; = &#x27;-&#x27; ]; then   </span><br><span class="line">                set -- mysqld &quot;$@&quot;# $@表示所有参数  </span><br><span class="line">                # set -- 后无内容，将当前 shell 脚本的参数置空，$1 $? $@ 等都为空。</span><br><span class="line"># set -- 后有内容，当前 shell 脚本的参数被替换为 set -- 后的内容，$1 $? $@ 等相应地被改变。</span><br><span class="line">        fi</span><br><span class="line">   </span><br><span class="line">        # 判断第一个参数是否为mysqld并且将所有参数传递给_mysql_want_help函数,跳到_mysql_want_help函数</span><br><span class="line">        if [ &quot;$1&quot; = &#x27;mysqld&#x27; ] &amp;&amp; ! _mysql_want_help &quot;$@&quot;; then    </span><br><span class="line">                mysql_note &quot;Entrypoint script for MySQL Server $&#123;MYSQL_VERSION&#125; started.&quot;</span><br><span class="line"># 将信息传到日志函数</span><br><span class="line"></span><br><span class="line">                mysql_check_config &quot;$@&quot;</span><br><span class="line">                # 检查配置</span><br><span class="line">                </span><br><span class="line">                docker_setup_env &quot;$@&quot;</span><br><span class="line">                # 将传入的值作为环境变量</span><br><span class="line">                </span><br><span class="line">                docker_create_db_directories &quot;$@&quot;</span><br><span class="line"># 创建数据库目录</span><br><span class="line"></span><br><span class="line">                # 判断用户是否为root得切换mysql用户启动</span><br><span class="line">                if [ &quot;$(id -u)&quot; = &quot;0&quot; ]; then</span><br><span class="line">                        mysql_note &quot;Switching to dedicated user &#x27;mysql&#x27;&quot;</span><br><span class="line">                        exec gosu mysql &quot;$BASH_SOURCE&quot; &quot;$@&quot;</span><br><span class="line">                fi</span><br><span class="line"></span><br><span class="line">                # 在环境变量函数中就判断数据目录是否存在   -z判断变量是否为空，如果是空就执行下面的初始化过程</span><br><span class="line">                if [ -z &quot;$DATABASE_ALREADY_EXISTS&quot; ]; then</span><br><span class="line">                        docker_verify_minimum_env</span><br><span class="line"></span><br><span class="line">                        # check dir permissions to reduce likelihood of half-initialized database</span><br><span class="line">                        ls /docker-entrypoint-initdb.d/ &gt; /dev/null</span><br><span class="line"></span><br><span class="line">                        docker_init_database_dir &quot;$@&quot;</span><br><span class="line"></span><br><span class="line">                        mysql_note &quot;Starting temporary server&quot;</span><br><span class="line">                        docker_temp_server_start &quot;$@&quot;</span><br><span class="line">                        mysql_note &quot;Temporary server started.&quot;</span><br><span class="line"></span><br><span class="line">                        mysql_socket_fix</span><br><span class="line">                        docker_setup_db</span><br><span class="line">                        docker_process_init_files /docker-entrypoint-initdb.d/*</span><br><span class="line"></span><br><span class="line">                        mysql_expire_root_user</span><br><span class="line"></span><br><span class="line">                        mysql_note &quot;Stopping temporary server&quot;</span><br><span class="line">                        docker_temp_server_stop</span><br><span class="line">                        mysql_note &quot;Temporary server stopped&quot;</span><br><span class="line"></span><br><span class="line">                        echo</span><br><span class="line">                        mysql_note &quot;MySQL init process done. Ready for start up.&quot;</span><br><span class="line">                        echo</span><br><span class="line">                else</span><br><span class="line">                        mysql_socket_fix</span><br><span class="line">                fi</span><br><span class="line">        fi</span><br><span class="line">        exec &quot;$@&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检查是否包含导进程停止的参数函数-1"><a href="#检查是否包含导进程停止的参数函数-1" class="headerlink" title="检查是否包含导进程停止的参数函数"></a>检查是否包含导进程停止的参数函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_mysql_want_help() &#123;</span><br><span class="line">        local arg# 将传递进来的变量作为局部变量arg</span><br><span class="line">        for arg; do</span><br><span class="line">                case &quot;$arg&quot; in# 判断变量(参数)是否包含如下选项是这返回0否则返回1</span><br><span class="line">                        -&#x27;?&#x27;|--help|--print-defaults|-V|--version)</span><br><span class="line">                                return 0</span><br><span class="line">                                ;;</span><br><span class="line">                esac</span><br><span class="line">        done</span><br><span class="line">        return 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="记录日志函数"><a href="#记录日志函数" class="headerlink" title="记录日志函数"></a>记录日志函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql_note() &#123;</span><br><span class="line">        mysql_log Note &quot;$@&quot;# 将传入的值进行记录</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检查配置函数"><a href="#检查配置函数" class="headerlink" title="检查配置函数"></a>检查配置函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql_check_config() &#123;</span><br><span class="line">        local toRun=( &quot;$@&quot; &quot;$&#123;_verboseHelpArgs[@]&#125;&quot; ) errors</span><br><span class="line">        if ! errors=&quot;$(&quot;$&#123;toRun[@]&#125;&quot; 2&gt;&amp;1 &gt;/dev/null)&quot;; then</span><br><span class="line">                mysql_error $&#x27;mysqld failed while attempting to check config\n\tcommand was: &#x27;&quot;$&#123;toRun[*]&#125;&quot;$&#x27;\n\t&#x27;&quot;$errors&quot;</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="设置环境变量函数"><a href="#设置环境变量函数" class="headerlink" title="设置环境变量函数"></a>设置环境变量函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker_setup_env() &#123;</span><br><span class="line">        # Get config</span><br><span class="line">        declare -g DATADIR SOCKET</span><br><span class="line">        DATADIR=&quot;$(mysql_get_config &#x27;datadir&#x27; &quot;$@&quot;)&quot;</span><br><span class="line">        SOCKET=&quot;$(mysql_get_config &#x27;socket&#x27; &quot;$@&quot;)&quot;</span><br><span class="line"></span><br><span class="line">        # Initialize values that might be stored in a file</span><br><span class="line">        file_env &#x27;MYSQL_ROOT_HOST&#x27; &#x27;%&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_DATABASE&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_USER&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_PASSWORD&#x27;</span><br><span class="line">        file_env &#x27;MYSQL_ROOT_PASSWORD&#x27;</span><br><span class="line"></span><br><span class="line">        declare -g DATABASE_ALREADY_EXISTS</span><br><span class="line">        if [ -d &quot;$DATADIR/mysql&quot; ]; then# 判断数据目录是否存在</span><br><span class="line">                DATABASE_ALREADY_EXISTS=&#x27;true&#x27;</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="创建数据库目录函数"><a href="#创建数据库目录函数" class="headerlink" title="创建数据库目录函数"></a>创建数据库目录函数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">docker_create_db_directories() &#123;</span><br><span class="line">        local user; user=&quot;$(id -u)&quot;</span><br><span class="line"></span><br><span class="line">        local -A dirs=( [&quot;$DATADIR&quot;]=1 )</span><br><span class="line">        local dir</span><br><span class="line">        dir=&quot;$(dirname &quot;$SOCKET&quot;)&quot;</span><br><span class="line">        dirs[&quot;$dir&quot;]=1</span><br><span class="line"></span><br><span class="line">        # &quot;datadir&quot; and &quot;socket&quot; are already handled above (since they were already queried previously)</span><br><span class="line">        local conf</span><br><span class="line">        for conf in \</span><br><span class="line">                general-log-file \</span><br><span class="line">                keyring_file_data \</span><br><span class="line">                pid-file \</span><br><span class="line">                secure-file-priv \</span><br><span class="line">                slow-query-log-file \</span><br><span class="line">        ; do</span><br><span class="line">                dir=&quot;$(mysql_get_config &quot;$conf&quot; &quot;$@&quot;)&quot;</span><br><span class="line"></span><br><span class="line">                # skip empty values</span><br><span class="line">                if [ -z &quot;$dir&quot; ] || [ &quot;$dir&quot; = &#x27;NULL&#x27; ]; then</span><br><span class="line">                        continue</span><br><span class="line">                fi</span><br><span class="line">                case &quot;$conf&quot; in</span><br><span class="line">                        secure-file-priv)</span><br><span class="line">                                # already points at a directory</span><br><span class="line">                                ;;</span><br><span class="line">                        *)</span><br><span class="line">                                # other config options point at a file, but we need the directory</span><br><span class="line">                                dir=&quot;$(dirname &quot;$dir&quot;)&quot;</span><br><span class="line">                                ;;</span><br><span class="line">                esac</span><br><span class="line"></span><br><span class="line">                dirs[&quot;$dir&quot;]=1</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">        mkdir -p &quot;$&#123;!dirs[@]&#125;&quot;</span><br><span class="line"></span><br><span class="line">        if [ &quot;$user&quot; = &quot;0&quot; ]; then</span><br><span class="line">                # this will cause less disk access than `chown -R`</span><br><span class="line">                find &quot;$&#123;!dirs[@]&#125;&quot; \! -user mysql -exec chown --no-dereference mysql &#x27;&#123;&#125;&#x27; +</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>个人生成的Docker镜像</title>
      <link href="/archives/736ef7f1.html"/>
      <url>/archives/736ef7f1.html</url>
      
        <content type="html"><![CDATA[<h1 id="LNMP"><a href="#LNMP" class="headerlink" title="LNMP"></a>LNMP</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">centos:centos7.9.2009</span></span><br><span class="line"></span><br><span class="line"><span class="string">MAINTAINER</span> <span class="string">xiaowangc&lt;780312916@qq.com&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">my.cnf</span> <span class="string">/etc/my.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/yum.repos.d/*</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">curl</span> <span class="string">-o</span> <span class="string">/etc/yum.repos.d/CentOS-Base.repo</span> <span class="string">http://mirrors.cloud.tencent.com/repo/centos7_base.repo</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">yum</span> <span class="string">makecache</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">gcc</span> <span class="string">gcc-c++</span> <span class="string">make</span> <span class="string">libpng-devel</span> <span class="string">automake</span> <span class="string">autoconf</span> <span class="string">glibc</span> <span class="string">wget</span> <span class="string">prce</span> <span class="string">pcre-devel</span> <span class="string">openssl</span> <span class="string">openssl-devel</span> <span class="string">numactl</span> <span class="string">libaio</span> <span class="string">libxml2</span> <span class="string">libxml2-devel</span> <span class="string">sqlite-devel</span> <span class="string">libcurl</span> <span class="string">libcurl-devel</span> <span class="string">ncurses-devel&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">yum</span> <span class="string">clean</span> <span class="string">all</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mkdir</span> <span class="string">/lnmp</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/lnmp</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">wget</span> <span class="string">https://nginx.org/download/nginx-1.22.1.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">xf</span> <span class="string">nginx-1.22.1.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-rf</span> <span class="string">nginx-1.22.1.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">useradd</span> <span class="string">nginx</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">nginx-1.22.1/</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">./configure</span> <span class="string">--prefix=/lnmp/nginx</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--user=nginx</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--group=nginx</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-compat</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-file-aio</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-threads</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_addition_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_auth_request_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_dav_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_flv_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_gunzip_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_gzip_static_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_mp4_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_random_index_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_realip_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_secure_link_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_slice_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_ssl_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_stub_status_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_sub_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-http_v2_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-mail</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-mail_ssl_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-stream</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-stream_realip_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-stream_ssl_module</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-stream_ssl_preread_module</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">/lnmp/</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">nginx-1.22.1</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">chown</span> <span class="string">-R</span> <span class="string">nginx.nginx</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">wget</span> <span class="string">--no-check-certificate</span> <span class="string">https://vpn.xiaowangc.com/cmake-3.25.0-rc3-linux-x86_64.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">xf</span> <span class="string">cmake-3.25.0-rc3-linux-x86_64.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">cmake-3.25.0-rc3-linux-x86_64.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">cmake-3.25.0-rc3-linux-x86_64</span> <span class="string">cmake</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">wget</span> <span class="string">--no-check-certificate</span> <span class="string">https://libzip.org/download/libzip-1.9.2.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">xf</span> <span class="string">libzip-1.9.2.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">libzip-1.9.2</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mkdir</span> <span class="string">build</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">build</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">/lnmp/cmake/bin/cmake</span> <span class="string">..</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">../../</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">libzip-1.9.2</span> <span class="string">libzip-1.9.2.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-rf</span> <span class="string">cmake</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENV</span> <span class="string">PKG_CONFIG_PATH</span> <span class="string">/usr/local/lib64/pkgconfig</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">cd</span> <span class="string">/lnmp</span> <span class="string">&amp;&amp;</span> <span class="string">wget</span> <span class="string">https://www.php.net/distributions/php-7.4.33.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">xf</span> <span class="string">php-7.4.33.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-rf</span> <span class="string">php-7.4.33.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">php-7.4.33</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">./configure</span> <span class="string">--prefix=/lnmp/php</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-config-file-path=/lnmp/php7/etc</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-config-file-scan-dir=/lnmp/php/etc/php.d</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-mysqlnd</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-mysqli</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-pdo-mysql</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-fpm</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-fpm-user=nginx</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-fpm-group=nginx</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-gd</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-iconv</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-zlib</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-xml</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-shmop</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-sysvsem</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-inline-optimization</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-mbregex</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-mbstring</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--disable-mbregex</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-ftp</span> <span class="string">\--with-openssl</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-pcntl</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-sockets</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-xmlrpc</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--without-pear</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--disable-phar</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-zip</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-soap</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--without-pear</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-gettext</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-session</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--with-curl</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-bcmath</span> <span class="string">\</span></span><br><span class="line">    <span class="string">--enable-opcache</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">/lnmp</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">php-7.4.33</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cp</span> <span class="string">php/etc/php-fpm.conf.default</span> <span class="string">php/etc/php-fpm.conf</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cp</span> <span class="string">php/etc/php-fpm.d/www.conf.default</span> <span class="string">php/etc/php-fpm.d/www.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">nginx.conf</span> <span class="string">/lnmp/nginx/conf/nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">wget</span> <span class="string">--no-check-certificate</span> <span class="string">https://vpn.xiaowangc.com/cmake-3.25.0-rc3-linux-x86_64.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">xf</span> <span class="string">cmake-3.25.0-rc3-linux-x86_64.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">cmake-3.25.0-rc3-linux-x86_64.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">cmake-3.25.0-rc3-linux-x86_64</span> <span class="string">cmake</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">wget</span> <span class="string">https://downloads.mysql.com/archives/get/p/23/file/mysql-boost-5.7.39.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">xf</span> <span class="string">mysql-boost-5.7.39.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-rf</span> <span class="string">mysql-boost-5.7.39.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">mysql-5.7.39</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">useradd</span> <span class="string">mysql</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">/lnmp/cmake/bin/cmake</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DCMAKE_INSTALL_PREFIX=/lnmp/mysql</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DMYSQL_DATADIR=/var/lib/mysql</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DMYSQL_UNIX_ADDR=/var/lib/mysql/mysql.sock</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DWITH_INNOBASE_STORAGE_ENGINE=1</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DSYSCONFDIR=/etc</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DENABLED_LOCAL_INFILE=1</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DWITH_EXTRA_CHARSETS=all</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DDEFAULT_CHARSET=utf8mb4</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DDEFAULT_COLLATION=utf8mb4_unicode_ci</span> <span class="string">\</span></span><br><span class="line">    <span class="string">-DWITH_BOOST=/lnmp/mysql-5.7.39/boost/boost_1_59_0</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">..</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">mysql-5.7.39</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mkdir</span> <span class="string">/var/lib/mysql</span> <span class="string">&amp;&amp;</span> <span class="string">chown</span> <span class="string">-R</span> <span class="string">mysql.mysql</span> <span class="string">/var/lib/mysql</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">/lnmp</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">cmake</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENV</span> <span class="string">PATH</span> <span class="string">$PATH:/lnmp/nginx/sbin:/lnmp/php/sbin:/lnmp/mysql/bin:/lnmp/mysql/support-files</span></span><br><span class="line"></span><br><span class="line"><span class="string">VOLUME</span> [<span class="string">&quot;/lnmp/nginx/html&quot;</span>,<span class="string">&quot;/var/lib/mysql&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">EXPOSE</span> <span class="number">80</span> <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">docker-entrypoint.sh</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="number">777</span> <span class="string">/docker-entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENTRYPOINT</span> [<span class="string">&quot;/docker-entrypoint.sh&quot;</span>]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 容器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis单机数据迁移</title>
      <link href="/archives/b37d654d.html"/>
      <url>/archives/b37d654d.html</url>
      
        <content type="html"><![CDATA[<h1 id="Redis单机数据持久化迁移"><a href="#Redis单机数据持久化迁移" class="headerlink" title="Redis单机数据持久化迁移"></a>Redis单机数据持久化迁移</h1><p><img src="/archives/b37d654d/redis-boot.png" alt="redis-boot"><br><strong>注意RDB和AOF加载流程</strong><br>停止 Redis，关闭 AOF 持久化，保留 RDB 持久化，防止启动时生成 appendonly.aof 文件；<br>拷贝 RDB 文件到数据目录，启动 Redis，启动后 Redis 会使用 RDB 文件恢复数据；<br>确认数据恢复，在命令行热修改配置开启 AOF 持久化 config set appendonly yes；<br>等待 Redis 将内存中的数据写入 appendonly.aof 文件，此时 RDB 和 AOF 数据已同步；<br>停止 Redis，修改配置文件开启 AOF 持久化和 RDB 持久化；<br>启动 Redis，数据恢复和持久化配置完成。</p>]]></content>
      
      
      <categories>
          
          <category> NoSQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> NoSQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LVM实现数据一致性备份迁移</title>
      <link href="/archives/e54f90b7.html"/>
      <url>/archives/e54f90b7.html</url>
      
        <content type="html"><![CDATA[<h1 id="LVM介绍"><a href="#LVM介绍" class="headerlink" title="LVM介绍"></a>LVM介绍</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>算了，主要也不是讲LVM的操作，不介绍了….</p><h2 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h2><p>LVM快照机制，基于写时复制技术实现对数据进行备份&#x2F;镜像，这比传统的备份技术效率要高，创建快照无需停止服务即可对数据进行备份&#x2F;镜像</p><p>一般情况下，不停止服务或停机的情况下对数据进行备份，由于不停机整个数据块的内容是时时变化的，那么数据是存在不一致性的。<strong>不一致的数据备份没有任何价值</strong>，目前在LVM2中引入了基于软件实现快照的技术，几乎是零成本，但效果明显；</p><p>LVM快照是基于存储级别而不是文件级别，由于采用CoW技术，所以创建逻辑卷的快照时间几乎为0，这可以保证快照数据一致性至关重要，此时系统总存在两份数据，一份是源数据，一份是快照数据</p><h1 id="COW"><a href="#COW" class="headerlink" title="COW"></a>COW</h1><p><strong>Copy-on-Write(COW)，写时复制技术</strong></p><p>当LVM创建快照的一瞬间，系统会记录那个时间点LV的数据块和状态等信息。当快照创建之后没有发生数据的修改，源数据和快照数据是共享的，也就是此时此刻的数据在存储中只有一份。当进程对文件进行增&#x2F;改&#x2F;删操作时，系统会先把原来的数据块Copy到快照中，然后再写入源数据块。此后再对这个已经修改的源数据块进行修改就不用再Copy到快照中！</p><p><img src="/archives/e54f90b7/image-20221018174341086.png" alt="image-20221018174341086"></p><h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p><code>保证快照LV大小要与源LV大小一致</code> </p><p><code>只能在同过一个VG中创建快照</code></p><ol><li><p>添加一块硬盘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# lsblk</span><br><span class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0          11:0    1  9.3G  0 rom</span><br><span class="line">nvme0n1     259:0    0   20G  0 disk</span><br><span class="line">├─nvme0n1p1 259:1    0    1G  0 part /boot</span><br><span class="line">└─nvme0n1p2 259:2    0   19G  0 part</span><br><span class="line">  ├─cl-root 253:0    0   17G  0 lvm  /</span><br><span class="line">  └─cl-swap 253:1    0    2G  0 lvm  [SWAP]</span><br><span class="line">nvme0n2     259:3    0   20G  0 disk# 此硬盘是新添加的</span><br></pre></td></tr></table></figure></li><li><p>创建PV</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# pvcreate /dev/nvme0n2</span><br><span class="line">  Physical volume &quot;/dev/nvme0n2&quot; successfully created.</span><br></pre></td></tr></table></figure></li><li><p>创建VG</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# vgcreate data /dev/nvme0n2</span><br><span class="line">  Volume group &quot;data&quot; successfully created</span><br></pre></td></tr></table></figure></li><li><p>创建LV</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# lvcreate -L +2G -n web data</span><br><span class="line">  Logical volume &quot;web&quot; created.</span><br></pre></td></tr></table></figure></li><li><p>格式化LV</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# mkfs.ext4 /dev/mapper/data-web</span><br><span class="line">mke2fs 1.45.6 (20-Mar-2020)</span><br><span class="line">Creating filesystem with 524288 4k blocks and 131072 inodes</span><br><span class="line">Filesystem UUID: dc410526-15dd-4e8e-81ea-7b106b1ae656</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">        32768, 98304, 163840, 229376, 294912</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Creating journal (16384 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br></pre></td></tr></table></figure></li><li><p>挂载LV</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# mkdir /web_data</span><br><span class="line">[root@xiaowangc ~]# mount /dev/mapper/data-web /web_data/</span><br><span class="line">[root@xiaowangc ~]# blkid</span><br><span class="line">/dev/nvme0n1: PTUUID=&quot;6d0cc3a7&quot; PTTYPE=&quot;dos&quot;</span><br><span class="line">/dev/nvme0n1p1: UUID=&quot;dc078753-6fab-4c5a-8159-3b8574e695ba&quot; BLOCK_SIZE=&quot;512&quot; TYPE=&quot;xfs&quot; PARTUUID=&quot;6d0cc3a7-01&quot;</span><br><span class="line">/dev/nvme0n1p2: UUID=&quot;v7zY6z-be09-lpfv-M30s-zq74-pcdn-inhNdV&quot; TYPE=&quot;LVM2_member&quot; PARTUUID=&quot;6d0cc3a7-02&quot;</span><br><span class="line">/dev/nvme0n2: UUID=&quot;sjdx2e-xE43-tcfL-n68g-qMpe-ayqZ-SDoWma&quot; TYPE=&quot;LVM2_member&quot;</span><br><span class="line">/dev/sr0: BLOCK_SIZE=&quot;2048&quot; UUID=&quot;2021-06-01-20-39-18-00&quot; LABEL=&quot;CentOS-8-4-2105-x86_64-dvd&quot; TYPE=&quot;iso9660&quot; PTUUID=&quot;44956b46&quot; PTTYPE=&quot;dos&quot;</span><br><span class="line">/dev/mapper/cl-root: UUID=&quot;a9c18d43-b830-4b9e-b81f-54fcb5a722e9&quot; BLOCK_SIZE=&quot;512&quot; TYPE=&quot;xfs&quot;</span><br><span class="line">/dev/mapper/cl-swap: UUID=&quot;9306acb9-f748-4d55-a7a7-b127b7c9de7b&quot; TYPE=&quot;swap&quot;</span><br><span class="line">/dev/mapper/data-web: UUID=&quot;dc410526-15dd-4e8e-81ea-7b106b1ae656&quot; BLOCK_SIZE=&quot;4096&quot; TYPE=&quot;ext4&quot;</span><br><span class="line">[root@xiaowangc ~]# echo &#x27;UUID=dc410526-15dd-4e8e-81ea-7b106b1ae656 /web_data ext4 defaults 0 0&#x27; &gt;&gt; /etc/fstab</span><br></pre></td></tr></table></figure></li><li><p>写入数据测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# vi w_file.sh</span><br><span class="line">/bin/bash</span><br><span class="line">for i in &#123;1..1000000000000000&#125;;</span><br><span class="line">do</span><br><span class="line">  sleep 0.1</span><br><span class="line">  touch /web_data/file_$i</span><br><span class="line">done</span><br><span class="line">[root@xiaowangc ~]# nohup bash w_file.sh &amp;</span><br><span class="line">[1] 1960</span><br><span class="line">nohup: ignoring input and appending output to &#x27;nohup.out&#x27;</span><br><span class="line">[root@xiaowangc ~]# ls /web_data/</span><br><span class="line">file_1    file_113  file_128  file_142  file_157  file_171  file_186  file_28  file_42  file_57  file_71  file_86</span><br><span class="line">file_10   file_114  file_129  file_143  file_158  file_172  file_187  file_29  file_43  file_58  file_72  file_87</span><br><span class="line">file_100  file_115  file_13   file_144  file_159  file_173  file_188  file_3   file_44  file_59  file_73  file_88</span><br><span class="line">file_101  file_116  file_130  file_145  file_16   file_174  file_189  file_30  file_45  file_6   file_74  file_89</span><br><span class="line">file_102  file_117  file_131  file_146  file_160  file_175  file_19   file_31  file_46  file_60  file_75  file_9</span><br><span class="line">file_103  file_118  file_132  file_147  file_161  file_176  file_190  file_32  file_47  file_61  file_76  file_90</span><br></pre></td></tr></table></figure></li><li><p>对LV创建快照</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# [root@xiaowangc ~]# lvcreate -n web_data_bak -s -L 2G /dev/mapper/data-web</span><br><span class="line">  Logical volume &quot;web_data_bak&quot; created.</span><br><span class="line">[root@xiaowangc ~]# lvs</span><br><span class="line">  LV           VG   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  root         cl   -wi-ao---- &lt;17.00g</span><br><span class="line">  swap         cl   -wi-ao----   2.00g</span><br><span class="line">  web          data owi-aos---   2.00g</span><br><span class="line">  web_data_bak data swi-a-s---   2.00g      web    0.03# 瞬间进行快照</span><br></pre></td></tr></table></figure></li><li><p>查看快照</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# mount /dev/mapper/data-web_data_bak /root/test/</span><br><span class="line">[root@xiaowangc ~]# cd test/</span><br><span class="line">[root@xiaowangc test]# ls</span><br><span class="line">file_1                        file_1249  file_150   file_1751  file_2001  file_2253  file_2504  file_499  file_75</span><br><span class="line">file_10                       file_125   file_1500  file_1752  file_2002  file_2254  file_2505  file_5    file_750</span><br><span class="line">file_100                      file_1250  file_1501  file_1753  file_2003  file_2255  file_2506  file_50   file_751</span><br><span class="line">file_1000                     file_1251  file_1502  file_1754  file_2004  file_2256  file_2507  file_500  file_752</span><br><span class="line">file_1001                     file_1252  file_1503  file_1755  file_2005  file_2257  file_2508  file_501  file_753</span><br></pre></td></tr></table></figure></li><li><p>对比数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc test]# df -h</span><br><span class="line">Filesystem                     Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                       1.8G     0  1.8G   0% /dev</span><br><span class="line">tmpfs                          1.9G     0  1.9G   0% /dev/shm</span><br><span class="line">tmpfs                          1.9G  9.0M  1.9G   1% /run</span><br><span class="line">tmpfs                          1.9G     0  1.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/cl-root             17G  2.8G   15G  17% /</span><br><span class="line">/dev/nvme0n1p1                1014M  197M  818M  20% /boot</span><br><span class="line">tmpfs                          371M     0  371M   0% /run/user/0</span><br><span class="line">/dev/mapper/data-web           2.0G  6.3M  1.8G   1% /web_data</span><br><span class="line">/dev/mapper/data-web_data_bak  2.0G  6.1M  1.8G   1% /root/test</span><br><span class="line">[root@xiaowangc test]# pwd</span><br><span class="line">/root/test</span><br><span class="line">[root@xiaowangc test]# ls | wc -l</span><br><span class="line">2511</span><br><span class="line">[root@xiaowangc test]# ls /web_data/ | wc -l</span><br><span class="line">7031</span><br></pre></td></tr></table></figure></li><li><p>对数据进行打包备份</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc test]# tar zcvf /root/web_backup.tar.gz *</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 备份 </tag>
            
            <tag> LVM </tag>
            
            <tag> 数据一致性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux基于legacy(BIOS)引导过程</title>
      <link href="/archives/993b501c.html"/>
      <url>/archives/993b501c.html</url>
      
        <content type="html"><![CDATA[<h1 id="引导过程"><a href="#引导过程" class="headerlink" title="引导过程"></a>引导过程</h1><p>开机自检(BISO初始化以及自检)——&gt;MBR引导——&gt;GRUB菜单——&gt;加载内核Kernel——&gt;init进程初始化<br><img src="/archives/993b501c/boot.png" alt="boot"></p><ol><li><p>开机自检</p><p>主机开机之后根据BIOS中的设置对CPU、内存、显卡、键鼠标等设备进行初步检测，检测成功后根据预设的磁盘引导顺序移交系统控制权。(检测设备以及检测出能够引导系统的设备)</p></li><li><p>MBR引导</p><p>当从本地存储设备中启动系统时，首先根据硬盘第一个扇区(512B,常见大小)中的MBR(<code>主引导记录</code>)的设置，将系统控制权传递给包含操作系统引导文件的分区；或者直接根据MBR记录的引导信息调用启动菜单如<code>GRUB</code></p></li><li><p>GRUB菜单</p><p>对于Linux操作系统来说，GRUB是使用最广泛的多系统引导器程序。系统控制器权传递给GRUB以后，将会显示启动菜单给用户选择，并根据所选项(或采用默认值)加载Linux内核文件，然后将系统控制权转交给内核(CentOS7采用的是GRUB2启动引导器，通过读取GRUB的配置文件，获取内核和镜像文件系统的设置和路径位置)</p></li><li><p>加载内核</p><p>Linux内核是一个预先编译好的特殊二进制文件，介于各种硬件资源与系统程序之间，负责资源分配与调度。内核接过系统控制权以后，将会完全掌控整个Linux操作系统的运行过程(此时将内核和镜像文件系统加载到内存中)</p></li><li><p>init进程初始化(Systemd)</p><blockquote><p>在CentOS7以前是采用init，7以后采用Systemd</p></blockquote><p>Linux内核首先将系统中的&#x2F;sbin&#x2F;init程序加载到内存中运行，init进程负责完成整个系统的初始化，最后等待用户登录(内核把init进程加载到内存中运行，并加载硬件驱动以及运行一些开机自启的程序)</p><p>init进程是系统中的第一个进程PID为1</p><p>Systemd在CentOS7取代了init，成为内核第一个加载的程序，PID为1的初始化进程</p></li></ol><p><strong>UEFI过程</strong></p><p><code>UEFI仅支持64系统以及GPT磁盘分区</code></p><p>UEFI初始化(硬件自检)——&gt;加载GRUB&#x2F;加载内核——&gt;init&#x2F;systemd</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlab更改分支克隆中的URL地址</title>
      <link href="/archives/d46e7f9b.html"/>
      <url>/archives/d46e7f9b.html</url>
      
        <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# vi /opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml</span><br><span class="line">...</span><br><span class="line">production: &amp;base</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">  <span class="comment"># 1. GitLab app settings</span></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">==========================</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment"># GitLab settings</span></span></span><br><span class="line">  gitlab:</span><br><span class="line">    ## Web server settings (note: host is the FQDN, do not include http://)</span><br><span class="line">    host: gitlab.local.com</span><br><span class="line">    port: 80</span><br><span class="line">    https: false</span><br><span class="line"></span><br><span class="line">[root@xiaowangc ~]# vi /etc/gitlab/gitlab.rb</span><br><span class="line">external_url &#x27;http://gitlab.local.com&#x27;</span><br><span class="line"></span><br><span class="line">[root@xiaowangc ~]# gitlab-cli restart</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Gitlab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gitlab </tag>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决ubuntu 16.04分辨率</title>
      <link href="/archives/f140992e.html"/>
      <url>/archives/f140992e.html</url>
      
        <content type="html"><![CDATA[<p>ubuntu安装图形化后只有800*600分辨率</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/default/grub</span><br><span class="line">GRUB_GFXMODE=1920x1080</span><br><span class="line">GRUB_GFXPAYLOAD_LINUX=1920x1080</span><br><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCP三次握手四次挥手</title>
      <link href="/archives/36eaa23d.html"/>
      <url>/archives/36eaa23d.html</url>
      
        <content type="html"><![CDATA[<h1 id="TCP协议"><a href="#TCP协议" class="headerlink" title="TCP协议"></a>TCP协议</h1><h2 id="TCP头格式"><a href="#TCP头格式" class="headerlink" title="TCP头格式"></a>TCP头格式</h2><p>TCP收到应用层提交的数据之后，将其分段，并在每个分段前面封装一个TCP头，最终的IP包是在TCP头之间再添加IP形成的</p><p><img src="/archives/36eaa23d/image-20220926040258467.png" alt="image-20220926040258467"></p><p>TCP头由20B的固定长度部分加上变长的选项字段组成</p><p><img src="/archives/36eaa23d/image-20220926040457943.png" alt="image-20220926040457943"></p><p>TCP头的各字段含义如下：</p><ol><li><p>源端口(Source Port)</p><p>源端口是初始化通信的端口号，通常与IP地址一起起到标识报文的返回地址</p></li><li><p>目的端口(Destination Port)</p><p>目的端口是定义传输的目的，通常指接收方计算机上的应用程序接口</p></li><li><p>序列号(Sequence Number)</p><p>用于标识TCP源端设备向目的设备发送的字节流，形象的指对每个字节进行计数</p></li><li><p>确认号(Acknowledgement Number)</p><p>用于标识期望收到的下一个段的第一个字节，并声明此前接收到的所有数据都正确无误的收到。因此，确认序号应该是上一次成功收到的数据字节序列号加1。<strong>确认号的字段只有在ACK标志被置为1时生效</strong></p></li><li><p>数据偏移(Data Offset)</p><p>表示数据开始的地方离TCP段的起始位置有多远，实际上就是TCP头部长度，TCP头部是不固定的</p></li><li><p>保留(Reserved)</p><p>顾名思义</p></li><li><p>控制位(Control Bits)</p><ul><li>URG: 用于表示TCP包的紧急指针字段有效，用来保证TCP连接不被中断，并督促中间层设备要尽快处理这些数据</li><li>ACK: 取值为1时表示应答字段有效，为0时反之</li><li>PSH: 表示Push操作，当数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队</li><li>RST: 表示连接复位请求，用来复位产生错误的连接，也被用来拒绝和非法的数据包</li><li>SYN: 表示同步序列号，用来建立连接</li><li>FIN: 表示发送端已经发送完毕，发送FIN标志位的TCP段后，连接将被断开</li></ul></li><li><p>窗口(Window)</p><p>表示它期望每次收到的数据的字节数</p></li><li><p>校验和(Checksum)</p><p>源主机基于部分IP头信息、TCP头和数据内容计算出一个校验和，目的主机也要进行相同的计算，如果计算一致可证明数据的有效性</p></li><li><p>紧急指针(Urgent Pointer)</p><p>当URG标志被设置时才有效</p></li><li><p>选项(Options)</p><p>标识哪个选项有效。如果没有选项这个字节等于0，这个字节等于1标识无须再有操作；等于2表示下4个字节包括源机器的最大长度(MSS)，MSS是数据字段中可包含最大的数据量，源和目的机器要对此达成一致。当一个TCP建立时，双方都要通告各自的MSS，协商可以传输的最大段长度。</p></li><li><p>填充(Padding)</p><p>用于保证TCP头是32位的整倍数，不够将添加额外的零</p></li><li><p>数据(Data)</p><p>用于载荷数据，数据的长度是由源目的主机之间进行协商的</p></li></ol><h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p><img src="/archives/36eaa23d/image-20220926045027324.png" alt="image-20220926045027324"></p><ol><li>由发起方HostA向被叫方HostB发出连接请求。将随机生成一段数字作为序列号为a(100)，并将控制位的SYN置位。由于是第一个包，ACK无效</li><li>HostB收到连接请求后，读出序号为a(100)，并随机生成一个序列号b(200)，发送序列号为b的包，同时将ACK置为有效，并将确认号置为a+1(100+1)，同时将SYN置位</li><li>HostA收到HostB的连接确认后，对该确认再次确认。HostA收到确认号为a+1(100+1)、序列号为b(200)的包后，发送序列号为a+1(100+1)、确认号为b+1(200+1)的段进行确认</li><li>HostB收到确认报文之后，连接建立</li></ol><h2 id="抓包验证"><a href="#抓包验证" class="headerlink" title="抓包验证"></a>抓包验证</h2><ol><li><p>由发起方192.168.64.1向被叫方192.168.64.11发出连接请求。将随机生成一段数字作为序列号为2224225331，并将控制位的SYN置位为1。由于是第一个包，ACK无效</p><p><img src="/archives/36eaa23d/image-20220926054412047.png" alt="image-20220926054412047"></p></li><li><p>192.168.64.11收到连接请求后，读出序号为2224225331，并随机生成一个序列号1836170397，发送序列号为1836170397的包，同时将ACK置为有效，并将确认号置为2224225331+1，同时将SYN置位</p><p><img src="/archives/36eaa23d/image-20220926054705676.png" alt="image-20220926054705676"></p></li><li><p>192.168.64.1收到192.168.64.11的连接确认后，对该确认再次确认。192.168.64.1收到确认号为2224225331+1、序列号为1836170397的包后，发送序列号为2224225331+1、确认号为1836170397+1的段进行确认，同时将Ack置为1</p><p><img src="/archives/36eaa23d/image-20220926055204885.png" alt="image-20220926055204885"></p></li></ol><h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p><img src="/archives/36eaa23d/image-20220926154734711.png" alt="image-20220926154734711"></p><ol><li>HostA要求终止连接，发送序列号为p(随机生成的一段数字)的段，FIN控制位置为有效，同时确认此前收到的段。</li><li>HostB收到HostA发送的段后，发送ACK段，确认号为p+1，同时关闭连接</li><li>HostB发送序列号为q(随机生成的一段数字)的段，FIN置为有效，通知连接关闭</li><li>HostA收到HostB发送的段后，发送ACK段，确认号为q+1，同时关闭连接。</li></ol>]]></content>
      
      
      <categories>
          
          <category> TCP/IP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TCP/IP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8S-Help</title>
      <link href="/archives/3a1cedd3.html"/>
      <url>/archives/3a1cedd3.html</url>
      
        <content type="html"><![CDATA[<h1 id="K8S开启IPVS"><a href="#K8S开启IPVS" class="headerlink" title="K8S开启IPVS"></a>K8S开启IPVS</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# cat /etc/modules-load.d/k8s.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack</span><br></pre></td></tr></table></figure><h1 id="设置SC为默认存储"><a href="#设置SC为默认存储" class="headerlink" title="设置SC为默认存储"></a>设置SC为默认存储</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch storageclass nfs-client -p &#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><h1 id="K8S二进制安装遇到的网络问题"><a href="#K8S二进制安装遇到的网络问题" class="headerlink" title="K8S二进制安装遇到的网络问题"></a>K8S二进制安装遇到的网络问题</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在签发apiserver证书时需要加上K8S集群SVC地址</span><br></pre></td></tr></table></figure><h1 id="K8S使用NFS作为SC时遇到的错误"><a href="#K8S使用NFS作为SC时遇到的错误" class="headerlink" title="K8S使用NFS作为SC时遇到的错误"></a>K8S使用NFS作为SC时遇到的错误</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">必须要在所有节点安装nfs-client工具(nfs-utils)</span><br><span class="line">不推荐集群使用NFS当作存储,测试即可</span><br></pre></td></tr></table></figure><h1 id="K8S安装度量组件-环境是K8S二进制集群"><a href="#K8S安装度量组件-环境是K8S二进制集群" class="headerlink" title="K8S安装度量组件(环境是K8S二进制集群)"></a>K8S安装度量组件(环境是K8S二进制集群)</h1><h2 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h2><p>metrics x509: cannot validate certificate for 192.168.64.103 because it doesn’t cont</p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>在metrics-server的yaml添加如下参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=4443</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname,InternalDNS</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls              # 添加这段</span><br></pre></td></tr></table></figure><h2 id="报错-1"><a href="#报错-1" class="headerlink" title="报错"></a>报错</h2><p>[root@master ~]# kubectl top node<br>Error from server (ServiceUnavailable): the server is currently unable to handle the request (get nodes.metrics.k8s.io)<br><strong>同时apiserver报错</strong><br>Oct 26 17:21:01 master kube-apiserver[18236]: , Header: map[Content-Type:[text&#x2F;plain; charset&#x3D;utf-8] X-Content-Type-Options:[nosniff]]<br>Oct 26 17:21:01 master kube-apiserver[18236]: I1026 17:21:01.182587   18236 controller.go:129] OpenAPI AggregationController: action for item v1beta1.metrics.k8s.io: Rate Limited Requeue.<br>Oct 26 17:21:05 master kube-apiserver[18236]: E1026 17:21:05.182475   18236 available_controller.go:524] v1beta1.metrics.k8s.io failed with: failing or missing response from <a href="https://172.12.118.65/apis/metrics.k8s.io/v1beta1">https://172.12.118.65:443/apis/metrics.k8s.io/v1beta1</a>: Get …</p><h2 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /lib/systemd/system/apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=apiServer</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-apiserver \</span><br><span class="line">  --advertise-address=192.168.64.101 \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --enable-admission-plugins=NodeRestriction \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --etcd-cafile=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --etcd-certfile=/etc/etcd/apiserver-etcd-client.crt \</span><br><span class="line">  --etcd-keyfile=/etc/etcd/apiserver-etcd-client.key \</span><br><span class="line">  --etcd-servers=https://master:2379 \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/apiserver-kubelet-client.crt \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/apiserver-kubelet-client.key \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/sa.key \</span><br><span class="line">  --service-cluster-ip-range=172.12.0.0/16 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/apiserver.crt \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/apiserver.key \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/front-proxy-client.crt \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/front-proxy-client.key \</span><br><span class="line">  --requestheader-allowed-names=front-proxy-client \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/front-proxy-ca.crt \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --token-auth-file=/etc/kubernetes/token.csv \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --service-node-port-range=80-60000 \</span><br><span class="line">  --enable-aggregator-routing=true \   # 添加此选项</span><br><span class="line">  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p><strong>效果</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc ~]# kubectl top node</span><br><span class="line">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">node01   72m          1%     1007Mi          13%</span><br><span class="line">node02   82m          2%     1112Mi          14%</span><br><span class="line">node03   73m          1%     1052Mi          13%</span><br><span class="line">[root@xiaowangc ~]# kubectl top pod</span><br><span class="line">NAME                                      CPU(cores)   MEMORY(bytes)</span><br><span class="line">nfs-client-provisioner-5684cb8fbd-cl9zp   2m           15Mi</span><br><span class="line">nfs-client-provisioner-5684cb8fbd-t72xg   1m           13Mi</span><br><span class="line">[root@xiaowangc ~]#</span><br></pre></td></tr></table></figure><h2 id="重启控制器"><a href="#重启控制器" class="headerlink" title="重启控制器"></a>重启控制器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout restart deploy/prom-deployment</span><br></pre></td></tr></table></figure><h2 id="设置K8S-ROLES属性"><a href="#设置K8S-ROLES属性" class="headerlink" title="设置K8S ROLES属性"></a>设置K8S ROLES属性</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get node</span><br><span class="line">NAME                      STATUS   ROLES           AGE    VERSION</span><br><span class="line">master1.xiaowangc.local   Ready    control-plane   10h    v1.25.4</span><br><span class="line">master2.xiaowangc.local   Ready    control-plane   9h     v1.25.4</span><br><span class="line">master3.xiaowangc.local   Ready    control-plane   9h     v1.25.4</span><br><span class="line">node1.xiaowangc.local     Ready    nodes           154m   v1.25.4</span><br><span class="line">node2.xiaowangc.local     Ready    nodes           146m   v1.25.4</span><br><span class="line">node3.xiaowangc.local     Ready    nodes           138m   v1.25.4</span><br><span class="line">node4.xiaowangc.local     Ready    nodes           123m   v1.25.4</span><br><span class="line">[root@master1 ~]# kubectl get node --show-labels</span><br><span class="line">NAME                      STATUS   ROLES           AGE    VERSION   LABELS</span><br><span class="line">master1.xiaowangc.local   Ready    control-plane   10h    v1.25.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master1.xiaowangc.local,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">master2.xiaowangc.local   Ready    control-plane   9h     v1.25.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master2.xiaowangc.local,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">master3.xiaowangc.local   Ready    control-plane   9h     v1.25.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master3.xiaowangc.local,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">node1.xiaowangc.local     Ready    nodes           155m   v1.25.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node1.xiaowangc.local,kubernetes.io/os=linux,node-role.kubernetes.io/nodes=</span><br><span class="line">node2.xiaowangc.local     Ready    nodes           147m   v1.25.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node2.xiaowangc.local,kubernetes.io/os=linux,node-role.kubernetes.io/nodes=</span><br><span class="line">node3.xiaowangc.local     Ready    nodes           139m   v1.25.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node3.xiaowangc.local,kubernetes.io/os=linux,node-role.kubernetes.io/nodes=</span><br><span class="line">node4.xiaowangc.local     Ready    nodes           125m   v1.25.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node4.xiaowangc.local,kubernetes.io/os=linux,node-role.kubernetes.io/nodes=</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl label nodes 节点名字 node-role.kubernetes.io/ROLES属性名称=或-</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql备份、恢复及二进制日志</title>
      <link href="/archives/6e89b25.html"/>
      <url>/archives/6e89b25.html</url>
      
        <content type="html"><![CDATA[<h1 id="备份和恢复类型"><a href="#备份和恢复类型" class="headerlink" title="备份和恢复类型"></a>备份和恢复类型</h1><h2 id="物理备份与逻辑备份"><a href="#物理备份与逻辑备份" class="headerlink" title="物理备份与逻辑备份"></a>物理备份与逻辑备份</h2><p>物理备份由存储数据库内容的目录和文件的原始副本组成。这种类型的备份适用于在出现问题时需要快速恢复的大型重要数据库</p><p>逻辑备份保存表示为逻辑数据库结构(创建数据库、创建表语句)和内容(INSERT语句或分割文本文件)的信息。这种类型的备份适用于较小的数据量，您可以在其中编辑数据值或表结构，或者在不同的计算机体系结构上重新创建数据。</p><p><strong>物理备份方法具有以下特征</strong>：</p><ul><li>备份有数据库目录和文件的精确副本组成。通常这是MySQL数据目录的全部或部分副本</li><li>物理备份方法比逻辑备份方法快，因为它们只涉及文件复制而不进行转换</li><li>输出比逻辑备份更紧凑</li><li>备份和还原粒度的范围从整个数据目录的级别到单个文件的级别。这可能提供也可能不提供表级粒度，具体取决于存储引擎</li><li>除了数据库之外，备份还可以包括任何相关文件，如日志或配置文件</li><li>以这种方式备份表中数据很棘手，因为它们的内容不存储在磁盘上</li><li>备份只能移植到相同或类似硬件特征的其他计算机</li><li>可以在MySQL服务器未运行时执行备份。如果服务器正在运行，则必须执行适当的锁定，以便服务器在备份期间不会更改数据库内容</li><li>物理备份工具包括MySQL企业备份或任何其它表的MySQL备份，或表的文件系统级命令如：cp、scp、tar、rsync</li><li>对于恢复<ul><li>ndb_restore还原NDB表</li><li>可以使用文件系统命令将文件系统级别复制的文件复制回其原始位置</li></ul></li></ul><p><strong>逻辑备份方法具有以下特征</strong>：</p><ul><li>备份是通过查询MySQL服务器以获得数据库结构和内容信息来完成的</li><li>备份速度比物理方法慢，因为服务器必须访问数据库信息并将其转换为逻辑格式。如果输出写入客户端，则服务器还必须将其发送到备份程序</li><li>输出大于物理备份，尤其是在以文本格式保持时</li><li>备份和还原粒度在服务器级别(所有数据库)、数据库级别(特定数据库中的所有表)或表级别可用。无论存储引擎如何，都是如此</li><li>备份不包括日志或配置文件，或者不属于数据库的其他与数据库相关的文件</li><li>以逻辑格式存储的备份与机器无关，并且具有高度的可移植性</li><li>要还原逻辑备份，可以使用MySQL客户端处理SQL格式的转储文件</li></ul><h2 id="联机备份与脱机备份"><a href="#联机备份与脱机备份" class="headerlink" title="联机备份与脱机备份"></a>联机备份与脱机备份</h2><p>在线备份在MySQL服务器运行时进行，以便可以从服务器获取数据库信息。脱机备份在服务器停止时进行。这种区别也可以描述为”热”与”冷”备份；”热”备份是指服务器保持运行状态，但需要从外部访问数据库文件时锁定以防止修改数据</p><p><strong>联机备份方法具有以下特征</strong>：</p><ul><li>备份对于客户端的干扰较小，其他客户端可以在备份期间连接到MySQL服务器，并且可以访问数据</li><li>必须注意施加适当的锁定，以免发生会损害备份完整性的数据修改</li></ul><p><strong>脱机备份方法具有以下特征</strong>：</p><ul><li>客户端可能会受到负面影响，因为服务器在备份期间不可用。因此，此类备份通常从副本服务器获取，该副本服务器可以在不损害可用性的情况下脱机</li><li>备份过程更简单，因为客户端活动不会干扰</li></ul><h2 id="快照备份"><a href="#快照备份" class="headerlink" title="快照备份"></a>快照备份</h2><p>某些文件系统实现允许拍摄快照。它们提供文件系统在给定的时间点的逻辑副本，而不需要整个文件系统的物理副本</p><h2 id="完整备份与增量备份"><a href="#完整备份与增量备份" class="headerlink" title="完整备份与增量备份"></a>完整备份与增量备份</h2><p>完整备份包括由MySQL服务器在给定时间点管理的所有数据</p><p>增量备份包括在给定时间跨度(从一个时间点到另一个时间点)内对数据所作的更改</p><h2 id="完整恢复与时间点-增量-恢复"><a href="#完整恢复与时间点-增量-恢复" class="headerlink" title="完整恢复与时间点(增量)恢复"></a>完整恢复与时间点(增量)恢复</h2><p>完整恢复从完整备份还原所有数据。这会将服务器实例还原到备份时的状态。如果该状态不够最新，则可以在完全恢复之后恢复自完整备份以来所作的增量备份，以使服务器处于更新状态</p><p>增量恢复是对给定时间跨度内所作更改的恢复。这也曾时间点恢复，因为它使服务器的状态在给定时间内保持最新。时间点恢复基于二进制日志，通常遵循从备份文件进行完全恢复之后，该恢复会将服务器还原到进行备份时的状态。然后，写入二进制日志文件中的数据更改作为增量恢复应用，以重做数据修改并使服务器达到所需的时间点</p><h1 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h1><p>二进制日志包含描述数据库更改(创建、修改、删除)的”事件”。它还包含可能已进行更改的语句事件，除非使用基于行的日志记录。二进制日志还包含有关每条语句占用该更新数据多长时间的信息。二进制日志有两个重要用途：</p><ul><li>对于复制，复制源服务器上的二进制日志提供要发送到副本的数据更改的记录。源将二进制日志中包含的事件发送到其副本，副本执行这些事件以进行与源上相同的数据更改</li><li>某些数据恢复操作需要使用二进制日志。还原备份后，将重新执行进行备份后记录的二进制日志中的事件。这些事件使数据库从备份点保持最新</li></ul><h1 id="复制实现"><a href="#复制实现" class="headerlink" title="复制实现"></a>复制实现</h1><p>MySQL内建的复制功能是构建基于MySQL的<code>大规模</code>、<code>高性能</code>应用的基础，这类应用使用所谓的”<code>水平扩展</code>“的架构。通过为服务器配置一个或多个从库的方式来进行数据同步。</p><p>复制解决的基本问题是让一台服务器的数据与其他服务器保持同步。一台主库的数据可以同步到多台从库上，从库本身也可以被配置成为另一台服务器的主库</p><p>MySQL支持两种复制方式：</p><ul><li>基于行的复制</li><li>基于语句的复制</li></ul><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul><li><p>数据分布</p><p>复制通常不会对带宽造成很大的压力，但是在基于行的复制会比传统的基于语句的复制模式的贷款压力大。可以随意停止或开始复制，并在<strong>不同的地理位置</strong>来分布数据备份。</p></li><li><p>负载均衡</p><p>通过MySQL复制可以将读操作分布到多台服务器上，实现对读密集型应用的优化，并且实现很方便</p></li><li><p>备份</p><p><strong>对于备份来说，复制是一项很有意义的技术补充，但复制既不是备份也不能狗取代备份</strong>。</p><p><strong>优点</strong>：当主服务器发生故障或瘫痪可在一定程度上保证数据不会丢失，同时可以快速将备份服务器切换为主服务器</p><p><strong>缺点</strong>：当人(黑客)为对数据库进行删除加密等操作，作为备份服务器同样会被删除或进行加密</p></li><li><p>高可用性和故障切换</p><p>避免<strong>单点故障</strong>，切换系统可<strong>缩短宕机时间</strong></p></li><li><p>升级测试</p><p>使用高版本的MySQL作为备库，保证升级全部实例前，查询能够在备库按照预期执行</p></li></ul><h2 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a>复制原理</h2><h3 id="基于语句的复制"><a href="#基于语句的复制" class="headerlink" title="基于语句的复制"></a>基于语句的复制</h3><p>在早期版本只支持基于语句的复制(逻辑复制)，原理是主库会记录哪些造成数据更改的查询，当备库读取并重放这些事件时，实际上只是把主库上执行过的SQL再执行一遍。</p><h3 id="基于行的复制"><a href="#基于行的复制" class="headerlink" title="基于行的复制"></a>基于行的复制</h3><p>MySQL5.1开始支持行的复制，这种方式会将实际数据记录在二进制日志中，最大的好处是可以正确地复制每一行。一些语句可以被更加有效地复制</p><h2 id="复制工作原理"><a href="#复制工作原理" class="headerlink" title="复制工作原理"></a>复制工作原理</h2><p><img src="/archives/6e89b25/image-20221013001804788.png" alt="image-20221013001804788"></p><p>MySQL实现复制数据的过程共有三个步骤：</p><ol><li>在主库上把数据更改记录到二进制日志（Binary Log）中，这些记录被称之为二进制日志事件</li><li>备库将主库上的日志复制到自己的中继日志(Relay Log)中</li><li>备库读取中继日志中的事件，将其重放到备库数据之上</li></ol><h1 id="实验章节"><a href="#实验章节" class="headerlink" title="实验章节"></a>实验章节</h1><p>在实现MySQL主从架构，一定是从空数据库开始，如果是已有的数据MySQL数据库做主从这可能相对于比较麻烦，如果在数据库创建的时候就开启了二进制日志，那么在有数据的MySQL数据中是可以做主从，如果之前的MySQL数据库没有开启二进制日志并且想做主从的架构，那么从数据库需要保证与主数据库服务器原先的数据保持一致再进行复制</p><blockquote><p>从节点可以保证主节点宕机之后还能提供读操作，或可以将从节点切换为主节点以提供读写</p></blockquote><blockquote><p>开启了二进制日志的MySQL服务器可以实现增量备份</p></blockquote><p><img src="/archives/6e89b25/image-20221013004443899.png" alt="image-20221013004443899"></p><p>根据系统下载对应的MySQL以及版本</p><p>我的下载：<a href="https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.39-1.el7.x86_64.rpm-bundle.tar">https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.39-1.el7.x86_64.rpm-bundle.tar</a></p><h2 id="安装主节点"><a href="#安装主节点" class="headerlink" title="安装主节点"></a>安装主节点</h2><p>本次实验是在CentOS8.4上操作的，虽然MySQL5.7没有EL8的包但是可以在CentOS8上安装EL7的软件包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tar xf mysql-5.7.39-1.el7.x86_64.rpm-bundle.tar</span><br><span class="line">[root@master ~]# ls</span><br><span class="line">anaconda-ks.cfg                                   mysql-community-embedded-compat-5.7.39-1.el7.x86_64.rpm</span><br><span class="line">mysql-5.7.39-1.el7.x86_64.rpm-bundle.tar          mysql-community-embedded-devel-5.7.39-1.el7.x86_64.rpm</span><br><span class="line">mysql-community-client-5.7.39-1.el7.x86_64.rpm    mysql-community-libs-5.7.39-1.el7.x86_64.rpm</span><br><span class="line">mysql-community-common-5.7.39-1.el7.x86_64.rpm    mysql-community-libs-compat-5.7.39-1.el7.x86_64.rpm</span><br><span class="line">mysql-community-devel-5.7.39-1.el7.x86_64.rpm     mysql-community-server-5.7.39-1.el7.x86_64.rpm</span><br><span class="line">mysql-community-embedded-5.7.39-1.el7.x86_64.rpm  mysql-community-test-5.7.39-1.el7.x86_64.rpm</span><br><span class="line">[root@master ~]# dnf -y install *.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用dnf软件包管理工具安装rpm软件包可以自动解决依赖问题</span></span><br></pre></td></tr></table></figure><h2 id="配置主节点"><a href="#配置主节点" class="headerlink" title="配置主节点"></a>配置主节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vi /etc/my.cnf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在配置文件中开启这两项</span></span><br><span class="line">log_bin = mysql-bin# 以mysql-bin命名的二进制日志文件</span><br><span class="line">server_id = 10# 节点id</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其余采用默认配置</span></span><br></pre></td></tr></table></figure><p><img src="/archives/6e89b25/image-20221013005001875.png" alt="image-20221013005001875"></p><h2 id="启动主节点"><a href="#启动主节点" class="headerlink" title="启动主节点"></a>启动主节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl enable --now mysqld</span><br><span class="line">[root@master ~]# cat /var/log/mysqld.log | grep password# 初次安装自动生成密码，通过日志查看</span><br><span class="line">2022-10-12T16:51:22.192080Z 1 [Note] A temporary password is generated for root@localhost: dF4q%Xs6ylyP</span><br><span class="line">[root@master ~]# mysql -uroot -pdF4q%Xs6ylyP</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.39-log</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt;</span><span class="language-bash"><span class="comment"># 初次登陆需要重置密码</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">set</span> global validate_password_policy=0;<span class="comment"># 设置密码策略   如果对安全有要求可以跳过这两项操作，这里主要是为了演示采用简单密码</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">set</span> global validate_password_length=1;<span class="comment"># 设置密码长度</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;<span class="comment"># 更新root密码</span></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show master status;<span class="comment"># 查看master状态，可以看到二进制日志文件的名称</span></span></span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000002 |      398 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave,replication client on *.* to slave@<span class="string">&quot;192.168.64.*&quot;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建复制账号并设置密码</span></span><br></pre></td></tr></table></figure><h2 id="安装从节点"><a href="#安装从节点" class="headerlink" title="安装从节点"></a>安装从节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ls</span><br><span class="line">anaconda-ks.cfg  mysql-5.7.39-1.el7.x86_64.rpm-bundle.tar</span><br><span class="line">[root@slave ~]# tar xf mysql-5.7.39-1.el7.x86_64.rpm-bundle.tar</span><br><span class="line">[root@slave ~]# dnf -y install *.rpm</span><br></pre></td></tr></table></figure><h2 id="配置从节点"><a href="#配置从节点" class="headerlink" title="配置从节点"></a>配置从节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# vi /etc/my.cnf</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">server_id = 11</span><br><span class="line">read_only = 1# 开启只读，从节点只提供只读</span><br></pre></td></tr></table></figure><p><img src="/archives/6e89b25/image-20221013011005455.png" alt="image-20221013011005455"></p><h2 id="启动从节点"><a href="#启动从节点" class="headerlink" title="启动从节点"></a>启动从节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# systemctl enable --now mysqld</span><br><span class="line">[root@slave ~]# cat /var/log/mysqld.log | grep password</span><br><span class="line">2022-10-12T17:11:25.637271Z 1 [Note] A temporary password is generated for root@localhost: mHJ5aTJE+grU</span><br><span class="line">[root@slave ~]# mysql -uroot -pmHJ5aTJE+grU</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.39-log</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">set</span> global validate_password_policy=0;<span class="comment"># 更改密码复杂度</span></span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">set</span> global validate_password_length=1;<span class="comment"># 更改密码策略长度</span></span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;<span class="comment"># 更改root密码</span></span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">change master to master_host=<span class="string">&quot;192.168.64.147&quot;</span>,<span class="comment"># 配置复制账号信息</span></span></span><br><span class="line">    -&gt; master_user=&quot;slave&quot;,</span><br><span class="line">    -&gt; master_password=&quot;123456&quot;,</span><br><span class="line">    -&gt; master_log_file=&quot;mysql-bin.000002&quot;,</span><br><span class="line">    -&gt; master_log_pos=0;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\G<span class="comment"># 查看slave状态</span></span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: 192.168.64.147</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 4</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 4</span><br><span class="line">              Relay_Log_Space: 154</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">                  Master_UUID:</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State:</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">start slave;<span class="comment"># 启动复制，关闭使用stop slave;</span></span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\G<span class="comment"># 查看状态</span></span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.64.147</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 1028</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1241</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes# IO启动     确保这两项为Yes</span><br><span class="line">            Slave_SQL_Running: Yes# SQL启动</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 1028</span><br><span class="line">              Relay_Log_Space: 1448</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 10</span><br><span class="line">                  Master_UUID: 19e30d90-4a4e-11ed-9534-000c2952ba66</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="测试主从"><a href="#测试主从" class="headerlink" title="测试主从"></a>测试主从</h2><p>在主节点上对数据库进行写操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create database xiaowangc;</span></span><br></pre></td></tr></table></figure><p>在从简单上对数据库进行查看</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show databases;</span></span><br></pre></td></tr></table></figure><p><img src="/archives/6e89b25/image-20221013015033188.png" alt="image-20221013015033188"></p><h1 id="增量备份"><a href="#增量备份" class="headerlink" title="增量备份"></a>增量备份</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--all-databases：备份所有的数据库</span><br><span class="line">--databases db1 db2：备份指定的数据库</span><br><span class="line">--single-transaction：对事务引擎执行热备</span><br><span class="line">--flush-logs：更新二进制日志文件</span><br><span class="line">--master-data=2</span><br><span class="line">  1：每备份一个库就生成一个新的二进制文件(默认)</span><br><span class="line">  2：只生成一个新的二进制文件</span><br><span class="line">--quick：在备份大表时指定该选项</span><br><span class="line">================================================================================</span><br><span class="line">mysqldump -u root -p password --all-databases --single-transaction --flush-logs --master-data=2 &gt; mysql_all.sql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份所有库</span></span><br><span class="line"></span><br><span class="line">mysqladmin -u root -p flush-logs   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增量备份，刷新二进制文件后最好再Copy一份到其他服务器上避免服务器崩溃</span></span><br></pre></td></tr></table></figure><p><strong>不管做不做主从一定要开启二进制日志！！！</strong></p><h1 id="复制架构"><a href="#复制架构" class="headerlink" title="复制架构"></a>复制架构</h1><ul><li><p>一主多从</p><p><img src="/archives/6e89b25/image-20221013021525912.png" alt="image-20221013021525912"></p></li><li><p>多主架构</p><ul><li><p>主动</p><p><img src="/archives/6e89b25/image-20221013021551952.png" alt="image-20221013021551952"></p></li><li><p>被动</p><p><img src="/archives/6e89b25/image-20221013021609894.png" alt="image-20221013021609894"></p></li></ul></li><li><p>多主多从</p><p><img src="/archives/6e89b25/image-20221013021642526.png" alt="image-20221013021642526"></p></li><li><p>环形复制</p><p><img src="/archives/6e89b25/image-20221013021705448.png" alt="image-20221013021705448"></p><p><img src="/archives/6e89b25/image-20221013021721728-16655986421531.png" alt="image-20221013021721728"></p></li><li><p>树形复制</p><p><img src="/archives/6e89b25/image-20221013021822328.png" alt="image-20221013021822328"></p></li></ul><h1 id="允许Root从远程登录"><a href="#允许Root从远程登录" class="headerlink" title="允许Root从远程登录"></a>允许Root从远程登录</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update mysql.user set Host=&#x27;%&#x27; where HOST=&#x27;localhost&#x27; and User=&#x27;root&#x27;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubeadmin集群生成token加入新节点</title>
      <link href="/archives/43937223.html"/>
      <url>/archives/43937223.html</url>
      
        <content type="html"><![CDATA[<h1 id="Kubeadmin生成token加入新节点"><a href="#Kubeadmin生成token加入新节点" class="headerlink" title="Kubeadmin生成token加入新节点"></a>Kubeadmin生成token加入新节点</h1><h1 id="添加Node节点"><a href="#添加Node节点" class="headerlink" title="添加Node节点"></a>添加Node节点</h1><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><ul><li><p>创建Token</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubeadm token create --print-join-command</span><br><span class="line">kubeadm join 192.168.64.11:6443 --token w1s3w2.mkvsfgygelphy48q --discovery-token-ca-cert-hash sha256:58304b3b4aedd0d995d7a8b61b0e42b25bbfaa0fa947bfa3b3090cd8da8fefd2</span><br></pre></td></tr></table></figure><p><strong>Token默认过期时间是24h，可通过指定参数–ttl&#x3D;0使Token永久有效</strong></p><p><strong>–print-join-command 不只是打印令牌，而是打印使用令牌加入集群所需的完整“kubeadm-join”标志。</strong></p></li><li><p>查看Token</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubeadm token list</span><br><span class="line">TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS</span><br><span class="line">w1s3w2.mkvsfgygelphy48q   23h         2022-09-22T05:33:27Z   authentication,signing   &lt;none&gt;                                                     system:bootstrappers:kubeadm:default-node-token</span><br></pre></td></tr></table></figure></li><li><p>WorkNode加入节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# kubeadm join 192.168.64.11:6443 --token w1s3w2.mkvsfgygelphy48q --discovery-token-ca-cert-hash sha256:58304b3b4aedd0d995d7a8b61b0e42b25bbfaa0fa947bfa3b3090cd8da8fefd2</span><br></pre></td></tr></table></figure></li></ul><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master pki]# kubeadm token create</span><br><span class="line">lzh5ym.5angzdhj3cowkplo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成token</span></span><br><span class="line"></span><br><span class="line">[root@master pki]# openssl x509 -pubkey -in ca.crt | openssl rsa -pubin -outform der| openssl dgst -sha256 -hex</span><br><span class="line">writing RSA key</span><br><span class="line">(stdin)= 58304b3b4aedd0d995d7a8b61b0e42b25bbfaa0fa947bfa3b3090cd8da8fefd2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提取Ca证书token-ca-cert-hash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">组合</span></span><br><span class="line">kubeadm join 192.168.64.11:6443 --token lzh5ym.5angzdhj3cowkplo --discoverty-token-ca-cert-hash sha256:58304b3b4aedd0d995d7a8b61b0e42b25bbfaa0fa947bfa3b3090cd8da8fefd2</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s二进制安装方法</title>
      <link href="/archives/a6cffccf.html"/>
      <url>/archives/a6cffccf.html</url>
      
        <content type="html"><![CDATA[<h1 id="K8S二进制安装"><a href="#K8S二进制安装" class="headerlink" title="K8S二进制安装"></a>K8S二进制安装</h1><p><strong>对于安装过程中的证书以及配置文件不做过多讲解</strong></p><p><strong>详情请参考：<a href="https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/">https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/</a></strong></p><p>我们在翻阅kubernets官网文章时，有注意的小伙伴就会发现官方只介绍了使用kubeadm等工具进行安装，并没有介绍或者详细介绍二进制的安装方法，但是网上的却有很多介绍二进制安装，证书生成等教程。那么我曾就有这个疑问，<strong>他们是到底怎么学会二进制的呢</strong>？</p><p>Kubernetes是开源的容器编排工具，而底层还是容器技术；在通过Kubeadm工具安装Kubernetes集群时，每个组件还是以容器的方式运行的。容器的本质就是<code>对进程进行隔离</code>的一项技术，<strong>容器内其实运行的也是二进制</strong>。我们可以对adm安装的集群包括证书、二进制参数、配置文件等进行分析，大致就能明白如何通过二进制的方式对kubernetes进行安装。知道这种方式那么通过adm安装的Kubernetes集群是不是就是官方给我们的最好的例子！</p><p>预先通过adm搭建的Kubernetes集群对各个组件、证书以及容器进行分析大致就能知道二进制如何安装！此文档是根据kubeadm部署的1.23.6进行分析部署的</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><h2 id="前提准备"><a href="#前提准备" class="headerlink" title="前提准备"></a>前提准备</h2><p>本次安装采用<strong>CentOS 8.4</strong>系统上部署<strong>etcd高可用</strong>方式安装k8s 1.23.6集群</p><p><strong>请预先配置IP以及主机名并配置集群之间免密</strong></p><p>不会免密的请到：<a href="https://www.xiaowangc.com/2021/05/16/ssh/">https://www.xiaowangc.com/2021/05/16/ssh/</a></p><table><thead><tr><th>主机名</th><th>IP</th><th></th></tr></thead><tbody><tr><td>master01</td><td>192.168.64.31&#x2F;24</td><td>控制平面</td></tr><tr><td>node01</td><td>192.168.64.32&#x2F;24</td><td>Node&#x2F;etcd01</td></tr><tr><td>node02</td><td>192.168.64.33&#x2F;24</td><td>Node&#x2F;etcd02</td></tr><tr><td>node03</td><td>192.168.64.34&#x2F;24</td><td>Node&#x2F;etcd03</td></tr></tbody></table><p><strong>请确保集群中主机hosts解析配置一致</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.64.31   master</span><br><span class="line">192.168.64.32   node01  node1   etcd01  etcd1</span><br><span class="line">192.168.64.33   node02  node2   etcd02  etcd2</span><br><span class="line">192.168.64.34   node03  node3   etcd03  etcd3</span><br></pre></td></tr></table></figure><h2 id="配置存储库-所有节点"><a href="#配置存储库-所有节点" class="headerlink" title="配置存储库(所有节点)"></a>配置存储库(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mkdir /etc/yum.repos.d/bak</span><br><span class="line">[root@master ~]# mv /etc/yum.repos.d/* /etc/yum.repos.d/bak</span><br><span class="line">[root@master ~]# curl -o /etc/yum.repos.d/a.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span><br><span class="line">[root@master ~]# curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h2 id="关闭Selinux-所有节点"><a href="#关闭Selinux-所有节点" class="headerlink" title="关闭Selinux(所有节点)"></a>关闭Selinux(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# setenforce 0</span><br><span class="line">[root@master ~]# sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure><h2 id="关闭交换分区-所有节点"><a href="#关闭交换分区-所有节点" class="headerlink" title="关闭交换分区(所有节点)"></a>关闭交换分区(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# swapoff -a</span><br><span class="line">[root@master ~]# sed -ri &quot;s/.*swap.*/#&amp;/&quot; /etc/fstab</span><br></pre></td></tr></table></figure><h2 id="关闭防火墙-所有节点"><a href="#关闭防火墙-所有节点" class="headerlink" title="关闭防火墙(所有节点)"></a>关闭防火墙(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl disable --now firewalld</span><br></pre></td></tr></table></figure><h2 id="配置网桥-所有节点"><a href="#配置网桥-所有节点" class="headerlink" title="配置网桥(所有节点)"></a>配置网桥(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tee &gt; /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# tee &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# sysctl --system</span><br></pre></td></tr></table></figure><h2 id="安装配置Docker"><a href="#安装配置Docker" class="headerlink" title="安装配置Docker"></a>安装配置Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# curl https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">[root@master ~]# dnf -y install docker-ce --allowerasing</span><br><span class="line">[root@master ~]# systemctl enable --now docker</span><br><span class="line">[root@master ~]# tee &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line"> &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="开启IPVS-所有节点"><a href="#开启IPVS-所有节点" class="headerlink" title="开启IPVS(所有节点)"></a>开启IPVS(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tee  &gt;  /etc/sysconfig/modules/ipvs.modules &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">modprobe  --  ip_vs</span><br><span class="line">modprobe  --  ip_vs_rr</span><br><span class="line">modprobe  --  ip_vs_wrr</span><br><span class="line">modprobe  --  ip_vs_sh</span><br><span class="line">modprobe  --  nf_conntrack</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# chmod +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">[root@master ~]# /bin/bash /etc/sysconfig/modules/ipvs.modules</span><br></pre></td></tr></table></figure><h1 id="ETCD集群"><a href="#ETCD集群" class="headerlink" title="ETCD集群"></a>ETCD集群</h1><h2 id="下载-etcd节点"><a href="#下载-etcd节点" class="headerlink" title="下载(etcd节点)"></a>下载(etcd节点)</h2><p>ETCD下载连接：<a href="https://github.com/etcd-io/etcd/releases/">https://github.com/etcd-io/etcd/releases/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.5.5/etcd-v3.5.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p><strong>通过参考kubeadm安装生成etcd配置文件,单节点ETCD部署就只在节点配置如下即可，修改对应的IP地址和证书路径</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master manifests]# ls</span><br><span class="line">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml</span><br><span class="line">[root@master manifests]# pwd</span><br><span class="line">[root@master manifests]# cat etcd.yaml</span><br><span class="line">/etc/kubernetes/manifests</span><br><span class="line">    - etcd</span><br><span class="line">    - --advertise-client-urls=https://192.168.64.11:2379</span><br><span class="line">    - --cert-file=/etc/kubernetes/pki/etcd/server.crt</span><br><span class="line">    - --client-cert-auth=true</span><br><span class="line">    - --data-dir=/var/lib/etcd</span><br><span class="line">    - --initial-advertise-peer-urls=https://192.168.64.11:2380</span><br><span class="line">    - --initial-cluster=master=https://192.168.64.11:2380</span><br><span class="line">    - --key-file=/etc/kubernetes/pki/etcd/server.key</span><br><span class="line">    - --listen-client-urls=https://127.0.0.1:2379,https://192.168.64.11:2379</span><br><span class="line">    - --listen-metrics-urls=http://127.0.0.1:2381</span><br><span class="line">    - --listen-peer-urls=https://192.168.64.11:2380</span><br><span class="line">    - --name=master</span><br><span class="line">    - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</span><br><span class="line">    - --peer-client-cert-auth=true</span><br><span class="line">    - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key</span><br><span class="line">    - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">    - --snapshot-count=10000</span><br><span class="line">    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br></pre></td></tr></table></figure><p>通过现环境修改成适用于高可用的ETCD集群配置</p><h2 id="创建etcd-CA"><a href="#创建etcd-CA" class="headerlink" title="创建etcd CA"></a>创建etcd CA</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# mkdir /etc/etcd</span><br><span class="line">[root@node01 ~]# cd /etc/etcd/</span><br><span class="line">[root@node01 etcd]# vi etcd-ca.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:etcd-ca</span><br><span class="line">[root@node01 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd-ca.key -out etcd-ca.csr -nodes -subj &#x27;/CN=etcd-ca&#x27;</span><br><span class="line">[root@node01 etcd]# openssl x509 -req -days 36500 -sha256 -extfile etcd-ca.cnf -extensions v3_ca -set_serial 0 -signkey etcd-ca.key -in etcd-ca.csr -out etcd-ca.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = etcd-ca</span><br><span class="line">Getting Private key</span><br><span class="line">[root@node01 etcd]# ls</span><br><span class="line">etcd-ca.cnf  etcd-ca.crt  etcd-ca.csr  etcd-ca.key</span><br></pre></td></tr></table></figure><h2 id="创建etcd01证书"><a href="#创建etcd01证书" class="headerlink" title="创建etcd01证书"></a>创建etcd01证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 etcd]# cat etcd01.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:etcd01,IP:127.0.0.1, IP:192.168.64.32# 注意IP域名与本机一致</span><br><span class="line"></span><br><span class="line">========================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node01 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd01.key -out etcd01.csr -nodes -subj &#x27;/CN=etcd01&#x27;</span><br><span class="line">[root@node01 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd01.cnf -extensions v3_req -in etcd01.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out etcd01.crt -CAcreateserial</span><br><span class="line"></span><br><span class="line">========================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node01 etcd]# openssl req -new -newkey rsa:2048 -keyout peer.key -out peer.csr -nodes -subj &#x27;/CN=etcd01&#x27;</span><br><span class="line">[root@node01 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd01.cnf -extensions v3_req -in peer.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out peer.crt -CAcreateserial</span><br></pre></td></tr></table></figure><h2 id="配置etcd01"><a href="#配置etcd01" class="headerlink" title="配置etcd01"></a>配置etcd01</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 etcd]# cd</span><br><span class="line">[root@node01 ~]# tar xf etcd-v3.5.5-linux-amd64.tar.gz</span><br><span class="line">[root@node01 ~]# cp etcd-v3.5.5-linux-amd64/etcd* /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# vi /lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=etcd --name etcd01 --initial-advertise-peer-urls https://192.168.64.32:2380 \</span><br><span class="line">  --listen-peer-urls https://192.168.64.32:2380 \</span><br><span class="line">  --listen-client-urls https://192.168.64.32:2379,https://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.64.32:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd01=https://192.168.64.32:2380,etcd02=https://192.168.64.33:2380,etcd03=https://192.168.64.34:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --cert-file=/etc/etcd/etcd01.crt \</span><br><span class="line">  --key-file=/etc/etcd/etcd01.key \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --peer-cert-file=/etc/etcd/peer.crt \</span><br><span class="line">  --peer-key-file=/etc/etcd/peer.key \</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@node01 ~]# systemctl daemon-reload</span><br><span class="line">[root@node01 system]# systemctl enable --now etcd</span><br></pre></td></tr></table></figure><h2 id="创建etcd02证书"><a href="#创建etcd02证书" class="headerlink" title="创建etcd02证书"></a>创建etcd02证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# tar xf etcd-v3.5.5-linux-amd64.tar.gz</span><br><span class="line">[root@node02 ~]# cp etcd-v3.5.5-linux-amd64/etcd* /usr/local/sbin/</span><br><span class="line">[root@node02 ~]# mkdir /etc/etcd</span><br><span class="line">[root@node02 ~]# cd /etc/etcd/</span><br><span class="line">[root@node02 etcd]# scp node01:/etc/etcd/etcd-ca* .# 拷贝etcd-ca到etcd02</span><br><span class="line">etcd-ca.cnf                                                                                        100%  172   373.5KB/s   00:00</span><br><span class="line">etcd-ca.crt                                                                                        100% 1090     2.4MB/s   00:00</span><br><span class="line">etcd-ca.csr                                                                                        100%  887     2.7MB/s   00:00</span><br><span class="line">etcd-ca.key                                                                                        100% 1708     3.6MB/s   00:00</span><br><span class="line">etcd-ca.srl                                                                                        100%   41   107.5KB/s   00:00</span><br><span class="line">[root@node02 etcd]# cat etcd02.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:etcd02,IP:127.0.0.1, IP:192.168.64.33# 注意IP和主机名</span><br><span class="line"></span><br><span class="line">===================================================================================</span><br><span class="line"></span><br><span class="line">[root@node02 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd02.key -out etcd02.csr -nodes -subj &#x27;/CN=etcd02&#x27;</span><br><span class="line">[root@node02 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd02.cnf -extensions v3_req -in etcd02.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out etcd02.crt -CAcreateserial</span><br><span class="line"></span><br><span class="line">===================================================================================</span><br><span class="line"></span><br><span class="line">[root@node02 etcd]# openssl req -new -newkey rsa:2048 -keyout peer.key -out peer.csr -nodes -subj &#x27;/CN=etcd02&#x27;</span><br><span class="line">[root@node02 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd02.cnf -extensions v3_req -in peer.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out peer.crt -CAcreateserial</span><br></pre></td></tr></table></figure><h2 id="配置etcd02"><a href="#配置etcd02" class="headerlink" title="配置etcd02"></a>配置etcd02</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 etcd]# vi /lib/systemd/system/etcd.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=etcd --name etcd02 --initial-advertise-peer-urls https://192.168.64.33:2380 \</span><br><span class="line">  --listen-peer-urls https://192.168.64.33:2380 \</span><br><span class="line">  --listen-client-urls https://192.168.64.33:2379,https://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.64.33:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd01=https://192.168.64.32:2380,etcd02=https://192.168.64.33:2380,etcd03=https://192.168.64.34:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --cert-file=/etc/etcd/etcd02.crt \</span><br><span class="line">  --key-file=/etc/etcd/etcd02.key \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --peer-cert-file=/etc/etcd/peer.crt \</span><br><span class="line">  --peer-key-file=/etc/etcd/peer.key \</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@node02 etcd]# systemctl daemon-reload</span><br><span class="line">[root@node02 etcd]# systemctl enable --now etcd</span><br></pre></td></tr></table></figure><h2 id="创建etcd03证书"><a href="#创建etcd03证书" class="headerlink" title="创建etcd03证书"></a>创建etcd03证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@node03 ~]# tar xf etcd-v3.5.5-linux-amd64.tar.gz</span><br><span class="line">[root@node03 ~]# cp etcd-v3.5.5-linux-amd64/etcd* /usr/local/sbin/</span><br><span class="line">[root@node03 ~]# mkdir /etc/etcd</span><br><span class="line">[root@node03 ~]# cd /etc/etcd/</span><br><span class="line">[root@node03 etcd]# scp node01:/etc/etcd/etcd-ca* .</span><br><span class="line">etcd-ca.cnf                                                                                  100%  172   318.4KB/s   00:00</span><br><span class="line">etcd-ca.crt                                                                                  100% 1090     1.7MB/s   00:00</span><br><span class="line">etcd-ca.csr                                                                                  100%  887     1.5MB/s   00:00</span><br><span class="line">etcd-ca.key                                                                                  100% 1708     4.2MB/s   00:00</span><br><span class="line">etcd-ca.srl                                                                                  100%   41   127.2KB/s   00:00</span><br><span class="line">[root@node03 etcd]# cat etcd03.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:etcd03,IP:127.0.0.1, IP:192.168.64.34# 注意IP和主机名</span><br><span class="line"></span><br><span class="line">================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node03 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd03.key -out etcd03.csr -nodes -subj &#x27;/CN=etcd03&#x27;</span><br><span class="line">[root@node03 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd03.cnf -extensions v3_req -in etcd03.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out etcd03.crt -CAcreateserial</span><br><span class="line"></span><br><span class="line">================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node03 etcd]# openssl req -new -newkey rsa:2048 -keyout peer.key -out peer.csr -nodes -subj &#x27;/CN=etcd03&#x27;</span><br><span class="line">[root@node03 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd03.cnf -extensions v3_req -in peer.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out peer.crt -CAcreateserial</span><br></pre></td></tr></table></figure><h2 id="配置etcd03"><a href="#配置etcd03" class="headerlink" title="配置etcd03"></a>配置etcd03</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node03 etcd]# vi /lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=etcd --name etcd03 --initial-advertise-peer-urls https://192.168.64.34:2380 \</span><br><span class="line">  --listen-peer-urls https://192.168.64.34:2380 \</span><br><span class="line">  --listen-client-urls https://192.168.64.34:2379,https://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.64.34:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd01=https://192.168.64.32:2380,etcd02=https://192.168.64.33:2380,etcd03=https://192.168.64.34:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --cert-file=/etc/etcd/etcd03.crt \</span><br><span class="line">  --key-file=/etc/etcd/etcd03.key \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --peer-cert-file=/etc/etcd/peer.crt \</span><br><span class="line">  --peer-key-file=/etc/etcd/peer.key \</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@node03 etcd]# systemctl daemon-reload</span><br><span class="line">[root@node03 etcd]# systemctl enable --now etcd</span><br></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 etcd]# etcdctl --endpoints=&quot;https://etcd02:2379,https://etcd03:2379,https://etcd01:2379&quot; --cacert=etcd-ca.crt --cert=etcd02.crt --key=etcd02.key endpoint status --write-out=table</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| https://etcd02:2379 | f0e17e8a11ca95f3 |   3.5.5 |   20 kB |     false |      false |         2 |          8 |                  8 |        |</span><br><span class="line">| https://etcd03:2379 | ba673fc8f108eb32 |   3.5.5 |   20 kB |     false |      false |         2 |          8 |                  8 |        |</span><br><span class="line">| https://etcd01:2379 | afd02c09f31c7a3e |   3.5.5 |   20 kB |      true |      false |         2 |          8 |                  8 |        |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure><h1 id="Kubernetes二进制下载"><a href="#Kubernetes二进制下载" class="headerlink" title="Kubernetes二进制下载"></a>Kubernetes二进制下载</h1><p>下载地址：<a href="https://dl.k8s.io/v1.23.6/kubernetes-server-linux-amd64.tar.gz">https://dl.k8s.io/v1.23.6/kubernetes-server-linux-amd64.tar.gz</a></p><p>将server二进制包下载并上传至master节点上或直接使用wget下载亦可</p><h1 id="Master节点部署"><a href="#Master节点部署" class="headerlink" title="Master节点部署"></a>Master节点部署</h1><h2 id="apiServer组件部署"><a href="#apiServer组件部署" class="headerlink" title="apiServer组件部署"></a>apiServer组件部署</h2><p>先查看adm方式部署生成的配置参数进行参考</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- kube-apiserver</span><br><span class="line">- --advertise-address=192.168.64.11</span><br><span class="line">- --allow-privileged=true</span><br><span class="line">- --authorization-mode=Node,RBAC</span><br><span class="line">- --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">- --enable-admission-plugins=NodeRestriction</span><br><span class="line">- --enable-bootstrap-token-auth=true</span><br><span class="line">- --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">- --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class="line">- --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br><span class="line">- --etcd-servers=https://127.0.0.1:2379</span><br><span class="line">- --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br><span class="line">- --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span><br><span class="line">- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname                 </span><br><span class="line">- --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span><br><span class="line">- --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span><br><span class="line">- --requestheader-allowed-names=front-proxy-client</span><br><span class="line">- --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">- --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">- --requestheader-group-headers=X-Remote-Group</span><br><span class="line">- --requestheader-username-headers=X-Remote-User</span><br><span class="line">- --secure-port=6443</span><br><span class="line">- --service-account-issuer=https://kubernetes.default.svc.cluster.local</span><br><span class="line">- --service-account-key-file=/etc/kubernetes/pki/sa.pub</span><br><span class="line">- --service-account-signing-key-file=/etc/kubernetes/pki/sa.key</span><br><span class="line">- --service-cluster-ip-range=192.12.0.0/16</span><br><span class="line">- --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">- --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br></pre></td></tr></table></figure><p>稍微对adm的apiserver配置进行修改即可使用</p><h3 id="创建Kubernetes-Ca"><a href="#创建Kubernetes-Ca" class="headerlink" title="创建Kubernetes Ca"></a>创建Kubernetes Ca</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]#</span><br><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# cat ca.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:kubernetes</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout ca.key -out ca.csr -nodes -subj &#x27;/CN=kubernetes&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -days 36500 -sha256 -extfile ca.cnf -extensions v3_ca -set_serial 0 -signkey ca.key -in ca.csr -out ca.crt</span><br><span class="line">[root@master kubernetes]# ls</span><br><span class="line">ca.cnf  ca.crt  ca.csr  ca.key</span><br></pre></td></tr></table></figure><h3 id="创建签发apiServer组件证书"><a href="#创建签发apiServer组件证书" class="headerlink" title="创建签发apiServer组件证书"></a>创建签发apiServer组件证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# vi apiserver.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:master, IP:127.0.0.1, IP:192.168.64.31</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout apiserver.key -out apiserver.csr -nodes -subj &#x27;/CN=kube-apiserver&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile apiserver.cnf -extensions v3_req -in apiserver.csr -CA ca.crt -CAkey ca.key -out apiserver.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls api*</span><br><span class="line">apiserver.cnf  apiserver.crt  apiserver.csr  apiserver.key</span><br></pre></td></tr></table></figure><h3 id="创建签发etcd-client证书"><a href="#创建签发etcd-client证书" class="headerlink" title="创建签发etcd-client证书"></a>创建签发etcd-client证书</h3><p>etcd因为部署在Node节点上，所以要把etcd-ca拷贝到master上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# mkdir etcd</span><br><span class="line">[root@master kubernetes]# cd etcd/</span><br><span class="line">[root@master etcd]# scp node01:/etc/etcd/etcd-ca* .</span><br><span class="line">etcd-ca.cnf                                                   100%  172   232.1KB/s   00:00</span><br><span class="line">etcd-ca.crt                                                   100% 1090     2.1MB/s   00:00</span><br><span class="line">etcd-ca.csr                                                   100%  887     1.8MB/s   00:00</span><br><span class="line">etcd-ca.key                                                   100% 1708     3.2MB/s   00:00</span><br><span class="line">[root@master etcd]# vi apiserver-etcd-client.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master etcd]# openssl req -new -newkey rsa:2048 -keyout apiserver-etcd-client.key -out apiserver-etcd-client.csr -nodes -subj &#x27;/O=system:masters/CN=kube-apiserver-etcd-client&#x27;</span><br><span class="line">[root@master etcd]# openssl x509 -req -sha256 -days 36500 -extfile apiserver-etcd-client.cnf -extensions v3_req -in apiserver-etcd-client.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out apiserver-etcd-client.crt -CAcreateserial</span><br><span class="line">[root@master etcd]# ls api*</span><br><span class="line">apiserver-etcd-client.cnf  apiserver-etcd-client.crt  apiserver-etcd-client.csr  apiserver-etcd-client.key</span><br></pre></td></tr></table></figure><h3 id="创建签发kubelet组件证书"><a href="#创建签发kubelet组件证书" class="headerlink" title="创建签发kubelet组件证书"></a>创建签发kubelet组件证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# cd ..</span><br><span class="line">[root@master kubernetes]# vi apiserver-kubelet-client.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout apiserver-kubelet-client.key -out apiserver-kubelet-client.csr -nodes -subj &#x27;/O=system:masters/CN=kube-apiserver-kubelet-client&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile apiserver-kubelet-client.cnf -extensions v3_req -in apiserver-kubelet-client.csr -CA ca.crt -CAkey ca.key -out apiserver-kubelet-client.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls apiserver-kubelet-client*</span><br><span class="line">apiserver-kubelet-client.cnf  apiserver-kubelet-client.crt  apiserver-kubelet-client.csr  apiserver-kubelet-client.key</span><br></pre></td></tr></table></figure><h3 id="创建front-proxy-ca"><a href="#创建front-proxy-ca" class="headerlink" title="创建front-proxy-ca"></a>创建front-proxy-ca</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# vi front-proxy-ca.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:front-proxy-ca</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout front-proxy-ca.key -out front-proxy-ca.csr -nodes -subj &#x27;/CN=front-proxy-ca&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -days 36500 -sha256 -extfile front-proxy-ca.cnf -extensions v3_ca -set_serial 0 -signkey front-proxy-ca.key -in front-proxy-ca.csr -out front-proxy-ca.crt</span><br></pre></td></tr></table></figure><h3 id="创建front-proxy-client"><a href="#创建front-proxy-client" class="headerlink" title="创建front-proxy-client"></a>创建front-proxy-client</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# vi front-proxy-client.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout front-proxy-client.key -out front-proxy-client.csr -nodes -subj &#x27;/CN=front-proxy-client&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile front-proxy-client.cnf -extensions v3_req -in front-proxy-client.csr -CA front-proxy-ca.crt -CAkey front-proxy-ca.key -out front-proxy-client.crt -CAcreateserial</span><br></pre></td></tr></table></figure><h3 id="创建密钥对"><a href="#创建密钥对" class="headerlink" title="创建密钥对"></a>创建密钥对</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# openssl genrsa -out sa.key</span><br><span class="line">[root@master kubernetes]# openssl rsa -in sa.key -pubout -out sa.pub</span><br></pre></td></tr></table></figure><h3 id="配置apiServer"><a href="#配置apiServer" class="headerlink" title="配置apiServer"></a>配置apiServer</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ls</span><br><span class="line">anaconda-ks.cfg  kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# tar xf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kube-apiserver /usr/local/sbin/</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kubectl /usr/local/sbin/</span><br><span class="line">[root@master ~]# vi /lib/systemd/system/apiserver.service</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意注释只是需要注意的点，不要把注释写到文件中，确保\后面没有空格，否则可能会报错</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line">[Unit]</span><br><span class="line">Description=apiServer</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-apiserver \</span><br><span class="line">  --advertise-address=192.168.64.31 \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --enable-admission-plugins=NodeRestriction \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/etcd/etcd-ca.crt \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/etcd/apiserver-etcd-client.crt \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/etcd/apiserver-etcd-client.key \</span><br><span class="line">  --etcd-servers=https://etcd01:2379,https://etcd02:2379,https://etcd03:2379 \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/apiserver-kubelet-client.crt \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/apiserver-kubelet-client.key \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/sa.key \</span><br><span class="line">  --service-cluster-ip-range=172.12.0.0/16 \# Service地址</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/apiserver.crt \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/apiserver.key \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/front-proxy-client.crt \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/front-proxy-client.key \</span><br><span class="line">  --requestheader-allowed-names=front-proxy-client \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/front-proxy-ca.crt \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl enable --now apiserver</span><br><span class="line">[root@master ~]# systemctl status apiserver</span><br><span class="line">● apiserver.service - apiServer</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2022-09-18 16:36:41 CST; 37s ago</span><br><span class="line"> Main PID: 14714 (kube-apiserver)</span><br><span class="line">    Tasks: 11 (limit: 23494)</span><br><span class="line">   Memory: 239.9M</span><br><span class="line">   CGroup: /system.slice/apiserver.service</span><br><span class="line">           └─14714 /usr/local/sbin/kube-apiserver --advertise-address=192.168.64.31</span><br><span class="line">[root@master ~]# ss -lntp</span><br><span class="line">State                   Recv-Q                  Send-Q                                   Local Address:Port                                   Peer Address:Port                 Process</span><br><span class="line">LISTEN                  0                       128                                            0.0.0.0:22                                          0.0.0.0:*                     users:((&quot;sshd&quot;,pid=960,fd=5))</span><br><span class="line">LISTEN                  0                       128                                               [::]:22                                             [::]:*                     users:((&quot;sshd&quot;,pid=960,fd=7))</span><br><span class="line">LISTEN                  0                       128                                                  *:6443                                              *:*                     users:((&quot;kube-apiserver&quot;,pid=14714,fd=7))</span><br></pre></td></tr></table></figure><h2 id="CM组件部署"><a href="#CM组件部署" class="headerlink" title="CM组件部署"></a>CM组件部署</h2><p>查看通过adm部署生成Controller-Manager配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kube-controller-manager</span><br><span class="line">    - --allocate-node-cidrs=true</span><br><span class="line">    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">    - --bind-address=127.0.0.1</span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --cluster-cidr=192.11.0.0/16# Pod地址</span><br><span class="line">    - --cluster-name=kubernetes</span><br><span class="line">    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span><br><span class="line">    - --controllers=*,bootstrapsigner,tokencleaner</span><br><span class="line">    - --kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">    - --leader-elect=true</span><br><span class="line">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt# 可不需要</span><br><span class="line">    - --root-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key</span><br><span class="line">    - --service-cluster-ip-range=192.12.0.0/16</span><br><span class="line">    - --use-service-account-credentials=true</span><br></pre></td></tr></table></figure><h3 id="创建CM证书"><a href="#创建CM证书" class="headerlink" title="创建CM证书"></a>创建CM证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# vi controller-manager.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout controller-manager.key -out controller-manager.csr -nodes -subj &#x27;/CN=system:kube-controller-manager&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile controller-manager.cnf -extensions v3_req -in controller-manager.csr -CA ca.crt -CAkey ca.key -out controller-manager.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls controller-manager*</span><br><span class="line">controller-manager.cnf  controller-manager.crt  controller-manager.csr  controller-manager.key</span><br></pre></td></tr></table></figure><h3 id="创建config文件"><a href="#创建config文件" class="headerlink" title="创建config文件"></a>创建config文件</h3><blockquote><p>kubectl config 用于设置kubeconfig并生成kubeconfig文件</p><p>此文件保存kubernetes根证书，cm证书密钥，apiserver组件地址等信息</p></blockquote><p>文件格式可参考：<a href="https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/">https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/</a> 最后一节，固定格式，需要通过命令的方式填写相关参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \# 指定kubernetes CA证书并</span><br><span class="line">--embed-certs=true \# 将证书导入此文件</span><br><span class="line">--server=https://192.168.64.31:6443 \# 指定apiserver组件地址</span><br><span class="line">--kubeconfig=controller-manager.conf# 将上述配置生成到controller-manager.conf文件</span><br><span class="line">======================================================================================================</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置凭证信息  system:kube-controller-manager是依据证书中的CN字段配置的，需要保证一致</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">--client-certificate=controller-manager.crt \# 指定cm证书</span><br><span class="line">--client-key=controller-manager.key \# 指定cm私钥</span><br><span class="line">--embed-certs=true \# 将证书导入此文件</span><br><span class="line">--kubeconfig=controller-manager.conf# 将上述配置生成到controller-manager.conf文件</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-context system:kube-controller-manager \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-controller-manager \</span><br><span class="line">--kubeconfig=controller-manager.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config use-context system:kube-controller-manager \</span><br><span class="line">--kubeconfig=controller-manager.conf</span><br><span class="line"></span><br><span class="line">=======================================================================================================</span><br><span class="line">[root@master kubernetes]# cat controller-manager.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURBRENDQWVpZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFEREFwcmRXSmwKY201bGRHVnpNQ0FYRFRJeU1Ea3hPREEzTlRBek0xb1lEekl4TWpJd09ESTFNRGMxTURNeldqQVZNUk13RVFZRApWUVFEREFwcmRXSmxjbTVsZEdWek1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBCjBPd0ZpUDNPTjFyNytQSWkxQzZmQndkNm9hR2tGRWFQU0tuU3hlMmE1VHBxUElJUU1UMUJjb0xWNFRBTG15WksKYW01VWYxN1JpbU1SUU9FekdxaTdORmU2YXlWWGcvTzFnZkJFNUcwVWcxcXlobkhGZ1p6YlhOUlozZXJPNkVZbAp6SC81U1ZMYStUeHRVa0lBZlBRQ3JVY1RmMmV1NHVleGFvcE1sY3pJSFNHMDhTVmFTT2psZks2VHJSUXVqcHduClVNcXE5MytublhrcHBwVVg3VVpSL0NkT1c0VGFzN2ZWc2thL0ZRNlltTWRPK3NXcTVlYXpIcVlxMjV3c044aXQKV011Y0JRSEpQZUdOVHFSRUJxZlpabXNab05ZNFgwM3Azb1JFS1NHM0ZoVkxBUEtaNGNFZG5LVng4eFVaNkVrVApQdDh4am9EaW9mQ1pyY3ZsdW1DRmJ3SURBUUFCbzFrd1Z6QU9CZ05WSFE4QkFmOEVCQU1DQXFRd0R3WURWUjBUCkFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVVHMGptODNaM2pneExWeVVLVnVaSVVkN3hCdkF3RlFZRFZSMFIKQkE0d0RJSUthM1ZpWlhKdVpYUmxjekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBUUVJTkJEU0xCTkVTMkhFOApEekR4UHlRc29uNForeUtydUpsWXRXQm40aGRkK2sxY05WRTF3dDhkZnhKNjF3S2l4S0NUVTBsNmlleXBqbWFZCkMvQUNsdHFsZXQwV0dtNFhITnp1d1crYWhPa25HQlpZZ2d3czZMbktqbjYxMEFmaGtKZlo2UUJreGM5cko5NEMKV1VuUTJlUVlmdlZmVHA1MUJLRWVJU3FUVkRtcktkK0xQcXRyQ0ZydnYwZGlVYU5GZ0tVSnpwVmt4Qzhsb3BYdQpTTlJwTi8wamwyYjRLUkV6MjlGamlFaEgrbXZ5ek5GREN4d2RPQVcySWorekFOS3pva2szM2ZjTTE1cGsxb0VlCnBRRllTRUlaQ09xaDFoMmtUZlpPaFNDdGpLZVVaMlFRUStkSjZndExUcUFWVjJqZFJHTkFoTE9XWWJWeGIzak0KUTFzSDR3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    server: https://192.168.64.31:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: system:kube-controller-manager</span><br><span class="line">  name: system:kube-controller-manager</span><br><span class="line">current-context: system:kube-controller-manager</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: system:kube-controller-manager</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURKRENDQWd5Z0F3SUJBZ0lVRTJQV1JlRGphaVRTaS9aeENXYkRWdUd0T2w4d0RRWUpLb1pJaHZjTkFRRUwKQlFBd0ZURVRNQkVHQTFVRUF3d0thM1ZpWlhKdVpYUmxjekFnRncweU1qQTVNVGd4TURJeE5USmFHQTh5TVRJeQpNRGd5TlRFd01qRTFNbG93S1RFbk1DVUdBMVVFQXd3ZWMzbHpkR1Z0T210MVltVXRZMjl1ZEhKdmJHeGxjaTF0CllXNWhaMlZ5TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF6S2NYalNtNkE0RDAKUCthMUpkR0plK3Y3anczZFUzVHlSMjNOWHhHQ21xOUZ3T0hoN0xCWXcrSjNMcXlEdHZ6aCszbTRpTXZnRjFFegpSeWMwT3JCWUdFT0FPcE91NlFyc2ZoaDEvS29vek1Wa0xmc0pJT0UyTWlzdDh3YVBxS1dFVCtiY2l3QXV5MEdlCmk0QVdjTWhpYWw0ZzlyNmJWNHBCRTdSbHBFaDN6WUh1QWJ4NndyY2FuOWpGVGNGbmM1TlMzdlBidmdqQzN2QXEKTmI2L253dWZENUpnS3hwZGRHc1JiZHNFL0NZQkNqQzNMTFFvSUM5eDBMa09zVEZjdmFwbk4zZmFqaDd1bUxGcAoyMTkySHdvTmNvNGQwbitpbkJSYU8yN3QxdXVHL1hMT2ZzUmQ5ZjVMckFyQzYxbHhFZ0dsbkt4M21yRG1rUmxUCmZsN1FCc0NTclFJREFRQUJvMVl3VkRBT0JnTlZIUThCQWY4RUJBTUNCYUF3RXdZRFZSMGxCQXd3Q2dZSUt3WUIKQlFVSEF3SXdEQVlEVlIwVEFRSC9CQUl3QURBZkJnTlZIU01FR0RBV2dCUWJTT2J6ZG5lT0RFdFhKUXBXNWtoUgozdkVHOERBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWdmd2txK0JnQ0VMdDN0djgzbmFDbGE4dFVKWEdGVHNSCjZ4OVFkWWFYVnVLQkxBTU1xdm1xUDdEeE9oc1FzeEpzVXF2N2lnRmN1ZE92c0lONjlvcDhVeHFiejlEalZPTTAKSnY1c1F3RmxkMGt6WEUyelJERXZyUVlDL0VJbVZiMUFpRjhsZ1RvL3JtR3JuYkxZeDMxRURxeTJsV2Z1eVJaQgpFdTFMQkRUQkRYZEJxSDcyc0NzQmh1c1l3SkU4R2NDQWUvSkJZU0pyaXhQYUt4NDZRaGRqUVNUT3RGQ0ptcTZrCmx6RElFMXcxS0srNjdBREVKaFpWTFoyd01TYXd3R2hCOENOcGNwTDZpdFBOUEpUc1JPU1JZemZTVmg4dmlHNDQKTDJZTUYyQ0xCY0tQa2Z4SzVnaUNlT3A1cTVQTFp3WUlpNU05R1lsTGJXN0dVRWEvajQ3cnlBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2d0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktrd2dnU2xBZ0VBQW9JQkFRRE1weGVOS2JvRGdQUS8KNXJVbDBZbDc2L3VQRGQxVGRQSkhiYzFmRVlLYXIwWEE0ZUhzc0ZqRDRuY3VySU8yL09IN2ViaUl5K0FYVVROSApKelE2c0ZnWVE0QTZrNjdwQ3V4K0dIWDhxaWpNeFdRdCt3a2c0VFl5S3kzekJvK29wWVJQNXR5TEFDN0xRWjZMCmdCWnd5R0pxWGlEMnZwdFhpa0VUdEdXa1NIZk5nZTRCdkhyQ3R4cWYyTVZOd1dkemsxTGU4OXUrQ01MZThDbzEKdnIrZkM1OFBrbUFyR2wxMGF4RnQyd1Q4SmdFS01MY3N0Q2dnTDNIUXVRNnhNVnk5cW1jM2Q5cU9IdTZZc1duYgpYM1lmQ2cxeWpoM1NmNktjRkZvN2J1M1c2NGI5Y3M1K3hGMzEva3VzQ3NMcldYRVNBYVdjckhlYXNPYVJHVk4rClh0QUd3Skt0QWdNQkFBRUNnZ0VBUE1mRGJ1RmRwWHkvRGR0dklYUkI2TlFGT2s5YjFGVi9QMGVWSHc4TVF2U2IKT3RYYlMzaDBaSGoxL0o2djM4RHJQTXpCeVo4RFJ1bU8yU3NEa0FxZm4xVXMyRGpVVWRJMHVwNTVMRGs5Tk5QTApGUHpoa1NwUjlrUnN1U2pSc2J5MnR5UlJpOWJhRHZQR0twZzRFZmJ4ZzdYQkJJZEhpNUE4RTZZWUtkcDcra1I3CjRKL3IyOWI4d3g3cTExaSsyaU82WFVCc1NTd1M4aEVNNjZyY0RkVXlQclVOc25FTzRQY043Q1o2RUFCV3U2Zi8KajZ0am5tM2NWRk9qeHQ3dU9TV3RkUnA5cHJzc2RsNzhndkRJaUlpT3JEV09XN2lVRk1HNFYrYy9EYWdGZXZ1SwpFQlNsdExicnVWWlRrOU50VWlJZ3QxTDRGZlN5bmgxV1hIcnRWREx5NFFLQmdRRDdza3lPcGpaL3lyZzZkcGsxCmY1WnpWQmxyTHdYL28xZGRFYUZ1R3JMVXN2bmszaFVkUjBTNU82d254TjdOZEg5a2RGY3d4UGpyOHNTYlpUTlYKbVI1RXV5NUUydVJzSmcrMDUrQlJGU0F0amVxWHZFY0ZGWUEvSEdGK1RRUjgwWmRSY1RCNjlvUDdHd0hrbUloZgpjWDVYeUJ0QzQ4UVh1T0RPQy9CTHk4RjNQd0tCZ1FEUUp1Q291Sng2N0ZVUzZhRG44ZzlWS2xSNWV6bUhMVHdDCnZiMEx2MERuajczaHlxdGdJdmg3dDl3VVh3VUk2d3J0bTdSY1YrNkVKNXYxaHF0ZEFFenFlTkRjZnowMENlUjcKeXBvSkNHMFlINEdiOUt1RW42WlkzVEN5dGErbkhyRUV2VFRtK25pN0M3R3VobjRqOTZScEt4MWQxK2F5bTlNOQpxY0tyTEY0SEV3S0JnUUNKWUNXODdpZHMxSDU5R21KQSt1UnBDZ3Zkbm9yTm5wOStZck1UWDJzZ0FKZTRQU2FWCkZtTUNIdm0xc3hSUVd6ZDA0ckw4SVdZamtodVJIVWxKZlFzeVJGL2FvUVp2cU02RjFORndML0dpSzRWUlVDZ0wKTkZNTkh6WnZNeVl4NGt1TzNoS3g2bjdhdlVEcFBmK2c2RmNuSGtjUzJUSWNLSUk2cy9WeHlVSk5EUUtCZ1FDZQphR2ZpbnhRZkRFbzJLV3hWK0VZbzV4MEFrb0dXV1J0cGJxSTNGV2E4a3d6TGorUmFObUxxTEdNbGNhYXdRY2ZBClNoVzVqUVdzdDBRZVYwMkVhbDBldDdFampRV3oyNjl4Y2g5RnJvN3ZvOUtNTUdoemR0Z3VtcTZiNGw3NkRRWmsKZCtXUnZwNHdvdGFtM2gyVEc3eVllTUpSajZRMjJ4V293TSt3V3dSMzF3S0JnUUN0MnhZRGR2Ly9BNWZ2UmNXKwpQZzVJdzZPWThkbGw5Wmgra1dIaDdlMXFRU3l6OTVsa3BYWTZDTms1Vjl5WTFjaWpYanpKWENGWnRtWTBvUk1TCi9rMmkxbW10N3UrUFV4SzdrV1hrUDNBWExTMC9JU1dWNWlBTVlQZTZRd0pmT2llSmxjNC9wVWR3R1Q5aUhrL3EKN1duOEZ6SVJ2WC9wcTZ5MEh5QlVxbXg0SEE9PQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==</span><br></pre></td></tr></table></figure><h3 id="配置CM"><a href="#配置CM" class="headerlink" title="配置CM"></a>配置CM</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# cd</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kube-controller-manager /usr/local/sbin/</span><br><span class="line">[root@master ~]# vi /lib/systemd/system/controller-manager.service</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意注释只是需要注意的点，不要把注释写到文件中，确保\后面没有空格，否则可能会报错</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line">[Unit]</span><br><span class="line">Description=ControllerManager</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-controller-manager \</span><br><span class="line">  --allocate-node-cidrs=true \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf \</span><br><span class="line">  --bind-address=127.0.0.1 \# cm不需要外部访问</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --cluster-cidr=172.11.0.0/16\# Pod地址</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/ca.key \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/controller-manager.conf \</span><br><span class="line">  --leader-elect=true \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/front-proxy-ca.crt \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/sa.key \</span><br><span class="line">  --service-cluster-ip-range=172.12.0.0/16 \# Service地址</span><br><span class="line">  --use-service-account-credentials=true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master kubernetes]# systemctl daemon-reload</span><br><span class="line">[root@master kubernetes]# systemctl enable --now controller-manager.service</span><br></pre></td></tr></table></figure><h2 id="Scheduler组件部署"><a href="#Scheduler组件部署" class="headerlink" title="Scheduler组件部署"></a>Scheduler组件部署</h2><p>通过查看adm生成配置获得如下参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kube-scheduler</span><br><span class="line">    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line">    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line">    - --bind-address=127.0.0.1</span><br><span class="line">    - --kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line">    - --leader-elect=true</span><br></pre></td></tr></table></figure><h3 id="创建Scheduler证书"><a href="#创建Scheduler证书" class="headerlink" title="创建Scheduler证书"></a>创建Scheduler证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# vi scheduler.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout scheduler.key -out scheduler.csr -nodes -subj &#x27;/CN=system:kube-scheduler&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile scheduler.cnf -extensions v3_req -in scheduler.csr -CA ca.crt -CAkey ca.key -out scheduler.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls scheduler.*</span><br><span class="line">scheduler.cnf  scheduler.crt  scheduler.csr  scheduler.key</span><br></pre></td></tr></table></figure><h3 id="创建config文件-1"><a href="#创建config文件-1" class="headerlink" title="创建config文件"></a>创建config文件</h3><blockquote><p>与CM的config一致就是部分名字文件需要更改</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@master kubernetes]# kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">--client-certificate=scheduler.crt \</span><br><span class="line">--client-key=scheduler.key \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-context system:kube-scheduler \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-scheduler \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config use-context system:kube-scheduler \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br></pre></td></tr></table></figure><h3 id="配置Scheduler"><a href="#配置Scheduler" class="headerlink" title="配置Scheduler"></a>配置Scheduler</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@master kubernetes]# vi /lib/systemd/system/scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Scheduler</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-scheduler \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/scheduler.conf \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/scheduler.conf \</span><br><span class="line">  --bind-address=127.0.0.1 \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/scheduler.conf \</span><br><span class="line">  --leader-elect=true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master kubernetes]# cd</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kube-scheduler /usr/local/sbin/</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl restart scheduler.service</span><br></pre></td></tr></table></figure><h2 id="Admin文件生成"><a href="#Admin文件生成" class="headerlink" title="Admin文件生成"></a>Admin文件生成</h2><p>用于kubectl连接集群</p><h3 id="创建admin证书"><a href="#创建admin证书" class="headerlink" title="创建admin证书"></a>创建admin证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# vi admin.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout admin.key -out admin.csr -nodes -subj &#x27;/CN=kubernetes-admin/O=system:masters&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile admin.cnf -extensions v3_req -in admin.csr -CA ca.crt -CAkey ca.key -out admin.crt -CAcreateserial</span><br></pre></td></tr></table></figure><h3 id="配置config文件"><a href="#配置config文件" class="headerlink" title="配置config文件"></a>配置config文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=admin.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@master kubernetes]# kubectl config set-credentials kubernetes-admin \</span><br><span class="line">--client-certificate=admin.crt \</span><br><span class="line">--client-key=admin.key \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-context kubernetes-admin \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kubernetes-admin \</span><br><span class="line">--kubeconfig=admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config use-context kubernetes-admin \</span><br><span class="line">--kubeconfig=admin.conf</span><br></pre></td></tr></table></figure><h3 id="测试Admin"><a href="#测试Admin" class="headerlink" title="测试Admin"></a>测试Admin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# echo &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt; /etc/profile</span><br><span class="line">[root@master kubernetes]# export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">[root@master kubernetes]# kubectl get node</span><br><span class="line">No resources found</span><br><span class="line">[root@master kubernetes]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure><h1 id="Node节点部署"><a href="#Node节点部署" class="headerlink" title="Node节点部署"></a>Node节点部署</h1><p><strong>Node只演示一个节点的部署</strong></p><p>下载地址：<a href="https://dl.k8s.io/v1.23.6/kubernetes-node-linux-amd64.tar.gz">https://dl.k8s.io/v1.23.6/kubernetes-node-linux-amd64.tar.gz</a></p><p>将node二进制包下载并上传至所有node节点上或直接使用wget下载亦可</p><h2 id="Kubelet组件部署"><a href="#Kubelet组件部署" class="headerlink" title="Kubelet组件部署"></a>Kubelet组件部署</h2><p>查看通过adm部署的Node节点配置</p><p>adm部署的方式Node节点是采用config方式进行认证的，二进制通常使用kubelet-bootstrap进行认证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 kubernetes]# tree</span><br><span class="line">.</span><br><span class="line">├── kubelet.conf# config文件</span><br><span class="line">├── manifests</span><br><span class="line">└── pki</span><br><span class="line">    └── ca.crt# kubernetesCA证书</span><br><span class="line">    </span><br><span class="line">[root@node01 kubernetes]# cat kubelet.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3hOekV3TWpBd05Gb1hEVE15TURreE5ERXdNakF3TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS1NRCkVScnRRUHBPNzE0VGVueEQ5ZUZ0d25tNFFWWG56L1liUE5MNE5VdXdmcUNPTVg1MGJNTWxiblkya3poZmlSSmQKSWxVK3o4RVYrZGJ6WDJUd0JUWGRxN1pOeDFxdmx2bFpuZDlUY21Zd3l6eUpCRUROVjdmMG9lYWxUSUIwMGVRYQovYjFWeStPL1I0NUhuY3VXUDhMc2lwV3J5U3I1WjRpcnkvVmIrbnB4T2xVeXpTL3BtdVhBTmdGUGVpL0w3MUlpCkxha0NlNmZNRCtMMHpGektCdGVVeVpuWWZMOWxyVm0xeG1QUjVFdkdZN2NaNTl3YmtqbW94VGE1bjdVTzR6SjgKZndiak5oNHVLVzdqOHpvajVTWTJBMEZIZ0RSbnY5NlFxVk5SSkIraGMrRDBrTE1EdmRHcUM0QVpaUzJDbUNLUQpBTUZGUUlGSDIyMCtBRngvNGM4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDdjNSOHRCVEttMDJwTVlNT0RxRUg0eEpnUktNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBR3hwamdwcjVOZmxxMkJBZC9vdQpTQW14WDIyVi9XTmJZZDNDYVA2dVAwY2F3QXdWMm8xY3lucjNwVk9reG8xaDZ6UjBPWkdvNEJpc2tlWUJKUHNkCjdjeVhwRGVseDh2b2QvUjc1NUQ5TmcwOWUybFlSQWlmSE9NZXkvbjdYb0JLNWNRUk9KUWtmZmxvYWFBRFZsNlAKdVBSNXJhUWd0c0hIZUUwVy9hTitqVTQrby92VFJ4TnZzdUtERVpXY1pyYnBOOUJRZjVGc09vRTAyV25XRi9uUQpVOXNwVjlmanJVU0I5MFhqTG1GdDRFUW1ucm5JWjRjMU42TnJqQ0szTk1NdFlidFE2VXo2M3FDVzRtZmRoK3FFCi9DcmVHTTR1T1JLMnBjVjYwYlFHOVhTOFVDWXc4bWN1SVFuTlRpc05NaXMwbCtkelV1Ui9qYVJZS1EydEdaMTAKWlVJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://192.168.64.11:6443</span><br><span class="line">  name: default-cluster</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: default-cluster</span><br><span class="line">    namespace: default</span><br><span class="line">    user: default-auth</span><br><span class="line">  name: default-context</span><br><span class="line">current-context: default-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: default-auth</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem</span><br><span class="line">    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem</span><br></pre></td></tr></table></figure><p><strong>启动文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结构</span></span><br><span class="line">/lib/systemd/system/</span><br><span class="line">└── kubelet.service</span><br><span class="line">└── kubelet.service.d</span><br><span class="line">    └── 10-kubeadm.conf</span><br><span class="line">[root@node01 kubernetes]# cat /lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=kubelet: The Kubernetes Node Agent</span><br><span class="line">Documentation=https://kubernetes.io/docs/</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/kubelet</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target  </span><br><span class="line">[root@node01 kubernetes]# cat /lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br><span class="line">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a file that <span class="string">&quot;kubeadm init&quot;</span> and <span class="string">&quot;kubeadm join&quot;</span> generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a file that the user can use <span class="keyword">for</span> overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the .NodeRegistration.KubeletExtraArgs object <span class="keyword">in</span> the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet# 空，可以删掉</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node01 kubernetes]# cat /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">KUBELET_KUBEADM_ARGS=&quot;--network-plugin=cni --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot;</span><br></pre></td></tr></table></figure><p><strong>通过分析上述等文件汇总成如下</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=kubelet</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kubelet \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf </span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.conf</span><br><span class="line">  --config=/var/lib/kubelet/config.yaml</span><br><span class="line">  --network-plugin=cni </span><br><span class="line">  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="apiServer配置"><a href="#apiServer配置" class="headerlink" title="apiServer配置"></a>apiServer配置</h3><p>通过参考adm部署方式参考的apiServer配置文件还不支持bootstrap方式认证，需要添加如下参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--token-auth-file=/etc/kubernetes/token.csv</span><br><span class="line">--enable-bootstrap-token-auth=true</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota</span><br></pre></td></tr></table></figure><h4 id="生成token"><a href="#生成token" class="headerlink" title="生成token"></a>生成token</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# openssl rand -hex 10</span><br><span class="line">370e9b286ef7528dc199</span><br><span class="line">[root@master kubernetes]# echo &#x27;370e9b286ef7528dc199,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;&#x27; &gt; /etc/kubernetes/token.csv</span><br><span class="line">[root@master kubernetes]# cat /etc/kubernetes/token.csv</span><br><span class="line">370e9b286ef7528dc199,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br></pre></td></tr></table></figure><h4 id="新增apiServer参数"><a href="#新增apiServer参数" class="headerlink" title="新增apiServer参数"></a>新增apiServer参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vi /lib/systemd/system/apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=apiServer</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-apiserver \</span><br><span class="line">  --advertise-address=192.168.64.31 \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --enable-admission-plugins=NodeRestriction \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/etcd/etcd-ca.crt \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/etcd/apiserver-etcd-client.crt \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/etcd/apiserver-etcd-client.key \</span><br><span class="line">  --etcd-servers=https://etcd01:2379,https://etcd02:2379,https://etcd03:2379 \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/apiserver-kubelet-client.crt \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/apiserver-kubelet-client.key \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/sa.key \</span><br><span class="line">  --service-cluster-ip-range=172.12.0.0/16 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/apiserver.crt \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/apiserver.key \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/front-proxy-client.crt \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/front-proxy-client.key \</span><br><span class="line">  --requestheader-allowed-names=front-proxy-client \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/front-proxy-ca.crt \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --token-auth-file=/etc/kubernetes/token.csv \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl restart apiserver</span><br><span class="line">[root@master ~]# systemctl restart controller-manager</span><br><span class="line">[root@master ~]# systemctl restart scheduler</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#########################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建集群角色</span></span><br><span class="line">[root@master ~]# kubectl create clusterrolebinding kubelet-bootstrap1 --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure><h3 id="配置Kubelet"><a href="#配置Kubelet" class="headerlink" title="配置Kubelet"></a>配置Kubelet</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# tar xf kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">[root@node01 ~]# cp kubernetes/node/bin/kubelet /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# mkdir /var/lib/kubelet/</span><br><span class="line">[root@node01 ~]# vi /lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=kubelet</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kubelet \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.conf \</span><br><span class="line">  --config=/var/lib/kubelet/config.yaml \</span><br><span class="line">  --network-plugin=cni \</span><br><span class="line">  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝adm生成config.yaml文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################################################</span></span></span><br><span class="line">[root@node01 ~]# vi /var/lib/kubelet/config.yaml</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.crt# KubernetesCA证书</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 0s</span><br><span class="line">    cacheUnauthorizedTTL: 0s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">clusterDNS:</span><br><span class="line">- 172.12.0.10# 需要注意此DNS地址，Service地址</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">cpuManagerReconcilePeriod: 0s</span><br><span class="line">evictionPressureTransitionPeriod: 0s</span><br><span class="line">fileCheckFrequency: 0s</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 0s</span><br><span class="line">imageMinimumGCAge: 0s</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">logging:</span><br><span class="line">  flushFrequency: 0</span><br><span class="line">  options:</span><br><span class="line">    json:</span><br><span class="line">      infoBufferSize: &quot;0&quot;</span><br><span class="line">  verbosity: 0</span><br><span class="line">memorySwap: &#123;&#125;</span><br><span class="line">nodeStatusReportFrequency: 0s</span><br><span class="line">nodeStatusUpdateFrequency: 0s</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 0s</span><br><span class="line">shutdownGracePeriod: 0s</span><br><span class="line">shutdownGracePeriodCriticalPods: 0s</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 0s</span><br><span class="line">syncFrequency: 0s</span><br><span class="line">volumeStatsAggPeriod: 0s</span><br><span class="line">[root@node01 ~]# mkdir -p /etc/kubernetes/pki/</span><br><span class="line">[root@node01 ~]# mkdir /etc/kubernetes/manifests</span><br><span class="line">[root@node01 ~]# scp master:/etc/kubernetes/ca.crt /etc/kubernetes/pki/</span><br><span class="line">ca.crt                                                       100% 1103     1.9MB/s   00:00</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="创建BootStap文件"><a href="#创建BootStap文件" class="headerlink" title="创建BootStap文件"></a>创建BootStap文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# cp kubernetes/node/bin/kubectl /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# cd /etc/kubernetes/pki/</span><br><span class="line">[root@node01 pki]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@node01 pki]#  kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">--token=370e9b286ef7528dc199 \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config set-context kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kubelet-bootstrap \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config use-context kubernetes \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line">[root@node01 pki]# mv bootstrap-kubelet.conf ../</span><br><span class="line">[root@node01 pki]# cd</span><br><span class="line">[root@node01 ~]#</span><br></pre></td></tr></table></figure><h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# systemctl daemon-reload</span><br><span class="line">[root@node01 ~]# systemctl enable --now kubelet</span><br><span class="line">[root@node01 ~]# systemctl status kubelet</span><br><span class="line">● kubelet.service - kubelet</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2022-09-18 21:03:30 CST; 19s ago</span><br><span class="line"> Main PID: 16226 (kubelet)</span><br><span class="line">    Tasks: 13 (limit: 23494)</span><br><span class="line">   Memory: 29.0M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br></pre></td></tr></table></figure><h3 id="颁发证书"><a href="#颁发证书" class="headerlink" title="颁发证书"></a>颁发证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get csr</span><br><span class="line">NAME        AGE     SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-4qhgh   53s     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Pending</span><br><span class="line">[root@master ~]# kubectl certificate approve csr-4qhgh</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-4qhgh approved</span><br><span class="line">[root@master ~]# kubectl get node</span><br><span class="line">NAME     STATUS     ROLES    AGE     VERSION</span><br><span class="line">node01   NotReady   &lt;none&gt;   11m     v1.23.6</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他节点一样操作，没地方需要改的</span></span><br></pre></td></tr></table></figure><h2 id="KubePorxy组件部署"><a href="#KubePorxy组件部署" class="headerlink" title="KubePorxy组件部署"></a>KubePorxy组件部署</h2><p>KubePorxy在adm方式安装下，文件夹中不存在配置文件等信息，可以通过查看容器获取</p><p><strong>通过查询adm部署的Node中docker容器找到相应的参数</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE                                                           COMMAND                  CREATED        STATUS        PORTS     NAMES</span><br><span class="line">fa420f27a34f   4c0375452406                                                    &quot;/usr/local/bin/kube…&quot;   27 hours ago   Up 27 hours             k8s_kube-proxy_kube-proxy-45hb8_kube-system_70fb18c0-3dd8-4f6c-ac31-7e437189db51_0</span><br><span class="line">ee76bafc7838   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6   &quot;/pause&quot;                 27 hours ago   Up 27 hours             k8s_POD_kube-proxy-45hb8_kube-system_70fb18c0-3dd8-4f6c-ac31-7e437189db</span><br><span class="line">[root@node01 ~]# docker inspect fa420</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;fa420f27a34f2487d242ae06502e969d6b245be2721b016337829b90c89d5d80&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-09-17T10:32:02.250879493Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/usr/local/bin/kube-proxy&quot;,</span><br><span class="line">        &quot;Args&quot;: [</span><br><span class="line">            &quot;--config=/var/lib/kube-proxy/config.conf&quot;,</span><br><span class="line">            &quot;--hostname-override=node01&quot;</span><br><span class="line">...</span><br><span class="line">[root@node01 ~]# docker cp fa:/var/lib/kube-proxy/..data/config.conf .</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">bindAddressHardFail: false</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 0</span><br><span class="line">  contentType: &quot;&quot;</span><br><span class="line">  kubeconfig: /var/lib/kube-proxy/kubeconfig.conf# 还有一个文件也考出来看看</span><br><span class="line">  qps: 0</span><br><span class="line">clusterCIDR: 192.11.0.0/16# Pod地址</span><br><span class="line">configSyncPeriod: 0s</span><br><span class="line">conntrack:</span><br><span class="line">  maxPerCore: null</span><br><span class="line">  min: null</span><br><span class="line">  tcpCloseWaitTimeout: null</span><br><span class="line">  tcpEstablishedTimeout: null</span><br><span class="line">detectLocalMode: &quot;&quot;</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: &quot;&quot;</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;&quot;</span><br><span class="line">  strictARP: false</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">  tcpFinTimeout: 0s</span><br><span class="line">  tcpTimeout: 0s</span><br><span class="line">  udpTimeout: 0s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: &quot;&quot;</span><br><span class="line">mode: &quot;&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: null</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">showHiddenMetricsForVersion: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 0s</span><br><span class="line">winkernel:</span><br><span class="line">  enableDSR: false</span><br><span class="line">  networkName: &quot;&quot;</span><br><span class="line">  sourceVip: &quot;&quot;</span><br><span class="line">[root@node01 ~]# docker cp fa:/var/lib/kube-proxy/..data/kubeconfig.conf .  </span><br><span class="line">[root@node01 ~]# cat kubeconfig.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt# Kubernets Ca证书</span><br><span class="line">    server: https://192.168.64.11:6443</span><br><span class="line">  name: default</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: default</span><br><span class="line">    namespace: default</span><br><span class="line">    user: default</span><br><span class="line">  name: default</span><br><span class="line">current-context: default</span><br><span class="line">users:</span><br><span class="line">- name: default</span><br><span class="line">  user:</span><br><span class="line">    tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过上述信息了解到，KubeProxy有一个配置文件和一个Config文件，Config文件是使用Pod中的SA进行认证的，这里我们二进制方式部署通过证书进行认证</p><h3 id="创建KubeProxy组件证书"><a href="#创建KubeProxy组件证书" class="headerlink" title="创建KubeProxy组件证书"></a>创建KubeProxy组件证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# cd /etc/kubernetes/pki/</span><br><span class="line">[root@node01 pki]# ls</span><br><span class="line">ca.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">之前Copy了Ca的证书用于kubelet，颁发证书还需要私钥</span></span><br><span class="line">[root@node01 pki]# scp master:/etc/kubernetes/ca.key .</span><br><span class="line">ca.key                                                             100% 1704     3.0MB/s   00:00</span><br><span class="line">[root@node01 pki]# ls</span><br><span class="line">ca.crt  ca.key</span><br><span class="line">[root@node01 pki]# vi kube-proxy.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@node01 pki]# openssl req -new -newkey rsa:2048 -keyout kube-proxy.key -out kube-proxy.csr -nodes -subj &#x27;/CN=system:kube-proxy&#x27;</span><br><span class="line">Gen</span><br><span class="line">[root@node01 pki]# openssl x509 -req -sha256 -days 36500 -extfile kube-proxy.cnf -extensions v3_req -in kube-proxy.csr -CA ca.crt -CAkey ca.key -out kube-proxy.crt -CAcreateserial</span><br><span class="line">[root@node01 pki]# ls kube-proxy.*</span><br><span class="line">kube-proxy.cnf  kube-proxy.crt  kube-proxy.csr  kube-proxy.key</span><br></pre></td></tr></table></figure><h3 id="配置config文件-1"><a href="#配置config文件-1" class="headerlink" title="配置config文件"></a>配置config文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 pki]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@node01 pki]# kubectl config set-credentials system:kube-proxy \</span><br><span class="line">--client-certificate=kube-proxy.crt \</span><br><span class="line">--client-key=kube-proxy.key \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config set-context system:kube-proxy \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-proxy \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config use-context system:kube-proxy \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br></pre></td></tr></table></figure><h3 id="配置KubeProxy"><a href="#配置KubeProxy" class="headerlink" title="配置KubeProxy"></a>配置KubeProxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 pki]# cd</span><br><span class="line">[root@node01 ~]# mkdir /etc/cni/net.d -p</span><br><span class="line">[root@node01 ~]# cp kubernetes/node/bin/kube-proxy /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# vi /lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kube-Proxy</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/config.conf \</span><br><span class="line">  --hostname-override=node01</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@node01 ~]# vi /etc/kubernetes/config.conf</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">bindAddressHardFail: false</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 0</span><br><span class="line">  contentType: &quot;&quot;</span><br><span class="line">  kubeconfig: /etc/kubernetes/pki/kubeconfig.conf</span><br><span class="line">  qps: 0</span><br><span class="line">clusterCIDR: 172.11.0.0/16</span><br><span class="line">configSyncPeriod: 0s</span><br><span class="line">conntrack:</span><br><span class="line">  maxPerCore: null</span><br><span class="line">  min: null</span><br><span class="line">  tcpCloseWaitTimeout: null</span><br><span class="line">  tcpEstablishedTimeout: null</span><br><span class="line">detectLocalMode: &quot;&quot;</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: &quot;&quot;</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;&quot;</span><br><span class="line">  strictARP: false</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">  tcpFinTimeout: 0s</span><br><span class="line">  tcpTimeout: 0s</span><br><span class="line">  udpTimeout: 0s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: &quot;&quot;</span><br><span class="line">mode: &quot;&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: null</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">showHiddenMetricsForVersion: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 0s</span><br><span class="line">winkernel:</span><br><span class="line">  enableDSR: false</span><br><span class="line">  networkName: &quot;&quot;</span><br><span class="line">  sourceVip: &quot;&quot;</span><br><span class="line">[root@node01 ~]# systemctl daemon-reload</span><br><span class="line">[root@node01 ~]# systemctl enable --now kube-proxy</span><br><span class="line">[root@node01 ~]# systemctl status kube-proxy.service</span><br><span class="line">● kube-proxy.service - Kube-Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2022-09-18 22:26:45 CST; 1min 6s ago</span><br><span class="line"> Main PID: 26824 (kube-proxy)</span><br><span class="line">    Tasks: 5 (limit: 23494)</span><br><span class="line">   Memory: 10.6M</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br></pre></td></tr></table></figure><p><strong>其他节点的Kube-Proxy直接拷贝Node01所有Kube-Proxy文件即可</strong></p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8S证书分析</title>
      <link href="/archives/fd5f7d86.html"/>
      <url>/archives/fd5f7d86.html</url>
      
        <content type="html"><![CDATA[<h1 id="K8S证书分析"><a href="#K8S证书分析" class="headerlink" title="K8S证书分析"></a>K8S证书分析</h1><h2 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h2><blockquote><p>对证书没有基础的先去补一下，前置知识：<a href="https://www.xiaowangc.com/2022/08/29/openssl/">https://www.xiaowangc.com/2022/08/29/openssl/</a></p></blockquote><p>我们在通过kubeadm方式安装集群后可以在路径<code>/etc/kubernetes</code>目录下发现文件，他们分别是</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# tree</span><br><span class="line">.</span><br><span class="line">├── admin.conf# kubeconfig文件 暂不做说明</span><br><span class="line">├── controller-manager.conf# kubeconfig文件 暂不做说明</span><br><span class="line">├── kubelet.conf# kubeconfig文件 暂不做说明</span><br><span class="line">├── manifests</span><br><span class="line">│   ├── etcd.yaml# ETCD配置文件</span><br><span class="line">│   ├── kube-apiserver.yaml# apiserver配置文件</span><br><span class="line">│   ├── kube-controller-manager.yaml# CM配置文件</span><br><span class="line">│   └── kube-scheduler.yaml# scheduler配置文件</span><br><span class="line">├── pki</span><br><span class="line">│   ├── apiserver.crt# apiserver组件证书通过kubernetes进行签发</span><br><span class="line">│   ├── apiserver-etcd-client.crt# 用于apiserver连接etcd的证书(etcd客户端认证)，通过etcd-ca进行签发</span><br><span class="line">│   ├── apiserver-etcd-client.key# etcd客户端(apiserver)的私钥</span><br><span class="line">│   ├── apiserver.key# apiserver组件私钥</span><br><span class="line">│   ├── apiserver-kubelet-client.crt# 通过kubernetes根签发的用于kubelet身份验证</span><br><span class="line">│   ├── apiserver-kubelet-client.key# kubelet组件的私钥</span><br><span class="line">│   ├── ca.crt## kubernetes根证书  `CA`</span><br><span class="line">│   ├── ca.key## kubernetes私钥</span><br><span class="line">│   ├── etcd</span><br><span class="line">│   │   ├── ca.crt## etcd根证书  `CA`</span><br><span class="line">│   │   ├── ca.key## etcd私钥</span><br><span class="line">│   │   ├── healthcheck-client.crt    # 通过Pod方式部署etcd需要用到此证书，用于对etcd服务做存活探测</span><br><span class="line">│   │   ├── healthcheck-client.key# 存活探测私钥</span><br><span class="line">│   │   ├── peer.crt# etcd集群中节点互相通信使用的证书</span><br><span class="line">│   │   ├── peer.key# 邻居私钥</span><br><span class="line">│   │   ├── server.crt# etcd服务器证书通过etcd根进行签发</span><br><span class="line">│   │   └── server.key# etcd组件私钥</span><br><span class="line">│   ├── front-proxy-ca.crt# 代理端根证书`CA`</span><br><span class="line">│   ├── front-proxy-ca.key# 代理端私钥</span><br><span class="line">│   ├── front-proxy-client.crt# 代理客户端证书由代理CA进行签发</span><br><span class="line">│   ├── front-proxy-client.key# 代理客户端私钥</span><br><span class="line">│   ├── sa.key# 私钥 没有关联单独生成即可</span><br><span class="line">│   └── sa.pub# 公钥 没有关联单独生成即可</span><br><span class="line">└── scheduler.conf# kubeconfig文件 暂不做说明</span><br><span class="line"></span><br><span class="line">3 directories, 30 files</span><br></pre></td></tr></table></figure><h2 id="证书关系"><a href="#证书关系" class="headerlink" title="证书关系"></a>证书关系</h2><p><img src="/archives/fd5f7d86/zs1.png" alt="image-20220917193700095"><br><img src="/archives/fd5f7d86/zs.png" alt="image-20220917193700094"></p><p>通过仔细分析kubeadm生成证书可以得出上图的关系，线条指向是<code>证书签发信任关系</code>，整个<code>红色</code>的方框是组件所需要的所有证书</p><ul><li>kubernetes根为apiserver签发证书</li><li>front-proxy根为client签发证书</li><li>etcd根为etcd-client签发证书</li><li>etcd根为etcd-server签发证书</li><li>etcd根为peer签发证书</li><li>etcd根为healthehck-client签发证书</li></ul><h2 id="kubernetes-CA详细信息"><a href="#kubernetes-CA详细信息" class="headerlink" title="kubernetes CA详细信息"></a>kubernetes CA详细信息</h2><p><strong>对证书结构或信息不了解的请仔细查看此小结的注释，后面不做注释(都是重复没啥必要)</strong></p><p><strong>通过命令：openssl x509 -in 证书名 -noout -text 即可查看证书详细信息</strong></p><p><strong>通过上述命令对&#x2F;etc&#x2F;kubernetes&#x2F;pki下的证书依次进行分析并创建一致的证书</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Certificate:# 证书</span><br><span class="line">    Data:# 数据</span><br><span class="line">        Version: 3 (0x2)# 版本 3</span><br><span class="line">        Serial Number: 0 (0x0)# 序号 0</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption# 签名算法 sha256</span><br><span class="line">        Issuer: CN = kubernetes# 发行者： CN=kubernetes</span><br><span class="line">        Validity# 有效期</span><br><span class="line">            Not Before: Sep 17 10:20:04 2022 GMT# 创建时间</span><br><span class="line">            Not After : Sep 14 10:20:04 2032 GMT# 失效时间</span><br><span class="line">        Subject: CN = kubernetes# 主体：CN = kubernetes</span><br><span class="line">        Subject Public Key Info:# 主体公钥信息</span><br><span class="line">            Public Key Algorithm: rsaEncryption# 公钥算法rsa</span><br><span class="line">                RSA Public-Key: (2048 bit)# RSA公钥：2048位</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:a4:90:11:1a:ed:40:fa:4e:ef:5e:13:7a:7c:43:</span><br><span class="line">                    f5:e1:6d:c2:79:b8:41:55:e7:cf:f6:1b:3c:d2:f8:</span><br><span class="line">                    35:4b:b0:7e:a0:8e:31:7e:74:6c:c3:25:6e:76:36:</span><br><span class="line">                    93:38:5f:89:12:5d:22:55:3e:cf:c1:15:f9:d6:f3:</span><br><span class="line">                    5f:64:f0:05:35:dd:ab:b6:4d:c7:5a:af:96:f9:59:</span><br><span class="line">                    9d:df:53:72:66:30:cb:3c:89:04:40:cd:57:b7:f4:</span><br><span class="line">                    a1:e6:a5:4c:80:74:d1:e4:1a:fd:bd:55:cb:e3:bf:</span><br><span class="line">                    47:8e:47:9d:cb:96:3f:c2:ec:8a:95:ab:c9:2a:f9:</span><br><span class="line">                    67:88:ab:cb:f5:5b:fa:7a:71:3a:55:32:cd:2f:e9:</span><br><span class="line">                    9a:e5:c0:36:01:4f:7a:2f:cb:ef:52:22:2d:a9:02:</span><br><span class="line">                    7b:a7:cc:0f:e2:f4:cc:5c:ca:06:d7:94:c9:99:d8:</span><br><span class="line">                    7c:bf:65:ad:59:b5:c6:63:d1:e4:4b:c6:63:b7:19:</span><br><span class="line">                    e7:dc:1b:92:39:a8:c5:36:b9:9f:b5:0e:e3:32:7c:</span><br><span class="line">                    7f:06:e3:36:1e:2e:29:6e:e3:f3:3a:23:e5:26:36:</span><br><span class="line">                    03:41:47:80:34:67:bf:de:90:a9:53:51:24:1f:a1:</span><br><span class="line">                    73:e0:f4:90:b3:03:bd:d1:aa:0b:80:19:65:2d:82:</span><br><span class="line">                    98:22:90:00:c1:45:40:81:47:db:6d:3e:00:5c:7f:</span><br><span class="line">                    e1:cf</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:# x509v3 扩展</span><br><span class="line">            X509v3 Key Usage: critical# x509v3 密钥用法</span><br><span class="line">                Digital Signature, Key Encipherment, Certificate Sign# 数字签名、密钥加密、证书签名</span><br><span class="line">            X509v3 Basic Constraints: critical# 基本约束</span><br><span class="line">                CA:TRUE# 是否是CA根</span><br><span class="line">            X509v3 Subject Key Identifier:# 密钥标识符</span><br><span class="line">                2B:F7:47:CB:41:4C:A9:B4:DA:93:18:30:E0:EA:10:7E:31:26:04:4A</span><br><span class="line">            X509v3 Subject Alternative Name:# 主体名称</span><br><span class="line">                DNS:kubernetes# DNS:kubernetes</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption# 签名算法： sha256</span><br><span class="line">         6c:69:8e:0a:6b:e4:d7:e5:ab:60:40:77:fa:2e:48:09:b1:5f:</span><br><span class="line">         6d:95:fd:63:5b:61:dd:c2:68:fe:ae:3f:47:1a:c0:0c:15:da:</span><br><span class="line">         8d:5c:ca:7a:f7:a5:53:a4:c6:8d:61:eb:34:74:39:91:a8:e0:</span><br><span class="line">         18:ac:91:e6:01:24:fb:1d:ed:cc:97:a4:37:a5:c7:cb:e8:77:</span><br><span class="line">         f4:7b:e7:90:fd:36:0d:3d:7b:69:58:44:08:9f:1c:e3:1e:cb:</span><br><span class="line">         f9:fb:5e:80:4a:e5:c4:11:38:94:24:7d:f9:68:69:a0:03:56:</span><br><span class="line">         5e:8f:b8:f4:79:ad:a4:20:b6:c1:c7:78:4d:16:fd:a3:7e:8d:</span><br><span class="line">         4e:3e:a3:fb:d3:47:13:6f:b2:e2:83:11:95:9c:66:b6:e9:37:</span><br><span class="line">         d0:50:7f:91:6c:3a:81:34:d9:69:d6:17:f9:d0:53:db:29:57:</span><br><span class="line">         d7:e3:ad:44:81:f7:45:e3:2e:61:6d:e0:44:26:9e:b9:c8:67:</span><br><span class="line">         87:35:37:a3:6b:8c:22:b7:34:c3:2d:61:bb:50:e9:4c:fa:de:</span><br><span class="line">         a0:96:e2:67:dd:87:ea:84:fc:2a:de:18:ce:2e:39:12:b6:a5:</span><br><span class="line">         c5:7a:d1:b4:06:f5:74:bc:50:26:30:f2:67:2e:21:09:cd:4e:</span><br><span class="line">         2b:0d:32:2b:34:97:e7:73:52:e4:7f:8d:a4:58:29:0d:ad:19:</span><br><span class="line">         9d:74:65:42</span><br></pre></td></tr></table></figure><h2 id="kubernetes-CA创建方法"><a href="#kubernetes-CA创建方法" class="headerlink" title="kubernetes CA创建方法"></a>kubernetes CA创建方法</h2><p><strong>对参数不了解的请看</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-extensions v3_req 指定使用X.509 v3版本签发证书(其实就是cnf文件中对于配置块信息)</span><br><span class="line">-extensions v3_ca </span><br><span class="line">-extfile 指定特殊的v3配置文件</span><br><span class="line">-days 36500 设置证书过期时间 36500为100年   365为一年</span><br><span class="line">-set_serial 0  设置序列号</span><br><span class="line">-signkey 指定CA私钥</span><br><span class="line">-sha256 指定为sha256算法</span><br><span class="line">-in 导入文件</span><br><span class="line">-out 输出文件</span><br></pre></td></tr></table></figure><p><strong>对于cnf v3配置详细信息请参考官网：<a href="https://www.openssl.org/docs/man1.1.1/man5/x509v3_config.html">https://www.openssl.org/docs/man1.1.1/man5/x509v3_config.html</a></strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建cnf文件</span></span><br><span class="line">[root@master pki]# cat xiaowangc.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment# 指定密钥用法</span><br><span class="line">basicConstraints = critical,CA:true# 指定是否为CA根</span><br><span class="line">subjectKeyIdentifier = hash# 密钥标识符</span><br><span class="line">subjectAltName = DNS:kubernetes# 主体备用名称</span><br><span class="line"></span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment     # 指定密钥用法</span><br><span class="line">extendedKeyUsage = serverAuth# 扩展密钥用法：服务器验证</span><br><span class="line">basicConstraints = critical, CA:FALSE# 指定是否为CA根</span><br><span class="line">authorityKeyIdentifier = keyid,issuer# 密钥标识符</span><br><span class="line">subjectAltName = DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:master, IP:127.0.0.1, IP:192.168.64.11# 主体备用名称</span><br><span class="line">===============================================================================</span><br><span class="line"></span><br><span class="line">[root@master pki]# openssl genrsa -out ca.pem# 生成私钥</span><br><span class="line">[root@master pki]# openssl req -new -key ca.pem -out ca.csr -subj &#x27;/CN=kubernetes&#x27;# 生成证书请求文件并设置CN为kubernetes</span><br><span class="line">[root@master pki]# openssl x509 -req -days 36500 -sha256 -extfile xiaowangc.cnf -extensions v3_ca -set_serial 0 -signkey ca.pem -in ca.csr -out ca.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = kubernetes</span><br><span class="line">Getting Private key</span><br><span class="line">[root@master pki]# openssl x509 -in ca.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 0 (0x0)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 13:40:22 2022 GMT</span><br><span class="line">            Not After : Aug 24 13:40:22 2122 GMT</span><br><span class="line">        Subject: CN = kubernetes</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:ca:29:5b:e0:f0:d1:cf:3e:55:a5:dd:e7:0f:e5:</span><br><span class="line">                    86:05:e1:e4:e2:0b:f5:e6:0e:cf:f9:a6:75:5c:76:</span><br><span class="line">                    f7:76:91:90:91:fb:3b:65:25:63:1f:24:8f:7f:43:</span><br><span class="line">                    17:1a:01:24:bd:2e:3a:c2:e3:3a:2b:10:3c:07:13:</span><br><span class="line">                    b8:63:7a:ac:9c:21:f4:48:d3:84:17:a9:60:b5:44:</span><br><span class="line">                    00:58:18:01:34:e7:d2:35:e3:0e:fe:de:22:c1:09:</span><br><span class="line">                    f3:4b:f8:5d:f4:1d:ae:7d:31:b1:19:42:00:cb:62:</span><br><span class="line">                    69:29:3d:90:eb:9d:d8:3e:51:e5:3b:bb:7e:c1:04:</span><br><span class="line">                    93:97:92:d9:47:62:b5:40:5f:8c:0b:82:de:f7:88:</span><br><span class="line">                    23:2e:7b:75:bb:ea:a3:ec:11:7f:48:62:66:a7:33:</span><br><span class="line">                    e3:16:bc:25:ea:91:89:b7:f6:fb:2f:be:a8:9b:3d:</span><br><span class="line">                    a6:1e:da:01:f5:23:d5:b3:1b:40:34:cd:1a:c2:45:</span><br><span class="line">                    0d:a5:a5:0f:2b:be:df:8f:e8:4b:72:05:33:ae:49:</span><br><span class="line">                    36:38:84:4a:87:34:fc:1d:d8:ca:a4:b5:13:ad:54:</span><br><span class="line">                    9b:52:08:16:e5:78:d4:01:a6:04:3e:83:23:77:38:</span><br><span class="line">                    b4:24:66:b1:de:15:e6:56:89:18:a2:af:41:99:63:</span><br><span class="line">                    ee:81:9d:a5:96:01:26:42:3c:f4:7d:37:35:64:1c:</span><br><span class="line">                    be:33</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment, Certificate Sign</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                CA:C2:0C:4E:A2:79:5D:1F:39:FF:09:AE:B7:9A:4F:6C:37:66:6E:A7</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:kubernetes</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         ba:22:cc:db:36:c4:6a:00:c1:0e:c2:69:e7:d2:4a:49:a3:df:</span><br><span class="line">         2b:a3:1a:34:4e:89:de:77:fe:f6:25:2b:9c:8c:b2:78:f8:7f:</span><br><span class="line">         58:28:dc:ef:92:18:30:18:2f:b1:f0:48:7b:47:64:ec:c8:bf:</span><br><span class="line">         27:22:b1:b5:ae:65:44:01:47:a9:14:5a:b3:17:3b:f1:13:8a:</span><br><span class="line">         d4:44:78:c9:bc:e5:ce:dd:bf:94:2e:d1:40:53:fe:0e:b7:99:</span><br><span class="line">         58:aa:59:c5:3e:dc:5c:c8:7b:f0:77:ce:29:04:53:ec:dc:ba:</span><br><span class="line">         14:cd:e3:65:4a:76:65:2e:fa:21:94:7a:37:cb:b1:b3:5b:b2:</span><br><span class="line">         cd:1f:0f:d7:35:fe:67:c5:8b:43:f6:dc:47:c8:d2:cd:93:f8:</span><br><span class="line">         d5:74:0e:f5:35:5d:a7:65:3e:ea:67:cb:51:60:22:4b:04:96:</span><br><span class="line">         c4:ed:1f:65:36:6c:9d:79:78:7d:32:c6:9f:52:26:7a:ef:ba:</span><br><span class="line">         da:88:80:52:84:41:88:3a:5d:84:39:14:03:75:8a:4e:86:b8:</span><br><span class="line">         a5:21:67:e0:93:66:dc:b3:08:1b:f4:61:63:4a:d9:c8:7d:c3:</span><br><span class="line">         24:7f:f9:cd:60:18:5e:5d:ba:6e:03:a7:31:99:a0:58:da:a6:</span><br><span class="line">         68:7d:df:08:4b:10:cf:5c:16:9a:37:ba:34:74:7f:ba:15:91:</span><br><span class="line">         21:36:4a:ad</span><br></pre></td></tr></table></figure><h2 id="apiserver证书详细信息"><a href="#apiserver证书详细信息" class="headerlink" title="apiserver证书详细信息"></a>apiserver证书详细信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数意思大致和上面差不多</span></span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 7046502440896354319 (0x61ca34a2d28cd80f)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:04 2022 GMT</span><br><span class="line">            Not After : Sep 17 10:20:04 2023 GMT</span><br><span class="line">        Subject: CN = kube-apiserver</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:94:4c:68:af:91:68:bf:3d:c2:59:0e:07:57:14:</span><br><span class="line">                    c2:85:38:18:ed:f7:73:19:d3:5b:18:49:a9:e7:3c:</span><br><span class="line">                    19:86:af:f8:bb:23:97:03:b0:74:9c:e2:2c:76:6e:</span><br><span class="line">                    59:64:dd:2d:a4:1e:ec:78:ff:7a:83:2b:44:71:3c:</span><br><span class="line">                    c6:c0:50:6c:23:49:8d:64:e4:88:20:38:2b:20:d9:</span><br><span class="line">                    0a:28:75:4c:7e:d2:30:1a:05:12:0b:38:8c:9b:8b:</span><br><span class="line">                    ba:5a:69:e4:7d:82:91:db:46:9f:f8:2c:42:7d:71:</span><br><span class="line">                    ee:60:24:cc:71:89:ce:89:7d:1c:ec:c3:9a:b5:e5:</span><br><span class="line">                    bd:ad:2c:d1:ad:b1:74:1b:b1:19:04:d6:a3:64:a4:</span><br><span class="line">                    2a:5b:90:d5:c7:ee:0a:9c:89:24:c7:e8:df:46:05:</span><br><span class="line">                    22:38:29:a5:78:40:a2:80:09:4c:06:1c:a8:cd:c3:</span><br><span class="line">                    73:13:f9:4f:a4:e9:41:61:52:e9:9a:d4:9a:d0:9b:</span><br><span class="line">                    9f:a6:86:2f:8a:b6:a6:1d:de:9f:09:72:55:49:71:</span><br><span class="line">                    4a:3c:64:44:ef:fd:0a:c6:21:f8:0d:cd:1f:77:95:</span><br><span class="line">                    61:41:4f:49:61:8a:32:f1:88:04:26:3b:3e:53:05:</span><br><span class="line">                    4d:47:6a:c6:a1:22:11:3c:d8:4d:44:87:b7:47:ee:</span><br><span class="line">                    ea:1d:17:14:e8:7c:7b:14:44:42:76:a9:f8:1c:06:</span><br><span class="line">                    04:43</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:2B:F7:47:CB:41:4C:A9:B4:DA:93:18:30:E0:EA:10:7E:31:26:04:4A</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:master, IP Address:192.12.0.1, IP Address:192.168.64.11</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         4f:f3:64:08:c1:6e:a8:03:c4:a2:94:d3:36:2c:06:0e:95:0d:</span><br><span class="line">         dc:b6:77:ca:5b:ee:41:b9:31:d3:75:79:fc:37:b8:d2:cc:92:</span><br><span class="line">         0d:18:ad:bd:e5:b4:0a:b0:2b:ba:51:94:bf:e4:d3:9d:49:e7:</span><br><span class="line">         2b:b7:df:44:38:a0:4f:e5:48:4a:bd:2d:d3:8d:76:60:f1:41:</span><br><span class="line">         2f:c0:6f:e2:fa:4c:79:a0:7f:ad:6d:3a:9d:0a:ac:82:d7:bc:</span><br><span class="line">         23:0f:ca:66:7f:7d:95:3f:f0:f3:75:41:2b:55:a1:66:6b:98:</span><br><span class="line">         58:4d:35:77:5f:3d:71:00:3a:3c:c9:00:e4:90:4b:9c:1e:42:</span><br><span class="line">         0d:47:e6:25:c2:77:7e:93:65:44:03:4c:d3:7e:f1:cf:e8:eb:</span><br><span class="line">         c1:72:08:35:6a:da:84:2a:f0:22:e2:57:4a:72:83:a9:c6:5c:</span><br><span class="line">         9e:38:fb:21:51:21:d0:12:92:af:63:a0:9c:c9:4b:ff:01:2a:</span><br><span class="line">         af:c3:ef:b5:64:ff:a3:47:44:24:75:8a:03:ed:b0:fe:54:22:</span><br><span class="line">         7c:b9:8b:05:8f:b0:3f:67:48:35:40:bc:97:34:59:48:92:37:</span><br><span class="line">         ba:d1:60:8a:bb:0c:00:a2:1a:15:d5:1f:17:f7:64:42:25:3c:</span><br><span class="line">         09:e7:70:5c:a0:c2:a0:20:65:fb:e4:6d:ae:59:b1:4f:09:60:</span><br><span class="line">         89:88:78:56</span><br></pre></td></tr></table></figure><h2 id="apisever证书创建方法"><a href="#apisever证书创建方法" class="headerlink" title="apisever证书创建方法"></a>apisever证书创建方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@master pki]# cat xiaowangc.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:kubernetes</span><br><span class="line"></span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:master, IP:127.0.0.1, IP:192.168.64.11</span><br><span class="line">==============================================</span><br><span class="line"></span><br><span class="line">[root@master pki]# openssl req -new -newkey rsa:2048 -keyout apiserver.key -out apiserver.csr -nodes -subj &#x27;/CN=kube-apiserver&#x27;</span><br><span class="line">[root@master pki]# openssl x509 -req -sha256 -days 36500 -extfile xiaowangc.cnf -extensions v3_req -in apiserver.csr -CA ca.crt -CAkey ca.pem -out apiserver.crt -CAcreateserial</span><br><span class="line">[root@master pki]# openssl x509 -in apiserver.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            19:39:ff:4c:dd:c2:d6:76:f3:cc:7e:f9:b8:8c:fb:4e:b5:17:5b:20</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 14:33:08 2022 GMT</span><br><span class="line">            Not After : Aug 24 14:33:08 2122 GMT</span><br><span class="line">        Subject: CN = kube-apiserver</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:e1:08:2b:cd:46:37:e7:3e:9f:c0:99:28:e2:91:</span><br><span class="line">                    d6:82:60:55:8f:69:e8:69:b2:3b:99:f0:05:77:cb:</span><br><span class="line">                    a9:35:e8:b5:07:a4:bc:f2:30:07:33:f4:a3:12:b6:</span><br><span class="line">                    f5:1b:8e:bd:c1:36:d8:b5:d0:fb:4c:4c:92:fb:38:</span><br><span class="line">                    ac:51:52:87:28:ea:e6:c8:49:0f:38:c6:b9:68:0c:</span><br><span class="line">                    79:2c:a7:aa:99:fa:f9:80:47:36:e7:0e:19:f1:96:</span><br><span class="line">                    07:ea:13:c0:5d:30:3c:3e:d6:33:28:f4:49:c1:b1:</span><br><span class="line">                    13:d7:4f:4f:ec:ac:c1:52:98:83:59:e6:df:5f:a1:</span><br><span class="line">                    2b:b3:81:4c:7b:84:d8:2d:29:bd:b3:b6:3d:b5:3a:</span><br><span class="line">                    da:2e:c1:d0:d1:f9:40:ff:e6:ff:c0:9c:e4:d5:19:</span><br><span class="line">                    31:1d:6c:70:4d:1c:9c:c2:0c:9f:51:1e:8a:ba:7c:</span><br><span class="line">                    b1:c4:e1:6e:f2:5b:9c:a6:f4:4c:6e:a2:d6:cf:db:</span><br><span class="line">                    1a:e7:94:d7:6f:2d:b2:10:4f:6a:bb:33:5c:56:bd:</span><br><span class="line">                    45:d1:1a:86:a2:34:9a:32:00:e9:39:c7:10:ce:22:</span><br><span class="line">                    e3:c1:95:56:e3:50:c0:a5:cd:93:ea:f0:f1:48:ef:</span><br><span class="line">                    9d:b0:29:ac:13:6b:fa:f8:73:49:44:30:5d:c4:12:</span><br><span class="line">                    cc:d0:b3:b9:7e:c6:4f:7a:06:19:e5:10:6f:f7:5e:</span><br><span class="line">                    eb:61</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:33:AC:40:D4:C2:3E:E9:64:2B:F5:00:C7:EB:E9:78:45:62:DD:3E:15</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:master, IP Address:127.0.0.1, IP Address:192.168.64.11</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         67:5f:de:8e:7f:39:b6:55:2a:c1:20:07:fb:60:fa:0d:b9:fc:</span><br><span class="line">         8b:22:ff:fb:31:8f:b8:6d:cd:2f:7a:56:cd:23:0f:94:68:a4:</span><br><span class="line">         57:90:05:88:e9:b9:08:1e:fa:08:d2:02:ed:1e:87:07:e6:7f:</span><br><span class="line">         40:ba:ca:90:27:19:7f:87:54:5f:1c:96:63:db:19:3a:1a:1c:</span><br><span class="line">         c2:cb:9b:fc:47:39:4d:4c:a2:d4:6d:26:0b:5f:b1:4e:f1:62:</span><br><span class="line">         8b:99:47:62:8f:28:6e:be:4b:94:de:02:f8:75:47:2e:08:81:</span><br><span class="line">         2e:8f:ca:7b:d8:72:c3:18:81:9d:5f:47:b6:5a:c5:5a:13:7f:</span><br><span class="line">         3d:a3:bb:86:2a:68:d5:45:b0:cd:dc:1b:78:d9:ec:4e:1b:d4:</span><br><span class="line">         8e:25:48:0d:b8:16:c7:49:08:f7:66:bb:18:6e:03:42:d8:6c:</span><br><span class="line">         e1:1a:7b:2f:de:19:07:4e:e6:60:d4:21:b5:b0:94:d0:7e:06:</span><br><span class="line">         9c:72:5d:57:b7:36:19:eb:30:5e:40:ea:6a:0b:c9:40:9c:22:</span><br><span class="line">         91:59:93:3e:af:40:06:77:1b:80:72:a1:e4:9d:e0:ac:a8:7d:</span><br><span class="line">         86:3c:a0:9f:67:a2:69:68:30:74:ff:67:ef:8c:5d:db:31:73:</span><br><span class="line">         7c:a9:8c:51:ac:25:e8:f5:bb:0f:8e:63:ba:fb:39:4d:14:bb:</span><br><span class="line">         b0:b0:96:a3</span><br></pre></td></tr></table></figure><h2 id="front-proxy-CA详细信息"><a href="#front-proxy-CA详细信息" class="headerlink" title="front-proxy CA详细信息"></a>front-proxy CA详细信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@master pki]# openssl x509 -in front-proxy-ca.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 0 (0x0)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = front-proxy-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:05 2022 GMT</span><br><span class="line">            Not After : Sep 14 10:20:05 2032 GMT</span><br><span class="line">        Subject: CN = front-proxy-ca</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:ce:fc:51:d7:ab:33:de:d9:bb:e4:b7:e1:34:37:</span><br><span class="line">                    af:ac:67:48:3e:7c:06:c1:35:6d:94:1d:5d:24:d4:</span><br><span class="line">                    79:fc:ac:ce:7c:7a:95:f2:1b:00:51:78:bf:4d:48:</span><br><span class="line">                    cb:6a:78:42:f7:3f:72:1c:60:74:64:8c:d4:01:74:</span><br><span class="line">                    17:e8:1f:9e:d6:ce:7a:63:a9:81:58:cd:fa:83:56:</span><br><span class="line">                    05:7e:25:6a:1a:0d:ea:e6:f9:5e:e8:92:4b:e7:19:</span><br><span class="line">                    80:d9:86:f9:bd:da:7d:53:30:37:ad:fc:4e:e1:dd:</span><br><span class="line">                    5c:ee:e0:50:31:9b:ba:87:cc:4a:e6:3c:c6:87:ca:</span><br><span class="line">                    0c:81:fa:f4:e0:95:4b:41:e9:ea:2b:11:36:c4:26:</span><br><span class="line">                    d8:e0:98:3c:f6:bb:0d:fc:70:e3:de:ba:14:ca:95:</span><br><span class="line">                    56:11:4b:6c:3a:bf:56:1f:00:e0:bf:40:6b:8d:4f:</span><br><span class="line">                    a0:a5:59:fb:35:d9:26:d9:b3:0d:9d:eb:f0:cf:24:</span><br><span class="line">                    a1:85:db:a6:8c:05:f7:fa:de:40:1c:aa:37:4d:36:</span><br><span class="line">                    8f:07:45:ff:ce:63:3f:f5:0f:8e:85:56:d5:3c:64:</span><br><span class="line">                    7c:c9:3d:ef:c8:47:01:ed:97:e7:c9:9c:83:68:da:</span><br><span class="line">                    6b:66:b7:01:41:4a:ab:9e:e2:f3:08:2b:38:73:c0:</span><br><span class="line">                    92:f7:d1:81:7d:06:92:10:1f:47:5d:7a:87:19:09:</span><br><span class="line">                    b3:0f</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment, Certificate Sign</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                4A:89:5F:73:59:04:A9:CE:8C:2E:D8:C2:29:3B:99:0E:B4:ED:54:D3</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:front-proxy-ca</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         b2:12:96:0c:a5:7b:ac:56:60:24:c4:ab:71:34:90:ae:2e:df:</span><br><span class="line">         17:44:10:52:8d:b0:92:93:dc:fd:12:d5:98:b7:03:14:6c:cc:</span><br><span class="line">         4e:8d:c8:74:6d:31:58:0f:50:5d:57:00:0e:8b:82:7b:8e:3a:</span><br><span class="line">         f7:7e:9a:a3:7f:3f:8e:7a:8e:55:1c:51:ab:7e:b6:3f:a6:28:</span><br><span class="line">         5d:6c:17:2d:05:2c:4f:69:bb:e7:aa:95:a7:7e:51:76:fc:66:</span><br><span class="line">         9e:22:21:2a:b1:19:d0:0b:2d:8e:91:9d:c6:eb:a1:86:93:9a:</span><br><span class="line">         b9:a4:e3:af:4e:f5:56:5c:7d:d2:0f:03:3c:98:ad:f9:da:13:</span><br><span class="line">         63:f9:15:86:03:8e:09:fd:93:34:c8:dd:ae:9b:b7:cd:29:a5:</span><br><span class="line">         41:89:b3:29:21:40:e7:18:dc:16:4c:0c:ec:0a:1e:02:81:27:</span><br><span class="line">         41:2d:5d:02:67:9b:a0:02:46:ad:a7:8d:c6:2d:a2:55:8c:b1:</span><br><span class="line">         c3:eb:4d:46:51:29:4d:49:8b:f0:b8:24:78:dd:30:ac:40:c9:</span><br><span class="line">         e4:61:65:ee:64:5f:7d:35:1d:2a:50:92:0a:d6:e7:3d:28:9c:</span><br><span class="line">         45:14:69:95:f3:76:de:2e:fb:1c:57:f1:ca:6e:1d:9f:8a:3a:</span><br><span class="line">         80:35:82:78:48:c5:19:8d:bf:da:21:28:2a:ad:62:d5:aa:66:</span><br><span class="line">         94:e3:73:f4</span><br></pre></td></tr></table></figure><h2 id="front-proxy-CA创建方法"><a href="#front-proxy-CA创建方法" class="headerlink" title="front-proxy CA创建方法"></a>front-proxy CA创建方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">front-proxy CA创建方法和kubernetes CA相同，可对比证书详细信息,变化不大</span></span><br><span class="line"></span><br><span class="line">[root@master pki]# cat xiaowangc.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:front-proxy-ca</span><br><span class="line"></span><br><span class="line">===============================================================================================</span><br><span class="line">[root@master pki]# openssl req -new -newkey rsa:2048 -keyout front-proxy-ca.key -out front-proxy-ca.csr -nodes -subj &#x27;/CN=front-proxy-ca&#x27;</span><br><span class="line">Generating a RSA private key</span><br><span class="line">..+++++</span><br><span class="line">...............................+++++</span><br><span class="line">writing new private key to &#x27;front-proxy-ca.key&#x27;</span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line">[root@master pki]# openssl x509 -req -days 36500 -sha256 -extfile xiaowangc.cnf -extensions v3_ca -set_serial 0 -signkey front-proxy-ca.key -in front-proxy-ca.csr -out front-proxy-ca.crt</span><br><span class="line">[root@master pki]# openssl x509 -in front-proxy-ca.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 0 (0x0)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = front-proxy-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 18:23:03 2022 GMT</span><br><span class="line">            Not After : Aug 24 18:23:03 2122 GMT</span><br><span class="line">        Subject: CN = front-proxy-ca</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:b0:db:55:92:4f:f4:a7:ec:db:5a:ad:a4:97:c9:</span><br><span class="line">                    84:4f:5b:10:d8:f4:28:54:a5:ec:02:62:8c:95:c4:</span><br><span class="line">                    7b:90:da:ca:76:ca:49:4b:3c:cc:98:79:0e:c3:6d:</span><br><span class="line">                    8f:80:b5:e1:26:dd:82:83:8d:8e:03:6e:b5:31:0e:</span><br><span class="line">                    8e:55:e6:41:3a:77:11:4e:9d:ad:10:8d:4c:77:a4:</span><br><span class="line">                    25:2b:02:c0:10:93:fd:18:53:d5:ab:43:70:2d:8d:</span><br><span class="line">                    6b:70:a8:84:d6:3d:df:ad:5f:7d:7f:0b:b6:b0:ba:</span><br><span class="line">                    bc:7c:e5:45:86:57:5b:a4:0a:2a:71:15:76:50:42:</span><br><span class="line">                    eb:e0:22:3a:c3:f0:ec:12:f9:47:f6:21:33:78:8d:</span><br><span class="line">                    87:fa:6d:23:8d:25:91:69:e8:99:a5:78:f9:63:c8:</span><br><span class="line">                    fc:c9:48:b8:b1:0c:fd:1b:14:c3:b8:55:c9:f5:ba:</span><br><span class="line">                    74:37:e4:98:17:69:3e:06:ce:80:1e:a6:e3:3d:de:</span><br><span class="line">                    8f:9b:be:3a:de:c1:8c:89:b3:17:b5:14:d4:2a:37:</span><br><span class="line">                    86:1c:37:71:15:5e:1f:df:02:85:16:5c:4e:3d:e6:</span><br><span class="line">                    d2:35:93:ad:f7:b7:00:4e:44:27:bf:9f:ce:da:45:</span><br><span class="line">                    33:57:1f:87:c5:4c:77:36:44:29:58:d6:53:00:6c:</span><br><span class="line">                    16:00:53:a8:f1:17:50:19:e5:75:e9:e1:96:ad:0d:</span><br><span class="line">                    e7:a5</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment, Certificate Sign</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                63:70:65:AC:BF:B0:9E:D2:93:57:C3:E7:2B:55:0F:01:08:FC:16:30</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:front-proxy-ca</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         43:bb:c2:61:96:68:74:72:44:34:06:f2:2e:57:03:1e:73:e9:</span><br><span class="line">         dd:dc:70:49:e1:04:36:1e:d1:35:29:b9:bc:cb:7b:99:0a:c9:</span><br><span class="line">         95:ae:62:42:0a:10:bb:e9:01:6c:57:3b:d0:59:69:56:a3:84:</span><br><span class="line">         83:90:45:fe:9f:90:78:10:38:be:f9:3b:03:c0:14:7e:17:15:</span><br><span class="line">         32:d4:d2:c8:40:8d:84:fe:0b:85:6d:70:04:ea:eb:56:05:a3:</span><br><span class="line">         cd:15:d2:94:fe:bc:04:7f:83:ac:bd:52:e5:f7:b5:17:cb:e4:</span><br><span class="line">         cc:e1:83:62:98:4a:de:f8:6f:cf:d4:b2:57:56:e3:41:e1:37:</span><br><span class="line">         d1:66:72:0b:1e:1c:5f:7d:bb:f7:eb:4e:48:b6:48:cc:3e:47:</span><br><span class="line">         02:a0:69:54:bf:b8:c1:ba:32:fa:7f:89:1d:c6:0a:85:36:81:</span><br><span class="line">         af:5c:74:98:3d:27:bb:ae:12:ac:4b:1b:6f:db:44:c3:66:aa:</span><br><span class="line">         18:8b:c9:4d:b4:b6:31:03:92:34:ce:20:81:73:7d:5c:b9:44:</span><br><span class="line">         4b:7f:ae:bd:da:77:a5:43:0d:83:04:97:30:05:8d:20:9d:42:</span><br><span class="line">         c6:59:50:fe:7c:c8:ca:d4:77:8e:ba:2d:15:53:04:1f:2c:d3:</span><br><span class="line">         03:ba:14:02:36:e6:02:9c:56:db:01:d9:dc:3d:66:6c:34:1c:</span><br><span class="line">         a7:52:82:32</span><br></pre></td></tr></table></figure><h2 id="front-proxy-client证书详细信息"><a href="#front-proxy-client证书详细信息" class="headerlink" title="front-proxy-client证书详细信息"></a>front-proxy-client证书详细信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@master pki]# openssl x509 -in front-proxy-client.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 8717535010990851132 (0x78fae7e7af24043c)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = front-proxy-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:05 2022 GMT</span><br><span class="line">            Not After : Sep 17 10:20:05 2023 GMT</span><br><span class="line">        Subject: CN = front-proxy-client</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:e0:7c:d8:e6:03:aa:4e:d1:35:d4:9a:0f:46:a7:</span><br><span class="line">                    fe:58:43:10:c2:d6:7b:84:3b:36:42:f7:dd:f0:29:</span><br><span class="line">                    d7:cc:cb:83:05:d5:80:70:18:aa:bf:b1:6a:f4:44:</span><br><span class="line">                    74:b2:1d:9a:2e:ac:f9:36:3f:18:ed:5e:b8:c9:53:</span><br><span class="line">                    9c:71:65:c4:af:32:ab:c5:0e:d5:a3:b9:f2:55:91:</span><br><span class="line">                    ef:4a:54:42:b2:26:4e:97:5a:9f:67:fd:ea:1a:c3:</span><br><span class="line">                    03:01:b5:ca:9b:d0:78:99:26:5c:da:01:12:40:3b:</span><br><span class="line">                    12:88:cc:25:0b:be:00:73:78:bb:d7:7e:e3:1b:07:</span><br><span class="line">                    ca:f7:f5:c4:73:9e:42:23:1e:e2:b7:58:a7:e5:33:</span><br><span class="line">                    71:dd:13:27:9d:44:5c:ce:b4:f9:50:19:ff:92:ed:</span><br><span class="line">                    37:3e:4a:00:23:4a:a4:8f:94:92:8f:f0:e2:ad:87:</span><br><span class="line">                    43:67:26:dd:d7:f3:c4:60:0e:c2:2f:ca:21:6c:dd:</span><br><span class="line">                    b5:5f:b1:a2:9a:ce:5f:5f:a2:aa:99:25:32:61:bd:</span><br><span class="line">                    be:1d:a4:fc:dd:91:d6:5e:60:32:f4:63:e4:69:ee:</span><br><span class="line">                    90:f2:63:01:ba:5e:64:60:48:7c:42:3f:50:9a:f9:</span><br><span class="line">                    b3:13:a7:e2:50:5d:bb:b2:2d:34:ee:38:8f:49:ac:</span><br><span class="line">                    de:a6:a1:32:d6:2b:83:77:47:1f:5d:36:e4:fc:b4:</span><br><span class="line">                    60:a1</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:4A:89:5F:73:59:04:A9:CE:8C:2E:D8:C2:29:3B:99:0E:B4:ED:54:D3</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         49:15:87:5e:b1:7a:bd:be:83:be:0c:55:54:0f:bb:ee:79:21:</span><br><span class="line">         21:03:6e:e6:d2:7b:69:74:fb:b0:a6:6b:b3:d4:d7:60:23:3b:</span><br><span class="line">         5c:89:16:9d:26:7a:be:4f:40:ad:b7:c7:a2:62:3e:ec:7c:ae:</span><br><span class="line">         df:30:05:d9:1f:61:44:8c:57:f7:7e:ba:dc:9c:b8:b9:09:2e:</span><br><span class="line">         83:59:da:44:4d:9a:23:02:51:56:7f:95:e8:59:88:7c:ee:33:</span><br><span class="line">         5f:0d:fe:93:79:1f:48:12:83:8a:2a:99:0c:f4:93:0a:c0:e6:</span><br><span class="line">         c1:ea:17:05:c2:de:e5:31:50:2a:bc:8f:0e:80:57:57:38:4a:</span><br><span class="line">         61:40:c4:12:de:17:53:f7:4a:72:55:4c:9b:5a:d9:48:8d:2b:</span><br><span class="line">         0c:69:16:b2:c9:2a:3e:7b:75:2b:89:c4:89:14:bf:e0:d4:64:</span><br><span class="line">         d0:31:9e:98:d2:5d:bc:c4:54:5f:f8:d0:0f:3e:49:c7:1a:d6:</span><br><span class="line">         83:51:f2:1f:f7:a4:61:bf:8d:58:ca:a4:18:bd:60:7c:bf:d1:</span><br><span class="line">         78:57:bd:2e:87:ff:c8:07:41:b2:ae:1b:36:c6:6d:c0:43:9b:</span><br><span class="line">         c1:44:c6:c3:7e:64:e3:9d:e6:5f:d7:36:a0:d5:a0:c4:2c:d0:</span><br><span class="line">         77:ab:5b:44:44:e8:47:3d:2a:9b:40:7d:ea:39:15:e4:81:32:</span><br><span class="line">         49:9d:21:86</span><br></pre></td></tr></table></figure><h2 id="front-proxy-client证书创建方法"><a href="#front-proxy-client证书创建方法" class="headerlink" title="front-proxy-client证书创建方法"></a>front-proxy-client证书创建方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@master pki]# vi xiaowangc.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line"></span><br><span class="line">=================================================================</span><br><span class="line"></span><br><span class="line">[root@master pki]# openssl req -new -newkey rsa:2048 -keyout front-proxy-client.key -out front-proxy-client.csr -nodes -subj &#x27;/CN=front-proxy-client&#x27;</span><br><span class="line">[root@master pki]# openssl x509 -req -sha256 -days 36500 -extfile xiaowangc.cnf -extensions v3_req -in front-proxy-client.csr -CA front-proxy-ca.crt -CAkey front-proxy-ca.key -out front-proxy-client.crt -CAcreateserial</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = front-proxy-client</span><br><span class="line">Getting CA Private Key</span><br><span class="line">[root@master pki]# openssl x509 -in front-proxy-client.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            7a:ab:72:43:b0:71:af:fe:8e:63:f7:c9:5f:d3:e4:c1:1c:93:ec:56</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = front-proxy-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 18:32:01 2022 GMT</span><br><span class="line">            Not After : Aug 24 18:32:01 2122 GMT</span><br><span class="line">        Subject: CN = front-proxy-client</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:b3:f6:af:47:98:65:d7:60:b5:ab:86:75:96:9b:</span><br><span class="line">                    fc:5a:16:63:62:6d:17:a0:cd:f9:2b:af:ac:5c:8b:</span><br><span class="line">                    41:ed:3d:89:90:6b:c4:bf:a0:90:8b:4c:9a:48:07:</span><br><span class="line">                    03:6b:1e:f7:a7:c1:64:b1:c1:c8:ac:48:c1:db:e1:</span><br><span class="line">                    8f:60:73:5c:d3:4b:bc:13:8a:62:d2:7e:0e:e3:57:</span><br><span class="line">                    87:ae:f1:bb:6d:0f:b8:79:57:4d:73:36:be:b2:fc:</span><br><span class="line">                    3c:b3:8c:b3:ba:ea:cb:58:a9:c9:ba:89:7e:ec:c3:</span><br><span class="line">                    08:eb:4f:41:7d:8d:d0:2e:db:ef:10:af:6d:5b:7c:</span><br><span class="line">                    c8:ca:89:a4:58:43:e5:10:43:da:6a:65:eb:db:fe:</span><br><span class="line">                    d1:cf:7e:29:9d:33:aa:a1:9f:d2:bd:e1:0a:11:15:</span><br><span class="line">                    da:7d:fa:4f:a8:c2:99:ed:be:dd:55:26:01:5a:7d:</span><br><span class="line">                    c4:c0:53:e4:2c:ac:9e:c1:44:aa:0e:cf:26:e3:87:</span><br><span class="line">                    38:dd:47:8f:2b:40:e8:86:a7:64:48:67:86:ed:b6:</span><br><span class="line">                    8b:6e:bd:1f:ea:d5:21:da:39:d7:24:61:2d:33:ff:</span><br><span class="line">                    22:78:8d:4d:1e:ed:89:a4:48:ac:6a:e7:76:a2:4d:</span><br><span class="line">                    72:08:c4:25:1c:13:0f:5e:11:f0:83:70:52:f1:a8:</span><br><span class="line">                    ff:fc:ff:f1:03:ae:c8:d8:e3:cc:89:b5:72:4b:97:</span><br><span class="line">                    71:87</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:63:70:65:AC:BF:B0:9E:D2:93:57:C3:E7:2B:55:0F:01:08:FC:16:30</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         a7:b1:36:2f:d2:9c:8c:8a:64:c4:2a:65:57:4d:e6:6d:38:de:</span><br><span class="line">         2c:60:53:3c:b0:96:17:1d:8f:c7:24:cc:03:12:9a:a6:af:98:</span><br><span class="line">         5d:9b:52:9b:11:88:63:58:ab:33:8f:d4:19:f4:c5:d5:1f:3a:</span><br><span class="line">         95:d2:97:a3:b9:a2:73:69:be:2c:60:42:2b:d2:de:f9:a8:2c:</span><br><span class="line">         ee:d2:b8:62:fb:8e:57:44:93:b7:27:f9:ce:76:9c:d5:ad:cb:</span><br><span class="line">         47:95:de:d0:62:97:46:f3:a2:d9:bf:20:b2:d4:36:a4:2e:e8:</span><br><span class="line">         08:61:ea:4a:db:35:58:5e:31:20:a1:f7:4c:21:23:2f:c8:db:</span><br><span class="line">         d4:2c:d7:e4:6c:e5:48:e6:8f:0d:69:78:5c:a4:23:91:e0:13:</span><br><span class="line">         4c:58:4a:10:9b:8f:1b:7d:c5:f9:68:7c:de:69:85:31:74:90:</span><br><span class="line">         f1:00:cb:d9:0d:23:8e:4b:5d:79:26:8b:3d:95:f7:7c:5a:f4:</span><br><span class="line">         a4:7d:fd:db:f4:d3:e2:75:17:18:40:16:b1:b0:c2:73:07:2a:</span><br><span class="line">         3b:b8:17:2a:c4:11:d1:a7:2e:17:e0:71:31:a7:2c:b5:d2:7a:</span><br><span class="line">         db:46:94:ec:09:68:5e:00:14:2d:9a:9d:7e:68:e1:bd:cd:e0:</span><br><span class="line">         48:2e:94:63:01:c3:49:2b:69:a7:db:f4:3c:96:a3:6d:5f:37:</span><br><span class="line">         eb:86:f6:bf</span><br></pre></td></tr></table></figure><h2 id="etcd-CA详细信息"><a href="#etcd-CA详细信息" class="headerlink" title="etcd CA详细信息"></a>etcd CA详细信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# openssl x509 -in ca.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 0 (0x0)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = etcd-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:05 2022 GMT</span><br><span class="line">            Not After : Sep 14 10:20:05 2032 GMT</span><br><span class="line">        Subject: CN = etcd-ca</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:da:27:fa:1a:96:1a:d6:0f:e0:ab:ab:45:c0:7b:</span><br><span class="line">                    33:69:fe:c2:de:78:e1:7f:e7:50:7b:aa:c3:d5:d7:</span><br><span class="line">                    0f:43:c8:01:83:be:cc:8e:a5:d2:05:28:17:ed:30:</span><br><span class="line">                    e2:d1:92:d5:6d:c7:52:76:76:aa:28:d2:21:4b:2a:</span><br><span class="line">                    c0:6c:06:b9:a0:26:8e:80:3e:5a:dc:93:f7:61:4f:</span><br><span class="line">                    fa:de:28:1a:41:df:0b:5f:13:50:2c:e3:49:b1:34:</span><br><span class="line">                    42:c9:7a:f4:7c:8e:04:40:8b:ea:af:d6:85:96:6a:</span><br><span class="line">                    37:d0:8b:1c:81:a6:98:17:7a:e7:ef:52:15:4e:83:</span><br><span class="line">                    46:8e:1f:23:68:90:ea:65:52:46:e6:02:cf:98:90:</span><br><span class="line">                    87:22:85:5e:5b:58:a7:68:90:13:b0:5b:15:57:2e:</span><br><span class="line">                    7f:01:f4:7f:b7:80:10:1e:ff:75:f4:28:3b:a5:bc:</span><br><span class="line">                    9c:5a:14:d0:02:e5:ea:33:79:22:99:97:7a:25:46:</span><br><span class="line">                    94:91:79:bc:a6:7b:6a:0b:d7:75:2e:b7:11:cb:3a:</span><br><span class="line">                    dd:0c:83:34:d8:a5:e3:2b:e2:1d:2c:82:c4:c3:e9:</span><br><span class="line">                    67:41:2e:9b:53:dd:51:c2:cf:27:e8:79:5b:8c:c5:</span><br><span class="line">                    33:f5:a8:87:0b:f5:f8:29:62:05:0b:2c:27:f8:c8:</span><br><span class="line">                    65:ed:ba:c2:fe:30:1a:b2:8e:1a:9f:49:14:84:6d:</span><br><span class="line">                    2c:73</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment, Certificate Sign</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                6A:87:F2:2F:84:67:97:88:97:A3:1B:55:18:AD:1E:AB:5C:33:5B:14</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:etcd-ca</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         15:9a:c9:5f:d8:b7:a9:38:02:5d:5b:76:2c:b0:8d:c6:9a:74:</span><br><span class="line">         89:2c:05:5c:a5:b3:d9:23:11:70:7b:91:bb:bb:4e:e7:f5:a4:</span><br><span class="line">         84:11:72:42:5d:ff:78:80:f8:ef:ee:4b:e2:00:13:8d:0c:c4:</span><br><span class="line">         43:53:44:d4:85:6a:d3:12:1e:e6:b0:ef:09:65:2e:d7:d3:fe:</span><br><span class="line">         83:dc:c8:e3:51:c0:e8:b4:68:32:59:f2:2d:9c:c5:de:c1:78:</span><br><span class="line">         fd:46:36:06:db:39:ff:65:3a:2f:3a:f6:1f:c9:4e:60:87:53:</span><br><span class="line">         39:db:b4:71:d6:87:16:da:a1:6a:fc:10:33:67:6b:78:68:ff:</span><br><span class="line">         ce:fe:cf:a7:62:fc:b4:ea:1d:9d:e7:14:de:79:22:69:d4:d0:</span><br><span class="line">         9b:c1:59:c0:28:92:80:bc:5d:39:d9:39:09:4b:48:56:6c:f6:</span><br><span class="line">         1a:54:de:31:2f:ca:ef:64:a1:6a:d5:da:e9:ff:d9:a2:52:7a:</span><br><span class="line">         88:fc:5b:7a:60:92:e3:1c:5c:b1:b0:80:18:1d:fe:14:22:69:</span><br><span class="line">         d8:8f:28:0c:4e:42:bc:a5:97:a1:4e:f4:db:22:b1:e4:3f:51:</span><br><span class="line">         ba:f9:04:bc:94:17:43:b0:7c:58:d6:da:11:3e:52:63:41:34:</span><br><span class="line">         4e:5d:c8:bc:01:b8:2a:30:ae:93:8a:92:6b:f0:e6:d3:bd:95:</span><br><span class="line">         89:b1:a7:ec</span><br></pre></td></tr></table></figure><h2 id="etcd-CA创建方法"><a href="#etcd-CA创建方法" class="headerlink" title="etcd CA创建方法"></a>etcd CA创建方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# ls</span><br><span class="line">xiaowangc.cnf</span><br><span class="line">[root@master etcd]# cat xiaowangc.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:etcd-ca</span><br><span class="line">==============================================================</span><br><span class="line">[root@master etcd]# openssl req -new -newkey rsa:2048 -keyout etcd-ca.key -out etcd-ca.csr -nodes -subj &#x27;/CN=etcd-ca&#x27;</span><br><span class="line">Generating a RSA private key</span><br><span class="line">.........+++++</span><br><span class="line">............................................................................................+++++</span><br><span class="line">writing new private key to &#x27;etcd-ca.key&#x27;</span><br><span class="line">-----</span><br><span class="line">[root@master etcd]# ls</span><br><span class="line">etcd-ca.csr  etcd-ca.key  xiaowangc.cnf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master etcd]# openssl x509 -req -days 36500 -sha256 -extfile xiaowangc.cnf -extensions v3_ca -set_serial 0 -signkey etcd-ca.key -in etcd-ca.csr -out etcd-ca.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = etcd-ca</span><br><span class="line">Getting Private key</span><br><span class="line">[root@master etcd]# openssl x509 -in etcd-ca.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 0 (0x0)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = etcd-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 18:39:44 2022 GMT</span><br><span class="line">            Not After : Aug 24 18:39:44 2122 GMT</span><br><span class="line">        Subject: CN = etcd-ca</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:b9:c9:cf:21:2a:e1:4f:b3:5c:5c:cc:0c:8e:6d:</span><br><span class="line">                    bc:86:18:97:0a:5c:ea:da:b8:88:9d:d4:9f:e1:d1:</span><br><span class="line">                    56:48:db:a4:c6:4c:27:63:68:27:70:b6:8b:4b:e0:</span><br><span class="line">                    fd:cb:60:c1:e5:a0:ce:5c:18:a0:4d:65:59:42:c4:</span><br><span class="line">                    ee:32:d2:57:74:7f:b3:2a:de:88:c8:54:b9:f3:f5:</span><br><span class="line">                    21:ee:79:88:11:73:f0:df:52:91:09:62:31:b1:67:</span><br><span class="line">                    a9:61:47:1d:6e:25:d2:0b:7a:4b:29:ce:06:0b:42:</span><br><span class="line">                    8b:e0:c5:aa:58:69:41:b3:b6:ab:ac:62:02:9b:c7:</span><br><span class="line">                    ab:88:23:9e:c0:6d:e4:49:2b:cc:c3:15:71:22:db:</span><br><span class="line">                    fb:14:90:60:c3:4d:6c:4a:4e:3e:53:01:ab:51:ac:</span><br><span class="line">                    33:94:a4:0c:3b:5c:c3:d7:fc:64:f4:a7:f8:75:70:</span><br><span class="line">                    2b:ad:32:e6:18:3d:92:78:fb:5c:bd:be:18:f8:07:</span><br><span class="line">                    95:8a:e3:71:aa:0a:85:e5:ae:1c:7c:64:ec:6e:2b:</span><br><span class="line">                    97:19:f5:0e:71:d0:17:78:13:92:76:8e:bc:3f:53:</span><br><span class="line">                    c7:0d:2a:d6:9d:f1:82:8d:ef:d2:dd:02:2e:39:a5:</span><br><span class="line">                    00:26:35:7e:99:47:93:5a:44:9a:d7:03:05:3d:df:</span><br><span class="line">                    14:47:dc:03:47:9f:31:6f:a5:0a:d1:27:7d:5c:9c:</span><br><span class="line">                    3b:51</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment, Certificate Sign</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                99:DC:10:B3:F8:63:BA:F7:DB:B2:B5:97:24:77:D2:DC:6D:F2:E1:1B</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:etcd-ca</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         0c:08:05:9c:0c:56:6e:52:c8:17:da:42:5a:2f:94:ee:ba:9e:</span><br><span class="line">         ca:7c:b3:f0:cd:1e:55:f5:6b:2d:1c:e8:da:40:e6:b7:55:da:</span><br><span class="line">         6c:7e:2e:33:3c:8e:15:1c:b0:03:ba:e2:cd:a9:51:28:f0:fa:</span><br><span class="line">         c4:a9:70:74:d7:6d:82:ec:47:38:72:b8:dc:aa:61:f4:8b:7f:</span><br><span class="line">         6f:ae:a1:c9:e1:86:a9:16:94:1c:5d:5e:0f:32:95:9c:40:12:</span><br><span class="line">         f1:8c:df:00:91:0d:39:3f:8f:15:b1:93:aa:15:71:af:bb:bb:</span><br><span class="line">         ca:b9:28:ef:6c:cd:e0:7f:65:ce:1c:ef:2f:71:cf:c0:aa:47:</span><br><span class="line">         16:34:62:4a:63:ef:44:e9:c2:0c:cd:22:fb:f4:4a:21:6d:26:</span><br><span class="line">         ad:cc:ac:af:ab:97:a2:14:23:97:3b:be:ec:3b:ca:ff:36:b5:</span><br><span class="line">         b0:1f:00:60:c8:40:6a:61:8d:df:56:fd:c4:08:9d:f7:a6:fc:</span><br><span class="line">         20:71:62:bf:34:74:4b:34:dc:d5:b6:a5:c9:5f:ee:94:5d:01:</span><br><span class="line">         f3:cf:a0:48:3d:74:6b:d5:e3:e4:1a:89:d4:d7:05:84:f2:e3:</span><br><span class="line">         b8:43:8b:c7:15:0c:a6:8f:d9:8f:18:9c:96:9f:c3:a2:bb:43:</span><br><span class="line">         89:6f:8c:8b:51:c8:6c:50:33:d8:ff:ff:c7:4e:d8:db:0d:3b:</span><br><span class="line">         f7:83:f4:aa</span><br></pre></td></tr></table></figure><h2 id="etcd证书详细信息"><a href="#etcd证书详细信息" class="headerlink" title="etcd证书详细信息"></a>etcd证书详细信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# openssl x509 -in server.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 1417249744485671725 (0x13ab15223a14e32d)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = etcd-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:05 2022 GMT</span><br><span class="line">            Not After : Sep 17 10:20:05 2023 GMT</span><br><span class="line">        Subject: CN = master</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:c5:6a:dc:04:22:d5:86:1d:ab:af:97:90:bc:49:</span><br><span class="line">                    91:ed:3a:5b:37:f3:4b:7c:55:1f:4b:bc:9b:d2:89:</span><br><span class="line">                    db:7d:aa:8d:a5:a9:b2:2c:a0:00:6d:ee:b2:cd:18:</span><br><span class="line">                    22:b6:87:df:f5:6e:5b:4a:90:92:cc:51:76:af:7c:</span><br><span class="line">                    8c:2a:26:9b:9c:31:c4:b6:c6:b9:28:ea:60:1e:1e:</span><br><span class="line">                    93:86:40:aa:74:10:08:e9:b2:d6:ec:48:b0:54:e2:</span><br><span class="line">                    a3:9e:8f:03:57:44:fd:33:83:11:c9:e1:29:8f:38:</span><br><span class="line">                    4c:82:62:f4:55:f7:40:bd:f3:64:1b:be:f4:f0:3b:</span><br><span class="line">                    c7:e1:b3:09:81:fe:70:44:b8:cb:5e:0e:fd:ac:6c:</span><br><span class="line">                    70:78:c5:1d:5e:a8:2c:4e:8b:6c:00:11:63:d7:39:</span><br><span class="line">                    6f:b8:47:bc:ef:f7:f2:de:c5:d2:24:37:ad:ae:22:</span><br><span class="line">                    75:40:04:96:61:e4:d3:20:94:a6:0f:84:1c:7a:8b:</span><br><span class="line">                    32:7e:54:a3:00:d9:57:8e:d5:23:cd:a6:32:fb:ae:</span><br><span class="line">                    92:25:51:24:f3:39:92:9c:86:6d:94:ab:f5:bf:f7:</span><br><span class="line">                    52:17:03:de:b5:ba:4f:82:6b:79:13:54:bb:2d:ca:</span><br><span class="line">                    b4:7e:88:40:8a:b6:f5:b3:2d:8a:88:f8:9e:f4:77:</span><br><span class="line">                    7e:d5:13:67:0e:bc:2a:a0:6e:d0:76:95:66:00:e3:</span><br><span class="line">                    47:25</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication, TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:6A:87:F2:2F:84:67:97:88:97:A3:1B:55:18:AD:1E:AB:5C:33:5B:14</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:localhost, DNS:master, IP Address:192.168.64.11, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         21:2b:05:67:46:e1:3b:b5:77:c5:9b:29:6b:06:70:6f:9d:09:</span><br><span class="line">         44:24:40:21:79:77:06:0e:3a:c8:27:2e:89:44:67:af:9e:91:</span><br><span class="line">         0e:4a:a6:4d:03:98:c7:92:36:f5:28:68:68:97:ec:fb:03:25:</span><br><span class="line">         13:54:90:b3:ac:0c:14:cf:d0:6c:d5:be:13:ef:05:3a:4d:43:</span><br><span class="line">         bf:03:d2:7e:c5:16:64:f2:a7:ec:a5:22:2b:3d:50:ef:6e:40:</span><br><span class="line">         c1:43:5e:76:20:19:06:2f:39:cc:b0:71:cb:24:6f:e6:bf:48:</span><br><span class="line">         0b:3f:14:5a:bb:f6:27:b6:a1:25:38:55:db:ea:4c:84:57:9d:</span><br><span class="line">         19:74:66:e1:78:3d:be:04:ad:24:7a:af:d1:a6:fa:e9:26:39:</span><br><span class="line">         bd:14:ba:bc:31:b4:a4:2a:6e:34:db:ca:0c:d9:b2:3a:11:9b:</span><br><span class="line">         f2:15:67:9f:db:a2:54:30:29:d1:be:e9:f3:6f:80:79:f4:35:</span><br><span class="line">         88:4e:6f:d3:6d:f7:4e:88:20:f1:50:ba:71:c3:d7:93:dc:b5:</span><br><span class="line">         07:3d:44:75:4d:75:f3:65:5a:80:b8:29:7a:64:bb:23:c9:03:</span><br><span class="line">         59:22:37:25:57:1f:8f:99:5c:5e:f6:ee:3b:d8:06:60:4d:0d:</span><br><span class="line">         d4:9a:44:3e:79:4a:04:40:5d:6c:16:88:a7:88:d5:d4:00:f9:</span><br><span class="line">         8a:31:13:73</span><br></pre></td></tr></table></figure><h2 id="etcd证书创建方法"><a href="#etcd证书创建方法" class="headerlink" title="etcd证书创建方法"></a>etcd证书创建方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# cat xiaowangc.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:master,IP:127.0.0.1, IP:192.168.64.11</span><br><span class="line">================================================================================================</span><br><span class="line">[root@master etcd]# openssl req -new -newkey rsa:2048 -keyout etcd.key -out etcd.csr -nodes -subj &#x27;/CN=master&#x27;</span><br><span class="line">Generating a RSA private key</span><br><span class="line">..........+++++</span><br><span class="line">........+++++</span><br><span class="line">writing new private key to &#x27;etcd.key&#x27;</span><br><span class="line">-----</span><br><span class="line">[root@master etcd]# openssl x509 -req -sha256 -days 36500 -extfile xiaowangc.cnf -extensions v3_req -in etcd.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out etcd.crt -CAcreateserial</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = master</span><br><span class="line">Getting CA Private Key</span><br><span class="line">[root@master etcd]# openssl x509 -in etcd.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            71:0d:f4:02:36:9e:08:d4:9c:a8:40:ee:56:ca:df:79:69:ff:3e:47</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = etcd-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 18:49:13 2022 GMT</span><br><span class="line">            Not After : Aug 24 18:49:13 2122 GMT</span><br><span class="line">        Subject: CN = master</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:d8:1d:78:c3:92:84:21:e9:fb:42:5b:90:51:b3:</span><br><span class="line">                    56:4b:4b:ee:a6:95:52:48:6f:c2:89:c3:30:a8:33:</span><br><span class="line">                    b0:a9:9d:22:c1:2d:b6:dd:75:c8:f2:81:16:86:c4:</span><br><span class="line">                    ab:cd:2e:b5:dd:6d:ce:79:9d:24:bd:4a:4f:e3:0c:</span><br><span class="line">                    48:5a:05:cb:40:28:91:db:43:0d:88:66:1a:ad:fc:</span><br><span class="line">                    33:69:74:49:90:96:35:01:fa:5a:2d:b1:0c:e6:e6:</span><br><span class="line">                    2c:7b:90:47:95:7c:13:c9:84:3e:f4:f3:d3:c4:8d:</span><br><span class="line">                    b5:18:a5:22:73:ac:71:a4:ff:31:a4:1e:a8:ac:2b:</span><br><span class="line">                    ab:69:aa:5c:5d:d7:93:d1:a4:c4:dd:87:f4:c8:e2:</span><br><span class="line">                    09:ab:ca:0c:06:c5:02:46:60:3a:a6:37:f9:b4:fa:</span><br><span class="line">                    b3:60:9d:75:58:30:5d:82:e9:a1:62:51:61:af:cd:</span><br><span class="line">                    e8:b1:4a:b2:72:26:1a:59:6a:d3:46:76:80:7b:64:</span><br><span class="line">                    de:61:70:46:45:87:b5:cb:dd:bb:2e:77:f3:00:1e:</span><br><span class="line">                    16:32:8d:6b:65:c8:7a:c0:ce:0e:00:46:07:54:59:</span><br><span class="line">                    e7:d6:d8:63:34:d9:0f:5b:84:d8:64:75:63:37:02:</span><br><span class="line">                    c9:14:4c:05:8a:01:8b:46:60:ea:a1:38:a6:6c:75:</span><br><span class="line">                    1d:3d:a1:41:53:92:b0:2c:e9:58:f9:fe:9e:ea:16:</span><br><span class="line">                    22:31</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication, TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:99:DC:10:B3:F8:63:BA:F7:DB:B2:B5:97:24:77:D2:DC:6D:F2:E1:1B</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:localhost, DNS:master, IP Address:127.0.0.1, IP Address:192.168.64.11</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         1f:de:42:6b:49:8c:df:89:17:93:6c:c6:36:79:6b:87:d9:5f:</span><br><span class="line">         57:9e:2e:5c:d0:91:c7:3d:f5:af:f2:92:3c:72:44:c5:1b:f4:</span><br><span class="line">         d4:51:12:ca:5f:d6:88:10:fa:99:a5:b7:5b:bd:d7:51:71:0c:</span><br><span class="line">         36:76:82:55:2a:49:83:e7:84:ff:b4:fd:46:29:6f:73:59:9e:</span><br><span class="line">         8e:ba:29:cc:4c:37:79:a6:84:88:5d:6a:72:25:82:a2:dc:ed:</span><br><span class="line">         bb:3b:81:51:94:f6:1a:7a:ce:ee:be:cc:65:c5:e2:aa:ed:93:</span><br><span class="line">         59:17:15:6e:fa:6c:32:5a:64:98:6a:8d:c9:c4:2a:3d:2f:d1:</span><br><span class="line">         89:61:c7:df:a9:fa:ea:bf:1e:6f:59:c0:cc:48:e6:9c:63:20:</span><br><span class="line">         2e:32:f1:58:38:c6:54:de:cf:66:5d:ae:b8:c6:b0:ff:3d:25:</span><br><span class="line">         82:99:d7:a1:f3:9b:cb:de:d1:ca:c8:64:68:0d:da:6a:18:c9:</span><br><span class="line">         f6:23:10:84:ff:82:82:80:9e:c0:ba:e4:c8:a5:16:8b:6e:1e:</span><br><span class="line">         ff:e7:e8:5d:5f:08:7a:bd:60:2a:f8:37:bd:a4:ca:11:95:ea:</span><br><span class="line">         05:f9:d7:20:8a:a3:c4:34:b7:c1:2a:56:3d:2a:ef:ab:92:e4:</span><br><span class="line">         3f:75:9f:80:3c:b8:d5:d5:0b:93:67:88:0a:ce:ab:0f:aa:b9:</span><br><span class="line">         f3:24:be:25</span><br></pre></td></tr></table></figure><h2 id="peer证书详细信息"><a href="#peer证书详细信息" class="headerlink" title="peer证书详细信息"></a>peer证书详细信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此证书与etcd没啥差别</span></span><br><span class="line">[root@master etcd]# openssl x509 -in peer.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 5472109028630849635 (0x4bf0d62b47bfe863)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = etcd-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:05 2022 GMT</span><br><span class="line">            Not After : Sep 17 10:20:05 2023 GMT</span><br><span class="line">        Subject: CN = master</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:ca:4c:e3:cd:af:4f:f4:11:0e:8a:2b:c3:b6:6d:</span><br><span class="line">                    18:03:f1:90:29:a2:28:59:4c:3e:7c:5e:ec:47:0c:</span><br><span class="line">                    bd:de:0a:7c:40:ef:9a:2b:bb:30:cb:98:1a:88:47:</span><br><span class="line">                    c9:c6:b7:e4:81:d4:77:e2:88:d8:af:0a:49:a7:be:</span><br><span class="line">                    ae:9c:31:95:fd:65:9a:ca:b1:1e:e1:66:68:37:60:</span><br><span class="line">                    45:86:47:f6:b8:bd:06:92:50:02:96:3a:80:71:51:</span><br><span class="line">                    9c:5c:88:cf:6b:50:e7:f6:6d:ab:6a:94:d6:6a:0d:</span><br><span class="line">                    3a:a7:92:73:90:ce:1c:3c:67:e9:e2:e0:5c:d5:f9:</span><br><span class="line">                    9a:1b:0d:64:97:0c:7e:3e:42:36:7a:24:e3:33:eb:</span><br><span class="line">                    4e:6c:88:76:cd:ad:12:25:a4:53:20:25:64:c4:e9:</span><br><span class="line">                    61:81:fe:c0:e4:05:4d:1a:ee:35:2d:da:b1:31:96:</span><br><span class="line">                    5e:a9:04:6c:a1:45:a5:03:01:60:81:6e:6c:eb:07:</span><br><span class="line">                    f5:79:42:87:f0:64:88:47:bf:86:2d:e4:3a:79:ea:</span><br><span class="line">                    c6:95:d6:2b:4d:5c:2c:72:0d:f7:b9:c5:f3:da:00:</span><br><span class="line">                    32:a9:ac:0d:31:9f:33:27:f0:46:a1:9a:cf:c2:c4:</span><br><span class="line">                    63:da:1c:7b:b9:e2:b2:b0:d2:0c:4d:14:68:4f:83:</span><br><span class="line">                    ca:88:33:02:ad:fe:d6:00:80:9b:66:65:9f:45:1a:</span><br><span class="line">                    f1:ff</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication, TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:6A:87:F2:2F:84:67:97:88:97:A3:1B:55:18:AD:1E:AB:5C:33:5B:14</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:localhost, DNS:master, IP Address:192.168.64.11, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         31:3b:b9:eb:45:34:c9:48:e0:e2:27:f6:cf:56:48:37:2b:3d:</span><br><span class="line">         10:4f:fb:d8:ea:a2:9a:d4:56:79:d1:7e:09:8e:ec:cd:62:18:</span><br><span class="line">         57:31:43:05:b2:69:01:34:3a:48:ee:25:a1:8b:81:36:2b:11:</span><br><span class="line">         2a:93:06:ba:73:e3:c1:d9:a2:1d:3e:28:72:9c:11:b4:92:f1:</span><br><span class="line">         cc:9e:2d:4b:a2:c0:16:10:c6:e9:6c:68:99:15:53:49:bd:d5:</span><br><span class="line">         3b:57:d9:37:68:98:c6:7c:90:d0:53:f8:19:34:ff:2b:30:c4:</span><br><span class="line">         e2:40:32:b7:f8:f0:bd:74:c7:57:da:92:49:ed:85:f7:af:81:</span><br><span class="line">         b4:e2:ad:17:5b:d4:8a:d6:ea:55:1b:86:e8:3a:c9:5f:ea:fd:</span><br><span class="line">         1e:a7:ae:71:6e:89:70:08:3d:db:45:bf:94:bf:89:f2:c8:2a:</span><br><span class="line">         1b:16:78:34:89:8d:65:db:18:78:46:a3:ba:cb:40:c2:fa:6d:</span><br><span class="line">         bb:c1:dc:b7:e4:45:6c:a8:87:ef:bf:78:ac:c1:cd:96:d6:49:</span><br><span class="line">         08:75:ec:47:38:42:c4:c6:db:a4:f9:56:2c:81:9e:44:81:91:</span><br><span class="line">         c7:73:59:64:f5:79:e3:28:f8:1f:62:49:ee:2a:76:c9:e7:4a:</span><br><span class="line">         f8:4f:2f:0a:65:ef:3f:f6:8b:65:77:c2:90:aa:14:93:d3:18:</span><br><span class="line">         bf:f6:2f:6e</span><br></pre></td></tr></table></figure><h2 id="peer证书创建方法"><a href="#peer证书创建方法" class="headerlink" title="peer证书创建方法"></a>peer证书创建方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# cat xiaowangc.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:master,IP:127.0.0.1, IP:192.168.64.11</span><br><span class="line">================================================================================================</span><br><span class="line">[root@master etcd]# openssl req -new -newkey rsa:2048 -keyout peer.key -out peer.csr -nodes -subj &#x27;/CN=master&#x27;</span><br><span class="line">[root@master etcd]# openssl x509 -req -sha256 -days 36500 -extfile xiaowangc.cnf -extensions v3_req -in peer.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out peer.crt -CAcreateserial</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = master</span><br><span class="line">Getting CA Private Key</span><br><span class="line">[root@master etcd]# openssl x509 -in peer.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            71:0d:f4:02:36:9e:08:d4:9c:a8:40:ee:56:ca:df:79:69:ff:3e:48</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = etcd-ca</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 19:50:36 2022 GMT</span><br><span class="line">            Not After : Aug 24 19:50:36 2122 GMT</span><br><span class="line">        Subject: CN = master</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:e9:ef:71:77:f8:93:8e:1c:cb:d8:25:22:56:94:</span><br><span class="line">                    1f:d7:55:34:63:a2:fe:42:33:7e:5d:c3:f0:d2:97:</span><br><span class="line">                    b9:46:bf:03:42:83:2d:49:1e:6b:91:96:2c:22:21:</span><br><span class="line">                    76:1e:0d:2f:c1:fb:c0:72:cf:ef:ae:08:fe:74:a3:</span><br><span class="line">                    ee:0a:8a:c6:3a:bf:2a:aa:c7:ef:0c:9f:e4:2e:12:</span><br><span class="line">                    70:6e:10:52:7c:a3:0b:d5:72:59:fd:41:7e:cf:f3:</span><br><span class="line">                    ee:ed:7e:d9:87:5f:be:d3:b3:1c:d9:ed:d2:ef:8e:</span><br><span class="line">                    7d:44:44:39:f7:bc:01:00:a7:ae:d7:6d:86:05:58:</span><br><span class="line">                    df:9e:ed:cd:76:49:f1:63:71:2c:4e:d1:3f:e7:35:</span><br><span class="line">                    e5:96:11:43:49:ba:ce:64:36:ef:81:f3:99:73:6c:</span><br><span class="line">                    e2:04:0a:4d:f0:27:cf:41:e7:15:7e:8b:b2:ff:b6:</span><br><span class="line">                    ae:d5:c8:f5:a5:f3:58:13:3d:97:0b:f3:63:48:ae:</span><br><span class="line">                    61:1f:f7:73:82:86:64:3f:2e:36:f3:50:b8:ae:f6:</span><br><span class="line">                    c2:48:cf:e0:00:0b:42:0e:09:9e:3b:c4:f1:28:e5:</span><br><span class="line">                    c2:a7:51:98:a4:3b:dc:34:96:ec:9f:24:a4:71:26:</span><br><span class="line">                    e0:de:c4:37:f3:1b:23:b9:c0:ed:a1:7f:8e:d5:32:</span><br><span class="line">                    49:b5:b0:4e:1b:e0:66:6e:75:37:1d:e6:4d:dc:a6:</span><br><span class="line">                    06:eb</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication, TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:99:DC:10:B3:F8:63:BA:F7:DB:B2:B5:97:24:77:D2:DC:6D:F2:E1:1B</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:localhost, DNS:master, IP Address:127.0.0.1, IP Address:192.168.64.11</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         a9:0e:22:f3:47:52:4f:61:3e:4a:3a:03:d2:51:3e:9c:f2:96:</span><br><span class="line">         ed:ff:00:6b:f8:cc:68:30:da:6e:b2:50:f9:10:78:70:de:60:</span><br><span class="line">         18:fc:b4:2c:7a:be:c3:48:65:b2:35:7e:79:ce:59:f1:74:bb:</span><br><span class="line">         4f:3e:58:ae:d3:90:e5:63:f2:f2:17:0c:ad:61:68:77:c2:7f:</span><br><span class="line">         13:37:c7:42:57:40:ce:a7:a7:b5:13:a4:56:ae:a7:14:b0:e8:</span><br><span class="line">         f3:b2:67:8b:25:e5:87:2d:f6:c8:40:eb:f1:d7:79:6d:45:45:</span><br><span class="line">         d9:4f:a9:a5:70:1c:78:fd:19:47:b2:6e:f5:39:7c:79:ee:c8:</span><br><span class="line">         6b:d1:12:9d:4c:4c:29:9b:f7:12:4d:32:56:8d:2e:db:c3:1a:</span><br><span class="line">         67:a1:00:f2:15:95:7c:c1:65:70:57:e5:99:90:8d:0d:9d:dc:</span><br><span class="line">         3f:e3:42:90:9a:6a:42:5e:24:19:da:65:56:37:39:9c:c5:84:</span><br><span class="line">         5e:37:21:89:f2:4a:2d:e0:8c:10:08:27:4d:ec:ea:e2:a9:4d:</span><br><span class="line">         c7:a3:ff:0d:21:0d:eb:db:3c:dc:4e:83:75:d7:75:15:43:0d:</span><br><span class="line">         33:74:f6:2d:b3:b2:e6:96:cb:22:19:5e:3b:34:57:4c:3f:9f:</span><br><span class="line">         e3:3f:b3:06:3c:f2:15:c1:54:cd:bb:62:3a:39:17:21:da:d6:</span><br><span class="line">         1d:79:5a:aa</span><br></pre></td></tr></table></figure><h2 id="healthehck-client证书"><a href="#healthehck-client证书" class="headerlink" title="healthehck-client证书"></a>healthehck-client证书</h2><p>此证书在二进制部署方式不需要，用于ETCD通过pod创建时使用</p><h2 id="controller-manager详细信息"><a href="#controller-manager详细信息" class="headerlink" title="controller-manager详细信息"></a>controller-manager详细信息</h2><p><strong>controller-manager证书是存放在&#x2F;etc&#x2F;kubernetes&#x2F;controller-manager.conf文件中</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# cat controller-manager.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:# 下面是CA证书信息</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3hOekV3TWpBd05Gb1hEVE15TURreE5ERXdNakF3TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS1NRCkVScnRRUHBPNzE0VGVueEQ5ZUZ0d25tNFFWWG56L1liUE5MNE5VdXdmcUNPTVg1MGJNTWxiblkya3poZmlSSmQKSWxVK3o4RVYrZGJ6WDJUd0JUWGRxN1pOeDFxdmx2bFpuZDlUY21Zd3l6eUpCRUROVjdmMG9lYWxUSUIwMGVRYQovYjFWeStPL1I0NUhuY3VXUDhMc2lwV3J5U3I1WjRpcnkvVmIrbnB4T2xVeXpTL3BtdVhBTmdGUGVpL0w3MUlpCkxha0NlNmZNRCtMMHpGektCdGVVeVpuWWZMOWxyVm0xeG1QUjVFdkdZN2NaNTl3YmtqbW94VGE1bjdVTzR6SjgKZndiak5oNHVLVzdqOHpvajVTWTJBMEZIZ0RSbnY5NlFxVk5SSkIraGMrRDBrTE1EdmRHcUM0QVpaUzJDbUNLUQpBTUZGUUlGSDIyMCtBRngvNGM4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDdjNSOHRCVEttMDJwTVlNT0RxRUg0eEpnUktNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBR3hwamdwcjVOZmxxMkJBZC9vdQpTQW14WDIyVi9XTmJZZDNDYVA2dVAwY2F3QXdWMm8xY3lucjNwVk9reG8xaDZ6UjBPWkdvNEJpc2tlWUJKUHNkCjdjeVhwRGVseDh2b2QvUjc1NUQ5TmcwOWUybFlSQWlmSE9NZXkvbjdYb0JLNWNRUk9KUWtmZmxvYWFBRFZsNlAKdVBSNXJhUWd0c0hIZUUwVy9hTitqVTQrby92VFJ4TnZzdUtERVpXY1pyYnBOOUJRZjVGc09vRTAyV25XRi9uUQpVOXNwVjlmanJVU0I5MFhqTG1GdDRFUW1ucm5JWjRjMU42TnJqQ0szTk1NdFlidFE2VXo2M3FDVzRtZmRoK3FFCi9DcmVHTTR1T1JLMnBjVjYwYlFHOVhTOFVDWXc4bWN1SVFuTlRpc05NaXMwbCtkelV1Ui9qYVJZS1EydEdaMTAKWlVJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://192.168.64.11:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: system:kube-controller-manager</span><br><span class="line">  name: system:kube-controller-manager@kubernetes</span><br><span class="line">current-context: system:kube-controller-manager@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: system:kube-controller-manager</span><br><span class="line">  user:                                 # controller-manager证书</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURGakNDQWY2Z0F3SUJBZ0lJZlVjQTJvc3RGMmd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1UY3hNREl3TURSYUZ3MHlNekE1TVRjeE1ESXdNRFphTUNreApKekFsQmdOVkJBTVRIbk41YzNSbGJUcHJkV0psTFdOdmJuUnliMnhzWlhJdGJXRnVZV2RsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwyWmlNKzEwOG93cVpsNVh2UUp6TkhRVmdkREV5T1IKakFhRC9tZXFWL2ZjaXdrU0pIS1U2bS9jaFdQdVpiVFE2UlNvMWYyK0o5cmpiWFhmWmNPQUJKUHRzZ3JvZGpwSgpqY0N6dmtBNDJWOVVkbmhDSk5JOGNudGhWdTRjd3FlMlFxZDVPNjZWSVpNMTNJZjhwcU1SRU5ScWZTeGg5eFl2CnRTTzB3cWtaYnRrK2lxbk5SaHpKODBBbU5PVFB0S2FFcGo3Wk4ybTV1WC90cGZoU0NuQzdPcjNMZDNxTzBlWlMKZTBHdlB4R3VWUitBMXg4dVNUQndhdHBhN2dHdDc4NHhhY1hhMDhRSDlPcUFQZXZwZWk2V1R6R2VRNEVUTGZMUQphQVJhNm1KSW1qSkQvTjNycHloWnhTL2ZiZE5HWnIxdjhzNDBDZTBVb3RNcWh0aHMycnptSitzQ0F3RUFBYU5XCk1GUXdEZ1lEVlIwUEFRSC9CQVFEQWdXZ01CTUdBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIKL3dRQ01BQXdId1lEVlIwakJCZ3dGb0FVSy9kSHkwRk1xYlRha3hndzRPb1FmakVtQkVvd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBSU9ZZlczQjI5S1VzNEhPdWtxeUltbzBCeU5meHJRYVlLNzdJMWh0ZnZGZ09HVVNCcWRsCkc0YUR2NnZFRndHaWV0c2Q3RGJPc3ZxUnF5TFhOa1c4dll1SnFoMTh4c3MyZTdKWXlYUUtvbXI1VnVaeUFVaXAKMUJFZUJhcEZuaHdkNUcxZTYxajdKT0tMVHl1YUgyMVY1WmJYVnZrbVRUdWMyOHFYdWY5bUx2ME50dDN5SG1naApXcit6em1hSFU2OFhOdExkZEcxVHNjdFlSbXhyRVVTZTkrTmd1dzhnUWFJRlJnRHhoNjBBWERySmZhc2lLV0lmCks5VDNjME55c3d2ZmF0K0VNaXNIaDdiS29OZWhyNndsTE9iSFNGVU0wbHF0d3NRcCtRMVZTUXJRVVh2eE9vTlYKL09sNVVJSUd6VzdhMTBTRmkrWmJxL0FQOThRTnYvSlVzTm89Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><br><span class="line">    # controller-manager私钥</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdlptSXo3WFR5akNwbVhsZTlBbk0wZEJXQjBNVEk1R01Cb1ArWjZwWDk5eUxDUklrCmNwVHFiOXlGWSs1bHRORHBGS2pWL2I0bjJ1TnRkZDlsdzRBRWsrMnlDdWgyT2ttTndMTytRRGpaWDFSMmVFSWsKMGp4eWUyRlc3aHpDcDdaQ3AzazdycFVoa3pYY2gveW1veEVRMUdwOUxHSDNGaSsxSTdUQ3FSbHUyVDZLcWMxRwpITW56UUNZMDVNKzBwb1NtUHRrM2FibTVmKzJsK0ZJS2NMczZ2Y3QzZW83UjVsSjdRYTgvRWE1Vkg0RFhIeTVKCk1IQnEybHJ1QWEzdnpqRnB4ZHJUeEFmMDZvQTk2K2w2THBaUE1aNURnUk10OHRCb0JGcnFZa2lhTWtQODNldW4KS0ZuRkw5OXQwMFptdlcveXpqUUo3UlNpMHlxRzJHemF2T1luNndJREFRQUJBb0lCQVFDc0RQcFFlcENSQnUydwpmcW9DekMzWUs3VVZhL0dmTWtHZDNBTnRjTy9ZMVlJNW5nUURFazFYYXdhRXMxNEo0aFhRa0pGM2JDcGdnRWJoClV2TFdvSUlHOXdpOHkwd1dBbzhtMGpVUHRFYlZNaUU3YWRKZUVVcFYyZlAzcVpPZWUwOHJDR0YzUUk4eU5ndEUKUDZtN2lnMzZwQk9veGRGaGliTlhqbjJpMDVoNmU2MFE3TGUyc25PQWVHRlVHVlNYRHZCRjIzcjVkV0hDQVpZcwplV2Fjbm02MkF2b3VHNHVEYWF6c20zM1hJVkZOYXpkVHdVRGkwb2lmNi9od2ptSk05TTVJeTl0ZC9hTzlyME9OCjFPMVJUMk9ycGcrSWFYWk4zWnJJRFFnWUpSeXZOSm1wTUJud01GMHpaYU5MemNoRlV1QXA0V0xLNmhJN2NJRGgKbkxCK0wvbFpBb0dCQU9oY3VaZEh6LzFhdXdXZWZEbEMwRGMvd1hoTXEzbERwUzZzVGFCT2gvTktsRFBCQ1RXWApkNzR6YTZPQ3Y2c0Nsd3drT3c3L0dhK2UyeTA3NzA4SHcvbU50ak5uVUlxdFc1ZVdkaEZqSWlENmt4ampjSHR0CitiWGxqaE5vSzQzZnlnYUM0Q3IzRnV6ZnJCRUszRDhjTGhvTkFkN0JvUUZ0eWVMb3JlcHEvZDRuQW9HQkFORGoKSzlpb2U3QWZlS1ovYUNVL2dVZkdEYVlNUjI2N2VGemJrdVdvcXZXQlkxV2NLbVNkYzZEbDRvM0VtT2Z3K21ObgpGR01vMG93cDY3UGtDRjcrcUlTcDVYV3c3cGUrOGRMMnN5U1ZMWnM3ejF0NG5hZE82a01GQXhHWG5VSDAxQVVVCkR2UkFWYWVNR3JwNXJiVDFiZG5JMXE4WXJnanV6SjdRUW1qMEFBYWRBb0dCQUttM2NHY3FzS1FnclJHQm5NSkcKSnNiejdsL3J3Q01tWVhRaHJlRTArdCtjelhxdnVBWkl4OUZJeFluOGFmcUNQY2xFZlU2S3pUd1ZENG1PaVZCMApINVFiQ2NXcDVJNGw2UXhqZllGZG93UHJnWjFnSWp4Rksyck1iR1dJWktlUG1ZUC8rN1BtSGZ5TnNxUVFCcWFoCjhwcGNmYzB5S0dOZXlXTFBDSmg3NVVscEFvR0FIM0l6aFpoSGxvb0dWYnBVYVZjWUZVQUJpZi9MT1NaTHhsN2YKekdjSjVZK203cHBsMzJPOHBubzFFdmFIdGxNV3ZxUWo4NUdQc0w0VzE2djZmcUtEcUFVVG9CWVV0UTl2eER5VApWMnlGd3hyTDZvOUwzSVlLeWpBVStDOEU0NHNCNkFuTy9vSTQ0dEk2cTl2cGhKWjJCUlV4REljQW5DT205am1QCjVkRGx1QmtDZ1lCNDcrVUJhTkd4b3h2NFF0N3o5Z1F0d3hrR2Y1WDFHVW9lK2xDUlB6Ris0S2lmMzB2VE9ZdWIKK1RPYkNLSHFrV1drNDZiTXltaGdGcXhMdFFuY0QwaGNiYitiY0tXODdQTG9aK3VMQ1B5Smt5ZTdBZ3NCRUVSTQpGNzVRY21RVUNPZDhWMk5IaU41eHJKSWtIYWQxaXpPTDY4T0tqTDJ2YmFscm5SZHRCSDZkcnc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br></pre></td></tr></table></figure><p><strong>controller-manager证书是通过base64加密存放与配置文件中，需要进行解密进行查看</strong></p><p><strong>将client-certificate-data的值通过base64 -d进行解密</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# echo LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURGakNDQWY2Z0F3SUJBZ0lJZlVjQTJvc3RGMmd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1UY3hNREl3TURSYUZ3MHlNekE1TVRjeE1ESXdNRFphTUNreApKekFsQmdOVkJBTVRIbk41YzNSbGJUcHJkV0psTFdOdmJuUnliMnhzWlhJdGJXRnVZV2RsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwyWmlNKzEwOG93cVpsNVh2UUp6TkhRVmdkREV5T1IKakFhRC9tZXFWL2ZjaXdrU0pIS1U2bS9jaFdQdVpiVFE2UlNvMWYyK0o5cmpiWFhmWmNPQUJKUHRzZ3JvZGpwSgpqY0N6dmtBNDJWOVVkbmhDSk5JOGNudGhWdTRjd3FlMlFxZDVPNjZWSVpNMTNJZjhwcU1SRU5ScWZTeGg5eFl2CnRTTzB3cWtaYnRrK2lxbk5SaHpKODBBbU5PVFB0S2FFcGo3Wk4ybTV1WC90cGZoU0NuQzdPcjNMZDNxTzBlWlMKZTBHdlB4R3VWUitBMXg4dVNUQndhdHBhN2dHdDc4NHhhY1hhMDhRSDlPcUFQZXZwZWk2V1R6R2VRNEVUTGZMUQphQVJhNm1KSW1qSkQvTjNycHloWnhTL2ZiZE5HWnIxdjhzNDBDZTBVb3RNcWh0aHMycnptSitzQ0F3RUFBYU5XCk1GUXdEZ1lEVlIwUEFRSC9CQVFEQWdXZ01CTUdBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIKL3dRQ01BQXdId1lEVlIwakJCZ3dGb0FVSy9kSHkwRk1xYlRha3hndzRPb1FmakVtQkVvd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBSU9ZZlczQjI5S1VzNEhPdWtxeUltbzBCeU5meHJRYVlLNzdJMWh0ZnZGZ09HVVNCcWRsCkc0YUR2NnZFRndHaWV0c2Q3RGJPc3ZxUnF5TFhOa1c4dll1SnFoMTh4c3MyZTdKWXlYUUtvbXI1VnVaeUFVaXAKMUJFZUJhcEZuaHdkNUcxZTYxajdKT0tMVHl1YUgyMVY1WmJYVnZrbVRUdWMyOHFYdWY5bUx2ME50dDN5SG1naApXcit6em1hSFU2OFhOdExkZEcxVHNjdFlSbXhyRVVTZTkrTmd1dzhnUWFJRlJnRHhoNjBBWERySmZhc2lLV0lmCks5VDNjME55c3d2ZmF0K0VNaXNIaDdiS29OZWhyNndsTE9iSFNGVU0wbHF0d3NRcCtRMVZTUXJRVVh2eE9vTlYKL09sNVVJSUd6VzdhMTBTRmkrWmJxL0FQOThRTnYvSlVzTm89Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K | base64 -d &gt; cm.crt</span><br><span class="line">[root@master kubernetes]# cat cm.crt</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDFjCCAf6gAwIBAgIIfUcA2ostF2gwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE</span><br><span class="line">AxMKa3ViZXJuZXRlczAeFw0yMjA5MTcxMDIwMDRaFw0yMzA5MTcxMDIwMDZaMCkx</span><br><span class="line">JzAlBgNVBAMTHnN5c3RlbTprdWJlLWNvbnRyb2xsZXItbWFuYWdlcjCCASIwDQYJ</span><br><span class="line">KoZIhvcNAQEBBQADggEPADCCAQoCggEBAL2ZiM+108owqZl5XvQJzNHQVgdDEyOR</span><br><span class="line">jAaD/meqV/fciwkSJHKU6m/chWPuZbTQ6RSo1f2+J9rjbXXfZcOABJPtsgrodjpJ</span><br><span class="line">jcCzvkA42V9UdnhCJNI8cnthVu4cwqe2Qqd5O66VIZM13If8pqMRENRqfSxh9xYv</span><br><span class="line">tSO0wqkZbtk+iqnNRhzJ80AmNOTPtKaEpj7ZN2m5uX/tpfhSCnC7Or3Ld3qO0eZS</span><br><span class="line">e0GvPxGuVR+A1x8uSTBwatpa7gGt784xacXa08QH9OqAPevpei6WTzGeQ4ETLfLQ</span><br><span class="line">aARa6mJImjJD/N3rpyhZxS/fbdNGZr1v8s40Ce0UotMqhths2rzmJ+sCAwEAAaNW</span><br><span class="line">MFQwDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAwGA1UdEwEB</span><br><span class="line">/wQCMAAwHwYDVR0jBBgwFoAUK/dHy0FMqbTakxgw4OoQfjEmBEowDQYJKoZIhvcN</span><br><span class="line">AQELBQADggEBAIOYfW3B29KUs4HOukqyImo0ByNfxrQaYK77I1htfvFgOGUSBqdl</span><br><span class="line">G4aDv6vEFwGietsd7DbOsvqRqyLXNkW8vYuJqh18xss2e7JYyXQKomr5VuZyAUip</span><br><span class="line">1BEeBapFnhwd5G1e61j7JOKLTyuaH21V5ZbXVvkmTTuc28qXuf9mLv0Ntt3yHmgh</span><br><span class="line">Wr+zzmaHU68XNtLddG1TsctYRmxrEUSe9+Nguw8gQaIFRgDxh60AXDrJfasiKWIf</span><br><span class="line">K9T3c0Nyswvfat+EMisHh7bKoNehr6wlLObHSFUM0lqtwsQp+Q1VSQrQUXvxOoNV</span><br><span class="line">/Ol5UIIGzW7a10SFi+Zbq/AP98QNv/JUsNo=</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">[root@master kubernetes]# openssl x509 -in cm.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 9027184916725307240 (0x7d4700da8b2d1768)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:04 2022 GMT</span><br><span class="line">            Not After : Sep 17 10:20:06 2023 GMT</span><br><span class="line">        Subject: CN = system:kube-controller-manager</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:bd:99:88:cf:b5:d3:ca:30:a9:99:79:5e:f4:09:</span><br><span class="line">                    cc:d1:d0:56:07:43:13:23:91:8c:06:83:fe:67:aa:</span><br><span class="line">                    57:f7:dc:8b:09:12:24:72:94:ea:6f:dc:85:63:ee:</span><br><span class="line">                    65:b4:d0:e9:14:a8:d5:fd:be:27:da:e3:6d:75:df:</span><br><span class="line">                    65:c3:80:04:93:ed:b2:0a:e8:76:3a:49:8d:c0:b3:</span><br><span class="line">                    be:40:38:d9:5f:54:76:78:42:24:d2:3c:72:7b:61:</span><br><span class="line">                    56:ee:1c:c2:a7:b6:42:a7:79:3b:ae:95:21:93:35:</span><br><span class="line">                    dc:87:fc:a6:a3:11:10:d4:6a:7d:2c:61:f7:16:2f:</span><br><span class="line">                    b5:23:b4:c2:a9:19:6e:d9:3e:8a:a9:cd:46:1c:c9:</span><br><span class="line">                    f3:40:26:34:e4:cf:b4:a6:84:a6:3e:d9:37:69:b9:</span><br><span class="line">                    b9:7f:ed:a5:f8:52:0a:70:bb:3a:bd:cb:77:7a:8e:</span><br><span class="line">                    d1:e6:52:7b:41:af:3f:11:ae:55:1f:80:d7:1f:2e:</span><br><span class="line">                    49:30:70:6a:da:5a:ee:01:ad:ef:ce:31:69:c5:da:</span><br><span class="line">                    d3:c4:07:f4:ea:80:3d:eb:e9:7a:2e:96:4f:31:9e:</span><br><span class="line">                    43:81:13:2d:f2:d0:68:04:5a:ea:62:48:9a:32:43:</span><br><span class="line">                    fc:dd:eb:a7:28:59:c5:2f:df:6d:d3:46:66:bd:6f:</span><br><span class="line">                    f2:ce:34:09:ed:14:a2:d3:2a:86:d8:6c:da:bc:e6:</span><br><span class="line">                    27:eb</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:2B:F7:47:CB:41:4C:A9:B4:DA:93:18:30:E0:EA:10:7E:31:26:04:4A</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         83:98:7d:6d:c1:db:d2:94:b3:81:ce:ba:4a:b2:22:6a:34:07:</span><br><span class="line">         23:5f:c6:b4:1a:60:ae:fb:23:58:6d:7e:f1:60:38:65:12:06:</span><br><span class="line">         a7:65:1b:86:83:bf:ab:c4:17:01:a2:7a:db:1d:ec:36:ce:b2:</span><br><span class="line">         fa:91:ab:22:d7:36:45:bc:bd:8b:89:aa:1d:7c:c6:cb:36:7b:</span><br><span class="line">         b2:58:c9:74:0a:a2:6a:f9:56:e6:72:01:48:a9:d4:11:1e:05:</span><br><span class="line">         aa:45:9e:1c:1d:e4:6d:5e:eb:58:fb:24:e2:8b:4f:2b:9a:1f:</span><br><span class="line">         6d:55:e5:96:d7:56:f9:26:4d:3b:9c:db:ca:97:b9:ff:66:2e:</span><br><span class="line">         fd:0d:b6:dd:f2:1e:68:21:5a:bf:b3:ce:66:87:53:af:17:36:</span><br><span class="line">         d2:dd:74:6d:53:b1:cb:58:46:6c:6b:11:44:9e:f7:e3:60:bb:</span><br><span class="line">         0f:20:41:a2:05:46:00:f1:87:ad:00:5c:3a:c9:7d:ab:22:29:</span><br><span class="line">         62:1f:2b:d4:f7:73:43:72:b3:0b:df:6a:df:84:32:2b:07:87:</span><br><span class="line">         b6:ca:a0:d7:a1:af:ac:25:2c:e6:c7:48:55:0c:d2:5a:ad:c2:</span><br><span class="line">         c4:29:f9:0d:55:49:0a:d0:51:7b:f1:3a:83:55:fc:e9:79:50:</span><br><span class="line">         82:06:cd:6e:da:d7:44:85:8b:e6:5b:ab:f0:0f:f7:c4:0d:bf:</span><br><span class="line">         f2:54:b0:da</span><br></pre></td></tr></table></figure><h2 id="controller-manager证书创建"><a href="#controller-manager证书创建" class="headerlink" title="controller-manager证书创建"></a>controller-manager证书创建</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# cat xiaowangc.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">==============================================================================================</span><br><span class="line">[root@master pki]# openssl req -new -newkey rsa:2048 -keyout controller-manager.key -out controller-manager.csr -nodes -subj &#x27;/CN=system:kube-controller-manager&#x27;</span><br><span class="line">Generating a RSA private key</span><br><span class="line">.....................................+++++</span><br><span class="line">........................+++++</span><br><span class="line">writing new private key to &#x27;controller-manager.key&#x27;</span><br><span class="line">-----</span><br><span class="line">[root@master pki]# openssl x509 -req -sha256 -days 36500 -extfile xiaowangc.cnf -extensions v3_req -in controller-manager.csr -CA ca.crt -CAkey ca.pem -out controller-manager.crt -CAcreateserial</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = system:kube-controller-manager</span><br><span class="line">Getting CA Private Key</span><br><span class="line">[root@master pki]# openssl x509 -in controller-manager.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            19:39:ff:4c:dd:c2:d6:76:f3:cc:7e:f9:b8:8c:fb:4e:b5:17:5b:21</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 21:55:00 2022 GMT</span><br><span class="line">            Not After : Aug 24 21:55:00 2122 GMT</span><br><span class="line">        Subject: CN = system:kube-controller-manager</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:a2:08:62:a6:6e:21:0e:1a:e2:73:1a:9b:d7:8b:</span><br><span class="line">                    2c:c0:fe:72:85:77:a3:ca:62:80:5f:bf:f3:6c:14:</span><br><span class="line">                    05:c2:1d:30:68:d7:c9:b0:d1:7f:cf:78:f5:41:8f:</span><br><span class="line">                    a1:60:be:26:58:43:74:c4:af:45:c7:e2:1e:f8:df:</span><br><span class="line">                    53:87:b4:46:20:ab:2e:d7:13:bd:35:f2:55:5b:bd:</span><br><span class="line">                    3a:16:f4:d6:98:c5:a4:7a:57:56:40:ba:98:28:e0:</span><br><span class="line">                    d6:78:11:bd:b5:58:18:8c:4c:ea:8a:88:3e:1b:9a:</span><br><span class="line">                    8f:79:39:32:05:26:61:e1:5d:9c:f1:bb:91:49:8c:</span><br><span class="line">                    39:76:e1:ac:43:a3:dd:5b:82:8b:72:ae:52:83:50:</span><br><span class="line">                    12:20:10:13:3b:66:89:38:9b:de:4a:42:29:81:8a:</span><br><span class="line">                    43:79:31:14:5c:cd:c7:bd:f0:ed:89:99:09:94:d0:</span><br><span class="line">                    e6:43:18:3f:18:14:79:fc:be:85:f7:13:e9:a3:f8:</span><br><span class="line">                    45:67:60:5a:e3:e6:a9:72:79:c4:ca:90:bb:05:89:</span><br><span class="line">                    d3:52:13:f7:6d:b1:10:b7:8a:5a:3e:56:cd:d2:b3:</span><br><span class="line">                    46:bd:fb:10:d3:ba:a0:05:ea:5d:22:c0:40:4e:ed:</span><br><span class="line">                    95:15:7e:80:5b:9a:e7:89:bf:aa:18:1f:b6:ca:1f:</span><br><span class="line">                    c1:a1:79:2c:4f:2c:c6:62:cd:5d:93:35:c7:bd:b6:</span><br><span class="line">                    c8:43</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:33:AC:40:D4:C2:3E:E9:64:2B:F5:00:C7:EB:E9:78:45:62:DD:3E:15</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         31:91:9f:f1:f1:99:6c:81:cb:65:8c:df:1f:db:0d:61:b2:b7:</span><br><span class="line">         fb:34:51:7a:61:17:09:42:8e:19:a4:32:2b:de:23:d3:96:32:</span><br><span class="line">         9f:8f:9f:96:0a:65:1f:ae:3b:cc:db:e6:b6:20:99:c9:5e:58:</span><br><span class="line">         c6:da:ea:e3:9a:64:d2:ee:6c:37:f7:ff:66:1d:87:6e:e5:fc:</span><br><span class="line">         fd:87:db:8e:e4:af:f3:2a:e0:46:db:a7:59:94:74:80:ce:07:</span><br><span class="line">         1e:e6:a5:a4:72:26:c2:de:2b:e1:6d:5b:eb:c0:70:0c:3e:ca:</span><br><span class="line">         39:fe:60:ad:c5:44:7c:fe:6f:ae:b9:5d:08:5b:02:05:88:29:</span><br><span class="line">         d4:24:8c:1a:1b:88:fe:58:4a:d5:ee:6f:4b:37:ac:e0:77:23:</span><br><span class="line">         8d:5a:71:cf:f4:f8:5d:b4:36:df:29:aa:11:42:35:0b:39:b7:</span><br><span class="line">         74:e4:81:c6:f3:29:d6:8f:75:3b:50:53:59:43:1c:75:6e:14:</span><br><span class="line">         5e:64:eb:36:1c:1b:f4:6b:b3:9b:c3:42:98:60:eb:2e:ea:ed:</span><br><span class="line">         f3:65:3a:15:9e:7a:c6:99:99:01:aa:1e:08:73:10:3f:c9:06:</span><br><span class="line">         b3:45:b0:b5:3f:db:08:18:60:bd:3d:5d:fa:29:48:ba:21:34:</span><br><span class="line">         f8:16:51:b1:3e:89:2c:27:a4:55:6d:5f:a4:d1:e7:cd:2d:bd:</span><br><span class="line">         74:eb:17:e7</span><br></pre></td></tr></table></figure><h2 id="scheduler证书详细信息"><a href="#scheduler证书详细信息" class="headerlink" title="scheduler证书详细信息"></a>scheduler证书详细信息</h2><p><strong>scheduler证书同controller-manager证书一样存放在文件中</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# cat scheduler.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    # CA证书</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3hOekV3TWpBd05Gb1hEVE15TURreE5ERXdNakF3TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS1NRCkVScnRRUHBPNzE0VGVueEQ5ZUZ0d25tNFFWWG56L1liUE5MNE5VdXdmcUNPTVg1MGJNTWxiblkya3poZmlSSmQKSWxVK3o4RVYrZGJ6WDJUd0JUWGRxN1pOeDFxdmx2bFpuZDlUY21Zd3l6eUpCRUROVjdmMG9lYWxUSUIwMGVRYQovYjFWeStPL1I0NUhuY3VXUDhMc2lwV3J5U3I1WjRpcnkvVmIrbnB4T2xVeXpTL3BtdVhBTmdGUGVpL0w3MUlpCkxha0NlNmZNRCtMMHpGektCdGVVeVpuWWZMOWxyVm0xeG1QUjVFdkdZN2NaNTl3YmtqbW94VGE1bjdVTzR6SjgKZndiak5oNHVLVzdqOHpvajVTWTJBMEZIZ0RSbnY5NlFxVk5SSkIraGMrRDBrTE1EdmRHcUM0QVpaUzJDbUNLUQpBTUZGUUlGSDIyMCtBRngvNGM4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDdjNSOHRCVEttMDJwTVlNT0RxRUg0eEpnUktNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBR3hwamdwcjVOZmxxMkJBZC9vdQpTQW14WDIyVi9XTmJZZDNDYVA2dVAwY2F3QXdWMm8xY3lucjNwVk9reG8xaDZ6UjBPWkdvNEJpc2tlWUJKUHNkCjdjeVhwRGVseDh2b2QvUjc1NUQ5TmcwOWUybFlSQWlmSE9NZXkvbjdYb0JLNWNRUk9KUWtmZmxvYWFBRFZsNlAKdVBSNXJhUWd0c0hIZUUwVy9hTitqVTQrby92VFJ4TnZzdUtERVpXY1pyYnBOOUJRZjVGc09vRTAyV25XRi9uUQpVOXNwVjlmanJVU0I5MFhqTG1GdDRFUW1ucm5JWjRjMU42TnJqQ0szTk1NdFlidFE2VXo2M3FDVzRtZmRoK3FFCi9DcmVHTTR1T1JLMnBjVjYwYlFHOVhTOFVDWXc4bWN1SVFuTlRpc05NaXMwbCtkelV1Ui9qYVJZS1EydEdaMTAKWlVJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://192.168.64.11:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: system:kube-scheduler</span><br><span class="line">  name: system:kube-scheduler@kubernetes</span><br><span class="line">current-context: system:kube-scheduler@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: system:kube-scheduler</span><br><span class="line">  user:</span><br><span class="line">    # scheduler证书</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUREVENDQWZXZ0F3SUJBZ0lJUVg2RExrcWJFZGd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1UY3hNREl3TURSYUZ3MHlNekE1TVRjeE1ESXdNRFphTUNBeApIakFjQmdOVkJBTVRGWE41YzNSbGJUcHJkV0psTFhOamFHVmtkV3hsY2pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCCkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU5BanA2M3llTkZtRzV6YTRsWDU0dmwycXFScWdFckNPdU01TGhSL2FRS3YKS3BCV01KREZmM1J6Q2hoYk1GMVpHQ0dLYzRkT2ZCMzM3NStqaXY3eHZ4dlpxOU84Ymw4eHl3WDdSOFAyQWgwaQpxc3ZlNVNtUkFUc0ZOa29qTVlXZ0Q2RjhRL29QT3MyWkRJZTJycXJTbzRYRlVFVEtONTBUVFhzb1NqdEt4TlNkCkNKNmZtR1dQcytCSlBRekIzdXN6eFFGbTR4UFR5YytOclI2cXo2UDJucUlEMkpUUXlYUUo5ZkszUkhsMWY5Q00Kc2lVWGFiTlA3QkhIa2NYalEyclRkcll4d3Vsb2xNWSt4ZzhpMDE2MEZMV1ZRaDRSQjlXWmYwc2MxcDdQNzFuQwpKWlFLL0NHeWRhNzUya3BuSTJ4dm1hcEpUU0RxUVF5VWFoYXZVRmcwK1RrQ0F3RUFBYU5XTUZRd0RnWURWUjBQCkFRSC9CQVFEQWdXZ01CTUdBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBd0h3WUQKVlIwakJCZ3dGb0FVSy9kSHkwRk1xYlRha3hndzRPb1FmakVtQkVvd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQgpBQ3ovaVd0eWo3VWU1elhoUDh4UHBaNGZYdHNuTGxXbzdWRUVnVFA0N2JaL2t2T1BiM2hXZ2RhL0xPc3Z1QWdoCkZHdHhFSWk5UEljYnZXWnhFWkdMOUZnV1dzSk0vK3NmRG84QnlmUGUraXFhWUdxQ2YrWTNvcGlqYVVwYndzaGcKeWVTZDkzSlZzWWVVN2Z6VElTNTJuS0tVaWdvN3dNNUhzbmx0YklOL21lOGZkWW9hWURneVF0bU1hd3BKYjdiNgpFbXM2VEFxVWtqNjV0MXdnUGNRUWtsUGxEVW5qcVhMS1kvd2V2SHpUcmJGOXRCVUlsRE1nZXA4TEZSTzBidWhsClFyeUZRYTJUTEpMdnZHOU1iVjM3ZTd0TjNlSzBDcEY0LzBFRCtUdExBVCs3MmRKRG9rYkpCbkdGbHFhZ0JxazcKd3ZxYkc3TGRESzBDcGFTdDJaSFZncDA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><br><span class="line">    # scheduler私钥</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcFFJQkFBS0NBUUVBMENPbnJmSjQwV1libk5yaVZmbmkrWGFxcEdxQVNzSTY0emt1Rkg5cEFxOHFrRll3CmtNVi9kSE1LR0Zzd1hWa1lJWXB6aDA1OEhmZnZuNk9LL3ZHL0c5bXIwN3h1WHpITEJmdEh3L1lDSFNLcXk5N2wKS1pFQk93VTJTaU14aGFBUG9YeEQrZzg2elprTWg3YXVxdEtqaGNWUVJNbzNuUk5OZXloS08wckUxSjBJbnArWQpaWSt6NEVrOURNSGU2elBGQVdiakU5UEp6NDJ0SHFyUG8vYWVvZ1BZbE5ESmRBbjE4cmRFZVhWLzBJeXlKUmRwCnMwL3NFY2VSeGVORGF0TjJ0akhDNldpVXhqN0dEeUxUWHJRVXRaVkNIaEVIMVpsL1N4elducy92V2NJbGxBcjgKSWJKMXJ2bmFTbWNqYkcrWnFrbE5JT3BCREpScUZxOVFXRFQ1T1FJREFRQUJBb0lCQVFDTFhYUm5LcFh2VC9scApPNzZWWnU2dHJ1RnZtY2d4Um9CN3FNdkwrY3ZzZWpGNzE5cEk5WlR6K2h0bVY1aTR5SEU1OUNTTEV1aFVnTEU0CktSOW11YVFIRitiUHJib1JqNXVyYzZlSDlPOVJadWNKLzBOZVk3TjVPM0l3amdRWXZ5WDRNT2FyUnd0T293NGEKeVIySFQrY2lLUTRvSVdhL2pDOHpLYlVhb21QTkgrdG9XOEFkbjJoa1ZLNCtMdDZkT3F6bHB0SWRNdGRHVTRRLwpvaTF0QzVYV0lvTHN4L1Y4ZldvSXlHZk10U291NlRCa0pSMnBieEV0ZWh5aEg5K2FScEtRMlZmeERzMHBGbFJVClRYMi9rU0t4VThrd24wNUJCdklPZWtNVjhnZUFJUXg2VnJIUTEzNHg5emVSYzZ2ZkRjYTlaZjI3V0ZpZzU0cXQKaUdGMTJJOEJBb0dCQU9Cc3BTUThMUUFYQzNyWTlld1FzNEs4WHN3aC9XdWJodnhadWkvQ2VsVjRvSUdxK1ZDYgpJQ21YcmFIaHJPa3I0ZzN4dXRJdHBPMXAwUUdIK2t6SUxQZDVmdzh1N25CYy8yK1N5QWFjWHJXOWdJSDR1REMvClBrMnZ2VURSWU9EQmRUTmlvMUt5YU5ja1p3RzEzSkdueTd4MzFIekhYU016TnozUU1HQXhBbldKQW9HQkFPMXMKY3lvZlZMQjVXTGdkenU1UWNSb1Ntd3VMbHBFRlRlSVg2dldrZ1NKblFuUXhGRWhGc24yVEVDcGwzUnROMCsvegpiLzhPeFRKZExYaUdwS3NjR1JTRU5hcTMrZFR1aExHYlFHNCt0SnpPRUNPS1Rlb0ZvU1dPdjBNeHUvQThHWHo0CnZXNE1qMWJTeWNTMDBZWThld3BHS0tFUWp0VDNNbmpHSDBUcTFDb3hBb0dCQUxkSW81b3pOd0V5ME9KVVhJdWQKbkMxeVQrMWcrUW12N0E4ZDdJdml4V3dXWnVkZlRkd0J4TU9USjIvazBnVmdIRzhNODJtQmM0ZWRldDlJUVNnQgo5NDlvLzFiVUdsRlQ4aDBhQUJnK0RxOVlnNklpRWJObURLai9sSTFpTWo5OFg0NUd5V0haYVB3RHM4aFcwVHQzCmtWRnJmL01rRXJHVHUxTFZPeHprQ2NFWkFvR0FlMmlnbitkekxOdVdTdlZyaHlJVzkvZHQwZDEzb04vQjhPQi8KeDdqL1NuT2o3aU5JcUp4WnY3MytiQnRRaDQyM3VRU3ZWVU5IS3Z1VjFBMGdjTFNGTU0zYjIyWVBuU2R4bjZQVQpKTG5CUmJReVhWYlpVdWdrTUJKM3hpU0d6TU5nZUQ0T3NMSWttM3VyVnV5cDcvMWw4eHd1cURHa0hIeDFKcVBNCnd4VFF2VEVDZ1lFQXdvKzlRUGdGL0txVVF5akpIemZQS0VEbTZ2R0o3YnUxMTBlM2IvNCtsbmVqTktLc0pCT2QKOWVSKzdkU1ozVUlDaDZIUHNGbzBxMnJRQ2R5OVpZZ3EwV2VTUnZYcTRoZ2xpWlhnTGpaQjVzY3BzenkyTm9zWQp2VHFvYVFHRGFqT2pia0V3RUc5ZjQzZ2VTRTRCeDJ6eWg4YlQ2Wm1waGsxT0lsNFY2ekNmSHBNPQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br></pre></td></tr></table></figure><p>对文件的证书进行解密</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# echo LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUREVENDQWZXZ0F3SUJBZ0lJUVg2RExrcWJFZGd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1UY3hNREl3TURSYUZ3MHlNekE1TVRjeE1ESXdNRFphTUNBeApIakFjQmdOVkJBTVRGWE41YzNSbGJUcHJkV0psTFhOamFHVmtkV3hsY2pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCCkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU5BanA2M3llTkZtRzV6YTRsWDU0dmwycXFScWdFckNPdU01TGhSL2FRS3YKS3BCV01KREZmM1J6Q2hoYk1GMVpHQ0dLYzRkT2ZCMzM3NStqaXY3eHZ4dlpxOU84Ymw4eHl3WDdSOFAyQWgwaQpxc3ZlNVNtUkFUc0ZOa29qTVlXZ0Q2RjhRL29QT3MyWkRJZTJycXJTbzRYRlVFVEtONTBUVFhzb1NqdEt4TlNkCkNKNmZtR1dQcytCSlBRekIzdXN6eFFGbTR4UFR5YytOclI2cXo2UDJucUlEMkpUUXlYUUo5ZkszUkhsMWY5Q00Kc2lVWGFiTlA3QkhIa2NYalEyclRkcll4d3Vsb2xNWSt4ZzhpMDE2MEZMV1ZRaDRSQjlXWmYwc2MxcDdQNzFuQwpKWlFLL0NHeWRhNzUya3BuSTJ4dm1hcEpUU0RxUVF5VWFoYXZVRmcwK1RrQ0F3RUFBYU5XTUZRd0RnWURWUjBQCkFRSC9CQVFEQWdXZ01CTUdBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBd0h3WUQKVlIwakJCZ3dGb0FVSy9kSHkwRk1xYlRha3hndzRPb1FmakVtQkVvd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQgpBQ3ovaVd0eWo3VWU1elhoUDh4UHBaNGZYdHNuTGxXbzdWRUVnVFA0N2JaL2t2T1BiM2hXZ2RhL0xPc3Z1QWdoCkZHdHhFSWk5UEljYnZXWnhFWkdMOUZnV1dzSk0vK3NmRG84QnlmUGUraXFhWUdxQ2YrWTNvcGlqYVVwYndzaGcKeWVTZDkzSlZzWWVVN2Z6VElTNTJuS0tVaWdvN3dNNUhzbmx0YklOL21lOGZkWW9hWURneVF0bU1hd3BKYjdiNgpFbXM2VEFxVWtqNjV0MXdnUGNRUWtsUGxEVW5qcVhMS1kvd2V2SHpUcmJGOXRCVUlsRE1nZXA4TEZSTzBidWhsClFyeUZRYTJUTEpMdnZHOU1iVjM3ZTd0TjNlSzBDcEY0LzBFRCtUdExBVCs3MmRKRG9rYkpCbkdGbHFhZ0JxazcKd3ZxYkc3TGRESzBDcGFTdDJaSFZncDA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K | base64 -d &gt; scheduler.crt</span><br><span class="line">[root@master kubernetes]# cat scheduler.crt</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDDTCCAfWgAwIBAgIIQX6DLkqbEdgwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE</span><br><span class="line">AxMKa3ViZXJuZXRlczAeFw0yMjA5MTcxMDIwMDRaFw0yMzA5MTcxMDIwMDZaMCAx</span><br><span class="line">HjAcBgNVBAMTFXN5c3RlbTprdWJlLXNjaGVkdWxlcjCCASIwDQYJKoZIhvcNAQEB</span><br><span class="line">BQADggEPADCCAQoCggEBANAjp63yeNFmG5za4lX54vl2qqRqgErCOuM5LhR/aQKv</span><br><span class="line">KpBWMJDFf3RzChhbMF1ZGCGKc4dOfB3375+jiv7xvxvZq9O8bl8xywX7R8P2Ah0i</span><br><span class="line">qsve5SmRATsFNkojMYWgD6F8Q/oPOs2ZDIe2rqrSo4XFUETKN50TTXsoSjtKxNSd</span><br><span class="line">CJ6fmGWPs+BJPQzB3uszxQFm4xPTyc+NrR6qz6P2nqID2JTQyXQJ9fK3RHl1f9CM</span><br><span class="line">siUXabNP7BHHkcXjQ2rTdrYxwulolMY+xg8i0160FLWVQh4RB9WZf0sc1p7P71nC</span><br><span class="line">JZQK/CGyda752kpnI2xvmapJTSDqQQyUahavUFg0+TkCAwEAAaNWMFQwDgYDVR0P</span><br><span class="line">AQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAwGA1UdEwEB/wQCMAAwHwYD</span><br><span class="line">VR0jBBgwFoAUK/dHy0FMqbTakxgw4OoQfjEmBEowDQYJKoZIhvcNAQELBQADggEB</span><br><span class="line">ACz/iWtyj7Ue5zXhP8xPpZ4fXtsnLlWo7VEEgTP47bZ/kvOPb3hWgda/LOsvuAgh</span><br><span class="line">FGtxEIi9PIcbvWZxEZGL9FgWWsJM/+sfDo8ByfPe+iqaYGqCf+Y3opijaUpbwshg</span><br><span class="line">yeSd93JVsYeU7fzTIS52nKKUigo7wM5HsnltbIN/me8fdYoaYDgyQtmMawpJb7b6</span><br><span class="line">Ems6TAqUkj65t1wgPcQQklPlDUnjqXLKY/wevHzTrbF9tBUIlDMgep8LFRO0buhl</span><br><span class="line">QryFQa2TLJLvvG9MbV37e7tN3eK0CpF4/0ED+TtLAT+72dJDokbJBnGFlqagBqk7</span><br><span class="line">wvqbG7LdDK0CpaSt2ZHVgp0=</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">[root@master kubernetes]# openssl x509 -in scheduler.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 4719353694374269400 (0x417e832e4a9b11d8)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:04 2022 GMT</span><br><span class="line">            Not After : Sep 17 10:20:06 2023 GMT</span><br><span class="line">        Subject: CN = system:kube-scheduler</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:d0:23:a7:ad:f2:78:d1:66:1b:9c:da:e2:55:f9:</span><br><span class="line">                    e2:f9:76:aa:a4:6a:80:4a:c2:3a:e3:39:2e:14:7f:</span><br><span class="line">                    69:02:af:2a:90:56:30:90:c5:7f:74:73:0a:18:5b:</span><br><span class="line">                    30:5d:59:18:21:8a:73:87:4e:7c:1d:f7:ef:9f:a3:</span><br><span class="line">                    8a:fe:f1:bf:1b:d9:ab:d3:bc:6e:5f:31:cb:05:fb:</span><br><span class="line">                    47:c3:f6:02:1d:22:aa:cb:de:e5:29:91:01:3b:05:</span><br><span class="line">                    36:4a:23:31:85:a0:0f:a1:7c:43:fa:0f:3a:cd:99:</span><br><span class="line">                    0c:87:b6:ae:aa:d2:a3:85:c5:50:44:ca:37:9d:13:</span><br><span class="line">                    4d:7b:28:4a:3b:4a:c4:d4:9d:08:9e:9f:98:65:8f:</span><br><span class="line">                    b3:e0:49:3d:0c:c1:de:eb:33:c5:01:66:e3:13:d3:</span><br><span class="line">                    c9:cf:8d:ad:1e:aa:cf:a3:f6:9e:a2:03:d8:94:d0:</span><br><span class="line">                    c9:74:09:f5:f2:b7:44:79:75:7f:d0:8c:b2:25:17:</span><br><span class="line">                    69:b3:4f:ec:11:c7:91:c5:e3:43:6a:d3:76:b6:31:</span><br><span class="line">                    c2:e9:68:94:c6:3e:c6:0f:22:d3:5e:b4:14:b5:95:</span><br><span class="line">                    42:1e:11:07:d5:99:7f:4b:1c:d6:9e:cf:ef:59:c2:</span><br><span class="line">                    25:94:0a:fc:21:b2:75:ae:f9:da:4a:67:23:6c:6f:</span><br><span class="line">                    99:aa:49:4d:20:ea:41:0c:94:6a:16:af:50:58:34:</span><br><span class="line">                    f9:39</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:2B:F7:47:CB:41:4C:A9:B4:DA:93:18:30:E0:EA:10:7E:31:26:04:4A</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         2c:ff:89:6b:72:8f:b5:1e:e7:35:e1:3f:cc:4f:a5:9e:1f:5e:</span><br><span class="line">         db:27:2e:55:a8:ed:51:04:81:33:f8:ed:b6:7f:92:f3:8f:6f:</span><br><span class="line">         78:56:81:d6:bf:2c:eb:2f:b8:08:21:14:6b:71:10:88:bd:3c:</span><br><span class="line">         87:1b:bd:66:71:11:91:8b:f4:58:16:5a:c2:4c:ff:eb:1f:0e:</span><br><span class="line">         8f:01:c9:f3:de:fa:2a:9a:60:6a:82:7f:e6:37:a2:98:a3:69:</span><br><span class="line">         4a:5b:c2:c8:60:c9:e4:9d:f7:72:55:b1:87:94:ed:fc:d3:21:</span><br><span class="line">         2e:76:9c:a2:94:8a:0a:3b:c0:ce:47:b2:79:6d:6c:83:7f:99:</span><br><span class="line">         ef:1f:75:8a:1a:60:38:32:42:d9:8c:6b:0a:49:6f:b6:fa:12:</span><br><span class="line">         6b:3a:4c:0a:94:92:3e:b9:b7:5c:20:3d:c4:10:92:53:e5:0d:</span><br><span class="line">         49:e3:a9:72:ca:63:fc:1e:bc:7c:d3:ad:b1:7d:b4:15:08:94:</span><br><span class="line">         33:20:7a:9f:0b:15:13:b4:6e:e8:65:42:bc:85:41:ad:93:2c:</span><br><span class="line">         92:ef:bc:6f:4c:6d:5d:fb:7b:bb:4d:dd:e2:b4:0a:91:78:ff:</span><br><span class="line">         41:03:f9:3b:4b:01:3f:bb:d9:d2:43:a2:46:c9:06:71:85:96:</span><br><span class="line">         a6:a0:06:a9:3b:c2:fa:9b:1b:b2:dd:0c:ad:02:a5:a4:ad:d9:</span><br><span class="line">         91:d5:82:9d</span><br></pre></td></tr></table></figure><h2 id="scheduler证书创建"><a href="#scheduler证书创建" class="headerlink" title="scheduler证书创建"></a>scheduler证书创建</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# cat xiaowangc.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">================================================================</span><br><span class="line">[root@master pki]# openssl req -new -newkey rsa:2048 -keyout scheduler.key -out scheduler.csr -nodes -subj &#x27;/CN=system:kube-scheduler&#x27;</span><br><span class="line">Generating a RSA private key</span><br><span class="line">..................+++++</span><br><span class="line">......+++++</span><br><span class="line">writing new private key to &#x27;scheduler.key&#x27;</span><br><span class="line">-----</span><br><span class="line">[root@master pki]# openssl x509 -req -sha256 -days 36500 -extfile xiaowangc.cnf -extensions v3_req -in scheduler.csr -CA ca.crt -CAkey ca.pem -out scheduler.crt -CAcreateserial</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = system:kube-scheduler</span><br><span class="line">Getting CA Private Key</span><br><span class="line">[root@master pki]# openssl x509 -in controller-manager.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            19:39:ff:4c:dd:c2:d6:76:f3:cc:7e:f9:b8:8c:fb:4e:b5:17:5b:21</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 21:55:00 2022 GMT</span><br><span class="line">            Not After : Aug 24 21:55:00 2122 GMT</span><br><span class="line">        Subject: CN = system:kube-controller-manager</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:a2:08:62:a6:6e:21:0e:1a:e2:73:1a:9b:d7:8b:</span><br><span class="line">                    2c:c0:fe:72:85:77:a3:ca:62:80:5f:bf:f3:6c:14:</span><br><span class="line">                    05:c2:1d:30:68:d7:c9:b0:d1:7f:cf:78:f5:41:8f:</span><br><span class="line">                    a1:60:be:26:58:43:74:c4:af:45:c7:e2:1e:f8:df:</span><br><span class="line">                    53:87:b4:46:20:ab:2e:d7:13:bd:35:f2:55:5b:bd:</span><br><span class="line">                    3a:16:f4:d6:98:c5:a4:7a:57:56:40:ba:98:28:e0:</span><br><span class="line">                    d6:78:11:bd:b5:58:18:8c:4c:ea:8a:88:3e:1b:9a:</span><br><span class="line">                    8f:79:39:32:05:26:61:e1:5d:9c:f1:bb:91:49:8c:</span><br><span class="line">                    39:76:e1:ac:43:a3:dd:5b:82:8b:72:ae:52:83:50:</span><br><span class="line">                    12:20:10:13:3b:66:89:38:9b:de:4a:42:29:81:8a:</span><br><span class="line">                    43:79:31:14:5c:cd:c7:bd:f0:ed:89:99:09:94:d0:</span><br><span class="line">                    e6:43:18:3f:18:14:79:fc:be:85:f7:13:e9:a3:f8:</span><br><span class="line">                    45:67:60:5a:e3:e6:a9:72:79:c4:ca:90:bb:05:89:</span><br><span class="line">                    d3:52:13:f7:6d:b1:10:b7:8a:5a:3e:56:cd:d2:b3:</span><br><span class="line">                    46:bd:fb:10:d3:ba:a0:05:ea:5d:22:c0:40:4e:ed:</span><br><span class="line">                    95:15:7e:80:5b:9a:e7:89:bf:aa:18:1f:b6:ca:1f:</span><br><span class="line">                    c1:a1:79:2c:4f:2c:c6:62:cd:5d:93:35:c7:bd:b6:</span><br><span class="line">                    c8:43</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:33:AC:40:D4:C2:3E:E9:64:2B:F5:00:C7:EB:E9:78:45:62:DD:3E:15</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         31:91:9f:f1:f1:99:6c:81:cb:65:8c:df:1f:db:0d:61:b2:b7:</span><br><span class="line">         fb:34:51:7a:61:17:09:42:8e:19:a4:32:2b:de:23:d3:96:32:</span><br><span class="line">         9f:8f:9f:96:0a:65:1f:ae:3b:cc:db:e6:b6:20:99:c9:5e:58:</span><br><span class="line">         c6:da:ea:e3:9a:64:d2:ee:6c:37:f7:ff:66:1d:87:6e:e5:fc:</span><br><span class="line">         fd:87:db:8e:e4:af:f3:2a:e0:46:db:a7:59:94:74:80:ce:07:</span><br><span class="line">         1e:e6:a5:a4:72:26:c2:de:2b:e1:6d:5b:eb:c0:70:0c:3e:ca:</span><br><span class="line">         39:fe:60:ad:c5:44:7c:fe:6f:ae:b9:5d:08:5b:02:05:88:29:</span><br><span class="line">         d4:24:8c:1a:1b:88:fe:58:4a:d5:ee:6f:4b:37:ac:e0:77:23:</span><br><span class="line">         8d:5a:71:cf:f4:f8:5d:b4:36:df:29:aa:11:42:35:0b:39:b7:</span><br><span class="line">         74:e4:81:c6:f3:29:d6:8f:75:3b:50:53:59:43:1c:75:6e:14:</span><br><span class="line">         5e:64:eb:36:1c:1b:f4:6b:b3:9b:c3:42:98:60:eb:2e:ea:ed:</span><br><span class="line">         f3:65:3a:15:9e:7a:c6:99:99:01:aa:1e:08:73:10:3f:c9:06:</span><br><span class="line">         b3:45:b0:b5:3f:db:08:18:60:bd:3d:5d:fa:29:48:ba:21:34:</span><br><span class="line">         f8:16:51:b1:3e:89:2c:27:a4:55:6d:5f:a4:d1:e7:cd:2d:bd:</span><br><span class="line">         74:eb:17:e7</span><br></pre></td></tr></table></figure><h2 id="admin证书详细信息"><a href="#admin证书详细信息" class="headerlink" title="admin证书详细信息"></a>admin证书详细信息</h2><p>通常当我们通过kubeadm初始化集群成功之后会得到提示信息，也就是为KUBECONFIG配置环境变量，而这个环境变量指向的文件即是admin.conf，此文件通常用于连接kubernetes集群，里面包含集群地址，CA证书，client证书，client私钥等信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# cat admin.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3hOekV3TWpBd05Gb1hEVE15TURreE5ERXdNakF3TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS1NRCkVScnRRUHBPNzE0VGVueEQ5ZUZ0d25tNFFWWG56L1liUE5MNE5VdXdmcUNPTVg1MGJNTWxiblkya3poZmlSSmQKSWxVK3o4RVYrZGJ6WDJUd0JUWGRxN1pOeDFxdmx2bFpuZDlUY21Zd3l6eUpCRUROVjdmMG9lYWxUSUIwMGVRYQovYjFWeStPL1I0NUhuY3VXUDhMc2lwV3J5U3I1WjRpcnkvVmIrbnB4T2xVeXpTL3BtdVhBTmdGUGVpL0w3MUlpCkxha0NlNmZNRCtMMHpGektCdGVVeVpuWWZMOWxyVm0xeG1QUjVFdkdZN2NaNTl3YmtqbW94VGE1bjdVTzR6SjgKZndiak5oNHVLVzdqOHpvajVTWTJBMEZIZ0RSbnY5NlFxVk5SSkIraGMrRDBrTE1EdmRHcUM0QVpaUzJDbUNLUQpBTUZGUUlGSDIyMCtBRngvNGM4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDdjNSOHRCVEttMDJwTVlNT0RxRUg0eEpnUktNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBR3hwamdwcjVOZmxxMkJBZC9vdQpTQW14WDIyVi9XTmJZZDNDYVA2dVAwY2F3QXdWMm8xY3lucjNwVk9reG8xaDZ6UjBPWkdvNEJpc2tlWUJKUHNkCjdjeVhwRGVseDh2b2QvUjc1NUQ5TmcwOWUybFlSQWlmSE9NZXkvbjdYb0JLNWNRUk9KUWtmZmxvYWFBRFZsNlAKdVBSNXJhUWd0c0hIZUUwVy9hTitqVTQrby92VFJ4TnZzdUtERVpXY1pyYnBOOUJRZjVGc09vRTAyV25XRi9uUQpVOXNwVjlmanJVU0I5MFhqTG1GdDRFUW1ucm5JWjRjMU42TnJqQ0szTk1NdFlidFE2VXo2M3FDVzRtZmRoK3FFCi9DcmVHTTR1T1JLMnBjVjYwYlFHOVhTOFVDWXc4bWN1SVFuTlRpc05NaXMwbCtkelV1Ui9qYVJZS1EydEdaMTAKWlVJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://192.168.64.11:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJS2NpSGVBWHNnNHd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1UY3hNREl3TURSYUZ3MHlNekE1TVRjeE1ESXdNRFZhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQTNmV0NHbFo2cWc1bEtOWXYKMXdyb0FpZWgwbXFiMFpibGc0eVVEOXJQQ3FSd3Z4Q29oUkJvWnkxZFdCL2NLZ0IwR1pxQjUvZzhPNE8rMG5XKwpaVTZjU0U2S0txVi9zYW1sMGhiaktPZno3R2FrYldvK2dzVFMvSzlCbk8zMVlvRUYwNTZGcUF3T3FlV2RWb3loCllPZWRQV1JVZWdtVU5GVkxYMWJhWkdsblZCYkNFelRLV081b3VyeWxUbEpqcHFrZHJkZDdtcTNzRU45M2VyZ1IKR1l4YnZSOXdRNk1PQjY5MWt0ZWw2WmowU202UDNNK0Jxb3RxNWZFbGdwd29TWHAwNms3Rzd4SElPayt0K3VlYwp2eHR0Qlp3TExqTzZDUmNSeS9UREE0U1NyWERDdjB6UGpWOEJxeUhOY29SYkVDNVFVNm9COFdOYmhQN0ZnRWdrCnBWdWtSUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JRcjkwZkxRVXlwdE5xVEdERGc2aEIrTVNZRQpTakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBSWVqM1VLMzhpNlBtME5HeXRQRUNqMTc4bnRMaTFnQ3BTOVlsCkJRL29jUmtWSnpwVUFoVUxtV3NVRzNTSU1JeVEzUUpmQytnUXdnS1A0SWhGSksweFg0T3RNNld5aE55MWZFRmEKM3l3aXRHQ3pqN2NwL1BNc3U2NUJnTm9pRVB5Mkhjc3dGODJna2xaVXJidVdrYm9yYXNrVHV0TkptbkgwSEpzZwp3UDJYaVhOaVYwRVFXVHErZVJPdWIyaUl6L3Rlb1NHYStPUHFrWTMwN2JpTk9xTm1DeldlWGczV0VYaG9IZ2NQCmJ3L1hPcHoyZmlUWHV2NVM1c0MzRjZNR1RGcmM0d0RZK0szdTlBZVpleXpySUVvdXRCMitPS3ROZkFSb0dtNncKeTZIQ2pIazBVSjgzclVwYXVXMlBwVHFQYjZDT2xLcW1JZXJmNWhrcFVHWjEzNHBHSlE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBM2ZXQ0dsWjZxZzVsS05ZdjF3cm9BaWVoMG1xYjBaYmxnNHlVRDlyUENxUnd2eENvCmhSQm9aeTFkV0IvY0tnQjBHWnFCNS9nOE80TyswblcrWlU2Y1NFNktLcVYvc2FtbDBoYmpLT2Z6N0dha2JXbysKZ3NUUy9LOUJuTzMxWW9FRjA1NkZxQXdPcWVXZFZveWhZT2VkUFdSVWVnbVVORlZMWDFiYVpHbG5WQmJDRXpUSwpXTzVvdXJ5bFRsSmpwcWtkcmRkN21xM3NFTjkzZXJnUkdZeGJ2Ujl3UTZNT0I2OTFrdGVsNlpqMFNtNlAzTStCCnFvdHE1ZkVsZ3B3b1NYcDA2azdHN3hISU9rK3QrdWVjdnh0dEJad0xMak82Q1JjUnkvVERBNFNTclhEQ3YwelAKalY4QnF5SE5jb1JiRUM1UVU2b0I4V05iaFA3RmdFZ2twVnVrUlFJREFRQUJBb0lCQUdHdGpsRGE1K1o0cVVuOApZRmRKWkdxMldEK0tUUUpDWHNTeWsrSWFUKzBHQ3R2Nmo3N25ScHJKV3YvU0hZaWFaSDEwQW1FOFcvMXc4QVFjCmJ1cVVXckJ6WjloMnRxaFAyVHFJZWZWaGhuWHRnY1RvOFpPSTNMVDR4MjR4UmtEUU9PazFKT3FjUzhPMjJiUGgKOVk3NHZyanFzMFoxZXJSQktRZE82Sk14MDVnc0RjNkEvdlJwdll4YjhCajlBZmtsT1FmL050NmRDT21jcCt3OQphRGUvaU9PYTEwdW5qYUxUQkR6L0g5N0FHYmtwakhQRmtQUlZzeGR5S1lEMStoMlNJQjhMTmRId2dpb1NZQVJZCnppakE0NHM5K01GODNrVDJkRlo5ay9jdDcvYUErOXdJYUpYNUY1MGpObm0wTVdnZFd2ZnE5WkdVK2RQcGhNQnMKcmFYeVFrRUNnWUVBNVpsY05rSlZjNXVySU9ONlFWUkl4MTdQYmhsTUpmcm51YWQ5RFFxWFEySVdUSlRxK25legpDbmhGR3gvVXFIUW9KVzRGZkNYblRMQmVVQkd6dEhIcnFITzIxU0J6UUtkWDZuOXRiNUVxSWFTN0h3bWRjSTJOClQ0WkxYN0ZtQ2x0WmswTFFXNlA5R0Q3SkdHV3Z1MzIvSDY5Um9vbSt2aTk1RUNLUmFyZ3JURkVDZ1lFQTkzdEEKRGNLanhPVlM5M2pWRW5Wa01sM241M2FiWk12ZEhldWNWTDMvMGlTcGhETE8wdHd1enUwUGg2TmdrNEtxejBGWgorRjFKYnpadzhkWElTTWRKRmx0SFFyakJEcXBlcGIvVnVMNmtqbjJZK3YwaXJRN1F1eENwalhWZ2FTaytGajMzCjQ2dE9DRjBpVi9jeGRZWEFsYUl3WFBOQXRXOGdrUWs4RXRXYS83VUNnWUJPa080Ryt5ZjJpWHhEb3RQQTZ6Q0UKV0tNdWo2V0pFWlNkNlB4WHJCb2F5c1BLck9MRGxwWkRyT2dvNGZtSk0wWlJtSlp6NXh5QkY1RU9ZU0JYVE94UgpGbGVvRXBTZHVTWFNib3hxTXdoeHZzYnhWZjd6OXR3MkxFUTZtSi9NUjNvZGRDMk1UazliTHBEdHNrNHlJRk40CmFpdkxMTXVDbFFnZVIxWHZhTm9ZSVFLQmdRQ0JjOFlBcktTUHRNa2VTK1ZnbjJsRzgxbi8rRW0yZ3ZEcDJybk8KbGdnLyt3OTA2RUxKaDRVd2xrNCtUQmFUY3BFNGtsMm1qZDJBd0FCNmI3SXhaNVR5amRLTHN5ckJLaHNTSm5OOApETFQxRi91eXBrRENOM0sxdHpTSm16RlFNTk9hUE5YekVFTmtHcHVCV2Z0VUZ4K3k1Y0RZamlGMkJtZ0psY1FICnNoWSsxUUtCZ0Y0bFYydERUYUtDcEtIS2hXQTRKZm82WVkzL0k3MGgwdFFDTW8rOEZpZmlRdk9tdkV1MVNzOEUKQldPa2FmQmJvUll2akVCV3FuTllINlVIN3BwdTNMTk9HRjdISUZWZXBNNFdSejNyQW9Ybzk0VjIyUjF1K3MxYwo1aGFwZkRuOW1kTEZyaVpQYXlRVmVndW1TWGo3OHpXRDZOKzhhQVFqSDZJREFCaGUwT3BRCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span><br></pre></td></tr></table></figure><p><strong>对证书部分进行解密</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# echo LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJS2NpSGVBWHNnNHd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBNU1UY3hNREl3TURSYUZ3MHlNekE1TVRjeE1ESXdNRFZhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQTNmV0NHbFo2cWc1bEtOWXYKMXdyb0FpZWgwbXFiMFpibGc0eVVEOXJQQ3FSd3Z4Q29oUkJvWnkxZFdCL2NLZ0IwR1pxQjUvZzhPNE8rMG5XKwpaVTZjU0U2S0txVi9zYW1sMGhiaktPZno3R2FrYldvK2dzVFMvSzlCbk8zMVlvRUYwNTZGcUF3T3FlV2RWb3loCllPZWRQV1JVZWdtVU5GVkxYMWJhWkdsblZCYkNFelRLV081b3VyeWxUbEpqcHFrZHJkZDdtcTNzRU45M2VyZ1IKR1l4YnZSOXdRNk1PQjY5MWt0ZWw2WmowU202UDNNK0Jxb3RxNWZFbGdwd29TWHAwNms3Rzd4SElPayt0K3VlYwp2eHR0Qlp3TExqTzZDUmNSeS9UREE0U1NyWERDdjB6UGpWOEJxeUhOY29SYkVDNVFVNm9COFdOYmhQN0ZnRWdrCnBWdWtSUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JRcjkwZkxRVXlwdE5xVEdERGc2aEIrTVNZRQpTakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBSWVqM1VLMzhpNlBtME5HeXRQRUNqMTc4bnRMaTFnQ3BTOVlsCkJRL29jUmtWSnpwVUFoVUxtV3NVRzNTSU1JeVEzUUpmQytnUXdnS1A0SWhGSksweFg0T3RNNld5aE55MWZFRmEKM3l3aXRHQ3pqN2NwL1BNc3U2NUJnTm9pRVB5Mkhjc3dGODJna2xaVXJidVdrYm9yYXNrVHV0TkptbkgwSEpzZwp3UDJYaVhOaVYwRVFXVHErZVJPdWIyaUl6L3Rlb1NHYStPUHFrWTMwN2JpTk9xTm1DeldlWGczV0VYaG9IZ2NQCmJ3L1hPcHoyZmlUWHV2NVM1c0MzRjZNR1RGcmM0d0RZK0szdTlBZVpleXpySUVvdXRCMitPS3ROZkFSb0dtNncKeTZIQ2pIazBVSjgzclVwYXVXMlBwVHFQYjZDT2xLcW1JZXJmNWhrcFVHWjEzNHBHSlE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== | base64 -d &gt; admin.crt</span><br><span class="line">[root@master kubernetes]# cat admin.crt</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDITCCAgmgAwIBAgIIKciHeAXsg4wwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE</span><br><span class="line">AxMKa3ViZXJuZXRlczAeFw0yMjA5MTcxMDIwMDRaFw0yMzA5MTcxMDIwMDVaMDQx</span><br><span class="line">FzAVBgNVBAoTDnN5c3RlbTptYXN0ZXJzMRkwFwYDVQQDExBrdWJlcm5ldGVzLWFk</span><br><span class="line">bWluMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3fWCGlZ6qg5lKNYv</span><br><span class="line">1wroAieh0mqb0Zblg4yUD9rPCqRwvxCohRBoZy1dWB/cKgB0GZqB5/g8O4O+0nW+</span><br><span class="line">ZU6cSE6KKqV/saml0hbjKOfz7GakbWo+gsTS/K9BnO31YoEF056FqAwOqeWdVoyh</span><br><span class="line">YOedPWRUegmUNFVLX1baZGlnVBbCEzTKWO5ourylTlJjpqkdrdd7mq3sEN93ergR</span><br><span class="line">GYxbvR9wQ6MOB691ktel6Zj0Sm6P3M+Bqotq5fElgpwoSXp06k7G7xHIOk+t+uec</span><br><span class="line">vxttBZwLLjO6CRcRy/TDA4SSrXDCv0zPjV8BqyHNcoRbEC5QU6oB8WNbhP7FgEgk</span><br><span class="line">pVukRQIDAQABo1YwVDAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUH</span><br><span class="line">AwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBQr90fLQUyptNqTGDDg6hB+MSYE</span><br><span class="line">SjANBgkqhkiG9w0BAQsFAAOCAQEAIej3UK38i6Pm0NGytPECj178ntLi1gCpS9Yl</span><br><span class="line">BQ/ocRkVJzpUAhULmWsUG3SIMIyQ3QJfC+gQwgKP4IhFJK0xX4OtM6WyhNy1fEFa</span><br><span class="line">3ywitGCzj7cp/PMsu65BgNoiEPy2HcswF82gklZUrbuWkboraskTutNJmnH0HJsg</span><br><span class="line">wP2XiXNiV0EQWTq+eROub2iIz/teoSGa+OPqkY307biNOqNmCzWeXg3WEXhoHgcP</span><br><span class="line">bw/XOpz2fiTXuv5S5sC3F6MGTFrc4wDY+K3u9AeZeyzrIEoutB2+OKtNfARoGm6w</span><br><span class="line">y6HCjHk0UJ83rUpauW2PpTqPb6COlKqmIerf5hkpUGZ134pGJQ==</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">[root@master kubernetes]# openssl x509 -in admin.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 3010805300462388108 (0x29c8877805ec838c)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 10:20:04 2022 GMT</span><br><span class="line">            Not After : Sep 17 10:20:05 2023 GMT</span><br><span class="line">        Subject: O = system:masters, CN = kubernetes-admin</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:dd:f5:82:1a:56:7a:aa:0e:65:28:d6:2f:d7:0a:</span><br><span class="line">                    e8:02:27:a1:d2:6a:9b:d1:96:e5:83:8c:94:0f:da:</span><br><span class="line">                    cf:0a:a4:70:bf:10:a8:85:10:68:67:2d:5d:58:1f:</span><br><span class="line">                    dc:2a:00:74:19:9a:81:e7:f8:3c:3b:83:be:d2:75:</span><br><span class="line">                    be:65:4e:9c:48:4e:8a:2a:a5:7f:b1:a9:a5:d2:16:</span><br><span class="line">                    e3:28:e7:f3:ec:66:a4:6d:6a:3e:82:c4:d2:fc:af:</span><br><span class="line">                    41:9c:ed:f5:62:81:05:d3:9e:85:a8:0c:0e:a9:e5:</span><br><span class="line">                    9d:56:8c:a1:60:e7:9d:3d:64:54:7a:09:94:34:55:</span><br><span class="line">                    4b:5f:56:da:64:69:67:54:16:c2:13:34:ca:58:ee:</span><br><span class="line">                    68:ba:bc:a5:4e:52:63:a6:a9:1d:ad:d7:7b:9a:ad:</span><br><span class="line">                    ec:10:df:77:7a:b8:11:19:8c:5b:bd:1f:70:43:a3:</span><br><span class="line">                    0e:07:af:75:92:d7:a5:e9:98:f4:4a:6e:8f:dc:cf:</span><br><span class="line">                    81:aa:8b:6a:e5:f1:25:82:9c:28:49:7a:74:ea:4e:</span><br><span class="line">                    c6:ef:11:c8:3a:4f:ad:fa:e7:9c:bf:1b:6d:05:9c:</span><br><span class="line">                    0b:2e:33:ba:09:17:11:cb:f4:c3:03:84:92:ad:70:</span><br><span class="line">                    c2:bf:4c:cf:8d:5f:01:ab:21:cd:72:84:5b:10:2e:</span><br><span class="line">                    50:53:aa:01:f1:63:5b:84:fe:c5:80:48:24:a5:5b:</span><br><span class="line">                    a4:45</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:2B:F7:47:CB:41:4C:A9:B4:DA:93:18:30:E0:EA:10:7E:31:26:04:4A</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         21:e8:f7:50:ad:fc:8b:a3:e6:d0:d1:b2:b4:f1:02:8f:5e:fc:</span><br><span class="line">         9e:d2:e2:d6:00:a9:4b:d6:25:05:0f:e8:71:19:15:27:3a:54:</span><br><span class="line">         02:15:0b:99:6b:14:1b:74:88:30:8c:90:dd:02:5f:0b:e8:10:</span><br><span class="line">         c2:02:8f:e0:88:45:24:ad:31:5f:83:ad:33:a5:b2:84:dc:b5:</span><br><span class="line">         7c:41:5a:df:2c:22:b4:60:b3:8f:b7:29:fc:f3:2c:bb:ae:41:</span><br><span class="line">         80:da:22:10:fc:b6:1d:cb:30:17:cd:a0:92:56:54:ad:bb:96:</span><br><span class="line">         91:ba:2b:6a:c9:13:ba:d3:49:9a:71:f4:1c:9b:20:c0:fd:97:</span><br><span class="line">         89:73:62:57:41:10:59:3a:be:79:13:ae:6f:68:88:cf:fb:5e:</span><br><span class="line">         a1:21:9a:f8:e3:ea:91:8d:f4:ed:b8:8d:3a:a3:66:0b:35:9e:</span><br><span class="line">         5e:0d:d6:11:78:68:1e:07:0f:6f:0f:d7:3a:9c:f6:7e:24:d7:</span><br><span class="line">         ba:fe:52:e6:c0:b7:17:a3:06:4c:5a:dc:e3:00:d8:f8:ad:ee:</span><br><span class="line">         f4:07:99:7b:2c:eb:20:4a:2e:b4:1d:be:38:ab:4d:7c:04:68:</span><br><span class="line">         1a:6e:b0:cb:a1:c2:8c:79:34:50:9f:37:ad:4a:5a:b9:6d:8f:</span><br><span class="line">         a5:3a:8f:6f:a0:8e:94:aa:a6:21:ea:df:e6:19:29:50:66:75:</span><br><span class="line">         df:8a:46:25</span><br></pre></td></tr></table></figure><h2 id="admin证书创建"><a href="#admin证书创建" class="headerlink" title="admin证书创建"></a>admin证书创建</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# cat xiaowangc.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">================================================================</span><br><span class="line">[root@master pki]# openssl req -new -newkey rsa:2048 -keyout admin.key -out admin.csr -nodes -subj &#x27;/CN=kubernetes-admin/O=system:masters&#x27;</span><br><span class="line">[root@master pki]# openssl x509 -req -sha256 -days 36500 -extfile xiaowangc.cnf -extensions v3_req -in admin.csr -CA ca.crt -CAkey ca.pem -out admin.crt -CAcreateserial</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = kubernetes-admin, O = system:masters</span><br><span class="line">Getting CA Private Key</span><br><span class="line">[root@master pki]# openssl x509 -in admin.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            19:39:ff:4c:dd:c2:d6:76:f3:cc:7e:f9:b8:8c:fb:4e:b5:17:5b:23</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN = kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep 17 22:28:12 2022 GMT</span><br><span class="line">            Not After : Aug 24 22:28:12 2122 GMT</span><br><span class="line">        Subject: CN = kubernetes-admin, O = system:masters</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:b7:de:2f:2b:1c:be:e3:7f:dd:e5:04:b3:18:8a:</span><br><span class="line">                    e1:d6:7c:b8:4f:ed:87:c2:21:ca:12:bd:7e:35:ef:</span><br><span class="line">                    69:75:6e:38:69:07:18:9e:e6:c4:12:99:03:72:4d:</span><br><span class="line">                    20:96:ab:d4:ac:8e:4d:b0:2b:3a:69:36:aa:82:a2:</span><br><span class="line">                    a3:04:fb:1a:60:b7:5e:26:26:08:5b:c1:b5:58:b2:</span><br><span class="line">                    55:4b:ed:a1:fc:6b:8f:84:d0:04:4f:d6:47:3e:b1:</span><br><span class="line">                    99:eb:ed:91:f0:f0:f4:d8:9f:5c:af:13:36:68:3b:</span><br><span class="line">                    f8:a3:31:fd:de:b6:c2:81:98:65:ca:db:a1:46:80:</span><br><span class="line">                    b7:18:bd:5c:02:de:21:a1:3f:19:cc:da:a7:c2:09:</span><br><span class="line">                    6b:dd:a7:40:95:2f:7f:b7:ff:ba:89:43:03:02:46:</span><br><span class="line">                    6e:12:95:51:37:f4:4c:4c:ac:b0:50:65:59:1d:e5:</span><br><span class="line">                    31:a1:ce:f8:6b:08:74:91:2e:89:5e:5f:b6:db:b8:</span><br><span class="line">                    60:07:b2:c9:00:8e:bb:04:cd:6c:a0:e8:9c:e7:21:</span><br><span class="line">                    5d:6a:45:04:cb:47:70:95:30:a7:ba:da:13:b1:2b:</span><br><span class="line">                    5f:cd:5e:d4:39:4d:37:63:ad:45:87:46:57:4e:3a:</span><br><span class="line">                    df:8a:c1:83:e3:b1:88:b5:9b:f9:68:fb:ef:b1:47:</span><br><span class="line">                    32:06:9a:9e:41:35:0a:cf:1c:57:51:1d:15:f1:f6:</span><br><span class="line">                    10:3d</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:33:AC:40:D4:C2:3E:E9:64:2B:F5:00:C7:EB:E9:78:45:62:DD:3E:15</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         82:7b:b4:e6:22:a1:bb:3c:79:4d:8c:7c:5d:2f:b2:9e:d2:ac:</span><br><span class="line">         e4:67:15:91:03:b3:66:47:6c:ec:82:fa:6b:6e:29:3a:60:0d:</span><br><span class="line">         3b:3d:82:7a:df:11:a7:3a:a5:44:66:1f:a6:21:d6:7d:22:32:</span><br><span class="line">         8b:5c:69:cb:3d:2e:9f:4e:ba:bb:7b:b0:ea:29:c7:32:5b:35:</span><br><span class="line">         7c:9c:e2:b5:69:c5:50:ab:6c:1b:99:2b:4d:1d:1f:b7:0c:1f:</span><br><span class="line">         39:e3:fd:ee:a8:8b:b6:38:9f:af:c2:cd:16:f5:d2:be:8e:c3:</span><br><span class="line">         97:59:7e:0e:d8:9f:ca:22:2b:02:c0:06:fa:e1:96:1d:90:55:</span><br><span class="line">         55:3c:c4:90:b3:22:32:89:8c:22:59:77:9d:87:31:4a:c6:5a:</span><br><span class="line">         57:35:c6:c3:5a:f4:6a:2f:60:b3:3b:60:06:35:c7:e4:5f:80:</span><br><span class="line">         3d:9e:58:28:6b:8e:3a:1b:a9:0e:ac:79:09:8f:c5:fd:ff:4f:</span><br><span class="line">         22:78:db:ad:36:69:15:94:86:f1:e4:3f:84:ec:99:93:4a:95:</span><br><span class="line">         dc:3e:ea:9d:94:e6:11:73:24:9a:88:12:2d:73:28:97:15:00:</span><br><span class="line">         31:5d:ed:11:42:80:00:20:b5:6c:ce:32:14:57:dc:c6:aa:5d:</span><br><span class="line">         90:cb:12:8b:5b:fa:14:3f:48:34:35:0d:5f:a8:84:f5:db:5b:</span><br><span class="line">         a8:22:0e:12</span><br></pre></td></tr></table></figure><h1 id="kubeconfig文件"><a href="#kubeconfig文件" class="headerlink" title="kubeconfig文件"></a>kubeconfig文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# tree</span><br><span class="line">.</span><br><span class="line">├── admin.conf# 用于kubectl与apiserver进行认证/控制集群</span><br><span class="line">├── controller-manager.conf# 用于cm组件与apiserver进行认证</span><br><span class="line">├── kubelet.conf# 用于kubelet组件与apiserver进行认证</span><br><span class="line">└── scheduler.conf# 用于scheduler与apiserver进行认证</span><br></pre></td></tr></table></figure><p><strong>kubeconfig文件格式</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:# 集群配置</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority: */ca.crt# ca证书信息</span><br><span class="line">    server: https://******# 集群地址</span><br><span class="line">  name: demo# 集群名称</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: demo# 集群名称</span><br><span class="line">    user: demo# 对应证书CN值</span><br><span class="line">  name: demo</span><br><span class="line">current-context: demo</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: demo# 对应证书CN值</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: */client.crt# 客户端证书</span><br><span class="line">    client-key: */client.key# 客户端私钥</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> OpenSSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenSSL</title>
      <link href="/archives/2e203ce7.html"/>
      <url>/archives/2e203ce7.html</url>
      
        <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="加密算法"><a href="#加密算法" class="headerlink" title="加密算法"></a>加密算法</h2><ul><li>对称加密(使用相同的密码进行加密解密)</li></ul><p>对称加密是指双方对约定一个相同的密码，通过这个密码对文件或信息进行加密解密</p><p>常见加密算法：DES、3DES、IDEA等</p><ul><li>非对称加密(使用不相同的密码进行加密解密)</li></ul><p>非对称加密是通过生成密钥对(公钥&#x2F;私钥)，通过私钥对文件进行加密，可以使用公钥进行解密；通过使用公钥进行加密，只能使用私钥进行解密。一般私钥是私有的，公钥是公开的，一旦私钥泄露对安全的影响极大</p><p>常见加密算法：RSA、ECC等</p><h2 id="摘要算法"><a href="#摘要算法" class="headerlink" title="摘要算法"></a>摘要算法</h2><blockquote><p>MD5是摘要算法,不是加密算法</p></blockquote><p>消息摘要算法是指对信息、文件等数据进行计算，得到一定长度的摘要；比如我在网上下载了某个文件，我想确认文件是不是完整的，或者有没有被人修改的，只需要将文件下载到本地使用支持的相关算法进行摘要运算得出摘要信息，与发布者公示的摘要信息进行比较确认是否一致，如果一致则文件没有被修改也未损坏，如果不一样说明文件并不是原来的文件</p><p>消息摘要算法有如下几类：</p><ul><li><p>消息摘要</p><p>生成的消息摘要都是128位的包括：MD5、MD4、MD2，MD5相对4、2安全性最高，至今未被破解；通过MD5算法是不可逆的，无法通过加密后的信息破解出原始数据。但是MD5不足之处就是可以通过穷举进行推举出明文，因为相同的信息用MD5进行摘要运算后的信息都是一样的。在使用MD5摘要算法对密码进行加密时，应使用复杂密码</p></li><li><p>安全散列</p><p>SHA1、SHA256、SHA384、SHA512</p></li></ul><h2 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h2><p>数字签名的三个特征：</p><ul><li>不可否认</li><li>报文的完整性</li><li>报文鉴别</li></ul><p>数字签名是指对文件进行摘要运算得出摘要信息，通过使用私钥对摘要进行加密的过程称之为数字签名的过程，而通过加密摘要信息称之为该文件的数字签名</p><h2 id="证书颁发机构"><a href="#证书颁发机构" class="headerlink" title="证书颁发机构"></a>证书颁发机构</h2><ul><li><p>CA机构</p><p>CA机构全称为Certificate Authority证书认证中心，CA是否则签发证书、认证证书、管理已颁发的证书的机关。先前说的私钥公钥，每个人都可以去生成一对密钥对，而我们怎么确定这个密钥对一定是某某的呢？这时候我们就需要把我们的公钥以及相关信息发送给权威的CA机构，通过CA机构来鉴别</p><p>而CA机构的证书在安装好操作系统时就已经被内置在系统中</p><p><img src="/archives/2e203ce7/openssl.png" alt="image-20220829020633073"></p></li></ul><h1 id="生成密钥对"><a href="#生成密钥对" class="headerlink" title="生成密钥对"></a>生成密钥对</h1><ul><li><p>生成密钥对(公私钥)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc media]# openssl genrsa -out ca-key.pem 2048  # 生成2048位的私钥</span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">......................................+++++</span><br><span class="line">....................................................................................................................+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line">[root@xiaowangc media]# cat ca-key.pem</span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpAIBAAKCAQEA2CjcI+aU1cwHczvbMJglT/QstPJzKwwRqftmUTm4UjWJCBap</span><br><span class="line">MSjWS+9EfkoqqkwUodjy6d1KyOqlXKnsa6JuinkbL0S2iFnh0RN19EIoqne+a1Y5</span><br><span class="line">3KhrV0J765bl71ugdU87G5WxgnXrQeZcHINeEUkkMTfAL//FWnZlZdJ2JMUrc6Og</span><br><span class="line">CX+NzX4ITLNZagILWIC3IofGkxLGLRestN4Lveh4S7bLZHQekqsxLgRG0tWIGa3b</span><br><span class="line">V50gFbRdeFWYP82Z59AK6t62/fcSefSqwCRBnHOkTKkGom13umV/vIkW8rdexVZE</span><br><span class="line">tCYvZmbN4qNJ5GGSjiBWHj8qtDqnw8Bjz3zF4QIDAQABAoIBAF68kbb+UQ7ezAka</span><br><span class="line">G7fRhtDi8FEhzY35TSiVsUM6K+mD4xnzbJXKExnWtMsw0EAw9f31KomK3kLubCkP</span><br><span class="line">pDmMSCxSZbKyx9k8o3bRs6mo8U+9CWzbrqJiAiGNVuhrCz17h/jCD+LIGbNW4RPR</span><br><span class="line">1V79yFWFG+KiT4356FH8f/Y/Zl44ad6OVVGr66tgpAv2fOUNiInOcKpi+AmSl4lj</span><br><span class="line">3Us/Sc+ZqgaLkdWFWvQM+RtjFvDt9E7GHrHieh+CnTmKj9CRzHBDTut/36WdTqlS</span><br><span class="line">JnyBQsTUD4T2yTgTlr0ewhRcITXrUY2od0cm+dpr33UCE8nDMMGAWvGCL6ZD0CHr</span><br><span class="line">w4Rk9hECgYEA6/yGJBrt8TTB9RTQTaflD1YB6nF1NMwJ1M2SQz5w6uhOnfvigpIj</span><br><span class="line">lBAp3JfpgnYcjxUoXPanrSk04UwtM5llmDMj8wg66XtSmm8iT0uL4PbrZUxONjKo</span><br><span class="line">4BYud0rIWFMrZilc0EIm0nywsfK3L+lhtM+/+1uVCGgDfW8YIgT+wg0CgYEA6n3g</span><br><span class="line">zGwxAPN/wAD4i2/hc3tQ+Z9LgAcFy7MAxEzOv62Gcbge3NohHwTPTm7wuQr53TZg</span><br><span class="line">GcNV+T0UiOhKEjcSccqiq8IHsfl+dCaWJQdPSnG5XrHd2zRSYuzihVQLgiHWSkJG</span><br><span class="line">06U8BdmXN/7Yp99TX60O2ADNivSrr8rHRzw5IiUCgYEArbTvRMpx1bhhATd18YOh</span><br><span class="line">z70eoeUsQlXi8rrza/4dfjzMCeysmjJacBXJyrAj2b15XjVTxcJmQMdxPlold7L1</span><br><span class="line">nqgeUToAq3b0oesmVTol183KDoGxnKGDv5d0UqlAeguWiZfu0vmuvAe+xO4FvAXN</span><br><span class="line">vxuhlLOgK1TtJLrPB9Ond00CgYEA4xTn389eXVdxfZTzHMVKBTWEo1g6G0+xsyQ0</span><br><span class="line">N+VRypnWusXdTW8H6CwWPhR9lhUlB66ivhBGb8lQ24xoPt+KQxxDECYkoZvFc+Hy</span><br><span class="line">QQWlKaicJTIGcUNoDVjtvMQ5KNpv1RX91PQM/nVLVfS8B0XkTaEf4NpWMpzirqim</span><br><span class="line">9ztA8OkCgYBr/MLkp/6EvoeUhH1SwCal2DThXhbIuTOoVjl1lQhLqdyJlKnKPAN2</span><br><span class="line">mTcwzk779JQhIvbFS8iZ4iYu6mBJGStnMzl+ZHWhRgHohT4M960ToikTsNOwbMon</span><br><span class="line">CCg+8ntFycNc0ml0BBQ5B37AN72iX0Fwair93PdDyH46PRIuiIZ8zg==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line">[root@xiaowangc media]#</span><br></pre></td></tr></table></figure></li><li><p>通过私钥提取出公钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc media]# openssl rsa -in ca-key.pem -pubout -out ca-pub.pem</span><br><span class="line">writing RSA key</span><br><span class="line">[root@xiaowangc media]# ls</span><br><span class="line">ca-key.pem  ca-pub.pem</span><br><span class="line">[root@xiaowangc media]# cat ca-pub.pem</span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2CjcI+aU1cwHczvbMJgl</span><br><span class="line">T/QstPJzKwwRqftmUTm4UjWJCBapMSjWS+9EfkoqqkwUodjy6d1KyOqlXKnsa6Ju</span><br><span class="line">inkbL0S2iFnh0RN19EIoqne+a1Y53KhrV0J765bl71ugdU87G5WxgnXrQeZcHINe</span><br><span class="line">EUkkMTfAL//FWnZlZdJ2JMUrc6OgCX+NzX4ITLNZagILWIC3IofGkxLGLRestN4L</span><br><span class="line">veh4S7bLZHQekqsxLgRG0tWIGa3bV50gFbRdeFWYP82Z59AK6t62/fcSefSqwCRB</span><br><span class="line">nHOkTKkGom13umV/vIkW8rdexVZEtCYvZmbN4qNJ5GGSjiBWHj8qtDqnw8Bjz3zF</span><br><span class="line">4QIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure></li></ul><h1 id="生成摘要"><a href="#生成摘要" class="headerlink" title="生成摘要"></a>生成摘要</h1><h2 id="对字符串生成摘要"><a href="#对字符串生成摘要" class="headerlink" title="对字符串生成摘要"></a>对字符串生成摘要</h2><ul><li><p>MD5</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc media]# echo 123456 | openssl md5</span><br><span class="line">(stdin)= f447b20a7fcbf53a5d5be013ea0b15af</span><br><span class="line">[root@xiaowangc media]#</span><br></pre></td></tr></table></figure></li><li><p>Sha</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc media]# echo 123456 | openssl sha1</span><br><span class="line">(stdin)= c4f9375f9834b4e7f0a528cc65c055702bf5f24a</span><br><span class="line">[root@xiaowangc media]# echo 123456 | openssl sha256</span><br><span class="line">(stdin)= e150a1ec81e8e93e1eae2c3a77e66ec6dbd6a3b460f89c1d08aecf422ee401a0</span><br><span class="line">[root@xiaowangc media]#</span><br></pre></td></tr></table></figure></li></ul><h2 id="对文件生成摘要"><a href="#对文件生成摘要" class="headerlink" title="对文件生成摘要"></a>对文件生成摘要</h2><ul><li><p>MD5</p><blockquote><p>更改文件名MD5值不变，当内容发生改变后MD5值才会产生变化</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc media]# echo xiaowangc &gt; 1.txt</span><br><span class="line">[root@xiaowangc media]# openssl dgst -md5 1.txt</span><br><span class="line">MD5(1.txt)= 117d8e3d36b77fd390ee6f0304257ec1</span><br></pre></td></tr></table></figure><p><strong>验证更改文件数据后的MD5值</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc media]# echo 12345678 &gt; 1.txt</span><br><span class="line">[root@xiaowangc media]# openssl dgst -md5 1.txt</span><br><span class="line">MD5(1.txt)= 23cdc18507b52418db7740cbb5543e54</span><br></pre></td></tr></table></figure></li><li><p>Sha256</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xiaowangc media]# openssl dgst -sha256 1.txt</span><br><span class="line">SHA256(1.txt)= e7e213f38f47bbaec6aef3307831c1ce60a932e2c380a19e00d191927122a9f4</span><br></pre></td></tr></table></figure></li></ul><h1 id="生成数字签名"><a href="#生成数字签名" class="headerlink" title="生成数字签名"></a>生成数字签名</h1><p>通过上面的命令已经了解到了如何生成密钥对以及提取摘要信息，下面我们开始试着对文件进行数字签名</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对文件进行摘要运算</span></span><br><span class="line">[root@xiaowangc media]# ls</span><br><span class="line">ca-key.pem  ca-pub.pem</span><br><span class="line">[root@xiaowangc media]# echo xiaowangc.com &gt; 1.txt</span><br><span class="line">[root@xiaowangc media]# openssl dgst -md5 1.txt</span><br><span class="line">MD5(1.txt)= b02eb36de574cd721a3dda12d1693ff3</span><br><span class="line">[root@xiaowangc media]# openssl dgst -sha256 1.txt</span><br><span class="line">SHA256(1.txt)= a84c0b84e7e54dcb092f289b174b506580e675682b0c79756d90947e07fe4fea</span><br><span class="line">[root@xiaowangc media]# openssl dgst -sha512 1.txt</span><br><span class="line">SHA512(1.txt)= cb7e7a147ed14a0479a792fb4d6f3c83d63da9627d8e5badfb2f98f4e180bec1813f211d639357af3044757a3946af35827be29bb0c2320e7cdfcf8a9de5eb9e</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用私钥对文件进行签名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过-hex在命令行显示数字签名信息</span></span><br><span class="line">[root@xiaowangc media]# openssl dgst -md5 -hex -sign ca-key.pem 1.txt</span><br><span class="line">RSA-MD5(1.txt)= 00f943f79704d775c6b4112a1ebf7ff1c6cc314bf809f4482de2f2f159c83b297291c4159d307358d3bdb11214be8b5c6d1f2ec0c983910de0a1c2ba617de52eb609b55c140c34ef3cc5b65d29f7734e57dce29032e49ebf333d86ee2314aba65901a977e1426e17b7eb919cd9c74b87e4da025fa1428f494695c08349185a693b80a010596ce4985422766d1c38ed7328b35dbd4aa471e1b08292833038f2b2df30a8c89667c5036bf608fbb1b8f1eb2d16cd8c81ee583d2c2b3c23da744786f105643abd131a706a761f7ada75e4546c1349666d0fed88f86a529d04e83e98ddeb031500a0d8a2c678cbd56aa8d51d25a643a282bd876a39066f55a1fc9db4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过将数字签名保存到文件中，保存不能使用-hex参数</span></span><br><span class="line">[root@xiaowangc media]# openssl dgst -md5 -out 1.txt.sign -sign ca-key.pem 1.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为是二进制所以显示乱码</span></span><br><span class="line">[root@xiaowangc media]# cat 1.txt.sign</span><br><span class="line">ºa&#125;.*\4&lt;Ŷ])sNW2䞿3=#YwBn둜K_BIF��IZi;YlT&quot;vm8s(]Jqᰂ080Ȗg-͌X=,+</span><br><span class="line">[root@xiaowangc media]#</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  使用公钥来对文件进行验证数字签名</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################################</span></span></span><br><span class="line">[root@xiaowangc media]# ls</span><br><span class="line">1.txt  1.txt.sign  ca-key.pem  ca-pub.pem</span><br><span class="line">[root@xiaowangc media]# openssl dgst -md5 -verify ca-pub.pem -signature 1.txt.sign 1.txt</span><br><span class="line">Verified OK </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成数字签名的时候使用的是MD5算法，所有验证的时候也要指定相同算法</span></span><br></pre></td></tr></table></figure><h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建CA</span></span><br><span class="line">openssl req -new -newkey rsa:2048 -keyout ca.key -out ca.csr -nodes</span><br><span class="line">openssl x509 -req -days 36500 -sha256  -signkey ca.key -in ca.csr -out ca.crt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过CA签发node01</span></span><br><span class="line">openssl req -new -newkey rsa:2048 -keyout node01.key -out node01.csr -nodes</span><br><span class="line">openssl x509 -req -sha256 -days 36500 -in node01.csr -CA ca.crt -CAkey ca.key -out node01.crt -CAcreateserial</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenSSL </tag>
            
            <tag> 证书 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NetFilter/IPtables</title>
      <link href="/archives/9fdd5e2e.html"/>
      <url>/archives/9fdd5e2e.html</url>
      
        <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><blockquote><p>防火墙发展</p></blockquote><p>防火墙检测技术经过了三个阶段:</p><ol><li><p>包过滤防火墙</p><p>包过滤防火墙是基于路由器ACL规则的第一代防火墙，根据网络层协议中的地址信息或者传输层信息设定，通过允许和阻塞某些指定规则的数据包</p></li><li><p>应用代理防火墙</p><p>代理服务作用于网络的应用层，替代工作网络客户端执行应用层的连接，即提供代理服务；防火墙转发外部用户请求，与受信网络的服务器建立连接。与包过滤防火墙不同的是这些访问都是基于应用层中进行控制的</p></li><li><p>状态检测防火墙</p><p>第三代防火墙，类似于包过滤防火墙，采用更复杂的访问控制算法。状态检测防火墙工作在传输层，使用状态表记录会话信息。会话建立成功以后，记录信息并实时更新，所有会话数据都要与状态表信息匹配否则将被阻断</p></li></ol><p>Netfilter项目是集成到Linux内核协议栈中的一套防火墙机制，现集成在Linux2.4.x及更高版本的内核中。用户可以通过运行工具将相关配置下发给防火墙，简单来说不管是使用iptables&#x2F;firewalld的命令进行防火墙配置，这两款工具底层依靠的是Netfilter(真正起到防火墙的的功能的)。</p><p>该框架既简单又灵活，可实现安全策略应用中的许多功能，如数据包过滤、数据包处理、地址伪装、透明代理、动态网络地址转换，以及基于用户及媒体访问控制、地址的过滤和基于状态的过滤、包速率限制等。</p><p>Netfilter主要特点有：</p><ul><li>无状态数据包过滤(IPV4&amp;IPV6)</li><li>有状态数据包过滤(IPV4&amp;IPV6)</li><li>各种网络地址和端口转换，NAT&#x2F;NAPT(IPV4&amp;IPV6)</li><li>灵活和可扩展的基础设施</li><li>用于第三方扩展的多层API</li></ul><p>子系统常见框架：</p><ul><li>IPVS：四层负载均衡解决方案</li><li>IPSet：由用户空间工具和内核部分组成的框架</li><li>IPtables：Linux防火墙</li></ul><h1 id="四表五链"><a href="#四表五链" class="headerlink" title="四表五链"></a>四表五链</h1><p>防火墙的功能就是对经过的数据包进行匹配规则，然后执行相应的动作。当数据包进入主机后必须匹配这个表中的相应规则进行相应的动作处理。而规则就存放于链中</p><ul><li><p>链</p><p><strong>prerouting</strong>：路由前。数据包进入路由表之前(进站前)的数据包进行规则匹配</p><p><strong>input</strong>：进站。通过路由表查询后，目的地址为本机的数据包进行匹配规则</p><p><strong>forward</strong>：转发。通过路由表查询后，目的地址不为本机的数据包进行匹配规则</p><p><strong>output</strong>：出站。由本机产生的数据包，向外转发时的数据包进行匹配规则</p><p><strong>postrouing</strong>：路由后。发送到网卡之前(出站后)对数据包匹配规则</p></li></ul><p>表是用于存放相同规则的集合</p><ul><li><p>表</p><p><strong>filter</strong>：用于数据包过滤</p><p><strong>nat</strong>：用于nat功能(端口映射，地址转换)</p><p><strong>raw</strong>：有限级最高，设置此表是为了不让iptables做数据包的连接跟踪处理，提高性能</p><p><strong>mangle</strong>：用于对指定数据包的修改（拆包，修改，封包）</p></li></ul><p>表和链的关系(某些链只能存放于特定的表)</p><table><thead><tr><th>raw表</th><th>mangle表</th><th>nat表</th><th>filter表</th></tr></thead><tbody><tr><td>PreRouting链</td><td>PreRouting链</td><td>PreRouting链</td><td></td></tr><tr><td></td><td>InPut链</td><td><strong>InPut链(CentOS7)</strong></td><td>InPut链</td></tr><tr><td></td><td>Forward链</td><td></td><td>Forward链</td></tr><tr><td>Output链</td><td>Output链</td><td>Output链</td><td>OutPut链</td></tr><tr><td></td><td>PostRouting链</td><td>PostRouting链</td><td></td></tr></tbody></table><h1 id="数据流向"><a href="#数据流向" class="headerlink" title="数据流向"></a>数据流向</h1><p>若仔细观察上表可得出表的优先</p><p>例如PreRouting链(路由前)可存放于三张表中，通过观察下图，可以得知数据包进入转发时先经过raw、mangle、nat表，刚好对应上表名称顺序。</p><blockquote><p>表优先级（执行动作顺序）：raw &gt; mangle &gt; nat &gt; filter，相同的链存在多个表中将会依照表优先级进行匹配执行</p></blockquote><p>下图是将上表进行逻辑呈现，当数据包进入主机先匹配PreRouting链，而存放PreRouting链的表有raw，mangle，nat，将按照优先级依次进行匹配……</p><p><img src="/archives/9fdd5e2e/netfilter1.png" alt="image-20220219125859519"></p><blockquote><p>需要开启Linux Forward功能需开启内核路由转发功能。echo “1” &gt; &#x2F;proc&#x2F;sys&#x2F;ipv4&#x2F;ip_forward</p></blockquote><h1 id="动作及条件"><a href="#动作及条件" class="headerlink" title="动作及条件"></a>动作及条件</h1><p><strong>动作</strong>(符合条件所执行的动作)：</p><ul><li>accept：允许数据包通过</li><li>drop：丢弃数据包，不会返回响应</li><li>reject：拒绝数据包，必要时会发送一个响应信息，告诉客户端被拒绝</li><li>snat：源地址转换</li><li>dnat：目的地址转换</li><li>masquerade：</li><li>log：记录日志信息</li><li>masquerade：特殊的SNAT，用于动态IP的SNAT</li></ul><p><strong>条件</strong>(同于匹配数据包)：</p><ul><li><p>基本条件</p><p>源地址，目的地址</p></li><li><p>扩展条件</p><p>TCP</p><p>UDP</p><p>ICMP</p><p>MAC</p><p>MARK</p><p>OWNE</p><p>LIMIT</p><p>STATE</p><p>INVALID</p><p>ESTABLISHED</p><p>NEW</p><p>RELATED</p><p>TOS</p></li></ul><h1 id="iptables命令"><a href="#iptables命令" class="headerlink" title="iptables命令"></a>iptables命令</h1><h2 id="查"><a href="#查" class="headerlink" title="查"></a>查</h2><p>使用iptables -L 默认查询的filter表</p><p>-L，列出规则</p><p>-v，列出详细规则</p><p>–line-numbers(-line)，列出规则时显示编号</p><p>-t，操作的表</p><p>-n，不对IP或者端口进行名称解析</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy DROP)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">DOCKER-USER  all  --  anywhere             anywhere</span><br><span class="line">DOCKER-ISOLATION-STAGE-1  all  --  anywhere             anywhere</span><br><span class="line">ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED</span><br><span class="line">DOCKER     all  --  anywhere             anywhere</span><br><span class="line">ACCEPT     all  --  anywhere             anywhere</span><br><span class="line">ACCEPT     all  --  anywhere             anywhere</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain DOCKER (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">DOCKER-ISOLATION-STAGE-2  all  --  anywhere             anywhere</span><br><span class="line">RETURN     all  --  anywhere             anywhere</span><br><span class="line"></span><br><span class="line">Chain DOCKER-ISOLATION-STAGE-2 (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">DROP       all  --  anywhere             anywhere</span><br><span class="line">RETURN     all  --  anywhere             anywhere</span><br><span class="line"></span><br><span class="line">Chain DOCKER-USER (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">RETURN     all  --  anywhere             anywhere</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><p>使用iptables -t 表名 -L </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t raw -L</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">[root@localhost ~]# iptables -t nat -L</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">MASQUERADE  all  --  172.17.0.0/16        anywhere</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">DOCKER     all  --  anywhere            !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">RETURN     all  --  anywhere             anywhere</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><p>使用iptables -t 表名 -vL 查看详细信息</p><p>iptables -t nat -vL 链名 可查看nat表下链的详细信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -vL</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">链   PREROUTING (策略 放行9个包，大小2485bytes)</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 9 packets, 2485 bytes)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">匹配包个数 包大小总和 协议 选项 数据包进网口 数据包出网口 源地址 目的地址</span></span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    4   272 DOCKER     all  --  any    any     anywhere             anywhere             ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 4 packets, 272 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 51 packets, 3835 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 MASQUERADE  all  --  any    !docker0  172.17.0.0/16        anywhere</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 51 packets, 3835 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 DOCKER     all  --  any    any     anywhere            !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 RETURN     all  --  docker0 any     anywhere             anywhere</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################################################################</span></span></span><br><span class="line">[root@localhost ~]# iptables -t nat -vL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 4 packets, 272 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################################################################</span></span></span><br><span class="line">[root@localhost ~]# iptables -t nat -vnL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 10 packets, 2569 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    5   356 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 5 packets, 356 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 63 packets, 4732 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 63 packets, 4732 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><h2 id="增"><a href="#增" class="headerlink" title="增"></a>增</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.1.1 -j DROP</span><br><span class="line">-t # 选择表</span><br><span class="line">-I # insert在什么链中插入规则</span><br><span class="line">-s # 源地址</span><br><span class="line">-j # 动作</span><br><span class="line">-A # 追加</span><br></pre></td></tr></table></figure><h2 id="删"><a href="#删" class="headerlink" title="删"></a>删</h2><blockquote><p>可以通过–line显示序号删除，或者写完整的策略进行删除</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -D INPUT -s 192.168.1.1 -j DROP</span><br><span class="line">-D # 删除delete删除某个链下的规则</span><br><span class="line">[root@localhost ~]# iptables -t filter -F</span><br><span class="line">-F # 清空所有链上的规则</span><br><span class="line">[root@localhost ~]# iptables -t filter -L</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -vL --line</span><br><span class="line">Chain INPUT (policy ACCEPT 22720 packets, 64M bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 DROP       all  --  any    any     192.168.1.1          anywhere</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 15639 packets, 1048K bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">[root@localhost ~]# iptables -t filter -D INPUT 1# 删除对应编号的规则</span><br><span class="line">--line# 使规则输出时带编号</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="改"><a href="#改" class="headerlink" title="改"></a>改</h2><blockquote><p>IPTALBES默认是黑名单，可以通过iptables修改成白名单</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -R INPUT  1 -s 192.168.2.1 -j REJECT</span><br><span class="line">-R </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改对应编号的规则为...</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t mangle -L</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">[root@localhost ~]# iptables -t mangle -P FORWARD DROP</span><br><span class="line">[root@localhost ~]#</span><br><span class="line">[root@localhost ~]# iptables -t mangle -L</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy DROP)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">[root@localhost ~]# iptables -t mangle -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-R #修改链默认规则</span><br></pre></td></tr></table></figure><h2 id="存"><a href="#存" class="headerlink" title="存"></a>存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、service iptables save</span><br><span class="line">2、iptables-save &gt; /etc/sysconfig/iptables# iptables-save只能输出当前规则</span><br><span class="line">3、iptables-restore &lt; /etc/sysconfig/iptables# 重新加载规则</span><br></pre></td></tr></table></figure><h1 id="匹配规则"><a href="#匹配规则" class="headerlink" title="匹配规则"></a>匹配规则</h1><h2 id="IP-IPrange"><a href="#IP-IPrange" class="headerlink" title="IP(IPrange)"></a>IP(IPrange)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.1.1,192.168.1.2 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝两个源IP为xxx</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.1.0/24 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝一个网段</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -d 192.168.1.1 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝一个目的IP为xxx</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.2.1 -d 192.168.1.1 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝一个源IP为xxx目的IP为xxx</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -m iprange --src-range 192.168.2.1-192.168.2.100 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过iprange模块拒绝一段范围的源IP地址</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -m iprange --dst-range 192.168.2.1-192.168.2.100 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过iprange模块拒绝一段范围的目的IP地址</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.2.1 -d 192.168.1.1 -p tcp -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝源IP为xxx目的IP为xxx的tcp协议</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.2.1 -d 192.168.1.1 -p tcp -j DROP</span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.2.1 -d 192.168.1.1 -p udp -j DROP</span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -s 192.168.2.1 -d 192.168.1.1 -p icmp -j DROP</span><br><span class="line">[root@localhost ~]# iptables -L INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">DROP       icmp --  192.168.2.1          192.168.1.1</span><br><span class="line">DROP       udp  --  192.168.2.1          192.168.1.1</span><br><span class="line">DROP       tcp  --  192.168.2.1          192.168.1.1</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><h2 id="网口"><a href="#网口" class="headerlink" title="网口"></a>网口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -i ens33 -p icmp -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝网卡ens33的ICMP协议</span></span><br><span class="line">-i # 指定网卡，只用用于PREROUTING、INPUT、FORWARD</span><br><span class="line">-p # 协议</span><br></pre></td></tr></table></figure><h2 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -I INPUT  -s 192.168.2.1 -d 192.168.1.1 -p tcp -m tcp --dport 22 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝源IP为xxx到目的IP为xxx的ssh协议请求</span></span><br><span class="line">-m # 使用扩展规则需要使用-m指定扩展模块为tcp</span><br><span class="line">--dport # 端口</span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT  -s 192.168.2.1 -d 192.168.1.1 -p tcp -m tcp --sport 22 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝IP:22到IPxxx</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT  -s 192.168.2.1 -d 192.168.1.1 -p tcp -m tcp --sport 22:32 -j DROP</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝一段端口</span></span><br></pre></td></tr></table></figure><h2 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">时间模块，通过time模块指定在某时间段之间的报文匹配规则</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I OUTPUT -p tcp --dport 80 -m time --timestart 08:00:00 --timestop 12:00:00 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -t filter -I OUTPUT -p tcp --dport 443 -m time --timestart 08:00:00 --timestop 12:00:00 -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在早上8点到中午12点不能访问网页</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I OUTPUT -p tcp --dport 80 -m time --weekdays 1,2,3,4,5 -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工作日不能访问网页</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I OUTPUT -p tcp --dport 80 -m time --weekdays 6,7 --timestart 08:00:00 --timestop 12:00:00 -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">周末的8-12点不能访问网页</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I OUTPUT -p tcp --dport 80 -m time --datastart 2022-07-06 --datastop 2022-07-08 -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定日期不能访问网页</span></span><br></pre></td></tr></table></figure><h2 id="connlimit"><a href="#connlimit" class="headerlink" title="connlimit"></a>connlimit</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过connlimit限制连接数量，不指定IP地址，默认就是对单一IP的并发数量进行限制</span></span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 2 -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每个客户端只能与服务器建立两个80端口连接</span></span><br></pre></td></tr></table></figure><h2 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过<span class="built_in">limit</span>限制报文到达的速率，例如每秒最多有多少个包进行传入，或者每分钟</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -p icmp -m limit --limit 10/m -J ACCEPT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每分钟放行10个ICMP数据包</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意链中默认策略是放行，当超过10/m是虽然是无法匹配的 但是默认策略是运行放行的</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -p icmp -m limit --limit-burst 3 --limit 10/m -J ACCEPT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用令牌桶，最大有3个名额，每分钟生成10个，每6秒生成一个，只有有名额的时候才能放行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位s m h d</span></span><br></pre></td></tr></table></figure><h2 id="TCP-Flags"><a href="#TCP-Flags" class="headerlink" title="TCP-Flags"></a>TCP-Flags</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可使用TCP模块的TCP-Flags对TCP中的标志位进行控制</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">[root@localhost ~]<span class="comment"># iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN -j REJECT</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁止连接到服务器22号端口的SYN标志的TCP报文(第一次握手)</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags SYN,ACK,FIN,RST,URG,PSH SYN,ACK -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁止连接到服务器22号端口的SYN,ACK标志的TCP报文(第二次握手)</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --tcp-flags ALL SYN,ACK -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">标志位可以用ALL代替</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -p tcp -m tcp --dport 22 --syn -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">专门禁止第一次握手</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h2><p>ICMP协议(互联网传输控制协议)，用于探测网络是否可达，主机是否存活等。</p><p>图下为ICMP报文类型以及代码</p><p><img src="/archives/9fdd5e2e/netfilter2.jpeg" alt="img"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果使用基础匹配对ICMP进行过滤来实现禁Ping，虽然是可以实现的，但是也阻断了本身的Ping功能</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -p ICMP -J REJECT</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">想要实现禁止Ping但自身能够Ping的规则如下</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -p ICMP -m ICMP --icmp-type 8/0 -j REJECT</span><br></pre></td></tr></table></figure><h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><blockquote><p>state模块是对TCP、UDP、ICMP等有连接的报文进行控制的，</p></blockquote><p>报文的可分为5中状态：</p><ol><li><p>NEW</p><p>A向B发送建立请求的第一个包，状态为NEW(第一次握手)</p></li><li><p>ESTABLISHED</p><p>B向A返回请求并开放端口，状态为ESTABLISHED(第二次握手，第二次握手之后的报文都是此状态)</p></li><li><p>RELATED</p><p>临时连接</p></li><li><p>INVALID</p><p>无状态</p></li><li><p>UNTRACKED</p><p>报文未被追踪到，无法找到相关的连接</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -m state --state NEW -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝别人向本机建立连接，但是我可以向别人建立连接</span></span><br><span class="line">[root@localhost ~]# iptables -t filter -I INPUT -m state --state RELATED,ESTABLISHED -j ACESSPT</span><br><span class="line">[root@localhost ~]# iptables -t filter -A INPUT -j REJECT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拒绝别人向我建立连接，但是我可以向别人建立连接</span></span><br></pre></td></tr></table></figure><h1 id="自定义链"><a href="#自定义链" class="headerlink" title="自定义链"></a>自定义链</h1><p>Netfilter默认是有四表五链的，而规则是保存在链(链表)中，自定义链类似用来给我们的规则进行分组，当规则条数过多全部放在默认的链中不方便我们对其进行管理</p><h2 id="新建链"><a href="#新建链" class="headerlink" title="新建链"></a>新建链</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -N Nginx# 默认在filter表中</span><br><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain Nginx (0 references)</span><br><span class="line">target     prot opt source               destination</span><br></pre></td></tr></table></figure><h2 id="修改链"><a href="#修改链" class="headerlink" title="修改链"></a>修改链</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain Nginx (0 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">[root@localhost ~]# iptables -E Nginx Web_APP</span><br><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain Web_APP (0 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><h2 id="删除链"><a href="#删除链" class="headerlink" title="删除链"></a>删除链</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain Web_APP (0 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">[root@localhost ~]# iptables -X Web_APP</span><br><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br></pre></td></tr></table></figure><h2 id="关联链"><a href="#关联链" class="headerlink" title="关联链"></a>关联链</h2><blockquote><p>在了解四表五连的流量走向后，可以知道默认数据都是在四张表中的默认链进行转发的，我们创建的自定义链必须与默认链进行关联，也就是在满足什么规则后将流量转发进入到自定义链中</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">[root@localhost ~]# iptables -N Web_App# 在filter表中创建Web_app链</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 80 -j Web_App# 当流量进入filter表的INPUT链条件匹配目标端口为80时将其转发到Web_app链中</span><br><span class="line">[root@localhost ~]# iptables -L</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">Web_App    tcp  --  anywhere             anywhere             tcp dpt:http</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain Web_App (1 references)# 对链进行关联后references为1(引用计数)</span><br><span class="line">target     prot opt source               destination</span><br></pre></td></tr></table></figure><h1 id="扩展动作"><a href="#扩展动作" class="headerlink" title="扩展动作"></a>扩展动作</h1><h2 id="LOG日志"><a href="#LOG日志" class="headerlink" title="LOG日志"></a>LOG日志</h2><blockquote><p>顾名思义就是对符合条件的数据包做记录的</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j LOG</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对进栈访问22端口的流量进行记录；在/var/log/messages</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可修改日志保存的文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可发行版也许有差异</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/etc/rsyslog.conf</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">kern.warning /root/iptables.log</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j LOG --log-prefix &quot;ssh client conn&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对建立22连接的流量数据包进行记录</span></span><br></pre></td></tr></table></figure><h2 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 1.1.1.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对符合条件的数据包做源地址转换</span></span><br></pre></td></tr></table></figure><h2 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目的地址转换</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -d 192.168.1.1 -p tcp --dport 80 -j DNAT --to-destination 10.1.1.1:80</span><br></pre></td></tr></table></figure><h2 id="MASQUERADE"><a href="#MASQUERADE" class="headerlink" title="MASQUERADE"></a>MASQUERADE</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">动态地址转换,与SNAT相比会动态将源地址修改成网卡上可用的IP地址</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -I POSTROUTING -s 192.168.1.0/24 -o ens33 -j MASQUERADE</span><br></pre></td></tr></table></figure><h2 id="REDIRECT"><a href="#REDIRECT" class="headerlink" title="REDIRECT"></a>REDIRECT</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口映射</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -I PREROUTING -p tcp -dport 80 -j REDIRECT --tp-ports 8080</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iptables </tag>
            
            <tag> 防火墙 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqldump备份命令</title>
      <link href="/archives/fa9c6891.html"/>
      <url>/archives/fa9c6891.html</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL备份命令"><a href="#MySQL备份命令" class="headerlink" title="MySQL备份命令"></a>MySQL备份命令</h1><ul><li><p>备份数据库表结构及数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# mysqldump -hlocalhost -uroot -p123456 test &gt; /root/test.sql</span><br></pre></td></tr></table></figure></li><li><p>备份其中一张数据表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# mysqldump -hlocalhost -uroot -p123456 test t1 &gt; /root/test_t1.sql</span><br></pre></td></tr></table></figure></li><li><p>备份多张表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# mysqldump -hlocalhost -uroot -p123456 test t1 t2 t3 &gt; /root/test_t.sql</span><br></pre></td></tr></table></figure></li><li><p>备份整个数据库包含数据库本身</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# mysqldump -hlocalhost -uroot -p123456 -B test &gt; /root/test.sql</span><br></pre></td></tr></table></figure></li><li><p>备份所有数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# mysqldump -hlocalhost -uroot -p123456 --all-databases &gt; all.sql</span><br></pre></td></tr></table></figure></li><li><p>备份表结构不含数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# mysqldump -hlocalhost -uroot -p123456 -d test &gt; /root/test.sql</span><br></pre></td></tr></table></figure></li><li><p>备份数据包含表结构</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# mysqldump -hlocalhost -uroot -p123456 -t test &gt; /root/test.sql</span><br></pre></td></tr></table></figure></li><li><p>导入备份数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@xiaowangc:~# ls</span><br><span class="line">test.sql</span><br><span class="line">root@xiaowangc:~# mysql -uroot -p123456</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.39 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">source</span> test.sql</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenResty</title>
      <link href="/archives/da147c79.html"/>
      <url>/archives/da147c79.html</url>
      
        <content type="html"><![CDATA[<h1 id="OpenResty简介"><a href="#OpenResty简介" class="headerlink" title="OpenResty简介"></a>OpenResty简介</h1><p>OpenResty是一个基于Nginx与Lua(LuaJIT)的高性能Web平台，其内部集成了大量精良的Lua库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态Web应用、Web访问和动态网关</p><p>OpenResty通过汇聚各种设计精良的Nginx模块(例如Nginx C Module)，从而将Nginx有效变成一个强大的通用Web应用平台。这样Web开发人员和工程师可以使用Lua语言调动Nginx支持各种C以及Lua模块，快速构造出足以胜任10k乃至1000k以上单机并发连接的高性能web应用程序</p><p>高性能服务端的要素：</p><ul><li>缓存</li><li>异步非阻塞</li></ul><p>互联网公司内部的技术架构基本相似，主要体现在如下几个方面：</p><ul><li>数据量过大，如何定制存储</li><li>访问量过高，如何集群化部署，流量负载均衡</li><li>响应速度过慢，如何提高处理速度，引入多级缓存</li><li>如果机器过多，如何保证某服务器宕机，不影响业务的稳定</li></ul><p>OpenResty通用可以充当网关，作为客户端与服务段之间的桥梁，将通用的、非业务逻辑抽离、前置到网关系统，减少重复性开发工作，是整个网站的唯一流量入口；为了提高系统的扩展性，网关通常采用组件式架构，高内聚低耦合</p><p><strong>常用组件功能：</strong></p><ul><li>黑名单</li><li>日志</li><li>参数校验</li><li>鉴权</li><li>限流</li><li>负载均衡</li><li>路由转发</li><li>监控</li><li>灰度分流</li><li>多协议支持</li><li>熔断、降级、重试、数据聚合等</li></ul><p><strong>OpenResty的特点</strong>：</p><ul><li>支持跨网络的gRPC请求转发，底层采用HTTP&#x2F;2协议</li><li>支持SSL&#x2F;TLS证书加密</li><li>支持高并发请求</li><li>性能开销低，延迟少</li></ul><h1 id="OpenResty架构"><a href="#OpenResty架构" class="headerlink" title="OpenResty架构"></a>OpenResty架构</h1><h2 id="Nginx架构"><a href="#Nginx架构" class="headerlink" title="Nginx架构"></a>Nginx架构</h2><p><img src="/archives/da147c79/20220717220727969.png" alt="image-20220717220727969"></p><p>Nginx采用Master、Worker进程模型，分工明确，职责单一，也是具备高性能的原因之一</p><ol><li><p>master进程</p><p>master管理进程，处理指令通过进程间通信，将管理指令发送给其他worker进程，从而实现对worker的控制</p></li><li><p>worker进程</p><p>worker工作进程，不断接收客户端的连接请求，处理请求。数量通常设置为与CPU核数一致，nginx也会将每个进程与每个CPU进行绑定，充分利用其多核特性。</p><p>多个worker进程会竞争一个共享锁，只有抢到锁的进程才能处理客户端的请求。如果请求是accept事件，则会将其添加到accept队列中；如果是read或者write事件，则会将其添加到read-write队列。</p><p>nginx采用基于Epoll机制的事件驱动，异步非阻塞，大大提高并发处理能力</p></li></ol><h2 id="OpenResty架构-1"><a href="#OpenResty架构-1" class="headerlink" title="OpenResty架构"></a>OpenResty架构</h2><p><img src="/archives/da147c79/20220717221435075.png" alt="image-20220717221435075"></p><p>OpenResty是一个基于Nginx的Web平台，内部嵌入LuaJIT虚拟机运行Lua脚本，使用Lua编程语言对Nginx核心以及各种Nginx C模块进行脚本编程；另外Lua支持协程，协程是用户态的操作，上下文切换不用涉及内核态，系统资源开销小；协程占用内存很小，初始2KB</p><ul><li><p>每接到一个客户端请求，通过抢占锁，由一个worker进程来跟进处理</p></li><li><p>worker内部会创建一个lua协程，绑定请求，也就是一个请求对应一个lua协程</p></li><li><p>lua协程将请求通过网络发出，并添加一个event事件到nginx，然后当前协程就处于yield，让出CPU控制权</p></li><li><p>当服务端响应数据后，网络流程会创建一个新的event事件，将之前的协程唤醒，返回结果</p><p>ps：不同的lua协程之间数据隔离，保证请求之间互不影响。一个worker中同一时刻，只会有一个协程在运行</p></li></ul><h1 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h1><h2 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h2><p>Openresty给常见Linux发布提供官方预编译安装包，包含Ubuntu、Debian、RHEL、Centos、Alpine等提供二进制包仓库</p><p>下面演示在RHEL8.4版本中进行安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# wget https://openresty.org/package/rhel/openresty.repo# 下载存储库</span><br><span class="line">--2022-07-17 11:37:51--  https://openresty.org/package/rhel/openresty.repo</span><br><span class="line">Resolving openresty.org (openresty.org)... 182.92.62.145, 182.92.4.22</span><br><span class="line">Connecting to openresty.org (openresty.org)|182.92.62.145|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 263 [text/plain]</span><br><span class="line">Saving to: ‘openresty.repo’</span><br><span class="line"></span><br><span class="line">openresty.repo                100%[=================================================&gt;]     263  --.-KB/s    in 0s</span><br><span class="line"></span><br><span class="line">2022-07-17 11:37:52 (544 MB/s) - ‘openresty.repo’ saved [263/263]</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mv openresty.repo /etc/yum.repos.d/# 将存储库配置文件移动至仓库目录</span><br><span class="line">mv: overwrite &#x27;/etc/yum.repos.d/openresty.repo&#x27;? y</span><br><span class="line">[root@localhost ~]# dnf search openresty --show# 可查询openresty所有版本软件包信息</span><br><span class="line">Updating Subscription Management repositories.</span><br><span class="line">Unable to read consumer identity</span><br><span class="line"></span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line"></span><br><span class="line">Last metadata expiration check: 0:06:38 ago on Sun 17 Jul 2022 11:33:29 AM EDT.</span><br><span class="line">Module yaml error: Unexpected key in data: static_context [line 9 col 3]</span><br><span class="line">Module yaml error: Unexpected key in data: static_context [line 9 col 3]</span><br><span class="line">===================================================================================================== Name &amp; Summary Matched: openresty =====================================================================================================</span><br><span class="line">openresty-1.17.8.1-1.el8.x86_64 : OpenResty, scalable web platform by extending NGINX with Lua</span><br><span class="line">openresty-1.17.8.2-1.el8.x86_64 : OpenResty, scalable web platform by extending NGINX with Lua</span><br><span class="line">openresty-1.19.3.1-1.el8.x86_64 : OpenResty, scalable web platform by extending NGINX with Lua</span><br><span class="line">openresty-1.19.3.2-1.el8.x86_64 : OpenResty, scalable web platform by extending NGINX with Lua</span><br><span class="line">openresty-1.19.9.1-1.el8.x86_64 : OpenResty, scalable web platform by extending NGINX with Lua</span><br><span class="line">openresty-1.21.4.1-1.el8.x86_64 : OpenResty, scalable web platform by extending NGINX with Lua</span><br><span class="line">openresty-asan-1.17.8.1-1.el8.x86_64 : The clang AddressSanitizer (ASAN) version of OpenResty</span><br><span class="line">openresty-asan-1.17.8.2-1.el8.x86_64 : The clang AddressSanitizer (ASAN) version of OpenResty</span><br><span class="line">openresty-asan-1.19.3.1-1.el8.x86_64 : The clang AddressSanitizer (ASAN) version of OpenResty</span><br><span class="line">openresty-asan-1.19.3.1-5.el8.x86_64 : The AddressSanitizer (ASAN) version of OpenResty</span><br><span class="line">openresty-asan-1.19.3.2-1.el8.x86_64 : The AddressSanitizer (ASAN) version of OpenResty</span><br><span class="line">openresty-asan-1.19.9.1-1.el8.x86_64 : The AddressSanitizer (ASAN) version of OpenResty</span><br><span class="line">openresty-asan-1.21.4.1-1.el8.x86_64 : The AddressSanitizer (ASAN) version of OpenResty</span><br><span class="line">openresty-asan-debuginfo-1.17.8.1-1.el8.x86_64 : Debug information for package openresty-asan</span><br><span class="line">...</span><br><span class="line">[root@localhost ~]# dnf -y install openresty# 直接通过dnf软件包管理工具进行安装</span><br><span class="line">Updating Subscription Management repositories.</span><br><span class="line">Unable to read consumer identity</span><br><span class="line"></span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line"></span><br><span class="line">Last metadata expiration check: 0:08:02 ago on Sun 17 Jul 2022 11:33:29 AM EDT.</span><br><span class="line">Module yaml error: Unexpected key in data: static_context [line 9 col 3]</span><br><span class="line">Module yaml error: Unexpected key in data: static_context [line 9 col 3]</span><br><span class="line">Dependencies resolved.</span><br><span class="line">=============================================================================================================================================================================================================================================</span><br><span class="line"> Package                                                          Architecture                                       Version                                                     Repository                                             Size</span><br><span class="line">=============================================================================================================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> openresty                                                        x86_64                                             1.21.4.1-1.el8                                              openresty                                             1.1 M</span><br><span class="line">Installing dependencies:</span><br><span class="line"> openresty-openssl111                                             x86_64                                             1.1.1n-1.el8                                                openresty                                             1.6 M</span><br><span class="line"> openresty-pcre                                                   x86_64                                             8.45-1.el8                                                  openresty                                             167 k</span><br><span class="line"> openresty-zlib                                                   x86_64                                             1.2.12-1.el8                                                openresty                                              59 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================================================================================================================================================================</span><br><span class="line">Install  4 Packages</span><br><span class="line"></span><br><span class="line">Total download size: 2.9 M</span><br><span class="line">Installed size: 8.2 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">(1/4): openresty-pcre-8.45-1.el8.x86_64.rpm                                                                                                                                                                   94 kB/s | 167 kB     00:01</span><br><span class="line">(2/4): openresty-zlib-1.2.12-1.el8.x86_64.rpm                                                                                                                                                                192 kB/s |  59 kB     00:00</span><br><span class="line">(3/4): openresty-openssl111-1.1.1n-1.el8.x86_64.rpm                                                                                                                                                          560 kB/s | 1.6 MB     00:02</span><br><span class="line">(4/4): openresty-1.21.4.1-1.el8.x86_64.rpm                                                                                                                                                                   223 kB/s | 1.1 MB     00:05</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Total                                                                                                                                                                                                        578 kB/s | 2.9 MB     00:05</span><br><span class="line">warning: /var/cache/dnf/openresty-d4438f2e03fc84d1/packages/openresty-1.21.4.1-1.el8.x86_64.rpm: Header V4 RSA/SHA256 Signature, key ID d5edeb74: NOKEY</span><br><span class="line">Official OpenResty Open Source Repository for RHEL                                                                                                                                                           6.1 kB/s | 1.6 kB     00:00</span><br><span class="line">Importing GPG key 0xD5EDEB74:</span><br><span class="line"> Userid     : &quot;OpenResty Admin &lt;admin@openresty.com&gt;&quot;</span><br><span class="line"> Fingerprint: E522 18E7 0878 97DC 6DEA 6D6D 97DB 7443 D5ED EB74</span><br><span class="line"> From       : https://openresty.org/package/pubkey.gpg</span><br><span class="line">Key imported successfully</span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded.</span><br><span class="line">Running transaction</span><br><span class="line">  Preparing        :                                                                                                                                                                                                                     1/1</span><br><span class="line">  Installing       : openresty-zlib-1.2.12-1.el8.x86_64                                                                                                                                                                                  1/4</span><br><span class="line">  Installing       : openresty-openssl111-1.1.1n-1.el8.x86_64                                                                                                                                                                            2/4</span><br><span class="line">  Installing       : openresty-pcre-8.45-1.el8.x86_64                                                                                                                                                                                    3/4</span><br><span class="line">  Installing       : openresty-1.21.4.1-1.el8.x86_64                                                                                                                                                                                     4/4</span><br><span class="line">  Running scriptlet: openresty-1.21.4.1-1.el8.x86_64                                                                                                                                                                                     4/4</span><br><span class="line">  Verifying        : openresty-1.21.4.1-1.el8.x86_64                                                                                                                                                                                     1/4</span><br><span class="line">  Verifying        : openresty-openssl111-1.1.1n-1.el8.x86_64                                                                                                                                                                            2/4</span><br><span class="line">  Verifying        : openresty-pcre-8.45-1.el8.x86_64                                                                                                                                                                                    3/4</span><br><span class="line">  Verifying        : openresty-zlib-1.2.12-1.el8.x86_64                                                                                                                                                                                  4/4</span><br><span class="line">Installed products updated.</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  openresty-1.21.4.1-1.el8.x86_64                        openresty-openssl111-1.1.1n-1.el8.x86_64                        openresty-pcre-8.45-1.el8.x86_64                        openresty-zlib-1.2.12-1.el8.x86_64</span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><p>源码安装本文就不举例子了，大致流程可安装官方提供的文件进行安装即可，需要注意的就是请确认自己的系统版本，以及需要提前安装的依赖，否则编译时会出现ERROR导致不能正常安装</p><p>文档：<a href="http://openresty.org/cn/installation.html">http://openresty.org/cn/installation.html</a></p><ul><li>安装依赖</li><li>下载源码</li><li>安装gcc编译套件</li><li>正常编译流程</li></ul><h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>RHEL通过DNF包管理进行安装，配置目录处于&#x2F;usr&#x2F;local&#x2F;openresty下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost openresty]# pwd</span><br><span class="line">/usr/local/openresty</span><br><span class="line">[root@localhost openresty]# tree -L 2</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   └── openresty -&gt; /usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">├── COPYRIGHT</span><br><span class="line">├── luajit</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── include</span><br><span class="line">│   ├── lib</span><br><span class="line">│   └── share</span><br><span class="line">├── lualib</span><br><span class="line">│   ├── cjson.so</span><br><span class="line">│   ├── librestysignal.so</span><br><span class="line">│   ├── ngx</span><br><span class="line">│   ├── redis</span><br><span class="line">│   ├── resty</span><br><span class="line">│   └── tablepool.lua</span><br><span class="line">├── nginx</span><br><span class="line">│   ├── conf</span><br><span class="line">│   ├── html</span><br><span class="line">│   ├── logs</span><br><span class="line">│   └── sbin</span><br><span class="line">├── openssl111</span><br><span class="line">│   ├── bin</span><br><span class="line">│   └── lib</span><br><span class="line">├── pcre</span><br><span class="line">│   └── lib</span><br><span class="line">├── site</span><br><span class="line">│   └── lualib</span><br><span class="line">└── zlib</span><br><span class="line">    └── lib</span><br><span class="line"></span><br><span class="line">24 directories, 5 files</span><br><span class="line">[root@localhost openresty]#</span><br></pre></td></tr></table></figure><p>如果有Nginx的基础，那么学习其应该是非常容易的</p><p>配置文件在conf&#x2F;nginx.conf下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf]# cat nginx.conf | grep -v &quot;#&quot;</span><br><span class="line">worker_processes  1;# 工作进程数</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;# 工作进程连接数</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;# http配置块</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    server &#123;# server配置块</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="启动Openresty"><a href="#启动Openresty" class="headerlink" title="启动Openresty"></a>启动Openresty</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf]# systemctl enable --now openresty# 启动并设置开机启动</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/openresty.service → /usr/lib/systemd/system/openresty.service.</span><br><span class="line">[root@localhost conf]# curl localhost# 访问测试</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta content=&quot;text/html;charset=utf-8&quot; http-equiv=&quot;Content-Type&quot;&gt;</span><br><span class="line">&lt;meta content=&quot;utf-8&quot; http-equiv=&quot;encoding&quot;&gt;</span><br><span class="line">&lt;title&gt;Welcome to OpenResty!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to OpenResty!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the OpenResty web platform is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to our</span><br><span class="line">&lt;a href=&quot;https://openresty.org/&quot;&gt;openresty.org&lt;/a&gt; site&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;https://openresty.com/&quot;&gt;openresty.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;We have articles on troubleshooting issues like &lt;a href=&quot;https://blog.openresty.com/en/lua-cpu-flame-graph/?src=wb&quot;&gt;high CPU usage&lt;/a&gt; and</span><br><span class="line">&lt;a href=&quot;https://blog.openresty.com/en/how-or-alloc-mem/&quot;&gt;large memory usage&lt;/a&gt; on &lt;a href=&quot;https://blog.openresty.com/&quot;&gt;our official blog site&lt;/a&gt;.</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for flying &lt;a href=&quot;https://openresty.org/&quot;&gt;OpenResty&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@localhost conf]#</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> openresty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>yaml语法</title>
      <link href="/archives/f0b5a6ea.html"/>
      <url>/archives/f0b5a6ea.html</url>
      
        <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>YAML(YAML Ain’t Markup Language)，是一种可读性非常高的数据格式。YAML不再以标记为重点语言，而是围绕数据来组织结构化格式。常见YAML用于Playbook、K8S资源文件的书写标准</p><p>YAML文件后缀为yml、yaml</p><h1 id="YAML语法规则"><a href="#YAML语法规则" class="headerlink" title="YAML语法规则"></a>YAML语法规则</h1><ol><li>使用缩进表示层级关系、缩进的空格数不重要，只要相同的元素左对齐即可</li><li>YAML支持字典、数组、纯量(字符串、布尔值、整数、浮点数、Null、时间、日期)</li><li>YAML以#表示注释</li><li>区分大小写</li></ol><h2 id="纯量"><a href="#纯量" class="headerlink" title="纯量"></a>纯量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">xiaowangc</span><span class="comment"># 字符串</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">18</span><span class="comment"># 整数</span></span><br><span class="line"><span class="attr">number:</span><span class="number">18.1</span><span class="comment"># 浮点数</span></span><br><span class="line"><span class="attr">one:</span> <span class="literal">true</span><span class="comment"># 布尔值</span></span><br><span class="line"><span class="attr">two:</span> <span class="literal">null</span><span class="comment"># null</span></span><br><span class="line"><span class="attr">two:</span> <span class="string">~</span><span class="comment"># null</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2022-07-09</span><span class="comment"># 时间</span></span><br><span class="line"><span class="attr">time:</span> <span class="number">2022-07</span><span class="string">-09T20:30+08:00</span><span class="comment"># 日期 年月日 小时分钟 时区</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多行表示</span></span><br><span class="line"><span class="attr">str:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">效果:</span> <span class="string">&quot;This is a long string written by xiaowangc This is a long string written by xiaowangc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按原格式</span></span><br><span class="line"><span class="attr">str:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">效果:</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string">  This is a long string written by xiaowangc</span></span><br><span class="line"><span class="string">&quot;</span></span><br></pre></td></tr></table></figure><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式一</span></span><br><span class="line"><span class="attr">name:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">xiaowangc</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">zhangsan</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二</span></span><br><span class="line"><span class="attr">name:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">xiaowangc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">zhangsan</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 方式三</span></span><br><span class="line"><span class="attr">name:</span> [<span class="string">xiaowangc</span>,<span class="string">zhangsan</span>]</span><br></pre></td></tr></table></figure><h2 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">names:</span></span><br><span class="line">  <span class="attr">name01:</span> <span class="string">xiaowangc</span></span><br><span class="line">  <span class="attr">name02:</span> <span class="string">zhangsan</span></span><br><span class="line">  <span class="attr">name03:</span> <span class="string">lisi</span></span><br><span class="line">  <span class="attr">name04:</span> <span class="string">wanger</span></span><br><span class="line">  <span class="attr">age01:</span> <span class="number">1234</span></span><br><span class="line">  <span class="attr">age02:</span> <span class="number">7.7</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> YAML </category>
          
      </categories>
      
      
        <tags>
            
            <tag> yaml </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins-安装</title>
      <link href="/archives/705f63c3.html"/>
      <url>/archives/705f63c3.html</url>
      
        <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Jenkins是一款开源 CI&amp;CD 软件，用于自动化各种任务，包括构建、测试和部署软件。</p><p>Jenkins 支持各种运行方式，可通过系统包、Docker 或者通过一个独立的 Java 程序。</p><h1 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h1><p>最低推荐配置：</p><ul><li>256MB可用内存</li><li>1GB可用磁盘空间</li></ul><p>小团队推荐配置：</p><ul><li>1GB+可用内存</li><li>50GB+可用磁盘空间</li></ul><p>软件配置：</p><ul><li>Java8</li></ul><h1 id="安装Jenkins"><a href="#安装Jenkins" class="headerlink" title="安装Jenkins"></a>安装Jenkins</h1><p>Jenkins通常作为一个独立的应用程序在其自己的流程中运行， 内置Java servlet 容器&#x2F;应用程序服务器（Jetty）</p><p>Jenkins也可以运行在不同的Java servlet容器(（如Apache Tomcat 或 GlassFish）)中作为servlet运行</p><h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><ol><li><p>软件包方式安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf -y install java</span><br></pre></td></tr></table></figure></li><li><p>二进制方式安装</p><p>官网：<a href="https://www.oracle.com/java/technologies/downloads/%EF%BC%8C%E9%9C%80%E8%A6%81oracle%E8%B4%A6%E5%8F%B7">https://www.oracle.com/java/technologies/downloads/，需要oracle账号</a></p><p>Jre和jdk环境都可，这里我们使用jdk的二进制包进行安装</p><p><img src="/archives/705f63c3/image-20220705204344220.png" alt="image-20220705204344220"></p><p>下载好之后将压缩包上传至服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# ls</span><br><span class="line">anaconda-ks.cfg  jdk-8u321-linux-x64.tar.gz</span><br><span class="line">[root@jenkins ~]# tar xf jdk-8u321-linux-x64.tar.gz#解压</span><br><span class="line">[root@jenkins ~]# mv jdk1.8.0_321 /usr/local/</span><br><span class="line">[root@jenkins ~]# export JAVA_HOME=/usr/local/jdk1.8.0_321</span><br><span class="line">[root@jenkins ~]# export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib</span><br><span class="line">[root@jenkins ~]# export PATH=$PATH:$JAVA_HOME/bin:$JAVA_HOME/jre/bin</span><br><span class="line">[root@jenkins ~]# java -version</span><br><span class="line">java version &quot;1.8.0_321&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_321-b07)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.321-b07, mixed mode)</span><br></pre></td></tr></table></figure></li></ol><h2 id="下载安装Jenkins"><a href="#下载安装Jenkins" class="headerlink" title="下载安装Jenkins"></a>下载安装Jenkins</h2><p>官网：<a href="https://www.jenkins.io/zh/download/">https://www.jenkins.io/zh/download/</a></p><p>下载好之后上传至服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# ls</span><br><span class="line">anaconda-ks.cfg  jenkins.war</span><br><span class="line">[root@jenkins ~]# nohup java -jar jenkins.war --httpPort=80 &gt; jenkins.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h2 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h2><p><img src="/archives/705f63c3/image-20220705211926441.png" alt="image-20220705211926441"></p>]]></content>
      
      
      <categories>
          
          <category> Jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jenkins </tag>
            
            <tag> ci&amp;cd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git分布式版本控制</title>
      <link href="/archives/a13195e8.html"/>
      <url>/archives/a13195e8.html</url>
      
        <content type="html"><![CDATA[<h1 id="Git概述"><a href="#Git概述" class="headerlink" title="Git概述"></a>Git概述</h1><p>官网：<a href="https://git-scm.com/">https://git-scm.com/</a></p><p>Git 是一个免费和开源的 分布式版本控制系统，旨在以速度和效率处理从小型到大型项目的所有内容。</p><p>Git易于学习， 占用空间小，性能快如闪电。它优于 SCM 工具，如 Subversion、CVS、Perforce 和 ClearCase，具有廉价的本地分支、方便的暂存区域和 多个工作流等功能。</p><p>其功能：</p><ul><li>记录代码的变更(记录开发过程的变更和进程)</li><li>实现多人协作(多人的代码进行合并)</li></ul><h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p>版本控制是一种记录一个或若干文件内容变化，以便将来查阅特定版本修订情况的系统</p><p>可以将选定的文件回溯到之前的状态，甚至将整个项目都回退到过去某个时间点的状态，你可以比较文件的变化细节，查出最后是谁修改了哪个地方，从而找出导致怪异问题出现的原因，又是谁在何时报告了某个功能缺陷等等。 使用版本控制系统通常还意味着，就算你乱来一气把整个项目中的文件改的改删的删，你也照样可以轻松恢复到原先的样子。 但额外增加的工作量却微乎其微</p><p><strong>从个人开发过渡到团队协作的</strong></p><h3 id="本地版本控制"><a href="#本地版本控制" class="headerlink" title="本地版本控制"></a>本地版本控制</h3><p>复制整个项目目录的方式来保存不同的版本，并改名加上备份时间以示区别，有时候会混淆所在的工作目录，一不小心会写错文件或者覆盖意想外的文件。</p><p>为了解决这个问题，人们很久以前就开发了许多种本地版本控制系统，大多都是采用某种简单的数据库来记录文件的历次更新差异。</p><p><img src="/archives/a13195e8/local.png" alt="本地版本控制图解"></p><h3 id="集中式版本控制"><a href="#集中式版本控制" class="headerlink" title="集中式版本控制"></a>集中式版本控制</h3><p>如何让在不同系统上的开发者协同工作？ 于是，集中化的版本控制系统（Centralized Version Control Systems，简称 CVCS）应运而生。 这类系统，诸如 CVS、Subversion 以及 Perforce 等，都有一个单一的集中管理的服务器，保存所有文件的修订版本，而协同工作的人们都通过客户端连到这台服务器，取出最新的文件或者提交更新。 多年以来，这已成为版本控制系统的标准做法。</p><p><img src="/archives/a13195e8/centralized.png" alt="集中化的版本控制图解"></p><p>这种做法带来了许多好处，特别是相较于老式的本地 VCS 来说。 现在，每个人都可以在一定程度上看到项目中的其他人正在做些什么。 而管理员也可以轻松掌控每个开发者的权限，并且管理一个 CVCS 要远比在各个客户端上维护本地数据库来得轻松容易。</p><p>事分两面，有好有坏。 这么做最显而易见的缺点是中央服务器的<strong>单点故障</strong>。 如果宕机一小时，那么在这一小时内，谁都无法提交更新，也就无法协同工作。 <strong>如果中心数据库所在的磁盘发生损坏，又没有做恰当备份，毫无疑问你将丢失所有数据</strong>——包括项目的整个变更历史，只剩下人们在各自机器上保留的单独快照。 本地版本控制系统也存在类似问题，只要整个项目的历史记录被保存在单一位置，就有丢失所有历史更新记录的风险。</p><h3 id="分布式版本控制"><a href="#分布式版本控制" class="headerlink" title="分布式版本控制"></a>分布式版本控制</h3><p>客户端并不只提取最新版本的文件快照， 而是把代码仓库完整地镜像下来，包括完整的历史记录。 这么一来，任何一处协同工作用的服务器发生故障，事后都可以用任何一个镜像出来的本地仓库恢复。 因为每一次的克隆操作，实际上都是一次对代码仓库的完整备份。</p><p><img src="/archives/a13195e8/distributed.png" alt="分布式版本控制图解"></p><p>许多这类系统都可以指定和若干不同的远端代码仓库进行交互。籍此，你就可以在同一个项目中，分别和不同工作小组的人相互协作。 你可以根据需要设定不同的协作流程，比如层次模型式的工作流，而这在以前的集中式系统中是无法实现的。</p><ul><li>服务器断网的情况下也可以进行开发（版本控制是在本地进行的）</li><li>每个客户端保存的也都说完整的项目（包含历史记录，更加安全）</li></ul><h1 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h1><h2 id="用户签名"><a href="#用户签名" class="headerlink" title="用户签名"></a>用户签名</h2><p>签名的作用是区分不同操作者的身份。用户的签名信息在每一个版本的提交信息中能够看到，以此确认此次提交是谁做的。Git首次安装需要设置用户签名，否则无法提交代码(和代码托管中心的账号没有关系)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置用户名</span></span><br><span class="line">git config --global user.name 用户名</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置邮箱</span></span><br><span class="line">git config --global user.email 邮箱</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出Git当前能找到的配置</span></span><br><span class="line">git config --list</span><br></pre></td></tr></table></figure><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>一个项目只需要初始化一次本地库即可，可通过项目目录查看是否有.git目录来辨别是否初始化过</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git init -h</span></span><br><span class="line">用法：git init [-q | --quiet] [--bare] [--template=&lt;template-directory&gt;] [--shared[=&lt;permissions&gt;]] [&lt;directory&gt;]</span><br><span class="line"></span><br><span class="line">     --template &lt;模板目录&gt;</span><br><span class="line">                           将使用模板的目录</span><br><span class="line">     --bare 创建一个裸仓库</span><br><span class="line">     --shared[=&lt;权限&gt;]</span><br><span class="line">                           指定 git 存储库将在多个用户之间共享</span><br><span class="line">     -q, --quiet 安静</span><br><span class="line">     --separate-git-dir &lt;gitdir&gt;</span><br><span class="line">                           将 git 目录与工作树分开</span><br><span class="line">     -b, --initial-branch &lt;名称&gt;</span><br><span class="line">                           覆盖初始分支的名称</span><br><span class="line">     --object-format &lt;哈希&gt;</span><br><span class="line">                           指定要使用的哈希算法</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不指定即当前目录</span></span><br></pre></td></tr></table></figure><h2 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h2><p>通过查看状态对文件进行检查是否提交，如果文件没有进行提交，则不允许进行下一步操作包括创建分支、拉取代码、切换分支等等。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git status -h</span></span><br><span class="line">用法：git status [&lt;options&gt;] [--] &lt;pathspec&gt;...</span><br><span class="line"></span><br><span class="line">    -v, --verbose 详细</span><br><span class="line">    -s, --short 简明地显示状态</span><br><span class="line">    -b, --branch 显示分支信息</span><br><span class="line">    --show-stash 显示存储信息</span><br><span class="line">    --ahead-behind 计算完整的提前/落后值</span><br><span class="line">    --porcelain[=&lt;版本&gt;]</span><br><span class="line">                          机器可读的输出</span><br><span class="line">    --long 以长格式显示状态（默认）</span><br><span class="line">    -z, --null 以 NUL 终止条目</span><br><span class="line">    -u, --untracked-files[=&lt;模式&gt;]</span><br><span class="line">                          显示未跟踪的文件，可选模式：全部、正常、否。 （默认：全部）</span><br><span class="line">    --ignored[=&lt;mode&gt;] 显示被忽略的文件，可选模式：传统、匹配、否。 （默认：传统）</span><br><span class="line">    --ignore-submodules[=&lt;何时&gt;]</span><br><span class="line">                          忽略对子模块的更改，可选时：全部、脏、未跟踪。 （默认：全部）</span><br><span class="line">    --column[=&lt;style&gt;] 按列列出未跟踪的文件</span><br><span class="line">    --no-renames 不检测重命名</span><br><span class="line">    -M, --find-renames[=&lt;n&gt;]</span><br><span class="line">                          检测重命名，可选择设置相似度索引</span><br><span class="line">    --no-lock-index （已弃用：使用 `git --no-optional-locks status` 代替）不要锁定索引</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git status</span></span><br><span class="line">在主分支</span><br><span class="line"></span><br><span class="line">还没有提交</span><br><span class="line"></span><br><span class="line">无需提交（创建/复制文件并使用“git add”进行跟踪）</span><br></pre></td></tr></table></figure><h2 id="添加命令"><a href="#添加命令" class="headerlink" title="添加命令"></a>添加命令</h2><p>将工作区变更的文件提交至暂存区</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add -h</span></span><br><span class="line">用法： git add [&lt;options&gt;] [--] &lt;pathspec&gt;...</span><br><span class="line"></span><br><span class="line">    -n, --dry-run 试运行</span><br><span class="line">    -v, --verbose 详细</span><br><span class="line"></span><br><span class="line">    -i, --interactive 交互式拾取</span><br><span class="line">    -p, --patch 以交互方式选择帅哥</span><br><span class="line">    -e, --edit 编辑当前差异并应用</span><br><span class="line">    -f, --force 允许添加其他被忽略的文件</span><br><span class="line">    -u, --update 更新跟踪的文件</span><br><span class="line">    --renormalize 重新规范化跟踪文件的 EOL（隐含 -u）</span><br><span class="line">    -N, --intent-to-add 只记录后面要添加的路径</span><br><span class="line">    -A, --all 添加所有已跟踪和未跟踪文件的更改</span><br><span class="line">    --ignore-removal 忽略工作树中删除的路径（与 --no-all 相同）</span><br><span class="line">    --refresh 不添加，只刷新索引</span><br><span class="line">    --ignore-errors 只是跳过由于错误而无法添加的文件</span><br><span class="line">    --ignore-missing 检查是否 - 甚至丢失 - 文件在试运行中被忽略</span><br><span class="line">    --sparse 允许更新稀疏结帐锥之外的条目</span><br><span class="line">    --chmod (+|-)x 覆盖列出文件的可执行位</span><br><span class="line">    --pathspec-from-file &lt;文件&gt;</span><br><span class="line">                          从文件中读取路径规范</span><br><span class="line">    --pathspec-file-nul 和 --pathspec-from-file，pathspec 元素用 NUL 字符分隔</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add 1.txt</span></span><br><span class="line">warning: in the working copy of &#x27;1.txt&#x27;, LF will be replaced by CRLF the next time Git touches it</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对换行符进行转换</span></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git status</span></span><br><span class="line">On branch master</span><br><span class="line"></span><br><span class="line">No commits yet</span><br><span class="line"></span><br><span class="line">Changes to be committed:</span><br><span class="line">  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</span><br><span class="line">        new file:   1.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="删除命令"><a href="#删除命令" class="headerlink" title="删除命令"></a>删除命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">rm</span> -h</span></span><br><span class="line">用法： git rm [&lt;options&gt;] [--] &lt;file&gt;...</span><br><span class="line"></span><br><span class="line">     -n, --dry-run 试运行</span><br><span class="line">     -q, --quiet 不列出删除的文件</span><br><span class="line">     --cached 仅从索引中删除</span><br><span class="line">     -f, --force 覆盖最新检查</span><br><span class="line">     -r 允许递归删除</span><br><span class="line">     --ignore-unmatch 即使没有匹配项也以零状态退出</span><br><span class="line">     --sparse 允许更新稀疏结帐锥之外的条目</span><br><span class="line">     --pathspec-from-file &lt;文件&gt;</span><br><span class="line">                           从文件中读取路径规范</span><br><span class="line">     --pathspec-file-nul 和 --pathspec-from-file，pathspec 元素用 NUL 字符分隔</span><br></pre></td></tr></table></figure><h2 id="提交命令"><a href="#提交命令" class="headerlink" title="提交命令"></a>提交命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -h</span></span><br><span class="line">用法：git commit [&lt;options&gt;] [--] &lt;pathspec&gt;...</span><br><span class="line"></span><br><span class="line">    -q, --quiet 成功提交后抑制摘要</span><br><span class="line">    -v, --verbose 在提交消息模板中显示差异</span><br><span class="line"></span><br><span class="line">Commit message options</span><br><span class="line">    -F, --file &lt;file&gt; 从文件中读取消息</span><br><span class="line">    --author &lt;author&gt; 覆盖提交的作者</span><br><span class="line">    --date &lt;date&gt; 覆盖提交的日期</span><br><span class="line">    -m, --message &lt;消息&gt;</span><br><span class="line">                          提交信息</span><br><span class="line">    -c, --reedit-message &lt;提交&gt;</span><br><span class="line">                          重用和编辑来自指定提交的消息</span><br><span class="line">    -C, --reuse-message &lt;提交&gt;</span><br><span class="line">                          重用来自指定提交的消息</span><br><span class="line">    --fixup [(修正|reword):]提交</span><br><span class="line">                          使用 autosquash 格式的消息来修复或修改/改写指定的提交</span><br><span class="line">    --squash &lt;commit&gt; 使用自动压缩格式的消息来压缩指定的提交</span><br><span class="line">    --reset-author 提交现在由我创作（与 -C/-c/--amend 一起使用）</span><br><span class="line">    --trailer &lt;trailer&gt; 添加自定义预告片</span><br><span class="line">    -s, --signoff 添加一个 Signed-off-by 预告片</span><br><span class="line">    -t, --template &lt;文件&gt;</span><br><span class="line">                          使用指定的模板文件</span><br><span class="line">    -e, --edit 强制编辑提交</span><br><span class="line">    --cleanup &lt;mode&gt; 如何去除消息中的空格和#comments</span><br><span class="line">    --status 在提交消息模板中包含状态</span><br><span class="line">    -S, --gpg-sign[=&lt;key-id&gt;]</span><br><span class="line">                          GPG 签署提交</span><br><span class="line"></span><br><span class="line">Commit contents options</span><br><span class="line">    -a, --all 提交所有更改的文件</span><br><span class="line">    -i, --include 将指定文件添加到索引以进行提交</span><br><span class="line">    --interactive 交互式添加文件</span><br><span class="line">    -p, --patch 以交互方式添加更改</span><br><span class="line">    -o, --only 只提交指定的文件</span><br><span class="line">    -n, --no-verify 绕过 pre-commit 和 commit-msg 钩子</span><br><span class="line">    --dry-run 显示将要提交的内容</span><br><span class="line">    --short 简明扼要地显示状态</span><br><span class="line">    --branch 显示分支信息</span><br><span class="line">    --ahead-behind 计算完整的提前/落后值</span><br><span class="line">    --porcelain 机器可读输出</span><br><span class="line">    --long 以长格式显示状态（默认）</span><br><span class="line">    -z, --null 以 NUL 终止条目</span><br><span class="line">    --amend 修改之前的提交</span><br><span class="line">    --no-post-rewrite 绕过 post-rewrite 钩子</span><br><span class="line">    -u, --untracked-files[=&lt;模式&gt;]</span><br><span class="line">                          显示未跟踪的文件，可选模式：全部、正常、否。 （默认：全部）</span><br><span class="line">    --pathspec-from-file &lt;文件&gt;</span><br><span class="line">                          从文件中读取路径规范</span><br><span class="line">    --pathspec-file-nul 和 --pathspec-from-file，pathspec 元素用 NUL 字符分隔</span><br></pre></td></tr></table></figure><h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">log</span> -h</span></span><br><span class="line">用法：git log [&lt;options&gt;] [&lt;revision-range&gt;] [[--] &lt;path&gt;...]</span><br><span class="line">    或： git show [&lt;options&gt;] &lt;object&gt;...</span><br><span class="line"></span><br><span class="line">     -q, --quiet 抑制差异输出</span><br><span class="line">     --source 显示源</span><br><span class="line">     --use-mailmap 使用邮件映射文件</span><br><span class="line">     --mailmap 别名 --use-mailmap</span><br><span class="line">     --decorate-refs &lt;模式&gt;</span><br><span class="line">                           只装饰匹配 &lt;pattern&gt; 的 refs</span><br><span class="line">     --decorate-refs-exclude &lt;模式&gt;</span><br><span class="line">                           不要装饰匹配 &lt;pattern&gt; 的 refs</span><br><span class="line">     --decorate[=...] 装饰选项</span><br><span class="line">     -L &lt;range:file&gt; 跟踪行范围 &lt;start&gt;,&lt;end&gt; 或 function :&lt;funcname&gt; in &lt;file&gt; 的演变</span><br></pre></td></tr></table></figure><h2 id="版本穿梭"><a href="#版本穿梭" class="headerlink" title="版本穿梭"></a>版本穿梭</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git reflog 查看版本信息</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git <span class="built_in">log</span> 查看版本详细信息</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset -h</span></span><br><span class="line">用法：git reset [--mixed | --软 | --硬 | --合并 | --keep] [-q] [&lt;提交&gt;]</span><br><span class="line">   或： git reset [-q] [&lt;tree-ish&gt;] [--] &lt;pathspec&gt;...</span><br><span class="line">   或： git reset [-q] [--pathspec-from-file [--pathspec-file-nul]] [&lt;tree-ish&gt;]</span><br><span class="line">   或： git reset --patch [&lt;tree-ish&gt;] [--] [&lt;pathspec&gt;...]</span><br><span class="line">   或：已弃用：git reset [-q] [--stdin [-z]] [&lt;tree-ish&gt;]</span><br><span class="line"></span><br><span class="line">    -q, --quiet 安静，只报告错误</span><br><span class="line">    --no-refresh 重置后跳过刷新索引</span><br><span class="line">    --mixed 重置 HEAD 和索引</span><br><span class="line">    --soft reset only HEAD</span><br><span class="line">    --hard reset HEAD、索引和工作树</span><br><span class="line">    --merge 重置 HEAD、索引和工作树</span><br><span class="line">    --keep reset HEAD 但保留本地更改</span><br><span class="line">    --recurse-submodules[=&lt;重置&gt;]</span><br><span class="line">                          控制子模块的递归更新</span><br><span class="line">    -p, --patch 以交互方式选择帅哥</span><br><span class="line">    -N, --intent-to-add 仅记录删除的路径将在以后添加的事实</span><br><span class="line">    --pathspec-from-file &lt;文件&gt;</span><br><span class="line">                          从文件中读取路径规范</span><br><span class="line">    --pathspec-file-nul 和 --pathspec-from-file，pathspec 元素用 NUL 字符分隔</span><br><span class="line">    -z 已弃用（使用 --pathspec-file-nul 代替）：路径用 NUL 字符分隔</span><br><span class="line">    --stdin 已弃用（使用 --pathspec-from-file=- 代替）：从 &lt;stdin&gt; 读取路径</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定文件回到某个版本</span></span><br><span class="line">git checkout 版本号 文件名</span><br></pre></td></tr></table></figure><h1 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h1><h2 id="分支概述"><a href="#分支概述" class="headerlink" title="分支概述"></a>分支概述</h2><p>使用分支意味着你可以把你的工作从开发主线上分离开来，以免影响开发主线。最简单的可以理解为副本</p><p>使用分支可以并行推进多个功能的开发，提高开发效率；例如某分支在开发的过程中出现Bug，不会对其他分支有影响；失败的分支可以删除重新开始</p><h2 id="查看分支"><a href="#查看分支" class="headerlink" title="查看分支"></a>查看分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git branch -v</span><br><span class="line"></span><br><span class="line">git branch</span><br></pre></td></tr></table></figure><h2 id="创建分支"><a href="#创建分支" class="headerlink" title="创建分支"></a>创建分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch 分支名</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch -v</span></span><br><span class="line">* master 96bceab there modify</span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch</span></span><br><span class="line">* master</span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch hot-fix</span></span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch</span></span><br><span class="line">  hot-fix</span><br><span class="line">* master</span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br></pre></td></tr></table></figure><h2 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout 分支名</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch hot-fix</span></span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch</span></span><br><span class="line">  hot-fix</span><br><span class="line">* master</span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (master)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout hot-fix</span></span><br><span class="line">Switched to branch &#x27;hot-fix&#x27;</span><br><span class="line"></span><br><span class="line">Tao@DESKTOP-41ETPE3 MINGW64 /e/code (hot-fix)</span><br></pre></td></tr></table></figure><h2 id="合并分支"><a href="#合并分支" class="headerlink" title="合并分支"></a>合并分支</h2><p>1.正常合并</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git merge 分支名</span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意如果要将分支合并到Master需切换到master在合并</span></span><br></pre></td></tr></table></figure><p> 2.冲突合并</p><p>在合并分支时，两个分支在同一个文件的同一个位置有两条完全不相同的修改。Git无法替我们决定使用哪一个。必须人为决定代码内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在手动合并之后会报错</span><br><span class="line">需要手动修改文件确认需要合并的代码</span><br><span class="line">之后手动添加到暂存区提交本地库</span><br><span class="line">之后合并不需要指定文件名提交</span><br></pre></td></tr></table></figure><h1 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h1><h2 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">别名用于代替远程代码托管中心的连接</span></span><br><span class="line">git remote add xiaowangc https://github.com/qq780312916/xiaowangc.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">例如将我的github地址取了一个别名叫做xiaowangc</span></span><br></pre></td></tr></table></figure><h2 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push 别名 分支</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push xiaowangc master</span></span><br><span class="line">warning: ----------------- SECURITY WARNING ----------------</span><br><span class="line">warning: | TLS certificate verification has been disabled! |</span><br><span class="line">warning: ---------------------------------------------------</span><br><span class="line">warning: HTTPS connections may not be secure. See https://aka.ms/gcm/tlsverify for more information.</span><br><span class="line">warning: ----------------- SECURITY WARNING ----------------</span><br><span class="line">warning: | TLS certificate verification has been disabled! |</span><br><span class="line">warning: ---------------------------------------------------</span><br><span class="line">warning: HTTPS connections may not be secure. See https://aka.ms/gcm/tlsverify for more information.</span><br><span class="line">Enumerating objects: 13, done.</span><br><span class="line">Counting objects: 100% (13/13), done.</span><br><span class="line">Delta compression using up to 16 threads</span><br><span class="line">Compressing objects: 100% (7/7), done.</span><br><span class="line">Writing objects: 100% (13/13), 999 bytes | 999.00 KiB/s, done.</span><br><span class="line">Total 13 (delta 0), reused 0 (delta 0), pack-reused 0</span><br><span class="line">To https://github.com/qq780312916/xiaowangc.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br></pre></td></tr></table></figure><h2 id="拉取"><a href="#拉取" class="headerlink" title="拉取"></a>拉取</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> git pull xiaowangc master</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">存在两种情况</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将远程(新)代码同步至本地仓库</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在空仓库拉取到本地仓库，需先初始化git</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> git pull xiaowangc master</span></span><br><span class="line">remote: Enumerating objects: 5, done.</span><br><span class="line">remote: Counting objects: 100% (5/5), done.</span><br><span class="line">remote: Compressing objects: 100% (3/3), done.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0</span><br><span class="line">Unpacking objects: 100% (3/3), 689 bytes | 43.00 KiB/s, done.</span><br><span class="line">From https://github.com/qq780312916/xiaowangc</span><br><span class="line"> * branch            master     -&gt; FETCH_HEAD</span><br><span class="line">   9b571ca..0a29e5d  master     -&gt; xiaowangc/master</span><br><span class="line">Updating 9b571ca..0a29e5d</span><br><span class="line">Fast-forward</span><br><span class="line"> 2.txt | 1 +</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br></pre></td></tr></table></figure><h2 id="克隆"><a href="#克隆" class="headerlink" title="克隆"></a>克隆</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone 链接</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">clone</span>会进行代码的拉取、初始化本地仓库、创建别名</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/qq780312916/xiaowangc.git</span></span><br><span class="line">Cloning into &#x27;xiaowangc&#x27;...</span><br><span class="line">remote: Enumerating objects: 16, done.</span><br><span class="line">remote: Counting objects: 100% (16/16), done.</span><br><span class="line">remote: Compressing objects: 100% (10/10), done.</span><br><span class="line">remote: Total 16 (delta 1), reused 12 (delta 0), pack-reused 0</span><br><span class="line">Receiving objects: 100% (16/16), done.</span><br><span class="line">Resolving deltas: 100% (1/1), done.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus-Alertmanager</title>
      <link href="/archives/446ae31b.html"/>
      <url>/archives/446ae31b.html</url>
      
        <content type="html"><![CDATA[<h1 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h1><p>Prometheus发出告警时分为两部分。首先，Prometheus按告警规则（rule_files配置块）向alertmanager发送告警（即告警规则是在Prometheus上定义的）。然后由Alertmanager来管理这些告警，包括去重（Deduplicating）、分组（Grouping）、静音（Silencing）、抑制（Inhibition）、聚合（Aggregation），最终通过电子邮件、WebHook等方式告警通知对应的联系人</p><h1 id="安装Alertmanager"><a href="#安装Alertmanager" class="headerlink" title="安装Alertmanager"></a>安装Alertmanager</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xf alertmanager-0.24.0.linux-amd64.tar.gz</span><br><span class="line">mv alertmanager-0.24.0.linux-amd64 /usr/local/</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span> <span class="string">alertmanager</span>]<span class="comment"># cat alertmanager.yml</span></span><br><span class="line"><span class="attr">route:</span><span class="comment"># 路由</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>]<span class="comment"># 分组聚合</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span><span class="comment"># 当新组被创建需等待多久才发送初始通知</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span><span class="comment"># </span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1h</span><span class="comment"># c</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&#x27;web.hook&#x27;</span></span><br><span class="line"><span class="attr">receivers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;web.hook&#x27;</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://127.0.0.1:5001/&#x27;</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    <span class="attr">equal:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br></pre></td></tr></table></figure><h1 id="修改Prometheus配置，对Alertmanager进行关联，同时添加监控"><a href="#修改Prometheus配置，对Alertmanager进行关联，同时添加监控" class="headerlink" title="修改Prometheus配置，对Alertmanager进行关联，同时添加监控"></a>修改Prometheus配置，对Alertmanager进行关联，同时添加监控</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">5s</span> <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">5s</span> <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">172.25</span><span class="number">.250</span><span class="number">.5</span><span class="string">:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it&#x27;s Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">xiaowangc</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;node&quot;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;172.25.250.9:9100&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">node01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;172.25.250.6:9100&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">node02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;172.25.250.7:9100&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">node03</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;alermanager&quot;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;172.25.250.5:9093&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">alermanager</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记录规则 first_rules.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node_rules</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">node_cpu</span><span class="comment"># 时间序列名称</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="number">100</span><span class="string">-avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[1m]))by(app)*100</span><span class="comment"># 查询表达式</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">metrice_type:</span> <span class="string">cpu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">load1m_monitor</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">node_load1</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">metrice_type:</span> <span class="string">load1m_monitor</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">node_mem</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="number">100</span><span class="string">-(node_memory_Active_bytes/node_memory_MemTotal_bytes)*100</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">metrice_type:</span> <span class="string">node_mem</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 报警规则 second_rules.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node_alerts</span></span><br><span class="line">    <span class="attr">rules:</span><span class="comment"># 规则</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">node_cpu</span><span class="comment"># 关联记录规则的时间序列名称</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">node_cpu</span> <span class="string">&gt;</span> <span class="number">80</span><span class="comment"># 值大于80</span></span><br><span class="line">      <span class="attr">for:</span> <span class="string">1m</span><span class="comment"># 持续时间</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">      <span class="attr">annotations:</span><span class="comment"># 提示信息</span></span><br><span class="line">        <span class="attr">summary:</span> <span class="string">主机</span> &#123;&#123; <span class="string">$labels.app</span> &#125;&#125; <span class="string">的CPU使用率持续1分钟超出阈值，当前为&#123;&#123;</span> <span class="string">$value</span> <span class="string">&#125;&#125;</span> <span class="string">%</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">load1m_monitor</span> <span class="string">&gt;</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">summary:</span> <span class="string">主机</span> &#123;&#123; <span class="string">$labels.app</span>&#125;&#125; <span class="string">CPU1分钟负载阈值超出当前为&#123;&#123;$value&#125;&#125;%</span></span><br></pre></td></tr></table></figure><p>可选for子句使 Prometheus 在第一次遇到新的表达式输出向量元素和将警报计数为针对该元素触发之间等待一定的持续时间。在这种情况下，Prometheus 将在每次评估期间检查警报是否继续处于活动状态 10 分钟，然后再触发警报。处于活动状态但尚未触发的元素处于挂起状态。</p><p>该labels子句允许指定一组附加标签附加到警报。任何现有的冲突标签都将被覆盖。标签值可以模板化。</p><p>该annotations子句指定一组信息标签，可用于存储更长的附加信息，例如警报描述或运行手册链接。注释值可以被模板化。</p>]]></content>
      
      
      <categories>
          
          <category> 监控 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> 监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus-查询</title>
      <link href="/archives/762f83eb.html"/>
      <url>/archives/762f83eb.html</url>
      
        <content type="html"><![CDATA[<h1 id="度量类型"><a href="#度量类型" class="headerlink" title="度量类型"></a>度量类型</h1><p><strong>Prometheus 支持四种类型的指标，它们是 - Counter - Gauge - Histogram - Summary</strong></p><ol><li><p>Counter(计数器类型)</p><p>计数器是一个只能增加或重置的度量值，即该值不能比之前的值减少。它可用于请求数量、错误数量等指标。</p><p>不是Counter类型的度量却当作Counter类型计算，会得到一个错误的结果。例如，使用计数器来计算当前正在运行的进程的数量；应该使用Gauge</p><p><img src="/archives/762f83eb/counter_example.png" alt="counter_example"></p></li><li><p>Gauge(仪表测量类型）</p><p>Gauge是一个可以上升或下降的数字。它可用于衡量指标，例如集群中的 pod 数量、队列中的事件数量等。</p><p><img src="/archives/762f83eb/gauge_example.png" alt="gauge_example"></p></li><li><p>Histogram(直方图类型)</p><p>Histogram是对数据进行采样的指标类型，用来展示数据集的频率分布。Histogram是表示数值分布的图形，它将数值分组到一个一个的bucket当中，然后计算每个bucket中值出现的次数。在Histogram上，X轴表示数值的范围，Y轴表示该对应数值出现的频次</p></li><li><p>Summary(摘要类型)</p><p>Summary和Histogram类似，主要也是用于表示一段时间内数据采样结果，它直接存储了quantile(分位图)数据，而不是根据统计区间计算出来的</p></li></ol><h1 id="查询语法"><a href="#查询语法" class="headerlink" title="查询语法"></a>查询语法</h1><p>Prometheus 提供了一种称为 PromQL（Prometheus Query Language）的功能性查询语言，让用户可以实时选择和聚合时间序列数据。表达式的结果既可以显示为图形，也可以在 Prometheus 的表达式浏览器中以表格数据的形式显示，或者由外部系统通过HTTP API 使用。</p><p>在Prometheus的表达式语言中，表达式或者子表达式可以计算为以下四种类型之一</p><ol><li>瞬时向量</li><li>范围向量</li><li>数量</li><li>String</li></ol><p>时间序列选择器：</p><ol><li><p>瞬时矢量选择器</p><p>瞬时矢量选择器可以即时为每个度量选择一个样本值，最简单的形式就是给度量名称，这样将返回所有包含此度量名称的时间序列元素的瞬时向量。可以通过{}大括号中附加逗号的标签匹配器列表来进一步筛选这些时间序列</p><ul><li>&#x3D;(等于)：选择与提供的字符串完全相等的标签。</li><li>！&#x3D;(不等于)：选择不等于提供的字符串的标签。</li><li>&#x3D;~(模糊匹配)：选择与提供的字符串进行正则表达式匹配的标签。</li><li>!~(模糊匹配取反)：选择与提供的字符串不匹配的标签。</li></ul></li><li><p>范围矢量选择器</p><p>范围向量字面量的工作方式类似于瞬时向量字面量，只是它们从当前时刻选择一系列样本</p></li><li><p>偏移修饰器</p><p>该<code>offset</code>修饰符允许更改查询中各个瞬间和范围向量的时间偏移量。</p></li></ol><h1 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h1><p>官网：<a href="https://prometheus.io/docs/prometheus/latest/querying/functions/">https://prometheus.io/docs/prometheus/latest/querying/functions/</a></p><ol><li><p>increase()函数，该函数结合counter数据类型使用，获取区间向量中的第一个和最后一个样本并返回其增长量。如果除以时间就可以获得该时间内的平均增长值</p></li><li><p>rate()函数，该函数配置counter数据类型使用，用于获取时间段内的平均每秒增量</p><p>通过rate函数获取在1分钟内网卡每秒接收字节数：</p><p>rate(node_network_receive_bytes_total {app&#x3D;”app01”,device&#x3D;”ens33”}[1m])</p></li><li><p>irate()函数，用于计算指定时间范围内每秒瞬时增长率，是基于该时间范围内最后两个点来计算。rate取指定时间范围的所有值，算出一组速率，然后取平均值</p></li><li><p>sum()函数，实际工作中CPU大多数是多核心，而node_cpu_seconds_total会将每个核的数据单独显示出来，因此可以使用sum()函数求和之后得出百分比之和</p><p>sum(increase(node_cpu_seconds_total {app&#x3D;”node01“,mode&#x3D;”user”}[1m])&#x2F;60)</p></li><li><p>count()函数，该函数用于统计或用来做一些模糊判断。</p><p>统计当前TCP连接是否大于200</p><p>count(node_netstat_tcp_currestab {app&#x3D;”node01”} &gt; 200 )</p></li><li><p>topk()函数，该函数从大量数据中取出排行前N的数值。</p><p>例如从所有主机中找出近5分钟网卡流量排名前3的主机(Counter类型数据)</p><p>topk(3,rate(node_network_receive_bytes_total {device&#x3D;”ens33”}[3m]))</p></li><li><p>predict_linear()函数，根据前一个时间段的值来预测未来某个时间点数据的走势</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 监控 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> 监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus-NodeExport</title>
      <link href="/archives/dc8c870.html"/>
      <url>/archives/dc8c870.html</url>
      
        <content type="html"><![CDATA[<h1 id="node-exporter安装"><a href="#node-exporter安装" class="headerlink" title="node_exporter安装"></a>node_exporter安装</h1><p>node_exporter安装非常简单，只需要解压后台运行即可，默认端口：9100</p><p>官方下载地址：<a href="https://prometheus.io/download/">https://prometheus.io/download/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.36.1/prometheus-2.36.1.linux-amd64.tar.gz</span><br><span class="line">tar xf prometheus-2.36.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv prometheus-2.36.1.linux-amd64 /usr/loca/node</span><br><span class="line"></span><br><span class="line">restorecon -Rv /usr/loca/node</span><br><span class="line"></span><br><span class="line">tee &gt; /usr/lib/systemd/system/node.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/loca/node/node_exporter \</span><br><span class="line">--collector.systemd \</span><br><span class="line">--collector.systemd.unit-whitelist=&quot;(ssh|docker).service&quot;</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl enable --now node.service</span><br></pre></td></tr></table></figure><h1 id="启动说明"><a href="#启动说明" class="headerlink" title="启动说明"></a>启动说明</h1><ol><li><p>启用systemd收集器</p><p>systemd收集器记录systemd中服务和系统状态。需要通过参数–collector.systemd启动该收集器；</p></li><li><p>指定textfile收集器目录</p><p>textfile收集器可以让用户添加自定义的度量指标，功能类似pushgateway，同zabbix自定义的item一样，只要将度量指标和值按照Prometheus规范的格式输出到指定位置以.prom后缀文件保存，textfile收集器会自动读取collector.textfile.directory目录下所有以.prom结尾的文件，并提取所有格式为Prometheus的指标暴露给Prometheus抓取。</p><p>textfile收集器默认是开启的，我们只需要指定–collector.textfile.directory的路径即可</p><p><strong>例如</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控系统登录用户数</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;node_login_user <span class="subst">$(who | wc -l)</span>&quot;</span> &gt; /path/login_users.prom</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以定时任务的方式采集</span></span><br><span class="line">*/1 * * * * <span class="built_in">echo</span> <span class="string">&quot;login_users <span class="subst">$(who | wc -l)</span>&quot;</span> &gt; /path/login_users.prom</span><br></pre></td></tr></table></figure></li><li><p>启动或禁用收集器</p><p>通过.&#x2F;node_exporter -h 命令，可以看到默认启动了哪些收集器，若要禁用某个收集器，如：–collector.ntp，可以修改为–no-collector.ntp，即禁用该收集器</p></li><li><p>只添加指定的收集器</p><p>node_exporter等各种收集器默认会收集非常多的指标数据，有很多并非我们所需要的，是可以不收集的，除了在node_exporter启动时指定禁用某些收集器之外，也可以在Prometheus的配置文件中的scrape_config配置块下指定只收集哪些指标</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">params:</span></span><br><span class="line">  <span class="string">collect[]:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">foo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bar</span></span><br></pre></td></tr></table></figure><p>使用场景：</p><p>在清楚每一个收集器的用途之后再使用该方法，推荐默认收集所有数据，然后过滤不需要的收集器</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">用法：node_exporter [&lt;flags&gt;]</span><br><span class="line"></span><br><span class="line">标志：</span><br><span class="line">  -h, --<span class="built_in">help</span> 显示上下文相关帮助（也可以试试 --help-long 和 --help-man）。</span><br><span class="line">      --collector.bcache.priorityStats</span><br><span class="line">                                 公开昂贵的优先级统计数据。</span><br><span class="line">      --collector.cpu.guest 启用指标 node_cpu_guest_seconds_total</span><br><span class="line">      --collector.cpu.info 启用度量 cpu_info</span><br><span class="line">      --collector.cpu.info.flags-include=COLLECTOR.CPU.INFO.FLAGS-INCLUDE</span><br><span class="line">                                 使用必须是正则表达式的值过滤 cpuInfo 中的 `flags` 字段</span><br><span class="line">      --collector.cpu.info.bugs-include=COLLECTOR.CPU.INFO.BUGS-INCLUDE</span><br><span class="line">                                 使用必须是正则表达式的值过滤 cpuInfo 中的 `bugs` 字段</span><br><span class="line">      --collector.diskstats.ignored-devices=<span class="string">&quot;^(ram|loop|fd|(h|s|v|xv)d[az]|nvme\\d+n\\d+p)\\d+$&quot;</span></span><br><span class="line">                                 diskstats 要忽略的设备的正则表达式。</span><br><span class="line">      --collector.ethtool.device-include=COLLECTOR.ETHTOOL.DEVICE-INCLUDE</span><br><span class="line">                                 要包含的 ethtool 设备的正则表达式（与设备排除互斥）。</span><br><span class="line">      --collector.ethtool.device-exclude=COLLECTOR.ETHTOOL.DEVICE-EXCLUDE</span><br><span class="line">                                 要排除的 ethtool 设备的正则表达式（与 device-include 互斥）。</span><br><span class="line">      --collector.ethtool.metrics-include=<span class="string">&quot;.*&quot;</span></span><br><span class="line">                                 要包含的 ethtool 统计信息的正则表达式。</span><br><span class="line">      --collector.filesystem.mount-points-exclude=<span class="string">&quot;^/(dev|proc|run/credentials/.+|sys|var/lib/docker/.+)($|/)&quot;</span></span><br><span class="line">                                 要为文件系统收集器排除的挂载点的正则表达式。</span><br><span class="line">      --collector.filesystem.fs-types-exclude=<span class="string">&quot;^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore| rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$&quot;</span></span><br><span class="line">                                 要为文件系统收集器排除的文件系统类型的正则表达式。</span><br><span class="line">      --collector.ipvs.backend-labels=<span class="string">&quot;local_address,local_port,remote_address,remote_port,proto,local_mark&quot;</span></span><br><span class="line">                                 IPVS 后端统计标签的逗号分隔列表。</span><br><span class="line">      --collector.netclass.ignored-devices=<span class="string">&quot;^$&quot;</span></span><br><span class="line">                                 网络类收集器要忽略的网络设备的正则表达式。</span><br><span class="line">      --collector.netclass.ignore-invalid-speed</span><br><span class="line">                                 忽略速度无效的设备。这将是 2.x 中的默认行为。</span><br><span class="line">      --collector.netdev.device-include=COLLECTOR.NETDEV.DEVICE-INCLUDE</span><br><span class="line">                                 要包含的网络设备的正则表达式（与设备排除互斥）。</span><br><span class="line">      --collector.netdev.device-exclude=COLLECTOR.NETDEV.DEVICE-EXCLUDE</span><br><span class="line">                                 要排除的网络设备的正则表达式（与设备包含互斥）。</span><br><span class="line">      --collector.netdev.address-info</span><br><span class="line">                                 收集每个设备的地址信息</span><br><span class="line">      --collector.netstat.fields=<span class="string">&quot;^(.*_(InErrors|InErrs)|Ip_Forwarding|Ip(6|Ext)_(InOctets|OutOctets)|Icmp6?_(InMsgs|OutMsgs)|TcpExt_(Listen.*| Syncookies.*|TCPSynRetrans|TCPTimeouts)|Tcp_(ActiveOpens|InSegs|OutSegs|OutRsts|PassiveOpens|RetransSegs|CurrEstab)|Udp6?_(InDatagrams|OutDatagrams|NoPorts|RcvbufErrors|SndbufErrors))$&quot;</span></span><br><span class="line">                                 为 netstat 收集器返回的字段正则表达式。</span><br><span class="line">      --collector.ntp.server=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                                 用于 ntp 收集器的 NTP 服务器</span><br><span class="line">      --collector.ntp.protocol-version=4</span><br><span class="line">                                 NTP协议版本</span><br><span class="line">      --collector.ntp.server-is-local</span><br><span class="line">                                 证明 collector.ntp.server 地址不是公共 ntp 服务器</span><br><span class="line">      --collector.ntp.ip-ttl=1 发送 NTP 查询时使用的 IP TTL</span><br><span class="line">      --collector.ntp.max-distance=3.46608s</span><br><span class="line">                                 到根的最大累积距离</span><br><span class="line">      --collector.ntp.local-offset-tolerance=1ms</span><br><span class="line">                                 本地时钟和本地 ntpd 时间之间允许的偏移量</span><br><span class="line">      --path.procfs=<span class="string">&quot;/proc&quot;</span> procfs 挂载点。</span><br><span class="line">      --path.sysfs=<span class="string">&quot;/sys&quot;</span> sysfs 挂载点。</span><br><span class="line">      --path.rootfs=<span class="string">&quot;/&quot;</span> rootfs 挂载点。</span><br><span class="line">      --collector.perf.cpus=<span class="string">&quot;&quot;</span> 应该从中收集性能指标的 CPU 列表</span><br><span class="line">      --collector.perf.tracepoint=COLLECTOR.PERF.TRACEPOINT ...</span><br><span class="line">                                 应该收集的性能跟踪点</span><br><span class="line">      --collector.powersupply.ignored-supplies=<span class="string">&quot;^$&quot;</span></span><br><span class="line">                                 powersupplyclass 收集器要忽略的电源正则表达式。</span><br><span class="line">      --collector.qdisc.fixtures=<span class="string">&quot;&quot;</span></span><br><span class="line">                                 用于 qdisc 收集器端到端测试的测试装置</span><br><span class="line">      --collector.runit.servicedir=<span class="string">&quot;/etc/service&quot;</span></span><br><span class="line">                                 runit 服务目录的路径。</span><br><span class="line">      --collector.supervisord.url=<span class="string">&quot;http://localhost:9001/RPC2&quot;</span></span><br><span class="line">                                 XML RPC 端点。</span><br><span class="line">      --collector.systemd.unit-include=<span class="string">&quot;.+&quot;</span></span><br><span class="line">                                 要包含的 systemd 单元的正则表达式。单元必须同时匹配 include 和不匹配 exclude 才能被包含。</span><br><span class="line">      --collector.systemd.unit-exclude=<span class="string">&quot;.+\\.(automount|device|mount|scope|slice)&quot;</span></span><br><span class="line">                                 要排除的 systemd 单位的正则表达式。单元必须同时匹配 include 和不匹配 exclude 才能被包含。</span><br><span class="line">      --collector.systemd.enable-task-metrics</span><br><span class="line">                                 启用服务单元任务指标 unit_tasks_current 和 unit_tasks_max</span><br><span class="line">      --collector.systemd.enable-restarts-metrics</span><br><span class="line">                                 启用服务单元指标 service_restart_total</span><br><span class="line">      --collector.systemd.enable-start-time-metrics</span><br><span class="line">                                 启用服务单元度量 unit_start_time_seconds</span><br><span class="line">      --collector.tapestats.ignored-devices=<span class="string">&quot;^$&quot;</span></span><br><span class="line">                                 Tapestats 要忽略的设备的正则表达式。</span><br><span class="line">      --collector.textfile.directory=<span class="string">&quot;&quot;</span></span><br><span class="line">                                 从中读取带有度量的文本文件的目录。</span><br><span class="line">      --collector.vmstat.fields=<span class="string">&quot;^(oom_kill|pgpg|pswp|pg.*fault).*&quot;</span></span><br><span class="line">                                 为 vmstat 收集器返回的字段正则表达式。</span><br><span class="line">      --collector.wifi.fixtures=<span class="string">&quot;&quot;</span></span><br><span class="line">                                 用于 wifi 收集器指标的测试装置</span><br><span class="line">      --collector.arp 启用 arp 收集器（默认：启用）。</span><br><span class="line">      --collector.bcache 启用 bcache 收集器（默认值：启用）。</span><br><span class="line">      --collector.bonding 启用绑定收集器（默认值：启用）。</span><br><span class="line">      --collector.btrfs 启用 btrfs 收集器（默认：启用）。</span><br><span class="line">      --collector.buddyinfo 启用 buddyinfo 收集器（默认：禁用）。</span><br><span class="line">      --collector.conntrack 启用 conntrack 收集器（默认：启用）。</span><br><span class="line">      --collector.cpu 启用 cpu 收集器（默认：启用）。</span><br><span class="line">      --collector.cpufreq 启用 cpufreq 收集器（默认：启用）。</span><br><span class="line">      --collector.diskstats 启用 diskstats 收集器（默认：启用）。</span><br><span class="line">      --collector.dmi 启用 dmi 收集器（默认：启用）。</span><br><span class="line">      --collector.drbd 启用 drbd 收集器（默认：禁用）。</span><br><span class="line">      --collector.drm 启用 drm 收集器（默认值：禁用）。</span><br><span class="line">      --collector.edac 启用 edac 收集器（默认值：启用）。</span><br><span class="line">      --collector.entropy 启用熵收集器（默认：启用）。</span><br><span class="line">      --collector.ethtool 启用 ethtool 收集器（默认：禁用）。</span><br><span class="line">      --collector.fiberchannel 启用光纤通道收集器（默认：启用）。</span><br><span class="line">      --collector.filefd 启用 filefd 收集器（默认：启用）。</span><br><span class="line">      --collector.filesystem 启用文件系统收集器（默认：启用）。</span><br><span class="line">      --collector.hwmon 启用 hwmon 收集器（默认值：启用）。</span><br><span class="line">      --collector.infiniband 启用 infiniband 收集器（默认：启用）。</span><br><span class="line">      --collector.interrupts 启用中断收集器（默认值：禁用）。</span><br><span class="line">      --collector.ipvs 启用 ipvs 收集器（默认：启用）。</span><br><span class="line">      --collector.ksmd 启用 ksmd 收集器（默认值：禁用）。</span><br><span class="line">      --collector.lnstat 启用 lnstat 收集器（默认值：禁用）。</span><br><span class="line">      --collector.loadavg 启用 loadavg 收集器（默认值：启用）。</span><br><span class="line">      --collector.logind 启用登录收集器（默认值：禁用）。</span><br><span class="line">      --collector.mdadm 启用 mdadm 收集器（默认：启用）。</span><br><span class="line">      --collector.meminfo 启用 meminfo 收集器（默认：启用）。</span><br><span class="line">      --collector.meminfo_numa 启用 meminfo_numa 收集器（默认：禁用）。</span><br><span class="line">      --collector.mountstats 启用 mountstats 收集器（默认：禁用）。</span><br><span class="line">      --collector.netclass 启用网络类收集器（默认：启用）。</span><br><span class="line">      --collector.netdev 启用 netdev 收集器（默认：启用）。</span><br><span class="line">      --collector.netstat 启用 netstat 收集器（默认：启用）。</span><br><span class="line">      --collector.network_route 启用 network_route 收集器（默认：禁用）。</span><br><span class="line">      --collector.nfs 启用 nfs 收集器（默认值：启用）。</span><br><span class="line">      --collector.nfsd 启用 nfsd 收集器（默认值：启用）。</span><br><span class="line">      --collector.ntp 启用 ntp 收集器（默认值：禁用）。</span><br><span class="line">      --collector.nvme 启用 nvme 收集器（默认值：启用）。</span><br><span class="line">      --collector.os 启用 os 收集器（默认：启用）。</span><br><span class="line">      --collector.perf 启用性能收集器（默认值：禁用）。</span><br><span class="line">      --collector.powersupply 类</span><br><span class="line">                                 启用 powersupplyclass 收集器（默认值：启用）。</span><br><span class="line">      --collector.pressure 启用压力收集器（默认：启用）。</span><br><span class="line">      --collector.processes 启用进程收集器（默认：禁用）。</span><br><span class="line">      --collector.qdisc 启用 qdisc 收集器（默认值：禁用）。</span><br><span class="line">      --collector.rapl 启用 rapl 收集器（默认：启用）。</span><br><span class="line">      --collector.runit 启用 runit 收集器（默认值：禁用）。</span><br><span class="line">      --collector.schedstat 启用 schedstat 收集器（默认：启用）。</span><br><span class="line">      --collector.sockstat 启用 sockstat 收集器（默认：启用）。</span><br><span class="line">      --collector.softnet 启用 softnet 收集器（默认值：启用）。</span><br><span class="line">      --collector.stat 启用统计收集器（默认：启用）。</span><br><span class="line">      --collector.supervisord 启用 supervisord 收集器（默认值：禁用）。</span><br><span class="line">      --collector.systemd 启用 systemd 收集器（默认：禁用）。</span><br><span class="line">      --collector.tapestats 启用tapestats 收集器（默认：启用）。</span><br><span class="line">      --collector.tcpstat 启用 tcpstat 收集器（默认值：禁用）。</span><br><span class="line">      --collector.textfile 启用文本文件收集器（默认：启用）。</span><br><span class="line">      --collector.thermal_zone 启用 thermo_zone 收集器（默认：启用）。</span><br><span class="line">      --collector.time 启用时间收集器（默认：启用）。</span><br><span class="line">      --collector.timex 启用 timex 收集器（默认：启用）。</span><br><span class="line">      --collector.udp_queues 启用 udp_queues 收集器（默认：启用）。</span><br><span class="line">      --collector.uname 启用 <span class="built_in">uname</span> 收集器（默认值：启用）。</span><br><span class="line">      --collector.vmstat 启用 vmstat 收集器（默认：启用）。</span><br><span class="line">      --collector.wifi 启用 wifi 收集器（默认：禁用）。</span><br><span class="line">      --collector.xfs 启用 xfs 收集器（默认值：启用）。</span><br><span class="line">      --collector.zfs 启用 zfs 收集器（默认：启用）。</span><br><span class="line">      --collector.zoneinfo 启用 zoneinfo 收集器（默认值：禁用）。</span><br><span class="line">      --web.listen-address=<span class="string">&quot;:9100&quot;</span></span><br><span class="line">                                 公开指标和 Web 界面的地址。</span><br><span class="line">      --web.telemetry-path=<span class="string">&quot;/metrics&quot;</span></span><br><span class="line">                                 公开指标的路径。</span><br><span class="line">      --web.disable-exporter-metrics</span><br><span class="line">                                 排除有关导出器本身的指标（promhttp_*、process_*、go_*）。</span><br><span class="line">      --web.max-requests=40 最大并行抓取请求数。使用 0 禁用。</span><br><span class="line">      --collector.disable-defaults</span><br><span class="line">                                 默认情况下将所有收集器设置为禁用。</span><br><span class="line">      --web.config=<span class="string">&quot;&quot;</span> [EXPERIMENTAL] 可以启用 TLS 或身份验证的配置 yaml 文件的路径。</span><br><span class="line">      --log.level=info 仅记录具有给定严重性或更高级别的消息。之一：[调试、信息、警告、错误]</span><br><span class="line">      --log.format=logfmt 日志消息的输出格式。之一：[logfmt，json]</span><br><span class="line">      --version 显示应用程序版本。</span><br></pre></td></tr></table></figure><h1 id="监控系统资源"><a href="#监控系统资源" class="headerlink" title="监控系统资源"></a>监控系统资源</h1><p>在Google SRE Handbook中提出了评估系统是否存在问题，用户体验是否受影响，用四个黄金信号来判断：</p><p>Latency（延迟）、Traffic（流量）、Errors（错误数）、Saturation（饱和度）</p><p>但在系统资源监控用的较多的方法是“USE”方法，分别为：Utilization（使用率）、Saturation（饱和度）、Errors（错误数）</p><ol><li><p>CPU使用率监控</p><p> (1-(avg(irate(node_cpu_seconds_total{app&#x3D;”node01”,mode&#x3D;”idle”}[5m])))) * 100</p></li><li><p>内存使用率监控</p><p>(node_memory_MemAvailable_bytes{app&#x3D;”node01”}&#x2F;node_memory_MemTotal_bytes{app&#x3D;”node01”})* 100</p></li><li><p>磁盘分区使用率监控</p><p>(1-(node_filesystem_avail_bytes{app&#x3D;”node01”,mountpoint&#x3D;”&#x2F;“}&#x2F;node_filesystem_size_bytes{app&#x3D;’node01’,mountpoint&#x3D;’&#x2F;‘}))*100</p></li><li><p>CPU饱和度监控</p><p>avg(node_load1{app&#x3D;”node01”})&#x2F;count(node_cpu_seconds_total{app&#x3D;”node01”,mode&#x3D;”system”})</p></li><li><p>内存饱和度监控</p><p>node_vmstat_pswpin：系统每秒从磁盘读到内存的字节数</p><p>node_vmstat_pswpout：系统每秒从内存写到磁盘的字节数</p></li><li><p>网卡接收&#x2F;发送流量监控</p><p>irate(node_network_receive_bytes_total{app&#x3D;”node01”,device&#x3D;”ens33”}[5m])*8</p><p>irate(node_network_transmit_bytes_total{app&#x3D;”node01”,device&#x3D;”ens33”}[5m])*8</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 监控 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> 监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus-基础</title>
      <link href="/archives/b87e9ddb.html"/>
      <url>/archives/b87e9ddb.html</url>
      
        <content type="html"><![CDATA[<h1 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h1><p>Prometheus是一个开源系统监控和警报工具包，最初在 SoundCloud构建。自 2012 年成立以来，许多公司和组织都采用了 Prometheus，该项目拥有非常活跃的开发者和用户社区。它现在是一个独立的开源项目，独立于任何公司维护。为了强调这一点，并明确项目的治理结构，Prometheus 于 2016 年加入 云原生计算基金会，成为继Kubernetes之后的第二个托管项目。</p><h1 id="Prometheus主要特点"><a href="#Prometheus主要特点" class="headerlink" title="Prometheus主要特点"></a>Prometheus主要特点</h1><ol><li>Prometheus使用的是度量(metric)名称和键&#x2F;值对标签(label)的时间序列数据，是一种多维的数据模型</li><li>PromQL是一种灵活的查询语言，可以利用度量(metric)名称和标签进行查询、聚合</li><li>不依赖于分布式存储，单个Prometheus服务也是自治理的</li><li>使用基于HTTP的拉(pull)模型进行时间序列的数据收集</li><li>同时也支持通过一个中间网关(pushgateway)来推送时间序列</li><li>目标对象(主机)是通过静态配置或者服务发现来添加的</li><li>支持多种图形模式和仪表盘</li></ol><h1 id="Prometheus组件"><a href="#Prometheus组件" class="headerlink" title="Prometheus组件"></a>Prometheus组件</h1><p>Prometheus目前已经是一个生态系统，具有众多的可选组件</p><ol><li>Prometheus Server本身用于抓取并存储时间序列数据</li><li>客户端程序库用于检测各种编程语言编写的程序代码</li><li>pushgateway用于支持短生命周期(short-lived)的作业(job)</li><li>可以针对不同的服务提供对应的导出器(exporters)用于采集度量对数，如HAproxy、MySQL等服务</li><li>用于告警的alertmanager组件</li><li>各种支持工具</li></ol><h1 id="Prometheus架构以及应用场景"><a href="#Prometheus架构以及应用场景" class="headerlink" title="Prometheus架构以及应用场景"></a>Prometheus架构以及应用场景</h1><p>此图说明了 Prometheus 的架构及其一些生态系统组件：</p><p><img src="/archives/b87e9ddb/architecture.png" alt="architecture"></p><p>Prometheus 从检测作业中直接或通过中间推送网关从短期作业中抓取指标。它在本地存储所有抓取的样本，并对这些数据运行规则，以从现有数据聚合和记录新的时间序列或生成警报。Grafana或其他 API 使用者可用于可视化收集的数据。</p><p>Prometheus 可以很好地记录任何纯数字时间序列。它既适合以机器为中心的监控，也适合监控高度动态的面向服务的架构。在微服务的世界中，它对多维数据收集和查询的支持是一个特殊的优势。Prometheus 专为可靠性而设计，是您在中断期间可以使用的系统，可让您快速诊断问题。每个 Prometheus 服务器都是独立的，不依赖于网络存储或其他远程服务。当您的基础设施的其他部分损坏时，您可以依赖它，并且您无需设置大量基础设施即可使用它。</p><p>Prometheus将其可以拉取指标的来源成为endpoint(端点)，endpoint可以是各种exporter(导出器)或者应用程序。然后，为了拉取endpoint里的数据，Prometheus定义了名为target(目标)的配置，告诉拉取时要如何进行连接等信息，多个具有相同功能角色的target组合在一起就构成了一个job(作业)。例如，具有相同用途的一组主机的资源监控器(node_exporter)，又或者是MySQL数据库监控器(mysqld_exporter)</p><p>Prometheus默认是将收集到的时间序列存储在本地TSDB数据库中，且默认只保留15天，也可以配置发送到其他时间序列数据库中。</p><h1 id="安装并配置Prometheus"><a href="#安装并配置Prometheus" class="headerlink" title="安装并配置Prometheus"></a>安装并配置Prometheus</h1><p>Prometheus官方下载地址：<a href="https://prometheus.io/download/">https://prometheus.io/download/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.36.1/prometheus-2.36.1.linux-amd64.tar.gz</span><br><span class="line">tar xf prometheus-2.36.1.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.36.1.linux-amd64 /usr/local/prometheus</span><br><span class="line">chown -R root.root /usr/local/prometheus</span><br><span class="line">restorecon -Rv /usr/local/prometheus</span><br></pre></td></tr></table></figure><p>Prometheus的配置文件是YAML格式，大致分为4大部分：global、alerting、rule_files、scrape_configs</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">5s</span> <span class="comment"># Server端拉取数据的时间间隔，这个值也表示是时间序列的颗粒度，可以被局部配置覆盖</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">5s</span> <span class="comment"># 该参数用于控制记录规则和报警规则的执行间隔(频率),Prometheus使用记录规则来创建新的时间序列并生成告警(Prometheus会拉取大量的时间序列度量数据，如CPU、内存、磁盘等，但这些单个的度量数据不能直接拿来告警，先用PromQL来编写规则得到我们想要的指标值，如何给规则定义一个名字，这个编写好的规则我们称之为记录规则，同时这是一个新的时间序列数据，这个已定义的规则名可以在告警规则中引用)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alertmanager configuration;用于设置Prometheus的告警，Prometheus本身不支持告警通知功能，需要借助Alertmanager组件</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9093&quot;</span>]</span><br><span class="line">          <span class="comment">#   - localhost:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second_rules.yml&quot;</span></span><br><span class="line"><span class="comment"># 规则文件，用来指定包含记录规则或告警规则的文件列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it&#x27;s Prometheus itself.</span></span><br><span class="line"><span class="comment"># 用于配置Prometheus的目标endpint端点，目前配置是基于静态列表，后续可以配置成文件读取和自动发现等方式</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;node&quot;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;172.25.250.9:9100&quot;</span>]</span><br></pre></td></tr></table></figure><p>配置Prometheus启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tee</span> &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=prometheus</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/prometheus/prometheus --config.file=/usr/local/prometheus/prometheus.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now prometheus.service</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 监控 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> 监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s安装1.23.6脚本</title>
      <link href="/archives/8b15daa1.html"/>
      <url>/archives/8b15daa1.html</url>
      
        <content type="html"><![CDATA[<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>适用于1.23.6版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">function set_repo() &#123;</span><br><span class="line">echo &quot;开始配置存储库...&quot;</span><br><span class="line">echo &quot;清空默认存储库...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">rm -rf /etc/yum.repos.d/*.repo</span><br><span class="line">echo &quot;安装基础存储库...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">curl -o /etc/yum.repos.d/a.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span><br><span class="line">echo &quot;安装k8s存储库...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">tee &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line">echo &quot;安装Docker-CE存储库...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function set_env() &#123;</span><br><span class="line">echo &quot;关闭SeLinux...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class="line">echo &quot;永久关闭交换分区...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">swapoff -a</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line">echo &quot;桥接流量...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">tee &gt; /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line">tee &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line">echo &quot;永久关闭Firewalld防火墙...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">systemctl disable --now firewalld</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function install_software() &#123;</span><br><span class="line">echo &quot;安装Docker-CE...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">dnf -y install docker-ce --allowerasing</span><br><span class="line">echo &quot;设置Docker开机自启并启动Docker...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">systemctl enable --now docker</span><br><span class="line">echo &quot;配置Docker...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">mkdir /etc/docker/</span><br><span class="line">touch /etc/docker/daemon.json</span><br><span class="line">tee &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line"> &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">sleep 2</span><br><span class="line">echo &quot;设置Docker开机自启并启动Docker...&quot;</span><br><span class="line">echo &quot;安装K8S组件...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">dnf -y install kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6</span><br><span class="line">echo &quot;设置Kubelet自启...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">systemctl enable kubelet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function conf_k8smaster() &#123;</span><br><span class="line">echo &quot;开始初始化K8S集群...&quot;</span><br><span class="line">sleep 2</span><br><span class="line">read -p &quot;请输入本机IP地址:&quot; IP</span><br><span class="line">read -p &quot;请输入pod网络(x.x.x.x/x)：&quot; PODIP</span><br><span class="line">read -p &quot;请输入Server网络(x.x.x.x/x)：&quot; SRVIP</span><br><span class="line">read -p &quot;确认输入正确? [y/n] &quot; input</span><br><span class="line">case $input in</span><br><span class="line">        [yY]*)</span><br><span class="line">        echo &quot;开始初始化集群...&quot;</span><br><span class="line">                sleep 2</span><br><span class="line">                echo &quot;此过程可能需要几分钟请耐心等待...&quot;</span><br><span class="line">                kubeadm init --apiserver-advertise-address=$IP --pod-network-cidr=$PODIP --service-cidr=$SRVIP --image-repository=registry.cn-hangzhou.aliyuncs.com/ --kubernetes-version 1.23.6 google_containers &gt; /root/.k8s.info</span><br><span class="line">                export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">                echo &quot;请在客户端安装环境后输入如下命令加入集群！&quot;</span><br><span class="line">                echo &quot;==================================&quot;</span><br><span class="line">                tail -n 2 /root/.k8s.info</span><br><span class="line">                echo &quot;==================================&quot;</span><br><span class="line">                echo &quot;Master初始化完毕&quot;</span><br><span class="line">                </span><br><span class="line">                ;;</span><br><span class="line">        [nN]*)</span><br><span class="line">conf_k8s</span><br><span class="line">clear</span><br><span class="line">                ;;</span><br><span class="line">        *)</span><br><span class="line">                echo &quot;请手动初始化...&quot;</span><br><span class="line">                exit</span><br><span class="line">                ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function conf_k8snode()&#123;</span><br><span class="line">echo &quot;正在下载组件！&quot;</span><br><span class="line">sleep 2</span><br><span class="line">echo &quot;请耐心等待，这个过程可能需要几分钟...&quot;</span><br><span class="line">kubeadm config images pull --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">echo &quot;Master初始化完毕!&quot;</span><br><span class="line">echo &quot;接下来请输入Master生成的令牌将节点加入K8S集群&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function set_master_node() &#123;</span><br><span class="line">echo &quot;</span><br><span class="line">----------------------</span><br><span class="line">1.初始化Master环境</span><br><span class="line">2.初始化Node环境</span><br><span class="line">&quot;</span><br><span class="line">read -p &quot;请选择：&quot; setMN</span><br><span class="line">case $setMN in</span><br><span class="line">        1*)</span><br><span class="line">        set_repo</span><br><span class="line">set_env</span><br><span class="line">install_software</span><br><span class="line">conf_k8smaster</span><br><span class="line">                ;;</span><br><span class="line">        2*)</span><br><span class="line">set_repo</span><br><span class="line">set_env</span><br><span class="line">install_software</span><br><span class="line">conf_k8snode</span><br><span class="line">                ;;</span><br><span class="line">        *)</span><br><span class="line">                echo &quot;脚本退出...&quot;</span><br><span class="line">                exit</span><br><span class="line">                ;;</span><br><span class="line">esac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">echo &quot;请确保CPU2大于两核，内存大于2G，否则初始化会报错！&quot;</span><br><span class="line">sleep 3</span><br><span class="line">set_master_node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>keepalived</title>
      <link href="/archives/7377fd95.html"/>
      <url>/archives/7377fd95.html</url>
      
        <content type="html"><![CDATA[<h1 id="Keepalived概念"><a href="#Keepalived概念" class="headerlink" title="Keepalived概念"></a>Keepalived概念</h1><blockquote><p>前置知识LVS，<a href="https://www.xiaowangc.com/archives/lvslinuxvirtualserver">点我转到LVS</a></p></blockquote><p>Keepalived最初是为LVS而设计，用于避免LVS的单点故障(只有一台LVS服务器，当它Down之后整个集群就崩溃了)。该项目主要是为了Linux系统和基础设施提供简单而强大的负载均衡和高可用性，Keepalived中的负载均衡框架依赖与LVS(IPVS)内核模块，提供4层(OSI七层模型中的第四层)负载均衡。</p><p>简单来说，Keepalived是LVS的升级版，在此基础上增加了<strong>故障检测</strong>和**高可用(VRRP)**功能，之前我们配置LVS的时候是使用ipvsadm软件包来进行设置的，但使用keepalived之后就无需通过ipvsadm进行配置管理，更多的是用来查看LVS的配置。</p><p><img src="/archives/7377fd95/20220212070236487.png" alt="image-20220212070236487"></p><p>如上图所示：</p><ul><li>传统LVS实现Web应用的高可用，但是LVS存在单点故障。当LVS服务器Down掉之后，整个集群将瘫痪无法对外提供服务。</li><li>Keepalived+LVS架构解决了LVS存在的单点故障并提供负载均衡、高可用性。当Master节点Down掉之后，Backup发现之后就会代替Master接管VIP的工作</li><li>Keepalived节点可以任意台(大于等于2)</li></ul><h1 id="配置文件解析"><a href="#配置文件解析" class="headerlink" title="配置文件解析"></a>配置文件解析</h1><p>Keepalived配置分为三大模块</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">global_defs&#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">全局配置块</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VRRP配置块</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.1.1 80 &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">LVS配置块</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">keepalived配置文件</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################全局配置块##########################</span></span></span><br><span class="line">global_defs &#123;</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">定义邮箱列表</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">定义邮件发送者</span></span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">设置邮件服务器地址</span></span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">邮件服务器连接超时30s</span></span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">路由ID(设备标识)</span></span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查),默认开启</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">配置VRRP检测脚本</span></span><br><span class="line">   vrrp_strict</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">在接口上配置免费ARP发送时间</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">在接口上发送未经请求的NA消息之间的延迟</span></span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################VRRP配置块##########################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义VRRP实例</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置VRRP状态(MASTER为主，BACKUP为备)</span></span><br><span class="line">    state MASTER</span><br><span class="line">    # VRRP绑定的网络接口</span><br><span class="line">    interface eth0</span><br><span class="line">    # 虚拟路由ID(相同的VRID为一个组，主从服务器需设为一致；该值为0-255)</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    # 优先级(越大越优)</span><br><span class="line">    priority 100</span><br><span class="line">    # 检查时间为1s</span><br><span class="line">    advert_int 1</span><br><span class="line">    # 验证方式</span><br><span class="line">    authentication &#123;</span><br><span class="line">    # 认证类型(PASS或AH)</span><br><span class="line">        auth_type PASS</span><br><span class="line">        # 验证密码</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    # 定义VIP，只有VRRP实例中MASTER拥有</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.16</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################## LVS配置块############################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义LVS虚拟服务</span></span><br><span class="line">virtual_server 192.168.200.100 443 &#123;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器轮询间隔时间</span></span><br><span class="line">    delay_loop 6</span><br><span class="line">    # LVS调度算法(rr,wrr,lc,wlc,lblc,sh,dh)</span><br><span class="line">    lb_algo rr</span><br><span class="line">    # LVS工作模式(NAT,DR,TUN)</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    # 会话保持时间</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    # 数据转发协议</span><br><span class="line">    protocol TCP</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义后端真实服务器IP及端口</span></span><br><span class="line">    real_server 192.168.201.100 443 &#123;</span><br><span class="line">    # 权重</span><br><span class="line">        weight 1</span><br><span class="line">        # 健康检测器(HTTP_GET\SSL_GET)</span><br><span class="line">        SSL_GET &#123;</span><br><span class="line">        # 统一资源定位器</span><br><span class="line">            url &#123;</span><br><span class="line">              # 路径 </span><br><span class="line">              path /</span><br><span class="line">              # 摘要(监控检测需要设置摘要或status_code)</span><br><span class="line">              digest ff20ad2481f97b1754ef3e12ecd3a9cc</span><br><span class="line">              # status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /mrtg/</span><br><span class="line">              digest 9b3a0c85a887a256d6939da88aabd8cd</span><br><span class="line">            &#125;</span><br><span class="line">            # 连接超时3s</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            # 重试3次</span><br><span class="line">            retry 3</span><br><span class="line">            # 失败后重试之前的延迟</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.10.10.2 1358 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    sorry_server 192.168.200.200 1358</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.2 1358 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl3/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.3 1358 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334c</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334c</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.10.10.3 1358 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.4 1358 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl3/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.5 1358 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl3/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><h2 id="keepalived部署及配置"><a href="#keepalived部署及配置" class="headerlink" title="keepalived部署及配置"></a>keepalived部署及配置</h2><ul><li><p>实验拓扑</p><p>由两台服务器共同维护一个VIP，VIP正常情况下由Master接管，当Master发生故障后由Backup代替接管</p><p><img src="/archives/7377fd95/20220212165741955.png" alt="image-20220212165741955"></p></li><li><p>IP地址配置(略)</p></li><li><p>Master配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# systemctl disable --now firewalld</span><br><span class="line">[root@master ~]# ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:73:6d:58 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.25.250.101/24 brd 172.25.250.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe73:6d58/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@master ~]# dnf -y install keepalived</span><br><span class="line">[root@master ~]# cd /etc/keepalived/</span><br><span class="line">[root@master keepalived]# cp keepalived.conf keepalived.conf.bak</span><br><span class="line">[root@master keepalived]# vim keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">       # 邮箱列表没有不写</span><br><span class="line">   &#125;</span><br><span class="line">   router_id master# 路由表示设置为主机名</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER# 状态设置为master</span><br><span class="line">    interface ens33# 绑定接口为ens33</span><br><span class="line">    virtual_router_id 51# 虚拟路由IP</span><br><span class="line">    priority 100# 优先级</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.25.250.100# VIP</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master keepalived]# systemctl enable --now keepalived</span><br></pre></td></tr></table></figure></li><li><p>Backup配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# systemctl disable --now firewalld</span><br><span class="line">[root@backup ~]# dnf -y install keepalived</span><br><span class="line">[root@backup ~]# cd /etc/keepalived/</span><br><span class="line">[root@backup keepalived]# ls</span><br><span class="line">keepalived.conf</span><br><span class="line">[root@backup keepalived]# mv keepalived.conf keepalived.conf.bak</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里我就不修改了直接拷贝Master的配置文件过来</span></span><br><span class="line">[root@backup keepalived]# scp root@172.25.250.101:/etc/keepalived/keepalived.conf .</span><br><span class="line">root@172.25.250.101&#x27;s password:</span><br><span class="line">keepalived.conf                                                                       100%  424   233.5KB/s   00:00</span><br><span class="line">[root@backup keepalived]# vim keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">   &#125;</span><br><span class="line">   router_id backup# 路由ID改为主机名</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP# 状态为备用</span><br><span class="line">    interface ens33# 接口</span><br><span class="line">    virtual_router_id 51# 虚拟路由ID，同于一个vrrp组需一样</span><br><span class="line">    priority 99# 备节点需比Master优先级低</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111# 密码验证</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.25.250.100# VIP</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@backup ~]# systemctl enable --now keepalived</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/archives/7377fd95/20220212171839534.png" alt="image-20220212171839534"></p></li><li><p>验证阶段</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:73:6d:58 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.25.250.101/24 brd 172.25.250.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.25.250.100/32 scope global ens33# VIP</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe73:6d58/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">-------------------------------------------------------------------------------------------</span><br><span class="line">[root@backup ~]# ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:b7:ea:f8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.25.250.102/24 brd 172.25.250.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:feb7:eaf8/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@backup ~]#</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过ipadd命令查看，可以发现VIP由master接管</span></span><br><span class="line">------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p><img src="/archives/7377fd95/20220212183851781.png" alt="image-20220212183851781"></p><p>当我主动断开master网卡接口之后，172.25.250.100被backup接管</p></li><li><p>分析日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# tail -n 50 /var/log/messages</span><br><span class="line">Feb 12 05:30:02 backup Keepalived_vrrp[1141]: (VI_1) Sending/queueing gratuitous ARPs on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:30:02 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:30:02 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:30:02 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:30:02 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:30:02 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:30:16 backup Keepalived_vrrp[1141]: (VI_1) Master received advert from 172.25.250.101 with higher priority 255, ours 99</span><br><span class="line">Feb 12 05:30:16 backup Keepalived_vrrp[1141]: (VI_1) Entering BACKUP STATE# 此时服务器还是backup状态</span><br><span class="line">Feb 12 05:30:16 backup Keepalived_vrrp[1141]: (VI_1) removing VIPs.# 并移除VIP</span><br><span class="line">Feb 12 05:30:53 backup kernel: perf: interrupt took too long (4036 &gt; 3271), lowering kernel.perf_event_max_sample_rate to 49000</span><br><span class="line">Feb 12 05:36:40 backup systemd[1]: Starting Cleanup of Temporary Directories...</span><br><span class="line">Feb 12 05:36:40 backup systemd[1]: systemd-tmpfiles-clean.service: Succeeded.</span><br><span class="line">Feb 12 05:36:40 backup systemd[1]: Started Cleanup of Temporary Directories.</span><br><span class="line">Feb 12 05:37:59 backup Keepalived_vrrp[1141]: (VI_1) Backup received priority 0 advertisement</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: (VI_1) Receive advertisement timeout# 检查超时，此时因为我们关闭了master的网卡</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: (VI_1) Entering MASTER STATE# 服务器进入master状态进行接管</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: (VI_1) setting VIPs.# 添加VIP</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: (VI_1) Sending/queueing gratuitous ARPs on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:00 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:05 backup Keepalived_vrrp[1141]: (VI_1) Sending/queueing gratuitous ARPs on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:05 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:05 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:05 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:05 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br><span class="line">Feb 12 05:38:05 backup Keepalived_vrrp[1141]: Sending gratuitous ARP on ens33 for 172.25.250.100</span><br></pre></td></tr></table></figure></li></ul><h2 id="LVS-Keepalived实践"><a href="#LVS-Keepalived实践" class="headerlink" title="LVS+Keepalived实践"></a>LVS+Keepalived实践</h2><blockquote><p>采用LVS VS&#x2F;DR模式+Keepalived</p></blockquote><ul><li><p>实验拓扑</p><p><img src="/archives/7377fd95/20220212204324934.png" alt="image-20220212204324934"></p></li><li><p>配置环境</p><ul><li><p>四台Web服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# vi /etc/sysctl.conf</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.announce = 2</span><br><span class="line">net.ipv4.conf.lo.announce = 2</span><br><span class="line">[root@web01 ~]# sysctl -p</span><br><span class="line">[root@web01 ~]# ip address add 192.168.100.100/32 dev lo</span><br><span class="line">[root@web01 ~]# ip address</span><br></pre></td></tr></table></figure><p><img src="/archives/7377fd95/20220212210709887.png" alt="image-20220212210709887"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# mount /dev/sr0 /mnt/</span><br><span class="line">[root@web01 ~]# tee &gt; /etc/yum.repos.d/a.repo &lt;&lt; EOF</span><br><span class="line">[BaseOS]</span><br><span class="line">name = BaseOS</span><br><span class="line">baseurl = file:///mnt/BaseOS</span><br><span class="line">enabled = 1 </span><br><span class="line">gpgcheck = 0</span><br><span class="line"></span><br><span class="line">[AppStream]</span><br><span class="line">name = AppStream</span><br><span class="line">baseurl = file:///mnt/AppStream</span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 0</span><br><span class="line">EOF</span><br><span class="line">[root@web01 ~]# dnf -y install httpd</span><br><span class="line">[root@web01 ~]# systemctl enable --now httpd</span><br><span class="line">[root@web01 ~]# systemctl disable --now firewalld</span><br><span class="line">[root@web01 ~]# echo &quot;web01&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@web01 ~]# curl http://localhost</span><br></pre></td></tr></table></figure><p><img src="/archives/7377fd95/20220212211319941.png" alt="image-20220212211319941"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# scp /etc/sysctl.conf 192.168.200.102:/etc/sysctl.conf</span><br><span class="line">[root@web01 ~]# scp /etc/sysctl.conf 192.168.200.103:/etc/sysctl.conf</span><br><span class="line">[root@web01 ~]# scp /etc/sysctl.conf 192.168.200.104:/etc/sysctl.conf</span><br><span class="line">[root@web01 ~]# scp /etc/yum.repos.d/a.repo 192.168.200.102:/etc/yum.repos.d/a.repo</span><br><span class="line">[root@web01 ~]# scp /etc/yum.repos.d/a.repo 192.168.200.103:/etc/yum.repos.d/a.repo</span><br><span class="line">[root@web01 ~]# scp /etc/yum.repos.d/a.repo 192.168.200.104:/etc/yum.repos.d/a.repo</span><br><span class="line">[root@web01 ~]# ssh 192.168.200.102</span><br><span class="line">[root@web02 ~]# sysctl -p</span><br><span class="line">[root@web02 ~]# ip address add 192.168.100.100/32 dev lo</span><br><span class="line">[root@web02 ~]# mount /dev/sr0 /mnt</span><br><span class="line">[root@web02 ~]# dnf -y install httpd</span><br><span class="line">[root@web02 ~]# systemctl enable --now httpd</span><br><span class="line">[root@web02 ~]# systemctl disable --now firewalld</span><br><span class="line">[root@web02 ~]# curl http://localhost</span><br></pre></td></tr></table></figure></li></ul><p> <img src="/archives/7377fd95/20220212212042834.png" alt="image-20220212212042834"></p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 ~]# ssh 192.168.200.103</span><br><span class="line">[root@web03 ~]# sysctl -p</span><br><span class="line">[root@web03 ~]# ip address add 192.168.100.100/32 dev lo</span><br><span class="line">[root@web03 ~]# mount /dev/sr0 /mnt/</span><br><span class="line">[root@web03 ~]# dnf -y install httpd</span><br><span class="line">[root@web03 ~]# systemctl enable --now httpd</span><br><span class="line">[root@web03 ~]# systemctl disable --now firewalld</span><br><span class="line">[root@web03 ~]# echo &quot;web03&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@web03 ~]# curl http://localhost</span><br></pre></td></tr></table></figure><p> <img src="/archives/7377fd95/20220212212600468.png" alt="image-20220212212600468"></p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@web03 ~]# ssh 192.168.200.104</span><br><span class="line">[root@web04 ~]# mount /dev/sr0 /mnt</span><br><span class="line">[root@web04 ~]# sysctl -p</span><br><span class="line">[root@web04 ~]# ip add add 192.168.100.100/32 dev lo</span><br><span class="line">[root@web04 ~]# dnf -y install httpd</span><br><span class="line">[root@web04 ~]# systemctl enable --now httpd</span><br><span class="line">[root@web04 ~]# systemctl disable --now firewalld</span><br><span class="line">[root@web04 ~]# echo &quot;web04&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@web04 ~]# curl http://localhost</span><br></pre></td></tr></table></figure><p>  <img src="/archives/7377fd95/20220212212940769.png" alt="image-20220212212940769"></p><ul><li><p><strong>配置Keepalived(Master)+LVS</strong></p><p>IP配置略</p><p><img src="/archives/7377fd95/20220212214708348.png" alt="image-20220212214708348"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# scp 192.168.200.101:/etc/yum.repos.d/a.repo /etc/yum.repos.d/a.repo</span><br><span class="line">[root@master ~]# mount /dev/sr0 /mnt</span><br><span class="line">[root@master ~]# systemctl disable --now firewalld</span><br><span class="line">[root@master ~]# echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">[root@master ~]# dnf -y install keepalived</span><br><span class="line">[root@master ~]# dnf -y install vim </span><br><span class="line">[root@master ~]# cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">router_id master</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER</span><br><span class="line">interface ens33</span><br><span class="line">virtual_router_id 51</span><br><span class="line">priority 100</span><br><span class="line">advert_int 1</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.100.100</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.100.100 80 &#123;</span><br><span class="line">delay_loop 6</span><br><span class="line">lb_algo rr</span><br><span class="line">lb_kind DR</span><br><span class="line">persistence_timeout 50</span><br><span class="line"></span><br><span class="line">real_server 192.168.200.101 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.102 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.103 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.104 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master ~]# systemctl enable --now keepalived</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p><strong>配置Keepalived(Backup)+LVS</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# mount /dev/sr0 /mnt/</span><br><span class="line">[root@backup ~]# scp 192.168.100.101:/etc/yum.repos.d/a.repo /etc/yum.repos.d/a.repo</span><br><span class="line">[root@backup ~]# systemctl disable --now firewalld</span><br><span class="line">[root@backup ~]# echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">[root@backup ~]# dnf -y install vim keepalived</span><br><span class="line">[root@backup ~]# scp 192.168.100.101:/etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf</span><br><span class="line">[root@backup ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">router_id backup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state BACKUP</span><br><span class="line">interface ens33</span><br><span class="line">virtual_router_id 51</span><br><span class="line">priority 99</span><br><span class="line">advert_int 1</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.100.100</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.100.100 80 &#123;</span><br><span class="line">delay_loop 6</span><br><span class="line">lb_algo rr</span><br><span class="line">lb_kind DR</span><br><span class="line">persistence_timeout 50</span><br><span class="line"></span><br><span class="line">real_server 192.168.200.101 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.102 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.103 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.104 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@backup ~]# systemctl enable --now keepalived</span><br></pre></td></tr></table></figure></li><li><p><strong>配置网关及Nat</strong></p><ul><li>配置网卡</li></ul><p><img src="/archives/7377fd95/20220212221601562.png" alt="image-20220212221601562"></p><ul><li><p>安装服务</p><p><img src="/archives/7377fd95/20220212221808032.png" alt="image-20220212221808032"></p><p>选择路由然后一下步直至安装完毕</p><p><img src="/archives/7377fd95/20220212221823741.png" alt="image-20220212221823741"></p></li><li><p>安装好之后配置NAT</p><p><img src="/archives/7377fd95/20220212222047738.png" alt="image-20220212222047738"></p><p><img src="/archives/7377fd95/20220212222248554.png" alt="image-20220212222248554"></p></li></ul></li></ul></li><li><p>测试</p><p>IP地址随意，不一定按照拓扑图上来</p><p>我这测试的情况是一台主机发送请求后一直对应后端的Web02服务器，更换IP后后端Web才变</p><p><img src="/archives/7377fd95/20220212225053422.png" alt="image-20220212225053422"></p><p><img src="/archives/7377fd95/20220212225231668.png" alt="image-20220212225231668"></p></li><li><p>断开Master网卡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# nmcli connection down ens33</span><br></pre></td></tr></table></figure><p>再次访问(结果正常，实现了LVS的高可用)</p><p><img src="/archives/7377fd95/20220212225440861.png" alt="image-20220212225440861"></p><ul><li>Backup正常接管VIP</li></ul></li></ul><p><img src="/archives/7377fd95/20220212225536408.png" alt="image-20220212225536408"></p>]]></content>
      
      
      <categories>
          
          <category> 负载均衡 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LVS</title>
      <link href="/archives/9842572a.html"/>
      <url>/archives/9842572a.html</url>
      
        <content type="html"><![CDATA[<h1 id="LVS概念"><a href="#LVS概念" class="headerlink" title="LVS概念"></a>LVS概念</h1><blockquote><p>最开始学的时候感觉这么老的技术为什么还在用，内心反感。直到思索K8S部署的时候如果采用LVS的某个功能可以加快K8S包转发效率，感觉是真不错。</p></blockquote><p>LVS(Linux Virtual Server)，Linux虚拟服务器。是一个虚拟的服务器集群系统，通过LVS可提供负载均衡以及用来实现一个高可用、高性能的服务器集群，它有良好的可靠性、可扩展性和可操作性。LVS已集成在Linux内核(2.4+)中。</p><p>在诸多负载均衡技术中有基于DNS、客户端、应用层、IP等调度的方案。而LVS采用IP负载均衡和基于内容请求分发技术，主要功能有如下：</p><ul><li>三种负载均衡技术(NAT&#x2F;TUN&#x2F;DR)</li><li>十种调度算法(rr&#x2F;wrr&#x2F;lc&#x2F;wlc&#x2F;lblc&#x2F;lblcr&#x2F;dh&#x2F;sh&#x2F;sed&#x2F;nq)</li></ul><p>LVS基于内核级别的应用软件，有着较高的性能和处理能力。可支持上百万个并发连接请求(据说在百兆网卡下，吞吐量可以达到1Gbits&#x2F;s；千兆网卡可达到10Gbits&#x2F;s，不知道是不是真的反正我没有试过！)</p><p>缺点也就是需要上层协议支持，QwQ还要单独配置网络环境烦死了</p><h1 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h1><blockquote><p>LVS有三种工作模式，Dr、Tun、Nat，后期实验只测试Dr和Tun。Tun跟Dr差不多只是跨网段，配置起来嘛，不会真有把调度器和集群分离的情况吧？？？</p></blockquote><ul><li><p><strong>VS&#x2F;NAT</strong></p><p>VS&#x2F;NAT即虚拟网络地址转换实现虚拟服务器。让我们想一下Nat的工作原理：</p><p>​                                        外网&lt;———-&gt;Nat服务器&lt;——–&gt;内网</p><p><code>众所周知</code>Nat主要实现内外网络地址转换，以解决IPv4地址池不足问题以及端口映射等。当我们从外网访问Nat服务器的外网IP地址就会将地址转换成内外的某个给定的地址范围，并于内外某一个用户进行通信，用户再将信息返回给Nat进行转换为公网IP地址与外网进行通信。</p><p>而VS&#x2F;NAT就是基于此技术，但是Nat转换同一个端口&#x2F;IP只对应内网的某个单一的服务器。那么就得说到一个LVS最重要的一个功能，那就是调度器。</p><p>如下图：</p></li></ul><p><img src="/archives/9842572a/20220210011443401.png" alt="image-20220210011443401"></p><p>  假如用户访问<a href="http://www.xiaowangc.com，众所周知www.xiaowangc.com是一个Web应用服务器。图上带着地球图标的Web服务器。举个例子www.xiaowangc.com对应IP地址：192.168.1.1/24，但实际上，真实的Web应用服务器不会是192.168.1.1，而且其他地址。这个192.168.1.1IP地址是由LVS上的VIP(虚拟地址，实际上是网口上的接口地址)。通过访问这个集群虚拟IP地址，LVS会将http/https请求按照设置的调度算法以此转发(Nat，通过对数据包中的源目的IP进行更改)给其中一台服务器(不知道我这么说明白了吗？反正我自己是清楚的！)。">www.xiaowangc.com，众所周知www.xiaowangc.com是一个Web应用服务器。图上带着地球图标的Web服务器。举个例子www.xiaowangc.com对应IP地址：192.168.1.1/24，但实际上，真实的Web应用服务器不会是192.168.1.1，而且其他地址。这个192.168.1.1IP地址是由LVS上的VIP(虚拟地址，实际上是网口上的接口地址)。通过访问这个集群虚拟IP地址，LVS会将http/https请求按照设置的调度算法以此转发(Nat，通过对数据包中的源目的IP进行更改)给其中一台服务器(不知道我这么说明白了吗？反正我自己是清楚的！)。</a></p><p>  第一次请求进行转发后，那么LVS会记录下此次转发的情况，谁给我的？我又给谁的？并记录到Hash表中，当这个请求后续的数据包需要转发时直接查询Hash表进行转发。</p><p>  <strong>Web服务器网关需要将LVS的接口IP地址(与服务器集群相连的那个接口的IP地址)设置为自身网关！因为服务器需要经过LVS对响应数据包进行转发</strong></p><blockquote><p>LVS的VIP不能和服务器的网段处于同一网段！</p></blockquote><ul><li><p><strong>VS&#x2F;DR</strong></p><p>VS&#x2F;DR即直接路由实现虚拟服务器。什么叫直接路由？在了解了VS&#x2F;Nat方式后，可以发现。一个数据包通常可分为请求&#x2F;响应两种，用户请求访问网页，服务器返回资源给用户。那么VS&#x2F;Nat模式不管是请求还是响应的数据包都是要经过LVS这会给LVS造成极大的压力。如果服务器网卡带宽本来就不高，还要承受请求和响应的数据转发，我都哭了~而且众所周知！响应数据包是要比请求包要大的！</p><p>VS&#x2F;DR的就是为了解决这个问题，请求响应分离！LVS以后之转发请求数据包，响应数据包由服务器直接转发给用户，分担LVS的工作量。</p></li></ul><p><img src="/archives/9842572a/20220210014303277.png" alt="image-20220210014303277"></p><p>  那么就会有朋友问了！我用户访问的是LVS的接口地址IP（VIP），那服务器如果直接返回给用户那么源地址不就是Web服务器的IP地址就是VIP，这样客户端就会丢弃的！<em><strong>其实在LVS调度器转发给后端服务器之前就通过更改目的Mac地址对数据包进行转发</strong></em>，而且IP层还是<code>[源地址：客户IP地址 | 目的地址：LVSIP地址]</code>，那么并在Web服务器的<strong>Lo本地回环网卡上配置一个VIP</strong>，并修改配置<strong>关闭ARP应答</strong>。这样一来，服务器在进行转发给用户的时候数据包源地址依然是VIP。</p><p>  直接路由也就是服务器直接转发给客户端，而不需要经过LVS~</p><blockquote><p>二层局域网中实际上传输的是帧，而帧依靠目的Mac地址进行转发。关闭ARP。在Lo回环口设置VIP！！！当然还要保证Web服务器能上网的情况下</p></blockquote><ul><li><p><strong>VS&#x2F;TUN</strong></p><p>这个东东感觉有点复杂(实现复杂，本来Dr就麻烦，这个还加了隧道)了o(*≧▽≦)ツ┏━┓，VS&#x2F;Tun即是IP隧道技术现实虚拟服务器。这个技术跟VS&#x2F;Dr差不多，也是将请求&#x2F;响应进行分离，由服务器直接转发给用户。来看图：</p></li></ul><p><img src="/archives/9842572a/20220210020648189.png" alt="image-20220210020648189"></p><p>  各位发现了没有，这图好像跟前一张图差不多好像几乎一模一样。不，仔细看，LVS到Web应用服务器之间连接到线变成了虚线，这个线还叫IP隧道！这种技术主要是用在跨网段，跨区域情况下使用。那么就会有兄弟说了：难道我这就在一个本地区域使用不行吗？啊这。。。那用VS&#x2F;Dr模式不就行了吗？还省去配置隧道的过程。而且哪个工程师会将调度器和应用分开部署的……除真有特别极端的情况，服务器有部分或all都不在一个区域，我分别将服务器放在北上广深，但是我LVS就想放在成都，那么你就可以用VS&#x2F;Tun来实现。</p><p>  而且图中的虚线也就LVS与服务器跨了一个或多个网络才会采用IP隧道技术实现将LVS与服务器虚拟在一个网络中。工作流程还是跟VS&#x2F;Dr一样，LVS接收并转发请求，而此模式的请求是经过隧道并转发给服务器，服务器在将响应数据通过互联网直接发送给用户。</p><blockquote><p>用跨一个或多个网络的情况下。</p></blockquote><h1 id="3-调度算法"><a href="#3-调度算法" class="headerlink" title="3. 调度算法"></a>3. 调度算法</h1><blockquote><p>根据前面的介绍依据大概对LVS有了一个基础的认识，LVS是做负载均衡的！</p></blockquote><blockquote><p>而负载均衡最核心的就是调度和算法，下面就来了解一下LVS的十种调度算法</p></blockquote><ol><li><p><strong>轮询</strong></p><p>轮询算法(rr)，就是按照依次循环的方式将请求调度到不同的服务器上。</p><p>例：第一个请求我给A，第二个请求我给B，第三个请求我给C，第四个请求我给A……以此往复</p><p>这种算法的特点就是简单，但是它忽略了服务器的真实负载情况。</p><p>例：假如有两台Web服务器A、B。我们知道请求是有一个连接(会话)的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第一个请求------------&gt;A# 这个连接三秒后就断开了</span><br><span class="line">第二个请求------------&gt;B# 这个连接一直保持连接</span><br><span class="line">第三个请求------------&gt;A# 此时A的连接数为1</span><br><span class="line">第四个请求------------&gt;B# 此时B的连接数为2</span><br></pre></td></tr></table></figure><p>此种情况，连接数小还行，如果大了，会将差距拉开，这将导致无法将请求均匀的分配的每个服务器</p></li><li><p><strong>加权轮询</strong></p><p>加权轮询算法(wrr)，这种调度算法算法是对轮询**(rr)**进行优化和改进的。这考虑到服务器的性能情况，让性能Newbee的服务器承担多一点（能力越大责任越大），减轻低性能服务器的压力。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A服务器权重为1</span><br><span class="line">B服务器权重为2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有3个请求，那么2个都会分给B服务器，1个分给A服务器</span></span><br></pre></td></tr></table></figure></li><li><p><strong>最小连接</strong></p><p>最小连接算法(lc)，我们前面说过轮询算法(rr)不能判断服务器的真实负载情况。而通过最小连接算法(lc)，就是将请求调度到连接数量最小的服务器上。</p></li><li><p><strong>加权最小连接</strong></p><p>加权最小连接算法(wlc)，通过设置权重，来决定分配给服务器请求，在平横实际请求的同时兼顾服务器性能，权重大的服务器收到的请求占比较多。</p></li><li><p><strong>目标地址散列</strong></p><p>目标地址散列算法(dh)，根据目标IP地址通过散列函数将目标IP服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该IP的请求会固定发给该服务器</p></li><li><p><strong>源地址散列</strong></p><p>源地址散列算法(sh)，与目标地址散列类似，但是它是根据源地址散列算法进行静态分配固定的服务器资源</p></li><li><p><strong>基于局部的最少连接</strong></p><p>基于局部的最少连接算法(lblc)，该算法主要用于Cache集群系统，用于判断服务器的活动状态且负载能力不佳的情况下，将发往该IP地址的数据包重定向到其他服务器，并按照最小连接数算法分配到集群其中的一台服务器</p></li><li><p><strong>带有复制调度的基于局部的最少连接</strong></p><p>带有复制调度的基于局部的最少连接算法(lblcr)，他会维护目标IP到服务器集群之间的连接记录，防止单点负载过高</p></li><li><p><strong>最短期望的延迟</strong></p><p>最短期望的延迟算法(sed)，该算法将网络连接分配给具有最短预期延迟的服务器</p></li><li><p><strong>从不排队调度</strong></p><p>从不排队调度算法(nq)，当有空闲服务器可用时，请求会被发送到该服务器，如果没有，请求将会被发送到最小期望的延迟服务器(最短期望的延迟)</p></li></ol><h1 id="4-命令格式"><a href="#4-命令格式" class="headerlink" title="4. 命令格式"></a>4. 命令格式</h1><p>简化：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">用于虚拟服务</span><br><span class="line">-A# 添加一个虚拟服务,使用IP+端口+协议定义</span><br><span class="line">—E# 编辑一个虚拟服务</span><br><span class="line">-D# 删除一个虚拟服务</span><br><span class="line">-C# 清空虚拟服务列表</span><br><span class="line">-s# 指定LVS采用的算法</span><br><span class="line">-S# 保存虚拟服务规则至标准输出，输出的规则可通过-R导入</span><br><span class="line">用于服务器</span><br><span class="line">-a# 在虚拟服务中添加一个服务器</span><br><span class="line">-e# 在虚拟服务中编辑一个服务器</span><br><span class="line">-d# 在虚拟服务中删除一个服务器</span><br><span class="line">-r# 设置真实服务器IP地址与端口信息</span><br><span class="line">-g# 设置LVS工作模式为Dr</span><br><span class="line">-i# 设置LVS工作模式为Tun</span><br><span class="line">-m# 设置LVS工作模式为Nat</span><br><span class="line">-w# 设置权重</span><br><span class="line">其他</span><br><span class="line">-L# 显示虚拟服务列表</span><br><span class="line">-n# 数字格式输出</span><br><span class="line">-c# 连接状态配合-L使用</span><br><span class="line">-t# 使用TCP</span><br><span class="line">-u# 使用UDP</span><br><span class="line">例：</span><br><span class="line">[root@localhost ~]# ipvsadm -A 192.168.1.1:80 -s rr</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置192.168.1.1:80虚拟服务并使用轮询(rr)算法</span></span><br><span class="line">[root@localhost ~]# ipvadm -a -t 192.168.1.1:80 -r 192.168.2.1:80 -m -w</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从192.168.1.1:80虚拟服务中添加192.168.2.1:80服务器并设置工作模式为Nat，权重为1(不指定默认为1)</span></span><br><span class="line">[root@localhost ~]# ipvadm -a -t 192.168.1.1:80 -r 192.168.2.2:80 -m -w 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从192.168.1.1:80虚拟服务中添加192.168.2.2:80服务器并设置工作模式为Nat，权重为2</span></span><br></pre></td></tr></table></figure><p>完整：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ipvsadm --help</span><br><span class="line">ipvsadm v1.31 2019/12/24（使用popt和IPVS v1.2.1编译）</span><br><span class="line">用法：</span><br><span class="line">  ipvsadm -A|E 虚拟服务 [-s 调度程序] [-p [超时]] [-M 网络掩码] [--pe persistence_engine] [-b sched-flags]</span><br><span class="line">  ipvsadm -D 虚拟服务</span><br><span class="line">  ipvsadm -C</span><br><span class="line">  ipvsadm -R</span><br><span class="line">  ipvsadm -S [-n]</span><br><span class="line">  ipvsadm -a|e 虚拟服务 -r 服务器地址 [选项]</span><br><span class="line">  ipvsadm -d 虚拟服务 -r 服务器地址</span><br><span class="line">  ipvsadm -L|l [虚拟服务] [选项]</span><br><span class="line">  ipvsadm -Z [虚拟服务]</span><br><span class="line">  ipvsadm --set tcp tcpfin udp</span><br><span class="line">  ipvsadm --start-daemon &#123;master|backup&#125; [daemon-options]</span><br><span class="line">  ipvsadm --stop-daemon &#123;master|backup&#125;</span><br><span class="line">  ipvsadm -h</span><br><span class="line"></span><br><span class="line">命令：</span><br><span class="line">允许做多或做空期权。</span><br><span class="line">  --add-service -A 添加带有选项的虚拟服务</span><br><span class="line">  --edit-service -E 使用选项编辑虚拟服务</span><br><span class="line">  --delete-service -D 删除虚拟服务</span><br><span class="line">  --clear -C 清空整个表</span><br><span class="line">  --restore -R 从标准输入恢复规则</span><br><span class="line">  --save -S 保存规则到标准输出</span><br><span class="line">  --add-server -a 添加带有选项的真实服务器</span><br><span class="line">  --edit-server -e 使用选项编辑真实服务器</span><br><span class="line">  --delete-server -d 删除真实服务器</span><br><span class="line">  --list -L|-l 列出表</span><br><span class="line">  --zero -Z 服务或所有服务中的零计数器</span><br><span class="line">  --set tcp tcpfin udp 设置连接超时值</span><br><span class="line">  --start-daemon 启动连接同步守护进程</span><br><span class="line">  --stop-daemon 停止连接同步守护进程</span><br><span class="line">  --help -h 显示此帮助信息</span><br><span class="line"></span><br><span class="line">虚拟服务：</span><br><span class="line">  --tcp-service|-t 服务地址 服务地址是主机[:端口]</span><br><span class="line">  --udp-service|-u 服务地址 服务地址是主机[:端口]</span><br><span class="line">  --sctp-service 服务地址 服务地址是主机[:端口]</span><br><span class="line">  --fwmark-service|-f fwmark fwmark 是大于零的整数</span><br><span class="line"></span><br><span class="line">选项：</span><br><span class="line">  --ipv6 -6 fwmark 条目使用 IPv6</span><br><span class="line">  --scheduler -s 调度程序 rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq|fo|ovf|mh 之一，</span><br><span class="line">                                      默认调度程序是 wlc。</span><br><span class="line">  --pe engine 替代持久性引擎可能是 sip，</span><br><span class="line">                                      默认情况下未设置。</span><br><span class="line">  --persistent -p [超时] 持久化服务</span><br><span class="line">  --netmask -M netmask 持久粒度掩码</span><br><span class="line">  --real-server -r server-address server-address 是主机（和端口）</span><br><span class="line">  --gatewaying -g 网关（直接路由）（默认）</span><br><span class="line">  --ipip -i ipip 封装（隧道）</span><br><span class="line">  --masquerading -m 伪装（NAT）</span><br><span class="line">  --tun-type 类型之一 ipip|gue|gre,</span><br><span class="line">                                      默认隧道类型为 ipip。</span><br><span class="line">  --tun-port port 隧道目的端口</span><br><span class="line">  --tun-nocsum 没有校验和的隧道封装</span><br><span class="line">  --tun-csum 带校验和的隧道封装</span><br><span class="line">  --tun-remcsum 带有远程校验和的隧道封装</span><br><span class="line">  --weight -w 真实服务器的权重容量</span><br><span class="line">  --u-threshold -x uthreshold 连接上限阈值</span><br><span class="line">  --l-threshold -y lthreshold 连接的下限阈值</span><br><span class="line">  --connection -c 当前 IPVS 连接的输出</span><br><span class="line">  --timeout 超时输出（tcp tcpfin udp）</span><br><span class="line">  --daemon 输出守护进程信息</span><br><span class="line">  --stats 输出统计信息</span><br><span class="line">  --rate 输出速率信息</span><br><span class="line">  --exact 扩展数字（显示精确值）</span><br><span class="line">  --thresholds 输出阈值信息</span><br><span class="line">  --persistent-conn 持久连接信息的输出</span><br><span class="line">  --tun-info 输出隧道信息</span><br><span class="line">  --nosort 禁用服务/服务器条目的排序输出</span><br><span class="line">  --sort 什么都不做，为了向后兼容</span><br><span class="line">  --ops -o 一包调度</span><br><span class="line">  --numeric -n 地址和端口的数字输出</span><br><span class="line">  --sched-flags -b flags 调度程序标志（逗号分隔）</span><br><span class="line">守护进程选项：</span><br><span class="line">  --syncid sid syncid 用于连接同步（默认=255）</span><br><span class="line">  --sync-maxlen length 最大同步消息长度（默认=1472）</span><br><span class="line">  --mcast-interface interface 用于连接同步的多播接口</span><br><span class="line">  --mcast-group 地址 IPv4/IPv6 组（默认=224.0.0.81）</span><br><span class="line">  --mcast-port 端口 UDP 端口（默认=8848）</span><br><span class="line">  --mcast-ttl ttl 多播 TTL (默认=1)</span><br></pre></td></tr></table></figure><h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><h2 id="VS-x2F-NAT"><a href="#VS-x2F-NAT" class="headerlink" title="VS&#x2F;NAT"></a>VS&#x2F;NAT</h2><p>拓扑：</p><blockquote><p>简述：在内外部署一套Web应用服务器对外提供服务，由于并发量较大，许采用LVS实现负载均衡。客户端通过访问：100.1.1.2:80获取到Web应用资源。</p></blockquote><p><img src="/archives/9842572a/20220207233553299.png" alt="image-20220207233553299"></p><ul><li><p>配置Web01服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@apache01 ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=d9aa645a-2436-4aa2-b595-88fe28f7eeb9</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.20.1</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.168.20.254# 网关指向LVS内部接口</span><br><span class="line">[root@apache01 ~]# dnf -y install httpd</span><br><span class="line">[root@apache01 ~]# systemctl enable --now httpd</span><br><span class="line">[root@apache01 ~]# systemctl disable --now firewalld</span><br><span class="line">[root@apache01 ~]# echo &quot;apache01&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@apache01 ~]# curl http://localhost</span><br><span class="line">apache01</span><br></pre></td></tr></table></figure></li><li><p>配置Web02服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@apache02 ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=d9aa645a-2436-4aa2-b595-88fe28f7eeb9</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.20.2</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.168.20.254# 网关指向LVS内部接口</span><br><span class="line">[root@apache02 ~]# dnf -y install httpd</span><br><span class="line">[root@apache02 ~]# systemctl enable --now httpd</span><br><span class="line">[root@apache02 ~]# systemctl disable --now firewalld</span><br><span class="line">[root@apache02 ~]# echo &quot;apache02&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@apache02 ~]# curl http://localhost</span><br><span class="line">apache02</span><br></pre></td></tr></table></figure></li><li><p>配置LVS调度</p><blockquote><p>虽然LVS内置在内核中但是我们需要安装ipvsadm工具对其进行配置</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">IP配置略</span><br><span class="line">[root@LVS ~]# dnf -y install ipvsadm# 安装ipvsadm工具包</span><br><span class="line">[root@LVS ~]# systemctl disable --now firewalld</span><br><span class="line">[root@LVS ~]# ipvsadm -A -t 192.168.10.1:80 -s rr</span><br><span class="line">[root@LVS ~]# ipvsadm -a -t 192.168.10.1:80 -r 192.168.20.1:80 -m -w 1</span><br><span class="line">[root@LVS ~]# ipvsadm -a -t 192.168.10.1:80 -r 192.168.20.2:80 -m -w 1</span><br><span class="line">[root@LVS ~]# ipvsadm -S &gt; /etc/sysconfig/ipvsadm</span><br><span class="line">[root@LVS ~]# systemctl enable --now ipvsadm</span><br><span class="line">[root@LVS ~]# echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">[root@LVS ~]# systemctl status ipvsadm</span><br><span class="line">● ipvsadm.service - Initialise the Linux Virtual Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/ipvsadm.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (exited) since Wed 2022-02-09 23:22:52 EST; 40min ago</span><br><span class="line">  Process: 970 ExecStart=/bin/bash -c exec /sbin/ipvsadm-restore &lt; /etc/sysconfig/ipvsadm (code=exited, status=0/SUCCES&gt;</span><br><span class="line"> Main PID: 970 (code=exited, status=0/SUCCESS)</span><br><span class="line">    Tasks: 0 (limit: 4757)</span><br><span class="line">   Memory: 0B</span><br><span class="line">   CGroup: /system.slice/ipvsadm.service</span><br><span class="line"></span><br><span class="line">Feb 09 23:22:52 localhost.localdomain systemd[1]: Starting Initialise the Linux Virtual Server...</span><br><span class="line">Feb 09 23:22:52 localhost.localdomain systemd[1]: Started Initialise the Linux Virtual Server.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我们通过LVS本地访问VIP地址就可以得到效果了</span></span><br><span class="line"></span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache01</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache02</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache01</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache02</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache01</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache02</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache01</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache02</span><br><span class="line">[root@LVS ~]# curl http://192.168.10.1</span><br><span class="line">apache01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看列表</span></span><br><span class="line"></span><br><span class="line">[root@LVS ~]# ipvsadm -L</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  LVS:http rr</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">192.168.20.1:http            Masq    1      0          5<span class="comment"># 向192.168.20.1转发了5次</span></span></span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">192.168.20.2:http            Masq    1      0          4<span class="comment"># 向192.168.20.2转发了4次</span></span></span><br><span class="line">[root@LVS ~]#</span><br></pre></td></tr></table></figure></li></ul><h2 id="VS-x2F-DR"><a href="#VS-x2F-DR" class="headerlink" title="VS&#x2F;DR"></a>VS&#x2F;DR</h2><p>拓扑：</p><blockquote><p>此实验与VS&#x2F;NAT的实验的区别就是将Web应用服务器的网关设置为真实网关，并添加Lo回环接口地址，关闭ARP。</p></blockquote><p><img src="/archives/9842572a/20220211005508487.png" alt="image-20220211005508487"></p><ul><li><p>配置Web01服务器</p><blockquote><p>应用服务器重要步骤即：先配置ARP转发策略，再配置lo地址</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@apache01 ~]# tee &gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">EOF</span><br><span class="line">[root@apache01 ~]# ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:f2:2a:52 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.10.101/24 brd 192.168.10.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fef2:2a52/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@apache01 ~]# ip address add 172.16.10.1/32 dev lo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ens33 自行按照拓扑图正常配置即可，网关指向正常网关，而非LVS</span></span><br><span class="line">[root@apache01 ~]# systemctl disable --now firewalld</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@apache01 ~]# dnf -y install httpd</span><br><span class="line">[root@apache01 ~]# systemctl enable --now httpd</span><br><span class="line">[root@apache01 ~]# echo &quot;apache01&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@apache01 ~]# curl http://localhost</span><br></pre></td></tr></table></figure></li><li><p>配置Web02服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@apache02 ~]# tee &gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">EOF</span><br><span class="line">[root@apache02 ~]# ip address add 172.16.10.1/32 dev lo</span><br><span class="line">[root@apache02 ~]# systemctl disable -now firewalld</span><br><span class="line">[root@apache02 ~]# dnf -y install httpd</span><br><span class="line">[root@apache02 ~]# systemctl enable --now httpd</span><br><span class="line">[root@apache02 ~]# echo &quot;apache02&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@apache02 ~]# curl http://localhost</span><br></pre></td></tr></table></figure></li><li><p>配置LVS调度</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@LVS ~]# echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forwared</span><br><span class="line">[root@LVS ~]# dnf -y install ipvsadm</span><br><span class="line">[root@LVS ~]# ipvsadm -A -t 172.16.10.1:80 -s rr</span><br><span class="line">[root@LVS ~]# ipvsadm -a -t 172.16.10.1:80 -r 192.168.10.101:80 -g</span><br><span class="line">[root@LVS ~]# ipvsadm -a -t 172.16.10.1:80 -r 192.168.10.102:80 -g</span><br><span class="line">[root@LVS ~]# ipvsadm -L</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@LVS ~]# ipvsadm -S &gt; /etc/sysconfig/ipvsadm</span><br><span class="line">[root@LVS ~]# systemctl enable --now ipvsadm</span><br><span class="line">[root@LVS ~]# systemctl disable --now firewalld</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 负载均衡 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker基础</title>
      <link href="/archives/1d9fbb6a.html"/>
      <url>/archives/1d9fbb6a.html</url>
      
        <content type="html"><![CDATA[<h1 id="Docker学习"><a href="#Docker学习" class="headerlink" title="Docker学习"></a>Docker学习</h1><h1 id="Docker概念"><a href="#Docker概念" class="headerlink" title="Docker概念"></a>Docker概念</h1><h2 id="Docker基本概念"><a href="#Docker基本概念" class="headerlink" title="Docker基本概念"></a>Docker基本概念</h2><h6 id="Docker-是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中-然后发布到任何流行的Linux或Windows操作系统的机器上-也可以实现虚拟化-容器是完全使用沙箱机制-相互之间不会有任何接口。"><a href="#Docker-是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中-然后发布到任何流行的Linux或Windows操作系统的机器上-也可以实现虚拟化-容器是完全使用沙箱机制-相互之间不会有任何接口。" class="headerlink" title="Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中,然后发布到任何流行的Linux或Windows操作系统的机器上,也可以实现虚拟化,容器是完全使用沙箱机制,相互之间不会有任何接口。"></a>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中,然后发布到任何流行的Linux或Windows操作系统的机器上,也可以实现虚拟化,容器是完全使用沙箱机制,相互之间不会有任何接口。</h6><h6 id="Linux操作系统本身从系统层面就支持虚拟化技术LXC，LXC有三大特色："><a href="#Linux操作系统本身从系统层面就支持虚拟化技术LXC，LXC有三大特色：" class="headerlink" title="Linux操作系统本身从系统层面就支持虚拟化技术LXC，LXC有三大特色："></a>Linux操作系统本身从系统层面就支持虚拟化技术LXC，LXC有三大特色：</h6><ul><li><strong>cgroup</strong></li></ul><h6 id="Linux-Cgroups-Control-Groups-）提供了对组进程及将来子进程的资源限制、控制和统计的能力，这些资源包括-CPU、内存、存储、网络等-通过-Cgroups-，可以方便地限制某个进程的资源占用，并且可以实时地监控进程的监控和统计信息"><a href="#Linux-Cgroups-Control-Groups-）提供了对组进程及将来子进程的资源限制、控制和统计的能力，这些资源包括-CPU、内存、存储、网络等-通过-Cgroups-，可以方便地限制某个进程的资源占用，并且可以实时地监控进程的监控和统计信息" class="headerlink" title="Linux Cgroups (Control Groups ）提供了对组进程及将来子进程的资源限制、控制和统计的能力，这些资源包括 CPU、内存、存储、网络等 通过 Cgroups ，可以方便地限制某个进程的资源占用，并且可以实时地监控进程的监控和统计信息"></a>Linux Cgroups (Control Groups ）提供了对组进程及将来子进程的资源限制、控制和统计的能力，这些资源包括 CPU、内存、存储、网络等 通过 Cgroups ，可以方便地限制某个进程的资源占用，并且可以实时地监控进程的监控和统计信息</h6><ul><li><strong>namespace</strong></li></ul><h6 id="Linux-Namespace是Kernel的一个功能，它可以隔离一系列的系统资源，比如PID、UserID、Netwokr等。"><a href="#Linux-Namespace是Kernel的一个功能，它可以隔离一系列的系统资源，比如PID、UserID、Netwokr等。" class="headerlink" title="Linux Namespace是Kernel的一个功能，它可以隔离一系列的系统资源，比如PID、UserID、Netwokr等。"></a>Linux Namespace是Kernel的一个功能，它可以隔离一系列的系统资源，比如PID、UserID、Netwokr等。</h6><ul><li><strong>unionFS</strong></li></ul><h6 id="Union-File-System-UnionFS-将其他文件系统联合到一个联合挂载点的文件系统服务。它使用branch把不同文件系统的文件和目录透明的覆盖，形成一个单一一致的文件系统，当对这个联合文件系统进行写操作时，系统是真正写到了一个新的文件中，这个虚拟后的联合文件系统是可以对任何文件进行操作的，但是它并没有改变原来的文件，因为unionfs用到了一个重要的资源管理技术，叫做写时复制。"><a href="#Union-File-System-UnionFS-将其他文件系统联合到一个联合挂载点的文件系统服务。它使用branch把不同文件系统的文件和目录透明的覆盖，形成一个单一一致的文件系统，当对这个联合文件系统进行写操作时，系统是真正写到了一个新的文件中，这个虚拟后的联合文件系统是可以对任何文件进行操作的，但是它并没有改变原来的文件，因为unionfs用到了一个重要的资源管理技术，叫做写时复制。" class="headerlink" title="Union File System(UnionFS): 将其他文件系统联合到一个联合挂载点的文件系统服务。它使用branch把不同文件系统的文件和目录透明的覆盖，形成一个单一一致的文件系统，当对这个联合文件系统进行写操作时，系统是真正写到了一个新的文件中，这个虚拟后的联合文件系统是可以对任何文件进行操作的，但是它并没有改变原来的文件，因为unionfs用到了一个重要的资源管理技术，叫做写时复制。"></a>Union File System(UnionFS): 将其他文件系统联合到一个联合挂载点的文件系统服务。它使用branch把不同文件系统的文件和目录透明的覆盖，形成一个单一一致的文件系统，当对这个联合文件系统进行写操作时，系统是真正写到了一个新的文件中，这个虚拟后的联合文件系统是可以对任何文件进行操作的，但是它并没有改变原来的文件，因为unionfs用到了一个重要的资源管理技术，叫做写时复制。</h6><h6 id="写时复制-Copy-on-write-CoW-是一种对可修改的资源实现高校复制的资源管理技术。它的思想是，如果一个资源是重复的没有任何修改，这时并不需要立即创建一个新的资源，这个资源可以被新旧实例共享。创建新资源发生在第一次写操作，也就是对资源进行修改的时候。通过这种资源共享的方式，可以显著地减少未修改资源复制带来的消耗，但是资源也会在进行资源修改时增加小部分的开销。"><a href="#写时复制-Copy-on-write-CoW-是一种对可修改的资源实现高校复制的资源管理技术。它的思想是，如果一个资源是重复的没有任何修改，这时并不需要立即创建一个新的资源，这个资源可以被新旧实例共享。创建新资源发生在第一次写操作，也就是对资源进行修改的时候。通过这种资源共享的方式，可以显著地减少未修改资源复制带来的消耗，但是资源也会在进行资源修改时增加小部分的开销。" class="headerlink" title="写时复制(Copy-on-write,CoW): 是一种对可修改的资源实现高校复制的资源管理技术。它的思想是，如果一个资源是重复的没有任何修改，这时并不需要立即创建一个新的资源，这个资源可以被新旧实例共享。创建新资源发生在第一次写操作，也就是对资源进行修改的时候。通过这种资源共享的方式，可以显著地减少未修改资源复制带来的消耗，但是资源也会在进行资源修改时增加小部分的开销。"></a><strong>写时复制(Copy-on-write,CoW)</strong>: 是一种对可修改的资源实现高校复制的资源管理技术。它的思想是，如果一个资源是重复的没有任何修改，这时并不需要立即创建一个新的资源，这个资源可以被新旧实例共享。创建新资源发生在第一次写操作，也就是对资源进行修改的时候。通过这种资源共享的方式，可以显著地减少未修改资源复制带来的消耗，但是资源也会在进行资源修改时增加小部分的开销。</h6><h2 id="虚拟化技术"><a href="#虚拟化技术" class="headerlink" title="虚拟化技术"></a>虚拟化技术</h2><h3 id="虚拟化分类"><a href="#虚拟化分类" class="headerlink" title="虚拟化分类"></a>虚拟化分类</h3><ul><li><p>SaaS(软件即服务)</p><blockquote><p>SaaS，是Software-as-a-Service的缩写名称，意思为软件即服务，即通过网络提供软件服务；简单来说用户需要使用某款软件直接双击进行运行，无需对软件进行下载安装等等。由SaaS进行提供，例如Office365</p></blockquote><ul><li>各互联网的应用</li></ul></li><li><p>PaaS(平台即服务)</p><blockquote><p>PaaS是（Platform as a Service）的缩写，是指平台即服务。 把服务器平台作为一种服务提供的商业模式，通过网络进行程序提供的服务称之为SaaS;简单来说就是通过互联网提供：(虚拟化)硬件+(各种)软件环境平台，例如做开发无需自行构建系统+编译环境，由PaaS进行提供。</p></blockquote><ul><li>Docker</li><li>LXC</li><li>OpenShitf</li></ul></li><li><p>IaaS(基础设施即服务)</p><blockquote><p>IaaS（Infrastructure as a Service），即基础设施即服务。指把IT基础设施作为一种服务通过网络对外提供；简单来说就是通过网络向用户提供一套基础的硬件设施(CPU、内存、主板、网卡…..)。常见的如阿里云的云服务器，在购买时选择各种的硬件配置…</p></blockquote><ul><li>阿里云ECS</li></ul></li></ul><h3 id="传统虚拟化与容器"><a href="#传统虚拟化与容器" class="headerlink" title="传统虚拟化与容器"></a>传统虚拟化与容器</h3><ul><li>传统虚拟技术：</li></ul><h6 id="通过虚拟化技术模拟出一整套硬件设施，然后在此基础上安装一套完整的操作系统，并在这个系统上面安装和运行软件"><a href="#通过虚拟化技术模拟出一整套硬件设施，然后在此基础上安装一套完整的操作系统，并在这个系统上面安装和运行软件" class="headerlink" title="通过虚拟化技术模拟出一整套硬件设施，然后在此基础上安装一套完整的操作系统，并在这个系统上面安装和运行软件"></a>通过虚拟化技术模拟出一整套硬件设施，然后在此基础上安装一套完整的操作系统，并在这个系统上面安装和运行软件</h6><ul><li>容器技术：</li></ul><h6 id="直接运行在宿主机的内核，容器是没有自己的内核；每个容器都是互相隔离互不影响，每个容器都有自己的文件系统"><a href="#直接运行在宿主机的内核，容器是没有自己的内核；每个容器都是互相隔离互不影响，每个容器都有自己的文件系统" class="headerlink" title="直接运行在宿主机的内核，容器是没有自己的内核；每个容器都是互相隔离互不影响，每个容器都有自己的文件系统"></a>直接运行在宿主机的内核，容器是没有自己的内核；每个容器都是互相隔离互不影响，每个容器都有自己的文件系统</h6><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218065435728-1516959397.png"></p><h1 id="Docker安装部署"><a href="#Docker安装部署" class="headerlink" title="Docker安装部署"></a>Docker安装部署</h1><h2 id="Docker的基本组成"><a href="#Docker的基本组成" class="headerlink" title="Docker的基本组成"></a>Docker的基本组成</h2><ul><li><strong>仓库(Repository)：</strong><ul><li>用于存放镜像的地方；</li><li>仓库分类：<ul><li>公有仓库：Docker_Hub、阿里云等</li><li>私有仓库：自行创建</li></ul></li></ul></li><li><strong>镜像(Image)：</strong><ul><li>Docker镜像类似一个模板，可以通过模板进行创建容器</li><li>一个镜像可以创建多个容器</li></ul></li><li><strong>容器(Container)：</strong><ul><li>利用容器技术，独立运行一个或一组应用，通过镜像来进行创建</li></ul></li></ul><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218065715035-942358671.png"></p><h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><h3 id="准备系统环境"><a href="#准备系统环境" class="headerlink" title="准备系统环境"></a>准备系统环境</h3><ul><li>操作系统<ul><li>操作系统：RedHat8.4(CentOS亦可)</li><li>CPU：x4</li><li>内存：4GB</li><li>内核：4.18.0-305.el8.x86_64</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# uname -a</span><br><span class="line">Linux node1 4.18.0-305.el8.x86_64 #1 SMP Thu Apr 29 08:54:30 EDT 2021 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">[root@node1 ~]# cat /etc/redhat-release</span><br><span class="line">Red Hat Enterprise Linux release 8.4 (Ootpa)</span><br><span class="line">[root@node1 ~]# free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:          3.6Gi       327Mi       3.0Gi       9.0Mi       285Mi       3.1Gi</span><br><span class="line">Swap:         2.0Gi          0B       2.0Gi</span><br><span class="line">[root@node1 ~]# lscpu | grep Core</span><br><span class="line">Core(s) per socket:  4</span><br></pre></td></tr></table></figure><h3 id="卸载旧版本"><a href="#卸载旧版本" class="headerlink" title="卸载旧版本"></a>卸载旧版本</h3><blockquote><p>如果有安装旧版本先进行卸载，我这是全新的系统所以不用执行以下操作</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# dnf remove docker\</span><br><span class="line">docker-client\</span><br><span class="line">docker-client-latest\</span><br><span class="line">docker-common\</span><br><span class="line">docker-latest\</span><br><span class="line">docker-logrotate\</span><br><span class="line">docker-engine</span><br><span class="line"></span><br><span class="line">Updating Subscription Management repositories.</span><br><span class="line">Unable to read consumer identity</span><br><span class="line"></span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line"></span><br><span class="line">No match for argument: dockerdocker-clientdocker-client-latestdocker-commondocker-latestdocker-logrotatedocker-engine</span><br><span class="line">No packages marked for removal.</span><br><span class="line">Dependencies resolved.</span><br><span class="line">Nothing to do.</span><br><span class="line">Complete!</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure><h3 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式"></a>安装方式</h3><blockquote><p>Docker的安装方法有主要有3中，本文档主要介绍在线安装</p></blockquote><ul><li>设置Docker的存储库并从中进行安装，以便后续进行升级</li><li>下载RPM包进行手动安装或升级，在无法访问互联网的情况下使用</li><li>在特殊环境中使用自动化进行安装Docker</li></ul><h3 id="使用存储库进行在线安装"><a href="#使用存储库进行在线安装" class="headerlink" title="使用存储库进行在线安装"></a>使用存储库进行在线安装</h3><ul><li><p>设置存储库</p><blockquote><p>由于国外镜像站速度鸡肋，这里我们使用阿里云的镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">--2021-12-09 01:38:19--  https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">Resolving mirrors.aliyun.com (mirrors.aliyun.com)... 110.188.28.225, 110.188.28.226, 110.188.28.230, ...</span><br><span class="line">Connecting to mirrors.aliyun.com (mirrors.aliyun.com)|110.188.28.225|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 1919 (1.9K) [application/octet-stream]</span><br><span class="line">Saving to: ‘/etc/yum.repos.d/docker-ce.repo’</span><br><span class="line"></span><br><span class="line">/etc/yum.repos.d/docker-ce.re 100%[=================================================&gt;]   1.87K  --.-KB/s    in 0s</span><br><span class="line"></span><br><span class="line">2021-12-09 01:38:19 (53.8 MB/s) - ‘/etc/yum.repos.d/docker-ce.repo’ saved [1919/1919]</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# dnf makecache</span><br><span class="line">Updating Subscription Management repositories.</span><br><span class="line">Unable to read consumer identity</span><br><span class="line"></span><br><span class="line">This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.</span><br><span class="line"></span><br><span class="line">Docker CE Stable - x86_64                                                                12 kB/s |  19 kB     00:01</span><br><span class="line">Metadata cache created.</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>安装Docker引擎</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于我的RedHat8.4存在Podman、cockpit等软件包与Docker有冲突所以加了--allowerasing参数</span></span><br><span class="line">[root@node1 ~]# dnf -y install docker-ce docker-ce-cli containerd.io --allowerasing</span><br><span class="line">  ...</span><br><span class="line">  Verifying        : buildah-1.19.7-1.module+el8.4.0+10607+f4da7515.x86_64                                          6/9</span><br><span class="line">  Verifying        : cockpit-podman-29-2.module+el8.4.0+10607+f4da7515.noarch                                       7/9</span><br><span class="line">  Verifying        : podman-3.0.1-6.module+el8.4.0+10607+f4da7515.x86_64                                            8/9</span><br><span class="line">  Verifying        : podman-catatonit-3.0.1-6.module+el8.4.0+10607+f4da7515.x86_64                                  9/9</span><br><span class="line">Installed products updated.</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  containerd.io-1.4.12-3.1.el8.x86_64 docker-ce-3:20.10.11-3.el8.x86_64 docker-ce-rootless-extras-20.10.11-3.el8.x86_64</span><br><span class="line">  libcgroup-0.41-19.el8.x86_64</span><br><span class="line">Removed:</span><br><span class="line">  buildah-1.19.7-1.module+el8.4.0+10607+f4da7515.x86_64  cockpit-podman-29-2.module+el8.4.0+10607+f4da7515.noarch</span><br><span class="line">  podman-3.0.1-6.module+el8.4.0+10607+f4da7515.x86_64    podman-catatonit-3.0.1-6.module+el8.4.0+10607+f4da7515.x86_64</span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>启动并设置Docker为开机自启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# systemctl enable --now docker</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /usr/lib/systemd/system/docker.service.</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>查看Docker版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker version</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           20.10.11</span><br><span class="line"> API version:       1.41</span><br><span class="line"> Go version:        go1.16.9</span><br><span class="line"> Git commit:        dea9396</span><br><span class="line"> Built:             Thu Nov 18 00:36:58 2021</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Context:           default</span><br><span class="line"> Experimental:      true</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          20.10.11</span><br><span class="line">  API version:      1.41 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.16.9</span><br><span class="line">  Git commit:       847da18</span><br><span class="line">  Built:            Thu Nov 18 00:35:20 2021</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br><span class="line"> containerd:</span><br><span class="line">  Version:          1.4.12</span><br><span class="line">  GitCommit:        7b11cfaabd73bb80907dd23182b9347b4245eb5d</span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.0.2</span><br><span class="line">  GitCommit:        v1.0.2-0-g52b36a2</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.19.0</span><br><span class="line">  GitCommit:        de40ad0</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>测试Docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker run hello-world</span><br><span class="line">Unable to find image &#x27;hello-world:latest&#x27; locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">2db29710123e: Pull complete</span><br><span class="line">Digest: sha256:cc15c5b292d8525effc0f89cb299f1804f3a725c8d05e158653a563f15e4f685</span><br><span class="line">Status: Downloaded newer image for hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此消息显示您的安装似乎工作正常。</span></span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为了生成此消息，Docker采取了以下步骤：</span></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Docker客户端已联系Docker守护程序。</span></span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Docker守护进程从Docker中心提取“hello world”映像。（amd64）</span></span><br><span class="line"> 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Docker守护进程从运行生成当前正在读取的输出的可执行文件。</span></span><br><span class="line"> 3. The Docker daemon created a new container from that image which runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Docker守护进程将该输出流式传输到Docker客户端，后者将其发送到你的终点站</span></span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"><span class="meta prompt_"> $ </span><span class="language-bash">docker run -it ubuntu bash</span></span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/get-started/</span><br><span class="line"></span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li></ul><h2 id="卸载Docker"><a href="#卸载Docker" class="headerlink" title="卸载Docker"></a>卸载Docker</h2><blockquote><p>如需卸载请按照如下步骤</p></blockquote><ul><li><p>卸载 Docker Engine、CLI 和 Containerd 包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf -y remove docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure></li><li><p>主机上的映像、容器、卷或自定义配置文件不会自动删除。删除所有镜像、容器和卷：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/lib/docker</span><br><span class="line">rm -rf /var/lib/containerd</span><br></pre></td></tr></table></figure></li></ul><h1 id="Docker命令"><a href="#Docker命令" class="headerlink" title="Docker命令"></a>Docker命令</h1><blockquote><p>掌握本图片的命令以及常用参数算是掌握Docker常用操作了</p></blockquote><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218065737234-1183832367.png"></p><ul><li><p>帮助命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker version # 显示版本信息</span><br><span class="line">docker info # 显示docker系统详细信息</span><br><span class="line">docker 命令 --help # 显示命令的详细帮助</span><br></pre></td></tr></table></figure></li><li><p>docker命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker命令格式</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker [可选选项] 命令</span></span><br><span class="line">Usage:  docker [OPTIONS] COMMAND</span><br><span class="line"></span><br><span class="line">A self-sufficient runtime for containers</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选项</span></span><br><span class="line">Options:</span><br><span class="line">     # 客户端配置文件地址(默认在&quot;/root/.docker&quot;)</span><br><span class="line">      --config string      Location of client config files (default &quot;/root/.docker&quot;)</span><br><span class="line">         # 用于连接到守护进程的上下文的名称</span><br><span class="line">  -c, --context string     Name of the context to use to connect to the daemon (overrides DOCKER_HOST env var and</span><br><span class="line">                           default context set with &quot;docker context use&quot;)</span><br><span class="line">                           # 开启调试模式</span><br><span class="line">  -D, --debug              Enable debug mode</span><br><span class="line">     # 连接到的守护程序套接字</span><br><span class="line">  -H, --host list          Daemon socket(s) to connect to</span><br><span class="line">     # 设置日志记录级别（“调试”|“信息”|“警告”|“错误”|“致命”）（默认为“信息”）</span><br><span class="line">  -l, --log-level string   Set the logging level (&quot;debug&quot;|&quot;info&quot;|&quot;warn&quot;|&quot;error&quot;|&quot;fatal&quot;) (default &quot;info&quot;)</span><br><span class="line">   # 使用TLS证书</span><br><span class="line">  --tls                Use TLS; implied by --tlsverify</span><br><span class="line">         # 仅由此CA签署的信任证书</span><br><span class="line">      --tlscacert string   Trust certs signed only by this CA (default &quot;/root/.docker/ca.pem&quot;)</span><br><span class="line">   # TLS证书文件的路径(默认在&quot;/root/.docker/cert.pem&quot;)</span><br><span class="line">  --tlscert string     Path to TLS certificate file (default &quot;/root/.docker/cert.pem&quot;)</span><br><span class="line">     # TLS密钥文件的路径(默认在&quot;/root/.docker/key.pem&quot;)</span><br><span class="line">      --tlskey string      Path to TLS key file (default &quot;/root/.docker/key.pem&quot;)</span><br><span class="line">         # 使用TLS并验证远程</span><br><span class="line">      --tlsverify          Use TLS and verify the remote</span><br><span class="line">         # 打印版本信息并退出</span><br><span class="line">  -v, --version            Print version information and quit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">管理命令</span></span><br><span class="line">Management Commands:</span><br><span class="line">  app*        Docker App (Docker Inc., v0.9.1-beta3)# Docker应用</span><br><span class="line">  builder     Manage builds# 管理构建</span><br><span class="line">  buildx*     Build with BuildKit (Docker Inc., v0.6.3-docker)# 使用BuildKit构建</span><br><span class="line">  config      Manage Docker configs# 管理Docker配置</span><br><span class="line">  container   Manage containers #管理容器</span><br><span class="line">  context     Manage contexts # 管理上下文</span><br><span class="line">  image       Manage images# 管理镜像</span><br><span class="line">  manifest    Manage Docker image manifests and manifest lists # 管理Docker映像清单和清单列表</span><br><span class="line">  network     Manage networks# 管理网络</span><br><span class="line">  node        Manage Swarm nodes# 管理群集节点</span><br><span class="line">  plugin      Manage plugins # 管理插件</span><br><span class="line">  scan*       Docker Scan (Docker Inc., v0.9.0) # Docker扫描</span><br><span class="line">  secret      Manage Docker secrets # 管理Docker机密</span><br><span class="line">  service     Manage services # 管理服务</span><br><span class="line">  stack       Manage Docker stacks # 管理Docker堆栈</span><br><span class="line">  swarm       Manage Swarm # 管理群集</span><br><span class="line">  system      Manage Docker # 管理Docker</span><br><span class="line">  trust       Manage trust on Docker images # 管理对Docker映像的信任</span><br><span class="line">  volume      Manage volumes # 管理卷</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令</span></span><br><span class="line">Commands:</span><br><span class="line">  # 将本地标准输入、输出和错误流附加到正在运行的容器</span><br><span class="line">  attach      Attach local standard input, output, and error streams to a running container</span><br><span class="line">  build       Build an image from a Dockerfile# 从Dockerfile生成映像</span><br><span class="line">  commit      Create a new image from a container&#x27;s changes # 根据容器的更改创建新图像</span><br><span class="line">    # 在容器和本地文件系统之间复制文件/文件夹</span><br><span class="line">  cp          Copy files/folders between a container and the local filesystem</span><br><span class="line">  create      Create a new container # 创建一个新容器</span><br><span class="line">    # 检查对容器文件系统上的文件或目录的更改</span><br><span class="line">  diff        Inspect changes to files or directories on a container&#x27;s filesystem</span><br><span class="line">  events      Get real time events from the server  # 从服务器获取实时事件</span><br><span class="line">  exec        Run a command in a running container# 在正在运行的容器中运行命令</span><br><span class="line">  export      Export a container&#x27;s filesystem as a tar archive# 将容器的文件系统导出为tar归档</span><br><span class="line">  history     Show the history of an image# 显示镜像的历史记录</span><br><span class="line">  images      List images# 列出镜像</span><br><span class="line">  import      Import the contents from a tarball to create a filesystem image# 从tarball导入内容以创建文件系统映像</span><br><span class="line">  info        Display system-wide information# 显示系统范围的信息</span><br><span class="line">  inspect     Return low-level information on Docker objects# 返回有关Docker对象的低级信息</span><br><span class="line">  kill        Kill one or more running containers# 杀死一个或多个正在运行的容器</span><br><span class="line">  load        Load an image from a tar archive or STDIN# 从tar存档或STDIN加载镜像</span><br><span class="line">  login       Log in to a Docker registry# 登录到Docker注册表</span><br><span class="line">  logout      Log out from a Docker registry# 从Docker注册表注销</span><br><span class="line">  logs        Fetch the logs of a container# 获取容器的日志</span><br><span class="line">  pause       Pause all processes within one or more containers# 暂停一个或多个容器中的所有进程</span><br><span class="line">  port        List port mappings or a specific mapping for the container# 列出容器的端口映射或特定映射</span><br><span class="line">  ps          List containers# 列出容器</span><br><span class="line">  pull        Pull an image or a repository from a registry# 从注册表中提取镜像或存储库</span><br><span class="line">  push        Push an image or a repository to a registry# 将镜像或存储库推送到注册表</span><br><span class="line">  rename      Rename a container# 重命名容器</span><br><span class="line">  restart     Restart one or more containers# 重新启动一个或多个容器</span><br><span class="line">  rm          Remove one or more containers# 移除一个或多个容器</span><br><span class="line">  rmi         Remove one or more images# 删除一个或多个镜像</span><br><span class="line">  run         Run a command in a new container# 在新容器中运行命令</span><br><span class="line">    # 将一个或多个镜像保存到tar存档（默认情况下流式传输到stdout）</span><br><span class="line">  save        Save one or more images to a tar archive (streamed to STDOUT by default)</span><br><span class="line">  search      Search the Docker Hub for images# 在Docker Hub中搜索镜像</span><br><span class="line">  start       Start one or more stopped containers# 启动一个或多个停止的容器</span><br><span class="line">  stats       Display a live stream of container(s) resource usage statistics# 显示容器资源使用统计信息的实时流</span><br><span class="line">  stop        Stop one or more running containers# 停止一个或多个正在运行的容器</span><br><span class="line">  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE# 创建引用源镜像的标记目标镜像;给镜像打标签</span><br><span class="line">  top         Display the running processes of a container# 显示容器的运行进程</span><br><span class="line">  unpause     Unpause all processes within one or more containers# 取消暂停一个或多个容器中的所有进程</span><br><span class="line">  update      Update configuration of one or more containers# 更新一个或多个容器的配置</span><br><span class="line">  version     Show the Docker version information# 显示Docker版本信息</span><br><span class="line">              # 阻止，直到一个或多个容器停止，然后打印其出口代码</span><br><span class="line">  wait        Block until one or more containers stop, then print their exit codes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有关命令的详细信息，请运行“docker 命令 --<span class="built_in">help</span>”。</span></span><br><span class="line">Run &#x27;docker COMMAND --help&#x27; for more information on a command.</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li></ul><h2 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h2><ul><li><p>docker images</p><blockquote><p>查询本地所有的镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker images</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">存储库标签 镜像ID   创建时间        大小</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello-world   latest    feb5d9fea6a5   2 months ago   13.3kB</span><br><span class="line">[root@node1 ~]# docker images --help</span><br><span class="line"></span><br><span class="line">Usage:  docker images [OPTIONS] [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">List images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --all             Show all images (default hides intermediate images)# 显示所有镜像</span><br><span class="line">      --digests         Show digests# 显示摘要</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided</span><br><span class="line">      --format string   Pretty-print images using a Go template# 根据提供的条件筛选输出</span><br><span class="line">      --no-trunc        Don&#x27;t truncate output# 不要截断输出</span><br><span class="line">  -q, --quiet           Only show image IDs# 仅显示镜像ID</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>docker search</p><blockquote><p>搜索镜像命令</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker search nginx</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">镜像名称    描述   星星正式的自动化</span></span><br><span class="line">NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">nginx                             Official build of Nginx.                        15928     [OK]</span><br><span class="line">jwilder/nginx-proxy               Automated Nginx reverse proxy for docker con…   2101                 [OK]</span><br><span class="line">richarvey/nginx-php-fpm           Container running Nginx + PHP-FPM capable of…   820                  [OK]</span><br><span class="line">jc21/nginx-proxy-manager          Docker container for managing Nginx proxy ho…   288</span><br><span class="line">linuxserver/nginx                 An Nginx container, brought to you by LinuxS…   160</span><br><span class="line">tiangolo/nginx-rtmp               Docker image with Nginx using the nginx-rtmp…   147                  [OK]</span><br><span class="line">jlesage/nginx-proxy-manager       Docker container for Nginx Proxy Manager        145                  [OK]</span><br><span class="line">alfg/nginx-rtmp                   NGINX, nginx-rtmp-module and FFmpeg from sou…   111                  [OK]</span><br><span class="line">nginxdemos/hello                  NGINX webserver that serves a simple page co…   79                   [OK]</span><br><span class="line">privatebin/nginx-fpm-alpine       PrivateBin running on an Nginx, php-fpm &amp; Al…   61                   [OK]</span><br><span class="line">nginx/nginx-ingress               NGINX and  NGINX Plus Ingress Controllers fo…   57</span><br><span class="line">nginxinc/nginx-unprivileged       Unprivileged NGINX Dockerfiles                  55</span><br><span class="line">nginxproxy/nginx-proxy            Automated Nginx reverse proxy for docker con…   29</span><br><span class="line">staticfloat/nginx-certbot         Opinionated setup for automatic TLS certs lo…   25                   [OK]</span><br><span class="line">nginx/nginx-prometheus-exporter   NGINX Prometheus Exporter for NGINX and NGIN…   22</span><br><span class="line">schmunk42/nginx-redirect          A very simple container to redirect HTTP tra…   19                   [OK]</span><br><span class="line">centos/nginx-112-centos7          Platform for running nginx 1.12 or building …   16</span><br><span class="line">centos/nginx-18-centos7           Platform for running nginx 1.8 or building n…   13</span><br><span class="line">bitwarden/nginx                   The Bitwarden nginx web server acting as a r…   11</span><br><span class="line">flashspys/nginx-static            Super Lightweight Nginx Image                   11                   [OK]</span><br><span class="line">mailu/nginx                       Mailu nginx frontend                            9                    [OK]</span><br><span class="line">sophos/nginx-vts-exporter         Simple server that scrapes Nginx vts stats a…   7                    [OK]</span><br><span class="line">ansibleplaybookbundle/nginx-apb   An APB to deploy NGINX                          3                    [OK]</span><br><span class="line">wodby/nginx                       Generic nginx                                   1                    [OK]</span><br><span class="line">arnau/nginx-gate                  Docker image with Nginx with Lua enabled on …   1                    [OK]</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker search --help</span><br><span class="line"></span><br><span class="line">Usage:  docker search [OPTIONS] TERM</span><br><span class="line"></span><br><span class="line">Search the Docker Hub for images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided# 根据提供的条件筛选输出</span><br><span class="line">      --format string   Pretty-print search using a Go template</span><br><span class="line">      --limit int       Max number of search results (default 25)# 最大搜索结果数（默认值25）</span><br><span class="line">      --no-trunc        Don&#x27;t truncate output# 不要截断输出</span><br><span class="line">      </span><br><span class="line">[root@node1 ~]# docker search tomcat -f STARS=1000# 根据条件进行筛选</span><br><span class="line">NAME      DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">tomcat    Apache Tomcat is an open source implementati…   3193      [OK]</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>docker pull</p><blockquote><p>下载镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker pull</span><br><span class="line">&quot;docker pull&quot; requires exactly 1 argument.</span><br><span class="line">See &#x27;docker pull --help&#x27;.</span><br><span class="line"></span><br><span class="line">Usage:  docker pull [OPTIONS] NAME[:TAG|@DIGEST]</span><br><span class="line"></span><br><span class="line">Pull an image or a repository from a registry</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker pull --help</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用法: docker pull [选项] NAME[:Tag|@DIGEST]<span class="comment"># []表示可选可不选</span></span> </span><br><span class="line">Usage:  docker pull [OPTIONS] NAME[:TAG|@DIGEST]</span><br><span class="line"></span><br><span class="line">Pull an image or a repository from a registry</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --all-tags                Download all tagged images in the repository# 下载存储库中所有标记的镜像</span><br><span class="line">      --disable-content-trust   Skip image verification (default true) # 跳过镜像验证（默认为开启）</span><br><span class="line">      # 如果服务器支持多平台，则设置平台</span><br><span class="line">      --platform string         Set platform if server is multi-platform capable</span><br><span class="line">  -q, --quiet                   Suppress verbose output# 抑制详细输出</span><br><span class="line">  </span><br><span class="line">[root@node1 ~]#</span><br><span class="line">[root@node1 ~]# docker pull mysql</span><br><span class="line">Using default tag: latest# 使用默认标记：最新</span><br><span class="line">latest: Pulling from library/mysql# 最新版本：从库/mysql中提取</span><br><span class="line">ffbb094f4f9e: Pull complete# 分层下载，Docker的核心，联合文件系统</span><br><span class="line">df186527fc46: Pull complete</span><br><span class="line">fa362a6aa7bd: Pull complete</span><br><span class="line">5af7cb1a200e: Pull complete</span><br><span class="line">949da226cc6d: Pull complete</span><br><span class="line">bce007079ee9: Pull complete</span><br><span class="line">eab9f076e5a3: Pull complete</span><br><span class="line">8a57a7529e8d: Pull complete</span><br><span class="line">b1ccc6ed6fc7: Pull complete</span><br><span class="line">b4af75e64169: Pull complete</span><br><span class="line">3aed6a9cd681: Pull complete</span><br><span class="line">23390142f76f: Pull complete</span><br><span class="line">Digest: sha256:ff9a288d1ecf4397967989b5d1ec269f7d9042a46fc8bc2c3ae35458c1a26727# 摘要校验</span><br><span class="line">Status: Downloaded newer image for mysql:latest# 状态：已下载mysql的较新镜像：最新</span><br><span class="line">docker.io/library/mysql:latest# 真实地址</span><br><span class="line">[root@node1 ~]#</span><br><span class="line">[root@node1 ~]# docker pull mysql:5.7# 指定版本下载,一定是官方有支持的版本！</span><br><span class="line">5.7: Pulling from library/mysql</span><br><span class="line">ffbb094f4f9e: Already exists# Already exists表示已经存在</span><br><span class="line">df186527fc46: Already exists</span><br><span class="line">fa362a6aa7bd: Already exists</span><br><span class="line">5af7cb1a200e: Already exists</span><br><span class="line">949da226cc6d: Already exists</span><br><span class="line">bce007079ee9: Already exists</span><br><span class="line">eab9f076e5a3: Already exists</span><br><span class="line">c7b24c3f27af: Pull complete</span><br><span class="line">6fc26ff6705a: Downloading [=============&gt;                                     ]   29.4MB/108.6MB</span><br><span class="line">6fc26ff6705a: Pull complete</span><br><span class="line">bec5cdb5e7f7: Pull complete</span><br><span class="line">6c1cb25f7525: Pull complete</span><br><span class="line">Digest: sha256:d1cc87a3bd5dc07defc837bc9084f748a130606ff41923f46dec1986e0dc828d</span><br><span class="line">Status: Downloaded newer image for mysql:5.7</span><br><span class="line">docker.io/library/mysql:5.7</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>docker images</p><blockquote><p>查看本机镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker images</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">存储库<span class="comment">#标签#镜像ID  # 创建时间# 大小</span></span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">mysql         5.7       738e7101490b   8 days ago     448MB</span><br><span class="line">mysql         latest    bbf6571db497   8 days ago     516MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   2 months ago   13.3kB</span><br><span class="line">[root@node1 ~]#</span><br><span class="line">[root@node1 ~]# docker images --help</span><br><span class="line"></span><br><span class="line">Usage:  docker images [OPTIONS] [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">List images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"># 显示所有镜像（默认隐藏中间镜像）</span><br><span class="line">  -a, --all             Show all images (default hides intermediate images)</span><br><span class="line">      --digests         Show digests# 显示摘要</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided# 根据提供的条件筛选输出</span><br><span class="line">      --format string   Pretty-print images using a Go template# 使用Go模板打印镜像</span><br><span class="line">      --no-trunc        Don&#x27;t truncate output# 不要截断输出</span><br><span class="line">  -q, --quiet           Only show image IDs# 仅显示镜像ID</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li><li><p>docker rmi</p><blockquote><p>删除镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker images# 查询镜像</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">mysql         5.7       738e7101490b   8 days ago     448MB</span><br><span class="line">mysql         latest    bbf6571db497   8 days ago     516MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   2 months ago   13.3kB</span><br><span class="line">[root@node1 ~]# docker rmi 738# 删除镜像id为738开头的</span><br><span class="line">Untagged: mysql:5.7</span><br><span class="line">Untagged: mysql@sha256:d1cc87a3bd5dc07defc837bc9084f748a130606ff41923f46dec1986e0dc828d</span><br><span class="line">Deleted: sha256:738e7101490b45decf606211a5437ed87aa6a82f1ff03c354564bf9375ce20f9</span><br><span class="line">Deleted: sha256:addad8cfeac97b96eb6652a576269346ac96def9a6709ed2388e24fff4345837</span><br><span class="line">Deleted: sha256:e288c3439a7e2f423f50bf22979a759371c51a70bbbaa450993c336978460b1a</span><br><span class="line">Deleted: sha256:33ece15accaa3bb20e3dee84e2e4501469b917c3abba3d5475cd1fec8bb3e82c</span><br><span class="line">Deleted: sha256:6b15390bceeca8424d82e75f5c9aca5eb4693f96849d6382168a99747877693d</span><br><span class="line">[root@node1 ~]# docker images# 查询镜像发现镜像id738开头的mysql5.7已经被删除了</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">mysql         latest    bbf6571db497   8 days ago     516MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   2 months ago   13.3kB</span><br><span class="line">[root@node1 ~]#</span><br><span class="line">[root@node1 ~]# docker rmi --help</span><br><span class="line"></span><br><span class="line">Usage:  docker rmi [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line"></span><br><span class="line">Remove one or more images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --force      Force removal of the image# 强制删除镜像</span><br><span class="line">      --no-prune   Do not delete untagged parents# 不要删除未标记的父项</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量删除所有镜像 $(将查询出镜像作为rmi的输入)</span></span><br><span class="line">[root@node1 ~]# docker rmi -f $(docker images -qa)</span><br><span class="line">Untagged: mysql:latest</span><br><span class="line">Untagged: mysql@sha256:ff9a288d1ecf4397967989b5d1ec269f7d9042a46fc8bc2c3ae35458c1a26727</span><br><span class="line">Deleted: sha256:bbf6571db4977fe13c3f4e6289c1409fc6f98c2899eabad39bfe07cad8f64f67</span><br><span class="line">Deleted: sha256:a72da99dce60d6f8d4c4cffa4173153c990537fcdfaa27c35324c3348d55dd5c</span><br><span class="line">Deleted: sha256:8b535d432ef2fbd45d93958347b2587c5cbe334f07d6909ad9d2d480ebbafb65</span><br><span class="line">Deleted: sha256:14d13a3b33fc76839f156cd24b4636dab121e6d3d026cefa2985a4b89e9d4df8</span><br><span class="line">Deleted: sha256:77c21a5a897a1ba752f3d742d6c94ee7c6b0e373fd0aeecc4bf88b9a3982007e</span><br><span class="line">Deleted: sha256:189162becec8bb4588c54fb4ea7e62d20121812e68aeb0291fb4bb5df9ec0985</span><br><span class="line">Deleted: sha256:34980dadfd6a5bb9d7f9e8d4e408000e0a8f4840cc7d3092dc94357ebe7a89b6</span><br><span class="line">Deleted: sha256:15b2beb64a91785c8f3709ecd2410d13577b3174faad164524434ce6a7633506</span><br><span class="line">Deleted: sha256:e38dd14d47b61171927ea4b928f7296123b65a81ad1cfde8f5d00cadf1e81bbb</span><br><span class="line">Deleted: sha256:865abdfd8444741f581ce582e4ac5746c4a00c282febf65aa808a235ec7abf78</span><br><span class="line">Deleted: sha256:b1e35233e1ac953bd06fc8fa83afb3a88c39c1aeae0c89a46cb1b652d6821b38</span><br><span class="line">Deleted: sha256:3bcfdf6641227ff63e3ddf9e38e45cf317b178a50a664e45c6ae596107d5bc46</span><br><span class="line">Deleted: sha256:f11bbd657c82c45cc25b0533ce72f193880b630352cc763ed0c045c808ff9ae1</span><br><span class="line">Untagged: hello-world:latest</span><br><span class="line">Untagged: hello-world@sha256:cc15c5b292d8525effc0f89cb299f1804f3a725c8d05e158653a563f15e4f685</span><br><span class="line">Deleted: sha256:feb5d9fea6a5e9606aa995e879d862b825965ba48de054caab5ef356dc6b3412</span><br><span class="line">[root@node1 ~]#</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除多个镜像</span></span><br><span class="line">[root@node1 ~]# docker rmi 镜像id1 镜像id2 ...</span><br></pre></td></tr></table></figure></li></ul><h2 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h2><blockquote><p>在创建容器之前，得先下载一个镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker pull centos</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">a1d0c7532777: Pull complete</span><br><span class="line">Digest: sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span><br><span class="line">Status: Downloaded newer image for centos:latest</span><br><span class="line">docker.io/library/centos:latest</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure><ul><li><p>docker run</p><blockquote><p>运行容器</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker run --help</span><br><span class="line"></span><br><span class="line">Usage:  docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br><span class="line"></span><br><span class="line">Run a command in a new container</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --add-host list                  Add a custom host-to-IP mapping (host:ip)# 添加自定义主机到IP映射（主机：IP）</span><br><span class="line">  -a, --attach list                    Attach to STDIN, STDOUT or STDERR# 连接到标准输入、标准输出或标准输出</span><br><span class="line">     # 块IO（相对权重），介于10和1000之间，或0禁用（默认为0）</span><br><span class="line">      --blkio-weight uint16            Block IO (relative weight), between 10 and 1000, or 0 to disable (default 0)</span><br><span class="line">         # 块IO权重（相对设备权重）（默认值[]）</span><br><span class="line">      --blkio-weight-device list       Block IO weight (relative device weight) (default [])</span><br><span class="line">      --cap-add list                   Add Linux capabilities# 添加Linux功能</span><br><span class="line">      --cap-drop list                  Drop Linux capabilities# 放弃Linux功能</span><br><span class="line">      --cgroup-parent string           Optional parent cgroup for the container# 容器的可选父cgroup</span><br><span class="line">      --cgroupns string                Cgroup namespace to use (host|private)# 要使用的Cgroup命名空间（主机|专用）</span><br><span class="line">         # 在Docker主机的cgroup命名空间中运行容器</span><br><span class="line">                                       &#x27;host&#x27;:    Run the container in the Docker host&#x27;s cgroup namespace</span><br><span class="line">                                       # 在其自己的私有cgroup命名空间中运行容器</span><br><span class="line">                                       &#x27;private&#x27;: Run the container in its own private cgroup namespace</span><br><span class="line">                                       # 使用由配置的cgroup命名空间守护进程上的默认cgroupns模式选项（默认）</span><br><span class="line">                                       &#x27;&#x27;:        Use the cgroup namespace as configured by the</span><br><span class="line">                                                  default-cgroupns-mode option on the daemon (default)</span><br><span class="line">      --cidfile string                 Write the container ID to the file# 将容器ID写入文件</span><br><span class="line">         # 限制CPU CFS（完全公平调度程序）周期</span><br><span class="line">      --cpu-period int                 Limit CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">         # 限制CPU CFS（完全公平调度程序）配额</span><br><span class="line">      --cpu-quota int                  Limit CPU CFS (Completely Fair Scheduler) quota</span><br><span class="line">         # 以微秒为单位限制CPU实时周期</span><br><span class="line">      --cpu-rt-period int              Limit CPU real-time period in microseconds</span><br><span class="line">         # 以微秒为单位限制CPU实时运行时间</span><br><span class="line">      --cpu-rt-runtime int             Limit CPU real-time runtime in microseconds</span><br><span class="line">  -c, --cpu-shares int                 CPU shares (relative weight)# CPU份额（相对权重）</span><br><span class="line">      --cpus decimal                   Number of CPUs# CPU数量</span><br><span class="line">      --cpuset-cpus string             CPUs in which to allow execution (0-3, 0,1)# 允许执行的CPU（0-3,0,1）</span><br><span class="line">      --cpuset-mems string             MEMs in which to allow execution (0-3, 0,1)# 允许执行的MEMs（0-3,0,1）</span><br><span class="line">  -d, --detach                         Run container in background and print container ID# 在后台运行容器并打印容器ID</span><br><span class="line">     # 覆盖用于分离容器的键序列</span><br><span class="line">      --detach-keys string             Override the key sequence for detaching a container</span><br><span class="line">         # 将主机设备添加到容器中</span><br><span class="line">      --device list                    Add a host device to the container</span><br><span class="line">         # 将规则添加到cgroup allowed devices列表</span><br><span class="line">      --device-cgroup-rule list        Add a rule to the cgroup allowed devices list</span><br><span class="line">         # 限制设备的读取速率（每秒字节数）（默认值[]）</span><br><span class="line">      --device-read-bps list           Limit read rate (bytes per second) from a device (default [])</span><br><span class="line">         # 限制设备的读取速率（IO/秒）（默认值[]）</span><br><span class="line">      --device-read-iops list          Limit read rate (IO per second) from a device (default [])</span><br><span class="line">         # 限制对设备的写入速率（每秒字节数）（默认值[]）</span><br><span class="line">      --device-write-bps list          Limit write rate (bytes per second) to a device (default [])</span><br><span class="line">         # 限制对设备的写入速率（IO/秒）（默认值[]）</span><br><span class="line">      --device-write-iops list         Limit write rate (IO per second) to a device (default [])</span><br><span class="line">         # 跳过镜像验证（默认为开启）</span><br><span class="line">      --disable-content-trust          Skip image verification (default true)</span><br><span class="line">      --dns list                       Set custom DNS servers# 设置自定义DNS服务器</span><br><span class="line">      --dns-option list                Set DNS options# 设置DNS选项</span><br><span class="line">      --dns-search list                Set custom DNS search domains# 设置自定义DNS搜索域</span><br><span class="line">      --domainname string              Container NIS domain name# 容器NIS域名</span><br><span class="line">      --entrypoint string              Overwrite the default ENTRYPOINT of the image# 覆盖图像的默认入口点</span><br><span class="line">  -e, --env list                       Set environment variables# 设置环境变量</span><br><span class="line">      --env-file list                  Read in a file of environment variables# 读入环境变量文件</span><br><span class="line">      --expose list                    Expose a port or a range of ports# 公开一个端口或一系列端口</span><br><span class="line">         # 要添加到容器中的GPU设备（“全部”用于传递所有GPU）</span><br><span class="line">      --gpus gpu-request               GPU devices to add to the container (&#x27;all&#x27; to pass all GPUs)</span><br><span class="line">      --group-add list                 Add additional groups to join# 添加要加入的其他组</span><br><span class="line">      --health-cmd string              Command to run to check health# 要运行以检查运行状况的命令</span><br><span class="line">         # 运行检查之间的时间（ms | s | m | h）（默认为0秒）</span><br><span class="line">      --health-interval duration       Time between running the check (ms|s|m|h) (default 0s)</span><br><span class="line">      --health-retries int             Consecutive failures needed to report unhealthy# 需要报告连续故障</span><br><span class="line">      --health-start-period duration   Start period for the container to initialize before starting health-retries countdown (ms|s|m|h) (default 0s)# 开始运行状况重试倒计时之前要初始化的容器的开始时间（ms | s | m | h）（默认为0s）</span><br><span class="line">         # 允许运行一次检查的最长时间（ms | s | m | h）（默认为0秒）</span><br><span class="line">      --health-timeout duration        Maximum time to allow one check to run (ms|s|m|h) (default 0s)</span><br><span class="line">      --help                           Print usage# 打印使用帮助</span><br><span class="line">  -h, --hostname string                Container host name# 容器主机名</span><br><span class="line">     # 在容器内运行一个init，它转发信号并接收进程</span><br><span class="line">      --init                           Run an init inside the container that forwards signals and reaps processes</span><br><span class="line">         # 即使未连接，也保持标准输入打开</span><br><span class="line">  -i, --interactive                    Keep STDIN open even if not attached</span><br><span class="line">      --ip string                      IPv4 address (e.g., 172.30.100.104)# IPv4地址（例如172.30.100.104）</span><br><span class="line">      --ip6 string                     IPv6 address (e.g., 2001:db8::33)# IPv6地址（例如，2001:db8:：33）</span><br><span class="line">      --ipc string                     IPC mode to use# 要使用的IPC模式</span><br><span class="line">      --isolation string               Container isolation technology# 容器隔离技术</span><br><span class="line">      --kernel-memory bytes            Kernel memory limit# 内核内存限制</span><br><span class="line">  -l, --label list                     Set meta data on a container# 在容器上设置元数据</span><br><span class="line">      --label-file list                Read in a line delimited file of labels# 读入以行分隔的标签文件</span><br><span class="line">      --link list                      Add link to another container# 添加指向另一个容器的链接</span><br><span class="line">      --link-local-ip list             Container IPv4/IPv6 link-local addresses# 容器IPv4/IPv6链路本地地址</span><br><span class="line">      --log-driver string              Logging driver for the container# 容器的日志记录驱动程序</span><br><span class="line">      --log-opt list                   Log driver options# 日志驱动程序选项</span><br><span class="line">      --mac-address string             Container MAC address (e.g., 92:d0:c6:0a:29:33)# 容器MAC地址（例如，92:d0:c6:0a:29:33）</span><br><span class="line">  -m, --memory bytes                   Memory limit# 内存限制</span><br><span class="line">      --memory-reservation bytes       Memory soft limit# 内存软限制</span><br><span class="line">         # 交换限制等于内存加交换：&#x27;-1&#x27;以启用无限制交换</span><br><span class="line">      --memory-swap bytes              Swap limit equal to memory plus swap: &#x27;-1&#x27; to enable unlimited swap</span><br><span class="line">         # 调整容器内存交换（0到100）（默认值-1）</span><br><span class="line">      --memory-swappiness int          Tune container memory swappiness (0 to 100) (default -1)</span><br><span class="line">      --mount mount                    Attach a filesystem mount to the container# 将文件系统装载附加到容器</span><br><span class="line">      --name string                    Assign a name to the container# 为容器指定一个名称</span><br><span class="line">      --network network                Connect a container to a network# 将容器连接到网络</span><br><span class="line">      --network-alias list             Add network-scoped alias for the container# 为容器添加网络范围的别名</span><br><span class="line">      --no-healthcheck                 Disable any container-specified HEALTHCHECK# 禁用任何指定的容器HEALTHCHECK</span><br><span class="line">      --oom-kill-disable               Disable OOM Killer# 禁用OOM杀手</span><br><span class="line">      --oom-score-adj int              Tune host&#x27;s OOM preferences (-1000 to 1000)# 调整主机的OOM首选项（-1000到1000）</span><br><span class="line">      --pid string                     PID namespace to use# 要使用的PID命名空间</span><br><span class="line">      --pids-limit int                 Tune container pids limit (set -1 for unlimited)# 调整容器pids限制（设置为-1表示无限制）</span><br><span class="line">      --platform string                Set platform if server is multi-platform capable# 如果服务器支持多平台，则设置平台</span><br><span class="line">      --privileged                     Give extended privileges to this container# 为此容器授予扩展权限</span><br><span class="line">  -p, --publish list                   Publish a container&#x27;s port(s) to the host# 将容器的端口发布到主机</span><br><span class="line">  -P, --publish-all                    Publish all exposed ports to random ports# 将所有公开端口发布到随机端口</span><br><span class="line">     # 运行前拉取图像（“始终”|“缺少”|“从不”）（默认为“缺少”）</span><br><span class="line">      --pull string                    Pull image before running (&quot;always&quot;|&quot;missing&quot;|&quot;never&quot;) (default &quot;missing&quot;)</span><br><span class="line">      --read-only                      Mount the container&#x27;s root filesystem as read only# 以只读方式装载容器的根文件系统</span><br><span class="line">         # 容器退出时应用的重新启动策略（默认为“否”）</span><br><span class="line">      --restart string                 Restart policy to apply when a container exits (default &quot;no&quot;)</span><br><span class="line">      --rm                             Automatically remove the container when it exits# 当容器退出时自动将其移除</span><br><span class="line">      --runtime string                 Runtime to use for this container# 用于此容器的运行时</span><br><span class="line">      --security-opt list              Security Options# 安全选项</span><br><span class="line">      --shm-size bytes                 Size of /dev/shm# /dev/shm的大小</span><br><span class="line">      --sig-proxy                      Proxy received signals to the process (default true)# 代理接收到进程的信号（默认为true）</span><br><span class="line">      --stop-signal string             Signal to stop a container (default &quot;SIGTERM&quot;)# 停止容器的信号（默认为“SIGTERM”）</span><br><span class="line">      --stop-timeout int               Timeout (in seconds) to stop a container# 停止容器的超时（秒）</span><br><span class="line">      --storage-opt list               Storage driver options for the container# 容器的存储驱动程序选项</span><br><span class="line">      --sysctl map                     Sysctl options (default map[])# Sysctl选项（默认映射[]）</span><br><span class="line">      --tmpfs list                     Mount a tmpfs directory# 安装tmpfs</span><br><span class="line">  -t, --tty                            Allocate a pseudo-TTY# 分配一个伪TTY</span><br><span class="line">      --ulimit ulimit                  Ulimit options (default [])# Ulimit选项（默认值[]）</span><br><span class="line">         # 用户名或UID（格式：&lt;name | UID&gt;[：&lt;group | gid&gt;）</span><br><span class="line">  -u, --user string                    Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])</span><br><span class="line">      --userns string                  User namespace to use# 要使用的用户命名空间</span><br><span class="line">      --uts string                     UTS namespace to use# 要使用的名称空间</span><br><span class="line">  -v, --volume list                    Bind mount a volume# 绑定并装入卷</span><br><span class="line">      --volume-driver string           Optional volume driver for the container# 容器的可选卷驱动程序</span><br><span class="line">      --volumes-from list              Mount volumes from the specified container(s)# 从指定容器装入卷</span><br><span class="line">  -w, --workdir string                 Working directory inside the container# 容器内的工作目录</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">常用参数</span></span><br><span class="line">--name=&#x27;xxx&#x27;  设置容器名称用于区分容器</span><br><span class="line">-d后台运行</span><br><span class="line">-it使用交互方式运行</span><br><span class="line">-p指定容器端口 -p 8080:8080/主机端口:容器端口</span><br><span class="line">-P随机指定端口</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">示例</span></span><br><span class="line">[root@node1 ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">centos       latest    5d0da3dc9764   2 months ago   231MB</span><br><span class="line">[root@node1 ~]# docker run -it 5d /bin/bash</span><br><span class="line">[root@b267d2d19ef4 /]#  # 已经进入到容器</span><br><span class="line">[root@b267d2d19ef4 /]# exit</span><br></pre></td></tr></table></figure></li><li><p>docker ps</p><blockquote><p>列出所有运行中的容器</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker ps --help</span><br><span class="line"></span><br><span class="line">Usage:  docker ps [OPTIONS]</span><br><span class="line"></span><br><span class="line">List containers</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --all             Show all containers (default shows just running)# 显示所有容器（默认显示正在运行）</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided# 根据提供的条件筛选输出</span><br><span class="line">      --format string   Pretty-print containers using a Go template</span><br><span class="line">      # 显示n个上次创建的容器（包括所有状态）（默认值-1）</span><br><span class="line">  -n, --last int        Show n last created containers (includes all states) (default -1)</span><br><span class="line">  -l, --latest          Show the latest created container (includes all states)# 显示最新创建的容器（包括所有状态）</span><br><span class="line">      --no-trunc        Don&#x27;t truncate output# 不要截断输出</span><br><span class="line">  -q, --quiet           Only display container IDs# 仅显示容器ID</span><br><span class="line">  -s, --size            Display total file sizes# 显示总文件大小</span><br><span class="line">[root@node1 ~]# docker ps -a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器ID <span class="comment">#镜像# 命令# 创建时间  # 状态# 端口 # 容器名称</span></span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">fe8edecbd757   centos    &quot;/bin/bash&quot;   13 seconds ago   Exited (0) 11 seconds ago             mystifying_satoshi</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;   6 minutes ago    Up 3 minutes                          exciting_morse</span><br></pre></td></tr></table></figure></li><li><p>退出容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit #直接退出容器</span><br><span class="line">Ctrl + q + p #不停止容器并退出</span><br></pre></td></tr></table></figure></li><li><p>docker rm</p><blockquote><p>删除容器</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker rm --help</span><br><span class="line"></span><br><span class="line">Usage:  docker rm [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line"></span><br><span class="line">Remove one or more containers</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  # 强制移除正在运行的容器（使用SIGKILL）</span><br><span class="line">  -f, --force     Force the removal of a running container (uses SIGKILL)</span><br><span class="line">  -l, --link      Remove the specified link# 删除指定的链接</span><br><span class="line">  -v, --volumes   Remove anonymous volumes associated with the container # 删除与容器关联的匿名卷</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker ps -a# 查看所有容器</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">fe8edecbd757   centos    &quot;/bin/bash&quot;   7 minutes ago    Exited (0) 7 minutes ago             mystifying_satoshi</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;   13 minutes ago   Up 11 minutes                        exciting_morse</span><br><span class="line">[root@node1 ~]# docker rm fe8edecbd757# 删除一个已经停止的容器</span><br><span class="line">fe8edecbd757</span><br><span class="line">[root@node1 ~]# docker ps -a# 再次查看发现已经被删除了</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS     NAMES</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;   14 minutes ago   Up 11 minutes             exciting_morse</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>容器的启动删除退出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker start 容器ID# 启动容器</span><br><span class="line">docker stop 容器ID# 停止容器</span><br><span class="line">docker restart 容器ID# 重启容器</span><br><span class="line">docker kill 容器ID# 强制停止容器</span><br></pre></td></tr></table></figure></li><li><p>docker exec</p><blockquote><p>以新的TTY进入容器</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker exec --help</span><br><span class="line"></span><br><span class="line">Usage:  docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</span><br><span class="line"></span><br><span class="line">Run a command in a running container</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -d, --detach               Detached mode: run command in the background# 分离模式：在后台运行命令</span><br><span class="line">      --detach-keys string   Override the key sequence for detaching a container# 覆盖用于分离容器的键序列</span><br><span class="line">  -e, --env list             Set environment variables# 设置环境变量</span><br><span class="line">      --env-file list        Read in a file of environment variables# 读入环境变量文件</span><br><span class="line">  -i, --interactive          Keep STDIN open even if not attached# 即使未连接，也保持标准输入打开</span><br><span class="line">      --privileged           Give extended privileges to the command #  为命令授予扩展权限</span><br><span class="line">  -t, --tty                  Allocate a pseudo-TTY# 分配一个伪TTY</span><br><span class="line">    # 用户名或UID（格式：&lt;name | UID&gt;[：&lt;group | gid&gt;）</span><br><span class="line">  -u, --user string          Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])</span><br><span class="line">  -w, --workdir string       Working directory inside the container#  容器内的工作目录</span><br><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED             STATUS          PORTS     NAMES</span><br><span class="line">5db7847b3285   centos    &quot;/bin/bash -c &#x27;while…&quot;   25 minutes ago      Up 25 minutes             shell3</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;              About an hour ago   Up 58 minutes             exciting_morse</span><br><span class="line">[root@node1 ~]# docker exec -it 5db /bin/bash</span><br><span class="line">[root@5db7847b3285 /]#</span><br></pre></td></tr></table></figure></li><li><p>docker attach</p><blockquote><p>打开正在运行的TTY</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED             STATUS             PORTS     NAMES</span><br><span class="line">5db7847b3285   centos    &quot;/bin/bash -c &#x27;while…&quot;   34 minutes ago      Up 34 minutes                shell3</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;              About an hour ago   Up About an hour             exciting_morse</span><br><span class="line">[root@node1 ~]# docker attach 5db</span><br></pre></td></tr></table></figure></li></ul><h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><ul><li><p>后台启动容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -d</span><br></pre></td></tr></table></figure></li><li><p>docker log</p><blockquote><p>查看容器日志</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker logs --help</span><br><span class="line"></span><br><span class="line">Usage:  docker logs [OPTIONS] CONTAINER</span><br><span class="line"></span><br><span class="line">Fetch the logs of a container</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --details        Show extra details provided to logs# 显示提供给日志的其他详细信息</span><br><span class="line">  -f, --follow         Follow log output# 跟踪日志输出</span><br><span class="line">     # 显示自时间戳（例如2013-01-02T13:23:37Z）或相对时间戳（例如42分钟的42m）以来的日志</span><br><span class="line">      --since string   Show logs since timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m for 42 minutes)</span><br><span class="line">         # 从日志末尾显示的行数（默认为“全部”）</span><br><span class="line">  -n, --tail string    Number of lines to show from the end of the logs (default &quot;all&quot;)</span><br><span class="line">  -t, --timestamps     Show timestamps# 显示时间戳</span><br><span class="line">     # 在时间戳（例如2013-01-02T13:23:37Z）或相对时间戳（例如42分钟的42m）之前显示日志</span><br><span class="line">      --until string   Show logs before a timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m for 42 minutes)</span><br></pre></td></tr></table></figure></li><li><p>docker top</p><blockquote><p>查看容器进程</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">5db7847b3285   centos    &quot;/bin/bash -c &#x27;while…&quot;   3 minutes ago    Up 3 minutes              shell3</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;              39 minutes ago   Up 36 minutes             exciting_morse</span><br><span class="line">[root@node1 ~]# docker top 5db</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                10825               10804               0                   22:08               ?                   </span><br><span class="line">root                11202               10825               0                   22:12               ?                   </span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>docker inspect</p><blockquote><p>查看容器元数据</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker inspect --help</span><br><span class="line"></span><br><span class="line">Usage:  docker inspect [OPTIONS] NAME|ID [NAME|ID...]</span><br><span class="line"></span><br><span class="line">Return low-level information on Docker objects</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --format string   Format the output using the given Go template</span><br><span class="line">  -s, --size            Display total file sizes if the type is container# 如果类型为容器，则显示总文件大小</span><br><span class="line">      --type string     Return JSON for specified type# 返回指定类型的JSON</span><br><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">5db7847b3285   centos    &quot;/bin/bash -c &#x27;while…&quot;   8 minutes ago    Up 8 minutes              shell3</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;              43 minutes ago   Up 40 minutes             exciting_morse</span><br><span class="line">[root@node1 ~]# docker inspect 5db</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;5db7847b3285ebb0bc78785808ed597f85c5476e84d24541cc5d135abc199bc2&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2021-12-11T14:08:37.31918904Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/bin/bash&quot;,</span><br><span class="line">        &quot;Args&quot;: [</span><br><span class="line">            &quot;-c&quot;,</span><br><span class="line">            &quot;while true;do echo hhhh;sleep 1;done&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;State&quot;: &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;running&quot;,</span><br><span class="line">            &quot;Running&quot;: true,</span><br><span class="line">            &quot;Paused&quot;: false,</span><br><span class="line">            &quot;Restarting&quot;: false,</span><br><span class="line">            &quot;OOMKilled&quot;: false,</span><br><span class="line">            &quot;Dead&quot;: false,</span><br><span class="line">            &quot;Pid&quot;: 10825,</span><br><span class="line">            &quot;ExitCode&quot;: 0,</span><br><span class="line">            &quot;Error&quot;: &quot;&quot;,</span><br><span class="line">            &quot;StartedAt&quot;: &quot;2021-12-11T14:08:37.712499657Z&quot;,</span><br><span class="line">            &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:5d0da3dc976460b72c77d94c8a1ad043720b0416bfc16c52c45d4847e53fadb6&quot;,</span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/var/lib/docker/containers/5db7847b3285ebb0bc78785808ed597f85c5476e84d24541cc5d135abc199bc2/resolv.conf&quot;,</span><br><span class="line">        &quot;HostnamePath&quot;: &quot;/var/lib/docker/containers/5db7847b3285ebb0bc78785808ed597f85c5476e84d24541cc5d135abc199bc2/hostname&quot;,</span><br><span class="line">        &quot;HostsPath&quot;: &quot;/var/lib/docker/containers/5db7847b3285ebb0bc78785808ed597f85c5476e84d24541cc5d135abc199bc2/hosts&quot;,</span><br><span class="line">        &quot;LogPath&quot;: &quot;/var/lib/docker/containers/5db7847b3285ebb0bc78785808ed597f85c5476e84d24541cc5d135abc199bc2/5db7847b3285ebb0bc78785808ed597f85c5476e84d24541cc5d135abc199bc2-json.log&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;/shell3&quot;,</span><br><span class="line">        &quot;RestartCount&quot;: 0,</span><br><span class="line">        &quot;Driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">        &quot;Platform&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;MountLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ProcessLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AppArmorProfile&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ExecIDs&quot;: null,</span><br><span class="line">        &quot;HostConfig&quot;: &#123;</span><br><span class="line">            &quot;Binds&quot;: null,</span><br><span class="line">            &quot;ContainerIDFile&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LogConfig&quot;: &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;json-file&quot;,</span><br><span class="line">                &quot;Config&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;NetworkMode&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;PortBindings&quot;: &#123;&#125;,</span><br><span class="line">            &quot;RestartPolicy&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;no&quot;,</span><br><span class="line">                &quot;MaximumRetryCount&quot;: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AutoRemove&quot;: false,</span><br><span class="line">            &quot;VolumeDriver&quot;: &quot;&quot;,</span><br><span class="line">            &quot;VolumesFrom&quot;: null,</span><br><span class="line">            &quot;CapAdd&quot;: null,</span><br><span class="line">            &quot;CapDrop&quot;: null,</span><br><span class="line">            &quot;CgroupnsMode&quot;: &quot;host&quot;,</span><br><span class="line">            &quot;Dns&quot;: [],</span><br><span class="line">            &quot;DnsOptions&quot;: [],</span><br><span class="line">            &quot;DnsSearch&quot;: [],</span><br><span class="line">            &quot;ExtraHosts&quot;: null,</span><br><span class="line">            &quot;GroupAdd&quot;: null,</span><br><span class="line">            &quot;IpcMode&quot;: &quot;private&quot;,</span><br><span class="line">            &quot;Cgroup&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Links&quot;: null,</span><br><span class="line">            &quot;OomScoreAdj&quot;: 0,</span><br><span class="line">            &quot;PidMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Privileged&quot;: false,</span><br><span class="line">            &quot;PublishAllPorts&quot;: false,</span><br><span class="line">            &quot;ReadonlyRootfs&quot;: false,</span><br><span class="line">            &quot;SecurityOpt&quot;: null,</span><br><span class="line">            &quot;UTSMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;UsernsMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;ShmSize&quot;: 67108864,</span><br><span class="line">            &quot;Runtime&quot;: &quot;runc&quot;,</span><br><span class="line">            &quot;ConsoleSize&quot;: [</span><br><span class="line">                0,</span><br><span class="line">                0</span><br><span class="line">            ],</span><br><span class="line">            &quot;Isolation&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpuShares&quot;: 0,</span><br><span class="line">            &quot;Memory&quot;: 0,</span><br><span class="line">            &quot;NanoCpus&quot;: 0,</span><br><span class="line">            &quot;CgroupParent&quot;: &quot;&quot;,</span><br><span class="line">            &quot;BlkioWeight&quot;: 0,</span><br><span class="line">            &quot;BlkioWeightDevice&quot;: [],</span><br><span class="line">            &quot;BlkioDeviceReadBps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceWriteBps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceReadIOps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceWriteIOps&quot;: null,</span><br><span class="line">            &quot;CpuPeriod&quot;: 0,</span><br><span class="line">            &quot;CpuQuota&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimePeriod&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimeRuntime&quot;: 0,</span><br><span class="line">            &quot;CpusetCpus&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpusetMems&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Devices&quot;: [],</span><br><span class="line">            &quot;DeviceCgroupRules&quot;: null,</span><br><span class="line">            &quot;DeviceRequests&quot;: null,</span><br><span class="line">            &quot;KernelMemory&quot;: 0,</span><br><span class="line">            &quot;KernelMemoryTCP&quot;: 0,</span><br><span class="line">            &quot;MemoryReservation&quot;: 0,</span><br><span class="line">            &quot;MemorySwap&quot;: 0,</span><br><span class="line">            &quot;MemorySwappiness&quot;: null,</span><br><span class="line">            &quot;OomKillDisable&quot;: false,</span><br><span class="line">            &quot;PidsLimit&quot;: null,</span><br><span class="line">            &quot;Ulimits&quot;: null,</span><br><span class="line">            &quot;CpuCount&quot;: 0,</span><br><span class="line">            &quot;CpuPercent&quot;: 0,</span><br><span class="line">            &quot;IOMaximumIOps&quot;: 0,</span><br><span class="line">            &quot;IOMaximumBandwidth&quot;: 0,</span><br><span class="line">            &quot;MaskedPaths&quot;: [</span><br><span class="line">                &quot;/proc/asound&quot;,</span><br><span class="line">                &quot;/proc/acpi&quot;,</span><br><span class="line">                &quot;/proc/kcore&quot;,</span><br><span class="line">                &quot;/proc/keys&quot;,</span><br><span class="line">                &quot;/proc/latency_stats&quot;,</span><br><span class="line">                &quot;/proc/timer_list&quot;,</span><br><span class="line">                &quot;/proc/timer_stats&quot;,</span><br><span class="line">                &quot;/proc/sched_debug&quot;,</span><br><span class="line">                &quot;/proc/scsi&quot;,</span><br><span class="line">                &quot;/sys/firmware&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;ReadonlyPaths&quot;: [</span><br><span class="line">                &quot;/proc/bus&quot;,</span><br><span class="line">                &quot;/proc/fs&quot;,</span><br><span class="line">                &quot;/proc/irq&quot;,</span><br><span class="line">                &quot;/proc/sys&quot;,</span><br><span class="line">                &quot;/proc/sysrq-trigger&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/c3c47f255c9d1db61b969601df06f580012e1783c6aa2bbbbe03e9bc970d105f-init/diff:/var/lib/docker/overlay2/41ea41b839add0b7e657a3b18b47d03f209199589ea6e20e52503cce2f8d580f/diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/c3c47f255c9d1db61b969601df06f580012e1783c6aa2bbbbe03e9bc970d105f/merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/c3c47f255c9d1db61b969601df06f580012e1783c6aa2bbbbe03e9bc970d105f/diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/c3c47f255c9d1db61b969601df06f580012e1783c6aa2bbbbe03e9bc970d105f/work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Mounts&quot;: [],</span><br><span class="line">        &quot;Config&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;5db7847b3285&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;/bin/bash&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;while true;do echo hhhh;sleep 1;done&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;centos&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20210915&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">            &quot;Bridge&quot;: &quot;&quot;,</span><br><span class="line">            &quot;SandboxID&quot;: &quot;a70d09048c929f2be067a98b10fb37d64287fd39d5fe0001a536fe70c8e9e002&quot;,</span><br><span class="line">            &quot;HairpinMode&quot;: false,</span><br><span class="line">            &quot;LinkLocalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LinkLocalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;Ports&quot;: &#123;&#125;,</span><br><span class="line">            &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/a70d09048c92&quot;,</span><br><span class="line">            &quot;SecondaryIPAddresses&quot;: null,</span><br><span class="line">            &quot;SecondaryIPv6Addresses&quot;: null,</span><br><span class="line">            &quot;EndpointID&quot;: &quot;8799f54ad2618d76893aeed3c1dafc959d83e63a7c153555fc0fe946d3c52ce9&quot;,</span><br><span class="line">            &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">            &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;IPAddress&quot;: &quot;172.17.0.3&quot;,</span><br><span class="line">            &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">            &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">            &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;bridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: null,</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;d7122c9cff979c8ad84c9d6f473ade3c87f211708febd877b1e6d5b0f50a9d79&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;8799f54ad2618d76893aeed3c1dafc959d83e63a7c153555fc0fe946d3c52ce9&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.3&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>docker cp</p><blockquote><p>Docker拷贝命令；用于从Docker中将文件拷贝至主机</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker cp --help</span><br><span class="line"></span><br><span class="line">Usage:  docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-</span><br><span class="line">        docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH</span><br><span class="line"></span><br><span class="line">Copy files/folders between a container and the local filesystem</span><br><span class="line"></span><br><span class="line">Use &#x27;-&#x27; as the source to read a tar archive from stdin</span><br><span class="line">and extract it to a directory destination in a container.</span><br><span class="line">Use &#x27;-&#x27; as the destination to stream a tar archive of a</span><br><span class="line">container source to stdout.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --archive       Archive mode (copy all uid/gid information)   # 存档模式（复制所有uid/gid信息）</span><br><span class="line">  -L, --follow-link   Always follow symbol link in SRC_PATH# 始终遵循SRC_路径中的符号链接</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用示例</span></span><br><span class="line">[root@node1 ~]# docker ps -a# 查看历史容器</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED       STATUS                        PORTS     NAMES</span><br><span class="line">5db7847b3285   centos    &quot;/bin/bash -c &#x27;while…&quot;   2 hours ago   Exited (137) 11 minutes ago             shell3</span><br><span class="line">df37e27d97c6   centos    &quot;/bin/sh -C &#x27;while t…&quot;   2 hours ago   Exited (127) 2 hours ago                shell2</span><br><span class="line">6e442975e003   centos    &quot;/bin/bash -C &#x27;while…&quot;   2 hours ago   Exited (127) 2 hours ago                shell</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;              3 hours ago   Exited (0) 52 seconds ago               exciting_morse</span><br><span class="line">[root@node1 ~]# docker start -a -i 2c# 运行容器</span><br><span class="line">[root@2c3fb40f1d3e /]# echo hello,world &gt; /root/xiaowangc</span><br><span class="line">[root@2c3fb40f1d3e /]# ls /root/</span><br><span class="line">abc  anaconda-ks.cfg  anaconda-post.log  original-ks.cfg  xiaowangc</span><br><span class="line">[root@2c3fb40f1d3e /]# # 使用ctrl q p 退出</span><br><span class="line">[root@node1 ~]# docker ps# 查看容器还在运行</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED       STATUS              PORTS     NAMES</span><br><span class="line">2c3fb40f1d3e   centos    &quot;/bin/bash&quot;   3 hours ago   Up About a minute             exciting_morse</span><br><span class="line">[root@node1 ~]# ls</span><br><span class="line">anaconda-ks.cfg  initial-setup-ks.cfg</span><br><span class="line">[root@node1 ~]# docker cp 2c:/root/xiaowangc ./</span><br><span class="line">[root@node1 ~]# ls</span><br><span class="line">anaconda-ks.cfg  initial-setup-ks.cfg  xiaowangc</span><br><span class="line">[root@node1 ~]# cat xiaowangc</span><br><span class="line">hello,world</span><br><span class="line">[root@node1 ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果需要将主机文件考至容器 即: docker <span class="built_in">cp</span> 主机文件 容器：路径</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="Docker-commit"><a href="#Docker-commit" class="headerlink" title="Docker commit"></a>Docker commit</h2><blockquote><p>从容器创建一个新的镜像</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker commit</span><br><span class="line">&quot;docker commit&quot; requires at least 1 and at most 2 arguments.</span><br><span class="line">See &#x27;docker commit --help&#x27;.</span><br><span class="line"></span><br><span class="line">Usage:  docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">Create a new image from a container&#x27;s changes</span><br><span class="line">[root@node1 ~]# docker commit --help</span><br><span class="line"></span><br><span class="line">Usage:  docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">Create a new image from a container&#x27;s changes</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"> # 作者（例如，“约翰·汉尼拔·史密斯&lt;hannibal@a-team.com&gt;）</span><br><span class="line">  -a, --author string    Author (e.g., &quot;John Hannibal Smith &lt;hannibal@a-team.com&gt;&quot;)</span><br><span class="line">   # 将Dockerfile指令应用于创建的镜像</span><br><span class="line">  -c, --change list      Apply Dockerfile instruction to the created image</span><br><span class="line">  -m, --message string   Commit message# 提交消息</span><br><span class="line">  -p, --pause            Pause container during commit (default true)# 提交期间暂停容器（默认为true）</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker pull tomcat</span><br><span class="line">[root@node1 ~]# docker images</span><br><span class="line">REPOSITORY      TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">tomcat          latest    24207ccc9cce   3 days ago     680MB</span><br><span class="line">centos          latest    5d0da3dc9764   2 months ago   231MB</span><br><span class="line">elasticsearch   latest    5acf0e8da90b   3 years ago    486MB</span><br><span class="line">[root@node1 ~]# docker run -d -P 24</span><br><span class="line">efa6bf9baf159b64b4b82d5f7d3330d6f83eddfe834d88ea8af21570ddb74ab4</span><br><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND             CREATED          STATUS          PORTS                                         NAMES</span><br><span class="line">efa6bf9baf15   24        &quot;catalina.sh run&quot;   28 seconds ago   Up 27 seconds   0.0.0.0:49154-&gt;8080/tcp, :::49154-&gt;8080/tcp   hungry_zhukovsky</span><br><span class="line">[root@node1 ~]# docker exec -it efa /bin/bash</span><br><span class="line">root@efa6bf9baf15:/usr/local/tomcat# ls</span><br><span class="line">BUILDING.txt     LICENSE  README.md      RUNNING.txt  conf  logs            temp     webapps.dist</span><br><span class="line">CONTRIBUTING.md  NOTICE   RELEASE-NOTES  bin          lib   native-jni-lib  webapps  work</span><br><span class="line">root@efa6bf9baf15:/usr/local/tomcat# cp -a webapps.dist/* webapps/</span><br><span class="line">root@efa6bf9baf15:/usr/local/tomcat# exit</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问当前宿主机IP:49154</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">官方镜像默认是无法打开此页面</span></span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218065838524-2076511357.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND             CREATED         STATUS         PORTS                                         NAMES</span><br><span class="line">efa6bf9baf15   24        &quot;catalina.sh run&quot;   4 minutes ago   Up 4 minutes   0.0.0.0:49154-&gt;8080/tcp, :::49154-&gt;8080/tcp   hungry_zhukovsky</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 作者描述  容器<span class="built_in">id</span>  镜像:tag[版本]</span></span><br><span class="line">[root@node1 ~]# docker commit -a xiaowangc -m &quot;Modify home page&quot; efa tomcat01:1.0</span><br><span class="line">sha256:fb71bc6566f66ab89c1b2c7b17358ade7a44f17c89f5c8193fa054b5d771f658</span><br><span class="line">[root@node1 ~]# docker images</span><br><span class="line">REPOSITORY      TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">tomcat01        1.0       fb71bc6566f6   3 seconds ago   684MB# 打包可以查看镜像</span><br><span class="line">tomcat          latest    24207ccc9cce   3 days ago      680MB</span><br><span class="line">centos          latest    5d0da3dc9764   2 months ago    231MB</span><br><span class="line">elasticsearch   latest    5acf0e8da90b   3 years ago     486MB</span><br><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND             CREATED         STATUS         PORTS                                         NAMES</span><br><span class="line">efa6bf9baf15   24        &quot;catalina.sh run&quot;   9 minutes ago   Up 9 minutes   0.0.0.0:49154-&gt;8080/tcp, :::49154-&gt;8080/tcp   hungry_zhukovsky</span><br><span class="line">[root@node1 ~]# docker stop efa# 停止之前的容器</span><br><span class="line">efa</span><br><span class="line">[root@node1 ~]# docker run -d -P fb71# 通过我们打包后的镜像创建容器</span><br><span class="line">a1b1c2987c3fee9546335a0070a31c3f5d903c3e17f04f34452aca775e7e1b10</span><br><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND             CREATED         STATUS         PORTS                                         NAMES</span><br><span class="line">a1b1c2987c3f   fb71      &quot;catalina.sh run&quot;   2 seconds ago   Up 2 seconds   0.0.0.0:49155-&gt;8080/tcp, :::49155-&gt;8080/tcp   compassionate_fermat</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接访问 宿主机IP:49155</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">官方的tomcat镜像不做修改，无法访问这个主页，现在我们通过修改后的容器打包成镜像，再创建就可以直接访问</span></span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218065903247-64115338.png"></p><h1 id="容器卷-容器数据持久化"><a href="#容器卷-容器数据持久化" class="headerlink" title="容器卷(容器数据持久化)"></a>容器卷(容器数据持久化)</h1><blockquote><p>数据可以存储在容器中，但是一旦将容器进行删除就等同删库跑路了qwq。</p></blockquote><h6 id="Docker对于宿主机来说，只是一个运行在Linux上的应用程序，因此它的的数据存储还是会依赖宿主机，实现数据持久化的两种方式："><a href="#Docker对于宿主机来说，只是一个运行在Linux上的应用程序，因此它的的数据存储还是会依赖宿主机，实现数据持久化的两种方式：" class="headerlink" title="Docker对于宿主机来说，只是一个运行在Linux上的应用程序，因此它的的数据存储还是会依赖宿主机，实现数据持久化的两种方式："></a>Docker对于宿主机来说，只是一个运行在Linux上的应用程序，因此它的的数据存储还是会依赖宿主机，实现数据持久化的两种方式：</h6><ul><li><strong>Bind Mount</strong></li></ul><h6 id="Bind-Mount数据持久化的方式，如果挂载本地的一个目录，则对应容器的目录下的内容会被本地的数据覆盖。使用Bind-Mount还需要指定本地的某个目录挂载到容器的某个目录。"><a href="#Bind-Mount数据持久化的方式，如果挂载本地的一个目录，则对应容器的目录下的内容会被本地的数据覆盖。使用Bind-Mount还需要指定本地的某个目录挂载到容器的某个目录。" class="headerlink" title="Bind Mount数据持久化的方式，如果挂载本地的一个目录，则对应容器的目录下的内容会被本地的数据覆盖。使用Bind Mount还需要指定本地的某个目录挂载到容器的某个目录。"></a>Bind Mount数据持久化的方式，如果挂载本地的一个目录，则对应容器的目录下的内容会被本地的数据覆盖。使用Bind Mount还需要指定本地的某个目录挂载到容器的某个目录。</h6><ul><li><strong>Docker Manager Volume</strong></li></ul><h6 id="Docker-Manager-Volume相比Bind-Mount，挂载目录到容器中数据不会被覆盖，同时也不需要管理员指定从宿主机挂载到容器中的某个目录，只需要指定对容器的某个目录进行挂载，而挂载到宿主机的某个目录是由Docker来进行统一管理。"><a href="#Docker-Manager-Volume相比Bind-Mount，挂载目录到容器中数据不会被覆盖，同时也不需要管理员指定从宿主机挂载到容器中的某个目录，只需要指定对容器的某个目录进行挂载，而挂载到宿主机的某个目录是由Docker来进行统一管理。" class="headerlink" title="Docker Manager Volume相比Bind Mount，挂载目录到容器中数据不会被覆盖，同时也不需要管理员指定从宿主机挂载到容器中的某个目录，只需要指定对容器的某个目录进行挂载，而挂载到宿主机的某个目录是由Docker来进行统一管理。"></a>Docker Manager Volume相比Bind Mount，挂载目录到容器中数据不会被覆盖，同时也不需要管理员指定从宿主机挂载到容器中的某个目录，只需要指定对容器的某个目录进行挂载，而挂载到宿主机的某个目录是由Docker来进行统一管理。</h6><h6 id="任一一种方式的持久化都不会在容器被删除后导致数据丢失"><a href="#任一一种方式的持久化都不会在容器被删除后导致数据丢失" class="headerlink" title="任一一种方式的持久化都不会在容器被删除后导致数据丢失"></a>任一一种方式的持久化都不会在容器被删除后导致数据丢失</h6><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218065958095-151971623.png"></p><h2 id="Bind-Mount"><a href="#Bind-Mount" class="headerlink" title="Bind Mount"></a>Bind Mount</h2><p>Bind Mount挂载卷有两种方式：</p><ul><li><p>-v [主机路径:]容器路径 [:可选参数]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# ls /root/# 查看主机root下并没有docker-volume目录</span><br><span class="line">anaconda-ks.cfg  Documents  initial-setup-ks.cfg  Pictures  quick_start.sh  Videos</span><br><span class="line">Desktop          Downloads  Music                 Public    Templates       xiaowangc</span><br><span class="line">[root@node1 ~]# docker run --help | grep volume</span><br><span class="line">  -v, --volume list                    Bind mount a volume# 使用方式  -v 宿主机路径:容器路径</span><br><span class="line">      --volume-driver string           Optional volume driver for the container</span><br><span class="line">      --volumes-from list              Mount volumes from the specified container(s)</span><br><span class="line">[root@node1 ~]# docker run -it -v /root/docker-volume:/root/docker centos /bin/bash# 启动容器并进行绑定</span><br><span class="line">[root@e8136a876260 /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@e8136a876260 /]# touch /root/docker/abc# 在对于的挂载位置创建一个文件</span><br><span class="line">[root@e8136a876260 /]# exit# 退出</span><br><span class="line">exit</span><br><span class="line">[root@node1 ~]# ls /root/docker-volume/# 查看本机对于的目录位置，可以看到我们之前在容器中创建的abc文件</span><br><span class="line">abc</span><br><span class="line">[root@node1 ~]# docker ps -a# 查看更改创建的容器id</span><br><span class="line">CONTAINER ID   IMAGE           COMMAND                  CREATED         STATUS                       PORTS     NAMES</span><br><span class="line">e8136a876260   centos          &quot;/bin/bash&quot;              3 minutes ago   Exited (0) 3 minutes ago               distracted_bose</span><br><span class="line">a1b1c2987c3f   fb71            &quot;catalina.sh run&quot;        3 hours ago     Exited (143) 5 minutes ago             compassionate_fermat</span><br><span class="line">efa6bf9baf15   24              &quot;catalina.sh run&quot;        3 hours ago     Exited (143) 3 hours ago               hungry_zhukovsky</span><br><span class="line">a1099bfaa7ff   tomcat          &quot;catalina.sh run&quot;        13 hours ago    Exited (143) 11 hours ago              clever_carson</span><br><span class="line">ca73206e78db   tomcat          &quot;catalina.sh run&quot;        13 hours ago    Exited (130) 13 hours ago              keen_mclean</span><br><span class="line">62d75c8f96c8   tomcat          &quot;/bin/bash&quot;              13 hours ago    Exited (0) 13 hours ago                strange_rhodes</span><br><span class="line">afecd5719875   elasticsearch   &quot;/docker-entrypoint.…&quot;   22 hours ago    Exited (130) 22 hours ago              modest_hawking</span><br><span class="line">[root@node1 ~]# docker inspect e8# 获取容器元数据</span><br><span class="line">...</span><br><span class="line"> &quot;Binds&quot;: [</span><br><span class="line">                &quot;/root/docker-volume:/root/docker&quot;</span><br><span class="line">            ],</span><br><span class="line">...</span><br><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,# 类型</span><br><span class="line">                &quot;Source&quot;: &quot;/root/docker-volume&quot;,# 源目录(宿主机路径)</span><br><span class="line">                &quot;Destination&quot;: &quot;/root/docker&quot;,# 目的目录(Docker容器中路径)</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我们试着将容器进行删除</span></span><br><span class="line">[root@node1 ~]# docker ps -a# 找到更改创建的容器id</span><br><span class="line">CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS                        PORTS     NAMES</span><br><span class="line">e8136a876260   centos          &quot;/bin/bash&quot;              10 minutes ago   Exited (0) 10 minutes ago               distracted_bose</span><br><span class="line">a1b1c2987c3f   fb71            &quot;catalina.sh run&quot;        3 hours ago      Exited (143) 12 minutes ago             compassionate_fermat</span><br><span class="line">efa6bf9baf15   24              &quot;catalina.sh run&quot;        3 hours ago      Exited (143) 3 hours ago                hungry_zhukovsky</span><br><span class="line">a1099bfaa7ff   tomcat          &quot;catalina.sh run&quot;        13 hours ago     Exited (143) 11 hours ago               clever_carson</span><br><span class="line">ca73206e78db   tomcat          &quot;catalina.sh run&quot;        13 hours ago     Exited (130) 13 hours ago               keen_mclean</span><br><span class="line">62d75c8f96c8   tomcat          &quot;/bin/bash&quot;              13 hours ago     Exited (0) 13 hours ago                 strange_rhodes</span><br><span class="line">afecd5719875   elasticsearch   &quot;/docker-entrypoint.…&quot;   22 hours ago     Exited (130) 22 hours ago               modest_hawking</span><br><span class="line">[root@node1 ~]# docker rm e81# 删除容器</span><br><span class="line">e81</span><br><span class="line">[root@node1 ~]# ls /root/docker-volume/# 再次查看发现数据还存在</span><br><span class="line">abc</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure><p>下面我们再深入了解一下-v</p></li></ul><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070017530-1564959356.png"></p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# man docker run# 有兴趣的可以自己阅读翻译</span><br><span class="line"></span><br><span class="line">       -v|--volume[=[[HOST-DIR:]CONTAINER-DIR[:OPTIONS]]]</span><br><span class="line">          Create a bind mount. If you specify, -v /HOST-DIR:/CONTAINER-DIR, Docker</span><br><span class="line">          bind mounts /HOST-DIR in the host to /CONTAINER-DIR in the Docker</span><br><span class="line">          container. If &#x27;HOST-DIR&#x27; is omitted,  Docker automatically creates the new</span><br><span class="line">          volume on the host.  The OPTIONS are a comma delimited list and can be:</span><br><span class="line">          #创建绑定挂载。如果指定-v/HOST-DIR:/CONTAINER-DIR，则为Docker将主机中的mounts/HOST-DIR绑定到Docker中的/CONTAINER-DIR容器如果省略“HOST-DIR”，Docker会自动创建新的主机上的卷。选项是逗号分隔的列表，可以是：</span><br><span class="line"></span><br><span class="line">              · [rw|ro]# 设置卷是否可读写，在上面的实例中我们看到一行 &quot;RW&quot;: true,表示可读写，当然我们也可以在挂载之前设置为ro(只读)</span><br><span class="line"></span><br><span class="line">              · [z|Z]</span><br><span class="line"></span><br><span class="line">              · [[r]shared|[r]slave|[r]private]</span><br><span class="line"></span><br><span class="line">              · [delegated|cached|consistent]</span><br><span class="line"></span><br><span class="line">              · [nocopy]</span><br><span class="line">              </span><br><span class="line">   # 这里告诉我们CONTAINER-DIR(容器目录)必须使用绝对路径，而HOST-DIR可以使用相对/绝对路径</span><br><span class="line">       The  CONTAINER-DIR must be an absolute path such as /src/docs. The HOST-DIR can be an absolute path or a name value. A name value must start with an alphanumeric character, followed by a-z0-9, _ (underscore), . (period) or -</span><br><span class="line">       (hyphen). An absolute path starts with a / (forward slash).</span><br><span class="line"></span><br><span class="line">   # 如果HOST-DIR是绝对路径，Docker Bind会装载到指定路径。如果是名称docker会使用该名称创建一个以改名称命名的卷</span><br><span class="line">       If you supply a HOST-DIR that is an absolute path,  Docker bind-mounts to the path you specify. If you supply a name, Docker creates a named volume by that name. For example, you can specify either /foo or foo for a HOST-DIR value. If you supply the /foo value, Docker creates a bind mount. If you supply the foo specification, Docker creates a named volume.</span><br><span class="line"></span><br><span class="line">   # 可以使用-v绑定一个或多个，如果其他容器也要使用请用--volumes-from选项</span><br><span class="line">       You can specify multiple  -v options to mount one or more mounts to a container. To use these same mounts in other containers, specify the --volumes-from option also.</span><br><span class="line"></span><br><span class="line">   #你还可以在：后面使用多个参数，设置读写权限rw、ro 例如： -v 主机路径:容器路径：ro...;还能使用Z/z设置Docker重新标记共享卷上的文件对象，Z选项告诉Docker使用私有非共享标签。只有当前容器才能使用专用卷。z表示共享卷内容</span><br><span class="line">       You  can  supply  additional  options for each bind mount following an additional colon.  A :ro or :rw suffix mounts a volume in read-only or read-write mode, respectively. By default, volumes are mounted in read-write mode.</span><br><span class="line">       You can also specify the consistency requirement for the mount, either :consistent (the default), :cached, or :delegated.  Multiple options are separated by commas, e.g. :ro,cached.</span><br><span class="line"></span><br><span class="line">       Labeling systems like SELinux require that proper labels are placed on volume content mounted into a container. Without a label, the security system might prevent the processes running inside the  container  from  using  the</span><br><span class="line">       content. By default, Docker does not change the labels set by the OS.</span><br><span class="line"></span><br><span class="line">       To  change  a label in the container context, you can add either of two suffixes :z or :Z to the volume mount. These suffixes tell Docker to relabel file objects on the shared volumes. The z option tells Docker that two con‐</span><br><span class="line">       tainers share the volume content. As a result, Docker labels the content with a shared content label. Shared volume labels allow all containers to read/write content.  The Z option tells Docker to label the  content  with  a</span><br><span class="line">       private unshared label.  Only the current container can use a private volume.</span><br><span class="line"></span><br><span class="line">       By  default bind mounted volumes are private. That means any mounts done inside container will not be visible on host and vice-a-versa. One can change this behavior by specifying a volume mount propagation property. Making a</span><br><span class="line">       volume shared mounts done under that volume inside container will be visible on host and vice-a-versa. Making a volume slave enables only one way mount propagation and that is mounts done on host under that  volume  will  be</span><br><span class="line">       visible inside container but not the other way around.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">要控制卷的装载传播属性，可以使用：[r]共享、：[r]从属或：[r]专用传播标志。只能为绑定装入的卷指定传播属性，而不能为内部卷或命名卷指定传播属性卷。要使装载传播工作，源装载点（装载源目录的装载点）必须具有正确的传播属性。对于共享卷，必须共享源装载点。对于从卷，源装载必须是共享的或从的。</span></span><br><span class="line">       To  control  mount  propagation  property of volume one can use :[r]shared, :[r]slave or :[r]private propagation flag. Propagation property can be specified only for bind mounted volumes and not for internal volumes or named</span><br><span class="line">       volumes. For mount propagation to work source mount point (mount point where source dir is mounted on) has to have right propagation properties. For shared volumes, source mount point has to be shared. And for slave volumes,</span><br><span class="line">       source mount has to be either shared or slave.</span><br><span class="line">   </span><br><span class="line">       ...</span><br><span class="line">       </span><br><span class="line">       To disable automatic copying of data from the container path to the volume, use the nocopy flag. The nocopy flag can be set on bind mounts and named volumes.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">另请参见--mount，它是--tmpfs和--volume的继承者。即使没有计划弃用--volume，也建议使用--mount。</span></span><br><span class="line">       See also --mount, which is the successor of --tmpfs and --volume.  Even though there is no plan to deprecate --volume, usage of --mount is recommended.</span><br></pre></td></tr></table></figure><ul><li><p>–mount</p><p>第二种通过–mount也是官方建议使用的方法，它相比-v跟灵活、可读性高。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# man docker run# 有兴趣的可以自己阅读翻译 </span><br><span class="line"></span><br><span class="line">      --mount type=TYPE,TYPE-SPECIFIC-OPTION[,...]</span><br><span class="line">          Attach a filesystem mount to the container</span><br><span class="line"></span><br><span class="line">   # 当前支持的装载类型有bind、volume和tmpfs。</span><br><span class="line">       Current supported mount TYPES are bind, volume, and tmpfs.</span><br><span class="line"></span><br><span class="line">       e.g.# 例如</span><br><span class="line">   # bind类型(Bind Mount)，源地址，目录地址</span><br><span class="line">       type=bind,source=/path/on/host,destination=/path/in/container</span><br><span class="line"></span><br><span class="line">   # volume类型(Docker Manager Volume)，源地址，目的地址，卷标，卷标</span><br><span class="line">       type=volume,source=my-volume,destination=/path/in/container,volume-label=&quot;color=red&quot;,volume-label=&quot;shape=round&quot;</span><br><span class="line"></span><br><span class="line">   # 前面图上的tmpfs</span><br><span class="line">       type=tmpfs,tmpfs-size=512M,destination=/path/in/container</span><br><span class="line"></span><br><span class="line">   # 常用选项</span><br><span class="line">       Common Options:</span><br><span class="line">  # 设置源地址</span><br><span class="line">              · src, source: mount source spec for bind and volume. Mandatory for bind.</span><br><span class="line">  # 设置目的地址</span><br><span class="line">              · dst, destination, target: mount destination spec.</span><br><span class="line">  # 设置权限</span><br><span class="line">              · ro, readonly: true or false (default).</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></li></ul><h2 id="Docker-Manager-Volume"><a href="#Docker-Manager-Volume" class="headerlink" title="Docker  Manager Volume"></a>Docker  Manager Volume</h2><p>通过上面对–mount参数的了解，我想对使用Docker Manager Volume方法挂载或绑定应该知道改怎么操作了~</p><p>下面来实践一下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker run -it --mount src=docker_home,dst=/home centos /bin/bash</span><br><span class="line">[root@69a38a458cb7 /]#   #ctrl + q + p 不停止退出容器</span><br><span class="line">[root@node1 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS     NAMES</span><br><span class="line">69a38a458cb7   centos    &quot;/bin/bash&quot;   41 seconds ago   Up 41 seconds             mystifying_satoshi</span><br><span class="line">[root@node1 ~]# docker inspect 69</span><br><span class="line">        &quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;volume&quot;,# 挂载类型 volume</span><br><span class="line">                &quot;Name&quot;: &quot;docker_home&quot;,# 前面有提到过，如果设置名称那么将以名称来创建对于卷</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/docker_home/_data&quot;,# 主机上目录地址(Docker自行创建)</span><br><span class="line">                &quot;Destination&quot;: &quot;/home&quot;,# 目录地址</span><br><span class="line">                &quot;Driver&quot;: &quot;local&quot;,# 设备为本地</span><br><span class="line">                &quot;Mode&quot;: &quot;z&quot;,# z表示共享卷内容</span><br><span class="line">                &quot;RW&quot;: true,# 表示可读写</span><br><span class="line">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h2 id="聚名和匿名挂载"><a href="#聚名和匿名挂载" class="headerlink" title="聚名和匿名挂载"></a>聚名和匿名挂载</h2><blockquote><p>在通过docker volume ls 查看卷的时候会发现有卷名为哈希值命名的是因为在挂载的时候并未指定卷名，bind不能通过–mount设置卷名，但可以直接使用-v 进行设置例: -v 卷名:容器路径 ，volume方式可以通过–mount 卷名:容器路径进行设置卷名，如果未设置将以哈希值进行命名</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker volume ls# 查看卷</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     15d9a94c6a8cdbffa66b3d9c76d476243c312f70f7e54d46549d137193036479# 匿名挂载，这是因为在挂载的时候并未指定源路径的名称</span><br><span class="line">local     docker_home# 聚名挂载，如果指定了名称那么将会以名称创建对于的卷</span><br><span class="line">[root@node1 ~]# docker volume inspect 15d9a94c6a8cdbffa66b3d9c76d476243c312f70f7e54d46549d137193036479</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2021-12-12T04:57:10+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/15d9a94c6a8cdbffa66b3d9c76d476243c312f70f7e54d46549d137193036479/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;15d9a94c6a8cdbffa66b3d9c76d476243c312f70f7e54d46549d137193036479&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@node1 ~]# docker volume inspect docker_home</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2021-12-13T04:19:01+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/docker_home/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;docker_home&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@node1 ~]#  </span><br></pre></td></tr></table></figure><h1 id="Docker-File"><a href="#Docker-File" class="headerlink" title="Docker File"></a>Docker File</h1><blockquote><p>此镜像在构建基本镜像（例如<a href="https://registry.hub.docker.com/_/debian/"><code>debian</code></a>和<a href="https://registry.hub.docker.com/_/busybox/"><code>busybox</code></a>）或超级小镜像（仅包含单个二进制文件和它需要的任何内容，例如<a href="https://registry.hub.docker.com/_/hello-world/"><code>hello-world</code></a>）的上下文中最有用。</p></blockquote><p>CentOS的官方Dockerfile</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch# 最基础的镜像</span><br><span class="line">ADD centos-8-x86_64.tar.xz /# 添加centos-8-x86_64软件包</span><br><span class="line">LABEL org.label-schema.schema-version=&quot;1.0&quot;/# 添加元数据到镜像</span><br><span class="line">  org.label-schema.name=&quot;CentOS Base Image&quot;/</span><br><span class="line">  org.label-schema.vendor=&quot;CentOS&quot;/</span><br><span class="line">  org.label-schema.license=&quot;GPLv2&quot;/</span><br><span class="line">  org.label-schema.build-date=&quot;20210915&quot;</span><br><span class="line">CMD [&quot;/bin/bash&quot;]</span><br></pre></td></tr></table></figure><p>DockerFile常用命令：</p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070042966-277361809.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker build --help</span><br><span class="line"></span><br><span class="line">Usage:  docker build [OPTIONS] PATH | URL | -</span><br><span class="line"></span><br><span class="line">Build an image from a Dockerfile# 从Dockerfile生成镜像</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"># 添加自定义主机到IP映射（主机：IP）</span><br><span class="line">      --add-host list           Add a custom host-to-IP mapping (host:ip)</span><br><span class="line">      --build-arg list          Set build-time variables# 设置构建时变量</span><br><span class="line">      --cache-from strings      Images to consider as cache sources# 视为高速缓存源的镜像</span><br><span class="line">      --cgroup-parent string    Optional parent cgroup for the container# 容器的可选父cgroup</span><br><span class="line">      --compress                Compress the build context using gzip# 使用gzip压缩构建上下文</span><br><span class="line">      # 限制CPU CFS（完全公平调度程序）周期</span><br><span class="line">      --cpu-period int          Limit the CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">      # 限制CPU CFS（完全公平调度程序）配额</span><br><span class="line">      --cpu-quota int           Limit the CPU CFS (Completely Fair Scheduler) quota</span><br><span class="line">  -c, --cpu-shares int          CPU shares (relative weight)# CPU份额（相对权重）</span><br><span class="line">      --cpuset-cpus string      CPUs in which to allow execution (0-3, 0,1)# 允许执行的CPU（0-3,0,1）</span><br><span class="line">      --cpuset-mems string      MEMs in which to allow execution (0-3, 0,1)# 允许执行的MEMs（0-3,0,1）</span><br><span class="line">      --disable-content-trust   Skip image verification (default true)# 跳过镜像验证（默认为真）</span><br><span class="line">      # Dockerfile的名称（默认值为“路径/Dockerfile”）</span><br><span class="line">  -f, --file string             Name of the Dockerfile (Default is &#x27;PATH/Dockerfile&#x27;)</span><br><span class="line">      --force-rm                Always remove intermediate containers# 务必拆下中间容器</span><br><span class="line">      --iidfile string          Write the image ID to the file# 将镜像ID写入文件</span><br><span class="line">      --isolation string        Container isolation technology# 容器隔离技术</span><br><span class="line">      --label list              Set metadata for an image# 设置镜像的元数据</span><br><span class="line">  -m, --memory bytes            Memory limit# 内存限制</span><br><span class="line">  # 交换限制等于内存加交换：&#x27;-1&#x27;以启用无限制交换</span><br><span class="line">      --memory-swap bytes       Swap limit equal to memory plus swap: &#x27;-1&#x27; to enable unlimited swap</span><br><span class="line">      # 在构建期间为运行指令设置网络模式（默认值为“默认值”）</span><br><span class="line">      --network string          Set the networking mode for the RUN instructions during build (default &quot;default&quot;)</span><br><span class="line">      --no-cache                Do not use cache when building the image# 生成镜像时不要使用缓存</span><br><span class="line">      --pull                    Always attempt to pull a newer version of the image # 始终尝试提取镜像的更新版本</span><br><span class="line">      # 成功时抑制生成输出并打印镜像ID</span><br><span class="line">  -q, --quiet                   Suppress the build output and print image ID on success</span><br><span class="line">  # 成功生成后删除中间容器（默认为true）</span><br><span class="line">      --rm                      Remove intermediate containers after a successful build (default true)</span><br><span class="line">      --security-opt strings    Security options# 安全选项</span><br><span class="line">      --shm-size bytes          Size of /dev/shm# /dev/shm的大小</span><br><span class="line">      # 名称和可选的“名称：标记”格式的标记</span><br><span class="line">  -t, --tag list                Name and optionally a tag in the &#x27;name:tag&#x27; format</span><br><span class="line">      --target string           Set the target build stage to build.# 将目标构建阶段设置为build。</span><br><span class="line">      --ulimit ulimit           Ulimit options (default [])# Ulimit选项（默认值[]）</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 docker]# vim Dockerfile</span><br><span class="line">FROM centos</span><br><span class="line">MAINTAINER xiaowangc&lt;780312916@qq.com&gt;</span><br><span class="line">ADD jdk-8u202-linux-x64.tar.gz /usr/local</span><br><span class="line">ADD apache-tomcat-10.0.14.tar.gz /usr/local</span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_202</span><br><span class="line">ENV CLASSPATH $JAVA_HOME/lib/dt.jar;$JAVA_HOME/lib/tools.jar</span><br><span class="line">ENV CATALINA_HOME /usr/local/apache-tomcat-10.0.14</span><br><span class="line">ENV CATALINA_BASH /usr/local/apache-tomcat-10.0.14</span><br><span class="line">ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line">EXPOSE 8080</span><br><span class="line">CMD /usr/local/apache-tomcat-10.0.14/bin/startup.sh &amp;&amp; tail -F /usr/local/apache-tomcat-10.0.14/bin/logs/catalina.out</span><br><span class="line">[root@node1 docker]# docker build -t tomcat:1.0 .</span><br><span class="line">Sending build context to Docker daemon  626.3MB</span><br><span class="line">Step 1/13 : FROM centos</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">5d0da3dc9764</span></span><br><span class="line">Step 2/13 : MAINTAINER xiaowangc&lt;780312916@qq.com&gt;</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> c4eb917f2af7</span></span><br><span class="line">Removing intermediate container c4eb917f2af7</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">ce301fca9581</span></span><br><span class="line">Step 3/13 : ADD jdk-8u202-linux-x64.tar.gz /usr/local</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">80553040d2a3</span></span><br><span class="line">Step 4/13 : ADD apache-tomcat-10.0.14.tar.gz /usr/local</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">e817c2abc0ea</span></span><br><span class="line">Step 5/13 : ENV MYPATH /usr/local</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> dc72d266f4eb</span></span><br><span class="line">Removing intermediate container dc72d266f4eb</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">9a11104f7a13</span></span><br><span class="line">Step 6/13 : WORKDIR $MYPATH</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> cdf0377b61ad</span></span><br><span class="line">Removing intermediate container cdf0377b61ad</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">e94e866312c7</span></span><br><span class="line">Step 7/13 : ENV JAVA_HOME /usr/local/jdk1.8.0_202</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 460df16b993a</span></span><br><span class="line">Removing intermediate container 460df16b993a</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">6523add551dc</span></span><br><span class="line">Step 8/13 : ENV CLASSPATH $JAVA_HOME/lib/dt.jar;$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> c3243bb658ab</span></span><br><span class="line">Removing intermediate container c3243bb658ab</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">d27761de5003</span></span><br><span class="line">Step 9/13 : ENV CATALINA_HOME /usr/local/apache-tomcat-10.0.14</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> a202f40d116f</span></span><br><span class="line">Removing intermediate container a202f40d116f</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">3e2b79eac04f</span></span><br><span class="line">Step 10/13 : ENV CATALINA_BASH /usr/local/apache-tomcat-10.0.14</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 75aa2512492c</span></span><br><span class="line">Removing intermediate container 75aa2512492c</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">69f0cf1dfa7c</span></span><br><span class="line">Step 11/13 : ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 61d1715c1996</span></span><br><span class="line">Removing intermediate container 61d1715c1996</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">9c10da8b965f</span></span><br><span class="line">Step 12/13 : EXPOSE 8080</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 27eb03392b67</span></span><br><span class="line">Removing intermediate container 27eb03392b67</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">29061051cbe8</span></span><br><span class="line">Step 13/13 : CMD /usr/local/apache-tomcat-10.0.14/bin/startup.sh &amp;&amp; tail -F /usr/local/apache-tomcat-10.0.14/bin/logs/catalina.out</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 96463dc0a1e7</span></span><br><span class="line">Removing intermediate container 96463dc0a1e7</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">c6bbae39158e</span></span><br><span class="line">Successfully built c6bbae39158e</span><br><span class="line">Successfully tagged tomcat:1.0</span><br><span class="line">[root@node1 docker]# docker run -itdp 80:8080 c6# 将容器8080映射到主机80</span><br><span class="line">212d00ffa33649ac8f4370feab11a36552d2ae40719d398718c29c233e3c09ed</span><br><span class="line">[root@node1 docker]# docker ps# 查看容器是否正在运行</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                   NAMES</span><br><span class="line">212d00ffa336   c6        &quot;/bin/sh -c &#x27;/usr/lo…&quot;   3 seconds ago   Up 3 seconds   0.0.0.0:80-&gt;8080/tcp, :::80-&gt;8080/tcp   confident_archimedes</span><br><span class="line">[root@node1 docker]#</span><br></pre></td></tr></table></figure><p><strong>访问宿主机IP</strong></p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070057949-125116092.png"></p><h1 id="Docker-Network"><a href="#Docker-Network" class="headerlink" title="Docker Network"></a>Docker Network</h1><blockquote><p>Docker网络模式</p></blockquote><table><thead><tr><th align="center">Docker网络</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">Host</td><td align="center">容器和宿主机共用Network&#x2F;Port</td></tr><tr><td align="center">Container</td><td align="center">容器和另外的容器共用Network&#x2F;Port</td></tr><tr><td align="center">None</td><td align="center">关闭该容器的网络</td></tr><tr><td align="center">Bridge</td><td align="center">容器会分配到属于各自的IP，并连接到Docker0的虚拟网桥，通过Docker0与宿主机通信(默认模式)</td></tr></tbody></table><h2 id="Bridge"><a href="#Bridge" class="headerlink" title="Bridge"></a>Bridge</h2><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070111722-358208503.png"></p><h6 id="桥接-Bridge-网络从上图就可以看出来，我们创建的两台容器是不能直接进行通信而是经过Docker0进行桥接实现的-二层交换-。在创建容器时，如果没有更改容器网络那么容器默认将加入到Docker0中。"><a href="#桥接-Bridge-网络从上图就可以看出来，我们创建的两台容器是不能直接进行通信而是经过Docker0进行桥接实现的-二层交换-。在创建容器时，如果没有更改容器网络那么容器默认将加入到Docker0中。" class="headerlink" title="桥接(Bridge)网络从上图就可以看出来，我们创建的两台容器是不能直接进行通信而是经过Docker0进行桥接实现的(二层交换)。在创建容器时，如果没有更改容器网络那么容器默认将加入到Docker0中。"></a>桥接(Bridge)网络从上图就可以看出来，我们创建的两台容器是不能直接进行通信而是经过Docker0进行桥接实现的(二层交换)。在创建容器时，如果没有更改容器网络那么容器默认将加入到Docker0中。</h6><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070123087-2044118293.png"></p><p>通过在宿主机和容器通过命令对网络进行查看，我们还会会看到宿主机和容器的网卡的名称有着微妙的联系，if7-if8、if9-if10…</p><p>这里是因为容器使用了veth-pair,veth设备的特点(在Bridge的第一张图就能看出)：</p><ul><li>veth设备是成对出现的，另一端两个设备彼此相连</li><li>一个设备收到协议栈的数据发送请求后，会将数据发送到另一个设备上去</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个新桥并加入容器</span></span><br><span class="line">[root@node1 ~]# docker network</span><br><span class="line"></span><br><span class="line">Usage:  docker network COMMAND</span><br><span class="line"></span><br><span class="line">Manage networks</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  connect     Connect a container to a network# 将容器连接到网络</span><br><span class="line">  create      Create a network# 创建一个新网络</span><br><span class="line">  disconnect  Disconnect a container from a network# 断开容器与网络的连接</span><br><span class="line">  inspect     Display detailed information on one or more networks# 显示一个或多个网络上的详细信息</span><br><span class="line">  ls          List networks# 列出所有网络</span><br><span class="line">  prune       Remove all unused networks# 删除所有未使用的网络</span><br><span class="line">  rm          Remove one or more networks# 删除一个或多个网络</span><br></pre></td></tr></table></figure><h6 id="由Docker默认创建的网络"><a href="#由Docker默认创建的网络" class="headerlink" title="由Docker默认创建的网络"></a>由Docker默认创建的网络</h6><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070133875-1412409362.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker network create --subnet 192.168.233.0/24 --gateway 192.168.233.254 netWork</span><br><span class="line">8e707433b97d58fb6329ec3cf6cf770d34df82b1050e16b56c4f7e6090cfbcc5</span><br><span class="line">[root@node1 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">712b32668ed2   bridge    bridge    local</span><br><span class="line">ca94de41081d   host      host      local</span><br><span class="line">8e707433b97d   netWork   bridge    local# 这是我们新建出来的网络</span><br><span class="line">2ef78fbe2411   none      null      local</span><br><span class="line">[root@node1 ~]# docker run -it --network=8e centos /bin/bash# 通过--network来指定容器网络</span><br><span class="line">[root@d9c64ba08629 /]# ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:c0:a8:e9:01 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 192.168.233.1/24 brd 192.168.233.255 scope global eth0# 已经获取到我们设置的地址</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@d9c64ba08629 /]#</span><br></pre></td></tr></table></figure><p><strong>#不同Bridge的容器之间不能互通</strong></p><h2 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h2><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070145064-275099183.png"></p><h6 id="Container模式是将创建好的新容器和已经存在的容器共享同一个网络-IP-x2F-Port-，而不是跟Bridge模式一样，新容器也不会创建一个属于自己的网卡和配置IP地址等等。当然，除了网络环境容器的其他资源还是默认进行隔离的。"><a href="#Container模式是将创建好的新容器和已经存在的容器共享同一个网络-IP-x2F-Port-，而不是跟Bridge模式一样，新容器也不会创建一个属于自己的网卡和配置IP地址等等。当然，除了网络环境容器的其他资源还是默认进行隔离的。" class="headerlink" title="Container模式是将创建好的新容器和已经存在的容器共享同一个网络(IP&#x2F;Port)，而不是跟Bridge模式一样，新容器也不会创建一个属于自己的网卡和配置IP地址等等。当然，除了网络环境容器的其他资源还是默认进行隔离的。"></a>Container模式是将创建好的新容器和已经存在的容器共享同一个网络(IP&#x2F;Port)，而不是跟Bridge模式一样，新容器也不会创建一个属于自己的网卡和配置IP地址等等。当然，除了网络环境容器的其他资源还是默认进行隔离的。</h6><h2 id="None"><a href="#None" class="headerlink" title="None"></a>None</h2><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070154007-2147253083.png"></p><h6 id="None模式Docker不会为容器进行任何网络的设置，当创建好这个容器它不会拥有IP地址、DNS、路由等等，需要我们手动对容器进行设置，这种网络类型的容器是没有办法进行联网的。"><a href="#None模式Docker不会为容器进行任何网络的设置，当创建好这个容器它不会拥有IP地址、DNS、路由等等，需要我们手动对容器进行设置，这种网络类型的容器是没有办法进行联网的。" class="headerlink" title="None模式Docker不会为容器进行任何网络的设置，当创建好这个容器它不会拥有IP地址、DNS、路由等等，需要我们手动对容器进行设置，这种网络类型的容器是没有办法进行联网的。"></a>None模式Docker不会为容器进行任何网络的设置，当创建好这个容器它不会拥有IP地址、DNS、路由等等，需要我们手动对容器进行设置，这种网络类型的容器是没有办法进行联网的。</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建容器并设置网络为None</span></span><br><span class="line">[root@node1 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">712b32668ed2   bridge    bridge    local</span><br><span class="line">ca94de41081d   host      host      local</span><br><span class="line">8e707433b97d   netWork   bridge    local</span><br><span class="line">2ef78fbe2411   none      null      local</span><br><span class="line">[root@node1 ~]# docker run -itd --network=none centos</span><br><span class="line">0f2e0509e81bb5e34f68eabe429eaf0ab4eca6d1937c62626635fdb625b16676</span><br><span class="line">[root@node1 ~]# docker exec -it 0f ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure><h2 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h2><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202112/2242444-20211218070205869-613575948.png"></p><h6 id="Host模式是指容器可以直接使用宿主机的IP地址进行通信，容器内的端口可以直接使用宿主机的端口不需要进行NAT。"><a href="#Host模式是指容器可以直接使用宿主机的IP地址进行通信，容器内的端口可以直接使用宿主机的端口不需要进行NAT。" class="headerlink" title="Host模式是指容器可以直接使用宿主机的IP地址进行通信，容器内的端口可以直接使用宿主机的端口不需要进行NAT。"></a>Host模式是指容器可以直接使用宿主机的IP地址进行通信，容器内的端口可以直接使用宿主机的端口不需要进行NAT。</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建容器并设置网络为Host</span></span><br><span class="line">[root@node1 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">712b32668ed2   bridge    bridge    local</span><br><span class="line">ca94de41081d   host      host      local</span><br><span class="line">8e707433b97d   netWork   bridge    local</span><br><span class="line">2ef78fbe2411   none      null      local</span><br><span class="line">[root@node1 ~]# docker run -itd --network host centos</span><br><span class="line">3ef7cf52eba35f6286ecc863f896ff96386fb61b79815100fe1666a7a0381e3e</span><br><span class="line">[root@node1 ~]# docker exec -it 3e ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:d0:69:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.25.250.9/24 brd 172.25.250.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fed0:69a9/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:69:3a:f3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:69:3a:f3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:b7:51:5a:38 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:b7ff:fe51:5a38/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">13: br-8e707433b97d: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:a0:c6:26:d2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.233.254/24 brd 192.168.233.255 scope global br-8e707433b97d</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:a0ff:fec6:26d2/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">17: vethbe82798@if16: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether d2:95:6d:24:8b:5f brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::d095:6dff:fe24:8b5f/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">19: veth76775e3@if18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-8e707433b97d state UP group default</span><br><span class="line">    link/ether 1a:48:2c:6f:f5:01 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::1848:2cff:fe6f:f501/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">21: vethfd72d16@if20: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether ae:d3:7c:80:fc:4e brd ff:ff:ff:ff:ff:ff link-netnsid 2</span><br><span class="line">    inet6 fe80::acd3:7cff:fe80:fc4e/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">25: vethafacb9a@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether a2:dc:c1:1d:0d:66 brd ff:ff:ff:ff:ff:ff link-netnsid 3</span><br><span class="line">    inet6 fe80::a0dc:c1ff:fe1d:d66/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 容器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh免密</title>
      <link href="/archives/17703002.html"/>
      <url>/archives/17703002.html</url>
      
        <content type="html"><![CDATA[<h1 id="记一次ssh免密登录"><a href="#记一次ssh免密登录" class="headerlink" title="记一次ssh免密登录"></a>记一次ssh免密登录</h1><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Secure Shell(安全外壳协议，ssh)，是一种加密的网络传输协议，可在不安全的网络中为网络服务提供安全的传输环境。SSH通过在网络中创建安全隧道来实现SSH客户端与服务器之间的连接。虽然如何网络服务都可以通过SSH实现安全传输，SSH最常见的用途是远程登陆系统，通常利用SSH来传输命令行界面和远程执行命令。</span><br></pre></td></tr></table></figure><ul><li>对称加密</li></ul><h6 id="对称加密使用同一个密钥来进行加密和解密。账号密码-口令-可以看作一种对称加密方式"><a href="#对称加密使用同一个密钥来进行加密和解密。账号密码-口令-可以看作一种对称加密方式" class="headerlink" title="对称加密使用同一个密钥来进行加密和解密。账号密码(口令)可以看作一种对称加密方式"></a>对称加密使用同一个密钥来进行加密和解密。账号密码(口令)可以看作一种对称加密方式</h6><ul><li>非对称加密</li></ul><h6 id="非对称加密有两个密钥：私钥和公钥，数据使用公钥加密后，只能用私钥进行解密。"><a href="#非对称加密有两个密钥：私钥和公钥，数据使用公钥加密后，只能用私钥进行解密。" class="headerlink" title="非对称加密有两个密钥：私钥和公钥，数据使用公钥加密后，只能用私钥进行解密。"></a>非对称加密有两个密钥：私钥和公钥，数据使用公钥加密后，只能用私钥进行解密。</h6><ul><li><p>公钥：加密，公开</p></li><li><p>私钥：解密，私有</p></li><li><p>SSH的两种登录方式</p><ul><li>口令登录</li></ul><p> <img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210516095918016-940482157.png"></p><ul><li><p>密钥登录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提前将公钥发送到目标服务器中</span></span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210516095927182-1093029143.png"></p><ol><li>发送登录请求并发送一个公钥指纹，服务器对指纹进行验证，查看指纹是否一致</li><li>服务器随机生成一串随机数，使用公钥加密</li><li>客户端使用私钥进行解密，并发送解密后的信息</li><li>对解密后的信息对比是否一致</li></ol></li></ul></li></ul><h1 id="路由器配置ssh免密登录"><a href="#路由器配置ssh免密登录" class="headerlink" title="路由器配置ssh免密登录"></a>路由器配置ssh免密登录</h1><blockquote><p>以H3C路由器为例，HCL环境</p></blockquote><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210516095940072-1200134666.png"></p><ol><li><p>配置IP地址略</p></li><li><p>生成密钥对</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">win10的cmd下生成的，也可使用其它工具进行生成</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line">C:\Users\Tao&gt;ssh-keygen -t rsa -b 2048</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">t 指定密钥类型默认rsa</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b 指定密钥长度默认2048</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (C:\Users\Tao/.ssh/id_rsa): Tao   # 保存的文件名</span><br><span class="line">Enter passphrase (empty for no passphrase):# 这里设置密钥的密码按需设置</span><br><span class="line">Enter same passphrase again:# 这里确认密钥的密码</span><br><span class="line">Your identification has been saved in Tao.</span><br><span class="line">Your public key has been saved in Tao.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:B0k4N7yruAZ3CYD9a3wbOq97kNKvwa/tmdmg1PNhWFo tao@DESKTOP-3TSULKA# 指纹信息</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">| o     o.        |</span><br><span class="line">|. o   o.+.       |</span><br><span class="line">|   o   ooo       |</span><br><span class="line">|    o   ..       |</span><br><span class="line">|   o + .E..      |</span><br><span class="line">|  o.O.==..       |</span><br><span class="line">|   =+B*+o        |</span><br><span class="line">|   .===X .       |</span><br><span class="line">|   .B@O o        |</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure></li><li><p>将公钥放置路由器</p><p>我这里使用的win10的IIS中的FTP配置过程略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;H3C&gt;ftp 192.168.56.101# 使用ftp登录</span><br><span class="line">Press CTRL+C to abort.</span><br><span class="line">Connected to 192.168.56.101 (192.168.56.101).</span><br><span class="line">220 Microsoft FTP Service</span><br><span class="line">User (192.168.56.101:(none)): anonymous# 输入用户名  匿名用户名为：anonymous</span><br><span class="line">331 Anonymous access allowed, send identity (e-mail name) as password.</span><br><span class="line">Password:</span><br><span class="line">230 User logged in.</span><br><span class="line">Remote system type is Windows_NT.</span><br><span class="line"><span class="meta prompt_">ftp&gt; </span><span class="language-bash"><span class="built_in">dir</span><span class="comment"># 列出文件</span></span></span><br><span class="line">227 Entering Passive Mode (192,168,56,101,249,170).</span><br><span class="line">125 Data connection already open; Transfer starting.</span><br><span class="line">05-16-21  08:35AM                  402 Tao.pub# 这是我们的公钥 ，生成两个文件后缀为.pub的是公钥，没有后缀的是私钥</span><br><span class="line">226 Transfer complete.</span><br><span class="line"><span class="meta prompt_">ftp&gt; </span><span class="language-bash">get Tao.pub<span class="comment"># 下载</span></span></span><br><span class="line">227 Entering Passive Mode (192,168,56,101,249,171).</span><br><span class="line">125 Data connection already open; Transfer starting.</span><br><span class="line">.</span><br><span class="line">226 Transfer complete.</span><br><span class="line">402 bytes received in 0.002 seconds (196.29 Kbytes/s)</span><br><span class="line"><span class="meta prompt_">ftp&gt; </span><span class="language-bash">quit<span class="comment"># 退出ftp</span></span></span><br><span class="line">221 Goodbye.</span><br><span class="line">&lt;H3C&gt;dir# 查看路由器的文件</span><br><span class="line">Directory of flash:</span><br><span class="line">   0 -rw-         402 May 16 2021 08:36:36   Tao.pub</span><br><span class="line">   1 drw-           - May 15 2021 17:19:14   diagfile</span><br><span class="line">   2 -rw-         402 May 16 2021 04:31:50   h3c.pub# 这就是我们刚刚下载下来的公钥</span><br><span class="line">   3 -rw-         735 May 16 2021 04:32:38   hostkey</span><br><span class="line">   4 -rw-       43136 May 15 2021 17:19:14   licbackup</span><br><span class="line">   5 drw-           - May 15 2021 17:19:14   license</span><br><span class="line">   6 -rw-       43136 May 15 2021 17:19:14   licnormal</span><br><span class="line">   7 drw-           - May 15 2021 17:19:14   logfile</span><br><span class="line">   8 -rw-           0 May 15 2021 17:19:14   msr36-cmw710-boot-a7514.bin</span><br><span class="line">   9 -rw-           0 May 15 2021 17:19:14   msr36-cmw710-system-a7514.bin</span><br><span class="line">  10 drw-           - May 15 2021 17:19:20   pki</span><br><span class="line">  11 drw-           - May 15 2021 17:19:14   seclog</span><br><span class="line">  12 -rw-         591 May 16 2021 04:32:38   serverkey</span><br><span class="line"></span><br><span class="line">1046512 KB total (1046356 KB free)</span><br><span class="line"></span><br><span class="line">&lt;H3C&gt;</span><br></pre></td></tr></table></figure></li><li><p>配置路由器SSH</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[H3C]public-key local create rsa# 生成rsa密钥对</span><br><span class="line">[H3C]ssh server enable# 开启ssh</span><br><span class="line">[H3C]line vty 0 4# 配置虚拟接口</span><br><span class="line">[H3C-line-vty0-4]authentication-mode scheme# 认证方式</span><br><span class="line">[H3C-line-vty0-4]quit</span><br><span class="line">[H3C]public-key peer h3c import sshkey Tao.pub  # 导入公钥并更名为h3c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置ssh用户的认证方式并指定公钥为h3c</span></span><br><span class="line">[H3C]ssh user xiaowangc service-type stelnet authentication-type publickey assign publickey h3c</span><br><span class="line">[H3C]local-user xiaowangc class manage# 创建本地用户</span><br><span class="line">[H3C-luser-manage-xiaowangc]service-type ssh# 服务器类型</span><br><span class="line">[H3C-luser-manage-xiaowangc]authorization-attribute user-role network-admin  # 用户角色</span><br><span class="line">[H3C-luser-manage-xiaowangc]quit</span><br></pre></td></tr></table></figure></li><li><p>测试连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Tao&gt;ssh xiaowangc@192.168.56.110 -c aes128-cbc -i Tao</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">i 指定私钥</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c 指定加密类型</span></span><br><span class="line">The authenticity of host &#x27;192.168.56.110 (192.168.56.110)&#x27; can&#x27;t be established.</span><br><span class="line">RSA key fingerprint is SHA256:wMmxasuUNqNvee0426c5wUcV5rcdphvVoGw3SaR7vBU.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes# 是否永久添加到列表</span><br><span class="line">Warning: Permanently added &#x27;192.168.56.110&#x27; (RSA) to the list of known hosts.</span><br><span class="line"></span><br><span class="line">******************************************************************************</span><br><span class="line">* Copyright (c) 2004-2017 New H3C Technologies Co., Ltd. All rights reserved.*</span><br><span class="line">* Without the owner&#x27;s prior written consent,                                 *</span><br><span class="line">* no decompiling or reverse-engineering shall be allowed.                    *</span><br><span class="line">******************************************************************************</span><br><span class="line"></span><br><span class="line">&lt;H3C&gt;</span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210516095955089-30077918.png"></p></li><li><p>如果不想每次连接都指定加密类型和密钥可配置config文件（略）</p></li></ol><h1 id="Linux配置ssh免密登录"><a href="#Linux配置ssh免密登录" class="headerlink" title="Linux配置ssh免密登录"></a>Linux配置ssh免密登录</h1><ol><li><p><a href="https://www.cnblogs.com/xiaowangc/p/14743138.html">安装</a>,网络拓扑<br><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210516100810436-2011226014.png"></p></li><li><p>生成密钥对</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">win10的cmd下生成的，也可使用其它工具进行生成</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line">C:\Users\Tao&gt;ssh-keygen -t rsa -b 2048</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">t 指定密钥类型默认rsa</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b 指定密钥长度默认2048</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (C:\Users\Tao/.ssh/id_rsa): Tao   # 保存的文件名</span><br><span class="line">Enter passphrase (empty for no passphrase):# 这里设置密钥的密码按需设置</span><br><span class="line">Enter same passphrase again:# 这里确认密钥的密码</span><br><span class="line">Your identification has been saved in Tao.</span><br><span class="line">Your public key has been saved in Tao.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:B0k4N7yruAZ3CYD9a3wbOq97kNKvwa/tmdmg1PNhWFo tao@DESKTOP-3TSULKA# 指纹信息</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">| o     o.        |</span><br><span class="line">|. o   o.+.       |</span><br><span class="line">|   o   ooo       |</span><br><span class="line">|    o   ..       |</span><br><span class="line">|   o + .E..      |</span><br><span class="line">|  o.O.==..       |</span><br><span class="line">|   =+B*+o        |</span><br><span class="line">|   .===X .       |</span><br><span class="line">|   .B@O o        |</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure></li><li><p>将公钥上传至服务器，并进行配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum -y install ftp# 安装ftp客户端</span><br><span class="line">[root@localhost ~]# ftp 192.168.204.1# 登录</span><br><span class="line">Connected to 192.168.204.1 (192.168.204.1).</span><br><span class="line">220 Microsoft FTP Service</span><br><span class="line">Name (192.168.204.1:root): anonymous</span><br><span class="line">331 Anonymous access allowed, send identity (e-mail name) as password.</span><br><span class="line">Password:</span><br><span class="line">230 User logged in.</span><br><span class="line">Remote system type is Windows_NT.</span><br><span class="line"><span class="meta prompt_">ftp&gt; </span><span class="language-bash"><span class="built_in">dir</span></span></span><br><span class="line">227 Entering Passive Mode (192,168,204,1,253,61).</span><br><span class="line">125 Data connection already open; Transfer starting.</span><br><span class="line">05-16-21  08:35AM                  402 Tao.pub</span><br><span class="line">226 Transfer complete.</span><br><span class="line"><span class="meta prompt_">ftp&gt; </span><span class="language-bash">get Tao.pub<span class="comment"># 下载公钥</span></span></span><br><span class="line">local: Tao.pub remote: Tao.pub</span><br><span class="line">227 Entering Passive Mode (192,168,204,1,253,63).</span><br><span class="line">125 Data connection already open; Transfer starting.</span><br><span class="line">226 Transfer complete.</span><br><span class="line">402 bytes received in 0.0001 secs (4020.00 Kbytes/sec)</span><br><span class="line"><span class="meta prompt_">ftp&gt;</span><span class="language-bash">quit</span></span><br><span class="line">[root@localhost ~]# mkdir .ssh# 创建.ssh文件</span><br><span class="line">[root@localhost ~]# cat Tao.pub &gt;&gt; .ssh/authorized_keys# 将公钥存放至文件</span><br></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Tao&gt;ssh root@192.168.204.131 -i Tao</span><br><span class="line">Last login: Sun May 16 09:41:55 2021 from 192.168.204.1</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210516100007661-2090560518.png"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> openssh </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh免密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx基础</title>
      <link href="/archives/a7bddb95.html"/>
      <url>/archives/a7bddb95.html</url>
      
        <content type="html"><![CDATA[<h1 id="Nginx软件包方式安装与配置"><a href="#Nginx软件包方式安装与配置" class="headerlink" title="Nginx软件包方式安装与配置"></a>Nginx软件包方式安装与配置</h1><blockquote><p>Nginx概念请转到👉<a href="https://www.cnblogs.com/xiaowangc/p/14742769.html">概念</a>；Linux安装请转发👉<a href="https://www.cnblogs.com/xiaowangc/p/14743138.html">安装</a></p></blockquote><h2 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h2><blockquote><p>两种安装方式：1、yum安装   2、安装包安装(<strong>此次演示本方式</strong>)</p></blockquote><ul><li><p>准备环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装编译环境</span></span><br><span class="line">[root@localhost ~]# yum -y install gcc gcc-c++ automake autoconf libtool make wget vim</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装PCRE库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">https://ftp.pcre.org/pub/pcre/pcre-8.44.tar.gz</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">官网：https://pcre.org/</span></span><br><span class="line">[root@localhost ~]# wget https://ftp.pcre.org/pub/pcre/pcre-8.44.tar.gz</span><br><span class="line">[root@localhost ~]# tar -zxvf pcre-8.44.tar.gz</span><br><span class="line">[root@localhost ~]#cd pcre-8.44</span><br><span class="line">[root@localhost pcre-8.44]#</span><br><span class="line">[root@localhost pcre-8.44]# ./configure</span><br><span class="line">[root@localhost pcre-8.44]#make</span><br><span class="line">[root@localhost pcre-8.44]#make install</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装zlib库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http://zlib.net/zlib-1.2.11.tar.gz</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">官网：http://zlib.net/</span></span><br><span class="line">[root@localhost ~]# wget http://zlib.net/zlib-1.2.11.tar.gz</span><br><span class="line">[root@localhost ~]#tar -zxvf zlib-1.2.11.tar.gz</span><br><span class="line">[root@localhost ~]# cd zlib-1.2.11</span><br><span class="line">[root@localhost zlib-1.2.11]#make</span><br><span class="line">[root@localhost zlib-1.2.11]#make install</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>下载👉<a href="http://nginx.org/en/download.html">官网</a></p></li><li><p>选择稳定版</p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031227787-1182612237.png"></p></li><li><p>右键复制链接地址</p></li></ul><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031238524-1856243410.png"></p><ul><li><p>下载解压编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# wget http://nginx.org/download/nginx-1.20.0.tar.gz</span><br><span class="line">[root@localhost ~]# tar -zxvf nginx-1.20.0.tar.gz</span><br><span class="line">[root@localhost ~]# cd nginx-1.20.0</span><br><span class="line">[root@localhost nginx-1.20.0]# ./configure</span><br><span class="line">[root@localhost nginx-1.20.0]# make </span><br><span class="line">[root@localhost nginx-1.20.0]# make install</span><br></pre></td></tr></table></figure><p>注意安装路径</p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031253315-859014338.png"></p></li></ul><h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><blockquote><p>可设置环境变量或者使用软连接 </p><p>ln -s &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx &#x2F;sbin&#x2F;nginx</p><p>启动、停止、重载就不需要加绝对路径或者进入nginx目录</p><p>例：1、nginx 启动  2、nginx -s  stop 停止 3、nginx -s reload 重载</p><p>[root@localhost ~]# whereis nginx#可使用whereis nginx查找nginx所在的位置<br>nginx: &#x2F;usr&#x2F;sbin&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;nginx</p></blockquote><ul><li><p>启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# /usr/local/nginx/sbin/nginx#启动</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] still could not bind()</span><br><span class="line">[root@localhost ~]# ps -aux | grep nginx</span><br><span class="line">root       25085  0.0  0.0  32976   380 ?        Ss   00:44   0:00 nginx: master process ./nginx</span><br><span class="line">nobody     25086  0.0  0.5  66580  4484 ?        S    00:44   0:00 nginx: worker process</span><br><span class="line">root       25147  0.0  0.1  12112   976 pts/0    S+   00:51   0:00 grep --color=auto nginx</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li><li><p>停止</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# /usr/local/nginx/sbin/nginx -s stop#停止</span><br><span class="line">[root@localhost ~]# ps -aux | grep nginx</span><br><span class="line">root       25157  0.0  0.1  12112  1080 pts/0    R+   00:51   0:00 grep --color=auto nginx</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></li><li><p>重启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# /usr/local/nginx/sbin/nginx -s reload#重新加载</span><br></pre></td></tr></table></figure></li></ul><h2 id="Nginx配置文件详解"><a href="#Nginx配置文件详解" class="headerlink" title="Nginx配置文件详解"></a>Nginx配置文件详解</h2><blockquote><p>Nginx配置文件结构</p><p>全局块、events块、http块、server块、location块</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">  1</span><br><span class="line">  2 #user  nobody;</span><br><span class="line">  3 worker_processes  1;#worder进程的数量</span><br><span class="line">  4</span><br><span class="line">  5 #error_log  logs/error.log;</span><br><span class="line">  6 #error_log  logs/error.log  notice;</span><br><span class="line">  7 #error_log  logs/error.log  info;</span><br><span class="line">  8</span><br><span class="line">  9 #pid        logs/nginx.pid;</span><br><span class="line"> 10</span><br><span class="line"> 11</span><br><span class="line"> 12 events &#123;</span><br><span class="line"> 13     worker_connections  1024;#最大连接数</span><br><span class="line"> 14 &#125;</span><br><span class="line"> 15</span><br><span class="line"> 16</span><br><span class="line"> 17 http &#123;</span><br><span class="line"> 18     include       mime.types;#Nginx支撑的媒体类型库文件</span><br><span class="line"> 19     default_type  application/octet-stream;#默认的媒体类型</span><br><span class="line"> 20</span><br><span class="line"> 21     #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line"> 22     #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line"> 23     #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"> 24</span><br><span class="line"> 25     #access_log  logs/access.log  main;</span><br><span class="line"> 26</span><br><span class="line"> 27     sendfile        on;#高效传输</span><br><span class="line"> 28     #tcp_nopush     on;</span><br><span class="line"> 29</span><br><span class="line"> 30     #keepalive_timeout  0;</span><br><span class="line"> 31     keepalive_timeout  65;#超时时间</span><br><span class="line"> 32</span><br><span class="line"> 33     #gzip  on;</span><br><span class="line"> 34</span><br><span class="line"> 35     server &#123;#第一个Server区块开始，表示一个独立的虚拟主机</span><br><span class="line"> 36         listen       80;#监听端口</span><br><span class="line"> 37         server_name  localhost;#监听IP或者域名</span><br><span class="line"> 38</span><br><span class="line"> 39         #charset koi8-r;</span><br><span class="line"> 40</span><br><span class="line"> 41         #access_log  logs/host.access.log  main;</span><br><span class="line"> 42</span><br><span class="line"> 43         location / &#123;</span><br><span class="line"> 44             root   html;#站点的根目录</span><br><span class="line"> 45             index  index.html index.htm;#首页文件</span><br><span class="line"> 46         &#125;</span><br><span class="line"> 47</span><br><span class="line"> 48         #error_page  404              /404.html;</span><br><span class="line"> 49</span><br><span class="line"> 50         # redirect server error pages to the static page /50x.html</span><br><span class="line"> 51         #</span><br><span class="line"> 52         error_page   500 502 503 504  /50x.html;</span><br><span class="line"> 53         location = /50x.html &#123;</span><br><span class="line"> 54             root   html;</span><br><span class="line"> 55         &#125;</span><br><span class="line"> 56</span><br><span class="line"> 57         # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line"> 58         #</span><br><span class="line"> 59         #location ~ \.php$ &#123;</span><br><span class="line"> 60         #    proxy_pass   http://127.0.0.1;</span><br><span class="line"> 61         #&#125;</span><br><span class="line"> 62</span><br><span class="line"> 63         # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line"> 64         #</span><br><span class="line"> 65         #location ~ \.php$ &#123;</span><br><span class="line"> 66         #    root           html;</span><br><span class="line"> 67         #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line"> 68         #    fastcgi_index  index.php;</span><br><span class="line"> 69         #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line"> 70         #    include        fastcgi_params;</span><br><span class="line"> 71         #&#125;</span><br><span class="line"> 72</span><br><span class="line"> 73         # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line"> 74         # concurs with nginx&#x27;s one</span><br><span class="line"> 75         #</span><br><span class="line"> 76         #location ~ /\.ht &#123;</span><br><span class="line"> 77         #    deny  all;</span><br><span class="line"> 78         #&#125;</span><br><span class="line"> 79     &#125;</span><br><span class="line"> 80</span><br><span class="line"> 81</span><br><span class="line"> 82     # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line"> 83     #</span><br><span class="line"> 84     #server &#123;</span><br><span class="line"> 85     #    listen       8000;</span><br><span class="line"> 86     #    listen       somename:8080;</span><br><span class="line"> 87     #    server_name  somename  alias  another.alias;</span><br><span class="line"> 88</span><br><span class="line"> 89     #    location / &#123;</span><br><span class="line"> 90     #        root   html;</span><br><span class="line"> 91     #        index  index.html index.htm;</span><br><span class="line"> 92     #    &#125;</span><br><span class="line"> 93     #&#125;</span><br><span class="line"> 94</span><br><span class="line"> 95</span><br><span class="line"> 96     # HTTPS server</span><br><span class="line"> 97     #</span><br><span class="line"> 98     #server &#123;</span><br><span class="line"> 99     #    listen       443 ssl;</span><br><span class="line">100     #    server_name  localhost;</span><br><span class="line">101</span><br><span class="line">102     #    ssl_certificate      cert.pem;</span><br><span class="line">103     #    ssl_certificate_key  cert.key;</span><br><span class="line">104</span><br><span class="line">105     #    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">106     #    ssl_session_timeout  5m;</span><br><span class="line">107</span><br><span class="line">108     #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">109     #    ssl_prefer_server_ciphers  on;</span><br><span class="line">110</span><br><span class="line">111     #    location / &#123;</span><br><span class="line">112     #        root   html;</span><br><span class="line">113     #        index  index.html index.htm;</span><br><span class="line">114     #    &#125;</span><br><span class="line">115     #&#125;</span><br><span class="line">116</span><br><span class="line">117 &#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">全局设置</span><br><span class="line"></span><br><span class="line">events&#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">events块</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http块</span></span><br><span class="line">server&#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">server块 or 虚拟机主机</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location&#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">location块</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Nginx反向代理"><a href="#Nginx反向代理" class="headerlink" title="Nginx反向代理"></a>Nginx反向代理</h2><ul><li>网络拓扑图</li></ul><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031335456-997331290.png"></p><ul><li><p>准备Tomcat环境</p><blockquote><p>快速部署Tomcat</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@Tomcat ~]# yum install java-1.8.0-openjdk vim wget</span><br><span class="line">[root@Tomcat ~]# java -version</span><br><span class="line">openjdk version &quot;1.8.0_292&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_292-b10)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.292-b10, mixed mode)</span><br><span class="line">[root@Tomcat ~]#</span><br><span class="line">[root@Tomcat ~]# wget https://mirrors.bfsu.edu.cn/apache/tomcat/tomcat-10/v10.0.5/bin/apache-tomcat-10.0.5.tar.gz</span><br><span class="line">[root@Tomcat ~]# tar -zxvf apache.tomcat-10.0.5.tar.gz</span><br><span class="line">[root@Tomcat ~]# apache-tomcat-10.0.5/bin/startup.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭防火墙、selinux</span></span><br><span class="line">[root@localhost sbin]# systemctl stop firewalld.service</span><br><span class="line">[root@localhost sbin]# setenforce 0</span><br></pre></td></tr></table></figure><p><strong>测试</strong></p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031358405-1964160705.png"></p></li><li><p>配置Nginx反向代理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">在location块添加如下配置</span><br><span class="line">proxy_pass http://192.168.204.131:8080;#Tomcat服务器地址，注意端口号和；结尾</span><br></pre></td></tr></table></figure></li></ul><p> <img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031417367-1294720935.png"></p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动Nginx</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cd /usr/local/nginx/sbin/</span><br><span class="line">[root@localhost sbin]# ./nginx</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span><br><span class="line">nginx: [emerg] still could not bind()</span><br><span class="line">[root@localhost sbin]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭防火墙和selinux</span></span><br><span class="line">[root@localhost sbin]# systemctl stop firewalld.service</span><br><span class="line">[root@localhost sbin]# setenforce 0</span><br></pre></td></tr></table></figure><ul><li><p>访问测试</p><blockquote><p>我们Nginx的IP地址为192.168.204.135，Tomcat的IP地址为192.168.204.131，从上面Tomcat测试即可看出。</p></blockquote><p>通过访问Nginx服务器地址能够打开Tomcat页面则反向代理成功</p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031432454-745109270.png"></p></li></ul><h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><ul><li>网络拓扑图</li></ul><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031445059-119842436.png"></p><ul><li><p>搭建Tomcat服务器</p><blockquote><p>需要搭建两台Tomcat服务器</p></blockquote><ul><li>Tomcat01</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@Tomcat01 ~]# yum install java-1.8.0-openjdk wget vim</span><br><span class="line">[root@Tomcat01 ~]# java -version</span><br><span class="line">openjdk version &quot;1.8.0_292&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_292-b10)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.292-b10, mixed mode)</span><br><span class="line">[root@Tomcat01 ~]#</span><br><span class="line">[root@Tomcat01 ~]# wget https://mirrors.bfsu.edu.cn/apache/tomcat/tomcat-10/v10.0.5/bin/apache-tomcat-10.0.5.tar.gz</span><br><span class="line">[root@Tomcat01 ~]# tar -zxvf apache.tomcat-10.0.5.tar.gz</span><br><span class="line">[root@Tomcat01 ~]# apache-tomcat-10.0.5/bin/startup.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭防火墙、selinux</span></span><br><span class="line">[root@Tomcat01 ~]# systemctl stop firewalld.service</span><br><span class="line">[root@Tomcat01 ~]# setenforce 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改主页方便区分</span></span><br><span class="line">[root@Tomcat01 ~]# vim apache-tomcat-10.0.5/webapps/ROOT/index.jsp</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031501672-8203707.png"></p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031510179-637395018.png"></p><ul><li>Tomcat02</li></ul>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@Tomcat02 ~]# yum install java-1.8.0-openjdk wget vim</span><br><span class="line">[root@Tomcat02 ~]# java -version</span><br><span class="line">openjdk version &quot;1.8.0_292&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_292-b10)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.292-b10, mixed mode)</span><br><span class="line">[root@Tomcat02 ~]#</span><br><span class="line">[root@Tomcat02 ~]# wget https://mirrors.bfsu.edu.cn/apache/tomcat/tomcat-10/v10.0.5/bin/apache-tomcat-10.0.5.tar.gz</span><br><span class="line">[root@Tomcat02 ~]# tar -zxvf apache.tomcat-10.0.5.tar.gz</span><br><span class="line">[root@Tomcat02 ~]#apache-tomcat-10.0.5/bin/startup.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭防火墙、selinux</span></span><br><span class="line">[root@Tomcat02 ~]# systemctl stop firewalld.service</span><br><span class="line">[root@Tomcat02 ~]# setenforce 0</span><br><span class="line">[root@Tomcat02 ~]# vim apache-tomcat-10.0.5/webapps/ROOT/index.jsp</span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031527365-1203091669.png"></p><ul><li>测试Tomcat01和02服务器</li></ul><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031536096-75766892.png"></p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031546910-1903805597.png"></p><ul><li><p>配置Nginx负载均衡</p><p>安装请参考<code>一、Nginx安装</code></p><p>配置Nginx文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">upstream 192.168.204.135 &#123;  #可更改为域名和proxy_pass对应</span><br><span class="line">        server 192.168.204.131:8080;# Tomcat01服务器IP地址：端口；</span><br><span class="line">        server 192.168.204.132:8080;# Tomcat02服务器IP地址：端口</span><br><span class="line">    &#125;</span><br><span class="line"> server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">           root   html;</span><br><span class="line">           index  index.html index.htm;</span><br><span class="line">           proxy_pass http://192.168.204.135;#本机IP地址：可更改为域名</span><br><span class="line">        &#125;    </span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031627328-1440815567.png"></p></li><li><p>重启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# /usr/local/nginx/sbin/nginx#启动或重载 -s reload</span><br></pre></td></tr></table></figure></li><li><p>测试，访问Nginx服务器</p><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031642786-29743126.png"></p></li><li><p>刷新</p></li></ul><p> <img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031652444-156414122.png"></p><h2 id="权重轮询"><a href="#权重轮询" class="headerlink" title="权重轮询"></a>权重轮询</h2><blockquote><p>假如我们两台服务器Tomcat01的性能优于Toncat02我们可以通过配置权重，让大部分请求交给Tomcat01处理</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream 192.168.204.135 &#123;</span><br><span class="line">        server 192.168.204.131:8080 weigth=8;#权重为8</span><br><span class="line">        server 192.168.204.132:8080 weigth=2;#权重为2默认为1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">每个10个请求，有8个转发给192.168.204.131</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2个转发给192.168.204.132</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">           root   html;</span><br><span class="line">           index  index.html index.htm;</span><br><span class="line">           proxy_pass http://192.168.204.135;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><img src="https://images.weserv.nl/?url=https://img2020.cnblogs.com/blog/2242444/202105/2242444-20210508031702290-1811097978.png"></p>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
