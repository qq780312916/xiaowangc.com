<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>k8s二进制安装方法 | 尤妤</title><meta name="keywords" content="kubernetes"><meta name="author" content="尤妤"><meta name="copyright" content="尤妤"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="K8S二进制安装对于安装过程中的证书以及配置文件不做过多讲解 详情请参考：https:&#x2F;&#x2F;www.xiaowangc.com&#x2F;2022&#x2F;09&#x2F;18&#x2F;k8s-zhengshu&#x2F; 我们在翻阅kubernets官网文章时，有注意的小伙伴就会发现官方只介绍了使用kubeadm等工具进行安装，并没有介绍或者详细介绍二进制的安装方法，但是网上的却有很多介绍二进制安装，证书生成等教程。那么我曾就有这个疑问，他们">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s二进制安装方法">
<meta property="og:url" content="https://www.xiaowangc.com/archives/a6cffccf.html">
<meta property="og:site_name" content="尤妤">
<meta property="og:description" content="K8S二进制安装对于安装过程中的证书以及配置文件不做过多讲解 详情请参考：https:&#x2F;&#x2F;www.xiaowangc.com&#x2F;2022&#x2F;09&#x2F;18&#x2F;k8s-zhengshu&#x2F; 我们在翻阅kubernets官网文章时，有注意的小伙伴就会发现官方只介绍了使用kubeadm等工具进行安装，并没有介绍或者详细介绍二进制的安装方法，但是网上的却有很多介绍二进制安装，证书生成等教程。那么我曾就有这个疑问，他们">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.xiaowangc.com/img/fengmian/k8s.jpeg">
<meta property="article:published_time" content="2022-09-18T14:29:39.000Z">
<meta property="article:modified_time" content="2022-10-17T18:18:19.000Z">
<meta property="article:author" content="尤妤">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.xiaowangc.com/img/fengmian/k8s.jpeg"><link rel="shortcut icon" href="/img/touxiang.jpg"><link rel="canonical" href="https://www.xiaowangc.com/archives/a6cffccf"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 尤妤","link":"链接: ","source":"来源: 尤妤","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'k8s二进制安装方法',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-18 02:18:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">53</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-screwdriver-wrench"></i><span> 工具</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://api.xiaowangc.com"><i class="fa-fw fas fa-location-dot"></i><span> IP地址查询</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://decoder.link/"><i class="fa-fw fa-brands fa-expeditedssl"></i><span> TLS检测工具</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://freessl.cn/"><i class="fa-fw fas fa-lock"></i><span> TLS证书申请1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://letsencrypt.org/"><i class="fa-fw fas fa-lock"></i><span> TLS证书申请2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.sslforfree.com/"><i class="fa-fw fas fa-lock"></i><span> TLS证书申请3</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://awesome-prometheus-alerts.grep.to/"><i class="fa-fw fa-brands fa-watchman-monitoring"></i><span> PromAlertRules</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://ssl-config.mozilla.org/"><i class="fa-fw fa-brands fa-expeditedssl"></i><span> TLS配置生成器</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/fengmian/k8s.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">尤妤</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-screwdriver-wrench"></i><span> 工具</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://api.xiaowangc.com"><i class="fa-fw fas fa-location-dot"></i><span> IP地址查询</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://decoder.link/"><i class="fa-fw fa-brands fa-expeditedssl"></i><span> TLS检测工具</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://freessl.cn/"><i class="fa-fw fas fa-lock"></i><span> TLS证书申请1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://letsencrypt.org/"><i class="fa-fw fas fa-lock"></i><span> TLS证书申请2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.sslforfree.com/"><i class="fa-fw fas fa-lock"></i><span> TLS证书申请3</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://awesome-prometheus-alerts.grep.to/"><i class="fa-fw fa-brands fa-watchman-monitoring"></i><span> PromAlertRules</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://ssl-config.mozilla.org/"><i class="fa-fw fa-brands fa-expeditedssl"></i><span> TLS配置生成器</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">k8s二进制安装方法</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-18T14:29:39.000Z" title="发表于 2022-09-18 22:29:39">2022-09-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-17T18:18:19.000Z" title="更新于 2022-10-18 02:18:19">2022-10-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Kubernetes/">Kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="k8s二进制安装方法"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="K8S二进制安装"><a href="#K8S二进制安装" class="headerlink" title="K8S二进制安装"></a>K8S二进制安装</h1><p><strong>对于安装过程中的证书以及配置文件不做过多讲解</strong></p>
<p><strong>详情请参考：<a href="https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/">https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/</a></strong></p>
<p>我们在翻阅kubernets官网文章时，有注意的小伙伴就会发现官方只介绍了使用kubeadm等工具进行安装，并没有介绍或者详细介绍二进制的安装方法，但是网上的却有很多介绍二进制安装，证书生成等教程。那么我曾就有这个疑问，<strong>他们是到底怎么学会二进制的呢</strong>？</p>
<p>Kubernetes是开源的容器编排工具，而底层还是容器技术；在通过Kubeadm工具安装Kubernetes集群时，每个组件还是以容器的方式运行的。容器的本质就是<code>对进程进行隔离</code>的一项技术，<strong>容器内其实运行的也是二进制</strong>。我们可以对adm安装的集群包括证书、二进制参数、配置文件等进行分析，大致就能明白如何通过二进制的方式对kubernetes进行安装。知道这种方式那么通过adm安装的Kubernetes集群是不是就是官方给我们的最好的例子！</p>
<p>预先通过adm搭建的Kubernetes集群对各个组件、证书以及容器进行分析大致就能知道二进制如何安装！此文档是根据kubeadm部署的1.23.6进行分析部署的</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><h2 id="前提准备"><a href="#前提准备" class="headerlink" title="前提准备"></a>前提准备</h2><p>本次安装采用<strong>CentOS 8.4</strong>系统上部署<strong>etcd高可用</strong>方式安装k8s 1.23.6集群</p>
<p><strong>请预先配置IP以及主机名并配置集群之间免密</strong></p>
<p>不会免密的请到：<a href="https://www.xiaowangc.com/2021/05/16/ssh/">https://www.xiaowangc.com/2021/05/16/ssh/</a></p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>master01</td>
<td>192.168.64.31&#x2F;24</td>
<td>控制平面</td>
</tr>
<tr>
<td>node01</td>
<td>192.168.64.32&#x2F;24</td>
<td>Node&#x2F;etcd01</td>
</tr>
<tr>
<td>node02</td>
<td>192.168.64.33&#x2F;24</td>
<td>Node&#x2F;etcd02</td>
</tr>
<tr>
<td>node03</td>
<td>192.168.64.34&#x2F;24</td>
<td>Node&#x2F;etcd03</td>
</tr>
</tbody></table>
<p><strong>请确保集群中主机hosts解析配置一致</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.64.31   master</span><br><span class="line">192.168.64.32   node01  node1   etcd01  etcd1</span><br><span class="line">192.168.64.33   node02  node2   etcd02  etcd2</span><br><span class="line">192.168.64.34   node03  node3   etcd03  etcd3</span><br></pre></td></tr></table></figure>

<h2 id="配置存储库-所有节点"><a href="#配置存储库-所有节点" class="headerlink" title="配置存储库(所有节点)"></a>配置存储库(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mkdir /etc/yum.repos.d/bak</span><br><span class="line">[root@master ~]# mv /etc/yum.repos.d/* /etc/yum.repos.d/bak</span><br><span class="line">[root@master ~]# curl -o /etc/yum.repos.d/a.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span><br><span class="line">[root@master ~]# curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h2 id="关闭Selinux-所有节点"><a href="#关闭Selinux-所有节点" class="headerlink" title="关闭Selinux(所有节点)"></a>关闭Selinux(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# setenforce 0</span><br><span class="line">[root@master ~]# sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<h2 id="关闭交换分区-所有节点"><a href="#关闭交换分区-所有节点" class="headerlink" title="关闭交换分区(所有节点)"></a>关闭交换分区(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# swapoff -a</span><br><span class="line">[root@master ~]# sed -ri &quot;s/.*swap.*/#&amp;/&quot; /etc/fstab</span><br></pre></td></tr></table></figure>

<h2 id="关闭防火墙-所有节点"><a href="#关闭防火墙-所有节点" class="headerlink" title="关闭防火墙(所有节点)"></a>关闭防火墙(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl disable --now firewalld</span><br></pre></td></tr></table></figure>

<h2 id="配置网桥-所有节点"><a href="#配置网桥-所有节点" class="headerlink" title="配置网桥(所有节点)"></a>配置网桥(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tee &gt; /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# tee &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# sysctl --system</span><br></pre></td></tr></table></figure>

<h2 id="安装配置Docker"><a href="#安装配置Docker" class="headerlink" title="安装配置Docker"></a>安装配置Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# curl https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">[root@master ~]# dnf -y install docker-ce --allowerasing</span><br><span class="line">[root@master ~]# systemctl enable --now docker</span><br><span class="line">[root@master ~]# tee &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line"> 	&quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="开启IPVS-所有节点"><a href="#开启IPVS-所有节点" class="headerlink" title="开启IPVS(所有节点)"></a>开启IPVS(所有节点)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tee  &gt;  /etc/sysconfig/modules/ipvs.modules &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">modprobe  --  ip_vs</span><br><span class="line">modprobe  --  ip_vs_rr</span><br><span class="line">modprobe  --  ip_vs_wrr</span><br><span class="line">modprobe  --  ip_vs_sh</span><br><span class="line">modprobe  --  nf_conntrack</span><br><span class="line">EOF</span><br><span class="line">[root@master ~]# chmod +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">[root@master ~]# /bin/bash /etc/sysconfig/modules/ipvs.modules</span><br></pre></td></tr></table></figure>



<h1 id="ETCD集群"><a href="#ETCD集群" class="headerlink" title="ETCD集群"></a>ETCD集群</h1><h2 id="下载-etcd节点"><a href="#下载-etcd节点" class="headerlink" title="下载(etcd节点)"></a>下载(etcd节点)</h2><p>ETCD下载连接：<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases/">https://github.com/etcd-io/etcd/releases/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.5.5/etcd-v3.5.5-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p><strong>通过参考kubeadm安装生成etcd配置文件,单节点ETCD部署就只在节点配置如下即可，修改对应的IP地址和证书路径</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master manifests]# ls</span><br><span class="line">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml</span><br><span class="line">[root@master manifests]# pwd</span><br><span class="line">[root@master manifests]# cat etcd.yaml</span><br><span class="line">/etc/kubernetes/manifests</span><br><span class="line">    - etcd</span><br><span class="line">    - --advertise-client-urls=https://192.168.64.11:2379</span><br><span class="line">    - --cert-file=/etc/kubernetes/pki/etcd/server.crt</span><br><span class="line">    - --client-cert-auth=true</span><br><span class="line">    - --data-dir=/var/lib/etcd</span><br><span class="line">    - --initial-advertise-peer-urls=https://192.168.64.11:2380</span><br><span class="line">    - --initial-cluster=master=https://192.168.64.11:2380</span><br><span class="line">    - --key-file=/etc/kubernetes/pki/etcd/server.key</span><br><span class="line">    - --listen-client-urls=https://127.0.0.1:2379,https://192.168.64.11:2379</span><br><span class="line">    - --listen-metrics-urls=http://127.0.0.1:2381</span><br><span class="line">    - --listen-peer-urls=https://192.168.64.11:2380</span><br><span class="line">    - --name=master</span><br><span class="line">    - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</span><br><span class="line">    - --peer-client-cert-auth=true</span><br><span class="line">    - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key</span><br><span class="line">    - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">    - --snapshot-count=10000</span><br><span class="line">    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br></pre></td></tr></table></figure>

<p>通过现环境修改成适用于高可用的ETCD集群配置</p>
<h2 id="创建etcd-CA"><a href="#创建etcd-CA" class="headerlink" title="创建etcd CA"></a>创建etcd CA</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# mkdir /etc/etcd</span><br><span class="line">[root@node01 ~]# cd /etc/etcd/</span><br><span class="line">[root@node01 etcd]# vi etcd-ca.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:etcd-ca</span><br><span class="line">[root@node01 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd-ca.key -out etcd-ca.csr -nodes -subj &#x27;/CN=etcd-ca&#x27;</span><br><span class="line">[root@node01 etcd]# openssl x509 -req -days 36500 -sha256 -extfile etcd-ca.cnf -extensions v3_ca -set_serial 0 -signkey etcd-ca.key -in etcd-ca.csr -out etcd-ca.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = etcd-ca</span><br><span class="line">Getting Private key</span><br><span class="line">[root@node01 etcd]# ls</span><br><span class="line">etcd-ca.cnf  etcd-ca.crt  etcd-ca.csr  etcd-ca.key</span><br></pre></td></tr></table></figure>

<h2 id="创建etcd01证书"><a href="#创建etcd01证书" class="headerlink" title="创建etcd01证书"></a>创建etcd01证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 etcd]# cat etcd01.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:etcd01,IP:127.0.0.1, IP:192.168.64.32		# 注意IP域名与本机一致</span><br><span class="line"></span><br><span class="line">========================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node01 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd01.key -out etcd01.csr -nodes -subj &#x27;/CN=etcd01&#x27;</span><br><span class="line">[root@node01 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd01.cnf -extensions v3_req -in etcd01.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out etcd01.crt -CAcreateserial</span><br><span class="line"></span><br><span class="line">========================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node01 etcd]# openssl req -new -newkey rsa:2048 -keyout peer.key -out peer.csr -nodes -subj &#x27;/CN=etcd01&#x27;</span><br><span class="line">[root@node01 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd01.cnf -extensions v3_req -in peer.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out peer.crt -CAcreateserial</span><br></pre></td></tr></table></figure>

<h2 id="配置etcd01"><a href="#配置etcd01" class="headerlink" title="配置etcd01"></a>配置etcd01</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 etcd]# cd</span><br><span class="line">[root@node01 ~]# tar xf etcd-v3.5.5-linux-amd64.tar.gz</span><br><span class="line">[root@node01 ~]# cp etcd-v3.5.5-linux-amd64/etcd* /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# vi /lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=etcd --name etcd01 --initial-advertise-peer-urls https://192.168.64.32:2380 \</span><br><span class="line">  --listen-peer-urls https://192.168.64.32:2380 \</span><br><span class="line">  --listen-client-urls https://192.168.64.32:2379,https://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.64.32:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd01=https://192.168.64.32:2380,etcd02=https://192.168.64.33:2380,etcd03=https://192.168.64.34:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --cert-file=/etc/etcd/etcd01.crt \</span><br><span class="line">  --key-file=/etc/etcd/etcd01.key \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --peer-cert-file=/etc/etcd/peer.crt \</span><br><span class="line">  --peer-key-file=/etc/etcd/peer.key \</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@node01 ~]# systemctl daemon-reload</span><br><span class="line">[root@node01 system]# systemctl enable --now etcd</span><br></pre></td></tr></table></figure>

<h2 id="创建etcd02证书"><a href="#创建etcd02证书" class="headerlink" title="创建etcd02证书"></a>创建etcd02证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# tar xf etcd-v3.5.5-linux-amd64.tar.gz</span><br><span class="line">[root@node02 ~]# cp etcd-v3.5.5-linux-amd64/etcd* /usr/local/sbin/</span><br><span class="line">[root@node02 ~]# mkdir /etc/etcd</span><br><span class="line">[root@node02 ~]# cd /etc/etcd/</span><br><span class="line">[root@node02 etcd]# scp node01:/etc/etcd/etcd-ca* .			# 拷贝etcd-ca到etcd02</span><br><span class="line">etcd-ca.cnf                                                                                        100%  172   373.5KB/s   00:00</span><br><span class="line">etcd-ca.crt                                                                                        100% 1090     2.4MB/s   00:00</span><br><span class="line">etcd-ca.csr                                                                                        100%  887     2.7MB/s   00:00</span><br><span class="line">etcd-ca.key                                                                                        100% 1708     3.6MB/s   00:00</span><br><span class="line">etcd-ca.srl                                                                                        100%   41   107.5KB/s   00:00</span><br><span class="line">[root@node02 etcd]# cat etcd02.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:etcd02,IP:127.0.0.1, IP:192.168.64.33			# 注意IP和主机名</span><br><span class="line"></span><br><span class="line">===================================================================================</span><br><span class="line"></span><br><span class="line">[root@node02 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd02.key -out etcd02.csr -nodes -subj &#x27;/CN=etcd02&#x27;</span><br><span class="line">[root@node02 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd02.cnf -extensions v3_req -in etcd02.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out etcd02.crt -CAcreateserial</span><br><span class="line"></span><br><span class="line">===================================================================================</span><br><span class="line"></span><br><span class="line">[root@node02 etcd]# openssl req -new -newkey rsa:2048 -keyout peer.key -out peer.csr -nodes -subj &#x27;/CN=etcd02&#x27;</span><br><span class="line">[root@node02 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd02.cnf -extensions v3_req -in peer.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out peer.crt -CAcreateserial</span><br></pre></td></tr></table></figure>

<h2 id="配置etcd02"><a href="#配置etcd02" class="headerlink" title="配置etcd02"></a>配置etcd02</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 etcd]# vi /lib/systemd/system/etcd.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=etcd --name etcd02 --initial-advertise-peer-urls https://192.168.64.33:2380 \</span><br><span class="line">  --listen-peer-urls https://192.168.64.33:2380 \</span><br><span class="line">  --listen-client-urls https://192.168.64.33:2379,https://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.64.33:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd01=https://192.168.64.32:2380,etcd02=https://192.168.64.33:2380,etcd03=https://192.168.64.34:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --cert-file=/etc/etcd/etcd02.crt \</span><br><span class="line">  --key-file=/etc/etcd/etcd02.key \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --peer-cert-file=/etc/etcd/peer.crt \</span><br><span class="line">  --peer-key-file=/etc/etcd/peer.key \</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@node02 etcd]# systemctl daemon-reload</span><br><span class="line">[root@node02 etcd]# systemctl enable --now etcd</span><br></pre></td></tr></table></figure>

<h2 id="创建etcd03证书"><a href="#创建etcd03证书" class="headerlink" title="创建etcd03证书"></a>创建etcd03证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@node03 ~]# tar xf etcd-v3.5.5-linux-amd64.tar.gz</span><br><span class="line">[root@node03 ~]# cp etcd-v3.5.5-linux-amd64/etcd* /usr/local/sbin/</span><br><span class="line">[root@node03 ~]# mkdir /etc/etcd</span><br><span class="line">[root@node03 ~]# cd /etc/etcd/</span><br><span class="line">[root@node03 etcd]# scp node01:/etc/etcd/etcd-ca* .</span><br><span class="line">etcd-ca.cnf                                                                                  100%  172   318.4KB/s   00:00</span><br><span class="line">etcd-ca.crt                                                                                  100% 1090     1.7MB/s   00:00</span><br><span class="line">etcd-ca.csr                                                                                  100%  887     1.5MB/s   00:00</span><br><span class="line">etcd-ca.key                                                                                  100% 1708     4.2MB/s   00:00</span><br><span class="line">etcd-ca.srl                                                                                  100%   41   127.2KB/s   00:00</span><br><span class="line">[root@node03 etcd]# cat etcd03.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth,clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:localhost, DNS:etcd03,IP:127.0.0.1, IP:192.168.64.34			# 注意IP和主机名</span><br><span class="line"></span><br><span class="line">================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node03 etcd]# openssl req -new -newkey rsa:2048 -keyout etcd03.key -out etcd03.csr -nodes -subj &#x27;/CN=etcd03&#x27;</span><br><span class="line">[root@node03 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd03.cnf -extensions v3_req -in etcd03.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out etcd03.crt -CAcreateserial</span><br><span class="line"></span><br><span class="line">================================================================================================</span><br><span class="line"></span><br><span class="line">[root@node03 etcd]# openssl req -new -newkey rsa:2048 -keyout peer.key -out peer.csr -nodes -subj &#x27;/CN=etcd03&#x27;</span><br><span class="line">[root@node03 etcd]# openssl x509 -req -sha256 -days 36500 -extfile etcd03.cnf -extensions v3_req -in peer.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out peer.crt -CAcreateserial</span><br></pre></td></tr></table></figure>

<h2 id="配置etcd03"><a href="#配置etcd03" class="headerlink" title="配置etcd03"></a>配置etcd03</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node03 etcd]# vi /lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=etcd --name etcd03 --initial-advertise-peer-urls https://192.168.64.34:2380 \</span><br><span class="line">  --listen-peer-urls https://192.168.64.34:2380 \</span><br><span class="line">  --listen-client-urls https://192.168.64.34:2379,https://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.64.34:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd01=https://192.168.64.32:2380,etcd02=https://192.168.64.33:2380,etcd03=https://192.168.64.34:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --cert-file=/etc/etcd/etcd03.crt \</span><br><span class="line">  --key-file=/etc/etcd/etcd03.key \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcd-ca.crt \</span><br><span class="line">  --peer-cert-file=/etc/etcd/peer.crt \</span><br><span class="line">  --peer-key-file=/etc/etcd/peer.key \</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@node03 etcd]# systemctl daemon-reload</span><br><span class="line">[root@node03 etcd]# systemctl enable --now etcd</span><br></pre></td></tr></table></figure>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 etcd]# etcdctl --endpoints=&quot;https://etcd02:2379,https://etcd03:2379,https://etcd01:2379&quot; --cacert=etcd-ca.crt --cert=etcd02.crt --key=etcd02.key endpoint status --write-out=table</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| https://etcd02:2379 | f0e17e8a11ca95f3 |   3.5.5 |   20 kB |     false |      false |         2 |          8 |                  8 |        |</span><br><span class="line">| https://etcd03:2379 | ba673fc8f108eb32 |   3.5.5 |   20 kB |     false |      false |         2 |          8 |                  8 |        |</span><br><span class="line">| https://etcd01:2379 | afd02c09f31c7a3e |   3.5.5 |   20 kB |      true |      false |         2 |          8 |                  8 |        |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure>

<h1 id="Kubernetes二进制下载"><a href="#Kubernetes二进制下载" class="headerlink" title="Kubernetes二进制下载"></a>Kubernetes二进制下载</h1><p>下载地址：<a target="_blank" rel="noopener" href="https://dl.k8s.io/v1.23.6/kubernetes-server-linux-amd64.tar.gz">https://dl.k8s.io/v1.23.6/kubernetes-server-linux-amd64.tar.gz</a></p>
<p>将server二进制包下载并上传至master节点上或直接使用wget下载亦可</p>
<h1 id="Master节点部署"><a href="#Master节点部署" class="headerlink" title="Master节点部署"></a>Master节点部署</h1><h2 id="apiServer组件部署"><a href="#apiServer组件部署" class="headerlink" title="apiServer组件部署"></a>apiServer组件部署</h2><p>先查看adm方式部署生成的配置参数进行参考</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- kube-apiserver</span><br><span class="line">- --advertise-address=192.168.64.11</span><br><span class="line">- --allow-privileged=true</span><br><span class="line">- --authorization-mode=Node,RBAC</span><br><span class="line">- --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">- --enable-admission-plugins=NodeRestriction</span><br><span class="line">- --enable-bootstrap-token-auth=true</span><br><span class="line">- --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">- --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class="line">- --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br><span class="line">- --etcd-servers=https://127.0.0.1:2379</span><br><span class="line">- --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br><span class="line">- --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span><br><span class="line">- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname                 </span><br><span class="line">- --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span><br><span class="line">- --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span><br><span class="line">- --requestheader-allowed-names=front-proxy-client</span><br><span class="line">- --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">- --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">- --requestheader-group-headers=X-Remote-Group</span><br><span class="line">- --requestheader-username-headers=X-Remote-User</span><br><span class="line">- --secure-port=6443</span><br><span class="line">- --service-account-issuer=https://kubernetes.default.svc.cluster.local</span><br><span class="line">- --service-account-key-file=/etc/kubernetes/pki/sa.pub</span><br><span class="line">- --service-account-signing-key-file=/etc/kubernetes/pki/sa.key</span><br><span class="line">- --service-cluster-ip-range=192.12.0.0/16</span><br><span class="line">- --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">- --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br></pre></td></tr></table></figure>

<p>稍微对adm的apiserver配置进行修改即可使用</p>
<h3 id="创建Kubernetes-Ca"><a href="#创建Kubernetes-Ca" class="headerlink" title="创建Kubernetes Ca"></a>创建Kubernetes Ca</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]#</span><br><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# cat ca.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:kubernetes</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout ca.key -out ca.csr -nodes -subj &#x27;/CN=kubernetes&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -days 36500 -sha256 -extfile ca.cnf -extensions v3_ca -set_serial 0 -signkey ca.key -in ca.csr -out ca.crt</span><br><span class="line">[root@master kubernetes]# ls</span><br><span class="line">ca.cnf  ca.crt  ca.csr  ca.key</span><br></pre></td></tr></table></figure>

<h3 id="创建签发apiServer组件证书"><a href="#创建签发apiServer组件证书" class="headerlink" title="创建签发apiServer组件证书"></a>创建签发apiServer组件证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# vi apiserver.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">subjectAltName = DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:master, IP:127.0.0.1, IP:192.168.64.31</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout apiserver.key -out apiserver.csr -nodes -subj &#x27;/CN=kube-apiserver&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile apiserver.cnf -extensions v3_req -in apiserver.csr -CA ca.crt -CAkey ca.key -out apiserver.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls api*</span><br><span class="line">apiserver.cnf  apiserver.crt  apiserver.csr  apiserver.key</span><br></pre></td></tr></table></figure>

<h3 id="创建签发etcd-client证书"><a href="#创建签发etcd-client证书" class="headerlink" title="创建签发etcd-client证书"></a>创建签发etcd-client证书</h3><p>etcd因为部署在Node节点上，所以要把etcd-ca拷贝到master上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# mkdir etcd</span><br><span class="line">[root@master kubernetes]# cd etcd/</span><br><span class="line">[root@master etcd]# scp node01:/etc/etcd/etcd-ca* .</span><br><span class="line">etcd-ca.cnf                                                   100%  172   232.1KB/s   00:00</span><br><span class="line">etcd-ca.crt                                                   100% 1090     2.1MB/s   00:00</span><br><span class="line">etcd-ca.csr                                                   100%  887     1.8MB/s   00:00</span><br><span class="line">etcd-ca.key                                                   100% 1708     3.2MB/s   00:00</span><br><span class="line">[root@master etcd]# vi apiserver-etcd-client.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master etcd]# openssl req -new -newkey rsa:2048 -keyout apiserver-etcd-client.key -out apiserver-etcd-client.csr -nodes -subj &#x27;/O=system:masters/CN=kube-apiserver-etcd-client&#x27;</span><br><span class="line">[root@master etcd]# openssl x509 -req -sha256 -days 36500 -extfile apiserver-etcd-client.cnf -extensions v3_req -in apiserver-etcd-client.csr -CA etcd-ca.crt -CAkey etcd-ca.key -out apiserver-etcd-client.crt -CAcreateserial</span><br><span class="line">[root@master etcd]# ls api*</span><br><span class="line">apiserver-etcd-client.cnf  apiserver-etcd-client.crt  apiserver-etcd-client.csr  apiserver-etcd-client.key</span><br></pre></td></tr></table></figure>

<h3 id="创建签发kubelet组件证书"><a href="#创建签发kubelet组件证书" class="headerlink" title="创建签发kubelet组件证书"></a>创建签发kubelet组件证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# cd ..</span><br><span class="line">[root@master kubernetes]# vi apiserver-kubelet-client.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout apiserver-kubelet-client.key -out apiserver-kubelet-client.csr -nodes -subj &#x27;/O=system:masters/CN=kube-apiserver-kubelet-client&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile apiserver-kubelet-client.cnf -extensions v3_req -in apiserver-kubelet-client.csr -CA ca.crt -CAkey ca.key -out apiserver-kubelet-client.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls apiserver-kubelet-client*</span><br><span class="line">apiserver-kubelet-client.cnf  apiserver-kubelet-client.crt  apiserver-kubelet-client.csr  apiserver-kubelet-client.key</span><br></pre></td></tr></table></figure>

<h3 id="创建front-proxy-ca"><a href="#创建front-proxy-ca" class="headerlink" title="创建front-proxy-ca"></a>创建front-proxy-ca</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# vi front-proxy-ca.cnf</span><br><span class="line">[ v3_ca ]</span><br><span class="line">keyUsage = critical, keyCertSign, digitalSignature, keyEncipherment</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectKeyIdentifier = hash</span><br><span class="line">subjectAltName = DNS:front-proxy-ca</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout front-proxy-ca.key -out front-proxy-ca.csr -nodes -subj &#x27;/CN=front-proxy-ca&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -days 36500 -sha256 -extfile front-proxy-ca.cnf -extensions v3_ca -set_serial 0 -signkey front-proxy-ca.key -in front-proxy-ca.csr -out front-proxy-ca.crt</span><br></pre></td></tr></table></figure>

<h3 id="创建front-proxy-client"><a href="#创建front-proxy-client" class="headerlink" title="创建front-proxy-client"></a>创建front-proxy-client</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# vi front-proxy-client.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout front-proxy-client.key -out front-proxy-client.csr -nodes -subj &#x27;/CN=front-proxy-client&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile front-proxy-client.cnf -extensions v3_req -in front-proxy-client.csr -CA front-proxy-ca.crt -CAkey front-proxy-ca.key -out front-proxy-client.crt -CAcreateserial</span><br></pre></td></tr></table></figure>

<h3 id="创建密钥对"><a href="#创建密钥对" class="headerlink" title="创建密钥对"></a>创建密钥对</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# openssl genrsa -out sa.key</span><br><span class="line">[root@master kubernetes]# openssl rsa -in sa.key -pubout -out sa.pub</span><br></pre></td></tr></table></figure>

<h3 id="配置apiServer"><a href="#配置apiServer" class="headerlink" title="配置apiServer"></a>配置apiServer</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ls</span><br><span class="line">anaconda-ks.cfg  kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# tar xf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kube-apiserver /usr/local/sbin/</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kubectl /usr/local/sbin/</span><br><span class="line">[root@master ~]# vi /lib/systemd/system/apiserver.service</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意注释只是需要注意的点，不要把注释写到文件中，确保\后面没有空格，否则可能会报错</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line">[Unit]</span><br><span class="line">Description=apiServer</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-apiserver \</span><br><span class="line">  --advertise-address=192.168.64.31 \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --enable-admission-plugins=NodeRestriction \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/etcd/etcd-ca.crt \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/etcd/apiserver-etcd-client.crt \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/etcd/apiserver-etcd-client.key \</span><br><span class="line">  --etcd-servers=https://etcd01:2379,https://etcd02:2379,https://etcd03:2379 \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/apiserver-kubelet-client.crt \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/apiserver-kubelet-client.key \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/sa.key \</span><br><span class="line">  --service-cluster-ip-range=172.12.0.0/16 \						# Service地址</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/apiserver.crt \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/apiserver.key \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/front-proxy-client.crt \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/front-proxy-client.key \</span><br><span class="line">  --requestheader-allowed-names=front-proxy-client \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/front-proxy-ca.crt \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl enable --now apiserver</span><br><span class="line">[root@master ~]# systemctl status apiserver</span><br><span class="line">● apiserver.service - apiServer</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2022-09-18 16:36:41 CST; 37s ago</span><br><span class="line"> Main PID: 14714 (kube-apiserver)</span><br><span class="line">    Tasks: 11 (limit: 23494)</span><br><span class="line">   Memory: 239.9M</span><br><span class="line">   CGroup: /system.slice/apiserver.service</span><br><span class="line">           └─14714 /usr/local/sbin/kube-apiserver --advertise-address=192.168.64.31</span><br><span class="line">[root@master ~]# ss -lntp</span><br><span class="line">State                   Recv-Q                  Send-Q                                   Local Address:Port                                   Peer Address:Port                 Process</span><br><span class="line">LISTEN                  0                       128                                            0.0.0.0:22                                          0.0.0.0:*                     users:((&quot;sshd&quot;,pid=960,fd=5))</span><br><span class="line">LISTEN                  0                       128                                               [::]:22                                             [::]:*                     users:((&quot;sshd&quot;,pid=960,fd=7))</span><br><span class="line">LISTEN                  0                       128                                                  *:6443                                              *:*                     users:((&quot;kube-apiserver&quot;,pid=14714,fd=7))</span><br></pre></td></tr></table></figure>

<h2 id="CM组件部署"><a href="#CM组件部署" class="headerlink" title="CM组件部署"></a>CM组件部署</h2><p>查看通过adm部署生成Controller-Manager配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kube-controller-manager</span><br><span class="line">    - --allocate-node-cidrs=true</span><br><span class="line">    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">    - --bind-address=127.0.0.1</span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --cluster-cidr=192.11.0.0/16						# Pod地址</span><br><span class="line">    - --cluster-name=kubernetes</span><br><span class="line">    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span><br><span class="line">    - --controllers=*,bootstrapsigner,tokencleaner</span><br><span class="line">    - --kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">    - --leader-elect=true</span><br><span class="line">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt				# 可不需要</span><br><span class="line">    - --root-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key</span><br><span class="line">    - --service-cluster-ip-range=192.12.0.0/16</span><br><span class="line">    - --use-service-account-credentials=true</span><br></pre></td></tr></table></figure>

<h3 id="创建CM证书"><a href="#创建CM证书" class="headerlink" title="创建CM证书"></a>创建CM证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# vi controller-manager.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout controller-manager.key -out controller-manager.csr -nodes -subj &#x27;/CN=system:kube-controller-manager&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile controller-manager.cnf -extensions v3_req -in controller-manager.csr -CA ca.crt -CAkey ca.key -out controller-manager.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls controller-manager*</span><br><span class="line">controller-manager.cnf  controller-manager.crt  controller-manager.csr  controller-manager.key</span><br></pre></td></tr></table></figure>

<h3 id="创建config文件"><a href="#创建config文件" class="headerlink" title="创建config文件"></a>创建config文件</h3><blockquote>
<p>kubectl config 用于设置kubeconfig并生成kubeconfig文件</p>
<p>此文件保存kubernetes根证书，cm证书密钥，apiserver组件地址等信息</p>
</blockquote>
<p>文件格式可参考：<a href="https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/">https://www.xiaowangc.com/2022/09/18/k8s-zhengshu/</a> 最后一节，固定格式，需要通过命令的方式填写相关参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \							# 指定kubernetes CA证书并</span><br><span class="line">--embed-certs=true \										# 将证书导入此文件</span><br><span class="line">--server=https://192.168.64.31:6443 \						# 指定apiserver组件地址</span><br><span class="line">--kubeconfig=controller-manager.conf						# 将上述配置生成到controller-manager.conf文件</span><br><span class="line">======================================================================================================</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置凭证信息  system:kube-controller-manager是依据证书中的CN字段配置的，需要保证一致</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">--client-certificate=controller-manager.crt \				# 指定cm证书</span><br><span class="line">--client-key=controller-manager.key \						# 指定cm私钥</span><br><span class="line">--embed-certs=true \										# 将证书导入此文件</span><br><span class="line">--kubeconfig=controller-manager.conf						# 将上述配置生成到controller-manager.conf文件</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-context system:kube-controller-manager \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-controller-manager \</span><br><span class="line">--kubeconfig=controller-manager.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config use-context system:kube-controller-manager \</span><br><span class="line">--kubeconfig=controller-manager.conf</span><br><span class="line"></span><br><span class="line">=======================================================================================================</span><br><span class="line">[root@master kubernetes]# cat controller-manager.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURBRENDQWVpZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFEREFwcmRXSmwKY201bGRHVnpNQ0FYRFRJeU1Ea3hPREEzTlRBek0xb1lEekl4TWpJd09ESTFNRGMxTURNeldqQVZNUk13RVFZRApWUVFEREFwcmRXSmxjbTVsZEdWek1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBCjBPd0ZpUDNPTjFyNytQSWkxQzZmQndkNm9hR2tGRWFQU0tuU3hlMmE1VHBxUElJUU1UMUJjb0xWNFRBTG15WksKYW01VWYxN1JpbU1SUU9FekdxaTdORmU2YXlWWGcvTzFnZkJFNUcwVWcxcXlobkhGZ1p6YlhOUlozZXJPNkVZbAp6SC81U1ZMYStUeHRVa0lBZlBRQ3JVY1RmMmV1NHVleGFvcE1sY3pJSFNHMDhTVmFTT2psZks2VHJSUXVqcHduClVNcXE5MytublhrcHBwVVg3VVpSL0NkT1c0VGFzN2ZWc2thL0ZRNlltTWRPK3NXcTVlYXpIcVlxMjV3c044aXQKV011Y0JRSEpQZUdOVHFSRUJxZlpabXNab05ZNFgwM3Azb1JFS1NHM0ZoVkxBUEtaNGNFZG5LVng4eFVaNkVrVApQdDh4am9EaW9mQ1pyY3ZsdW1DRmJ3SURBUUFCbzFrd1Z6QU9CZ05WSFE4QkFmOEVCQU1DQXFRd0R3WURWUjBUCkFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVVHMGptODNaM2pneExWeVVLVnVaSVVkN3hCdkF3RlFZRFZSMFIKQkE0d0RJSUthM1ZpWlhKdVpYUmxjekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBUUVJTkJEU0xCTkVTMkhFOApEekR4UHlRc29uNForeUtydUpsWXRXQm40aGRkK2sxY05WRTF3dDhkZnhKNjF3S2l4S0NUVTBsNmlleXBqbWFZCkMvQUNsdHFsZXQwV0dtNFhITnp1d1crYWhPa25HQlpZZ2d3czZMbktqbjYxMEFmaGtKZlo2UUJreGM5cko5NEMKV1VuUTJlUVlmdlZmVHA1MUJLRWVJU3FUVkRtcktkK0xQcXRyQ0ZydnYwZGlVYU5GZ0tVSnpwVmt4Qzhsb3BYdQpTTlJwTi8wamwyYjRLUkV6MjlGamlFaEgrbXZ5ek5GREN4d2RPQVcySWorekFOS3pva2szM2ZjTTE1cGsxb0VlCnBRRllTRUlaQ09xaDFoMmtUZlpPaFNDdGpLZVVaMlFRUStkSjZndExUcUFWVjJqZFJHTkFoTE9XWWJWeGIzak0KUTFzSDR3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    server: https://192.168.64.31:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: system:kube-controller-manager</span><br><span class="line">  name: system:kube-controller-manager</span><br><span class="line">current-context: system:kube-controller-manager</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: system:kube-controller-manager</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURKRENDQWd5Z0F3SUJBZ0lVRTJQV1JlRGphaVRTaS9aeENXYkRWdUd0T2w4d0RRWUpLb1pJaHZjTkFRRUwKQlFBd0ZURVRNQkVHQTFVRUF3d0thM1ZpWlhKdVpYUmxjekFnRncweU1qQTVNVGd4TURJeE5USmFHQTh5TVRJeQpNRGd5TlRFd01qRTFNbG93S1RFbk1DVUdBMVVFQXd3ZWMzbHpkR1Z0T210MVltVXRZMjl1ZEhKdmJHeGxjaTF0CllXNWhaMlZ5TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF6S2NYalNtNkE0RDAKUCthMUpkR0plK3Y3anczZFUzVHlSMjNOWHhHQ21xOUZ3T0hoN0xCWXcrSjNMcXlEdHZ6aCszbTRpTXZnRjFFegpSeWMwT3JCWUdFT0FPcE91NlFyc2ZoaDEvS29vek1Wa0xmc0pJT0UyTWlzdDh3YVBxS1dFVCtiY2l3QXV5MEdlCmk0QVdjTWhpYWw0ZzlyNmJWNHBCRTdSbHBFaDN6WUh1QWJ4NndyY2FuOWpGVGNGbmM1TlMzdlBidmdqQzN2QXEKTmI2L253dWZENUpnS3hwZGRHc1JiZHNFL0NZQkNqQzNMTFFvSUM5eDBMa09zVEZjdmFwbk4zZmFqaDd1bUxGcAoyMTkySHdvTmNvNGQwbitpbkJSYU8yN3QxdXVHL1hMT2ZzUmQ5ZjVMckFyQzYxbHhFZ0dsbkt4M21yRG1rUmxUCmZsN1FCc0NTclFJREFRQUJvMVl3VkRBT0JnTlZIUThCQWY4RUJBTUNCYUF3RXdZRFZSMGxCQXd3Q2dZSUt3WUIKQlFVSEF3SXdEQVlEVlIwVEFRSC9CQUl3QURBZkJnTlZIU01FR0RBV2dCUWJTT2J6ZG5lT0RFdFhKUXBXNWtoUgozdkVHOERBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWdmd2txK0JnQ0VMdDN0djgzbmFDbGE4dFVKWEdGVHNSCjZ4OVFkWWFYVnVLQkxBTU1xdm1xUDdEeE9oc1FzeEpzVXF2N2lnRmN1ZE92c0lONjlvcDhVeHFiejlEalZPTTAKSnY1c1F3RmxkMGt6WEUyelJERXZyUVlDL0VJbVZiMUFpRjhsZ1RvL3JtR3JuYkxZeDMxRURxeTJsV2Z1eVJaQgpFdTFMQkRUQkRYZEJxSDcyc0NzQmh1c1l3SkU4R2NDQWUvSkJZU0pyaXhQYUt4NDZRaGRqUVNUT3RGQ0ptcTZrCmx6RElFMXcxS0srNjdBREVKaFpWTFoyd01TYXd3R2hCOENOcGNwTDZpdFBOUEpUc1JPU1JZemZTVmg4dmlHNDQKTDJZTUYyQ0xCY0tQa2Z4SzVnaUNlT3A1cTVQTFp3WUlpNU05R1lsTGJXN0dVRWEvajQ3cnlBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2d0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktrd2dnU2xBZ0VBQW9JQkFRRE1weGVOS2JvRGdQUS8KNXJVbDBZbDc2L3VQRGQxVGRQSkhiYzFmRVlLYXIwWEE0ZUhzc0ZqRDRuY3VySU8yL09IN2ViaUl5K0FYVVROSApKelE2c0ZnWVE0QTZrNjdwQ3V4K0dIWDhxaWpNeFdRdCt3a2c0VFl5S3kzekJvK29wWVJQNXR5TEFDN0xRWjZMCmdCWnd5R0pxWGlEMnZwdFhpa0VUdEdXa1NIZk5nZTRCdkhyQ3R4cWYyTVZOd1dkemsxTGU4OXUrQ01MZThDbzEKdnIrZkM1OFBrbUFyR2wxMGF4RnQyd1Q4SmdFS01MY3N0Q2dnTDNIUXVRNnhNVnk5cW1jM2Q5cU9IdTZZc1duYgpYM1lmQ2cxeWpoM1NmNktjRkZvN2J1M1c2NGI5Y3M1K3hGMzEva3VzQ3NMcldYRVNBYVdjckhlYXNPYVJHVk4rClh0QUd3Skt0QWdNQkFBRUNnZ0VBUE1mRGJ1RmRwWHkvRGR0dklYUkI2TlFGT2s5YjFGVi9QMGVWSHc4TVF2U2IKT3RYYlMzaDBaSGoxL0o2djM4RHJQTXpCeVo4RFJ1bU8yU3NEa0FxZm4xVXMyRGpVVWRJMHVwNTVMRGs5Tk5QTApGUHpoa1NwUjlrUnN1U2pSc2J5MnR5UlJpOWJhRHZQR0twZzRFZmJ4ZzdYQkJJZEhpNUE4RTZZWUtkcDcra1I3CjRKL3IyOWI4d3g3cTExaSsyaU82WFVCc1NTd1M4aEVNNjZyY0RkVXlQclVOc25FTzRQY043Q1o2RUFCV3U2Zi8KajZ0am5tM2NWRk9qeHQ3dU9TV3RkUnA5cHJzc2RsNzhndkRJaUlpT3JEV09XN2lVRk1HNFYrYy9EYWdGZXZ1SwpFQlNsdExicnVWWlRrOU50VWlJZ3QxTDRGZlN5bmgxV1hIcnRWREx5NFFLQmdRRDdza3lPcGpaL3lyZzZkcGsxCmY1WnpWQmxyTHdYL28xZGRFYUZ1R3JMVXN2bmszaFVkUjBTNU82d254TjdOZEg5a2RGY3d4UGpyOHNTYlpUTlYKbVI1RXV5NUUydVJzSmcrMDUrQlJGU0F0amVxWHZFY0ZGWUEvSEdGK1RRUjgwWmRSY1RCNjlvUDdHd0hrbUloZgpjWDVYeUJ0QzQ4UVh1T0RPQy9CTHk4RjNQd0tCZ1FEUUp1Q291Sng2N0ZVUzZhRG44ZzlWS2xSNWV6bUhMVHdDCnZiMEx2MERuajczaHlxdGdJdmg3dDl3VVh3VUk2d3J0bTdSY1YrNkVKNXYxaHF0ZEFFenFlTkRjZnowMENlUjcKeXBvSkNHMFlINEdiOUt1RW42WlkzVEN5dGErbkhyRUV2VFRtK25pN0M3R3VobjRqOTZScEt4MWQxK2F5bTlNOQpxY0tyTEY0SEV3S0JnUUNKWUNXODdpZHMxSDU5R21KQSt1UnBDZ3Zkbm9yTm5wOStZck1UWDJzZ0FKZTRQU2FWCkZtTUNIdm0xc3hSUVd6ZDA0ckw4SVdZamtodVJIVWxKZlFzeVJGL2FvUVp2cU02RjFORndML0dpSzRWUlVDZ0wKTkZNTkh6WnZNeVl4NGt1TzNoS3g2bjdhdlVEcFBmK2c2RmNuSGtjUzJUSWNLSUk2cy9WeHlVSk5EUUtCZ1FDZQphR2ZpbnhRZkRFbzJLV3hWK0VZbzV4MEFrb0dXV1J0cGJxSTNGV2E4a3d6TGorUmFObUxxTEdNbGNhYXdRY2ZBClNoVzVqUVdzdDBRZVYwMkVhbDBldDdFampRV3oyNjl4Y2g5RnJvN3ZvOUtNTUdoemR0Z3VtcTZiNGw3NkRRWmsKZCtXUnZwNHdvdGFtM2gyVEc3eVllTUpSajZRMjJ4V293TSt3V3dSMzF3S0JnUUN0MnhZRGR2Ly9BNWZ2UmNXKwpQZzVJdzZPWThkbGw5Wmgra1dIaDdlMXFRU3l6OTVsa3BYWTZDTms1Vjl5WTFjaWpYanpKWENGWnRtWTBvUk1TCi9rMmkxbW10N3UrUFV4SzdrV1hrUDNBWExTMC9JU1dWNWlBTVlQZTZRd0pmT2llSmxjNC9wVWR3R1Q5aUhrL3EKN1duOEZ6SVJ2WC9wcTZ5MEh5QlVxbXg0SEE9PQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==</span><br></pre></td></tr></table></figure>

<h3 id="配置CM"><a href="#配置CM" class="headerlink" title="配置CM"></a>配置CM</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# cd</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kube-controller-manager /usr/local/sbin/</span><br><span class="line">[root@master ~]# vi /lib/systemd/system/controller-manager.service</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意注释只是需要注意的点，不要把注释写到文件中，确保\后面没有空格，否则可能会报错</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line">[Unit]</span><br><span class="line">Description=ControllerManager</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-controller-manager \</span><br><span class="line">  --allocate-node-cidrs=true \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf \</span><br><span class="line">  --bind-address=127.0.0.1 \						# cm不需要外部访问</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --cluster-cidr=172.11.0.0/16	\					# Pod地址</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/ca.key \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/controller-manager.conf \</span><br><span class="line">  --leader-elect=true \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/front-proxy-ca.crt \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/sa.key \</span><br><span class="line">  --service-cluster-ip-range=172.12.0.0/16 \			# Service地址</span><br><span class="line">  --use-service-account-credentials=true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master kubernetes]# systemctl daemon-reload</span><br><span class="line">[root@master kubernetes]# systemctl enable --now controller-manager.service</span><br></pre></td></tr></table></figure>

<h2 id="Scheduler组件部署"><a href="#Scheduler组件部署" class="headerlink" title="Scheduler组件部署"></a>Scheduler组件部署</h2><p>通过查看adm生成配置获得如下参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kube-scheduler</span><br><span class="line">    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line">    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line">    - --bind-address=127.0.0.1</span><br><span class="line">    - --kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line">    - --leader-elect=true</span><br></pre></td></tr></table></figure>



<h3 id="创建Scheduler证书"><a href="#创建Scheduler证书" class="headerlink" title="创建Scheduler证书"></a>创建Scheduler证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# vi scheduler.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout scheduler.key -out scheduler.csr -nodes -subj &#x27;/CN=system:kube-scheduler&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile scheduler.cnf -extensions v3_req -in scheduler.csr -CA ca.crt -CAkey ca.key -out scheduler.crt -CAcreateserial</span><br><span class="line">[root@master kubernetes]# ls scheduler.*</span><br><span class="line">scheduler.cnf  scheduler.crt  scheduler.csr  scheduler.key</span><br></pre></td></tr></table></figure>

<h3 id="创建config文件-1"><a href="#创建config文件-1" class="headerlink" title="创建config文件"></a>创建config文件</h3><blockquote>
<p>与CM的config一致就是部分名字文件需要更改</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@master kubernetes]# kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">--client-certificate=scheduler.crt \</span><br><span class="line">--client-key=scheduler.key \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-context system:kube-scheduler \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-scheduler \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config use-context system:kube-scheduler \</span><br><span class="line">--kubeconfig=scheduler.conf</span><br></pre></td></tr></table></figure>

<h3 id="配置Scheduler"><a href="#配置Scheduler" class="headerlink" title="配置Scheduler"></a>配置Scheduler</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@master kubernetes]# vi /lib/systemd/system/scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Scheduler</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-scheduler \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/scheduler.conf \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/scheduler.conf \</span><br><span class="line">  --bind-address=127.0.0.1 \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/scheduler.conf \</span><br><span class="line">  --leader-elect=true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master kubernetes]# cd</span><br><span class="line">[root@master ~]# cp kubernetes/server/bin/kube-scheduler /usr/local/sbin/</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl restart scheduler.service</span><br></pre></td></tr></table></figure>

<h2 id="Admin文件生成"><a href="#Admin文件生成" class="headerlink" title="Admin文件生成"></a>Admin文件生成</h2><p>用于kubectl连接集群</p>
<h3 id="创建admin证书"><a href="#创建admin证书" class="headerlink" title="创建admin证书"></a>创建admin证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /etc/kubernetes/</span><br><span class="line">[root@master kubernetes]# vi admin.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@master kubernetes]# openssl req -new -newkey rsa:2048 -keyout admin.key -out admin.csr -nodes -subj &#x27;/CN=kubernetes-admin/O=system:masters&#x27;</span><br><span class="line">[root@master kubernetes]# openssl x509 -req -sha256 -days 36500 -extfile admin.cnf -extensions v3_req -in admin.csr -CA ca.crt -CAkey ca.key -out admin.crt -CAcreateserial</span><br></pre></td></tr></table></figure>

<h3 id="配置config文件"><a href="#配置config文件" class="headerlink" title="配置config文件"></a>配置config文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=admin.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@master kubernetes]# kubectl config set-credentials kubernetes-admin \</span><br><span class="line">--client-certificate=admin.crt \</span><br><span class="line">--client-key=admin.key \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config set-context kubernetes-admin \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kubernetes-admin \</span><br><span class="line">--kubeconfig=admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@master kubernetes]# kubectl config use-context kubernetes-admin \</span><br><span class="line">--kubeconfig=admin.conf</span><br></pre></td></tr></table></figure>

<h3 id="测试Admin"><a href="#测试Admin" class="headerlink" title="测试Admin"></a>测试Admin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master kubernetes]# echo &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt; /etc/profile</span><br><span class="line">[root@master kubernetes]# export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">[root@master kubernetes]# kubectl get node</span><br><span class="line">No resources found</span><br><span class="line">[root@master kubernetes]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Node节点部署"><a href="#Node节点部署" class="headerlink" title="Node节点部署"></a>Node节点部署</h1><p><strong>Node只演示一个节点的部署</strong></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://dl.k8s.io/v1.23.6/kubernetes-node-linux-amd64.tar.gz">https://dl.k8s.io/v1.23.6/kubernetes-node-linux-amd64.tar.gz</a></p>
<p>将node二进制包下载并上传至所有node节点上或直接使用wget下载亦可</p>
<h2 id="Kubelet组件部署"><a href="#Kubelet组件部署" class="headerlink" title="Kubelet组件部署"></a>Kubelet组件部署</h2><p>查看通过adm部署的Node节点配置</p>
<p>adm部署的方式Node节点是采用config方式进行认证的，二进制通常使用kubelet-bootstrap进行认证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 kubernetes]# tree</span><br><span class="line">.</span><br><span class="line">├── kubelet.conf		# config文件	</span><br><span class="line">├── manifests</span><br><span class="line">└── pki</span><br><span class="line">    └── ca.crt			# kubernetesCA证书</span><br><span class="line">    </span><br><span class="line">[root@node01 kubernetes]# cat kubelet.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1Ea3hOekV3TWpBd05Gb1hEVE15TURreE5ERXdNakF3TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS1NRCkVScnRRUHBPNzE0VGVueEQ5ZUZ0d25tNFFWWG56L1liUE5MNE5VdXdmcUNPTVg1MGJNTWxiblkya3poZmlSSmQKSWxVK3o4RVYrZGJ6WDJUd0JUWGRxN1pOeDFxdmx2bFpuZDlUY21Zd3l6eUpCRUROVjdmMG9lYWxUSUIwMGVRYQovYjFWeStPL1I0NUhuY3VXUDhMc2lwV3J5U3I1WjRpcnkvVmIrbnB4T2xVeXpTL3BtdVhBTmdGUGVpL0w3MUlpCkxha0NlNmZNRCtMMHpGektCdGVVeVpuWWZMOWxyVm0xeG1QUjVFdkdZN2NaNTl3YmtqbW94VGE1bjdVTzR6SjgKZndiak5oNHVLVzdqOHpvajVTWTJBMEZIZ0RSbnY5NlFxVk5SSkIraGMrRDBrTE1EdmRHcUM0QVpaUzJDbUNLUQpBTUZGUUlGSDIyMCtBRngvNGM4Q0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZDdjNSOHRCVEttMDJwTVlNT0RxRUg0eEpnUktNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBR3hwamdwcjVOZmxxMkJBZC9vdQpTQW14WDIyVi9XTmJZZDNDYVA2dVAwY2F3QXdWMm8xY3lucjNwVk9reG8xaDZ6UjBPWkdvNEJpc2tlWUJKUHNkCjdjeVhwRGVseDh2b2QvUjc1NUQ5TmcwOWUybFlSQWlmSE9NZXkvbjdYb0JLNWNRUk9KUWtmZmxvYWFBRFZsNlAKdVBSNXJhUWd0c0hIZUUwVy9hTitqVTQrby92VFJ4TnZzdUtERVpXY1pyYnBOOUJRZjVGc09vRTAyV25XRi9uUQpVOXNwVjlmanJVU0I5MFhqTG1GdDRFUW1ucm5JWjRjMU42TnJqQ0szTk1NdFlidFE2VXo2M3FDVzRtZmRoK3FFCi9DcmVHTTR1T1JLMnBjVjYwYlFHOVhTOFVDWXc4bWN1SVFuTlRpc05NaXMwbCtkelV1Ui9qYVJZS1EydEdaMTAKWlVJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://192.168.64.11:6443</span><br><span class="line">  name: default-cluster</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: default-cluster</span><br><span class="line">    namespace: default</span><br><span class="line">    user: default-auth</span><br><span class="line">  name: default-context</span><br><span class="line">current-context: default-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: default-auth</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem</span><br><span class="line">    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem</span><br></pre></td></tr></table></figure>

<p><strong>启动文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结构</span></span><br><span class="line">/lib/systemd/system/</span><br><span class="line">└── kubelet.service</span><br><span class="line">└── kubelet.service.d</span><br><span class="line">    └── 10-kubeadm.conf</span><br><span class="line">[root@node01 kubernetes]# cat /lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=kubelet: The Kubernetes Node Agent</span><br><span class="line">Documentation=https://kubernetes.io/docs/</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/kubelet</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target  </span><br><span class="line">[root@node01 kubernetes]# cat /lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span><br><span class="line">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a file that <span class="string">&quot;kubeadm init&quot;</span> and <span class="string">&quot;kubeadm join&quot;</span> generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a file that the user can use <span class="keyword">for</span> overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the .NodeRegistration.KubeletExtraArgs object <span class="keyword">in</span> the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/kubelet			# 空，可以删掉</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node01 kubernetes]# cat /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">KUBELET_KUBEADM_ARGS=&quot;--network-plugin=cni --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot;</span><br></pre></td></tr></table></figure>

<p><strong>通过分析上述等文件汇总成如下</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=kubelet</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kubelet \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf </span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.conf</span><br><span class="line">  --config=/var/lib/kubelet/config.yaml</span><br><span class="line">  --network-plugin=cni </span><br><span class="line">  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="apiServer配置"><a href="#apiServer配置" class="headerlink" title="apiServer配置"></a>apiServer配置</h3><p>通过参考adm部署方式参考的apiServer配置文件还不支持bootstrap方式认证，需要添加如下参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--token-auth-file=/etc/kubernetes/token.csv</span><br><span class="line">--enable-bootstrap-token-auth=true</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota</span><br></pre></td></tr></table></figure>

<h4 id="生成token"><a href="#生成token" class="headerlink" title="生成token"></a>生成token</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# openssl rand -hex 10</span><br><span class="line">370e9b286ef7528dc199</span><br><span class="line">[root@master kubernetes]# echo &#x27;370e9b286ef7528dc199,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;&#x27; &gt; /etc/kubernetes/token.csv</span><br><span class="line">[root@master kubernetes]# cat /etc/kubernetes/token.csv</span><br><span class="line">370e9b286ef7528dc199,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br></pre></td></tr></table></figure>

<h4 id="新增apiServer参数"><a href="#新增apiServer参数" class="headerlink" title="新增apiServer参数"></a>新增apiServer参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vi /lib/systemd/system/apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=apiServer</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-apiserver \</span><br><span class="line">  --advertise-address=192.168.64.31 \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ca.crt \</span><br><span class="line">  --enable-admission-plugins=NodeRestriction \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/etcd/etcd-ca.crt \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/etcd/apiserver-etcd-client.crt \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/etcd/apiserver-etcd-client.key \</span><br><span class="line">  --etcd-servers=https://etcd01:2379,https://etcd02:2379,https://etcd03:2379 \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/apiserver-kubelet-client.crt \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/apiserver-kubelet-client.key \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/sa.key \</span><br><span class="line">  --service-cluster-ip-range=172.12.0.0/16 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/apiserver.crt \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/apiserver.key \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/front-proxy-client.crt \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/front-proxy-client.key \</span><br><span class="line">  --requestheader-allowed-names=front-proxy-client \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/front-proxy-ca.crt \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --token-auth-file=/etc/kubernetes/token.csv \</span><br><span class="line">  --enable-bootstrap-token-auth=true \</span><br><span class="line">  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl restart apiserver</span><br><span class="line">[root@master ~]# systemctl restart controller-manager</span><br><span class="line">[root@master ~]# systemctl restart scheduler</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#########################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建集群角色</span></span><br><span class="line">[root@master ~]# kubectl create clusterrolebinding kubelet-bootstrap1 --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<h3 id="配置Kubelet"><a href="#配置Kubelet" class="headerlink" title="配置Kubelet"></a>配置Kubelet</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# tar xf kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">[root@node01 ~]# cp kubernetes/node/bin/kubelet /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# mkdir /var/lib/kubelet/</span><br><span class="line">[root@node01 ~]# vi /lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=kubelet</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kubelet \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.conf \</span><br><span class="line">  --config=/var/lib/kubelet/config.yaml \</span><br><span class="line">  --network-plugin=cni \</span><br><span class="line">  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝adm生成config.yaml文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################################################</span></span></span><br><span class="line">[root@node01 ~]# vi /var/lib/kubelet/config.yaml</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.crt							# KubernetesCA证书</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 0s</span><br><span class="line">    cacheUnauthorizedTTL: 0s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">clusterDNS:</span><br><span class="line">- 172.12.0.10											# 需要注意此DNS地址，Service地址</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">cpuManagerReconcilePeriod: 0s</span><br><span class="line">evictionPressureTransitionPeriod: 0s</span><br><span class="line">fileCheckFrequency: 0s</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 0s</span><br><span class="line">imageMinimumGCAge: 0s</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">logging:</span><br><span class="line">  flushFrequency: 0</span><br><span class="line">  options:</span><br><span class="line">    json:</span><br><span class="line">      infoBufferSize: &quot;0&quot;</span><br><span class="line">  verbosity: 0</span><br><span class="line">memorySwap: &#123;&#125;</span><br><span class="line">nodeStatusReportFrequency: 0s</span><br><span class="line">nodeStatusUpdateFrequency: 0s</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 0s</span><br><span class="line">shutdownGracePeriod: 0s</span><br><span class="line">shutdownGracePeriodCriticalPods: 0s</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 0s</span><br><span class="line">syncFrequency: 0s</span><br><span class="line">volumeStatsAggPeriod: 0s</span><br><span class="line">[root@node01 ~]# mkdir -p /etc/kubernetes/pki/</span><br><span class="line">[root@node01 ~]# mkdir /etc/kubernetes/manifests</span><br><span class="line">[root@node01 ~]# scp master:/etc/kubernetes/ca.crt /etc/kubernetes/pki/</span><br><span class="line">ca.crt                                                       100% 1103     1.9MB/s   00:00</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="创建BootStap文件"><a href="#创建BootStap文件" class="headerlink" title="创建BootStap文件"></a>创建BootStap文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# cp kubernetes/node/bin/kubectl /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# cd /etc/kubernetes/pki/</span><br><span class="line">[root@node01 pki]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@node01 pki]#  kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">--token=370e9b286ef7528dc199 \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config set-context kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kubelet-bootstrap \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config use-context kubernetes \</span><br><span class="line">--kubeconfig=bootstrap-kubelet.conf</span><br><span class="line">[root@node01 pki]# mv bootstrap-kubelet.conf ../</span><br><span class="line">[root@node01 pki]# cd</span><br><span class="line">[root@node01 ~]#</span><br></pre></td></tr></table></figure>

<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# systemctl daemon-reload</span><br><span class="line">[root@node01 ~]# systemctl enable --now kubelet</span><br><span class="line">[root@node01 ~]# systemctl status kubelet</span><br><span class="line">● kubelet.service - kubelet</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2022-09-18 21:03:30 CST; 19s ago</span><br><span class="line"> Main PID: 16226 (kubelet)</span><br><span class="line">    Tasks: 13 (limit: 23494)</span><br><span class="line">   Memory: 29.0M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br></pre></td></tr></table></figure>

<h3 id="颁发证书"><a href="#颁发证书" class="headerlink" title="颁发证书"></a>颁发证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get csr</span><br><span class="line">NAME        AGE     SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-4qhgh   53s     kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Pending</span><br><span class="line">[root@master ~]# kubectl certificate approve csr-4qhgh</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-4qhgh approved</span><br><span class="line">[root@master ~]# kubectl get node</span><br><span class="line">NAME     STATUS     ROLES    AGE     VERSION</span><br><span class="line">node01   NotReady   &lt;none&gt;   11m     v1.23.6</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他节点一样操作，没地方需要改的</span></span><br></pre></td></tr></table></figure>

<h2 id="KubePorxy组件部署"><a href="#KubePorxy组件部署" class="headerlink" title="KubePorxy组件部署"></a>KubePorxy组件部署</h2><p>KubePorxy在adm方式安装下，文件夹中不存在配置文件等信息，可以通过查看容器获取</p>
<p><strong>通过查询adm部署的Node中docker容器找到相应的参数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE                                                           COMMAND                  CREATED        STATUS        PORTS     NAMES</span><br><span class="line">fa420f27a34f   4c0375452406                                                    &quot;/usr/local/bin/kube…&quot;   27 hours ago   Up 27 hours             k8s_kube-proxy_kube-proxy-45hb8_kube-system_70fb18c0-3dd8-4f6c-ac31-7e437189db51_0</span><br><span class="line">ee76bafc7838   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6   &quot;/pause&quot;                 27 hours ago   Up 27 hours             k8s_POD_kube-proxy-45hb8_kube-system_70fb18c0-3dd8-4f6c-ac31-7e437189db</span><br><span class="line">[root@node01 ~]# docker inspect fa420</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;fa420f27a34f2487d242ae06502e969d6b245be2721b016337829b90c89d5d80&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-09-17T10:32:02.250879493Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/usr/local/bin/kube-proxy&quot;,</span><br><span class="line">        &quot;Args&quot;: [</span><br><span class="line">            &quot;--config=/var/lib/kube-proxy/config.conf&quot;,</span><br><span class="line">            &quot;--hostname-override=node01&quot;</span><br><span class="line">...</span><br><span class="line">[root@node01 ~]# docker cp fa:/var/lib/kube-proxy/..data/config.conf .</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">bindAddressHardFail: false</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 0</span><br><span class="line">  contentType: &quot;&quot;</span><br><span class="line">  kubeconfig: /var/lib/kube-proxy/kubeconfig.conf		# 还有一个文件也考出来看看</span><br><span class="line">  qps: 0</span><br><span class="line">clusterCIDR: 192.11.0.0/16						# Pod地址</span><br><span class="line">configSyncPeriod: 0s</span><br><span class="line">conntrack:</span><br><span class="line">  maxPerCore: null</span><br><span class="line">  min: null</span><br><span class="line">  tcpCloseWaitTimeout: null</span><br><span class="line">  tcpEstablishedTimeout: null</span><br><span class="line">detectLocalMode: &quot;&quot;</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: &quot;&quot;</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;&quot;</span><br><span class="line">  strictARP: false</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">  tcpFinTimeout: 0s</span><br><span class="line">  tcpTimeout: 0s</span><br><span class="line">  udpTimeout: 0s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: &quot;&quot;</span><br><span class="line">mode: &quot;&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: null</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">showHiddenMetricsForVersion: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 0s</span><br><span class="line">winkernel:</span><br><span class="line">  enableDSR: false</span><br><span class="line">  networkName: &quot;&quot;</span><br><span class="line">  sourceVip: &quot;&quot;</span><br><span class="line">[root@node01 ~]# docker cp fa:/var/lib/kube-proxy/..data/kubeconfig.conf .  </span><br><span class="line">[root@node01 ~]# cat kubeconfig.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt			# Kubernets Ca证书</span><br><span class="line">    server: https://192.168.64.11:6443</span><br><span class="line">  name: default</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: default</span><br><span class="line">    namespace: default</span><br><span class="line">    user: default</span><br><span class="line">  name: default</span><br><span class="line">current-context: default</span><br><span class="line">users:</span><br><span class="line">- name: default</span><br><span class="line">  user:</span><br><span class="line">    tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过上述信息了解到，KubeProxy有一个配置文件和一个Config文件，Config文件是使用Pod中的SA进行认证的，这里我们二进制方式部署通过证书进行认证</p>
<h3 id="创建KubeProxy组件证书"><a href="#创建KubeProxy组件证书" class="headerlink" title="创建KubeProxy组件证书"></a>创建KubeProxy组件证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# cd /etc/kubernetes/pki/</span><br><span class="line">[root@node01 pki]# ls</span><br><span class="line">ca.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">之前Copy了Ca的证书用于kubelet，颁发证书还需要私钥</span></span><br><span class="line">[root@node01 pki]# scp master:/etc/kubernetes/ca.key .</span><br><span class="line">ca.key                                                             100% 1704     3.0MB/s   00:00</span><br><span class="line">[root@node01 pki]# ls</span><br><span class="line">ca.crt  ca.key</span><br><span class="line">[root@node01 pki]# vi kube-proxy.cnf</span><br><span class="line">[ v3_req ]</span><br><span class="line">keyUsage = critical, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth</span><br><span class="line">basicConstraints = critical, CA:FALSE</span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[root@node01 pki]# openssl req -new -newkey rsa:2048 -keyout kube-proxy.key -out kube-proxy.csr -nodes -subj &#x27;/CN=system:kube-proxy&#x27;</span><br><span class="line">Gen</span><br><span class="line">[root@node01 pki]# openssl x509 -req -sha256 -days 36500 -extfile kube-proxy.cnf -extensions v3_req -in kube-proxy.csr -CA ca.crt -CAkey ca.key -out kube-proxy.crt -CAcreateserial</span><br><span class="line">[root@node01 pki]# ls kube-proxy.*</span><br><span class="line">kube-proxy.cnf  kube-proxy.crt  kube-proxy.csr  kube-proxy.key</span><br></pre></td></tr></table></figure>

<h3 id="配置config文件-1"><a href="#配置config文件-1" class="headerlink" title="配置config文件"></a>配置config文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 pki]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=ca.crt \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://192.168.64.31:6443 \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br><span class="line">======================================================================================================</span><br><span class="line">[root@node01 pki]# kubectl config set-credentials system:kube-proxy \</span><br><span class="line">--client-certificate=kube-proxy.crt \</span><br><span class="line">--client-key=kube-proxy.key \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置集群上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config set-context system:kube-proxy \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-proxy \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认上下文</span></span><br><span class="line">[root@node01 pki]# kubectl config use-context system:kube-proxy \</span><br><span class="line">--kubeconfig=kubeconfig.conf</span><br></pre></td></tr></table></figure>

<h3 id="配置KubeProxy"><a href="#配置KubeProxy" class="headerlink" title="配置KubeProxy"></a>配置KubeProxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 pki]# cd</span><br><span class="line">[root@node01 ~]# mkdir /etc/cni/net.d -p</span><br><span class="line">[root@node01 ~]# cp kubernetes/node/bin/kube-proxy /usr/local/sbin/</span><br><span class="line">[root@node01 ~]# vi /lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kube-Proxy</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/config.conf \</span><br><span class="line">  --hostname-override=node01</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@node01 ~]# vi /etc/kubernetes/config.conf</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">bindAddressHardFail: false</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 0</span><br><span class="line">  contentType: &quot;&quot;</span><br><span class="line">  kubeconfig: /etc/kubernetes/pki/kubeconfig.conf</span><br><span class="line">  qps: 0</span><br><span class="line">clusterCIDR: 172.11.0.0/16</span><br><span class="line">configSyncPeriod: 0s</span><br><span class="line">conntrack:</span><br><span class="line">  maxPerCore: null</span><br><span class="line">  min: null</span><br><span class="line">  tcpCloseWaitTimeout: null</span><br><span class="line">  tcpEstablishedTimeout: null</span><br><span class="line">detectLocalMode: &quot;&quot;</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: &quot;&quot;</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;&quot;</span><br><span class="line">  strictARP: false</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">  tcpFinTimeout: 0s</span><br><span class="line">  tcpTimeout: 0s</span><br><span class="line">  udpTimeout: 0s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: &quot;&quot;</span><br><span class="line">mode: &quot;&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: null</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">showHiddenMetricsForVersion: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 0s</span><br><span class="line">winkernel:</span><br><span class="line">  enableDSR: false</span><br><span class="line">  networkName: &quot;&quot;</span><br><span class="line">  sourceVip: &quot;&quot;</span><br><span class="line">[root@node01 ~]# systemctl daemon-reload</span><br><span class="line">[root@node01 ~]# systemctl enable --now kube-proxy</span><br><span class="line">[root@node01 ~]# systemctl status kube-proxy.service</span><br><span class="line">● kube-proxy.service - Kube-Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2022-09-18 22:26:45 CST; 1min 6s ago</span><br><span class="line"> Main PID: 26824 (kube-proxy)</span><br><span class="line">    Tasks: 5 (limit: 23494)</span><br><span class="line">   Memory: 10.6M</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br></pre></td></tr></table></figure>

<p><strong>其他节点的Kube-Proxy直接拷贝Node01所有Kube-Proxy文件即可</strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.xiaowangc.com">尤妤</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.xiaowangc.com/archives/a6cffccf.html">https://www.xiaowangc.com/archives/a6cffccf.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.xiaowangc.com" target="_blank">尤妤</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><div class="post_share"><div class="social-share" data-image="/img/fengmian/k8s.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/archives/43937223.html"><img class="prev-cover" src="/img/fengmian/k8s.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kubeadmin集群生成token加入新节点</div></div></a></div><div class="next-post pull-right"><a href="/archives/fd5f7d86.html"><img class="next-cover" src="/img/fengmian/k8s.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">K8S证书分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/archives/e72cab47.html" title="Kubernetes-AppArmor"><img class="cover" src="/img/fengmian/avatar.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-02</div><div class="title">Kubernetes-AppArmor</div></div></a></div><div><a href="/archives/f2101881.html" title="etcd备份和检查集群状态命令"><img class="cover" src="/img/fengmian/etcd.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-24</div><div class="title">etcd备份和检查集群状态命令</div></div></a></div><div><a href="/archives/dd3f7a17.html" title="Kubernetes-排错思路"><img class="cover" src="/img/fengmian/k8s.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-02</div><div class="title">Kubernetes-排错思路</div></div></a></div><div><a href="/archives/3a1cedd3.html" title="K8S-Help"><img class="cover" src="/img/fengmian/k8s.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-18</div><div class="title">K8S-Help</div></div></a></div><div><a href="/archives/9b833745.html" title="Kubernetes组件概念"><img class="cover" src="/img/fengmian/k8s.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-28</div><div class="title">Kubernetes组件概念</div></div></a></div><div><a href="/archives/ceed1ba0.html" title="Kubernetes-Join流程"><img class="cover" src="/img/fengmian/k8s.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-01</div><div class="title">Kubernetes-Join流程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">尤妤</div><div class="author-info__description">欢迎来到尤妤的博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">53</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=780312916&amp;site=qq&amp;menu=yes"><i class="fa-brands fa-qq"></i><span>联系尤妤</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:admin@xiaowangc.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://www.xiaowangc.com/baidusitemap.xml" target="_blank" title="站点地图"><i class="fas fa-map-location-dot"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">如果阅读过程中遇到了问题，请联系尤妤</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#K8S%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">K8S二进制安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E5%87%86%E5%A4%87"><span class="toc-number">2.1.</span> <span class="toc-text">前提准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AD%98%E5%82%A8%E5%BA%93-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.</span> <span class="toc-text">配置存储库(所有节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%ADSelinux-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">2.3.</span> <span class="toc-text">关闭Selinux(所有节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">2.4.</span> <span class="toc-text">关闭交换分区(所有节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">2.5.</span> <span class="toc-text">关闭防火墙(所有节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BD%91%E6%A1%A5-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">2.6.</span> <span class="toc-text">配置网桥(所有节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEDocker"><span class="toc-number">2.7.</span> <span class="toc-text">安装配置Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AFIPVS-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-number">2.8.</span> <span class="toc-text">开启IPVS(所有节点)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ETCD%E9%9B%86%E7%BE%A4"><span class="toc-number">3.</span> <span class="toc-text">ETCD集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-etcd%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.</span> <span class="toc-text">下载(etcd节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAetcd-CA"><span class="toc-number">3.2.</span> <span class="toc-text">创建etcd CA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAetcd01%E8%AF%81%E4%B9%A6"><span class="toc-number">3.3.</span> <span class="toc-text">创建etcd01证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEetcd01"><span class="toc-number">3.4.</span> <span class="toc-text">配置etcd01</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAetcd02%E8%AF%81%E4%B9%A6"><span class="toc-number">3.5.</span> <span class="toc-text">创建etcd02证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEetcd02"><span class="toc-number">3.6.</span> <span class="toc-text">配置etcd02</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAetcd03%E8%AF%81%E4%B9%A6"><span class="toc-number">3.7.</span> <span class="toc-text">创建etcd03证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEetcd03"><span class="toc-number">3.8.</span> <span class="toc-text">配置etcd03</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-number">3.9.</span> <span class="toc-text">验证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%8B%E8%BD%BD"><span class="toc-number">4.</span> <span class="toc-text">Kubernetes二进制下载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Master%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">Master节点部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#apiServer%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">5.1.</span> <span class="toc-text">apiServer组件部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAKubernetes-Ca"><span class="toc-number">5.1.1.</span> <span class="toc-text">创建Kubernetes Ca</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AD%BE%E5%8F%91apiServer%E7%BB%84%E4%BB%B6%E8%AF%81%E4%B9%A6"><span class="toc-number">5.1.2.</span> <span class="toc-text">创建签发apiServer组件证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AD%BE%E5%8F%91etcd-client%E8%AF%81%E4%B9%A6"><span class="toc-number">5.1.3.</span> <span class="toc-text">创建签发etcd-client证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AD%BE%E5%8F%91kubelet%E7%BB%84%E4%BB%B6%E8%AF%81%E4%B9%A6"><span class="toc-number">5.1.4.</span> <span class="toc-text">创建签发kubelet组件证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAfront-proxy-ca"><span class="toc-number">5.1.5.</span> <span class="toc-text">创建front-proxy-ca</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAfront-proxy-client"><span class="toc-number">5.1.6.</span> <span class="toc-text">创建front-proxy-client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AF%86%E9%92%A5%E5%AF%B9"><span class="toc-number">5.1.7.</span> <span class="toc-text">创建密钥对</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEapiServer"><span class="toc-number">5.1.8.</span> <span class="toc-text">配置apiServer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CM%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">5.2.</span> <span class="toc-text">CM组件部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BACM%E8%AF%81%E4%B9%A6"><span class="toc-number">5.2.1.</span> <span class="toc-text">创建CM证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAconfig%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.2.</span> <span class="toc-text">创建config文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AECM"><span class="toc-number">5.2.3.</span> <span class="toc-text">配置CM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scheduler%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">5.3.</span> <span class="toc-text">Scheduler组件部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAScheduler%E8%AF%81%E4%B9%A6"><span class="toc-number">5.3.1.</span> <span class="toc-text">创建Scheduler证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAconfig%E6%96%87%E4%BB%B6-1"><span class="toc-number">5.3.2.</span> <span class="toc-text">创建config文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEScheduler"><span class="toc-number">5.3.3.</span> <span class="toc-text">配置Scheduler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Admin%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90"><span class="toc-number">5.4.</span> <span class="toc-text">Admin文件生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAadmin%E8%AF%81%E4%B9%A6"><span class="toc-number">5.4.1.</span> <span class="toc-text">创建admin证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEconfig%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.2.</span> <span class="toc-text">配置config文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95Admin"><span class="toc-number">5.4.3.</span> <span class="toc-text">测试Admin</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Node%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2"><span class="toc-number">6.</span> <span class="toc-text">Node节点部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubelet%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">6.1.</span> <span class="toc-text">Kubelet组件部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#apiServer%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.1.</span> <span class="toc-text">apiServer配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90token"><span class="toc-number">6.1.1.1.</span> <span class="toc-text">生成token</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9EapiServer%E5%8F%82%E6%95%B0"><span class="toc-number">6.1.1.2.</span> <span class="toc-text">新增apiServer参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEKubelet"><span class="toc-number">6.1.2.</span> <span class="toc-text">配置Kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BABootStap%E6%96%87%E4%BB%B6"><span class="toc-number">6.1.3.</span> <span class="toc-text">创建BootStap文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">6.1.4.</span> <span class="toc-text">启动测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="toc-number">6.1.5.</span> <span class="toc-text">颁发证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KubePorxy%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">6.2.</span> <span class="toc-text">KubePorxy组件部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAKubeProxy%E7%BB%84%E4%BB%B6%E8%AF%81%E4%B9%A6"><span class="toc-number">6.2.1.</span> <span class="toc-text">创建KubeProxy组件证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEconfig%E6%96%87%E4%BB%B6-1"><span class="toc-number">6.2.2.</span> <span class="toc-text">配置config文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEKubeProxy"><span class="toc-number">6.2.3.</span> <span class="toc-text">配置KubeProxy</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/archives/bc2a8490.html" title="Linux证书有效期检测脚本"><img src="/img/fengmian/linux.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux证书有效期检测脚本"/></a><div class="content"><a class="title" href="/archives/bc2a8490.html" title="Linux证书有效期检测脚本">Linux证书有效期检测脚本</a><time datetime="2023-01-21T18:51:55.000Z" title="发表于 2023-01-22 02:51:55">2023-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/e3278faf.html" title="关于Kubernetes配置私有镜像仓库"><img src="/img/fengmian/k8s.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="关于Kubernetes配置私有镜像仓库"/></a><div class="content"><a class="title" href="/archives/e3278faf.html" title="关于Kubernetes配置私有镜像仓库">关于Kubernetes配置私有镜像仓库</a><time datetime="2023-01-21T09:19:38.000Z" title="发表于 2023-01-21 17:19:38">2023-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/d89a6add.html" title="Containerd安装脚本"><img src="/img/fengmian/k8s.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Containerd安装脚本"/></a><div class="content"><a class="title" href="/archives/d89a6add.html" title="Containerd安装脚本">Containerd安装脚本</a><time datetime="2023-01-20T12:03:22.000Z" title="发表于 2023-01-20 20:03:22">2023-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/93a87db7.html" title="ES&amp;Kibana安装配置"><img src="/img/fengmian/elastic_logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ES&amp;Kibana安装配置"/></a><div class="content"><a class="title" href="/archives/93a87db7.html" title="ES&amp;Kibana安装配置">ES&amp;Kibana安装配置</a><time datetime="2023-01-10T07:32:11.000Z" title="发表于 2023-01-10 15:32:11">2023-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/bd4820af.html" title="Poste.io邮件服务器"><img src="/img/fengmian/email.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Poste.io邮件服务器"/></a><div class="content"><a class="title" href="/archives/bd4820af.html" title="Poste.io邮件服务器">Poste.io邮件服务器</a><time datetime="2022-12-16T02:39:37.000Z" title="发表于 2022-12-16 10:39:37">2022-12-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/fengmian/k8s.jpeg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 尤妤</div><div class="framework-info"><span><a href="https://hexo.io/" target="_blank" title="由 Halo 强力驱动" style="text-decoration:none;"><span style="color: #fff;border-bottom-left-radius: 4px;border-top-left-radius: 4px;background-color: #505050;padding: 1px 3px 1px 3px;" ><img src="https://www.xiaowangc.com/img/hexo.png" style="vertical-align:text-bottom">&nbsp</i>Powered</span><span data-v-625f2a9e="" style="color: #fff;padding: 1px 3px 1px 3px;background-color: #007ec6!important;border-top-right-radius: 4px;border-bottom-right-radius: 4px;">Hexo v6.2.0</span></a></span>
<span><a href="https://cloud.tencent.com/" target="_blank" title="由Tencent Cloud托管" style="text-decoration:none;"><span style="color: #fff;border-bottom-left-radius: 4px;border-top-left-radius: 4px;background-color: #505050;padding: 1px 3px 1px 3px;" ><i class="fa-brands fa-docker">&nbsp</i>Trusteeship</span><span data-v-625f2a9e="" style="color: #fff;padding: 1px 3px 1px 3px;background-color: #44e0c0!important;border-top-right-radius: 4px;border-bottom-right-radius: 4px;">Tencent Cloud</span></a></span>
<span><a href="https://beian.miit.gov.cn/" target="_blank" title="ICP备案" style="text-decoration:none;"><span style="color: #fff;border-bottom-left-radius: 4px;border-top-left-radius: 4px;background-color: #505050;padding: 1px 3px 1px 3px;"><img src="https://www.xiaowangc.com/img/icp.png" style="vertical-align:text-bottom">&nbsp</i>蜀ICP备</span><span data-v-625f2a9e="" style="color: #fff;padding: 1px 3px 1px 3px;background-color: red!important;border-top-right-radius: 4px;border-bottom-right-radius: 4px;">2022002393-1号</span></a></span>
<span><a href="https://icp.gov.moe/" target="_blank" title="萌国备案" style="text-decoration:none;"><span style="color: #fff;border-bottom-left-radius: 4px;border-top-left-radius: 4px;background-color: #505050;padding: 1px 3px 1px 3px;"><img src="https://www.xiaowangc.com/img/mb.ico" style="vertical-align:text-bottom">&nbsp</i>萌备</span><span data-v-625f2a9e="" style="color: #fff;padding: 1px 3px 1px 3px;background-color: orange!important;border-top-right-radius: 4px;border-bottom-right-radius: 4px;">20220706号</span></a></span>
<span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" title="主题" style="text-decoration:none;"><span style="color: #fff;border-bottom-left-radius: 4px;border-top-left-radius: 4px;background-color: #505050;padding: 1px 3px 1px 3px;"><i class="fa-brands fa-github"></i>&nbsp</i>Theme</span><span data-v-625f2a9e="" style="color: #fff;padding: 1px 3px 1px 3px;background-color: #4dc820!important;border-top-right-radius: 4px;border-bottom-right-radius: 4px;">Butterfly</span></a></span></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" style="text-decoration:none;"><span>本网站由</span><img src="https://www.xiaowangc.com/img/y_logo5.png" width="48" height="24" style="vertical-align:text-bottom"></img><span>提供CDN加速/云存储服务</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script data-pjax defer src="https://npm.elemecdn.com/tzy-blog/lib/js/theme/chocolate.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>